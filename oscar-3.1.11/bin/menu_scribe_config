#!/bin/bash

## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin,  jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.

#   programme de menu administrateur réseau pour l'autorun

#----------------------------------------------------------------------------------------------------
eteindre_le_poste()
{
runme boite_eteindre_le_poste
if ( test -e /tmp/annuler_eteindre )
then
	rm -f /tmp/annuler_eteindre
	main
	return
fi

runme boite_eteindre_ordinateur
}
#----------------------------------------------------------------------------------------------------
boucle()  # retour au programme principal
{
echo
echo
echo -e "\033[1;34mpour faire défiler l'écran utilisez \033[1;37m Maj_PgUp \033[1;34m ou \033[1;37m Maj_PgDn\033[1;m"
echo -ne "\033[1;34mappuyez sur la touche\033[1;37m Entrée \033[1;34mpour continuer...\033[1;m"
read reponse
main
}
#----------------------------------------------------------------------------------------------------
boite_masque()	# Donnez les valeurs du masque
{
rm -f /tmp/tempfile_mq
DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
--backtitle "`cat /etc/banniere_oscar`" \
--cancel-label "`cat $chemin_langue/Annuler`"  --title " Choix du masque  " \
--inputbox "\n\n\Z2 Les valeurs du masque\Zn : \
\n\n\n\Zb\Z4Donnez \Z3les valeurs du masque\Z4 :  " 0 0 $valeur_masque 2>/tmp/tempfile_mq
case $? in
    0)  reponse=`cat /tmp/tempfile_mq`
	cut -f4 -d"." /tmp/tempfile_mq > /tmp/tempfile_mq1
	valeur_test=`cat /tmp/tempfile_mq`
	rm -f /tmp/tempfile_mq1
	if [ "$valeur_test" = "" ]
	then
	    rm -f /tmp/tempfile_mq
	    boite_masque
	    return 0
	fi
	;;
    1)	echo "" > /tmp/sortir
    	rm -f /tmp/tempfile_mq
	;;
    255) echo "" > /tmp/sortir
    	rm -f /tmp/tempfile_mq
	;;
esac
}
#----------------------------------------------------------------------------------------------------
boite_ip()	# Donnez les valeurs d'IP
{
if [ "$nom_adresse_ip" = "adresse IP proxy" ]
then
	echo " (si pas de proxy entrez \Z3non\Z4)" > /tmp/texte_pas_proxy
else
	echo "" > /tmp/texte_pas_proxy
fi
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " Choix des valeurs d'IP  " \
	--inputbox "\n\n\Z2 Les valeurs d'adresse IP \Zb\Z3$nom_adresse_ip\Zn : \
	\n\n\n\Zb\Z4 Donnez \Z3les valeurs d'IP\Z4 : `cat /tmp/texte_pas_proxy` " 0 0 $valeur_ip 2>/tmp/tempfile_ip
        case $? in
	    0)  reponse=`cat /tmp/tempfile_ip`
		rm -f /tmp/texte_pas_proxy
		if [ "$nom_adresse_ip" = "adresse IP proxy" ]
		then
			if [ "$reponse" = "non" ]
			then
				echo "$reponse" > /tmp/temp_reponse
				return 0
			fi
		fi
		cut -f4 -d"." /tmp/tempfile_ip > /tmp/tempfile_ip1
		valeur_test=`cat /tmp/tempfile_ip1`
		rm -f /tmp/tempfile_ip1
		if [ "$valeur_test" = "" ]
		then
			rm -f /tmp/tempfile_ip
			boite_ip
			return 0
		fi
		echo "$reponse" > /tmp/temp_reponse
		grep -ci ":" /tmp/temp_reponse > /tmp/nb_port
		nb_port=`cat /tmp/nb_port`
		rm -f /tmp/nb_port
		;;
	    1)	echo "" > /tmp/sortir
		rm -f /tmp/texte_pas_proxy
	    	rm -f /tmp/tempfile_ip
		;;
	    255) echo "" > /tmp/sortir
		rm -f /tmp/texte_pas_proxy
	    	rm -f /tmp/tempfile_ip
		;;
	esac
}
#-----------------------------------------------------------------------------------------------------
boite_erreur_ping_serveur_pxe()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--ok-label "`cat $chemin_langue/Continuer`"  \
	--msgbox "\n\Zb\Z1Il y a déjà un poste $reponse sur le réseau. \Zn" 7 55
	case $? in
    0) ;;
    255) ;;
esac
}
#----------------------------------------------------------------------------------------------------
controle_ip_fixe_filtre_deja_sur_reseau()
{
ip_installe=`cat ip_installe_poste`
if ! [ "$reponse" = "$ip_installe" ]
then
	echo -e "\033[1;34m ...\033[1;m"
	echo
	ping -w 8 $reponse 2>/dev/null 1>/dev/null
	test_ping_serveur_pxe=$?
	if [ "$test_ping_serveur_pxe" = "0" ]
	then
		boite_erreur_ping_serveur_pxe
	else
		ip_client_fixe_pour_amon2=$reponse
	fi
else
	ip_client_fixe_pour_amon2=$reponse
fi
}
#----------------------------------------------------------------------------------------------------
main()
{
rm -f /tmp/sortir
rm -f /tmp/tempfile # des menus precedents sauf celui-ci tempfile______
rm -f /tmp/tempfile___
rm -f /tmp/tempfile____
rm -f /tmp/tempfile_____
rm -f /tmp/tempfile_______

calendrier=$(date +%d/%m/%y)
heure=$(date +%kh%Mmin)
rm -f /tmp/rien
echo "\Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  " > /tmp/rien
output=exit
afficher_proxy=$ip_proxy:$port_ip_proxy
if [ "$ip_proxy" = non ]
then
	afficher_proxy="pas de proxy"
fi

# ligne a rajouter si pas de bug apres la ligne "adresse_scribe"
# "adresse_proxy" "Adresse IP du \Z2proxy\Zn : \Zb\Z3 $afficher_proxy \Zn" \
	
dialog  --no-cancel --colors --no-shadow \
	--backtitle "`cat /etc/banniere_oscar`" --title " Menu SCRIBE " \
	--menu  "\n  \Zb\Z3  Faites votre choix : `cat /tmp/rien`  le $calendrier à $heure\n " 11 111 0  \
	" " "" \
	"accepter" "\Zb\Z3Accepter la configuration : " \
	" " "" \
	"adresse_scribe" "Adresse IP du serveur \Z2scribe\Zn : \Zb\Z3 $ip_serveur_scribe:$port_ip_serveur_scribe \Zn " \
	"adresse_proxy" "Adresse IP du \Z2proxy\Zn : \Zb\Z3 $afficher_proxy \Zn" \
	" " "" \
	"adresse_amon2" "Adresse IP du serveur \Z2amon2\Zn : \Zb\Z3 $ip_amon2:$port_ip_amon2 \Zn " \
	"adresse_accès" "Adresse IP du poste fixe d'accès \Z2amon2\Zn : \Zb\Z3 $ip_client_fixe_pour_amon2 \Zn " \
	"masque_accès" "Masque du poste fixe d'accès \Z2amon2\Zn : \Zb\Z3 $masque_ip_client_fixe_pour_amon2 \Zn " \
	" " "" \
	"defaut" "Mettre les valeurs par \Zb\Z3défaut \Zn " \
	"halt" "\Z1Eteindre\Zn l'ordinateur." \
	"quitter" "`cat $chemin_langue/menu_61`" \
	" " "" 2>/tmp/tempfile_scribe
	
if [ $? = "255" ]
then
	rm -f /tmp/tempfile_scribe
	rm -f /tmp/rien
	echo "" > /tmp/sortir
	exit
fi
output=`cat /tmp/tempfile_scribe`
rm -f /tmp/tempfile_scribe
rm -f /tmp/rien

if [ "$output" = " " ]
then
	main
elif [ "$output" = "" ]
then
	main
elif [ $output = "accepter" ]
then
	echo "$masque_ip_client_fixe_pour_amon2" > /tmp/ip_masque_poste
	echo "$ip_client_fixe_pour_amon2" > /etc/oscar_scribe/ip_client_fixe_pour_amon2
	echo "$masque_ip_client_fixe_pour_amon2" > /etc/oscar_scribe/masque_ip_client_fixe_pour_amon2
	echo "$ip_serveur_scribe:$port_ip_serveur_scribe" > /etc/oscar_scribe/ip_serveur_scribe
	echo "$ip_amon2:$port_ip_amon2" > /etc/oscar_scribe/ip_amon2
	echo "$ip_proxy:$port_ip_proxy" > /etc/oscar_scribe/ip_proxy
	
	# carte_ethi=`cat /tmp/carte_ethi`
	# ifconfig $carte_ethi $ip_client_fixe_pour_amon2 netmask $masque_ip_client_fixe_pour_amon2
	# echo "$ip_client_fixe_pour_amon2" > ip_installe_poste
	exit
elif [ $output = "defaut" ]
then
	if ! ( test -e /etc/oscar_scribe/ip_oscar_scribe_defaut )
	then	# cas improbable
		ip_serveur_scribe=$ip_serveur_scribe_defaut # 192.168.220.10
		port_ip_serveur_scribe=$port_ip_serveur_scribe_defaut	#4200
		ip_amon2=$ip_amon2_defaut	#172.16.0.252
		port_ip_amon2=$port_ip_amon2_defaut	#4200
		ip_client_fixe_pour_amon2=$ip_client_fixe_pour_amon2_defaut	# 172.16.2.100 pour camus : 172.16.2.200
		masque_ip_client_fixe_pour_amon2=$masque_ip_client_fixe_pour_amon2_defaut	# 255.255.0.0
		ip_proxy=$ip_proxy_defaut	#172.16.0.252
		port_ip_proxy=$port_ip_proxy_defaut	#3128
	else
		cut -d"," -f1 /etc/oscar_scribe/ip_oscar_scribe_defaut > /tmp/defaut_ip_poste_fixe_scribe
		cut -d"," -f2 /etc/oscar_scribe/ip_oscar_scribe_defaut > /tmp/defaut_mq_poste_fixe_scribe

		ip_serveur_scribe=$ip_serveur_scribe_defaut # 192.168.220.10 pour camus : 192.168.220.10
		port_ip_serveur_scribe=$port_ip_serveur_scribe_defaut	# 4200
		ip_amon2="`cat /tmp/defaut_ip_poste_fixe_scribe`.0.252"	# 172.16.0.252
		port_ip_amon2=$port_ip_amon2_defaut
		ip_client_fixe_pour_amon2="`cat /tmp/defaut_ip_poste_fixe_scribe`.2.100"	# 172.16.2.100 pour camus : 172.16.2.200
		masque_ip_client_fixe_pour_amon2=`cat /tmp/defaut_mq_poste_fixe_scribe`
		ip_proxy="`cat /tmp/defaut_ip_poste_fixe_scribe`.0.252"	# 172.16.0.252
		port_ip_proxy=$port_ip_proxy_defaut
		
		rm -f /tmp/defaut_ip_poste_fixe_scribe
		rm -f /tmp/defaut_mq_poste_fixe_scribe
	fi
	
	main
elif [ $output = "adresse_scribe" ]
then
	nom_adresse_ip="serveur scribe"
	valeur_ip=$ip_serveur_scribe:$port_ip_serveur_scribe
	boite_ip
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		main
		return
	fi
	if ! [ "$nb_port" = 0 ]
	then
		cut -d":" -f2 /tmp/temp_reponse > /tmp/defaut_port_ip
		port_ip_serveur_scribe=`cat /tmp/defaut_port_ip`
		rm -f /tmp/defaut_port_ip
	fi
	cut -d":" -f1 /tmp/temp_reponse > /tmp/defaut_ip
	ip_serveur_scribe=`cat /tmp/defaut_ip`
	rm -f /tmp/temp_reponse
	rm -f /tmp/defaut_ip
	main
elif [ $output = "adresse_proxy" ]
then
	nom_adresse_ip="adresse IP proxy"
	valeur_ip=$ip_proxy:$port_ip_proxy
	boite_ip
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		main
		return
	fi
	test_proxy=`cat /tmp/temp_reponse`
	if ! [ "$test_proxy" = non ]
	then
		if ! [ "$nb_port" = 0 ]
		then
			cut -d":" -f2 /tmp/temp_reponse > /tmp/defaut_port_ip_proxy
			port_ip_proxy=`cat /tmp/defaut_port_ip_proxy`
			rm -f /tmp/defaut_port_ip_proxy
		fi
		cut -d":" -f1 /tmp/temp_reponse > /tmp/defaut_ip_proxy
	else
		echo "non" > /tmp/defaut_ip_proxy
	fi
	ip_proxy=`cat /tmp/defaut_ip_proxy`
	rm -f /tmp/temp_reponse
	rm -f /tmp/defaut_ip_proxy
	main
elif [ $output = "adresse_amon2" ]
then
	nom_adresse_ip="serveur amon2"
	valeur_ip=$ip_amon2:$port_ip_amon2
	boite_ip
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		main
		return
	fi
	if ! [ "$nb_port" = 0 ]
	then
		cut -d":" -f2 /tmp/temp_reponse > /tmp/defaut_port_ip
		port_ip_amon2=`cat /tmp/defaut_port_ip`
		rm -f /tmp/defaut_port_ip
	fi
	cut -d":" -f1 /tmp/temp_reponse > /tmp/defaut_ip
	ip_amon2=`cat /tmp/defaut_ip`
	rm -f /tmp/temp_reponse
	rm -f /tmp/defaut_ip
	main
elif [ $output = "adresse_accès" ]
then
	nom_adresse_ip="poste fixe"
	valeur_ip=$ip_client_fixe_pour_amon2
	boite_ip
	rm -f /tmp/temp_reponse
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		main
		return
	fi
	controle_ip_fixe_filtre_deja_sur_reseau
	main
elif [ $output = "masque_accès" ]
then
	nom_adresse_masque="masque du poste fixe"
	valeur_masque=$masque_ip_client_fixe_pour_amon2
	boite_masque
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		main
		return
	fi
	masque_ip_client_fixe_pour_amon2=$reponse
	main
elif [ "$output" = "halt" ]
then
        eteindre_le_poste
elif [ $output = "quitter" ]
then
	echo "" > /tmp/sortir
	exit
else
	$output
fi
boucle
}
#----------------------------------------------------------------------------------------------------
PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

# valeurs par defaut :
ip_serveur_scribe_defaut=192.168.220.10
port_ip_serveur_scribe_defaut=4200

ip_amon2_defaut=172.16.0.252
port_ip_amon2_defaut=4200
ip_proxy_defaut=172.16.0.252
port_ip_proxy_defaut=3128

ip_client_fixe_pour_amon2_defaut=172.16.2.100	# pour camus 172.16.2.200
masque_ip_client_fixe_pour_amon2_defaut=255.255.0.0



if ! ( test -e /tmp/carte_ethi )
then
	runme lancer_dhcp
fi
carte_ethi=`cat /tmp/carte_ethi`
if ! ( test -e /etc/oscar_scribe/ip_oscar_scribe_defaut )
then
	cut -d"." -f1-2 ip_installe_poste > /etc/oscar_scribe/ip_oscar_scribe_defaut
	test_reseau=`cat /etc/oscar_scribe/ip_oscar_scribe_defaut`
	if [ "$test_reseau" = "" ]
	then
		echo "172.16" > /etc/oscar_scribe/ip_oscar_scribe_defaut
	fi
	echo `cat /tmp/ip_masque_poste` > /tmp/temp_ip_masque_poste
	echo "`cat /etc/oscar_scribe/ip_oscar_scribe_defaut`,`cat /tmp/temp_ip_masque_poste`" > /etc/oscar_scribe/ip_oscar_scribe_defaut
	rm -f /tmp/temp_ip_masque_poste
fi

cut -d"," -f1 /etc/oscar_scribe/ip_oscar_scribe_defaut > /tmp/defaut_ip_poste_fixe_scribe
cut -d"," -f2 /etc/oscar_scribe/ip_oscar_scribe_defaut > /tmp/defaut_mq_poste_fixe_scribe

if ( test -e /etc/oscar_scribe/ip_serveur_scribe )
then
	cut -d":" -f1 /etc/oscar_scribe/ip_serveur_scribe > /tmp/defaut_ip_serveur_scribe
	cut -d":" -f2 /etc/oscar_scribe/ip_serveur_scribe > /tmp/defaut_port_ip_serveur_scribe
	ip_serveur_scribe=`cat /tmp/defaut_ip_serveur_scribe`
	port_ip_serveur_scribe=`cat /tmp/defaut_port_ip_serveur_scribe`
	rm -f /tmp/defaut_ip_serveur_scribe
	rm -f /tmp/defaut_port_ip_serveur_scribe
else
	ip_serveur_scribe=$ip_serveur_scribe_defaut	# 192.168.220.10 pour camus : 192.168.220.10
	port_ip_serveur_scribe=$port_ip_serveur_scribe_defaut
fi

if ( test -e /etc/oscar_scribe/ip_amon2 )
then
	cut -d":" -f1 /etc/oscar_scribe/ip_amon2 > /tmp/defaut_ip_amon2
	cut -d":" -f2 /etc/oscar_scribe/ip_amon2 > /tmp/defaut_port_ip_amon2
	ip_amon2=`cat /tmp/defaut_ip_amon2`
	port_ip_amon2=`cat /tmp/defaut_port_ip_amon2`
	rm -f /tmp/defaut_ip_amon2
	rm -f /tmp/defaut_port_ip_amon2
else
	ip_amon2="`cat /tmp/defaut_ip_poste_fixe_scribe`.0.252"	# 172.16.0.252:4200
	port_ip_amon2=$port_ip_amon2_defaut
fi

if ( test -e /etc/oscar_scribe/ip_client_fixe_pour_amon2 )
then
	ip_client_fixe_pour_amon2=`cat /etc/oscar_scribe/ip_client_fixe_pour_amon2`
else
	ip_client_fixe_pour_amon2="`cat /tmp/defaut_ip_poste_fixe_scribe`.2.100"	# 172.16.2.100 pour camus : 172.16.2.200
fi
if ( test -e /etc/oscar_scribe/masque_ip_client_fixe_pour_amon2 )
then
	masque_ip_client_fixe_pour_amon2=`cat /etc/oscar_scribe/masque_ip_client_fixe_pour_amon2`
else
	masque_ip_client_fixe_pour_amon2=`cat /tmp/defaut_mq_poste_fixe_scribe`
fi

if ( test -e /etc/oscar_scribe/ip_proxy )
then
	cut -d":" -f1 /etc/oscar_scribe/ip_proxy > /tmp/defaut_ip_proxy
	ip_proxy=`cat /tmp/defaut_ip_proxy`
	if ! [ "$ip_proxy" = non ]
	then
		cut -d":" -f2 /etc/oscar_scribe/ip_proxy > /tmp/defaut_port_ip_proxy
		port_ip_proxy=`cat /tmp/defaut_port_ip_proxy`
	fi
	rm -f /tmp/defaut_ip_proxy
	rm -f /tmp/defaut_port_ip_proxy
else
	ip_proxy="`cat /tmp/defaut_ip_poste_fixe_scribe`.0.252"	# 172.16.0.252:3128
	port_ip_proxy=$port_ip_proxy_defaut
fi
rm -f /tmp/defaut_ip_poste_fixe_scribe
rm -f /tmp/defaut_mq_poste_fixe_scribe
rm -f /tmp/defaut_ip_sans_proxy

main