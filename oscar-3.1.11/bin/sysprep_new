#!/bin/sh



## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin,  jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.


PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue



#-----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
boite_info_new_sysprep()
{
# Informations sur la mise a jour sysprep
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors --ok-label "`cat $chemin_langue/Continuer`" \
	--cancel-label "`cat $chemin_langue/Annuler`" \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/menu_679a` " \
	--menu "  " 10 80 0 \
	"" "" \
	"" "\Zb\Z4`cat $chemin_langue/menu_690` : \Z2" \
	"" "  \Z2`cat $chemin_langue/menu_692`. " \
	"" "  \Z2`cat $chemin_langue/menu_692a`. " \
	"" "" \
	"" "\Zb\Z4`cat $chemin_langue/menu_691` : \Z2" \
	"" "  \Z2`cat $chemin_langue/menu_693`; " \
	"" "  \Z2`cat $chemin_langue/menu_694`; " \
	"" "  \Z2`cat $chemin_langue/menu_695`; " \
	"" "  \Z2`cat $chemin_langue/menu_696`. " \
	"" ""
case $? in
	0) ;;
	1) exit ;;
	255) exit ;;
esac
}
#-----------------------------------------------------------------------------------------------------
boite_autre_partition()
{
runme info_ddialog
runme prepare_fichier_temptaille
rm -f /tmp/bozo
	perl -pi -e 's/    Blocks/\\Z1Taille(Ko)\\Zn /g;' /tmp/fichier_disque_dur

        # couleurs
	runme colorier_selection_info
 	cp -f /tmp/couleurs_info /tmp/bozo
 	rm -f /tmp/couleurs_info
	# Récupérer /Personnel/new_sysprep depuis une partition
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`" --ok-label "`cat $chemin_langue/menu_483`" \
	--extra-button --extra-label "`cat $chemin_langue/menu_484`" \
	--title " `cat $chemin_langue/menu_668a` /new_sysprep/ " \
	--menu "\n\Zn`cat /tmp/bozo`" 0 0 0 \
	"" "\Z2 `cat $chemin_langue/menu_669` :  " \
	"" "\Z2 `cat $chemin_langue/menu_670` : \Zb\Z4< `cat $chemin_langue/menu_484` >  "
	case $? in
	    0)	rm -f /tmp/bozo	# sur partition vue
	    	chercher_repertoire_new_sysprep
		;;
	    1)	rm -f /tmp/bozo
	        exit
	        ;;
	    3)	rm -f /tmp/bozo	# sur autre cle USB
		echo
		runme lecture_connecteur_usb
		boite_autre_partition
		;;
	    255) rm -f /tmp/bozo
		exit
		;;
	esac
	
#	runme montage_local
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/tempfile
		rm -f /tmp/sortir
		exit
	fi
}
#----------------------------------------------------------------------------------------------------
boucle_partition_new_sysprep() # copier le repertoire /new_sysprep dans /tmp/new_sysprep
{
	rm -f /tmp/tempfile
	echo "$type" > /tmp/tempfile
	runme prepare_boucle_partition
	nombretype=`cat /tmp/nombre`
	rm -f /tmp/nombre
numero=0
until  ( test  $numero = $nombretype )
    do
	rm -f /tmp/tempfile1
	numero=$[$numero+1]
	cut -d":" -f$numero /tmp/tempfile > /tmp/tempfile1
	reponse=`cat /tmp/tempfile1`
	reparti=$reponse
	rm -f /tmp/tempfile1
	numero_hd=`expr substr $reponse 4 3`
	disque=`expr substr $reponse 1 3`       #hda
       	# id_type=`sfdisk /dev/$disque -c $numero_hd 2>/dev/null`
	echo "$reponse" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	partition_montee=`cat /tmp/monter_partition`
	rm -f /tmp/monter_partition
	if ( test -e $partition_montee/new_sysprep/sysprep/sysprep_var.inf ) || ( test -e $partition_montee/new_sysprep/sysprep/sysprep_var.xml )
	then
		mkdir -p /tmp/new_sysprep/sysprep 2>/dev/null
		cp -f  $partition_montee/new_sysprep/sysprep/sysprep_var.* /tmp/new_sysprep/sysprep/ 2>/dev/null
		cp -f  $partition_montee/new_sysprep/sysprep/sysprep_oscar.* /tmp/new_sysprep/sysprep/ 2>/dev/null
	elif ( test -e $partition_montee/new_sysprep/oscar_deploie/oscar_var.txt )
	then
		mkdir -p /tmp/new_sysprep/oscar_deploie 2>/dev/null
		cp -f  $partition_montee/new_sysprep/oscar_deploie/oscar_var.txt /tmp/new_sysprep/oscar_deploie/ 2>/dev/null
	fi
	umount $partition_montee 2>/dev/null ; sync
    done
rm -f /tmp/tempfile
}
#----------------------------------------------------------------------------------------------------
chercher_repertoire_new_sysprep()
{
	# recherche sur le disque dur la partition où se trouve le repertoire oscar_var_salle et /usr/share/oscar/var_salle

type="ntfs"
echo "ntfs" > /tmp/besoin_type
boucle_partition_new_sysprep
rm -f  /tmp/besoin_type
type="Linux"
boucle_partition_new_sysprep
type="W95 FAT32"
boucle_partition_new_sysprep
type="FAT16"
boucle_partition_new_sysprep
type="W95 FAT 32 (LBA)"
boucle_partition_new_sysprep
type="W95 FAT 16 (LBA)"
boucle_partition_new_sysprep
}
#----------------------------------------------------------------------------------------------------
gerer_cle_usb_new_sysprep()
{
boite_info_new_sysprep

rm -fR /tmp/new_sysprep
boite_autre_partition
if ! ( test -e /tmp/new_sysprep/sysprep/sysprep_var.xml )
then
	if ! ( test -e /tmp/new_sysprep/sysprep/sysprep_var.inf )
	then
		if ! ( test -e /tmp/new_sysprep/oscar_deploie/oscar_var.txt )
		then
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "\n\Zb\Z1`cat $chemin_langue/menu_671`: /new_sysprep/sysprep /new_sysprep/oscar_deploie ... " 7 80
			case $? in
			    0) 	exit
			    	;;
			    255) exit
			    	;;
			esac
		fi
	fi
fi
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/menu_289a` " \
	--ok-label "`cat $chemin_langue/Continuer`"  \
	--msgbox "\n\Zb\Z1`cat $chemin_langue/menu_292a` ... " 7 44
	case $? in
	    0) 	;;
	    255) rm -fR /tmp/new_sysprep
	    	exit
	    	;;
	esac
}
#-----------------------------------------------------------------------------------------------------
gerer_ip_serveur_etablissement()
{
echo $partition_oscar_new_sysprep > /tmp/partition_oscar_new_sysprep
perl -pi -e 's/\"oui /{/g; s/\"/{/g;' /tmp/partition_oscar_new_sysprep
cut -d"{" -f2 /tmp/partition_oscar_new_sysprep > /tmp/partition_oscar_new_sysprep1
partition_oscar_new_sysprep=`cat /tmp/partition_oscar_new_sysprep1`
rm -f /tmp/partition_oscar_new_sysprep
rm -f /tmp/partition_oscar_new_sysprep1

if ( test -e /mnt/$partition_oscar_new_sysprep/oscar/liste_postes_sysprep )
then
	grep -ci "IP_SERVEUR_ETABLISSEMENT=" /mnt/$partition_oscar_new_sysprep/oscar/liste_postes_sysprep > /tmp/nb_ip_serveur_etablissement_var_temp
	nb_ip_serveur_etablissement_var_temp=`cat /tmp/nb_ip_serveur_etablissement_var_temp`
	rm -f /tmp/nb_ip_serveur_etablissement_var_temp
	if [ "$nb_ip_serveur_etablissement_var_temp" != 0 ]
	then
		grep -i "IP_SERVEUR_ETABLISSEMENT=" /mnt/$partition_oscar_new_sysprep/oscar/liste_postes_sysprep > /tmp/ip_serveur_etablissement_liste_temp
		cut -d"=" -f2 /tmp/ip_serveur_etablissement_liste_temp > /tmp/ip_serveur_etablissement
		ip_serveur_etablissement=`cat /tmp/ip_serveur_etablissement`
		rm -f /tmp/ip_serveur_etablissement_liste_temp
		rm -f /tmp/ip_serveur_etablissement
		
		ping -w 8 $ip_serveur_etablissement 2>/dev/null 1>/dev/null
		test_ping_serveur_pxe=$?
		if [ "$test_ping_serveur_pxe" = "0" ]
		then	# pas de serveur ping
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  --extra-button --extra-label "`cat $chemin_langue/Forcer`"  \
			--msgbox "\n\Zb\Z1`cat $chemin_langue/menu_10cb` : $ip_serveur_etablissement \Zn" 7 65
			case $? in
				0) gerer_cle_usb_new_sysprep ;;
				3) mkdir -p /tmp/new_sysprep/oscar_deploie
				echo "oscar_var_new_sysprep" > /tmp/new_sysprep/oscar_deploie/oscar_var.txt
				return ;;
				255) mkdir -p /tmp/new_sysprep/oscar_deploie
				echo "oscar_var_new_sysprep" > /tmp/new_sysprep/oscar_deploie/oscar_var.txt
				return ;;
			esac
		else
			mkdir -p /tmp/new_sysprep/oscar_deploie
			echo "oscar_var_new_sysprep" > /tmp/new_sysprep/oscar_deploie/oscar_var.txt
		fi
	else	# pas de serveur_etablissement
		gerer_cle_usb_new_sysprep
	fi
else
	gerer_cle_usb_new_sysprep
fi
}
#-----------------------------------------------------------------------------------------------------
#		mise a jour sysprep
#-----------------------------------------------------------------------------------------------------
#	demande sauvegarde verifie si sysprep cherche usb sysprep restaure copie depuis /new_sysprep/sysprep sauvegarde

# choix de sauvegarde et restauration:
	echo "" > /tmp/sysprep_new_lance
	info_image gerer_sauvegardes_rst # si plusieurs sauvegardes sur le poste
	rm -f /tmp/sysprep_new_lance
        partition_oscar_new_sysprep=`cat /tmp/partition_linux_oscar_sauvegarde`
	rm -f /tmp/partition_linux_oscar_sauvegarde
	if ( test -e /tmp/sortir )
        then
        	rm -fR /tmp/new_sysprep
		rm -f /tmp/sortir
	else
		gerer_ip_serveur_etablissement
		rst
		if ( test -e /tmp/sortir )
		then
			rm -fR /tmp/new_sysprep
	        	rm -f /tmp/sortir
		fi
        fi
# sauvegarder est dans rst