#!/bin/sh



## Copyright (c) 2003-2013 Tissoires Jean-FranÃ§ois & Benjamin,  jftissoires@gmail.com
## Outil SystÃ¨me Complet d'Assistance RÃ©seau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et SystÃ¨mes: RapideSOS
## Ce programme est sous Licence Publique GÃ©nÃ©rale GNU publiÃ©e par la Free Software Foundation.

# la partition sdai est dans /tmp/partition_type_scsi_ide le type 'ide' ou 'scsi' est donnÃ© dans /tmp/partition_type_scsi_ide
# permet le contrÃ´le du client si ntfs partition sauvegardÃ©e vÃ©rifie IDE ou SATA

# on ne peut plus verifier si disque de type 'ide' ou 'scsi' depuis oscar 3.2.0
# verifier le répertoire si /dev/.udev/links/ contient une variable scsi ou ide
# il n'y a plus dans la ligne /dev/disk/by-path/ scsi et ide qui permettait la distinction
# on donne donc pour le serveur et le client le type scsi pour l'instant quand cela sera possible il faudra supprimer les 2 lignes suivantes
echo "" > /tmp/partition_type_scsi_ide
exit


#-----------------------------------------------------------------------------------------------------
comparer_uuid()
{
cut -d"," -f1 /tmp/temp_part2 > /tmp/temp_part1
nom_part_test=`cat /tmp/temp_part1`

if [ "$nom_part_test" != "" ]
then
	# sortir uuid de $partition_type_scsi_ide :
	# ancien : uuid_test=`vol_id -u /dev/disk/by-path/$nom_part_test`
	blkid -o full /dev/disk/by-path/`cat /tmp/temp_part1` > /tmp/temp_uuid_sdai
	perl -pi -e 's/UUID="/,/g;' /tmp/temp_uuid_sdai
	cut -d"," -f2 /tmp/temp_uuid_sdai > /tmp/temp_uuid_sdai1
	cut -d"\"" -f1 /tmp/temp_uuid_sdai1 > /tmp/temp_uuid_sdai
	uuid_test=`cat /tmp/temp_uuid_sdai`
	rm -f /tmp/temp_uuid_sdai
	rm -f /tmp/temp_uuid_sdai1
	
	if [ "$uuid_test" = "$uuid_sdai" ]	# c'est bien la partition
	then
		grep -i "\-ide\-" /tmp/temp_part1 > /tmp/temp_part2
		test_ide=`cat /tmp/temp_part2`
		if [ "$test_ide" != "" ]
		then
			echo "ide" > /tmp/partition_type_scsi_ide
		else
			echo "scsi" > /tmp/partition_type_scsi_ide
		fi
		return
	else	# tester la partition suivante
		echo "perl -pi -e 's/`cat /tmp/temp_part1`,//g;' /tmp/temp_part2" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		rm -f /tmp/exec_nom
		comparer_uuid
	fi
else
	echo "scsi" > /tmp/partition_type_scsi_ide	# par sÃ©curitÃ© on ne sait jamais pour ne pas bloquer
fi

}
#-----------------------------------------------------------------------------------------------------
partition_type_scsi_ide=`cat /tmp/partition_type_scsi_ide`
nom_part=`expr substr $partition_type_scsi_ide 4 3`
# ancien : ls /dev/disk/by-path/ | grep -i "pci" | grep -i part$nom_part > /tmp/temp_part
ls /dev/.udev/links/ | grep -i "pci" | grep -i part$nom_part | perl -pi -e 's/x2fpci/{pci/g;' > /tmp/temp_part
	cut -d"{" -f2 /tmp/temp_part > /tmp/temp_part1
	rm -f /tmp/temp_part
	echo `gawk '{ print $1 "," } ' /tmp/temp_part1` > /tmp/temp_part2
	rm -f /tmp/temp_part1
	perl -pi -e 's/, /,/g;' /tmp/temp_part2  ## pour enlever les espaces : pci-00...-scsi-parti,pci-...
	# toutes les partitions du type sÃ©parÃ©es par ,
	perl -pi -e 's/,
/,/g;' /tmp/temp_part2
	
	# sortir uuid de $partition_type_scsi_ide :
	# ancien : uuid_sdai=`vol_id -u /dev/$partition_type_scsi_ide 2>/dev/null`
	blkid -o full /dev/$partition_type_scsi_ide > /tmp/temp_uuid_sdai
	perl -pi -e 's/UUID="/,/g;' /tmp/temp_uuid_sdai
	cut -d"," -f2 /tmp/temp_uuid_sdai > /tmp/temp_uuid_sdai1
	cut -d"\"" -f1 /tmp/temp_uuid_sdai1 > /tmp/temp_uuid_sdai
	uuid_sdai=`cat /tmp/temp_uuid_sdai`
	rm -f /tmp/temp_uuid_sdai
	rm -f /tmp/temp_uuid_sdai1
	
	if [ "$uuid_sdai" = "" ] # partition qui ne possÃ¨de pas d'UUID anciens formatages
	then	# on ne peut pas vÃ©rifier sur le serveur ou le client
		echo "non_uuid" > /tmp/partition_type_scsi_ide
	else
		comparer_uuid
	fi
	rm -f /tmp/temp_part
	rm -f /tmp/temp_part1
	rm -f /tmp/temp_part2