#!/bin/sh


## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin,  jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.

PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

partition_oscar_image=`cat /tmp/partition_oscar_image`

#---------------------------------------------------------------------------------------------------
fichiers_avant_installe_oscar_dd()
{
cp -f $partition_oscar_image/cd_oscar/oscar/bin/fichier_r /etc/fichier_r	# resolution_vga
cp -f $partition_oscar_image/cd_oscar/oscar/bin/fichier_s /etc/fichier_s	# seul
cp -f $partition_oscar_image/cd_oscar/oscar/bin/fichier_t /etc/fichier_t	# tous
cp -f $partition_oscar_image/cd_oscar/oscar/bin/fichier_b /etc/fichier_b	# boot

cp -f $partition_oscar_image/cd_oscar/oscar/usr/choix_clavier /usr/share/oscar/usr/
cp -f $partition_oscar_image/cd_oscar/oscar/usr/choix_langue /usr/share/oscar/usr/

choix_langue=`cat /usr/share/oscar/usr/choix_langue`
traduction
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/lilo_expert )
then
	echo "" >  /etc/lilo_expert	# installer grub.conf  mais ne pas faire grub sur la partition de sauvegarde
fi
if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/grub_oscar_autres_systemes_ubuntu )
then
	cp -f $partition_oscar_image/cd_oscar/oscar/usr/grub_oscar_autres_systemes_ubuntu /tmp/tempmandriva
fi
if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/installer_grub2 )
then
	echo "" >  /etc/installer_grub2	# installer grub2
	cp -f $partition_oscar_image/cd_oscar/oscar/usr/superuser_oscar /usr/share/oscar/usr/superuser_oscar
	cp -f $partition_oscar_image/cd_oscar/oscar/usr/crypt_mot_passe_pbkdf2 /usr/share/oscar/usr/crypt_mot_passe_pbkdf2
	rm -f /etc/installer_grub1
fi
if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/installer_grub1 )
then
	echo "" >  /etc/installer_grub1	# installer grub1
	rm -f /etc/installer_grub2
fi
if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/etc_default_grub )
then
	cp -f $partition_oscar_image/cd_oscar/oscar/usr/etc_default_grub /etc/default/grub
fi

if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/installe_oscar_seul )
then
	cp -f $partition_oscar_image/cd_oscar/oscar/usr/installe_oscar_seul /etc/installe_oscar_seul
fi
if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/prive_40_custom )
then
	cp -f $partition_oscar_image/cd_oscar/oscar/usr/prive_40_custom /etc/conf.d/prive_40_custom
fi

if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/afficher_menu_grub )
then
	echo "" > /etc/afficher_menu_grub
fi
if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/fstab )
then
	rm -f /tmp/modifier_fstab
	echo " " > /tmp/modifier_fstab
fi
if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/grub.conf.expert )
then
	cp -f $partition_oscar_image/cd_oscar/oscar/usr/grub.conf.expert /etc/grub.conf.expert
fi
if ! ( test -e $partition_oscar_image/oscar/boot )
then
	mkdir $partition_oscar_image/oscar/boot
fi
cp -f $partition_oscar_image/cd_oscar/oscar/usr/oscar_usb/isolinux/oscar $partition_oscar_image/oscar/boot/
cp -f $partition_oscar_image/cd_oscar/oscar/usr/oscar_usb/isolinux/oscar.igz $partition_oscar_image/oscar/boot/
cp -f $partition_oscar_image/cd_oscar/oscar/usr/oscar_usb/isolinux/netboot $partition_oscar_image/oscar/boot/
}
#---------------------------------------------------------------------------------------------------
fichiers_apres_installe_oscar_dd()
{
cp -fr $partition_oscar_image/cd_oscar/oscar/bin/* $partition_oscar_image/bin/
cp -fr $partition_oscar_image/cd_oscar/oscar/bin/* $partition_oscar_image/usr/share/oscar/bin/
cp -fr $partition_oscar_image/cd_oscar/oscar/usr/* $partition_oscar_image/usr/share/oscar/usr/

if ! ( test -e $partition_oscar_image/cd_oscar/oscar/var_poste )
then
	mkdir $partition_oscar_image/cd_oscar/oscar/var_poste
else
	cp -fdpR $partition_oscar_image/cd_oscar/oscar/var_poste $partition_oscar_image/usr/share/oscar/
fi
# ci-dessous remet celui fstab du serveur : non car ecrase celui fait avec installe_oscar_dd 
# if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/fstab )
# then
#	cp -f $partition_oscar_image/cd_oscar/oscar/usr/fstab $partition_oscar_image/etc/fstab	# installer lilo mahuel sur la partition de sauvegarde
# fi
if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/etc_default_grub )
then
	cp -f $partition_oscar_image/cd_oscar/oscar/usr/etc_default_grub $partition_oscar_image/etc/default/grub
fi
if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/installe_oscar_seul )
then
	cp -f $partition_oscar_image/cd_oscar/oscar/usr/installe_oscar_seul $partition_oscar_image/etc/installe_oscar_seul
fi
if ( test -e $partition_oscar_image/cd_oscar/oscar/usr/afficher_menu_grub )
then
	echo "" > $partition_oscar_image/etc/afficher_menu_grub
fi

cp -f $partition_oscar_image/etc/conf.d/thttpd $partition_oscar_image/etc/conf.d/thttpd.bak
perl -pi -e 's/\/livemnt\/boot/\/usr\/share\/oscar\/usr\/oscar_usb/g;' $partition_oscar_image/etc/conf.d/thttpd
}
#----------------------------------------------------------------------------------------------------
bargraphe_decompression_oscar()
{
pourcentage_oscar=0
valeur_fin_oscar=0
while [ "$valeur_fin_oscar" != 1 ]
do
	sleep 1
	# taille des fichiers decompresses avec ls car petite partition
	ls -sR $partition_oscar_image/cd_oscar/oscar | grep total | awk '{print $2 "+" }' > /tmp/liste_du_total_fichiers_oscar	# par ligne : total valeur
	perl -pi -e 's/ //g;' /tmp/liste_du_total_fichiers_oscar
	taille_fichiers_decompresses=`cat /tmp/liste_du_total_fichiers_oscar`1-1
	rm -f /tmp/liste_du_total_fichiers_oscar
	taille_fichiers_decompresses=$[$taille_fichiers_decompresses]

	pourcentage_oscar=$[100*$taille_fichiers_decompresses/$taille_fichiers_oscar]

	if ( test -e /tmp/fin_decompression_oscar )
	then
		valeur_fin_oscar=1
		pourcentage_oscar=100
		rm -f /tmp/fin_decompression_oscar
	fi
	pourcentage_oscar=$[$pourcentage_oscar]
	echo $pourcentage_oscar
done | DIALOGRC="/etc/dialogmenu_bloque" dialog --colors\
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " OSCAR " \
	--gauge "\n\Zb\Z3  `cat $chemin_langue/selection_23` : \Z2$partition_oscar_image \n\n
	\n  `cat $chemin_langue/menu_74`\n\n  \Zb\Z2`cat $chemin_langue/Patience` ... " 12 80
}
#----------------------------------------------------------------------------------------------------
decompresser_fichiers_oscar()
{
rm -f /tmp/fin_decompression_oscar
tar -xpf oscar_seul_recept.tar.bz2 2>/dev/null 1>/dev/null	### les fichiers OSCAR envoyés sont dans le rep $partition_oscar_image/cd_oscar/oscar/
echo "" > /tmp/fin_decompression_oscar
}
#---------------------------------------------------------------------------------------------------
sp_decompresser_fichiers_oscar()
{
taille_fichiers_oscar=`cat /tmp/sp_taille_fichiers_oscar`
rm -f /tmp/sp_taille_fichiers_oscar
cd $partition_oscar_image/cd_oscar
if ( test -e /root/sysresccd-pkg.txt )	# démarrage cd sysrcd avec ou sans option cdcache ou démarrage ou pxe sur le poste si sysrcd
then	# menu pour sysrcd:
	decompresser_fichiers_oscar &
	bargraphe_decompression_oscar
else
	tar -xvpj f=oscar_seul_recept.tar.bz2	### les fichiers OSCAR envoyés sont dans le rep $partition_oscar_image/cd_oscar/oscar/
fi
cd /root
rm -f $partition_oscar_image/oscar_seul_recept.tar.bz2
}
#----------------------------------------------------------------------------------------------------
bargraphe_decompression_boot()
{
pourcentage_boot=0
valeur_fin_boot=0
while [ "$valeur_fin_boot" != 1 ]
do
	sleep 1
	# taille des fichiers decompresses
	ls -sR $partition_oscar_image/cd_oscar/$partition_juste_boot | grep total | awk '{print $2 "+" }' > /tmp/liste_du_total_fichiers_boot	# par ligne : total valeur
	perl -pi -e 's/ //g;' /tmp/liste_du_total_fichiers_boot
	taille_fichiers_decompresses=`cat /tmp/liste_du_total_fichiers_boot`1-1
	rm -f /tmp/liste_du_total_fichiers_boot
	taille_fichiers_decompresses=$[$taille_fichiers_decompresses]

	pourcentage_boot=$[100*$taille_fichiers_decompresses/$taille_fichiers_boot]

	if ( test -e /tmp/fin_decompression_boot )
	then
		valeur_fin_boot=1
		pourcentage_boot=100
		rm -f /tmp/fin_decompression_boot
	fi
	pourcentage_boot=$[$pourcentage_boot]
	echo $pourcentage_boot
done | DIALOGRC="/etc/dialogmenu_bloque" dialog --colors\
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " BOOT " \
	--gauge "\n\Zb\Z3  `cat $chemin_langue/texte_29a` \Z2$partition_juste_boot \n\n
	\n  `cat $chemin_langue/menu_74`\n\n  \Zb\Z2`cat $chemin_langue/Patience` ... " 12 80
}
#----------------------------------------------------------------------------------------------------
decompresser_fichiers_boot()
{
rm -f /tmp/fin_decompression_boot
tar -xpf juste_boot_recept.tar.bz2 2>/dev/null 1>/dev/null	### les fichiers juste_boot sont dans le rep /mnt/$partition_juste_boot
echo "" > /tmp/fin_decompression_boot
}
#---------------------------------------------------------------------------------------------------
sp_decompresser_fichiers_boot()
{
partition_juste_boot=`cat /tmp/sp_partition_juste_boot`
taille_fichiers_boot=`cat /tmp/sp_taille_fichiers_boot`
rm -f /tmp/sp_partition_juste_boot
rm -f /tmp/sp_taille_fichiers_boot
cd /$partition_oscar_image/cd_oscar
if ( test -e /root/sysresccd-pkg.txt )	# démarrage cd sysrcd avec ou sans option cdcache ou démarrage ou pxe sur le poste si sysrcd
then	# menu pour sysrcd:
	decompresser_fichiers_boot &
	bargraphe_decompression_boot
else
	tar -xvpj f=juste_boot_recept.tar.bz2	### les fichiers juste_boot sont dans le rep /mnt/$partition_juste_boot
fi
cd /root
}
#---------------------------------------------------------------------------------------------------
#  commandes externes de procédures
case "$1" in
	fichiers_apres_installe_oscar_dd)
		fichiers_apres_installe_oscar_dd
		exit 0
	;;
	sp_decompresser_fichiers_oscar)
		sp_decompresser_fichiers_oscar
		exit 0
	;;
	sp_decompresser_fichiers_boot)
		sp_decompresser_fichiers_boot
		exit 0
	;;
esac

cp -f /tmp/partition_oscar_image /tmp/partition_oscar_image1
perl -pi -e 's/\/mnt\///g;' /tmp/partition_oscar_image1
cp -f /tmp/partition_oscar_image1 /tmp/monter_partition
rm -f /tmp/partition_oscar_image1
runme autoriser_monter_partition_oscar
rm -f /tmp/monter_partition

fichiers_avant_installe_oscar_dd