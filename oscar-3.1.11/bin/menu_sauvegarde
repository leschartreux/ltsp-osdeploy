#!/bin/bash

## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin,  jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.

#   programme de menu administrateur réseau pour l'autorun

#----------------------------------------------------------------------------------------------------
eteindre_le_poste()
{
runme boite_eteindre_le_poste
if ( test -e /tmp/annuler_eteindre )
then
	rm -f /tmp/annuler_eteindre
	main
	return
fi

runme boite_eteindre_ordinateur
}
#----------------------------------------------------------------------------------------------------
boucle()  # retour au programme principal
{
echo
echo -e "`cat $chemin_langue/boucle_1`"
echo -ne "`cat $chemin_langue/boucle_2`"
read reponse
main
}
#----------------------------------------------------------------------------------------------------
boite_desole_pas_partition_oscar()
{
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\n`cat $chemin_langue/msgbox_2`\n\n " 10 61
rm -f /tmp/formatage_linux
rm -f /tmp/temp_image
}
#----------------------------------------------------------------------------------------------------
changer_numero_poste()
{
	serveur_clone cherche_image	# dans /tmp/formatage_linux : $reponse,linux_jfs ou $reponse,linux_ext4 ou $reponse,linux_ext3 ou $reponse,linux_xfs ou $reponse,linux_reiserfs $reponse,linux_reiser4
	rm -f /tmp/formatage_linux
	if ( test -e partition_linux_sauvegarde )
	then
		cp -f partition_linux_sauvegarde /tmp/monter_partition
		runme autoriser_monter_partition_oscar
		partition_oscar=`cat /tmp/monter_partition`
		rm -f /tmp/monter_partition
		rm -f partition_linux_sauvegarde	
		if ! ( test -e $partition_oscar/oscar/var_poste )
		then
			mkdir $partition_oscar/oscar/var_poste
		fi
		if ! ( test -e $partition_oscar/oscar/var_poste/numero_poste_client )
		then
			echo "" > $partition_oscar/oscar/var_poste/numero_poste_client
		fi
		defaut=`cat $partition_oscar/oscar/var_poste/numero_poste_client`
		# numero du poste :
		DIALOGRC="/etc/dialogrc" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--cancel-label "`cat $chemin_langue/Annuler`"  --title " `cat $chemin_langue/inputbox_1` " \
		--inputbox "\n`cat $chemin_langue/inputbox_2`" 12 50 $defaut 2>/tmp/tempfile
		case $? in
		    0)	rm -f /tmp/fichier_disque_dur
			teste_numero_client test_caractere
			if ( test -e /tmp/sortir )
		        then
		        	rm -f /tmp/tempfile
	    			rm -f /tmp/sortir
	    			return
			else
				cp -f /tmp/tempfile $partition_oscar/oscar/var_poste/numero_poste_client
				rm -f /tmp/tempfile
			fi
			;;
		    1)  rm -f /tmp/fichier_disque_dur
			rm -f /tmp/tempfile
			if [ "$commande_ajouter_postes" = oui ]
			then
				commande_ajouter_postes=
		        	echo "" > /tmp/sortir
		        fi
			;;
		    255) rm -f /tmp/fichier_disque_dur
			rm -f /tmp/tempfile
		        if [ "$commande_ajouter_postes" = oui ]
			then
				commande_ajouter_postes=
		        	echo "" > /tmp/sortir
		        fi
			;;
		esac
	else
		boite_desole_pas_partition_oscar
	fi
	rm -f /tmp/formatage_linux
	rm -f /tmp/temp_image
}
#----------------------------------------------------------------------------------------------------
main()
{
rm -f /tmp/sortir
rm -f /tmp/tempfile # des menus precedents sauf celui-ci /tmp/tempfile___
rm -f /tmp/tempfile__

rm -f /tmp/tempfile____
rm -f /tmp/tempfile_____
rm -f /tmp/tempfile______
rm -f /tmp/tempfile_______

calendrier=$(date +%d/%m/%y)
heure=$(date +%kh%Mmin)

###	incrémenter "\Z1Ajouter une sauvegarde \Znsur la partition de sauvegarde si la place est suffisante." \

rm -f /tmp/rien
echo "\Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn \Zn  \Zn  \Zn  \Zn  " > /tmp/rien
output=exit
dialog  --no-cancel --colors --no-shadow \
	--backtitle "`cat /etc/banniere_oscar`" --title " `cat $chemin_langue/menu_11` " \
	--menu  "\n  `cat $chemin_langue/menu_1` `cat /tmp/rien`  le $calendrier à $heure\n " 9 80 0 \
	"information" "`cat $chemin_langue/menu_12`" \
	"sauve" "`cat $chemin_langue/menu_13`" \
	"restaure" "`cat $chemin_langue/menu_14`" \
	" " "" \
	"copie_sauvegarde" "`cat $chemin_langue/menu_15`" \
	"recup_sauvegarde" "`cat $chemin_langue/menu_17`" \
	"recup_CD-DVD" "`cat $chemin_langue/menu_16`" \
	"numero_poste" "`cat $chemin_langue/menu_18`" \
	"ajouter_postes" "`cat $chemin_langue/menu_18a`" \
	"supprimer" "`cat $chemin_langue/menu_19`" \
	" " "" \
	"transfert_ssh" "`cat $chemin_langue/menu_17a`" \
	"partitions" "`cat $chemin_langue/menu_20`" \
	"sauve_blocs" "`cat $chemin_langue/menu_13a`" \
	" " "" \
        "halt" "`cat $chemin_langue/menu_8`" \
	"oscar" "`cat $chemin_langue/menu_21`" 2>/tmp/tempfile___
	
if [ $? = "255" ]
then
    rm -f /tmp/tempfile___
    rm -f /tmp/rien
    exit
fi
output=`cat /tmp/tempfile___`
rm -f /tmp/rien

if [ "$output" = " " ]
then
	main
elif [ "$output" = "" ]
then
	main
elif [ $output = "information" ]
then
	info_image
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	fi
	while ( test -e /tmp/lancer_info )
	do
		rm -f /tmp/lancer_info
		info_image
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
		fi
	done
	main
elif [ "$output" = "sauve" ]
then
	echo "" > /tmp/sauve_fsa
	sauve
	main
elif [ "$output" = "sauve_blocs" ]
then
	rm -f /tmp/sauve_fsa
	sauve
	main
elif [ "$output" = "restaure" ]
then
	info_image gerer_sauvegardes_rst # si plusieurs sauvegardes sur le poste
        if ( test -e /tmp/sortir )
        then
		rm -f /tmp/sortir
	else
		echo "" > /tmp/menu_admin_rst
		rst
		if ( test -e /tmp/sortir )
		then
	        	rm -f /tmp/sortir
		fi
        fi
elif [ "$output" = "teste_sauvegarde" ]
	then
		test_rst
	main
elif [ "$output" = "copie_sauvegarde" ]
then
        transfert_sauvegarde
        main
elif [ "$output" = "transfert_ssh" ]
then
        menu_transfert_ssh
        main
elif [ "$output" = "recup_CD-DVD" ]
then
        recup_depuis_dvd
        main
elif [ "$output" = "recup_sauvegarde" ]
then
        recup_sauvegarde
        main
elif [ "$output" = "incrémenter" ]
then
	info_image incrementer_sauvegarde
	while ( test -e /tmp/lancer_info )
	do
		rm -f /tmp/lancer_info
		info_image
	done
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	fi
        main
elif [ "$output" = "supprimer" ]
then
	info_image supprimer_sauvegarde
	
	rm -f /tmp/pas_repertoire_oscar_par_defaut
	rm -f /tmp/une_seule_image_trouvee
	rm -f /tmp/nouvelle_sauvegarde
	rm -f /tmp/incrementer_sauvegarde
	rm -f /tmp/partition_oscar_sauvegarde
	rm -f /tmp/partition_linux_oscar_sauvegarde
	rm -f /tmp/partition_possible_sauvegarde
	rm -f /tmp/sauvegarde_trouvee
	rm -f /tmp/sortir

	while ( test -e /tmp/lancer_info )
	do
		rm -f /tmp/lancer_info
		info_image
		
		rm -f /tmp/pas_repertoire_oscar_par_defaut
		rm -f /tmp/une_seule_image_trouvee
		rm -f /tmp/nouvelle_sauvegarde
		rm -f /tmp/incrementer_sauvegarde
		rm -f /tmp/partition_oscar_sauvegarde
		rm -f /tmp/partition_linux_oscar_sauvegarde
		rm -f /tmp/partition_possible_sauvegarde
		rm -f /tmp/sauvegarde_trouvee
		rm -f /tmp/sortir
	done
        main
elif [ $output = "partitions" ]
then
	runme information_dd
	main
elif [ $output = "ajouter_postes" ]
then
	commande_ajouter_postes=oui
	changer_numero_poste
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	else
		sysprep_new
	fi
	main
elif [ $output = "numero_poste" ]
then
	commande_ajouter_postes=
	changer_numero_poste
	main
elif [ "$output" = "halt" ]
then
	rm -f /tmp/tempfile___
        eteindre_le_poste
elif [ $output = "oscar" ]
then
	rm -f /tmp/tempfile___
	exit
else
	$output
fi
rm -f /tmp/tempfile___
boucle
}
#----------------------------------------------------------------------------------------------------
PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

#  commandes externes de procédures
case "$1" in
	changer_numero_poste)
		commande_ajouter_postes=
		changer_numero_poste
	exit 0
	;;
esac
main