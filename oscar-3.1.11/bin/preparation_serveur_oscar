#!/bin/bash

## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin,  jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.

PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue



#-----------------------------------------------------------------------------------------------------
boite_domaine()
{
	# Integration au domaine
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`" --ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/menu_453a` $texte_titre " \
	--menu "\n\Zb\Z4   `cat $chemin_langue/menu_454a` " 8 80 0 \
	"" "" \
	"" "\Z2`cat $chemin_langue/menu_457a` :" \
	"" "" \
	"" "\Z2`cat $chemin_langue/menu_458a`" \
	"" "    \Z2`cat $chemin_langue/menu_458b` \Zb\Z3 C:\sysprep" \
	"" "    \Z2`cat $chemin_langue/menu_458c` \Zb\Z3 C:\oscar\newsid.exe" \
	"" "" \
	"" "    \Zb\Z1`cat $chemin_langue/menu_460` ! \Zn " \
	"" "" \
	"" "\Z2`cat $chemin_langue/menu_461`." \
	"" ""
	case $? in
	    0)	
	   	 ;;
	  
	    1)	echo "" > /tmp/sortir
		exit;;
		
	    255) echo "" > /tmp/sortir
		 exit;;
	esac
}
#-----------------------------------------------------------------------------------------------------
boite_defaut()
{
	# Aide à la préparation du serveur OSCAR
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`" --ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/menu_453` $texte_titre " \
	--menu "\n\Zb\Z4   `cat $chemin_langue/menu_454` " 8 80 0 \
	"" "`cat /tmp/textetmp3`" \
	"" "" \
	"" "\Z2`cat $chemin_langue/menu_457` :" \
	"" "" \
	"" "\Z2`cat $chemin_langue/menu_458` \Zb\Z3 C:\oscar.bat" \
	"" "\Z2`cat $chemin_langue/menu_459`" \
	"" "\Zb\Z3C:\Documents and Settings\All Users\\`cat $chemin_langue/menu_462` \Zn " \
	"" "" \
	"" "\Zb\Z1`cat $chemin_langue/menu_460` !  \Zn " \
	"" "" \
	"" "\Z2`cat $chemin_langue/menu_461`." \
	"" ""
	case $? in
	    0)	
	   	 ;;
	  
	    1)	echo "" > /tmp/sortir
		exit;;
		
	    255) echo "" > /tmp/sortir
		 exit;;
	esac
}
#-----------------------------------------------------------------------------------------------------
affichage_defaut()
{
echo "`cat $chemin_langue/recapitule_4` \Z3`cat domaine` " > /tmp/tempaff1
echo "`cat $chemin_langue/recapitule_5` \Z3`cat $chemin_langue/recapitule_8` DHCP " > /tmp/tempaff2
echo "`cat $chemin_langue/recapitule_5` \Z3`cat $chemin_langue/recapitule_9` \Zn`cat ip_colore` " > /tmp/tempaff3
echo "`cat $chemin_langue/recapitule_6` \Z3`cat ip_masque` " > /tmp/tempaff4
echo "`cat $chemin_langue/recapitule_7` \Z3`cat ip_passerelle` " > /tmp/tempaff5
}
#-----------------------------------------------------------------------------------------------------
affichage_sysprep()
{
echo "`cat $chemin_langue/recapitule_4` \Z3$methode_deploie " > /tmp/tempaff1
echo " " > /tmp/tempaff2
echo " " > /tmp/tempaff3
echo " " > /tmp/tempaff4
echo " " > /tmp/tempaff5

}
#-----------------------------------------------------------------------------------------------------
affichage()
{
	if ! [ "$valeur" = "nonvfat" ]	## il y a une partition vfat
	then
		echo "`cat /tmp/tempaff1`" > /tmp/fichiertmp3

		valeur=`cat ip_format`
		if [ "$valeur" = "non_ip" ]	## affectation automatique
		then
			echo "`cat /tmp/tempaff2`" > /tmp/fichiertmp4
			echo " " > /tmp/fichiertmp41
			echo " " > /tmp/fichiertmp42
		else
			echo "`cat /tmp/tempaff3`" > /tmp/fichiertmp4
			echo "`cat /tmp/tempaff4`" > /tmp/fichiertmp41
			echo "`cat /tmp/tempaff5`" > /tmp/fichiertmp42
		fi
	else
			echo " " > /tmp/fichiertmp4
			echo "  `cat $chemin_langue/recapitule_10` " > /tmp/fichiertmp41
			echo " " > /tmp/fichiertmp42
	fi
	rm -f /tmp/tempaff1
	rm -f /tmp/tempaff2
	rm -f /tmp/tempaff3
	rm -f /tmp/tempaff4
	rm -f /tmp/tempaff5
	
	if ! (test -e /tmp/serveur_nfs )
	then
	        if ( test -e adresse_synchrone )
		then
			## si ancienne version prendre seulement le premier terme
			rm -f /tmp/tempfile
			echo `cut -d"." -f1 adresse_synchrone` > /tmp/tempfile	
			cp -f /tmp/tempfile adresse_synchrone
			rm -f /tmp/tempfile
			adresse_synchrone_un=`cat adresse_synchrone`
		else
			rm -f adresse_synchrone
			echo "232" > adresse_synchrone
		fi
		rm -f adresse_synchrone
		echo "232" > adresse_synchrone	## on ne peut changer cette valeur
		ip_installe=`cat ip_installe_poste` # ip du poste
		rm -f /tmp/tempfile
		echo `cut -d"." -f1-3 ip_installe_poste` > /tmp/tempfile
		adresse_synchrone_deux=`cat /tmp/tempfile`.255
		rm -f /tmp/tempfile
		echo `cut -d"." -f2-4 ip_installe_poste` > /tmp/tempfile
		adresse_synchrone_ctrl=$adresse_synchrone_un.`cat /tmp/tempfile`
		rm -f /tmp/tempfile
		echo "`cat $chemin_langue/recapitule_14` \Z3$adresse_synchrone_ctrl\Z4 ; \Z3$adresse_synchrone_deux " > /tmp/fichiertmp6
		texte_transmission="`cat $chemin_langue/menu_408` \Z3`cat vitesse_transmission`b/s \Z4(`cat $chemin_langue/menu_409`) "
	else
	    texte_transmission=
	    echo "" > /tmp/fichiertmp6
	fi

	# Configuration du réseau
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`" --ok-label "`cat $chemin_langue/Accepter`" \
	--extra-button --extra-label "`cat $chemin_langue/Modifier`" \
	--title " `cat $chemin_langue/menu_452` " \
	--menu "\n\Zb\Z4   `cat $chemin_langue/menu_451` : \n\n" 8 0 0 \
	"" "" \
	"" "`cat $chemin_langue/Installation` \Zn: " \
	"" "" \
	"" "$texte_transmission" \
	"" "\Zb\Z4`cat /tmp/fichiertmp2`" \
	"" "\Zb\Z4`cat /tmp/fichiertmp3`" \
	"" "\Zb\Z4`cat /tmp/fichiertmp4`" \
	"" "\Zb\Z4`cat /tmp/fichiertmp41`" \
	"" "\Zb\Z4`cat /tmp/fichiertmp42`" \
	"" "\Zb\Z4`cat /tmp/fichiertmp5`" \
	"" "\Zb\Z4`cat /tmp/fichiertmp6`" \
	"" "\Zb\Z4`cat /tmp/fichiertmp7`" \
	"" "" \
	"" ""
	case $? in
	    0)
	        rm -f /tmp/tempfile
		echo "accepter" > /tmp/tempfile
	        exit;;
	  
	    1)	echo "" > /tmp/sortir
		exit;;
	    3)	
		rm -f /tmp/tempfile
		echo "modifier" > /tmp/tempfile
		exit;;
			
	    255) echo "" > /tmp/sortir
		 exit;;
	esac
}
#-----------------------------------------------------------------------------------------------------

#----------------------------------------------------------------------------------------------------
#                   BOUCLE PRINCIPALE
#----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
main() # boucle principale
{
if ! (test -e /tmp/serveur_nfs )
then
    texte_titre="`cat $chemin_langue/menu_455`"
else
    texte_titre="`cat $chemin_langue/menu_456`"
fi

	rm -f /tmp/fichiertmp2
	rm -f /tmp/fichiertmp3
	rm -f /tmp/fichiertmp4
	rm -f /tmp/fichiertmp41
	rm -f /tmp/fichiertmp42
	rm -f /tmp/fichiertmp6
	
	if [ "$lance_serveur_clone" = "oui" ]
	then
		echo "`cat $chemin_langue/recapitule_13` \Z3`cat formatage_disques` " > /tmp/fichiertmp2
	else
		echo " " > /tmp/fichiertmp2
	fi
	valeur=`cat partition_oscar`

if ( test -e /tmp/sysprep_installe )
then
	affichage_sysprep_ou_deploie=`cat /tmp/sysprep_installe`
	if [ "$affichage_sysprep_ou_deploie" = oscar_deploie ]
	then
		methode_deploie="OSCAR deploie et renomme"
	else
		methode_deploie=sysprep
	fi
	affichage_sysprep
elif ( test -e /tmp/newsid_installe )
then
	# boite_defaut
	affichage_defaut
else
	# boite_defaut
	# boite_domaine
	affichage_defaut
fi

# echo "`cat $chemin_langue/menu_266b` \Z3`cat $chemin_langue/menu_266c` " > /tmp/fichiertmp7

if ( test -e /tmp/serveur_nfs )
then
	echo "" > /tmp/fichiertmp6
fi
affichage
}
#---------------------------------------------------------------------------------------------------
demande_un_ou_plusieurs_serveurs()
{
rm -f /tmp/le_poste_s_eteint
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Eteindre`" --cancel-label "`cat $chemin_langue/Annuler`" --title " `cat $chemin_langue/menu_157` " \
	--extra-button --extra-label "`cat $chemin_langue/Attendre`" \
	--menu "\Zb\Z3 `cat $chemin_langue/Choisissez` : " 0 0 0 \
	"" "" \
	"" "\Zb\Z4`cat $chemin_langue/menu_264a`" \
	"" "" \
	"" ""
case $? in
	3)	rm -f /tmp/le_poste_s_eteint
	;;
	0)  echo "" > /tmp/le_poste_s_eteint
	;;
	1) 
	rm -f /tmp/le_poste_s_eteint
	;;
	255) 
	rm -f /tmp/le_poste_s_eteint
	;;
esac
}
#-----------------------------------------------------------------------------------------------------
boite_eteindre_avec_plusieurs_serveurs_ancien()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Important`" --cancel-label "`cat $chemin_langue/Eteindre`" --title " `cat $chemin_langue/menu_157` " \
	--extra-button --extra-label "`cat $chemin_langue/Quitter`" \
	--menu "\Zb\Z3 `cat $chemin_langue/ATTENTION` : " 0 0 0 \
	"" "" \
	"" "\Zb\Z1 `cat $chemin_langue/menu_267d` " \
	"" "" \
	"" "\Zb\Z1 `cat $chemin_langue/menu_267e` " \
	"" ""
case $? in
	3)
	;;
	0)  boite_eteindre_avec_plusieurs_serveurs
	;;
	1) eteindre_un_seul_serveur
	;;
	255) boite_eteindre_avec_plusieurs_serveurs
	;;
esac
}
#-----------------------------------------------------------------------------------------------------
eteindre_un_seul_serveur()
{	
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/infobox_1` " \
	--infobox "\n\n\n`cat $chemin_langue/infobox_2`\n\n\n\n" 0 0

for passe in 8 7 6 5 4 3 2 1 STOP
do
    sleep 1
    echo -en "\033[1;31m  > $passe\033[1;m"
done
sleep 10	# 10 s
# sleep 900	# 15 min
runme supprimer_ip_ethernet
/etc/init.d/nfs stop
if ( test -e /etc/cdrom_ejecte )
then
	eject -t
fi
umount -a 2>/dev/null ; sync
halt
sleep 10
}
#-----------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------
#  commandes externes de procédures
case "$1" in
	demande_un_ou_plusieurs_serveurs)
		demande_un_ou_plusieurs_serveurs
		exit 0
	;;
	boite_eteindre_avec_plusieurs_serveurs)
		boite_eteindre_avec_plusieurs_serveurs
		exit 0
	;;
	eteindre_un_seul_serveur)
		eteindre_un_seul_serveur
		exit 0
	;;
esac

if ( test -e /tmp/lance_serveur_clone )
then
	rm -f /tmp/lance_serveur_clone
	lance_serveur_clone=oui
fi
main
