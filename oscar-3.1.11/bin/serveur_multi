#!/bin/sh

## Copyright (c) 2003-2013 Tissoires Jean-FranÃ§ois & Benjamin, jftissoires@gmail.com
## Cdrom Outil SystÃ¨me Complet d'Assistance RÃ©seau: OSCAR
## Ce programme est sous Licence Publique GÃ©nÃ©rale GNU publiÃ©e par la Free Software Foundation.


PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue


#----------------------------------------------------------------------------------------------------
boucle_partition() # sortir la partition dans la reponse
{
	rm -f /tmp/tempfile
	echo "$type" > /tmp/tempfile
	runme prepare_boucle_partition
	nombretype=`cat /tmp/nombre`
	rm -f /tmp/nombre

numero=0
cp -f /tmp/tempfile /tmp/temp_ligne_deux_points
rm -f /tmp/tempfile
until  ( test  $numero = $nombretype )
    do
	rm -f /tmp/temp_ligne_deux_points1
#	rm -f /tmp/partfile1
	numero=$[$numero+1]
	cut -d":" -f$numero /tmp/temp_ligne_deux_points > /tmp/temp_ligne_deux_points1	#hdaiii
#	cut -d":" -f$numero /tmp/partfile > /tmp/partfile1	#ide/h0/b0/t0/l0/hdaiii
	reponse=`cat /tmp/temp_ligne_deux_points1`
	#reparti=$reponse
#	reparti=`cat /tmp/partfile1`
	rm -f /tmp/temp_ligne_deux_points1
	numero_hd=`expr substr $reponse 4 3`
	disque=`expr substr $reponse 1 3`       #hda
#	disque=`cut -d/ -f1-5 /tmp/partfile1`/disc	#ide/h0/b0/t0/l0/disc
#	rm -f /tmp/partfile1
        if [ "$type" = "linux" ]
	then
        	# id_type=`sfdisk /dev/$disque -c $numero_hd 2>/dev/null`
		grep -i $reponse /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
	        nb_partition_linux=`cat /tmp/nb_partition_linux`
	        rm -f /tmp/nb_partition_linux
		if [ "$nb_partition_linux" = "1" ] # partition linux non swap
		then
			#if ! ( test -e /mnt/$reponse )
			#	then	mkdir /mnt/$reponse
			#fi
			
			echo "$reponse" > /tmp/monter_partition
			runme autoriser_monter_partition_oscar
			# linux_sauvegarde=`cat /tmp/monter_partition`
			image_serveur=`cat /tmp/monter_partition`
			rm -f /tmp/monter_partition
			
#			nombpart=`cat /tmp/nombpart`
#			if [ "$nombpart" = 0 ]
#			then
#				mount /dev/$reponse /mnt/$reponse
#			fi
			
			if ( test -e $image_serveur/image.partimage.000 ) ## sauvegarde dans ancienne version
			then
				rm -f partition_de_sauvegarde
				echo "$reponse" > partition_de_sauvegarde
				changement_version_oscar changement_partition_sauvegarde
			fi
			if ( test -e $image_serveur/oscar/image.partimage.000 ) || ( test -e $image_serveur/oscar/image.ntfs.00 ) || ( test -e $image_serveur/oscar/image_dar.1.dar ) || ( test -e $image_serveur/oscar/image_fsa.fsa )
			then
				image_trouvee=oui
				rm -f /tmp/temp_ligne_deux_points
		#		rm -f /tmp/partfile
				return
			elif ( test -e $image_serveur/usr/share/oscar/usr/oscar_usb )
			then
				partition_oscar_sans_sauvegarde=$reponse
				return
			fi
		fi
	fi
    done
rm -f /tmp/tempfile
# rm -f /tmp/partfile
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
#	Recherche d'une image
#----------------------------------------------------------------------------------------------------

cherche_image()		# recherche sur le disque dur la partition oÃ¹ se trouve l'image
{
type="linux"
image_trouvee=non
partition_oscar_sans_sauvegarde=non
boucle_partition
	if [ "$image_trouvee" = "oui" ] # la sauvegarde est trouvÃ©e sur nappe hd ou sd
	then
#		linux_sauvegarde=$partition_linux
		partition_image=$reponse	# ne sert pas pour ce programme
	fi
}
#  fin de recherche de l'image
#-----------------------------------------------------------------------------------------------------
boites_serveur_oscar()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors  \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" --cancel-label "`cat $chemin_langue/Annuler`" --extra-button --extra-label "`cat $chemin_langue/repertoire_4`" \
	--title " `cat $chemin_langue/menu_130` " \
	--menu "`cat /tmp/fichiertmp2`" 10 80 0  \
	"" "`cat $chemin_langue/menu_131`\Zn\Z2 $salle_clients \Zn " \
	"" "" \
	"" "`cat $chemin_langue/menu_74`" \
	"" "" \
	"" "`cat $chemin_langue/menu_132`" \
	"" "\Zn --> `cat $chemin_langue/menu_120`." \
	"" "" \
	"" "`cat $chemin_langue/menu_77`" \
	"" "\Zn --> `cat $chemin_langue/menu_76` \Zb\Z4client\Zn "
      case $? in
	    0)	rm -f /tmp/fichiertmp
		rm -f /tmp/fichiertmp2
		rm -f /tmp/fichiertxt
		;;
	    3)  dialog  --colors --backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/repertoire_4` " \
			--exit-label "`cat $chemin_langue/Retour`" --textbox "/tmp/fichiertxt" 0 0
	    	boites_serveur_oscar;;
	    1)  rm -f /tmp/fichiertmp
		rm -f /tmp/fichiertmp2
		rm -f /tmp/fichiertxt
		rm -f /tmp/sortir
		echo " " > /tmp/sortir
		return
		;;
	    255) rm -f /tmp/fichiertmp
		rm -f /tmp/fichiertmp2
		rm -f /tmp/fichiertxt
		rm -f /tmp/sortir
		echo " " > /tmp/sortir
		return
		;;
	esac 
}
#-----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
boites_serveur_multi()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors  \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" --cancel-label "`cat $chemin_langue/Annuler`" --extra-button --extra-label "`cat $chemin_langue/repertoire_4`" \
	--title " `cat $chemin_langue/menu_133` " \
	--menu "`cat /tmp/fichiertmp2`" 10 80 0  \
	"" "`cat $chemin_langue/menu_134`" \
	"" "" \
	"" "`cat $chemin_langue/menu_74`" \
	"" "" \
	"" "`cat $chemin_langue/menu_119` \Zb\Z4client\Zn " \
	"" "" \
	"" "\Zn --> `cat $chemin_langue/menu_120` : "
      case $? in
	    0)	rm -f /tmp/fichiertmp
		rm -f /tmp/fichiertmp2
		rm -f /tmp/textetmp1
		rm -f /tmp/textetmp2
		rm -f /tmp/fichiertxt
		;;
	    3)  dialog  --colors --backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/repertoire_4` " \
			--exit-label "`cat $chemin_langue/Retour`" --textbox "/tmp/fichiertxt" 0 0
	    	boites_serveur_multi;;
	    1)  rm -f /tmp/fichiertmp
		rm -f /tmp/fichiertmp2
		rm -f /tmp/textetmp1
		rm -f /tmp/textetmp2
		rm -f /tmp/fichiertxt
		exit
		;;
	    255) rm -f /tmp/fichiertmp
		rm -f /tmp/fichiertmp2
		rm -f /tmp/textetmp1
		rm -f /tmp/textetmp2
		rm -f /tmp/fichiertxt
		exit;;
	esac 
}
#-----------------------------------------------------------------------------------------------------
#
#-----------------------------------------------------------------------------------------------------
demande_type_windows_version_regedit_ancien()  # juste pour le reboot car REGEDIT4 convient aussi pour XP
{
#  a utiliser pour NT
		echo
		echo -en "Donnez la\033[1;34m version windows \033[1;mde ce poste, tapez\033[1;33m xp \033[1;m(pour XP;2000) ou  \033[1;33m98 \033[1;m(pour windows98) : "	
		read reponse
		if [ "$reponse" = "" ]
		then demande_type_windows_version_regedit
		elif [ "$reponse" = "xp" ] || [ "$reponse" = "XP" ]
		then echo "windowsxp" > /tmp/version_windows
		elif [ "$reponse" = "98" ] 
		then echo "windows98" > /tmp/version_windows
		else
		demande_type_windows_version_regedit
		fi		
}
#-----------------------------------------------------------------------------------------------------
boite_limite_logiciel() # dÃ©passe capacitÃ© logicielle
{
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "`cat $chemin_langue/msgbox_11`" 0 0
        rm -f /tmp/fichiertmp
        exit
}
#-----------------------------------------------------------------------------------------------------
demande_reboot_clients()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Oui`" --cancel-label "Reboot" \
	--title " `cat $chemin_langue/menu_83a` " \
	--menu "\n  \Zb\Z3`cat $chemin_langue/menu_684a` : \n" 8 65 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_85a``cat $chemin_langue/Oui`" \
	"" " " \
	"" "`cat $chemin_langue/menu_85b`" \
	"" " "
case $? in
	0)	reboot_clients=non_reboot
		afficher_reboot_clients=`cat $chemin_langue/non`
		;;
	1)	reboot_clients=oui_reboot
		afficher_reboot_clients=reboot
		;;
	255)	demande_reboot_clients
		;;
esac
}
#-----------------------------------------------------------------------------------------------------
boite_envoi_oscar_dd()	# demander l'autorisation d'envoi du cd oscar
{
envoyer_oscar_seul=non
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/menu_81`" --cancel-label "`cat $chemin_langue/menu_82`" \
	--title " `cat $chemin_langue/menu_83` " \
	--menu "`cat $chemin_langue/menu_84`" 8 65 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_85`" \
	"" "" \
	"" "" \
	"" "`cat $chemin_langue/menu_86`" \
	"" ""
      case $? in
	    0)	rm -f /tmp/fichiertmp
		cut -f2 -d"," $image_serveur/oscar/date_oscar > /tmp/fichiertmp
 		date=`cat /tmp/fichiertmp`
 		rm -f $image_serveur/oscar/date_oscar
 		echo "non,$date" > $image_serveur/oscar/date_oscar
 		envoyer_oscar=non
	    return;;
	    1)  rm -f /tmp/fichiertmp
		cut -f2 -d"," $image_serveur/oscar/date_oscar > /tmp/fichiertmp
 		date=`cat /tmp/fichiertmp`
 		rm -f $image_serveur/oscar/date_oscar
 		echo "oui,$date" > $image_serveur/oscar/date_oscar
		envoyer_oscar=oui
		envoyer_oscar_seul=non
	    return ;;
	    255) boite_envoi_oscar_dd
	    ;;
	esac
}
#-----------------------------------------------------------------------------------------------------
boite_salle()	# si serveur_oscar envoi la premiere fois
{
	rm -f /tmp/tempfile
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " `cat $chemin_langue/inputbox_7` " \
	--inputbox "`cat $chemin_langue/inputbox_8`" 10 64 $salle_clients 2>/tmp/tempfile
	case $? in
	    1)  rm -f /tmp/tempfile
		exit
		;;
	    255) rm -f /tmp/tempfile
		exit
		;;
	esac
	reponse=`cat /tmp/tempfile`
	salle_clients=`cat /tmp/tempfile`
	boite_separateur
}
#---------------------------------------------------------------------------------------------------------
boite_separateur()	# si serveur_oscar envoi la premiere fois ou pas salle_separateur
{
if ! ( test -e /tmp/sysprep_installe )
then
	rm -f /tmp/tempfile
	if [ "$separateur" = "aucun" ]	# après un deploiement sysprep un workgroup
	then
		separateur=_P
	fi
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " `cat $chemin_langue/inputbox_9` " \
	--inputbox "\n`cat $chemin_langue/inputbox_10` \Zb\Z4$salle_clients `cat $chemin_langue/inputbox_12`  \n " 12 75 $separateur 2>/tmp/tempfile
	case $? in
	    1)  rm -f /tmp/tempfile
		exit
		;;
	    255) rm -f /tmp/tempfile
		exit
		;;
	esac
	reponse=`cat /tmp/tempfile`
	salle_separateur=`cat /tmp/tempfile`
else	# car sysprep
	salle_separateur=aucun
fi
    echo "$salle_clients;$salle_separateur" > salle_clients
    cp -f salle_clients $image_serveur/oscar/var_poste/
}
#-----------------------------------------------------------------------------------------------------
test_nombre()
{
rm -f /tmp/tempofile
if [ "$fin_test" = "oui" ]
then
    return
else
    nombre=
    if [ "$commande_serveur_oscar_lancee" = "non" ] ## non la commande serveur_oscar
    then	 ## non la commande serveur_oscar
	echo "`cat $chemin_langue/inputbox_15`" > /tmp/temp1
    else
	echo "`cat $chemin_langue/inputbox_16`" > /tmp/temp1
    fi
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " `cat $chemin_langue/inputbox_13` " \
	--inputbox "\n\n`cat $chemin_langue/inputbox_17` `cat /tmp/temp1` :\n " 12 75 2>/tmp/tempfile
        case $? in
	    1)  rm -f /tmp/tempfile
		rm -f /tmp/temp1
		exit
		;;
	    255) rm -f /tmp/tempfile
		rm -f /tmp/temp1
		exit
		;;
	esac
	nombre=`cat /tmp/tempfile`
	cp -f /tmp/tempfile /tmp/tempofile
	rm -f /tmp/tempfile
	rm -f /tmp/temp1

    echo -en "\033[1;31m"
    test_valeur=`expr 255 - $nombre`
    controle=$?
    if [ "$controle" = "0" ]
    then
	    signe_valeur=`expr substr $test_valeur 1 1`
	    if [ "$signe_valeur" = "-" ]
	    then
		echo -e "\033[1;31m `cat $chemin_langue/texte_10` ... \033[1;m"
		sleep 1
	    else
		echo -e "\033[1;m "
		fin_test=oui
	    fi
    fi
    echo -en "\033[1;m"
    test_nombre
fi
}
#----------------------------------------------------------------------------------------------------
supprimer_serveur_du_fichier_serveur_nfs()
{
if ( test -e /mnt/serveur_nfs/serveurs_lances )
then
	# indiquer au serveur nfs que le poste va s'eteindre :
	echo "perl -pi -e 's/$ip_installe,`cat /tmp/mode_transfert`//g;' /mnt/serveur_nfs/serveurs_lances" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
fi

# enleve les doublons du fichier $image_serveur/usr/share/oscar/var_salle/$salle_clients.wol
if ( test -e $image_serveur/usr/share/oscar/var_salle/$salle_clients.wol )
then
	cp -f $image_serveur/usr/share/oscar/var_salle/$salle_clients.wol /tmp/temp_doublons_a_supprimer
	enlever_les_doublons
	if ( test -e /tmp/doublons_supprimes )
	then
		cp -f /tmp/doublons_supprimes $image_serveur/usr/share/oscar/var_salle/$salle_clients.wol
	fi
	rm -f /tmp/doublons_supprimes
fi
rm -f /tmp/nom_salle
}
#-----------------------------------------------------------------------------------------------------
afficher_postes_sous_tension()
{
ls $image_serveur/oscar/var_poste/postes_clients > /tmp/postes_en_reseau
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/Clients` " \
	--infobox "\n\Zb\Z1     --- `cat $chemin_langue/menu_266a` --- \n\n `cat $chemin_langue/infobox_4`\n\n     \Zb\Z1`cat /tmp/postes_en_reseau`\n\n  `cat $chemin_langue/menu_74` " 0 0
test_postes_en_reseau=`cat /tmp/postes_en_reseau`
if [ "$test_postes_en_reseau" !=  "" ]
then
	sleep 5
	afficher_postes_sous_tension
else
	rm -f /tmp/postes_en_reseau
fi
}
#-----------------------------------------------------------------------------------------------------
eteindre_le_poste()
{
if ( test -e $image_serveur/oscar/var_poste/postes_clients )
then
	afficher_postes_sous_tension
	rm -f /tmp/postes_en_reseau
	rm -fr $image_serveur/oscar/var_poste/postes_clients
fi
supprimer_serveur_du_fichier_serveur_nfs
serveur_pxe tester_fin_procedure
rm -f /tmp/ip_mcast_rdv
if ( test -e /tmp/sortir )
then
	rm -f /tmp/sortir
	exit
fi
# un seul serveur : le poste s'eteint a la fin
if [ "$un_seul_serveur_modele" = "un" ]
then
	preparation_serveur_oscar eteindre_un_seul_serveur
else
	preparation_serveur_oscar boite_eteindre_avec_plusieurs_serveurs
fi
exit
}
#-----------------------------------------------------------------------------------------------------
afficher_postes_defectueux()
{
ls $image_serveur/oscar/var_poste/postes_defectueux > /tmp/postes_defectueux
test_postes_defectueux=`cat /tmp/postes_defectueux`
if [ "$test_postes_defectueux" !=  "" ]
then
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/infobox_3` " \
	--infobox "\n\n\n`cat $chemin_langue/infobox_4`\n\n            \Zb\Z1`cat /tmp/postes_defectueux`\n\n" 0 0
	sleep 5
	afficher_postes_defectueux
else
	rm -f /tmp/postes_defectueux
fi
}
#------------------------------------------------------------------------------------------------------
etude_vitesse_bande()
{
	grep -i "right (" /usr/share/oscar/bin/choix_largeur_bande > /tmp/file_version
	perl -pi -e 's/##//g; s/ //g;' /tmp/file_version
	file_version=`cat /tmp/file_version`
	signe_file=$[`expr substr $file_version 18 3`/4-3]
	signe_file1=`cat /tmp/bande_verif`
	rm -f /tmp/bande_verif
	etude_file1=$[$signe_file-$signe_file1]
	etude_file=`expr substr $etude_file1 1 1`
	echo "$resultat_test_version,$etude_file" > /tmp/valeur_vitesse
}
#----------------------------------------------------------------------------------------------------
mesurer_taille_des_fichiers_boot()
{
taille_fichiers_boot=
# trop long
#	ls -sR /mnt/$partition_juste_boot | grep total | awk '{print $2 "+" }' > /tmp/fichiers_boot_sur_linux	# par ligne : total valeur
#	perl -pi -e 's/ //g;' /tmp/fichiers_boot_sur_linux
#	taille_fichiers_boot=`cat /tmp/fichiers_boot_sur_linux`1-1

# possible car serveur :
# taille des fichiers de la partition serveur ET le serveur ne doit pas etre eteint
df -P | grep /mnt/$partition_juste_boot | tail -n 1 | awk '{print $3}' > /tmp/fichiers_boot_sur_linux
taille_fichiers_boot=`cat /tmp/fichiers_boot_sur_linux`

taille_fichiers_boot=$[$taille_fichiers_boot]
rm -f /tmp/fichiers_boot_sur_linux
}
#----------------------------------------------------------------------------------------------------
mesurer_taille_des_fichiers_oscar()
{
taille_fichiers_oscar=
ls -sR $image_serveur/usr/share/oscar | grep total | awk '{print $2 "+" }' > /tmp/fichiers_oscar_sur_linux	# par ligne : total valeur
perl -pi -e 's/ //g;' /tmp/fichiers_oscar_sur_linux
taille_fichiers_oscar=`cat /tmp/fichiers_oscar_sur_linux`1-1
taille_fichiers_oscar=$[$taille_fichiers_oscar]
rm -f /tmp/fichiers_oscar_sur_linux
}
#----------------------------------------------------------------------------------------------------
principal()
{
if ( test -e /etc/demarrage_cdrom )
then
	if [ "$envoyer_oscar" = "oui" ]	# vÃ©rifier la version du poste Ã  envoyer
	then
		# extraire version_oscar_cdrom
		cp -f /usr/share/oscar/usr/version_oscar /tmp/version_temp
		cut -f2 -d"V" /tmp/version_temp > /tmp/tempfile
		perl -pi -e 's/\\Z/!Z/g;' /tmp/tempfile
		cut -f1 -d"\\" /tmp/tempfile > /tmp/version_temp
		perl -pi -e 's/!/\\/g;' /tmp/version_temp
		cut -f2 -d"n" /tmp/version_temp > /tmp/tempfile
		version_oscar_cdrom=`cat /tmp/tempfile`
		# extraire version_oscar_poste
		cp -f $image_serveur/usr/share/oscar/usr/version_oscar /tmp/version_temp
		cut -f2 -d"V" /tmp/version_temp > /tmp/tempfile
		perl -pi -e 's/\\Z/!Z/g;' /tmp/tempfile
		cut -f1 -d"\\" /tmp/tempfile > /tmp/version_temp
		perl -pi -e 's/!/\\/g;' /tmp/version_temp
		cut -f2 -d"n" /tmp/version_temp > /tmp/tempfile
		version_oscar_poste=`cat /tmp/tempfile`
		rm -f /tmp/tempfile
		rm -f /tmp/version_temp

		if ! [ "$version_oscar_cdrom" = "$version_oscar_poste" ]
		then 
		    	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--ok-label "`cat $chemin_langue/Annuler`" --cancel-label "`cat $chemin_langue/Accepter`" \
			--title " `cat $chemin_langue/menu_106` " \
			--menu "\n`cat $chemin_langue/menu_107`\n\n" 10 69 0 \
			"" "" \
			"" "" \
			"" "`cat $chemin_langue/menu_108` :\Zb\Z3$version_oscar_poste\Zn\Z2 " \
			"" "" \
			"" "`cat $chemin_langue/menu_109` :\Zb\Z3$version_oscar_cdrom\Zn " \
			"" "" \
			"" "" \
			"" "`cat $chemin_langue/menu_110` " \
			"" "`cat $chemin_langue/menu_111`" \
			"" ""
			case $? in
			    0)	exit
				;;
			    1)	;;
			    255) exit
			    	;;
			esac
		fi
	fi
fi


if ( test -e /tmp/sortir )
then
        rm -f /tmp/sortir
        exit
fi

vitesse_transmission=`cat vitesse_transmission`
cp -f vitesse_transmission $image_serveur/oscar/var_poste/vitesse_transmission
	fin_test=non
	test_nombre
	
	rm -f salle_clients

if [ "$commande_serveur_oscar_lancee" = "non" ] ## non la commande serveur_oscar
then
	if ! [ "$reponse_nom" = "nonvfat" ]
	then
		if ! ( test -e $image_serveur/oscar/var_poste/salle_clients ) 
		then
			if ! ( test -e $image_serveur/oscar/var_poste ) 
			then
				mkdir $image_serveur/oscar/var_poste
			fi
			separateur=_P
			salle_clients=
		else
			cut -f1 -d";" $image_serveur/oscar/var_poste/salle_clients > /tmp/tempfile
			salle_clients=`cat /tmp/tempfile`
			grep -ci ";" $image_serveur/oscar/var_poste/salle_clients > /tmp/tempfile
			nombre_test=`cat /tmp/tempfile`
			rm -f /tmp/tempfile
			if [ "$nombre_test" = "0" ]
			then
				separateur=_P
			else
				cut -f2 -d";" $image_serveur/oscar/var_poste/salle_clients > /tmp/tempfile
				separateur=`cat /tmp/tempfile`
			fi
		fi
		boite_salle
		rm -f /tmp/tempfile
		echo "$salle_clients;$salle_separateur" > salle_clients
		cp -f salle_clients $image_serveur/oscar/var_poste/
	else
		echo "aucun" > salle_clients
	fi
	cp -f salle_clients $image_serveur/oscar/var_poste/	## pour proposer par dÃ©faut la prochaine fois
	rm -f ctrl_serveur
	if [ "$commande_petite" != oui ]
	then
		echo "serveur_multi" > ctrl_serveur
		commande_client_multi=client_multi
	else
		echo "petite" > ctrl_serveur
		commande_client_multi=petite
	fi
else
	rm -f ctrl_serveur
	commande_client_multi=client_oscar
	echo "serveur_oscar" > ctrl_serveur
	choix_largeur_bande
	vitesse_transmission=`cat vitesse_transmission`
	cp -f vitesse_transmission $image_serveur/oscar/var_poste/vitesse_transmission
fi	## fin non commande serveur_oscar

if ( test -e $image_serveur/oscar/var_poste/salle_clients )
then
	cp -f $image_serveur/oscar/var_poste/salle_clients salle_clients
else
	echo "" > salle_clients
fi
cp -f $image_serveur/oscar/var_poste/domaine domaine
cp -f $image_serveur/oscar/var_poste/ip_format ip_format
cp -f $image_serveur/oscar/var_poste/ip_masque ip_masque
cp -f $image_serveur/oscar/var_poste/ip_passerelle ip_passerelle
cp -f $image_serveur/oscar/var_poste/adresse_synchrone adresse_synchrone
cp -f $image_serveur/oscar/var_poste/ip_colore ip_colore
cp -f $image_serveur/oscar/var_poste/vitesse_transmission vitesse_transmission

if ( test -e $image_serveur/oscar/version_oscar )
then
	version_oscar_sauvegarde=`cat $image_serveur/oscar/version_oscar`
else
	version_oscar_sauvegarde=
fi

cp -f /usr/share/oscar/usr/numero_version_oscar numero_version_oscar
rm -f fichiers_root_envoi

if ( test -e $image_serveur/oscar/commentaire_oscar.txt )	## plusieurs sauvegardes sur ce poste
then
	cp -f $image_serveur/oscar/commentaire_oscar.txt commentaire_oscar.txt
else
	echo "_non_plusieurs_" > commentaire_oscar.txt
fi
		
partition_juste_boot=non
if [ "$envoyer_oscar" = "oui" ]	# envoyer la partion /boot Ã©ventuelle
then
	if [ "$nombre_partition_linux_juste_boot" = "1" ]
	then
		# pour compresser plus loin la partition boot Ã©ventuelle pour son envoi
		if ! ( test -e $image_serveur/oscar/image.partimage.000 )
		then
			grep -i "partition_linux_juste_boot" /tmp/fichier_partitions_boot > /tmp/tempfile
			cut -d"," -f2 /tmp/tempfile > /tmp/tempfile1
			partition_juste_boot=`cat /tmp/tempfile1`
			rm -f /tmp/tempfile
			rm -f /tmp/tempfile1
			if [ "$commande_serveur_oscar_lancee" = "non" ]
			then
				echo "$partition_juste_boot" > /tmp/monter_partition
				runme autoriser_monter_partition_oscar
				rm -f /tmp/monter_partition
				mesurer_taille_des_fichiers_boot
			fi
		fi
	fi
fi

# envoyer la procedure des clients :
mesurer_taille_des_fichiers_sauvegarde_serveur
echo
echo "$ip_installe" > /tmp/ip_transfert
cut -d"." -f1-2 /tmp/ip_transfert > /tmp/temptransfert
debut_ip_transfert=`cat /tmp/temptransfert`
rm -f /tmp/ip_transfert
rm -f /tmp/temptransfert

cd $image_serveur/
	# taille du repertoire oscar:
	echo "`du oscar --max-depth=1 -ma`" > /tmp/valeur2
	perl -pi -e 's/oscar\//__rien_OSCAR__/g;' /tmp/valeur2
	grep -v "__rien_OSCAR__" /tmp/valeur2 > /tmp/valeur1
	# prendre la premiere colonne :
	taille_repertoire_oscar=`awk '{print$1}' /tmp/valeur1`
	rm -f /tmp/valeur1
	rm -f /tmp/valeur2
	cd oscar
		echo "`du image* -ma`" > /tmp/ligne_images_oscar
		perl -pi -e 's/^/  /g; s/image/--> image/g;' /tmp/ligne_images_oscar
cd /root/
envoi_differe
differe=
echo "$nombre" > /tmp/bande_verif
if ( test -e /tmp/demarrage_programme_serveur_pxe )
then
	cut -d "," -f1 /tmp/demarrage_programme_serveur_pxe > /tmp/temp_fichier_wol
	differe=`cat /tmp/temp_fichier_wol`
	rm -f /tmp/temp_fichier_wol
fi

installer_daemon_reseau

sauvegarde_avec_sysprep=non_sysprep
if [ "$commande_serveur_oscar_lancee" = "non" ] ## non la commande serveur_oscar
then
	recuperer_fichier_mac_adresse
	if ( test -e $image_serveur/oscar/liste_postes_sysprep )
	then
		sauvegarde_avec_sysprep=avec_sysprep
	fi
fi

# arreter le demon synchrone
daemon_oscar stop

echo "$commande_client_multi,$ip_installe,$repertoire_partage_nfs_oscar,$differe,$sauvegarde_avec_sysprep" > fichier_commande_envoi
echo
echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4`\033[1;34m."
echo
udp-sender -f fichier_commande_envoi --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
clear
echo
echo -e " ..."
echo
rm -f fichier_commande_envoi

# daemon_nfs stop

if [ "$sauvegarde_avec_sysprep" = "avec_sysprep" ]
then
	echo
	# echo -e "\033[0;34m( `cat $chemin_langue/texte_11` : $debut_ip_transfert.XXX.YYY )"
	echo -e "`cat $chemin_langue/texte_12a`\033[1;m"
	echo
	echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4`\033[1;34m."
	echo
	udp-sender -f $image_serveur/oscar/liste_postes_sysprep --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
fi

if [ "$differe" != "" ]
then
	cp -f $image_serveur/usr/share/oscar/var_salle/$differe fichier_mac_adresse_envoi
	echo
	# echo -e "\033[0;34m( `cat $chemin_langue/texte_11` : $debut_ip_transfert.XXX.YYY )"
	echo -e "`cat $chemin_langue/texte_12a`\033[1;m"
	echo
	echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4`\033[1;34m."
	echo
	udp-sender -f fichier_mac_adresse_envoi --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
	rm -f fichier_mac_adresse_envoi
fi

echo " " > md5sum_oscar
if [ "$envoyer_oscar" = "oui" ]
then
	echo
	echo -e " \033[1;32m`cat $chemin_langue/Patience` ...\033[1;34m"
	echo
	cd $image_serveur/usr/share
	rm -f oscar_seul_envoi.tar.bz2
	mesurer_taille_des_fichiers_oscar
	if ( test -e /root/sysresccd-pkg.txt )	# dÃ©marrage cd sysrcd avec ou sans option cdcache ou dÃ©marrage ou pxe sur le poste si sysrcd
	then 	# menu pour sysrcd:
		tar -cf oscar_seul_envoi.tar.bz2 oscar/	# les fichiers OSCAR envoyÃ©s sont dans le rep oscar/
	else
		tar -cj f=oscar_seul_envoi.tar.bz2 oscar/	# les fichiers OSCAR envoyÃ©s sont dans le rep oscar/
	fi
	cd /root
	
	md5sum $image_serveur/usr/share/oscar_seul_envoi.tar.bz2 > md5sum_oscar
	cut -d" " -f1 md5sum_oscar > /tmp/tempfile_md5
	cp -f /tmp/tempfile_md5 md5sum_oscar
	rm -f /tmp/tempfile_md5
fi

if ! ( test -e /tmp/ligne_images_oscar )
then
	# car deploiement oscar sans sauvegarde
	echo "" > /tmp/ligne_images_oscar
fi
echo
echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4`\033[1;34m."
echo
udp-sender -f /tmp/ligne_images_oscar --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
clear
echo
echo -e " ..."
echo

echo "`cat ctrl_serveur`,`cat salle_clients`,`cat domaine`,`cat ip_format`,`cat ip_masque`,`cat ip_passerelle`,`cat adresse_synchrone`,`cat ip_colore`,`cat vitesse_transmission`,`cat numero_version_oscar`,`cat md5sum_oscar`,`cat commentaire_oscar.txt`,$disque_boot,$partition_juste_boot,$taille_repertoire_oscar,$version_oscar_sauvegarde,$reboot_clients,$taille_fichiers_oscar,$taille_fichiers_boot" > fichiers_root_envoi
echo
echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4`\033[1;34m."
echo
udp-sender -f fichiers_root_envoi --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
clear
echo
echo -e " ..."
echo

rm -f fichiers_root_envoi
rm -f ctrl_serveur
rm -f salle_clients
rm -f domaine
rm -f ip_format
rm -f ip_masque
rm -f ip_passerelle
rm -f adresse_synchrone
rm -f ip_colore
rm -f vitesse_transmission
rm -f numero_version_oscar
rm -f md5sum_oscar
rm -f commentaire_oscar.txt
rm -f /tmp/sysprep_installe
rm -f /tmp/newsid_installe

echo "`cat $image_serveur/oscar/partition_sauvegardee`" > /tmp/partition_type_scsi_ide
donner_scsi_ide	# le type est dans /tmp/partition_type_scsi_ide

# debut du test de version
	# pour attendre tous les postes ce fichier /tmp/test_version ne sert a rien
	
	echo "" > /tmp/test_version
	udp-sender -f /tmp/test_version --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
	rm -f /tmp/test_version
	cp -f $tftpboot_partage/erreur_numero_version /tmp/temp_test_version
	daemon_nfs stop
	
	grep -ci "bon_" /tmp/temp_test_version > /tmp/nb_bonnes_versions
	valeur_bonnes_versions=`cat /tmp/nb_bonnes_versions`
	grep -ci "mauvais_" /tmp/temp_test_version > /tmp/nb_mauvaises_versions
	valeur_mauvaises_versions=`cat /tmp/nb_mauvaises_versions`
	rm -f /tmp/nb_mauvaises_versions
	rm -f /tmp/nb_bonnes_versions
	
	temp_test_version=`cat /tmp/temp_test_version`
	resultat_test_version=continuer
	if [ "$valeur_mauvaises_versions" = "0" ]
	then
		rm -f /tmp/temp_test_version
	else	# proposer : continuer avec seulement les bons clients ou eteindre (seulement les clients)
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--ok-label "`cat $chemin_langue/Continuer`" --cancel-label "`cat $chemin_langue/Eteindre`" \
		--title " `cat $chemin_langue/menu_704a` " \
		--menu "\n\Zb\Z3$valeur_mauvaises_versions `cat $chemin_langue/menu_705a`\n\n" 10 80 0 \
		"" "" \
		"" "\Zb\Z4`cat $chemin_langue/Continuer` : \Z2`cat $chemin_langue/menu_706a` " \
		"" "" \
		"" "\Zb\Z4`cat $chemin_langue/Eteindre` : \Z2`cat $chemin_langue/menu_707` " \
		"" "" \
		"" "" \
		"" "\Z2`cat $chemin_langue/menu_708` : "
		case $? in
			0) resultat_test_version=continuer
				;;
			1) resultat_test_version=eteindre
				;;
			255) resultat_test_version=eteindre
				;;
		esac
	fi
	
	etude_vitesse_bande
	rm -f /tmp/temp_test_version
	rm -f $tftpboot_partage/erreur_numero_version
	
	nombre=$valeur_bonnes_versions
	if [ "$nombre" = "0" ]
	then
		rm -f /tmp/valeur_vitesse
		rm -f /tmp/ip_mcast_rdv
		menu_reseau
		exit
	fi
	
	udp-sender -f /tmp/valeur_vitesse --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
	rm -f /tmp/valeur_vitesse
	if [ "$resultat_test_version" = "eteindre" ]
	then
		rm -f /tmp/ip_mcast_rdv
		menu_reseau
		exit
	fi
# fin du test de version


rm -f fichiers_linux_envoi
if [ "$commande_serveur_oscar_lancee" = "non" ]
then
	# mettre a jour ancienne version avant deploiement
		cp -f $image_serveur/oscar/taille_partition_$base /tmp/test_nouvelle_version
		perl -pi -e 's/,/,
		/g;' /tmp/test_nouvelle_version
		grep -ci "," /tmp/test_nouvelle_version > /tmp/test_nouvelle_version1
		test_nouvelle_version=`cat /tmp/test_nouvelle_version1`
		rm -f /tmp/test_nouvelle_version
		rm -f /tmp/test_nouvelle_version1
		
		if [ "$test_nouvelle_version" != 2 ]
		then
			echo "`cat $image_serveur/oscar/taille_partition_$base`,ancien," > $image_serveur/oscar/taille_partition_$base
		fi
	# fin mise a jour

	echo "`cat $image_serveur/oscar/partition_sauvegardee`,`cat $image_serveur/oscar/date_de_sauvegarde`,`cat $image_serveur/oscar/taille_partition_$base`,`cat $image_serveur/oscar/date_oscar`,`cat /tmp/partition_type_scsi_ide`" > fichiers_linux_envoi
else
	echo "commande_serveur_oscar_lancee" > fichiers_linux_envoi
fi
echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4` `cat $chemin_langue/suivant`\033[1;34m."
echo
rm -f /tmp/partition_type_scsi_ide
udp-sender -f fichiers_linux_envoi --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
clear
echo
echo -e " ..."
echo
rm -f fichiers_linux_envoi

if [ "$envoyer_oscar" = "oui" ]
then
	rm -f $tftpboot_partage/erreur_vitesse_transmission
	echo "" > /tmp/test_vitesse
	
	echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4` `cat $chemin_langue/suivant`\033[1;34m."
	echo
	udp-sender -f $image_serveur/usr/share/oscar_seul_envoi.tar.bz2 --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
	rm -f $image_serveur/usr/share/oscar_seul_envoi.tar.bz2
	
	# pour attendre tous les postes ce fichier /tmp/test_vitesse ne sert a rien
	udp-sender -f /tmp/test_vitesse --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
	rm -f /tmp/test_vitesse
	temp_test_vitesse=
	if ( test -e $tftpboot_partage/erreur_vitesse_transmission )
	then
		cp -f $tftpboot_partage/erreur_vitesse_transmission /tmp/temp_test_vitesse
		temp_test_vitesse=`cat /tmp/temp_test_vitesse`
	fi
	resultat_test=continuer
	if [ "$temp_test_vitesse" = "" ] || [ "$temp_test_vitesse" = " " ]
	then
		rm -f /tmp/temp_test_vitesse
	else	# proposer : vitesse eteindre (seulement les clients)
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--ok-label "`cat $chemin_langue/Vitesse`" --cancel-label "`cat $chemin_langue/Eteindre`" \
		--title " `cat $chemin_langue/menu_704` " \
		--menu "\n\Zb\Z3`cat $chemin_langue/menu_705`\n\n" 10 69 0 \
		"" "" \
		"" "\Zb\Z4`cat $chemin_langue/Vitesse` : \Z2`cat $chemin_langue/menu_706` " \
		"" "" \
		"" "\Zb\Z4`cat $chemin_langue/Eteindre` : \Z2`cat $chemin_langue/menu_707` " \
		"" "" \
		"" "" \
		"" "\Z2`cat $chemin_langue/menu_708` : "
		case $? in
			0) resultat_test=vitesse
				;;
			1) resultat_test=eteindre
				;;
			255) resultat_test=eteindre
				;;
		esac
	fi
	echo "$resultat_test" > /tmp/resultat_test
	rm -f /tmp/temp_test_vitesse
	rm -f $tftpboot_partage/erreur_vitesse_transmission

	udp-sender -f /tmp/resultat_test --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
	echo -e " \033[1;32m`cat $chemin_langue/Patience` ...\033[1;34m"
	echo
	rm -f /tmp/resultat_test
	if [ "$resultat_test" = "vitesse" ]
	then
		if [ "$commande_petite" != oui ]
		then
			echo "simple" > /tmp/procedure_serveur
		else
			echo "petite" > /tmp/procedure_serveur
		fi
		serveur_multi
		exit
	elif [ "$resultat_test" = "eteindre" ]
	then
		rm -f /tmp/ip_mcast_rdv
		menu_reseau
		exit
	fi	
	

	if ! [ "$partition_juste_boot" = "non" ]
	then	# envoyer la partition /boot Ã©ventuelle
		if [ "$commande_serveur_oscar_lancee" = "non" ]
		then
			#	echo "$partition_juste_boot" > /tmp/monter_partition
			#	runme autoriser_monter_partition_oscar
			#	# partition_montee_boot=`cat /tmp/monter_partition`
			#	rm -f /tmp/monter_partition
			cd /mnt
			rm -f juste_boot_envoi.tar.bz2
			if ( test -e /root/sysresccd-pkg.txt )	# dÃ©marrage cd sysrcd avec ou sans option cdcache ou dÃ©marrage ou pxe sur le poste si sysrcd
			then	# menu pour sysrcd:
				tar -cf juste_boot_envoi.tar.bz2 $partition_juste_boot/	# les fichiers boot envoyÃ©s sont dans le rep /
			else
				tar -cj f=juste_boot_envoi.tar.bz2 $partition_juste_boot/	# les fichiers boot envoyÃ©s sont dans le rep /
			fi
			cd /root
			echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_14` \033[1;34m/boot\033[1;34m."
			echo
			udp-sender -f /mnt/juste_boot_envoi.tar.bz2 --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			echo
			rm -f /mnt/juste_boot_envoi.tar.bz2
		fi
	fi
fi

if [ "$commande_serveur_oscar_lancee" = "non" ] ## non la commande serveur_oscar
then
	rm -f /tmp/postes_en_reseau
	rm -fr $image_serveur/oscar/var_poste/postes_clients
	mkdir $image_serveur/oscar/var_poste/postes_clients
	rm -f /tmp/postes_defectueux
	rm -fr $image_serveur/oscar/var_poste/postes_defectueux
	mkdir $image_serveur/oscar/var_poste/postes_defectueux
	if ( test -e $image_serveur/oscar/image.partimage.000 )
	then
		envoyer_image_partimage_000
	elif ( test -e $image_serveur/oscar/image.ntfs.00 )
	then
		envoyer_image_ntfs_00
	elif ( test -e $image_serveur/oscar/image_dar.1.dar )
	then
		envoyer_image_dar
	elif ( test -e $image_serveur/oscar/image_fsa.fsa )
	then
		envoyer_image_fsa
	fi
	if ( test -e $image_serveur/oscar/var_poste/postes_defectueux )
	then
		afficher_postes_defectueux
		rm -fr $image_serveur/oscar/var_poste/postes_defectueux
	fi
	ajouter_fichier_mac_adresse_poste
	eteindre_le_poste
fi	## fin non commande serveur_oscar
}
#---------------------------------------------------------------------------------------------------
afficher_ligne_images_oscar()
{
echo -e "`cat $chemin_langue/texte_6`"
echo
echo -e "\033[1;m ( `cat $chemin_langue/Taille` = $taille_repertoire_oscar Mo )\033[1;m"
echo "perl -pi -e 's/en cours \033\[1;32m`cat $image_serveur/oscar/commentaire_oscar.txt`\033\[1;31m .../envoyÃ©/g;' /tmp/ligne_images_oscar 
perl -pi -e 's/$image_ligne/$image_ligne \033[1;31men cours \033\[1;32m`cat $image_serveur/oscar/commentaire_oscar.txt`\033\[1;31m ...\033[1;m/g;' /tmp/ligne_images_oscar" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom
cat /tmp/ligne_images_oscar
}
#---------------------------------------------------------------------------------------------------
envoyer_image_fsa()
{
echo "image_fsa.fsa" > fichier_image
udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
clear
echo
echo -e " ..."
echo
image_ligne=image_fsa.fsa
afficher_ligne_images_oscar
echo
echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_7`\033[1;34m."
echo
udp-sender -f $image_serveur/oscar/image_fsa.fsa --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
clear
echo
echo -e " ..."
cp -f fichier_image /tmp/fichier_image_controle
controle_fichier_image

if ( test -e $image_serveur/oscar/image_fsa.f01 )
then
	fichier_existe=oui
	valeur=1
	rm -f fichier_image
	echo "image_fsa.f01" > fichier_image
	while [ "$fichier_existe" = "oui" ]
	do
	        cp -f fichier_image /tmp/fichier_image_controle
		if (( "$valeur" > "99" ))
		then
			boite_limite_logiciel
		elif (( "$valeur" > "9" ))
		then 
			if ( test -e $image_serveur/oscar/image_fsa.f$valeur )
			then
				udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
				clear
				echo
				echo -e " ..."
				echo
				image_ligne=image_fsa.f$valeur
				afficher_ligne_images_oscar
				echo
				echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_7`\033[1;34m."
				echo
				udp-sender -f $image_serveur/oscar/image_fsa.f$valeur --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
				clear
				echo
				echo -e " ..."
				echo
				echo -e " ..."
				valeur=$[$valeur+1]
				rm -f fichier_image
				if [ "$valeur" = "100" ]
				then
					boite_limite_logiciel
				else
					echo "image_fsa.f$valeur" > fichier_image
				fi
			else
				rm -f fichier_image
				echo "fin" > fichier_image
				udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
				clear
				echo
				echo -e " ..."
				fichier_existe=non
			fi
		else
			if ( test -e $image_serveur/oscar/image_fsa.f0$valeur )
			then
				udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
				clear
				echo
				echo -e " ..."
				echo
				image_ligne=image_fsa.f0$valeur
				afficher_ligne_images_oscar
				echo
				echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_7`\033[1;34m."
				echo
				udp-sender -f $image_serveur/oscar/image_fsa.f0$valeur --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
				clear
				echo
				echo -e " ..."
				valeur=$[$valeur+1]
				rm -f fichier_image
				if [ "$valeur" = "10" ]
				then
					echo "image_fsa.f$valeur" > fichier_image
				else
					echo "image_fsa.f0$valeur" > fichier_image
				fi
			else
				rm -f fichier_image
				echo "fin" > fichier_image
				udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
				clear
				echo
				echo -e " ..."
				fichier_existe=non
			fi
		fi
		controle_fichier_image
	done
else
	rm -f fichier_image
	echo "fin" > fichier_image
	udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	fichier_existe=non
fi
rm -f /tmp/ligne_images_oscar
rm -f fichier_image
echo -e "\033[1;m"
}
#---------------------------------------------------------------------------------------------------
envoyer_image_dar()
{
fichier_existe=oui
valeur=1
rm -f fichier_image
echo "image_dar.1.dar" > fichier_image
while [ "$fichier_existe" = "oui" ]
do
	cp -f fichier_image /tmp/fichier_image_controle
	if ( test -e $image_serveur/oscar/image_dar.$valeur.dar )
	then
		udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
		clear
		echo
		echo -e " ..."
		echo
		image_ligne=image_dar.$valeur.dar
		afficher_ligne_images_oscar
		echo
		echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_7`\033[1;34m."
		echo
		udp-sender -f $image_serveur/oscar/image_dar.$valeur.dar --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
		clear
		echo
		echo -e " ..."
		valeur=$[$valeur+1]
		rm -f fichier_image
		echo "image_dar.$valeur.dar" > fichier_image
	else
		rm -f fichier_image
		echo "fin" > fichier_image
		udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
		clear
		echo
		echo -e " ..."
		fichier_existe=non	
	fi
	controle_fichier_image
done
rm -f /tmp/ligne_images_oscar
rm -f fichier_image
rm -f /tmp/recu_fichier_mac
echo -e "\033[1;m"
}
#---------------------------------------------------------------------------------------------------
envoyer_image_ntfs_00()
{
fichier_existe=oui
valeur=0
rm -f fichier_image
echo "image.ntfs.00" > fichier_image
while [ "$fichier_existe" = "oui" ]
do
	cp -f fichier_image /tmp/fichier_image_controle
	if (( "$valeur" > "99" ))
	then
		boite_limite_logiciel
	elif (( "$valeur" > "9" ))
	then 
		if ( test -e $image_serveur/oscar/image.ntfs.$valeur )
		then
			udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			echo
			image_ligne=image.ntfs.$valeur
			afficher_ligne_images_oscar
			echo
			echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_7`\033[1;34m."
			echo
		
			udp-sender -f $image_serveur/oscar/image.ntfs.$valeur --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			valeur=$[$valeur+1]
			rm -f fichier_image
			if [ "$valeur" = "100" ]
			then
				boite_limite_logiciel
			else
				echo "image.partimage.$valeur" > fichier_image
			fi
		else
			rm -f fichier_image
			echo "fin" > fichier_image
			udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			fichier_existe=non	
		fi
	else
		if ( test -e $image_serveur/oscar/image.ntfs.0$valeur )
		then
			udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			echo
			image_ligne=image.ntfs.0$valeur
			afficher_ligne_images_oscar
			echo
			echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_7`\033[1;34m."
			echo
			udp-sender -f $image_serveur/oscar/image.ntfs.0$valeur --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			valeur=$[$valeur+1]
			rm -f fichier_image
			if [ "$valeur" = "10" ]
			then
				echo "image.ntfs.$valeur" > fichier_image
			else
				echo "image.ntfs.0$valeur" > fichier_image
			fi
		else
			rm -f fichier_image
			echo "fin" > fichier_image
			udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			fichier_existe=non
		fi
	fi
	controle_fichier_image
done
rm -f /tmp/ligne_images_oscar
rm -f fichier_image
echo -e "\033[1;m"
}
#---------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------
envoyer_image_partimage_000()
{
		fichier_existe=oui
		valeur=0
		rm -f fichier_image
		echo "image.partimage.000" > fichier_image
		while [ "$fichier_existe" = "oui" ]
		do
		cp -f fichier_image /tmp/fichier_image_controle
		if (( "$valeur" > "999" ))
		then
			boite_limite_logiciel
		elif (( "$valeur" > "99" ))
		then
			if ( test -e $image_serveur/oscar/image.partimage.$valeur )
			then
			udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			echo
			image_ligne=image.partimage.$valeur
			afficher_ligne_images_oscar
			echo
			echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_7`\033[1;34m."
			echo
			udp-sender -f $image_serveur/oscar/image.partimage.$valeur --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			valeur=$[$valeur+1]
			rm -f fichier_image
			    if [ "$valeur" = "1000" ]
			    then
			    boite_limite_logiciel
			    else
			    echo "image.partimage.$valeur" > fichier_image
			    fi
			else
			rm -f fichier_image
			echo "fin" > fichier_image
			udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			fichier_existe=non	
			fi
		elif (( "$valeur" > "9" ))
		then 
			if ( test -e $image_serveur/oscar/image.partimage.0$valeur )
			then
			udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			echo
			image_ligne=image.partimage.0$valeur
			afficher_ligne_images_oscar
			echo
			echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_7`\033[1;34m."
			echo
			udp-sender -f $image_serveur/oscar/image.partimage.0$valeur --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			valeur=$[$valeur+1]
			rm -f fichier_image
			    if [ "$valeur" = "100" ]
			    then
			    echo "image.partimage.$valeur" > fichier_image
			    else
			    echo "image.partimage.0$valeur" > fichier_image
			    fi
			else
			rm -f fichier_image
			echo "fin" > fichier_image
			udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			fichier_existe=non	
			fi
		else
			if ( test -e $image_serveur/oscar/image.partimage.00$valeur )
			then
			udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			echo
			image_ligne=image.partimage.00$valeur
			afficher_ligne_images_oscar
			echo
			echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_7`\033[1;34m."
			echo
			udp-sender -f $image_serveur/oscar/image.partimage.00$valeur --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			valeur=$[$valeur+1]
			rm -f fichier_image
			    if [ "$valeur" = "10" ]
			    then
			    echo "image.partimage.0$valeur" > fichier_image
			    else
			    echo "image.partimage.00$valeur" > fichier_image
			    fi
			else
			rm -f fichier_image
			echo "fin" > fichier_image
			udp-sender -f fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
			clear
			echo
			echo -e " ..."
			fichier_existe=non
			fi
		fi
		controle_fichier_image
		done
		rm -f /tmp/ligne_images_oscar
		rm -f fichier_image
		echo -e "\033[1;m"
}
#---------------------------------------------------------------------------------------------------
boite_partition_sauvegardee() # selectionner seulement les partitions linux non swap sauf la sauvegarde
{
        runme prepare_fichier_temptaille
        rm -f /tmp/bozo
        egrep -e "^/dev" /tmp/fichier_disque_dur | grep -v "$reponse" | grep -i linux |  grep -v "extended" | grep -v "Extended" | grep -v "swap" | \
	perl -pi -e 's/\*//g;  s/\+/ /g; s/\-/ /g; s/  /:/g; s/:+/:/g;' | \
        awk 'BEGIN { FS=" " } { printf ("%0s %15s %25s\n","\""$1"\" \"",$2,$3"\" \\")}' >> /tmp/bozo
        runme boite_selection_bozo
}
#---------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
demander_partition_a_sauvegarder()	#si pas de fichier $image_serveur/oscar/partition_sauvegardee
{
	rm -f /tmp/menu_titre
	rm -f /tmp/menu_texte
	rm -f /tmp/fichierquestion

	echo " `cat $chemin_langue/selection_7` " > /tmp/menu_titre
	echo "" > /tmp/menu_texte
	echo "`cat $chemin_langue/selection_8` \Zb\Z2$reponse\Zn:\n\n " > /tmp/fichierquestion
	echo "`cat $chemin_langue/selection_10`" >> /tmp/fichierquestion
	boite_partition_sauvegardee
	if ( test -e /tmp/sortir )
	        then
	        rm -f /tmp/sortir
	        exit
	fi
	
	rm -f /tmp/menu_titre
	rm -f /tmp/menu_texte
	rm -f /tmp/fichierquestion

	perl -pi -e 's/\/dev\///g;' /tmp/tempfile
	base=`cat /tmp/tempfile`	# hdaiii
	rm -f /tmp/tempfile
}
#---------------------------------------------------------------------------------------------------
mise_en_reseau_asynchrone()
{
# mise en rÃ©seau nfs :
echo "$repertoire_partage_nfs_oscar *(rw,sync,no_root_squash)" >> /etc/exports

rm -f $tftpboot_partage/client_pxe
/etc/init.d/nfs restart 1>/dev/null 2>/dev/null

rm -f $tftpboot_partage/erreur_numero_version
}
#---------------------------------------------------------------------------------------------------
recuperer_fichier_mac_adresse()
{
cut -f1 -d";" $image_serveur/oscar/var_poste/salle_clients > /tmp/nom_salle
if ! ( test -e $image_serveur/usr/share/oscar/var_salle )
then
	mkdir $image_serveur/usr/share/oscar/var_salle
fi
if ( test -e $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol )
then
	cp -f $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol $image_serveur/oscar/var_poste/
fi
if ( test -e $image_serveur/oscar/var_poste/`cat /tmp/nom_salle`.wol )
then	# supprimer la mac adresse si existe
	grep -v "`cat /tmp/mac_adresse`" $image_serveur/oscar/var_poste/`cat /tmp/nom_salle`.wol > /tmp/temp_nom_salle
	cp -f /tmp/temp_nom_salle $image_serveur/oscar/var_poste/`cat /tmp/nom_salle`.wol
	rm -f /tmp/temp_nom_salle
fi

if ( test -e $image_serveur/oscar/var_poste/numero_poste_client )
then
	numero_poste_serveur=`cat $image_serveur/oscar/var_poste/numero_poste_client`
else
	numero_poste_serveur=serveur
fi
echo "`cat /tmp/mac_adresse`,poste=$numero_poste_serveur" >> $image_serveur/oscar/var_poste/`cat /tmp/nom_salle`.wol
}
#---------------------------------------------------------------------------------------------------
ajouter_fichier_mac_adresse_poste()
{
if ( test -e $image_serveur/usr/share/oscar/var_salle )
then
	# ne pas supprimer si oscar non installe
	cp -f $image_serveur/oscar/var_poste/`cat /tmp/nom_salle`.wol $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol
	rm -f $image_serveur/oscar/var_poste/`cat /tmp/nom_salle`.wol
fi
}
#---------------------------------------------------------------------------------------------------
controle_fichier_image()
{
fichier_image_controle=`cat /tmp/fichier_image_controle`
fin_fichier_image=`cat fichier_image`
if ! [ "$fin_fichier_image" = "fin" ]
then
    echo
    echo -e " `cat $chemin_langue/texte_13` ..."
    echo
    md5sum $image_serveur/oscar/$fichier_image_controle > /tmp/md5sum_fichier_image
    udp-sender -f /tmp/md5sum_fichier_image --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
    clear
    echo
    echo -e " ..."
fi
rm -f /tmp/fichier_image_controle
rm -f /tmp/md5sum_fichier_image
}
#-----------------------------------------------------------------------------------------------------
installer_daemon_reseau()
{
mise_en_reseau_asynchrone

echo "synchrone," > /tmp/mode_transfert
lancer_avahi serveur
if ( test -e /tmp/sortir )
then
    rm -f /tmp/sortir
    rm -f /tmp/ip_mcast_rdv
    exit
fi
}
#----------------------------------------------------------------------------------------------------
mesurer_taille_des_fichiers_sauvegarde_serveur()
{
if ( test -e $image_serveur/oscar/image.partimage.000 )
then
	image_transferee=image.partimage
elif ( test -e $image_serveur/oscar/image.ntfs.00 )
then
	image_transferee=image.ntfs
elif ( test -e $image_serveur/oscar/image_dar.1.dar )
then
	image_transferee=image_dar
elif ( test -e $image_serveur/oscar/image_fsa.fsa )
then
	image_transferee=image_fsa
fi
ls -s $image_serveur/oscar/$image_transferee.* | awk '{print $1 "+" }' > /tmp/liste_copies_fichiers	# par ligne : valeur
perl -pi -e 's/ //g;' /tmp/liste_copies_fichiers
taille_fichiers_sauvegarde_serveur=`cat /tmp/liste_copies_fichiers`1-1
rm -f /tmp/liste_copies_fichiers
taille_fichiers_sauvegarde_serveur=$[$taille_fichiers_sauvegarde_serveur]
echo "$taille_fichiers_sauvegarde_serveur,$image_transferee" > $image_serveur/oscar/var_poste/taille_fichiers_sauvegarde_serveur
}
#-----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
#		SERVEUR  IMAGE synchrone
#-----------------------------------------------------------------------------------------------------
#   permet l'installation d'un SERVEUR en rÃ©seau qui partage sa partition image
un_seul_serveur_modele=un
commande_serveur_oscar_lancee=non
if ( test -e /tmp/serveur_oscar_lance )
then
	commande_serveur_oscar_lancee=oui
	rm -f /tmp/serveur_oscar_lance
fi
commande_petite=non
if ( test -e /tmp/serveur_multi_petite )
then
	commande_petite=oui
	rm -f /tmp/serveur_multi_petite
fi

daemon_oscar stop

if ! ( test -e /etc/cdrom_ejecte )
then
	if ( test -e /etc/demarrage_cdcache )
	then
		echo "" > /etc/cdrom_ejecte	# cd ejecte
		# umount /mnt/cdrom 2>/dev/null  ; sync
		eject
	fi
fi

cherche_image

if [ "$commande_serveur_oscar_lancee" = "non" ]
then
	if ! [ "$image_trouvee" = "oui" ]	# pas d'image existe
	then
		rm -f /tmp/fichiertmp
		dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
		--ok-label "`cat $chemin_langue/Continuer`" \
		--title " `cat $chemin_langue/DESOLE` " \
		--msgbox "\n\n`cat $chemin_langue/msgbox_2`\n\n " 10 62
		rm -f /tmp/fichiertmp
		exit
	fi
else
	if ! [ "$image_trouvee" = "oui" ]	# pas d'image existe
	then    
		if [ "$partition_oscar_sans_sauvegarde" = "non" ] # oscar non installe sur le poste
		then
			rm -f /tmp/fichiertmp
			dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
			--ok-label "`cat $chemin_langue/Continuer`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--msgbox "\n\n`cat $chemin_langue/msgbox_9`\n\n " 10 68
			rm -f /tmp/fichiertmp
			exit
		fi
	fi
fi

# test demarrage poste
echo "$image_serveur" > /tmp/repertoire_partage_nfs_oscar
etude_montage test_demarage_serveur_poste
repertoire_partage_nfs_oscar=`cat /tmp/repertoire_partage_nfs_oscar`
rm -f /tmp/repertoire_partage_nfs_oscar
if ( test -e /etc/demarrage_cdrom ) || ( test -e /etc/demarrage_usb )
then
	echo "/tftpboot *(fsid=0,rw,no_subtree_check,all_squash,insecure)" >> /etc/exports
	tftpboot_partage=/tftpboot
else	# demarrage poste
	tftpboot_partage=$repertoire_partage_nfs_oscar/var_poste
fi
echo "$tftpboot_partage" > /tmp/tftpboot_partage

### ici mise en reseau toujours partage_nfs
# installer_daemon_reseau

##### l'ip est dans le fichier ip_installe_poste
lancer_avahi recherche_installe_IP
if ( test -e /tmp/sortir )
then
	rm -f /tmp/sortir
	exit 0
fi
ip_installe=`cat ip_installe_poste`

if [ "$commande_serveur_oscar_lancee" = "non" ]
then
	echo "$image_serveur" > /tmp/linux_sauvegarde_serveur
	info_image gerer_sauvegardes_serveur
	if ( test -e /tmp/sortir )
	then
	    rm -f /tmp/ip_mcast_rdv
	    rm -f /tmp/sortir
	    exit
	fi
fi

if [ "$commande_serveur_oscar_lancee" = "non" ]	# commande serveur_multi
then
	if ! ( test -e $image_serveur/oscar/partition_sauvegardee ) # lire le nom de la partition sauvegardÃ©e
	then
		demander_partition_a_sauvegarder
		echo "$base" > $image_serveur/oscar/partition_sauvegardee
	fi
	base=`cat $image_serveur/oscar/partition_sauvegardee`		
	
	rm -f /tmp/tempfile
	if ! ( test -e $image_serveur/oscar/taille_partition_$base )
	then	# installe le fichier de la taille de la partition restaurÃ©e
		# echo "`fdisk -s /dev/$base`,ancien," > $image_serveur/oscar/taille_partition_$base
		echo "$base" > /tmp/calcul_taille_partition_disque
		runme calcul_taille_partition_MB
		echo "`cat /tmp/calcul_taille_partition_disque`,ancien," > $image_serveur/oscar/taille_partition_$base
		rm -f /tmp/calcul_taille_partition_disque
	fi
fi

if ( test -e $image_serveur/oscar/partition_sauvegardee )
then
	base=`cat $image_serveur/oscar/partition_sauvegardee`
else	# cas seulement pour envoyer les fichiers oscar
	base=$partition_oscar_sans_sauvegarde	# celle d'oscar car pas de sauvegarde
	echo "linux" > partition_oscar_reponse
fi

if ( test -e $image_serveur/oscar/taille_partition_$base )
then
	grep -ci "," $image_serveur/oscar/taille_partition_$base > /tmp/nbr_valeurs_tailles
	nbr_valeurs_tailles=`cat /tmp/nbr_valeurs_tailles`
	rm -f /tmp/nbr_valeurs_tailles
	if [ "$nbr_valeurs_tailles" = "0" ]
	then
		taille_image=`cat $image_serveur/oscar/taille_partition_$base`
	else
		cut -d"," -f1 $image_serveur/oscar/taille_partition_$base > /tmp/valeur_taille_image
		taille_image=`cat /tmp/valeur_taille_image`
		rm -f /tmp/valeur_taille_image
	fi
fi


if ! ( test -e $image_serveur/oscar/date_de_sauvegarde )
then
	date=$(date +%d-%m-%y)
	echo "`cat $chemin_langue/texte_1` $date" > $image_serveur/oscar/date_de_sauvegarde
	cp -f $image_serveur/oscar/taille_partition_$base $image_serveur/oscar/sauvegarde_$base:$[$taille_image/1024].Mo_avant_$date
fi


rm -f /tmp/fichiertxt
echo " " >> /tmp/fichiertxt
if [ "$image_serveur" = "" ]
then
	repertoire=/
else
	repertoire=$image_serveur
fi

	echo "`df $repertoire | grep "$reponse"`" > /tmp/toutes_les_valeurs
	grep -i "dev" /tmp/toutes_les_valeurs > /tmp/toutes_les_valeurs1
	
	valeur1=`awk '{print$2}' /tmp/toutes_les_valeurs1`
	valeur2=`awk '{print$3}' /tmp/toutes_les_valeurs1`
	valeur3=`awk '{print$5}' /tmp/toutes_les_valeurs1`
		
	rm -f /tmp/toutes_les_valeurs
	rm -f /tmp/toutes_les_valeurs1

	#	valeur1=`df $repertoire | grep "$reponse" | awk '{print$2}'`
	#	valeur2=`df $repertoire | grep "$reponse" | awk '{print$3}'`
	#	valeur3=`df $repertoire | grep "$reponse" | awk '{print$5}'`

valeur1=$[valeur1/1024]
valeur2=$[valeur2/1024]
valeur2=$[valeur1-valeur2]
echo " " >> /tmp/fichiertxt
echo "`cat $chemin_langue/repertoire_1` $image_serveur/oscar, `cat $chemin_langue/repertoire_2` $valeur3 : " >> /tmp/fichiertxt
echo " " >> /tmp/fichiertxt
echo "$valeur2 Mo `cat $chemin_langue/repertoire_3` $valeur1 Mo " >> /tmp/fichiertxt
echo " " >> /tmp/fichiertxt
ls $image_serveur/oscar >> /tmp/fichiertxt
echo " " >> /tmp/fichiertxt

rm -f /tmp/fichiertmp2
echo  "`cat $chemin_langue/menu_72`\Z2 $ip_installe \Zn\n " >> /tmp/fichiertmp2
echo " " >> /tmp/fichiertmp2

echo "$image_serveur : partagÃ© linux " >> /tmp/historique

echo "serveur_clone" > /tmp/texte_mbr
echo "$base" > /tmp/base_sauvegarde

installe_oscar_dd cherche_partition_et_variables_boot_pour_serveur
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/ip_mcast_rdv
		rm -f /tmp/sortir
		exit
	fi
disque_boot=`cat /tmp/disque_boot`	# sda
grep -ci "partition_linux_juste_boot" /tmp/fichier_partitions_boot > /tmp/tempfile
nombre_partition_linux_juste_boot=`cat /tmp/tempfile`

if [ "$partition_oscar_sans_sauvegarde" != "non" ] # oscar sans sauvegarde
then
	echo "linux" > partition_oscar_reponse
fi
if ( test -e partition_oscar_reponse )
then
	cp -f partition_oscar_reponse partition_oscar
else
	echo "" > partition_oscar
fi

rm -f partition_oscar_reponse
reponse_nom=`cat partition_oscar`

if ! ( test -e $image_serveur/oscar/var_poste )
then
	mkdir $image_serveur/oscar/var_poste
fi	

if ! ( test -e $image_serveur/oscar/var_poste/vitesse_transmission ) # lire la vitesse de transmission
then
	echo "75m" > $image_serveur/oscar/var_poste/vitesse_transmission
fi
cp -f $image_serveur/oscar/var_poste/vitesse_transmission vitesse_transmission
vitesse_transmission=`cat $image_serveur/oscar/var_poste/vitesse_transmission`

if ! ( test -e $image_serveur/oscar/var_poste/adresse_synchrone )
then
	rm -f adresse_synchrone
	echo "232" > adresse_synchrone
else
rm -f /tmp/tempfile
echo `cut -d"." -f1 $image_serveur/oscar/var_poste/adresse_synchrone` > /tmp/tempfile
cp -f /tmp/tempfile adresse_synchrone
rm -f /tmp/tempfile
fi
cp -f adresse_synchrone $image_serveur/oscar/var_poste/adresse_synchrone

if ( test -e /tmp/newsid_installe )
then
	echo "newsid" > domaine
else
	echo "non" > domaine
fi
cp -f domaine $image_serveur/oscar/var_poste/domaine

if ! ( test -e $image_serveur/oscar/var_poste/ip_format )
then
	rm -f ip_format
	rm -f ip_masque
	rm -f ip_passerelle
	rm -f ip_colore
	rm -f vitesse_transmission

	echo "non_ip" > ip_format
	echo " " > ip_masque
	echo " " > ip_passerelle
	echo " " > ip_colore
	echo "75m" > vitesse_transmission
	
	cp -f ip_format $image_serveur/oscar/var_poste/ip_format
	cp -f ip_masque $image_serveur/oscar/var_poste/ip_masque
	cp -f ip_passerelle $image_serveur/oscar/var_poste/ip_passerelle
	cp -f ip_colore $image_serveur/oscar/var_poste/ip_colore
	cp -f vitesse_transmission $image_serveur/oscar/var_poste/vitesse_transmission
else
	cp -f $image_serveur/oscar/var_poste/ip_format ip_format
	cp -f $image_serveur/oscar/var_poste/ip_masque ip_masque
	cp -f $image_serveur/oscar/var_poste/ip_passerelle ip_passerelle
	if ! ( test -e $image_serveur/oscar/var_poste/ip_colore )
	then
		echo " " > ip_colore
		cp -f ip_colore $image_serveur/oscar/var_poste/ip_colore
	else
		cp -f $image_serveur/oscar/var_poste/ip_colore ip_colore
	fi
	cp -f $image_serveur/oscar/var_poste/vitesse_transmission vitesse_transmission
fi

rm -f /tmp/fichiertmp5
if ( test -e $image_serveur/usr/share/oscar )	## Oscar est bien installÃ© sur ce poste
then
	rm -f /tmp/fichiertmp
	cut -f2 -d"," $image_serveur/oscar/date_oscar > /tmp/fichiertmp
	date=`cat /tmp/fichiertmp`
	rm -f /tmp/fichiertmp
	rm -f $image_serveur/oscar/date_oscar
	echo "oui,$date" > $image_serveur/oscar/date_oscar
	envoyer_oscar=oui
	envoyer_oscar_seul=oui
	rm -f /tmp/fichiertmp5
	echo "Installation d'\Z1OSCAR\Z4 aux clients    : \Z3$envoyer_oscar " > /tmp/fichiertmp5
else
	demande_installe_oscar_sur_serveur
	if ( test -e /tmp/sortir )
        then
        	rm -f /tmp/sortir
        	rm -f /tmp/ip_mcast_rdv
        	exit
	fi

        rm -f $image_serveur/oscar/date_oscar
        echo "non,$date" > $image_serveur/oscar/date_oscar
        envoyer_oscar=non
        echo " " > /tmp/fichiertmp5
	if ! [ "$commande_serveur_oscar_lancee" = "non" ] ## non la de serveur_oscar
	then
		exit
	fi
fi

if [ "$commande_serveur_oscar_lancee" = "non" ] ## non la commande serveur_oscar
then
	rm -f /tmp/textetmp3
	echo "" > /tmp/textetmp3
	
	# apres deploiememt nfs installer les fichiers.wol :
	if ( test -e $image_serveur/oscar/var_poste )
	then
		if ! ( test -e $image_serveur/usr/share/oscar/var_salle )
		then
			mkdir $image_serveur/usr/share/oscar/var_salle 2>/dev/null
		fi
		if ( test -e $image_serveur/usr/share/oscar/var_salle )
		then
			cp -f $image_serveur/oscar/var_poste/*.wol $image_serveur/usr/share/oscar/var_salle/ 2>/dev/null
		fi
	fi
	echo "`cat $chemin_langue/recapitule_18` \Z3`cat $chemin_langue/non` " > /tmp/fichiertmp7
	preparation_serveur_oscar
	rm -f /tmp/fichiertmp1
	rm -f /tmp/fichiertmp2
	rm -f /tmp/fichiertmp3
	rm -f /tmp/fichiertmp4
	rm -f /tmp/fichiertmp41
	rm -f /tmp/fichiertmp42
	rm -f /tmp/fichiertmp5
	rm -f /tmp/fichiertmp6
	if ( test -e /tmp/sortir )
  		then
  			rm -f /tmp/ip_mcast_rdv
			rm -f /tmp/tempfile
	  		rm -f /tmp/sortir
        	exit
	fi
	rm -f adresse_synchrone
	echo "232" > adresse_synchrone	## on ne peut changer cette valeur
	valeurs_par_defaut=`cat /tmp/tempfile`
	rm -f /tmp/tempfile
else
	echo "" > /tmp/fichiertmp7
	reboot_clients=non_reboot
	valeurs_par_defaut=accepter
fi

if [ "$valeurs_par_defaut" = "accepter" ]
then
	adresse_synchrone_un=`cat adresse_synchrone`
	rm -f /tmp/tempfile
	echo `cut -d"." -f2-4 ip_installe_poste` > /tmp/tempfile
	adresse_synchrone_ctrl=$adresse_synchrone_un.`cat /tmp/tempfile`
	rm -f /tmp/tempfile

	if ( test -e $image_serveur/usr/share/oscar )	## Oscar est pas installÃ© sur le poste
	then
		rm -f /tmp/fichiertmp
		cut -f2 -d"," $image_serveur/oscar/date_oscar > /tmp/fichiertmp
		date=`cat /tmp/fichiertmp`
 		rm -f $image_serveur/oscar/date_oscar
		echo "oui,$date" > $image_serveur/oscar/date_oscar
		envoyer_oscar=oui
	else
		rm -f $image_serveur/oscar/date_oscar
		echo "non,$date" > $image_serveur/oscar/date_oscar
 		envoyer_oscar=non
	fi

	if [ "$commande_serveur_oscar_lancee" = "non" ] ## la commande serveur_oscar
	then
		echo "\n`cat $chemin_langue/menu_135`\n\n" > /tmp/fichiertmp2
		boites_serveur_multi
	else
		##demande_adresse_synchrone
		cp -f adresse_synchrone $image_serveur/oscar/var_poste/adresse_synchrone

		rm -f /tmp/tempfile
		echo `cut -d"." -f2-4 ip_installe_poste` > /tmp/tempfile
		adresse_synchrone_ctrl=$adresse_synchrone_un.`cat /tmp/tempfile`
		rm -f /tmp/tempfile
		envoyer_oscar_seul=non
		#	if ! ( test -e $image_serveur/oscar/var_poste/salle_clients ) 
		#	then
		#		if ! ( test -e	/tmp/sysprep_installe )
		#		then
		#			separateur=_P
		#			boite_salle
		#		fi
		#		boites_serveur_oscar
		#		if ( test -e /tmp/sortir )
		#		then
	 	#	  		rm -f /tmp/sortir
		#			rm -f $image_serveur/oscar/var_poste/salle_clients
		#   			exit
		#		fi
		#	else
		#		if ! ( test -e 	/tmp/sysprep_installe )
		#		then
		#			grep -ci ";" $image_serveur/oscar/var_poste/salle_clients > /tmp/tempfile
		#			nombre_test=`cat /tmp/tempfile`
		#			rm -f /tmp/tempfile
		#			if [ "$nombre_test" = "0" ]
		#			then
		#			    separateur=_P
		#			    salle_clients=`cat $image_serveur/oscar/var_poste/salle_clients`
		#			else
		#			    cut -f2 -d";" $image_serveur/oscar/var_poste/salle_clients > /tmp/tempfile
		#			    separateur=`cat /tmp/tempfile`
		#			    cut -f1 -d";" $image_serveur/oscar/var_poste/salle_clients > /tmp/tempfile
		#			    salle_clients=`cat /tmp/tempfile`
		#			fi
		#		
		#			if [ "$separateur" = "" ]
		#			then
		#				separateur=_P
		#				boite_salle
		#			else
		#				separateur=$separateur
		#				boite_salle
		#			fi
		#		fi
		#		boites_serveur_oscar
		#		if ( test -e /tmp/sortir )
		#		then
	 	#	  		rm -f /tmp/sortir
		#   			exit
		#		fi
		#	fi
		#	rm -f /tmp/tempfile
		### fin pour serveur_oscar

	fi
	principal
	rm -f /tmp/ip_mcast_rdv
	exit
fi
	
## fin non commande serveur_oscar
choix_largeur_bande

##demande_adresse_synchrone
cp -f adresse_synchrone $image_serveur/oscar/var_poste/adresse_synchrone
adresse_synchrone_un=`cat adresse_synchrone`

if ! [ "$reponse_nom" = "nonvfat" ]
then
	if ! ( test -e /tmp/sysprep_installe )
	then
		if ! ( test -e /tmp/newsid_installe )
		then
			echo "non" > domaine
		else
			echo "newsid" > domaine
		fi
	else
		rm -f domaine
		echo "non" > domaine
	fi
else
	echo "non" > domaine
fi
cp -f domaine $image_serveur/oscar/var_poste/domaine
		
rm -f ip_format
echo "non_ip" > ip_format
rm -f ip_masque
echo " " > ip_masque
rm -f ip_passerelle
echo " " > ip_passerelle
rm -f ip_colore
echo " " > ip_colore

if ! [ "$reponse_nom" = "nonvfat" ]
then
	if ! ( test -e 	/tmp/sysprep_installe )
	then
		boite_ip
		if ( test -e /tmp/sortir )
 	  		then
 	  		rm -f /tmp/sortir
	        	exit
		fi
	fi
	cp -f ip_format $image_serveur/oscar/var_poste/ip_format
	cp -f ip_colore $image_serveur/oscar/var_poste/ip_colore
	cp -f ip_masque $image_serveur/oscar/var_poste/ip_masque
	cp -f ip_passerelle $image_serveur/oscar/var_poste/ip_passerelle
fi

### envoi Ã©ventuel du cd OSCAR

###### demande d'envoi d'Oscar
if ( test -e $image_serveur/usr/share/oscar )	## Oscar est installÃ© sur le poste
then
	boite_envoi_oscar_dd	# demander l'autorisation d'envoi
else
	rm -f $image_serveur/oscar/date_oscar
	echo "non,$date" > $image_serveur/oscar/date_oscar
	envoyer_oscar=non	
fi

# preparation_serveur_oscar demande_un_ou_plusieurs_serveurs
#	if ( test -e /tmp/le_poste_s_eteint )
#	then
#		un_seul_serveur_modele=un
#		rm -f /tmp/le_poste_s_eteint
#	else
#		un_seul_serveur_modele=plusieurs
#	fi
un_seul_serveur_modele=un	# le poste s eteint

if [ "$commande_serveur_oscar_lancee" = "non" ] ## la commande serveur_oscar
then
	demande_reboot_clients
else
	reboot_clients=non_reboot
	echo "" > /tmp/fichiertmp7
fi

#### RÃ©capitulatif des sÃ©lections:
rm -f /tmp/tempfile
rm -f /tmp/fichiertmp1
rm -f /tmp/fichiertmp2
rm -f /tmp/fichiertmp3
rm -f /tmp/fichiertmp4
rm -f /tmp/fichiertmp41
rm -f /tmp/fichiertmp42
rm -f /tmp/fichiertmp5
rm -f /tmp/fichiertmp6

echo " `cat $chemin_langue/recapitule_15` " > /tmp/tempfile
echo "   `cat $chemin_langue/recapitule_3` " > /tmp/fichiertmp1
echo " " > /tmp/fichiertmp2
valeur=`cat partition_oscar`

if ! ( test -e /tmp/sysprep_installe )
then
	echo "`cat $chemin_langue/recapitule_4` \Z3`cat domaine` " >/tmp/tempaff1
	echo "`cat $chemin_langue/recapitule_5` \Z3`cat $chemin_langue/recapitule_8` DHCP " > /tmp/tempaff2
	echo "`cat $chemin_langue/recapitule_5` \Z3`cat $chemin_langue/recapitule_9` \Zn`cat ip_colore` " > /tmp/tempaff3
	echo "`cat $chemin_langue/recapitule_6` \Z3`cat ip_masque` " > /tmp/tempaff4
	echo "`cat $chemin_langue/recapitule_7` \Z3`cat ip_passerelle` " > /tmp/tempaff5
else
	affichage_sysprep_ou_deploie=`cat /tmp/sysprep_installe`
	if [ "$affichage_sysprep_ou_deploie" = oscar_deploie ]
	then
		methode_deploie="OSCAR deploie et renomme"
	else
		methode_deploie=sysprep
	fi
	echo "`cat $chemin_langue/recapitule_4` \Z3$methode_deploie " >/tmp/tempaff1
	echo " " > /tmp/tempaff2
	echo " " > /tmp/tempaff3
	echo " " > /tmp/tempaff4
	echo " " > /tmp/tempaff5
fi



if ! [ "$valeur" = "nonvfat" ]	## il y a une partition vfat toujours vrai maintenant
then
	echo "`cat /tmp/tempaff1`" > /tmp/fichiertmp3	
	valeur=`cat ip_format`
	if [ "$valeur" = "non_ip" ]	## affectation automatique
	then
		echo "`cat /tmp/tempaff2`" > /tmp/fichiertmp4
		echo " " > /tmp/fichiertmp41
		echo " " > /tmp/fichiertmp42
	else
		echo "`cat /tmp/tempaff3`" > /tmp/fichiertmp4
		echo "`cat /tmp/tempaff4`" > /tmp/fichiertmp41
		echo "`cat /tmp/tempaff5`" > /tmp/fichiertmp42
	fi
else
		echo " " > /tmp/fichiertmp4
		echo "  `cat $chemin_langue/recapitule_10` " > /tmp/fichiertmp41
		echo " " > /tmp/fichiertmp42
fi
rm -f /tmp/tempaff1
rm -f /tmp/tempaff2
rm -f /tmp/tempaff3
rm -f /tmp/tempaff4
rm -f /tmp/tempaff5

if ( test -e $image_serveur/usr/share/oscar )	## Oscar est sur ce poste
then
	if [ "$envoyer_oscar_seul" = "non" ]
	then
		echo "`cat $chemin_langue/recapitule_16` \Z3$envoyer_oscar " > /tmp/fichiertmp5
	else
		echo "`cat $chemin_langue/recapitule_17` \Z3$envoyer_oscar " > /tmp/fichiertmp5
	fi
else
	echo " " > /tmp/fichiertmp5
fi
echo "`cat $chemin_langue/recapitule_18` \Z3$afficher_reboot_clients " > /tmp/fichiertmp7
#	# un seul serveur : le poste s'eteint a la fin
#	if [ "$un_seul_serveur_modele" = "un" ]
#	then
#		echo "`cat $chemin_langue/menu_266b` \Z3`cat $chemin_langue/menu_266c` " > /tmp/fichiertmp7
#	else
#		echo "`cat $chemin_langue/menu_267b` \Z3`cat $chemin_langue/menu_267c` " > /tmp/fichiertmp7
#	fi

ip_installe=`cat ip_installe_poste` # ip du poste
rm -f /tmp/tempfile1
echo `cut -d"." -f1-3 ip_installe_poste` > /tmp/tempfile1
adresse_synchrone_deux=`cat /tmp/tempfile1`.255

rm -f /tmp/tempfile
echo `cut -d"." -f2-4 ip_installe_poste` > /tmp/tempfile
adresse_synchrone_ctrl=$adresse_synchrone_un.`cat /tmp/tempfile`
rm -f /tmp/tempfile

echo "`cat $chemin_langue/recapitule_14` \Z3$adresse_synchrone_ctrl\Z4 ; \Z3$adresse_synchrone_deux " > /tmp/fichiertmp6
echo " `cat $chemin_langue/recapitule_2a` " > /tmp/tempfile_titre

texte_recapitule

reponse=`cat /tmp/recapitule`
rm -f /tmp/recapitule
rm -f /tmp/tempfile
rm -f /tmp/fichiertmp1
rm -f /tmp/fichiertmp2
rm -f /tmp/fichiertmp3
rm -f /tmp/fichiertmp4
rm -f /tmp/fichiertmp41
rm -f /tmp/fichiertmp42
rm -f /tmp/fichiertmp5
rm -f /tmp/fichiertmp6
rm -f /tmp/fichiertmp7
if [ "$reponse" = "sortir" ]
then
	exit
fi
#### fin RÃ©capitulatif des sÃ©lections
echo "\n`cat $chemin_langue/menu_135`\n\n" > /tmp/fichiertmp2
boites_serveur_multi

principal
rm -f /tmp/ip_mcast_rdv

