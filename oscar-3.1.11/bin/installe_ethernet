#!/bin/sh



## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin,  jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.



PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

 
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
cherche_carte()     # besoin du fichier /tmp/fichiertemp1
{
	echo -en "."
        #lire la premiere valeur
        cut -d";" -f1 /tmp/fichiertemp1 > /tmp/fichiertemp2
	# si repertoire renommer /
	perl -pi -e 's/\//OSCAR_/g;' /tmp/fichiertemp1
	perl -pi -e 's/\//OSCAR_/g;' /tmp/fichiertemp2

        # remplacer cette valeur par rien dans /tmp/fichiertemp1
        echo "perl -pi -e 's/`cat /tmp/fichiertemp2`;//g;' /tmp/fichiertemp1" > /tmp/exec_nom
        chmod +x /tmp/exec_nom
        /tmp/exec_nom # remplace par rien
	rm -f /tmp/exec_nom
	
	perl -pi -e 's/OSCAR_/\//g;' /tmp/fichiertemp1
	perl -pi -e 's/OSCAR_/\//g;' /tmp/fichiertemp2

        test_fin=`cat /tmp/fichiertemp2`
        if [ "$test_fin" = "oscar_fin.ko" ]
        then
	    echo
	    echo
	    echo -e "\033[1;31m `cat $chemin_langue/texte_89` \033[1;33mOSCAR\033[1;m ... "
	    echo
	    rm -f /tmp/fichiertemp1
	    rm -f /tmp/fichiertemp2
	    rm -f /tmp/fichiertemp3
	    rm -f /tmp/fichiertemp4
	    rm -f /tmp/tempfile
	    rm -f /tmp/nombre
	    sleep 3
	    exit	
	fi
        #lire la deuxieme partie
        cut -d"." -f2 /tmp/fichiertemp2 > /tmp/fichiertemp3
	test_carte=`cat /tmp/fichiertemp3`

        if ! [ "$test_carte" = "ko" ]	#  car repertoire
        then # ajouter les fichiers du repertoire
	    # supprimer oscar_fin.ko
	    perl -pi -e 's/oscar_fin.ko//g;' /tmp/fichiertemp1
	    # ajouter le contenu du repertoire  nom_carte dans /tmp/fichiertemp1:
	    nom_repertoire=`cat /tmp/fichiertemp2`

	    cd /lib/modules/$noyau/kernel/drivers/net/$nom_repertoire
	    echo -n "$nom_repertoire/" > /tmp/fichiertemp4	# pour le premier
	    echo -n `ls` >> /tmp/fichiertemp4

	    echo "$nom_repertoire" > /tmp/fichiertemp5
	    perl -pi -e 's/\//OSCAR_/g;' /tmp/fichiertemp5 # pour les sous repertoire remplacer les /

	    echo "perl -pi -e 's/ /;`cat /tmp/fichiertemp5`\//g; ' /tmp/fichiertemp4" > /tmp/exec_nom
            chmod +x /tmp/exec_nom
	    /tmp/exec_nom  # 2>/dev/null # donne le chemin complet
	    rm -f /tmp/exec_nom
	    rm -f /tmp/fichiertemp5

	    perl -pi -e 's/OSCAR_/\//g;' /tmp/fichiertemp4	# remettre les /

	    echo -n `cat /tmp/fichiertemp4` >> /tmp/fichiertemp1
	
	    echo -n " oscar_fin.ko" >> /tmp/fichiertemp1
	    cd /root
	    perl -pi -e 's/ /;/g; ' /tmp/fichiertemp1
	    # echo
	else # c'est une carte
	    cut -d"." -f1 /tmp/fichiertemp2 > /tmp/fichiertemp3
	    nom_carte=`cat /tmp/fichiertemp3`
	    modprobe $nom_carte 2>/dev/null 1>/dev/null
	    sortie=$?

	    if [ "$sortie" = "0" ]
    	    then	# carte detectee
	        ifconfig -a eth0 > /tmp/tempfile 2>/dev/null
		grep -ci "^eth0" /tmp/tempfile > /tmp/nombre
		nombre=`cat /tmp/nombre`
		if ! [ "$nombre" = "0" ]
    		then	# carte detectee
		    echo "$nom_carte" >> /etc/modules.autoload.d/kernel-2.6
		    echo
		    echo -e " \033[1;33mOSCAR\033[1;34m `cat $chemin_langue/texte_90` :\033[1;32m $nom_carte \033[1;m "
		    echo
		    sleep 2
		    cp -f /tmp/fichiertemp2 /etc/drivers_ethernet/drivers_ethernet # possible pour Oscar sur le poste et envoyer
 
		    rm -f /tmp/fichiertemp1
		    rm -f /tmp/fichiertemp2
		    rm -f /tmp/fichiertemp3
		    rm -f /tmp/fichiertemp4
		    rm -f /tmp/tempfile
		    rm -f /tmp/nombre
		    exit
		fi
	    fi
	    rmmod $nom_carte -s	# enlever le module qui ne convient pas
	fi
    cherche_carte
}
#----------------------------------------------------------------------------------------------------
prepare_chercher_carte_ethernet() # boucle principale
{
noyau=`uname -r`
if ! ( test -e /etc/drivers_ethernet )
then
    mkdir /etc/drivers_ethernet/
fi
cd /lib/modules/$noyau/kernel/drivers/net/
echo -n `ls` > /etc/drivers_ethernet/drivers_ethernet

echo -n " oscar_fin.ko" >> /etc/drivers_ethernet/drivers_ethernet
cd /root

    # Recupere toutes les cartes + oscar_fin separees par ;
#    perl -pi -e 's/.ko /;/g; s/ //g;' /etc/drivers_ethernet/drivers_ethernet
    perl -pi -e 's/ /;/g; ' /etc/drivers_ethernet/drivers_ethernet
    cp -f /etc/drivers_ethernet/drivers_ethernet /tmp/fichiertemp1
    
    cherche_carte
}
#----------------------------------------------------------------------------------------------------
carte_ethernet()
{
echo
echo -en "\033[1;33m OSCAR\033[1;m `cat $chemin_langue/texte_91` `cat $chemin_langue/texte_92` ..."
    #    runme lancer_dhcp
    prepare_chercher_carte_ethernet
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
#  commandes externes de procédures

case "$1" in
    carte_ethernet)
	carte_ethernet
	exit 0
	;;
esac
#-----------------------------------------------------------------------------------------------------
demande_recherche_driver_ethernet()
{
	# Installation du driver de carte ethernet
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Accepter`" --cancel-label "`cat $chemin_langue/Annuler`"  \
	--title " `cat $chemin_langue/menu_551` " \
	--menu "\n\Zb\Z3   `cat $chemin_langue/menu_552` \n\n" 10 70 0 \
	"" "" \
	"" "\Zb\Z4`cat $chemin_langue/menu_553` ? " \
	"" " "
	case $? in
	    0)	;;
	    1)  exit ;;
	    255) exit;;
	esac
}
#---------------------------------------------------------------------------------------------------

    ifconfig -a eth0 > /tmp/tempfile 2>/dev/null
    grep -ci "^eth0" /tmp/tempfile > /tmp/nombre
    nombre=`cat /tmp/nombre`
    rm -f /tmp/tempfile
    rm -f /tmp/nombre
    if ! [ "$nombre" = "0" ]
    then	# carte detectee	
	exit
    fi
demande_recherche_driver_ethernet
echo 
echo -en "\033[1;33m OSCAR\033[1;m `cat $chemin_langue/texte_92` ..."
    #    runme lancer_dhcp
    prepare_chercher_carte_ethernet

