#!/bin/sh

## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.


#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
recevoir_table_partitions() # recevoir en synchrone la table des partitions du disques hd et sd à cloner du serveur 
{
echo -e "`cat $chemin_langue/texte_35` :\033[1;m"

if ( test -e /dev/evms/$base )
then
    evms_oscar="evms/"
else
    evms_oscar=
fi

if ! ( test -e /dev/$evms_oscar$hd_boot )
then
	# texte_mauvais_cablage_disque
	serveur_disque choisir_disque_maitre
	hd_boot=`cat /tmp/disque`	# sda
	rm -f /tmp/disque
	if ( test -e /tmp/sortir )
	then
	    rm -f /tmp/sortir
	    exit
	fi
fi
if ! ( test -e /etc/demarrage_cdrom ) ## le poste est démarré avec client_multi ou USB voir depart
then
	test_demarrage_table_partition
	if [ "$quitter_la_procedure" = "oui" ]
	then
		exit
	fi
fi

rm -f table_partitions.mbr
echo
udp-receiver -f table_partitions.mbr --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
clear
echo
echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
echo
echo -e " ..."
rm -f table_partitions.sf
echo
udp-receiver -f table_partitions.sf --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
clear
echo
echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
echo
echo -e " ..."
rm -f /tmp/fichier_disque_dur_serveur
echo
udp-receiver -f /tmp/fichier_disque_dur_serveur --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
clear
echo
echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
echo
echo -e " ..."
rm -f /tmp/formatage_linux
echo
udp-receiver -f /tmp/formatage_linux --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
clear
echo
echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
echo
echo -e " ..."
	
#  danger!!! ici tue le poste:
echo
echo -e " `cat $chemin_langue/texte_33` ..."
echo
# sfdisk -f /dev/$evms_oscar$hd_boot < table_partitions.sf 2>/dev/null	# il est oblogatoire après d'attendre 5 secondes pour continuer
echo "$evms_oscar$hd_boot" > /tmp/disque_installer_table_sf
cp -f table_partitions.sf /tmp/fichier_installer_table_sf
runme installer_table_partition_sf
sleep 2 # obligatoire après l'installation de la table des partitions
dd if=table_partitions.mbr of=/dev/$evms_oscar$hd_boot 2>/dev/null
sleep 2 # obligatoire après le mbr
}
#----------------------------------------------------------------------------------------------------
test_demarrage_table_partition() ## ne pas utiliser cette commande si demarrage sur $hd_boot
{
grep -ci "root=UUID=" /proc/cmdline > /tmp/tempfile
demarrage_poste=`cat /tmp/tempfile`
if [ "$demarrage_poste" = "1" ]
then
	echo "`cat /proc/cmdline`" > /tmp/tempfile
	perl -pi -e 's/root=UUID=/{/g;' /tmp/tempfile
	cut -d"{" -f2 /tmp/tempfile > /tmp/temp1
	cut -d" " -f1 /tmp/temp1 > /tmp/temp_sdai	# valeur de UUID partition OSCAR
	installe_oscar_dd remplacer_uuid_par_sdai
    	partition_oscar_poste=`cat /tmp/temp_sdai`
    	rm -f /tmp/temp_sdai
    	rm -f /tmp/temp1
    	rm -f /tmp/tempfile
    	test_partition_oscar=`expr substr $partition_oscar_poste 1 3`
	if [ "$test_partition_oscar" = "$hd_boot" ]
	then	# démarrage du poste sur $hd_boot
		rm -f fichiers_depart_recept
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/DESOLE` " \
		--ok-label "`cat $chemin_langue/Continuer`"  \
		--msgbox "`cat $chemin_langue/msgbox_26` $hd_boot\n \
		\n `cat $chemin_langue/msgbox_27`.\n\n\n" 15 60
		case $? in
		    0) 	quitter_la_procedure=oui
			;;
		    255) quitter_la_procedure=oui
			;;
		esac
	fi
fi
}
#----------------------------------------------------------------------------------------------------
eteindre_ordinateur() 
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/infobox_1` " \
	--infobox "\n\n\n`cat $chemin_langue/infobox_2`" 9 58
	
rm -f /tmp/fichiertemp
for passe in 8 7 6 5 4 3 2 1 STOP
do
	sleep 1
	echo -en "\033[1;31m  > $passe\033[1;m"
done
if ( test -e /etc/cdrom_ejecte )
then
	eject -t
fi
halt
sleep 10
exit
}
#-----------------------------------------------------------------------------------------------------
#		CLIENT reçois la table des partitions d'un disque_maitre
#-----------------------------------------------------------------------------------------------------
PATH="/usr/share/oscar/bin:$PATH"

/usr/share/oscar/usr/version_theme_oscar

if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

case "$1" in
    test_demarrage_table_partition)
	hd_boot=`cat /tmp/disque_maitre_image`
	rm -f /tmp/disque_maitre_image
        test_demarrage_table_partition
	if [ "$quitter_la_procedure" = "oui" ]
	then
		echo "" > /tmp/sortir
	fi
        exit 0
        ;;
    eteindre_ordinateur)
	eteindre_ordinateur
	exit 0
	;;
esac

poste=`cat /tmp/numero_poste`
client=$poste
ip_transfert=`cat /tmp/ip_poste_client`
ip_serveur=`cat /tmp/ip_serveur`
rm -f /tmp/ip_poste_client
rm -f /tmp/ip_serveur
chemin_oscar=`cat /tmp/chemin_oscar_serveur`

echo
echo -e "`cat $chemin_langue/texte_37` :\033[1;m"
echo

rm -f fichiers_depart_recept
echo -en "\033[1;31m"
udp-receiver -f fichiers_depart_recept --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
clear
echo
echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
echo
echo -e " ..."
echo

rm -f ctrl_serveur
cut -f1 -d"," fichiers_depart_recept > ctrl_serveur
commande_serveur=`cat ctrl_serveur`

rm -f disque_maitre
cut -f2 -d"," fichiers_depart_recept > disque_maitre
hd_boot=`cat disque_maitre`
cp -f disque_maitre /tmp/disque_client

rm -f formatage_disques
cut -f3 -d"," fichiers_depart_recept > formatage_disques
cut -f4 -d"," fichiers_depart_recept > /tmp/taille_disque_envoye
rm -f fichiers_depart_recept

client_clone controler_taille_disque_client
if ( test -e /tmp/sortir )
then
	rm -f /tmp/sortir
	exit
fi

recevoir_table_partitions
client_clone formater_disque
rm -f table_partitions.mbr
rm -f table_partitions.sf
rm -f disque_maitre
eteindre_ordinateur


