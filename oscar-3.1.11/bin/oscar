#!/bin/bash

## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin,  jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.

#   programme de menu administrateur réseau pour l'autorun


#----------------------------------------------------------------------------------------------------
eteindre_le_poste()
{
runme boite_eteindre_le_poste
if ( test -e /tmp/annuler_eteindre )
then
	rm -f /tmp/annuler_eteindre
	main
	return
fi
runme boite_eteindre_ordinateur
}
#----------------------------------------------------------------------------------------------------
output_passage()
{
if ( test -e /etc/passage_oscar )
then
	nb_passage=`cat /etc/passage_oscar`
	nb_passage=$[$nb_passage+1]
	controle_passage=$[2-$nb_passage]
	echo "$nb_passage" > /etc/passage_oscar
	signe_negatif=`expr substr $controle_passage 1 1`
	if [ "$signe_negatif" = "-" ]
	then
		touch /etc/controle_passage
		echo "1" > /etc/passage_oscar
	fi
else
	echo "1" > /etc/passage_oscar
fi
}
#----------------------------------------------------------------------------------------------------
boucle()  # retour au programme principal
{
echo
echo -e "`cat $chemin_langue/boucle_1`"
echo -ne "`cat $chemin_langue/boucle_2`"
read reponse
    main
}
#----------------------------------------------------------------------------------------------------
main()
{
rm -f /tmp/sortir
rm -f /tmp/tempfile # des menus precedents sauf celui-ci 2>/tmp/tempfile__

rm -f /tmp/tempfile___
rm -f /tmp/tempfile____
rm -f /tmp/tempfile_____
rm -f /tmp/tempfile______
rm -f /tmp/tempfile_______

if ( test -e /usr/share/oscar/usr/initialise )
then
	if ( test -e /etc/menuoscar_client )
	then
		dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
		--ok-label "`cat $chemin_langue/Continuer`" \
		--title " `cat $chemin_langue/Information` " \
		--msgbox "\n\Z1\Zb`cat $chemin_langue/msgbox_78a` ...\Zn " 14 55
	else
		if ( test -e /etc/controle_passage )
		then
			DIALOGRC="/etc/dialogrc" dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
			--ok-label "`cat $chemin_langue/Sabonner`" \
			--cancel-label "`cat $chemin_langue/Continuer`" \
			--title " `cat $chemin_langue/Information` " \
			--menu "\n\Zb\Z3 Service d'accompagnement OSCAR \n\Zn " 9 55 0 \
			"" "" \
			"" "\Zb\Z1 --> `cat $chemin_langue/msgbox_78b1`" \
			"" "\Zb\Z1 --> `cat $chemin_langue/msgbox_78b2`" \
			"" "" \
			"" "" \
			"" "\Zb\Z1 `cat $chemin_langue/msgbox_78b3`" \
			"" "" \
			"" "\Zb\Z3 `cat $chemin_langue/msgbox_78b4`" \
			"" ""
			case $? in
				0)	/usr/bin/midori http://oscar.crdp-lyon.fr/wiki/pub/accompagnement 2>/dev/null &
					;;
				1)	;;
				255)	;;
			esac
		fi
	fi
fi

calendrier=$(date +%d/%m/%y)
heure=$(date +%kh%Mmin)
echo "  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  " > /tmp/rien
output=exit
#dialog --begin 2 0 --no-cancel --colors --no-shadow
dialog  --no-cancel --colors --no-shadow \
	--backtitle "`cat /etc/banniere_oscar`" --title " `cat $chemin_langue/menu_10` " \
	--menu "\n  `cat $chemin_langue/menu_1` `cat /tmp/rien`  le $calendrier à $heure \n " 9 80 0 \
	" " "" \
	"sauvegarde" "`cat $chemin_langue/menu_2`" \
	"réseau" "`cat $chemin_langue/menu_4`" \
	"disques" "`cat $chemin_langue/menu_3`" \
	"menu_oscar" "`cat $chemin_langue/menu_26`" \
	" " "" \
	"menu_avancé" "`cat $chemin_langue/menu_6`" \
	"menu_scribe" "`cat $chemin_langue/menu_230a`" \
	"version" "`cat $chemin_langue/menu_7`" \
	"halt" "`cat $chemin_langue/menu_8`" \
	"quitter" "`cat $chemin_langue/menu_9` \Zb\Z3oscar\Zn)." \
	" " "" 2>/tmp/tempfile__

if [ $? = "255" ]
then
    rm -f /tmp/tempfile__
    rm -f /tmp/rien
    exit
fi
output=`cat /tmp/tempfile__`
rm -f /tmp/rien
rm -f /etc/controle_passage
output_passage
if [ "$output" = " " ]
then
	main
elif [ "$output" = "" ]
then
	main
elif [ "$output" = "menu_scribe" ]
then
	menu_scribe
	main
elif [ "$output" = "sauvegarde" ]
then
	menu_sauvegarde
	main
elif [ "$output" = "réseau" ]
then
	menu_reseau
	main
elif [ "$output" = "disques" ]
then
	menu_disques
	if ( test -e /tmp/augmenter )	# pour quitter et redimensionner ntfs
	then
		exit
	fi
	main
elif [ "$output" = "menu_oscar" ]
then
	maj_boot_oscar
	main
elif [ "$output" = "gespere" ]
then
	menu_gespere
	main
elif [ $output = "menu_avancé" ]
then
		runme
		if ( test -e /tmp/augmenter )	# pour quitter et redimensionner ntfs
		then
		    exit
		fi
		if ( test -e /tmp/quitter_ssh )
		then
		    rm -f /tmp/quitter_ssh
		    echo -e "`cat $chemin_langue/ssh_1`"
		    exit
	        fi
		main
elif [ "$output" = "version" ]
then        
	version_oscar
	main
elif [ "$output" = "halt" ]
then
	rm -f /tmp/tempfile__
	eteindre_le_poste
elif [ "$output" = "quitter" ]
then
	echo
	rm -f /tmp/tempfile__
	exit
else
$output
fi
rm -f /tmp/tempfile__
boucle
}
#----------------------------------------------------------------------------------------------------
PATH="/usr/share/oscar/bin:$PATH"

/usr/share/oscar/usr/version_theme_oscar

grep -ci "docache" /proc/cmdline > /tmp/nombre_docache
if ( test -e /tmp/nombre_docache )
then
	nombre_docache=`cat /tmp/nombre_docache`
	rm -f /tmp/nombre_docache
	if [ "$nombre_docache" = "1" ]	# demarrage docache
	then
      		echo "" > /etc/demarrage_cdcache
      	fi
fi

if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue
main
