#!/bin/sh


## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
## Cdrom Outil Système Complet d'Assistance Réseau: OSCAR
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.


		
#-----------------------------------------------------------------------------------------------------
#			Vérifie que le poste client est bien en réseau avec le serveur image
#			avec le protocole linux
#-----------------------------------------------------------------------------------------------------


PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue


#-----------------------------------------------------------------------------------------------------
boites_client_verif()
{
	cp -f /etc/dialogrc /tmp/dialogrc
	perl -pi -e 's/item_selected_color = /item_selected_color = (WHITE,BLACK,OFF)\n#/g;' /tmp/dialogrc
	
	# Vérification de la connexion au serveur en NFS
	DIALOGRC="/tmp/dialogrc" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Continuer`" --ok-label "`cat $chemin_langue/menu_175`" --title " `cat $chemin_langue/menu_174` " \
	--menu "`cat /tmp/fichiertmp2`" 0 0 0  \
	"" "`cat $chemin_langue/menu_176` " \
	"" "" \
	"" "`cat $chemin_langue/menu_177` \Z2/mnt/serveur_oscar \Zn "
       case $? in
	    1)	rm -f /tmp/fichiertmp
		rm -f /tmp/fichiertmp2
		exit;;
	    0)  # Fichiers partagés
	    	dialog  --colors --backtitle "`cat /etc/banniere_oscar`" \
			--title "          `cat $chemin_langue/repertoire_4`          " \
			--exit-label "`cat $chemin_langue/Retour`" --textbox "/tmp/fichiertmp" 0 0
	    	boites_client_verif;;
	    255) rm -f /tmp/fichiertmp
		rm -f /tmp/fichiertmp2
		exit;;
	esac 
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boite_numero_poste()
{
 rm -f /tmp/tempfile
 runme prepare_fichier_temptaille
 	runme colorier_selection_info
 	cp -f /tmp/couleurs_info /tmp/fichier_disque_dur
 	rm -f /tmp/couleurs_info
 
 	# Vérification de la connexion au serveur en NFS
	DIALOGRC="/etc/dialogrc" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " `cat $chemin_langue/menu_174` " \
	--inputbox "`cat /tmp/fichier_disque_dur`\n `cat /tmp/fichierquestion`" 0 0 $defaut 2>/tmp/tempfile
     case $? in
	    0)	rm -f /tmp/fichier_disque_dur
		rm -f /tmp/fichierquestion
		return ;;
	    1)  rm -f /tmp/fichier_disque_dur
		rm -f /tmp/tempfile
		rm -f /tmp/fichierquestion
		exit;;
	    255) rm -f /tmp/fichier_disque_dur
		rm -f /tmp/tempfile
		rm -f /tmp/fichierquestion
		exit;;
	esac
}
#----------------------------------------------------------------------------------------------------
boite_demande_chemin_oscar_serveur()
{
	# Répertoire oscar partagé par le serveur
        DIALOGRC="/etc/dialogrc" dialog --colors \
        --backtitle "`cat /etc/banniere_oscar`" \
        --cancel-label "`cat $chemin_langue/Annuler`"  --title " `cat $chemin_langue/inputbox_29` " \
        --inputbox "\n\n`cat $chemin_langue/inputbox_30`" 11 60 / 2>/tmp/tempfile
     case $? in
            0)
                reponse=`cat /tmp/tempfile`
                rm -f /tmp/tempfile
                return ;;
            1)  rm -f /tmp/tempfile
                echo "" > /tmp/sortir
                return;;
            255) rm -f /tmp/tempfile
                echo "" > /tmp/sortir
                return;;
        esac
}
#-----------------------------------------------------------------------------------------------------
montage_nfs_avec_controle()
{
# /etc/init.d/nfs restart 1>/dev/null 2>/dev/null
mount "$ip_serveur":$chemin_oscar /mnt/serveur_oscar 1>/dev/null 2>/dev/null   # serveur_oscar est le repertoire oscar du serveur
sleep 4

grep -ci "/mnt/serveur_oscar" /etc/mtab > /tmp/test_deja_monte_nfs
test_deja_monte_nfs=`cat /tmp/test_deja_monte_nfs`
rm -f /tmp/test_deja_monte_nfs
if [ "$test_deja_monte_nfs" = "0" ]
then
	montage_nfs_avec_controle
	return
	#	echo
	#	echo -e "\033[1;31m  `cat $chemin_langue/menu_665a`"
	#	echo
	#	echo -e "  `cat $chemin_langue/boucle_2`"
	#	read p
	#	exit
else
	return
fi
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------

	##### recherche d'une adresse ip sur le poste:
	rm -f /tmp/carte_ethi
	runme recuperer_IP	# pour verifier ip fixe donne par OSCAR sur eth0
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		exit
	fi
	##### l'ip est dans le fichier ip_installe_poste
	ip_installe=`cat ip_installe_poste`

	rm -f /tmp/fichierquestion
	
	if [ "$ip_installe" = "" ]
	then
	    runme lancer_dhcp
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
			exit
		fi
	    runme recuperer_IP
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
			exit
		fi
	    ip_installe=`cat ip_installe_poste`
	    if [ "$ip_installe" = "" ]
	    then
		echo "`cat $chemin_langue/inputbox_33` \n`cat $chemin_langue/inputbox_25`" > /tmp/fichierquestion
			defaut=
			boite_numero_poste
			teste_numero_client
			if ( test -e /tmp/sortir )
		        then
		        	rm -f /tmp/fichierquestion
		        	rm -f /tmp/tempfile
	    			rm -f /tmp/sortir
		        	exit
			fi
			reponse=`cat /tmp/tempfile`
			rm -f /tmp/tempfile
		client=$reponse	
		poste=$client
		#client=$[$client+100]
		echo "192.168.69.$client" > ip_installe_poste
		echo "255.255.0.0" > /tmp/ip_masque_poste
		runme installer_IP
		#ifconfig  eth0 192.168.69.$client netmask 255.255.0.0
		ip_installe=192.168.69.$client
		#echo "$ip_installe" > ip_installe_poste
		ip_serveur=192.168.69.254
	    fi
	fi
	rm -f ip_salle
	cut -f1-2 -d"." ip_installe_poste > ip_salle
	echo "`cat $chemin_langue/inputbox_33` \n`cat $chemin_langue/inputbox_34`\Zn " > /tmp/fichierquestion
			defaut=`cat ip_salle`.
			boite_numero_poste
			reponse=`cat /tmp/tempfile`
			rm -f /tmp/tempfile
	ip_serveur=$reponse

        boite_demande_chemin_oscar_serveur
        if ( test -e /tmp/sortir )
        then
                rm -f /tmp/sortir
                exit
        fi
        chemin_oscar=$reponse

# montage linux   monter un répertoire distant avec le protocole de linux
        if ! ( test -e /mnt/serveur_oscar )
        then
                mkdir /mnt/serveur_oscar
        fi

	/etc/init.d/nfs restart 1>/dev/null 2>/dev/null
	montage_nfs_avec_controle
	
	echo "/mnt/serveur_oscar : mont réseau linux" >> /tmp/historique
	echo
	
	ls /mnt/serveur_oscar > /tmp/temp_verif_nfs
	verif_nfs=`cat /tmp/temp_verif_nfs`
	rm -f /tmp/temp_verif_nfs
	if ! [ "$verif_nfs" = "" ]
	then	
		rm -f /tmp/fichiertmp2
		rm -f /tmp/fichiertmp
		echo " " >> /tmp/fichiertmp
		echo "Contenu de /mnt/serveur_oscar :" >> /tmp/fichiertmp
		echo " " >> /tmp/fichiertmp
		ls /mnt/serveur_oscar >> /tmp/fichiertmp
		echo " " >> /tmp/fichiertmp
		echo " " >> /tmp/fichiertmp2
		echo  "\Z1 `cat $chemin_langue/texte_19` \Z2$poste \Z1`cat $chemin_langue/msgbox_28`\Z2 $ip_installe \Zn " >> /tmp/fichiertmp2
		echo " " >> /tmp/fichiertmp2
		boites_client_verif
		exit				
	else
		dialog --colors --backtitle "`cat /etc/banniere_oscar`" \
		--ok-label "`cat $chemin_langue/Continuer`" \
		--title " `cat $chemin_langue/DESOLE` " \
		--msgbox "\n\Zb\Z1  `cat $chemin_langue/texte_19`\Z2 $poste\Z1 `cat $chemin_langue/msgbox_29` ... " 9 56
	fi
#----------------------------------------------------------------------------------------------------
#  fin  de la vérification de la connexion au serveur IMAGE  avec le protocole linux
#----------------------------------------------------------------------------------------------------
