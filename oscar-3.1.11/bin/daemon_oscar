#!/bin/sh


## Copyright (c) 2003-2013 Tissoires Jean-FranÃ§ois & Benjamin,  jftissoires@gmail.com
## Outil SystÃ¨me Complet d'Assistance RÃ©seau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et SystÃ¨mes: RapideSOS
## Ce programme est sous Licence Publique GÃ©nÃ©rale GNU publiÃ©e par la Free Software Foundation.

PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

#	cette adresse peut etre utile :
#	adresse_rdv=233.168.168.69
#	udp-sender -f /tmp/test_version --min-clients $nombre --max-bitrate $vitesse_transmission --interface `cat /tmp/carte_ethi` --mcast-rdv-address $adresse_rdv --portbase 9910 ##--mcast-addr $adresse_synchrone_ctrl



# daemon procedure oscar
#-------------------------------------------------------------------------------------------------------------------------
boucle_enleve_les_doublons_pour_daemon()
{
grep -ci ":" /tmp/temp_doublons_a_supprimer_pour_daemon1 > /tmp/test_nombre_separateurs_pour_daemon
test_nombre_separateurs=`cat /tmp/test_nombre_separateurs_pour_daemon`
rm -f /tmp/test_nombre_separateurs
if ! [ "$test_nombre_separateurs" = "0" ]
then
	cut -d ":" -f1 /tmp/temp_doublons_a_supprimer_pour_daemon1 > /tmp/temp_doublons_a_supprimer_pour_daemon2
	test_vide=`cat /tmp/temp_doublons_a_supprimer_pour_daemon2`
	if ! [ "$test_vide" = "" ]
	then
		cat /tmp/temp_doublons_a_supprimer_pour_daemon2 >> /tmp/doublons_supprimes_pour_daemon
		# remplacer cette valeur par rien dans /tmp/temp_doublons_a_supprimer_pour_daemon1
		echo "perl -pi -e 's/`cat /tmp/temp_doublons_a_supprimer_pour_daemon2`://g;' /tmp/temp_doublons_a_supprimer_pour_daemon1" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		boucle_enleve_les_doublons_pour_daemon
	else
		rm -f /tmp/temp_doublons_a_supprimer_pour_daemon1
		rm -f /tmp/temp_doublons_a_supprimer_pour_daemon2
		return
	fi
else
	rm -f /tmp/temp_doublons_a_supprimer_pour_daemon1
	rm -f /tmp/temp_doublons_a_supprimer_pour_daemon2
	return
fi
}
#-------------------------------------------------------------------------------------------------------------------------
enlever_les_doublons_pour_daemon()
{
# enleve les doublons, les lignes identiques du fichier /tmp/temp_doublons_a_supprimer_pour_daemon
perl -pi -e 's/:/u__oscar__u/g; s/\//w__oscar__w/g;' /tmp/temp_doublons_a_supprimer_pour_daemon
echo `gawk '{ print $1 ":" } ' /tmp/temp_doublons_a_supprimer_pour_daemon` > /tmp/temp_doublons_a_supprimer_pour_daemon1
perl -pi -e 's/: /:/g; s/ //g;' /tmp/temp_doublons_a_supprimer_pour_daemon1  ## pour enlever les espaces
rm -f /tmp/doublons_supprimes_pour_daemon
rm -f /tmp/temp_doublons_a_supprimer_pour_daemon
boucle_enleve_les_doublons_pour_daemon
if ( test -e /tmp/doublons_supprimes_pour_daemon )
then
	perl -pi -e 's/u__oscar__u/:/g; s/w__oscar__w/\//g;' /tmp/doublons_supprimes_pour_daemon
fi
# le fichier sans doublons est /tmp/doublons_supprimes_pour_daemon
}
#-------------------------------------------------------------------------------------------------------------------------
procedure_daemon()
{
if [ "$chrono_procedure" = "synchrone" ]
then
	if ( test -e /tmp/bande_verif )
	then	# attend le nombre de clients
		nombre=`cat /tmp/bande_verif`
		vitesse_transmission=`cat vitesse_transmission`
		cut -d"." -f1-2 ip_installe_poste > /tmp/temp_transfert
		debut_ip_transfert=`cat /tmp/temp_transfert`
		rm -f /tmp/temp_transfert
		
		cp -f /etc/conf.d/oscar.conf /tmp/temp_doublons_a_supprimer_pour_daemon
		enlever_les_doublons_pour_daemon
		cp -f /tmp/doublons_supprimes_pour_daemon /etc/conf.d/oscar.conf
		rm -f /tmp/doublons_supprimes_pour_daemon
		
		echo
		echo -e " `cat $chemin_langue/texte_12`\033[1;m"
		echo
		echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4`\033[1;34m."
		echo
		udp-sender -f /etc/conf.d/oscar.conf --min-clients $nombre --max-bitrate $vitesse_transmission --interface `cat /tmp/carte_ethi`
		daemon_nfs start	# en tache de fond ESSAI
		## NE PAS oublier de faire le daemon_nfs stop au prochain udp-sender
		exit 0
	fi
else	# asynchrone
		if ! ( test -e /mnt/tftpboot_mnt )
		then
			mkdir /mnt/tftpboot_mnt
		fi
		if ( test -e /etc/demarrage_cdrom ) || ( test -e /etc/demarrage_usb )
		then
			tftpboot_partage=/tftpboot
		else	# demarrage poste
			tftpboot_partage=`cat /tmp/tftpboot_partage`
		fi
		#udp-sender -f /etc/conf.d/oscar.conf --daemon-mode --min-clients 1 --max-bitrate 100m --interface `cat /tmp/carte_ethi`
		#udp-sender -f /etc/conf.d/oscar.conf --min-clients 1 --max-bitrate 100m --interface `cat /tmp/carte_ethi` --min-wait 4
		# if ( test -e /mnt/partage_nfs/tmp/serveurs_lances )
		if ( test -e $tftpboot_partage/serveurs_lances )
		then
			echo "grep -v \"`cat ip_installe_poste`\" $tftpboot_partage/serveurs_lances > /tmp/temp_autres_serveurs_lances " > /tmp/exec_nom
			chmod +x /tmp/exec_nom
			/tmp/exec_nom
			rm -f /tmp/exec_nom
			
			cp -f /tmp/temp_oscar.conf /etc/conf.d/oscar.conf
			cat /tmp/temp_autres_serveurs_lances >> /etc/conf.d/oscar.conf
			rm -f /tmp/temp_autres_serveurs_lances
			
			cp -f /etc/conf.d/oscar.conf /tmp/temp_doublons_a_supprimer_pour_daemon
			enlever_les_doublons_pour_daemon
			cp -f /tmp/doublons_supprimes_pour_daemon /etc/conf.d/oscar.conf
			rm -f /tmp/doublons_supprimes_pour_daemon
			
			cp -f /etc/conf.d/oscar.conf $tftpboot_partage/serveurs_lances
			cp -f /etc/conf.d/oscar.conf /mnt/serveur_partage/serveurs_lances
			rm -f /tmp/temp_oscar.conf
		fi
		###### debug sysrcd 1.6.3 essayer la ligne ci-dessous vérifier lors du deploiement si coupure reseau
		#/etc/init.d/nfs restart 2>/dev/null 1>/dev/null
		udp-sender -f /etc/conf.d/oscar.conf --min-clients 1 --max-bitrate 100m --interface `cat /tmp/carte_ethi` --autostart 2
fi
}
#-------------------------------------------------------------------------------------------------------------------------
start()
{
procedure_daemon
if ( test -e /etc/daemon_oscar_lance )
then
	start
fi
}
#-------------------------------------------------------------------------------------------------------------------------
client()
{
udp-receiver -f /tmp/serveur_oscar_nfs --nokbd --interface `cat /tmp/carte_ethi` # 2>/dev/nul
exit 0
}
#-------------------------------------------------------------------------------------------------------------------------


# dans /etc/conf.d/oscar.conf adresse du serveur modele multicast daemon encore en action
# partager en nfs le fichier procedure_oscar_nfs qui contient : 192.168.168.69,synchrone (remplacer 192 par 233) ou 192.168.168.69,asynchrone


#  commandes externes de procÃ©dures
case "$1" in
    start)
	cp -f /etc/conf.d/oscar.conf /tmp/temp_doublons_a_supprimer_pour_daemon
	enlever_les_doublons_pour_daemon
	cp -f /tmp/doublons_supprimes_pour_daemon /etc/conf.d/oscar.conf
	rm -f /tmp/doublons_supprimes_pour_daemon
    	# dans /etc/conf.d/oscar.conf : ip,asynchrone,;$tftpboot_partage  ou ip,synchrone,;$tftpboot_partage ip,synchrone,table;$tftpboot_partage ip,synchrone,disque,;$tftpboot_partage (table et disque toujours synchrone)
	# cut -d"," -f2 /etc/conf.d/oscar.conf > /tmp/chrono_procedure
	chrono_procedure=`cat /tmp/chrono_procedure`
	rm -f /tmp/chrono_procedure
	if [ "$chrono_procedure" = "synchrone" ]
	then
		echo "" > /etc/daemon_oscar_lance
		start
	else
		rm -f /etc/daemon_oscar_lance
		#start &
		start 2>/dev/null
	fi
	exit 0
	;;
    stop)
	rm -f /tmp/serveur_nfs_non_premier_synchrone
    	rm -f /etc/daemon_oscar_lance
    	exit 0
    	;;
    client)
    	client
    	exit 0
    	;;
esac

