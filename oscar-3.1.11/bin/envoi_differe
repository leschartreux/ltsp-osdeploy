#!/bin/sh



## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin,  jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.


PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue


if ! ( test -e /tmp/demarrage_programme_serveur_pxe )
then
	exit 0
fi



#
#
#
#-----------------------------------------------------------------------------------------------------
teste_avec_horaire()
{
sleep 5
date=$(date +%y%m%d)
heure=$(date +%kh%Mmin)
echo "$heure" > /tmp/tempheure
perl -pi -e 's/ /0/g;' /tmp/tempheure
heure=`cat /tmp/tempheure`
rm -f /tmp/tempheure
total=$date$heure
echo "$total" > /tmp/total_instant
perl -pi -e 's/h//g; s/min//g; s/-//g; s/ //g;' /tmp/total_instant
perl -pi -e 's/h//g; s/min//g; s/-//g; s/ //g;' /tmp/programme_depart

temps_final=20`cat /tmp/programme_depart`
temps_instant=20`cat /tmp/total_instant`
temps_restant=$[$temps_final-$temps_instant-1]

teste_fin=`expr substr $temps_restant 1 1`
if [ "$teste_fin" = "-" ]
then
	rm -f /tmp/programme_depart
	rm -f /tmp/total_instant
	rm -f /tmp/date_depart
	rm -f /tmp/heure_depart
	return
fi
if [ "$passage" = "1" ]
then
	prompt_ecran=Z4`cat $chemin_langue/menu_678`
	passage=2
else
	prompt_ecran=Z1`cat $chemin_langue/menu_678`
	passage=1
fi

boite_info_decompte
}
#-----------------------------------------------------------------------------------------------------
boite_info_decompte()
{
defaut="$date-$heure"
	cp -f /etc/dialogrc /tmp/dialogrc
	perl -pi -e 's/item_selected_color = /item_selected_color = (WHITE,BLACK,OFF)\n#/g;' /tmp/dialogrc
	DIALOGRC="/tmp/dialogrc" dialog --colors --timeout 30 \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/menu_676` " \
	--infobox "\n\n\Z4\Zb `cat $chemin_langue/Aujourdhui` \Z2$date\Z4, \Z2$heure \n\n\Z4 `cat $chemin_langue/menu_676` : \Z3`cat /tmp/date_depart`\Z4, \Z3`cat /tmp/heure_depart` \n\n \
	\n           \Zb\\$prompt_ecran \
	\n\n\n \Zn\Z4`cat $chemin_langue/menu_686` \Zb\Z7Ctrl_c " 14 48 2>/dev/null
teste_avec_horaire
}
#-----------------------------------------------------------------------------------------------------
comparer_horaire_programme()
{
date=$(date +%y%m%d)
heure=$(date +%kh%Mmin)
echo "$heure" > /tmp/tempheure
perl -pi -e 's/ /0/g;' /tmp/tempheure
heure=`cat /tmp/tempheure`
rm -f /tmp/tempheure
prompt_ecran=Z1`cat $chemin_langue/menu_678`
passage=1
boite_info_decompte
}
#-----------------------------------------------------------------------------------------------------
lancer_postes()
{
	#lire la premiere valeur
	cut -d"," -f1 /tmp/fichiertemp_clients > /tmp/fichiertemp_clients1
	test_fin=`cat /tmp/fichiertemp_clients1`
	if ! [ "$test_fin" = "" ]
	then
		# remplacer cette valeur par rien dans /tmp/fichiertemp_clients
		echo "perl -pi -e 's/`cat /tmp/fichiertemp_clients1`,//g;' /tmp/fichiertemp_clients" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		rm -f /tmp/exec_nom
		ether-wake `cat /tmp/fichiertemp_clients1`
		sleep 1
		ether-wake `cat /tmp/fichiertemp_clients1`
		sleep 1
		lancer_postes
	fi
	rm -f /tmp/fichiertemp_clients
	rm -f /tmp/fichiertemp_clients1
	rm -f /tmp/programme_depart
}
#-----------------------------------------------------------------------------------------------------
lancer_procedure()
{
fichier=`cat /tmp/fichier_clients`
cp -f /usr/share/oscar/var_salle/$fichier /tmp/fichiertemp_clients1
perl -pi -e 's/,/ ,/g;' /tmp/fichiertemp_clients1
echo `gawk '{ print $1 "," } ' /tmp/fichiertemp_clients1` > /tmp/fichiertemp_clients	# 11:22:33 ; 11:33:99 ;  ...
perl -pi -e 's/ //g;' /tmp/fichiertemp_clients
lancer_postes
}
#-----------------------------------------------------------------------------------------------------
configurer_boot()	# car client
{
	cp -f /usr/share/oscar/usr/isolinux18.cfg /tmp/isolinux_perso.cfg
	noyau_client=`cat /tmp/noyau_differe`
	rm -f /tmp/noyau_differe

	ip_installe=`cat ip_installe_poste`
	echo "perl -pi -e 's/cdoscar/cdoscar scandelay=5 netboot=http:\/\/$ip_installe\/sysrcd.dat/g;' /tmp/isolinux_perso.cfg" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom

	if [ "$noyau_client" = "client" ]
	then
		perl -pi -e 's/default oscar docache/default client docache/g; s/prompt 1//g;' /tmp/isolinux_perso.cfg
	elif [ "$noyau_client" = "client1" ]
	then
	        perl -pi -e 's/default oscar docache/default client1 docache/g; s/prompt 1//g;' /tmp/isolinux_perso.cfg
	elif [ "$noyau_client" = "client_64" ]
	then
	        perl -pi -e 's/default oscar docache/default client_64 docache/g; s/prompt 1//g;' /tmp/isolinux_perso.cfg
	elif [ "$noyau_client" = "client1_64" ]
	then
		perl -pi -e 's/default oscar docache/default client1_64 docache/g; s/prompt 1//g;' /tmp/isolinux_perso.cfg
	elif [ "$noyau_client" = "restaure" ]
	then	
	        perl -pi -e 's/default oscar docache/default restaure docache/g; s/prompt 1//g;' /tmp/isolinux_perso.cfg
	elif [ "$noyau_client" = "restaure1" ]
	then
	        perl -pi -e 's/default oscar docache/default restaure1 docache/g; s/prompt 1//g;' /tmp/isolinux_perso.cfg
	elif [ "$noyau_client" = "restaure_64" ]
	then
	        perl -pi -e 's/default oscar docache/default restaure_64 docache/g; s/prompt 1//g;' /tmp/isolinux_perso.cfg
	elif [ "$noyau_client" = "restaure1_64" ]
	then
	        perl -pi -e 's/default oscar docache/default restaure1_64 docache/g; s/prompt 1//g;' /tmp/isolinux_perso.cfg
	fi
	cp -f /tmp/isolinux_perso.cfg /tftpboot/pxelinux.cfg/default
	rm -f /tmp/isolinux_perso.cfg
}
#-----------------------------------------------------------------------------------------------------
securite_apres_cinq_min()
{
teste_avec_horaire

temps_restant=$[$temps_final-$temps_instant-1]
echo "$temps_restant" > /tmp/temps_restant
perl -pi -e 's/-//g;' /tmp/temps_restant
temps_restant=`cat /tmp/temps_restant`
rm -f /tmp/temps_restant

if [ "$temps_restant" > "5" ]
then
	echo "" > /tmp/mettre_boot_disk1
else
	rm -f /tmp/mettre_boot_disk1
fi
}
#-----------------------------------------------------------------------------------------------------

cut -d"," -f2 /tmp/demarrage_programme_serveur_pxe > /tmp/programme_depart
cut -d"," -f1 /tmp/demarrage_programme_serveur_pxe > /tmp/fichier_clients

cut -d"-" -f1 /tmp/programme_depart > /tmp/date_depart
cut -d"-" -f2 /tmp/programme_depart > /tmp/heure_depart

date=$(date +%y%m%d)
heure=$(date +%kh%Mmin)

#  commandes externes de procédures
case "$1" in
securite_apres_cinq_min)
	securite_apres_cinq_min
	exit 0
	;;
esac
comparer_horaire_programme
configurer_boot
lancer_procedure