#!/bin/bash

## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin,  jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.

#   programme de menu administrateur réseau pour l'autorun

if ( test -e /usr/bin/firefox-bin )
then
	navigateur_web=/usr/bin/firefox-bin
elif ( test -e /usr/bin/midori )
then
	navigateur_web=/usr/bin/midori
fi



#----------------------------------------------------------------------------------------------------
boites_choix_controle_copie()    # copie avec vérification ou non
{
	# Contrôle de la copie de sauvegarde
	oui_ou_non_eteindre=`cat $chemin_langue/menu_266a`	# eteindre a la fin
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/menu_263`" --cancel-label "`cat $chemin_langue/Annuler`" --title " `cat $chemin_langue/menu_262a` " \
	--extra-button --extra-label "`cat $chemin_langue/Controlee`" \
	--menu "\Zb\Z3 `cat $chemin_langue/menu_278` : " 0 0 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_264c`" \
	"" "`cat $chemin_langue/menu_265a`." \
	"" "" \
	"" "" \
	"" "" \
	"" "\Z1`cat $chemin_langue/Remarque` :\Zn " \
	"" " " \
	"" "      `cat $chemin_langue/menu_266d`" \
	"" "      `cat $chemin_langue/menu_267f`" \
	"" ""
       case $? in
	    3)	type_copie=controlee
	    	oui_ou_non_eteindre=`cat $chemin_langue/menu_267a` # Le poste ne s'éteint pas
		;;
	    0)  # Le poste s'éteint à la fin
	    	type_copie=non_controlee
	    	;;
	    1)	echo "" > /tmp/sortir
		return
		;;
	    255) echo "" > /tmp/sortir
		return
		;;
	esac 
}
#----------------------------------------------------------------------------------------------------
eteindre_le_poste()
{
runme boite_eteindre_le_poste
if ( test -e /tmp/annuler_eteindre )
then
	rm -f /tmp/annuler_eteindre
	main
	return
fi

runme boite_eteindre_ordinateur
}
#----------------------------------------------------------------------------------------------------
boucle()  # retour au programme principal
{
echo
echo
echo -e "`cat $chemin_langue/boucle_1`"
echo -ne "`cat $chemin_langue/boucle_2`"
read reponse
main
}
#-----------------------------------------------------------------------------------------------------
boite_erreur_ping_serveur_pxe()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--ok-label "`cat $chemin_langue/Continuer`"  \
	--msgbox "\n\Zb\Z1Il y a déjà un poste $ip_client_fixe_pour_amon2 sur le réseau. \Zn" 7 55
	case $? in
    0) ;;
    255) ;;
esac
}
#----------------------------------------------------------------------------------------------------
controle_ip_fixe_filtre_deja_sur_reseau()
{
ip_installe=`cat ip_installe_poste`
if ! [ "$ip_client_fixe_pour_amon2" = "$ip_installe" ]
then
	echo ...
	echo
	ping -w 8 $ip_client_fixe_pour_amon2 2>/dev/null 1>/dev/null
	test_ping_serveur_pxe=$?
	if [ "$test_ping_serveur_pxe" = "0" ]
	then
		boite_erreur_ping_serveur_pxe
		echo "" > /tmp/sortir
	fi
fi
}
#----------------------------------------------------------------------------------------------------
boite_usb_sauvegarde()	# Donnez le nom du port usb_sauvegarde
{
rm -f /tmp/tempfile_usb
dev_usb_sauvegarde=sdb1
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " Disque USB de sauvegarde  " \
	--inputbox "\n\n\Zb\Z3 Le disque USB de sauvegarde doit être formaté en ext3.\Zn \
	\n\n\n\Zb\Z4 Donnez le port de branchement du \Z2disque USB\Z4 de sauvegarde :  " 0 0 $dev_usb_sauvegarde 2>/tmp/tempfile_usb
	case $? in
    0)  dev_usb_sauvegarde=`cat /tmp/tempfile_usb`
    	rm /tmp/tempfile_usb
	;;
    1)	echo "" > /tmp/sortir
    	rm -f /tmp/tempfile_usb
	;;
    255) echo "" > /tmp/sortir
    	rm -f /tmp/tempfile_usb
	;;
esac
}
#----------------------------------------------------------------------------------------------------
fin_ssh()
{
if [ "$login_root" != "non" ]
then
	ssh $ip_serveur_scribe	'
		grep -v "OSCAR" /root/.ssh/authorized_keys > /root/.ssh/authorized_keys1
		cp -f /root/.ssh/authorized_keys1 /root/.ssh/authorized_keys
		rm -f /root/.ssh/authorized_keys1
		exit
		'
	rm -f /root/.ssh/id_dsa
	rm -f /root/.ssh/id_dsa.pub
	rm -f /etc/console_scribe_ssh_lance
else
	umount /mnt/$ip_serveur_scribe-* 2>/dev/null
fi
}
#----------------------------------------------------------------------------------------------------
debut_ssh()
{
if ( test -e /etc/console_scribe_ssh_lance )
then
	if [ "$output" != console ]
	then
		return
	fi
fi

runme lancer_dhcp 2>/dev/null 1>/dev/null
rm -f /root/.ssh/id_dsa
ssh-keygen -t dsa -b 1024 -N '' -f /root/.ssh/id_dsa 1>/dev/null
echo
echo -e "\033[1;34m Après \033[0;37myes\033[1;34m entrez le mot de passe du \033[0;32mroot\033[1;34m :\033[1;m"
echo
ssh-copy-id -i /root/.ssh/id_dsa.pub $ip_serveur_scribe 1>/dev/null
if [ $? = 0 ]
then
	echo "" > /etc/console_scribe_ssh_lance
fi
}
#----------------------------------------------------------------------------------------------------
boite_demande_login_scribe()
{
awk 'BEGIN { FS=":" } { printf ("%0s\n","\""$1"\" \"\" \\")}' /tmp/temp_cherche_repertoire_utilisateur_scribe > /tmp/bozo

rm -f /tmp/temp_cherche_repertoire_utilisateur_scribe

# boite : Choix du login pour scribe
echo " Choix du login " > /tmp/menu_titre
echo "\n\Zb\Z3Plusieurs comptes trouvés\n" > /tmp/menu_texte
echo "\Zb\Z4Sélectionnez le login : " > /tmp/fichierquestion

echo "15" > /tmp/hauteur
echo "50" > /tmp/largeur
echo "0" > /tmp/position
runme boite_selection_bozo
rm -f /tmp/hauteur
rm -f /tmp/largeur
rm -f /tmp/position
rm -f /tmp/texte
}
#----------------------------------------------------------------------------------------------------
faire_repertoire_utilisateur_scribe()
{
premiere_lettre_login=`expr substr $repertoire_utilisateur_scribe 1 1`
echo "$repertoire_utilisateur_scribe" > /tmp/temp_repertoire_utilisateur_scribe
echo "$premiere_lettre_login" > /tmp/temp_premiere_lettre_repertoire_utilisateur_scribe
scp /tmp/temp_repertoire_utilisateur_scribe $ip_serveur_scribe:/tmp/temp_repertoire_utilisateur_scribe 1>/dev/null
scp /tmp/temp_premiere_lettre_repertoire_utilisateur_scribe $ip_serveur_scribe:/tmp/temp_premiere_lettre_repertoire_utilisateur_scribe 1>/dev/null
rm -f /tmp/temp_premiere_lettre_repertoire_utilisateur_scribe
}
#----------------------------------------------------------------------------------------------------
afficher_repertoire_utilisateurs()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors --no-shadow \
	--backtitle "`cat /etc/banniere_oscar`" \
	--exit-label "`cat $chemin_langue/Continuer`" \
	--title " Utilisateurs " \
	--textbox "/tmp/listing_utilisateur_scribe_envoye_titre" 0 0
	case $? in
	0)	;;
	3) 	;;
	255)	;;
esac

echo "Donnez le login à lister" > /tmp/texte_login_scribe
demander_l_utilisateur # le suivant
}
#----------------------------------------------------------------------------------------------------
envoyer_listing_a_utilisateur()
{
ssh $ip_serveur_scribe	'
	rm -f /tmp/temp_cherche_repertoire_utilisateur_scribe
	cp -f /tmp/temp_listing_utilisateur_scribe /home/`cat /tmp/temp_premiere_lettre_repertoire_utilisateur_scribe`/`cat /tmp/temp_repertoire_utilisateur_scribe`/perso/liste_de_la_taille_des_fichiers.odt
	rm -f /tmp/temp_listing_utilisateur_scribe
	#ls  /home/`cat /tmp/temp_premiere_lettre_repertoire_utilisateur_scribe`/`cat /tmp/temp_repertoire_utilisateur_scribe` -hRAposS > /tmp/temp_listing_utilisateur_scribe
	find /home -type f -user `cat /tmp/temp_repertoire_utilisateur_scribe` -exec ls -hs {} \; >> /home/`cat /tmp/temp_premiere_lettre_repertoire_utilisateur_scribe`/`cat /tmp/temp_repertoire_utilisateur_scribe`/perso/liste_de_la_taille_des_fichiers.odt 2>/dev/null
	'
}
#----------------------------------------------------------------------------------------------------
demander_l_utilisateur()	# puis le suivant
{
# demander l'utilisateur
if ( test -e /tmp/sortir )
then
	return 0
fi
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "Déconnexion"  --title " Répertoire utilisateur " \
	--inputbox "\n \Zb\Z4Login utilisateur\n\n \Z2`cat /tmp/texte_login_scribe` \Z4(quelques lettres) \Z2: " 12 64 2>/tmp/tempfile_repertoire_utilisateur
	case $? in
	0)
	;;
	1)  echo "" > /tmp/sortir
	;;
	255) echo "" > /tmp/sortir
	;;
esac
repertoire_utilisateur_scribe=`cat /tmp/tempfile_repertoire_utilisateur`
rm -f /tmp/tempfile_repertoire_utilisateur

if ( test -e /tmp/sortir )
then
	return 0
fi

faire_repertoire_utilisateur_scribe

ssh $ip_serveur_scribe	'
	ls /home/`cat /tmp/temp_premiere_lettre_repertoire_utilisateur_scribe`/`cat /tmp/temp_repertoire_utilisateur_scribe`* > /tmp/temp_cherche_repertoire_utilisateur_scribe 2>/dev/null
	'
scp $ip_serveur_scribe:/tmp/temp_cherche_repertoire_utilisateur_scribe /tmp/temp_cherche_repertoire_utilisateur_scribe 1>/dev/null

grep -ci "/"  /tmp/temp_cherche_repertoire_utilisateur_scribe > /tmp/temp_nombre_cherche_repertoire_utilisateur_scribe_1
test_depasse=`cat /tmp/temp_nombre_cherche_repertoire_utilisateur_scribe_1`
rm -f /tmp/temp_nombre_cherche_repertoire_utilisateur_scribe_1
if [ "$test_depasse" = "0" ]
then	# trop de lettres
	rm -f /tmp/temp_cherche_repertoire_utilisateur_scribe
	echo "Donnez moins de lettres" > /tmp/texte_login_scribe
	demander_l_utilisateur
	return 0
fi

grep -i "/"  /tmp/temp_cherche_repertoire_utilisateur_scribe > /tmp/temp_cherche_repertoire_utilisateur_scribe_1
# enlever /home/i
cut -d"/" -f4 /tmp/temp_cherche_repertoire_utilisateur_scribe_1 > /tmp/temp_cherche_repertoire_utilisateur_scribe
perl -pi -e 's/://g;' /tmp/temp_cherche_repertoire_utilisateur_scribe
rm -f /tmp/temp_cherche_repertoire_utilisateur_scribe_1
grep -ci `cat /tmp/temp_repertoire_utilisateur_scribe` /tmp/temp_cherche_repertoire_utilisateur_scribe > /tmp/temp_nombre_repertoire_utilisateur_scribe
nombre_repertoires_utilisateurs=`cat /tmp/temp_nombre_repertoire_utilisateur_scribe`
rm -f /tmp/temp_nombre_repertoire_utilisateur_scribe

if [ "$nombre_repertoires_utilisateurs" = "0" ]
then
	echo "utilisateur_inconnu" > /tmp/temp_reponse_repertoire_utilisateur_scribe
elif [ "$nombre_repertoires_utilisateurs" = "1" ]
then
	echo "utilisateur_trouve" > /tmp/temp_reponse_repertoire_utilisateur_scribe
else
	echo "plusieurs_utilisateurs" > /tmp/temp_reponse_repertoire_utilisateur_scribe
fi

reponse_repertoires_utilisateurs=`cat /tmp/temp_reponse_repertoire_utilisateur_scribe`
rm -f /tmp/temp_reponse_repertoire_utilisateur_scribe
if [ "$reponse_repertoires_utilisateurs" = "utilisateur_inconnu" ]
then
	rm -f /tmp/temp_cherche_repertoire_utilisateur_scribe
	echo
	echo
	echo -e " \033[1;31mUtilisateur inconnu : \033[1;37m$repertoire_utilisateur_scribe \033[1;31m... "
	echo
	echo
	echo -e "`cat $chemin_langue/boucle_1`"
	echo -ne "`cat $chemin_langue/boucle_2`"
	read touche
	echo "Donnez le login à lister" > /tmp/texte_login_scribe
	demander_l_utilisateur
	return 0
elif [ "$reponse_repertoires_utilisateurs" = "plusieurs_utilisateurs" ]
then
	boite_demande_login_scribe
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/tempfile
		rm -f /tmp/sortir
	echo "Donnez le login à lister" > /tmp/texte_login_scribe
		demander_l_utilisateur
		return 0
	fi
	repertoire_utilisateur_scribe=`cat /tmp/tempfile`
	rm -f /tmp/tempfile
	faire_repertoire_utilisateur_scribe
fi
rm -f /tmp/temp_cherche_repertoire_utilisateur_scribe

calendrier=$(date +%d/%m/%y)
echo "" > /tmp/temp_listing_utilisateur_scribe
echo " au $calendrier" >> /tmp/temp_listing_utilisateur_scribe
echo "" >> /tmp/temp_listing_utilisateur_scribe
scp /tmp/temp_listing_utilisateur_scribe $ip_serveur_scribe:/tmp/temp_listing_utilisateur_scribe 1>/dev/null
rm -f /tmp/temp_listing_utilisateur_scribe

envoyer_listing_a_utilisateur &

# afficher_utilisateur_scribe_envoye et demander le suivant :

echo "" > /tmp/listing_utilisateur_scribe_envoye_titre
echo " Cette procédure ralentie le serveur SCRIBE !
 Limitez les envois : " >> /tmp/listing_utilisateur_scribe_envoye_titre
echo "" >> /tmp/listing_utilisateur_scribe_envoye_titre
if ( test -e /tmp/listing_utilisateur_scribe_affiche )
then
	cp -f /tmp/listing_utilisateur_scribe_affiche /tmp/listing_utilisateur_scribe_affiche1
fi
echo " --> `cat /tmp/temp_repertoire_utilisateur_scribe` : en cours ..." > /tmp/listing_utilisateur_scribe_affiche
rm -f /tmp/temp_repertoire_utilisateur_scribe
if ( test -e /tmp/listing_utilisateur_scribe_affiche1 )
then
	cat /tmp/listing_utilisateur_scribe_affiche1 >> /tmp/listing_utilisateur_scribe_affiche
fi
cat /tmp/listing_utilisateur_scribe_affiche >> /tmp/listing_utilisateur_scribe_envoye_titre
rm -f /tmp/listing_utilisateur_scribe_affiche1

afficher_repertoire_utilisateurs
echo "Donnez le login à lister" > /tmp/texte_login_scribe
demander_l_utilisateur # le suivant
}
#----------------------------------------------------------------------------------------------------
boite_demande_32bits_ou_64bits()
{
echo "WPKG_Client_32bits.msi
WPKG_Client_64bits.msi" > /tmp/temp_bozo_systeme_client
awk 'BEGIN { FS=":" } { printf ("%0s\n","\""$1"\" \"\" \\")}' /tmp/temp_bozo_systeme_client > /tmp/bozo
rm -f /tmp/temp_bozo_systeme_client

# boite : Choix du Système
echo " Choix du Système " > /tmp/menu_titre
echo "\n\Zb\Z3Installation des postes clients en 32bits ou 64bits.\n" > /tmp/menu_texte
echo "\Zb\Z4Sélectionnez leur système : " > /tmp/fichierquestion

echo "15" > /tmp/hauteur
echo "60" > /tmp/largeur
echo "0" > /tmp/position
runme boite_selection_bozo
rm -f /tmp/hauteur
rm -f /tmp/largeur
rm -f /tmp/position
rm -f /tmp/texte
}
#----------------------------------------------------------------------------------------------------
installer_wpkg()
{
cp -f /tmp/tempfile /tmp/choix_systeme_poste_client
rm -f /tmp/tempfile
cp -f /usr/share/oscar/usr/scribe/oscar_wpkg_config_eol /tmp/temp_oscar_wpkg_config_eol
echo "$ip_serveur_scribe" > /tmp/ip_temp_oscar_wpkg
echo "perl -pi -e 's/IP_SERVEUR_SCRIBE/`cat /tmp/ip_temp_oscar_wpkg`/g;' /tmp/temp_oscar_wpkg_config_eol" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom
debut_ssh
	scp /tmp/ip_temp_oscar_wpkg $ip_serveur_scribe:/tmp/ip_temp_oscar_wpkg 1>/dev/null
	scp /tmp/choix_systeme_poste_client $ip_serveur_scribe:/tmp/temp_choix_systeme_poste_client 1>/dev/null
	rm -f /tmp/ip_temp_oscar_wpkg
	rm -f /tmp/choix_systeme_poste_client
	scp /tmp/temp_oscar_wpkg_config_eol $ip_serveur_scribe:/tmp/temp_oscar_wpkg_config_eol 1>/dev/null
	rm -f /tmp/temp_oscar_wpkg_config_eol
	ssh $ip_serveur_scribe	'
		apt-eole install eole-wpkg
		rm -f /tmp/fin_oscar_reconfigure_eole_wpkg
		oscar_reconfigure_eole_wpkg()
			{
			reconfigure
			echo "" > /tmp/fin_oscar_reconfigure_eole_wpkg
			}
		oscar_reconfigure_eole_wpkg &
		fin_sp_reconfigure=non
		while [ $fin_sp_reconfigure != oui ]
		do
			if ( test -e /tmp/fin_oscar_reconfigure_eole_wpkg )
			then
				fin_sp_reconfigure=oui
				rm -f /tmp/fin_oscar_reconfigure_eole_wpkg
			fi
		done
		ln -s /home/wpkg /home/a/admin/perso/wpkg
		if ! ( test -e /home/a/admin/perso/telechargement_oscar )
		then
			mkdir /home/a/admin/perso/telechargement_oscar
		fi
		if ! ( test -e /home/a/admin/perso/wpkg )
		then
			mkdir /home/a/admin/perso/wpkg
		fi
		cd /home/a/admin/perso/telechargement_oscar
			rm -f scripts_post-pre_wpkg.zip
			rm -f 'fetch.php?media=scribe:scripts_post-pre_wpkg.zip'
			wget http://www2.ac-lyon.fr/serv_ress/mission_tice/wiki/lib/exe/"fetch.php?media=scribe:scripts_post-pre_wpkg.zip"
			cp -f 'fetch.php?media=scribe:scripts_post-pre_wpkg.zip' /home/a/admin/perso/wpkg/scripts_post-pre_wpkg.zip
		cd /home/a/admin/perso/wpkg
				unzip -o scripts_post-pre_wpkg.zip
				cp -f /tmp/temp_oscar_wpkg_config_eol /usr/share/eole/wpkg/wpkg_config.eol
				rm -f /tmp/temp_oscar_wpkg_config_eol
				/usr/share/eole/wpkg/wpkg_configure
				perl -pi -e "s/IP_SCRIBE/`cat /tmp/ip_temp_oscar_wpkg`/g;" /home/a/admin/perso/wpkg/preinstall.bat
				rm -f /tmp/ip_temp_oscar_wpkg
		cd /home/a/admin/perso/telechargement_oscar
			rm -f "WPKG Client 1.3.9-x32.msi"
			rm -f "WPKG Client 1.3.9-x64.msi"
			wget http://www1.wpkg.org/files/client/stable/"WPKG Client 1.3.9-x32.msi"
			wget http://www1.wpkg.org/files/client/stable/"WPKG Client 1.3.9-x64.msi"
			temp_choix_systeme_poste_client=`cat /tmp/temp_choix_systeme_poste_client`
			rm -f /tmp/temp_choix_systeme_poste_client
			if [ "$temp_choix_systeme_poste_client" = "WPKG_Client_32bits.msi" ]
			then
				cp -f "WPKG Client 1.3.9-x32.msi" /home/a/admin/perso/wpkg/WPKG_Client.msi
			else
				cp -f "WPKG Client 1.3.9-x64.msi" /home/a/admin/perso/wpkg/WPKG_Client.msi
			fi
			rm -f wpkg-manage-setup.exe
			wget http://dev-eole.ac-dijon.fr/projects/wpkg-manage/repository/revisions/master/raw/wpkg-manage-setup.exe
			cp -f wpkg-manage-setup.exe /home/a/admin/perso/wpkg/wpkg-manage-setup.exe
		cd /root
		'
# fin_ssh
echo
echo -e " \033[1;32m... "
echo
echo -e " \033[1;32mLe navigateur s'ouvre pour la documentation sur \033[0;37mwpkg_gen_config \033[1;32m...\033[1;34m"
echo
echo -e " \033[1;32m... "
echo
echo -e "\033[1;34m Allez sur le \033[0;32mserveur scribe \033[1;34m:"
echo -e "\033[1;34m --> vérifiez la configuration wpkg en \033[0;32mroot\033[1;34m avec la commande \033[0;37mwpkg_gen_config\033[1;m" 
echo
echo -e "\033[1;34m Sur un poste en windows connecté en \033[0;32madmin \033[1;34m:"
echo -e "\033[1;34m --> lancez la commande \033[1;32mU:\wpkg\wpkg-manage-setup.exe"
echo

for passe in . . . . . . . .
do
	sleep 2
	echo -en "\033[1;31m $passe\033[1;m"
done

$navigateur_web http://www2.ac-lyon.fr/serv_ress/mission_tice/wiki/doku.php?id=scribe:wpkg#configuration_de_wpkg &
echo
for passe in . . . .
do
	sleep 2
	echo -en "\033[1;31m $passe\033[1;m"
done
}
#----------------------------------------------------------------------------------------------------
controle_ip_serveur_scribe_existe()
{
echo
echo
echo -e "\033[1;33m OSCAR \033[1;34mcherche le serveur scribe \033[0;32m$ip_serveur_scribe\033[1;34m ...\033[1;m"
echo
ping -w 8 $ip_serveur_scribe 2>/dev/null 1>/dev/null
test_ping_serveur_pxe=$?
if ! [ "$test_ping_serveur_pxe" = "0" ]
then
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--ok-label "`cat $chemin_langue/Continuer`"  --extra-button --extra-label "`cat $chemin_langue/Forcer`"  \
	--msgbox "\n\Zb\Z1Il n'y a aucun serveur scribe $ip_serveur_scribe sur le réseau. \Zn" 7 65
	case $? in
		0) ;;
		3) return ;;
		255) return ;;
	esac
	menu_scribe_config
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	else
		recupere_adresses_ip
		controle_ip_serveur_scribe_existe
	fi
fi
}
#----------------------------------------------------------------------------------------------------
boite_demande_oscar_scribe()
{
awk 'BEGIN { FS=":" } { printf ("%0s\n","\""$1"\" \"\" \\")}' /tmp/repertoire_copies_oscar_scribe > /tmp/bozo

# boite : Choix de la copie oscar pour scribe

echo "10" > /tmp/hauteur
echo "50" > /tmp/largeur
echo "0" > /tmp/position
runme boite_selection_bozo
rm -f /tmp/hauteur
rm -f /tmp/largeur
rm -f /tmp/position
rm -f /tmp/texte
}
#----------------------------------------------------------------------------------------------------
faire_exec_dialog_oscar_scribe()	# sort le choix : ecraser la selection ou nouvelle copie dans reponse et /tmp/tempfile
{
cat /tmp/bozo >> /tmp/exec_dialog
rm -f /tmp/bozo
rm -f /tmp/tempfile
echo '2>/tmp/tempfile
toutou=$?
if [ $toutou = 255 ]
then
	rm -f /tmp/tempfile
	echo "" > /tmp/sortir
	exit
elif [ $toutou = 0 ] # ok
then
	echo "nouvelle" > /tmp/reponse
	exit
elif [ $toutou = 1 ]
then
	rm -f /tmp/tempfile
	echo "" > /tmp/sortir
	exit
elif [ $toutou = 3 ] # selection
then
	echo "selection" > /tmp/reponse
	exit
fi
' >> /tmp/exec_dialog
chmod +x /tmp/exec_dialog
/tmp/exec_dialog
if ( test -e /tmp/sortir )
then
	return
fi 
reponse=`cat /tmp/tempfile`
}
#----------------------------------------------------------------------------------------------------
choix_copie_sauvegarde() # choisit une copie eventuelle a ecraser
{
# Choix possibles

echo "\n\Zb\Z4Des copies de sauvegardes \Z3OSCAR \Z4existent sur le serveur \Z3scribe\Z4. \
\n\Zb\Z4Vous pouvez sélectionner une copie pour l'écraser.\n\Zb\Z4Sélectionnez la copie à \Z1écraser \Z4ou créez une \Z1nouvelle\Z4 copie :\n " > /tmp/fichierquestion

cp /usr/share/oscar/usr/exec_dialog_src /tmp/exec_dialog -f
perl -pi -e 's/--cancel-label \"\`cat \$chemin_langue\/Annuler\`\"/--cancel-label \"\`cat \$chemin_langue\/Annuler\`\"  --ok-label \" Nouvelle ... \"  --extra-button --extra-label \" Ecraser \"/g;' /tmp/exec_dialog

awk 'BEGIN { FS=":" } { printf ("%0s\n","\""$1"\" \"\" \\")}' /tmp/repertoire_copies_oscar_scribe > /tmp/bozo

faire_exec_dialog_oscar_scribe
if ( test -e /tmp/sortir )
then
	rm -f /tmp/menu_titre
	rm -f /tmp/menu_texte
	rm -f /tmp/fichierquestion
        return
fi
perl -pi -e 's/ //g;' /tmp/reponse
perl -pi -e 's/ //g;' /tmp/tempfile
variable=`cat /tmp/reponse`
rm -f /tmp/reponse

if [ "$variable" = "nouvelle" ]
then
	demander_le_nom_de_la_copie
	copier_la_sauvegarde_sur_scribe
elif [ "$variable" = "selection" ]
then
	cp -f /tmp/tempfile /tmp/nom_copie_oscar
	rm -f /tmp/tempfile
	nom_copie_oscar=`cat /tmp/nom_copie_oscar`
	scp /tmp/nom_copie_oscar $ip_serveur_scribe:/tmp/nom_copie_oscar 1>/dev/null
	copier_la_sauvegarde_sur_scribe
fi
rm -f /tmp/tempfile
rm -f /tmp/menu_titre
rm -f /tmp/menu_texte
rm -f /tmp/fichierquestion
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boite_info_patience_copie_recup()
{
# Patience
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " Copie des fichiers sauvegardés par OSCAR " \
	--infobox "`cat $chemin_langue/infobox_22`\n \
	\n\Z1            --- $oui_ou_non_eteindre ---\Z1\n" 15 60
}
#----------------------------------------------------------------------------------------------------
cherche_partition_copies_oscar_scribe()
{
echo "$sp_info_copies" > /tmp/sp_info_copies
scp /tmp/sp_info_copies $ip_serveur_scribe:/tmp/sp_info_copies 1>/dev/null
rm -f /tmp/sp_info_copies
ssh $ip_serveur_scribe	'
	echo "non" > /tmp/repertoire_copies_existe
	sp_info_copies=`cat /tmp/sp_info_copies`
	rm -f /tmp/sp_info_copies
	valeur_sdai_copies_oscar=0
	for valeurA in a b c d e f g
	do
		if [ "$valeur_sdai_copies_oscar" = 0 ]
		then
			for valeuri in 1 2 3 4 5 6 7 8 9 10
			do
				if [ "$valeur_sdai_copies_oscar" = 0 ]
				then
					if ( test -e /dev/sd$valeurA$valeuri )
					then
						id_type_scribe=`sfdisk /dev/sd$valeurA -c $valeuri 2>/dev/null`
						if [ "$id_type_scribe" = "83" ] # partition linux non swap
						then
							if ! ( test -e /mnt/usb_oscar_scribe )
							then
								mkdir /mnt/usb_oscar_scribe
							fi
							mount /dev/sd$valeurA$valeuri /mnt/usb_oscar_scribe 1>/dev/null 2>/dev/null
							if ( test -e /mnt/usb_oscar_scribe/copies_oscar_scribe )
							then
								echo "sd$valeurA$valeuri" > /tmp/repertoire_copies_existe
							fi
							if [ -d /mnt/usb_oscar_scribe/copies_oscar_scribe ]
							then
								valeur_sdai_copies_oscar=usb_oscar_scribe
								echo "usb_oscar_scribe" > /tmp/partition_montee_copie_oscar_scribe
								ls /mnt/usb_oscar_scribe/copies_oscar_scribe > /tmp/repertoire_copies_oscar_scribe
								
								if [ "$sp_info_copies" = "oui" ]
								then
									ls -oht /mnt/usb_oscar_scribe/copies_oscar_scribe > /tmp/liste_copies_oscar_scribe
									echo "`df /mnt/usb_oscar_scribe/copies_oscar_scribe | grep "usb_oscar_scribe"`" > /tmp/toutes_les_valeurs_repertoire_copies_oscar
									grep -i "dev" /tmp/toutes_les_valeurs_repertoire_copies_oscar > /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar
									rm -f /tmp/toutes_les_valeurs_repertoire_copies_oscar
								fi
							else
								umount /mnt/usb_oscar_scribe 1>/dev/null 2>/dev/null ; sync
							fi
						fi
					fi
				fi
			done
		fi
	done
	echo "$valeur_sdai_copies_oscar" > /tmp/copies_oscar_trouve
	'
scp $ip_serveur_scribe:/tmp/repertoire_copies_existe /tmp/repertoire_copies_existe 1>/dev/null
scp $ip_serveur_scribe:/tmp/copies_oscar_trouve /tmp/copies_oscar_trouve 1>/dev/null
repertoire_copies_existe=`cat /tmp/repertoire_copies_existe`
rm -f /tmp/repertoire_copies_existe
copies_oscar_trouve=`cat /tmp/copies_oscar_trouve`

if [ "$repertoire_copies_existe" != "non" ]
then
	if [ "$sp_info_copies" = "oui" ]
	then
		scp $ip_serveur_scribe:/tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar 1>/dev/null
		scp $ip_serveur_scribe:/tmp/liste_copies_oscar_scribe /tmp/liste_copies_oscar_scribe 1>/dev/null
	fi
	if [ "$copies_oscar_trouve" != "0" ]
	then
		scp $ip_serveur_scribe:/tmp/repertoire_copies_oscar_scribe /tmp/repertoire_copies_oscar_scribe 1>/dev/null
		liste_repertoire_copies_oscar_scribe=`cat /tmp/repertoire_copies_oscar_scribe`
	fi
fi
}
#----------------------------------------------------------------------------------------------------
fin_ssh_copie_recup()
{
ssh $ip_serveur_scribe	'
		if ( test -e /tmp/partition_montee_copie_oscar_scribe )
		then
			umount /mnt/`cat /tmp/partition_montee_copie_oscar_scribe` 1>/dev/null 2>/dev/null ; sync
		fi
		rm -f /tmp/copies_oscar_trouve
		rm -f /tmp/repertoire_copies_oscar_scribe
		rm -f /tmp/nom_copie_oscar
		rm -f /tmp/partition_montee_copie_oscar_scribe
		rm -f /tmp/nom_copie_oscar_a_renommer
		rm -f /tmp/erreur_renomme_oscar
		rm -f /tmp/liste_copies_oscar_scribe
		rm -f /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar
		rm -f /tmp/repertoire_copies_existe
		'
# fin_ssh

rm -f /tmp/repertoire_copies_oscar_scribe
rm -f /tmp/nom_copie_oscar

if [ "$repertoire_copies_existe" != "non" ]
then
	if [ "$copies_oscar_trouve" = "0" ]
	then
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/DESOLE` " \
		--ok-label "`cat $chemin_langue/Continuer`"  \
		--msgbox "\n\Zb\Z4Le répertoire \Z3copies_oscar_scribe \Z4est vide ... \Zn \n " 10 65
		case $? in
			0) ;;
			255) ;;
		esac
	else
		if [ "$type_copie" = "non_controlee" ]
		then
			runme boite_eteindre_ordinateur
		elif [ "$type_copie" = "controlee" ]
		then
			echo
			echo -e " \033[1;33m`cat $chemin_langue/texte_46`\033[1;m ..."
			sauve question_test
		fi
	fi
else
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--ok-label "`cat $chemin_langue/Continuer`"  \
	--msgbox "\n\Zb\Z4La partition contenant \Z3/copies_oscar_scribe \Z4n'existe pas ... \Zn \n \
	\n\Zb\Z4Créez ce répertoire à la racine d'une partition Linux.\Zn " 10 65
	case $? in
		0) ;;
		255) ;;
	esac
fi
rm -f /tmp/copies_oscar_trouve
main
}
#----------------------------------------------------------------------------------------------------
supprimer_la_sauvegarde_sur_scribe()
{
ssh $ip_serveur_scribe	'
	nom_copie_oscar=`cat /tmp/nom_copie_oscar`
	rm -fR /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar
	'
}
#----------------------------------------------------------------------------------------------------
renommer_la_sauvegarde_sur_scribe()
{
ssh $ip_serveur_scribe	'
	nom_copie_oscar_a_renommer=`cat /tmp/nom_copie_oscar_a_renommer`
	nom_copie_oscar=`cat /tmp/nom_copie_oscar`
	if ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar )
	then
		echo "erreur" > /tmp/erreur_renomme_oscar
	else
		echo "" > /tmp/erreur_renomme_oscar
		mv /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar_a_renommer /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar
	fi
	'
}
#----------------------------------------------------------------------------------------------------
recuperer_la_sauvegarde_depuis_scribe()
{
recup_sauvegarde recherche_partition_oscar_pour_recuperer
partition_oscar_pour_recuperer=`cat /tmp/partition_oscar_pour_recuperer`
rm -f /tmp/partition_oscar_pour_recuperer
if ( test -e /tmp/nouveau_commentaire )
then
	nouveau_commentaire_txt=`cat /tmp/nouveau_commentaire`
	rm -f /tmp/nouveau_commentaire
fi

boite_info_patience_copie_recup

ssh $ip_serveur_scribe	'
	nom_copie_oscar=`cat /tmp/nom_copie_oscar`
	if ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar/sauvegarde_oscar/commentaire_oscar.txt )
	then
		echo "OK" > /tmp/commentaire_oscar_scribe
	else
		echo "" > /tmp/commentaire_oscar_scribe
	fi
	if ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar/sauvegarde_oscar/version_oscar )
	then
		echo "OK" > /tmp/version_oscar_scribe
	else
		echo "" > /tmp/version_oscar_scribe
	fi
	if ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar/sauvegarde_oscar/liste_postes_sysprep )
	then
		echo "OK" > /tmp/liste_postes_sysprep_oscar_scribe
	else
		echo "" > /tmp/liste_postes_sysprep_oscar_scribe
	fi
	
	if ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar/sauvegarde_oscar/image.partimage.000 )
	then
		echo "image.partimage" > /tmp/image_transferee_oscar_scribe
	elif ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar/sauvegarde_oscar/image.ntfs.00 )
	then
		echo "image.ntfs" > /tmp/image_transferee_oscar_scribe
	elif ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar/sauvegarde_oscar/image_dar.1.dar )
	then
		echo "image_dar" > /tmp/image_transferee_oscar_scribe
	elif ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar/sauvegarde_oscar/image_fsa.fsa )
	then
		echo "image_fsa" > /tmp/image_transferee_oscar_scribe
	fi
	'

scp $ip_serveur_scribe:/tmp/commentaire_oscar_scribe /tmp/commentaire_oscar_scribe 1>/dev/null
scp $ip_serveur_scribe:/tmp/version_oscar_scribe /tmp/version_oscar_scribe 1>/dev/null
scp $ip_serveur_scribe:/tmp/liste_postes_sysprep_oscar_scribe /tmp/liste_postes_sysprep_oscar_scribe 1>/dev/null
scp $ip_serveur_scribe:/tmp/image_transferee_oscar_scribe /tmp/image_transferee_oscar_scribe 1>/dev/null

commentaire_oscar_scribe=`cat /tmp/commentaire_oscar_scribe`
rm -f /tmp/commentaire_oscar_scribe
version_oscar_scribe=`cat /tmp/version_oscar_scribe`
rm -f /tmp/version_oscar_scribe
liste_postes_sysprep_oscar_scribe=`cat /tmp/liste_postes_sysprep_oscar_scribe`
rm -f /tmp/liste_postes_sysprep_oscar_scribe
image_transferee_oscar_scribe=`cat /tmp/image_transferee_oscar_scribe`
rm -f /tmp/image_transferee_oscar_scribe


if ! [ "$nouveau_commentaire_txt" = "oui" ]
then
	if [ "$commentaire_oscar_scribe" = "OK" ]
	then
		scp $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/commentaire_oscar.txt $partition_oscar_pour_recuperer/oscar/commentaire_oscar.txt 1>/dev/null
	fi
fi

if [ "$version_oscar_scribe" = "OK" ]
then
	scp $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/version_oscar $partition_oscar_pour_recuperer/oscar 1>/dev/null
fi
if [ "$liste_postes_sysprep_oscar_scribe" = "OK" ]
then
	scp $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/liste_postes_sysprep $partition_oscar_pour_recuperer/oscar 1>/dev/null
fi

scp $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/date_de_sauvegarde $partition_oscar_pour_recuperer/oscar 1>/dev/null
scp $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/partition_sauvegardee $partition_oscar_pour_recuperer/oscar 1>/dev/null
scp $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/taille_partition_* $partition_oscar_pour_recuperer/oscar 1>/dev/null
scp $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/sauvegarde_* $partition_oscar_pour_recuperer/oscar 1>/dev/null

ssh $ip_serveur_scribe	'
	rm -f /tmp/commentaire_oscar_scribe
	rm -f /tmp/version_oscar_scribe
	rm -f /tmp/liste_postes_sysprep_oscar_scribe
	rm -f /tmp/image_transferee_oscar_scribe
	'

scp $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/$image_transferee_oscar_scribe.* $partition_oscar_pour_recuperer/oscar

recup_sauvegarde nettoyer_fin
umount $partition_oscar_pour_recuperer 1>/dev/null 2>/dev/null ; sync
}
#----------------------------------------------------------------------------------------------------
copier_la_sauvegarde_sur_scribe()
{
transfert_sauvegarde recherche_partition_oscar_a_copier
partition_oscar_a_copier=`cat /tmp/partition_oscar_a_copier`
rm -f /tmp/partition_oscar_a_copier

boite_info_patience_copie_recup

ssh $ip_serveur_scribe	'
	nom_copie_oscar=`cat /tmp/nom_copie_oscar`
	rm -fR /mnt/`cat /tmp/copies_oscar_trouve`/$nom_copie_oscar
	mkdir -p /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/$nom_copie_oscar/sauvegarde_oscar
	'
scp $partition_oscar_a_copier/oscar/date_de_sauvegarde $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
scp $partition_oscar_a_copier/oscar/partition_sauvegardee $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
scp $partition_oscar_a_copier/oscar/taille_partition_* $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null

if ( test -e $partition_oscar_a_copier/oscar/table_partitions.mbr )
then
	scp $partition_oscar_a_copier/oscar/table_partitions.mbr $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/table_partitions.mbr 1>/dev/null
	scp $partition_oscar_a_copier/oscar/table_partitions.sf $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/table_partitions.sf 1>/dev/null
fi

if ( test -e $partition_oscar_a_copier/oscar/disque_boot )
then
	scp $partition_oscar_a_copier/oscar/disque_boot $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
fi

if ( test -e $partition_oscar_a_copier/oscar/version_oscar )
then	
	scp $partition_oscar_a_copier/oscar/version_oscar $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
fi
if ( test -e $partition_oscar_a_copier/oscar/liste_postes_sysprep )
then	
	scp $partition_oscar_a_copier/oscar/liste_postes_sysprep $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
fi

if ( test -e $partition_oscar_a_copier/oscar/commentaire_oscar.txt )
then
	scp $partition_oscar_a_copier/oscar/commentaire_oscar.txt $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
fi

scp $partition_oscar_a_copier/oscar/sauvegarde_* $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
scp /usr/share/oscar/usr/recuperer_sauvegarde_oscar.txt $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null

if ( test -e $partition_oscar_a_copier/oscar/image.partimage.000 )
then
	image_transferee=image.partimage
elif ( test -e $partition_oscar_a_copier/oscar/image.ntfs.00 )
then
	image_transferee=image.ntfs
elif ( test -e $partition_oscar_a_copier/oscar/image_dar.1.dar )
then
	image_transferee=image_dar
elif ( test -e $partition_oscar_a_copier/oscar/image_fsa.fsa )
then
	image_transferee=image_fsa
fi

scp $partition_oscar_a_copier/oscar/$image_transferee.* $ip_serveur_scribe:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_scribe/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar
transfert_sauvegarde nettoyer_fin
umount $partition_oscar_a_copier 1>/dev/null 2>/dev/null ; sync
}
#----------------------------------------------------------------------------------------------------
proposer_les_sauvegardes()
{
	boite_demande_oscar_scribe
}
#----------------------------------------------------------------------------------------------------
demander_le_nom_de_la_copie()
{
echo -en "\033[1;34m Donnez le nom de cette copie : \033[1;31m"
read nom_copie_oscar
echo -e "\033[1;m"
echo "$nom_copie_oscar" > /tmp/nom_copie_oscar
scp /tmp/nom_copie_oscar $ip_serveur_scribe:/tmp/nom_copie_oscar 1>/dev/null
}
#----------------------------------------------------------------------------------------------------
demander_le_nouveau_nom_de_la_copie()
{
echo -en "\033[1;34m Donnez le nouveau nom de cette copie \033[1;33m$nom_copie_oscar_a_renommer \033[1;34m: \033[1;31m"
read nom_copie_oscar
echo -e "\033[1;m"
echo "$nom_copie_oscar" > /tmp/nom_copie_oscar
scp /tmp/nom_copie_oscar $ip_serveur_scribe:/tmp/nom_copie_oscar 1>/dev/null
}
#----------------------------------------------------------------------------------------------------
remplacer_ComputerName_win7_non_utile()
{
# Pourrait servir si besoin de remplacer dans unattend_poste.xml ComputerName=iiii  par ComputerName=%COMPUTERNAME%
# il faut remplacer <ComputerName>iiii par <ComputerName>%COMPUTERNAME%
grep -i "<ComputerName>" /tmp/tmp_sysprep_oscar/oscar_sysprep/unattend_poste.xml > /tmp/ligne_computername_sysprep
cut -d">" -f2 /tmp/ligne_computername_sysprep > /tmp/valeur_computername_sysprep
cut -d"<" -f1 /tmp/valeur_computername_sysprep > /tmp/valeur_computername_sysprep1
rm -f /tmp/ligne_computername_sysprep
echo "perl -pi -e 's/`cat /tmp/valeur_computername_sysprep1`/%COMPUTERNAME%/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/unattend_poste.xml " > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom	
rm -f /tmp/exec_nom
rm -f /tmp/valeur_computername_sysprep1
}
#----------------------------------------------------------------------------------------------------
demander_domaine()
{
if [ "$groupe_de_travail" = non ]
then
	titre_domaine="Nom du domaine"
	nom_domaine=domaine
else
	titre_domaine="Nom du serveur"
	nom_domaine=serveur
fi
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " $titre_domaine " \
	--inputbox "\n\n\Zb\Z2 Donnez le nom du $nom_domaine : \n " 0 0 2>/tmp/demander_domaine
case $? in
    1)  rm -f /tmp/demander_domaine
        echo "" > /tmp/sortir
	return
	;;
    255) rm -f /tmp/demander_domaine
        echo "" > /tmp/sortir
	return
	;;
esac
domaine_scribe=`cat /tmp/demander_domaine`
rm -f /tmp/demander_domaine
}
#----------------------------------------------------------------------------------------------------
demander_mot_passe_admin()
{
if [ "$groupe_de_travail" = non ]
then
	titre_autorisation="Autorisation domaine"
	texte_domaine="Domaine $domaine_scribe :\n\n\Zn\Z2 Mot de passe d'\Zb\Z3admin\Zn\Z2 autorisé pour le domaine \Zb\Z3$domaine_scribe"
else
	titre_autorisation="Autorisation serveur"
	texte_domaine="Serveur :\n\n\Zn\Z2 Mot de passe d'\Zb\Z3admin\Zn\Z2 autorisé pour l'accés au serveur \Zb\Z3$domaine_scribe"
fi
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " $titre_autorisation " \
	--passwordbox "\n\Zb\Z3 $texte_domaine \Zn\Z2:\n" 11 75 2>/tmp/mot_passe_admin
case $? in
    0)	mot_passe_admin_scribe=`cat /tmp/mot_passe_admin`
	rm -f /tmp/mot_passe_admin
	;;
    1)	rm -f /tmp/mot_passe_admin
	echo "" > /tmp/sortir
	return
	;;
    255) rm -f /tmp/mot_passe_admin
	echo "" > /tmp/sortir
	return
	;;
esac
}
#----------------------------------------------------------------------------------------------------
test_mot_passe()
{
if [ "$reponse_mot_passe" = "" ] || [ "$reponse_mot_passe" = " " ]
then
	# mot de passe non valable
	dialog 	--colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "Recommencez" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\n\Z1 Ce mot de passe n'est pas valable ...\Zn " 9 43
	boite_mdp
fi
}
#----------------------------------------------------------------------------------------------------
boite_mdp()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title "$titre_mdp" \
	--passwordbox "$fichierquestion" 12 80 2>/tmp/temp_mot_passe
case $? in
    0)	reponse_mot_passe=`cat /tmp/temp_mot_passe`
	rm -f /tmp/temp_mot_passe
	test_mot_passe
	;;
    1)	rm -f /tmp/temp_mot_passe
    	echo "" > /tmp/sortir
    	exit ;;
    255) rm -f /tmp/temp_mot_passe
    	echo "" > /tmp/sortir
    	exit ;;
esac
}
#----------------------------------------------------------------------------------------------------
boite_confirme_mdp()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Oui`" --cancel-label "`cat $chemin_langue/Annuler`"  --title "$titre_mdp" \
	--passwordbox "$fichierquestion" 11 75 2>/tmp/temp_mot_passe
case $? in
    0)	reponse_confirme=`cat /tmp/temp_mot_passe`
	rm -f /tmp/temp_mot_passe
	if [ $reponse_confirme = $reponse_mot_passe ]
	then  
		return 
	else
		boite_confirme_mdp
	fi 
	;;
    1)	rm -f /tmp/temp_mot_passe
	echo "" > /tmp/sortir
	return
	;;
    255) rm -f /tmp/temp_mot_passe
	echo "" > /tmp/sortir
	return
	;;
esac
}
#----------------------------------------------------------------------------------------------------
demander_mot_passe_sysprep_et_monter()
{
# Mot de passe sysprep
if [ "$groupe_de_travail" = non ]
then
	titre_mdp="Autorisation domaine"
	fichierquestion="\n\Zb\Z3 Domaine $domaine_scribe :\n\n\Zn\Z2 Mot de passe du compte \Zb\Z3sysprep\Zn\Z2 autorisé pour le domaine \Zb\Z3$domaine_scribe \Zn\Z2:\n"
else
	titre_mdp="Autorisation serveur"
	fichierquestion="\n\Zb\Z3 Serveur :\n\n\Zn\Z2 Mot de passe du compte \Zb\Z3sysprep\Zn\Z2 autorisé pour le serveur \Zb\Z3$domaine_scribe \Zn\Z2:\n"
fi
boite_mdp
if ( test -e /tmp/sortir )
then
	return
fi
mot_passe_sysprep=$reponse_mot_passe

# Confirmation du mot de passe sysprep
titre_mdp=" Confirmation du mot de passe du compte sysprep "
if [ "$groupe_de_travail" = non ]
then
	fichierquestion="\n\Zb\Z3 Confirmez :\n\n\Zn\Z2 Mot de passe du compte \Zb\Z3sysprep\Zn\Z2 pour le domaine \Zb\Z3$domaine_scribe \Zn\Z2:\n"
else
	fichierquestion="\n\Zb\Z3 Confirmez :\n\n\Zn\Z2 Mot de passe du compte \Zb\Z3sysprep\Zn\Z2 pour le serveur \Zb\Z3$domaine_scribe \Zn\Z2:\n"
fi
boite_confirme_mdp
if ( test -e /tmp/sortir )
then
	demander_mot_passe_sysprep_et_monter
	return
fi

echo "$ip_serveur_scribe" > /tmp/ip_serveur_distant
echo "sysprep" > /tmp/repertoire_distant
echo "$ip_serveur_scribe-sysprep" > /tmp/repertoire_utilisateur_poste
echo "admin" > /tmp/username_distant
echo "$mot_passe_admin_scribe" > /tmp/password_distant
runme montage_serveur_samba_distant
if ( test -e /tmp/sortir )
then
	return
fi
}
#----------------------------------------------------------------------------------------------------
demander_mot_passe_admin_local()
{
# Mot de passe administrateur local
titre_mdp=" Administrateur local "
fichierquestion="\n\Zb\Z3 Administrateur local $login_admin_local :\n\n\Zn\Z2 Mot de passe du compte \Zb\Z3$login_admin_local\Zn\Z2 autorisé pour le \Zb\Z3poste modele \Zn\Z2:\n"
boite_mdp
if ( test -e /tmp/sortir )
then
	return
fi
mot_passe_admin_local=$reponse_mot_passe

# Confirmation du mot de passe administrateur local
titre_mdp=" Confirmation du mot de passe administrateur local "
fichierquestion="\n\Zb\Z3 Confirmez :\n\n\Zn\Z2 Le mot de passe de l'administrateur local \Zb\Z3$login_admin_local \Zn\Z2:\n"
boite_confirme_mdp
if ( test -e /tmp/sortir )
then
	demander_mot_passe_admin_local
	return
fi
}
#----------------------------------------------------------------------------------------------------
demander_login_admin_local()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " Login administrateur local " \
	--inputbox "\n\n\Zb\Z2 Donnez le nom login \Z3administrateur local\Z2 : \n " 0 0 2>/tmp/demander_login_admin_local
	case $? in
    1)  rm -f /tmp/demander_login_admin_local
        echo "" > /tmp/sortir
	return
	;;
    255) rm -f /tmp/demander_login_admin_local
        echo "" > /tmp/sortir
	return
	;;
esac
login_admin_local=`cat /tmp/demander_login_admin_local`
rm -f /tmp/demander_login_admin_local
}
#----------------------------------------------------------------------------------------------------
ancien_smbclient_XP()
{
if ! ( test -e /usr/bin/smbclient )
then # utiliser ssh
	debut_ssh
	ssh $ip_serveur_scribe	'
		if ! ( test -e /home/a/admin/perso/sysprep_oscar_xp )
		then
			mkdir /home/a/admin/perso/sysprep_oscar_xp
		fi
		'
	scp -r /tmp/tmp_sysprep_oscar/oscar_sysprep/*.* $ip_serveur_scribe:/home/a/admin/perso/sysprep_oscar_xp/ 1>/dev/null
	scp /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_XP.lnk $ip_serveur_scribe:/home/a/admin/perso/ 1>/dev/null
	# fin_ssh
else
	login_root=non
	runme lancer_dhcp 2>/dev/null 1>/dev/null
	echo
	echo -e "\033[1;34m ATTENTION entrez le mot de passe de l'\033[0;32madmin\033[1;34m :\033[1;m"
	echo
	echo -e "\033[1;34m Puis accepter tous les \033[0;32mPut file\033[1;34m en \033[0;32mEntrant 'y'\033[1;34m"
	echo
	smbclient //$ip_serveur_scribe/admin -U admin -c ' ;
	cd perso ;
	lcd /tmp/tmp_sysprep_oscar/oscar_sysprep ;
	put sysprep_XP.lnk ;
	mkdir sysprep_oscar_xp ;
	cd sysprep_oscar_xp ;
	lcd /tmp/tmp_sysprep_oscar/oscar_sysprep ;
	mput *.* ;
	quit ;
	; ' 2>/dev/null
fi
rm -fr /tmp/tmp_sysprep_oscar
}
#----------------------------------------------------------------------------------------------------
ancien_smbclient_W7()
{
echo "perl -pi -e 's/VOTRE_DOMAINE/$domaine_scribe/g; s/votre_mot_passe_admin/$mot_passe_admin_scribe/g; ' /tmp/tmp_sysprep_oscar/oscar_sysprep/joindre_domaine.txt " > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom
chmod 777 -R /tmp/tmp_sysprep_oscar/oscar_sysprep

if ! ( test -e /usr/bin/smbclient )
then # utiliser ssh
	if [ "$nb_bits_os" = 32 ]
	then
		debut_ssh
		ssh $ip_serveur_scribe	'
			if ! ( test -e /home/a/admin/perso/sysprep_oscar_w7_32 )
			then
				mkdir /home/a/admin/perso/sysprep_oscar_w7_32
			fi
			'
		scp -r /tmp/tmp_sysprep_oscar/oscar_sysprep/*.* $ip_serveur_scribe:/home/a/admin/perso/sysprep_oscar_w7_32/ 1>/dev/null
		scp /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_W7_8_32.lnk $ip_serveur_scribe:/home/a/admin/perso/ 1>/dev/null
	else
		debut_ssh
		ssh $ip_serveur_scribe	'
			if ! ( test -e /home/a/admin/perso/sysprep_oscar_w7_64 )
			then
				mkdir /home/a/admin/perso/sysprep_oscar_w7_64
			fi
			'
		scp -r /tmp/tmp_sysprep_oscar/oscar_sysprep/*.* $ip_serveur_scribe:/home/a/admin/perso/sysprep_oscar_w7_64/ 1>/dev/null
		scp /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_W7_8_64.lnk $ip_serveur_scribe:/home/a/admin/perso/ 1>/dev/null
	fi
	# fin_ssh
else
	login_root=non
	runme lancer_dhcp 2>/dev/null 1>/dev/null
	echo
	# echo -e "\033[1;34m ATTENTION entrez le mot de passe de l'\033[0;32madmin\033[1;34m :\033[1;m"
	echo
	if [ "$nb_bits_os" = 32 ]
	then
		smbclient //$ip_serveur_scribe/admin -U admin%$mot_passe_admin_scribe -c ' ;
		cd perso ;
		lcd /tmp/tmp_sysprep_oscar/oscar_sysprep ;
		put sysprep_W7_8_32.lnk ;
		mkdir sysprep_oscar_w7_32 ;
		cd sysprep_oscar_w7_32 ;
		lcd /tmp/tmp_sysprep_oscar/oscar_sysprep ;
		put oscar_samba_domaine.reg ;
		put oscar_nettoie_sysprep.bat ;
		put joindre_domaine.bat ;
		put joindre_domaine.txt ;
		put sysprep_oscar.xml ;
		put sysprep_var.xml ;
		put oscar.ico ;
		put sysprep_win7_numero_poste_32.bat ;
		put unattend1.xml ;
		put unattend2.xml ;
		put delay.vbs ;
		quit ;
		; ' 2>/dev/null 1>/tmp/testdev1
	else
		smbclient //$ip_serveur_scribe/admin -U admin%$mot_passe_admin_scribe -c ' ;
		cd perso ;
		lcd /tmp/tmp_sysprep_oscar/oscar_sysprep ;
		put sysprep_W7_8_64.lnk ;
		mkdir sysprep_oscar_w7_64 ;
		cd sysprep_oscar_w7_64 ;
		lcd /tmp/tmp_sysprep_oscar/oscar_sysprep ;
		put oscar_samba_domaine.reg ;
		put oscar_nettoie_sysprep.bat ;
		put joindre_domaine.bat ;
		put joindre_domaine.txt ;
		put sysprep_oscar.xml ;
		put sysprep_var.xml ;
		put oscar.ico ;
		put sysprep_win7_numero_poste_64.bat ;
		put unattend1.xml ;
		put unattend2.xml ;
		put delay.vbs ;
		quit ;
		; ' 2>/dev/null 1>/tmp/testdev1
	fi
fi
rm -fr /tmp/tmp_sysprep_oscar
grep -ci "NT_STATUS_LOGON_FAILURE" /tmp/testdev1 > /tmp/nb_testdev1
grep -ci "NT_STATUS_BAD_NETWORK_NAME" /tmp/testdev1 > /tmp/nb_testdev12
nb_testdev1=`cat /tmp/nb_testdev1`
nb_testdev1=`cat /tmp/nb_testdev12`
rm -f /tmp/nb_testdev1
rm -f /tmp/nb_testdev12
rm -f /tmp/testdev1
rm -f /tmp/testdev12
if [ "$nb_testdev1" = 1 ] || [ "$nb_testdev12" = 1 ]
then
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\n\Zb\Z1 Erreur, connexion impossible ..." 9 40
fi
}
#----------------------------------------------------------------------------------------------------
connexion_admin_serveur_scribe()
{
login_root=non
demander_domaine
if ( test -e /tmp/sortir )
then
	return
fi
demander_mot_passe_admin
if ( test -e /tmp/sortir )
then
	return
fi

echo "$ip_serveur_scribe" > /tmp/ip_serveur_distant
echo "admin" > /tmp/repertoire_distant
echo "$ip_serveur_scribe-admin" > /tmp/repertoire_utilisateur_poste
echo "admin" > /tmp/username_distant
echo "$mot_passe_admin_scribe" > /tmp/password_distant
runme montage_serveur_samba_distant
if ( test -e /tmp/sortir )
then
	return
fi
}
#----------------------------------------------------------------------------------------------------
connexion_utilisateur_serveur_scribe()
{
login_root=non
demander_nom_utilisateur
if ( test -e /tmp/sortir )
then
	return
fi
demander_mot_passe_admin
if ( test -e /tmp/sortir )
then
	return
fi

echo "$ip_serveur_scribe" > /tmp/ip_serveur_distant
echo "$nom_utilisateur_scribe" > /tmp/repertoire_distant
echo "$ip_serveur_scribe-$nom_utilisateur_scribe" > /tmp/repertoire_utilisateur_poste
echo "admin" > /tmp/username_distant
echo "$mot_passe_admin_scribe" > /tmp/password_distant
runme montage_serveur_samba_distant
if ( test -e /tmp/sortir )
then
	return
fi
mc /mnt/$ip_serveur_scribe-$nom_utilisateur_scribe
}
#----------------------------------------------------------------------------------------------------
demander_nom_utilisateur()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " Montage répertoire utilisateur " \
	--inputbox "\n\n\Zb\Z2 Donnez le login de l'utilisateur : \n " 0 0 2>/tmp/nom_utilisateur_scribe
	case $? in
    1)  rm -f /tmp/nom_utilisateur_scribe
        echo "" > /tmp/sortir
	return
	;;
    255) rm -f /tmp/nom_utilisateur_scribe
        echo "" > /tmp/sortir
	return
	;;
esac
nom_utilisateur_scribe=`cat /tmp/nom_utilisateur_scribe`
rm -f /tmp/nom_utilisateur_scribe
}
#----------------------------------------------------------------------------------------------------
faire_sysprep_XP_numero_poste_bat()
{
echo "@echo off
rem ## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
rem ## Outil Système Complet d'Assistance Réseau: OSCAR
rem ## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
rem ## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation

set ip_scribe=srv-scribe

mkdir c:\sysprep
xcopy \\\%ip_scribe%\admin\perso\sysprep_oscar_xp\*.* c:\sysprep\*.* /S /E /H /Y

cd c:\sysprep
del c:\sysprep\sysprep.inf
copy c:\sysprep\sysprep_poste.inf c:\sysprep\temp_sysprep.inf
for /F \"delims=\" %%i in (c:\sysprep\temp_sysprep.inf) do call c:\sysprep\routine_remplace.bat \"%%i \"
del c:\sysprep\temp_sysprep.inf

echo.
echo  Poste = %COMPUTERNAME%
echo.
if exist c:\sysprep\sysprep.inf goto continuer
echo.
echo  *** Erreur le fichier c:\sysprep\sysprep.inf est absent ***
echo.
echo.
pause
goto fin
:continuer
c:\sysprep\sysprep.exe -actived -mini -reseal -forceshutdown
:fin
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_XP_numero_poste.bat
}
#----------------------------------------------------------------------------------------------------
faire_fichier_sysprep_win7_numero_poste()
{
echo "@echo off
rem ## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
rem ## Outil Système Complet d'Assistance Réseau: OSCAR
rem ## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
rem ## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation

set ip_scribe=srv-scribe

cd %windir%\System32\sysprep
copy \\\%ip_scribe%\admin_perso\perso\sysprep_oscar_w7_$nb_bits_os\sysprep_var.xml %windir%\System32\sysprep\
copy \\\%ip_scribe%\admin_perso\perso\sysprep_oscar_w7_$nb_bits_os\sysprep_oscar.xml %windir%\System32\sysprep\
copy \\\%ip_scribe%\admin_perso\perso\sysprep_oscar_w7_$nb_bits_os\unattend1.xml %windir%\System32\sysprep\unattend1.txt
copy \\\%ip_scribe%\admin_perso\perso\sysprep_oscar_w7_$nb_bits_os\unattend2.xml %windir%\System32\sysprep\unattend2.txt
copy \\\%ip_scribe%\admin_perso\perso\sysprep_oscar_w7_$nb_bits_os\joindre_domaine.bat %windir%\System32\sysprep\
copy \\\%ip_scribe%\admin_perso\perso\sysprep_oscar_w7_$nb_bits_os\joindre_domaine.txt %windir%\System32\sysprep\joindre_domaine.ps1
copy \\\%ip_scribe%\admin_perso\perso\sysprep_oscar_w7_$nb_bits_os\oscar_samba_domaine.reg %windir%\System32\sysprep\
copy \\\%ip_scribe%\admin_perso\perso\sysprep_oscar_w7_$nb_bits_os\oscar_nettoie_sysprep.bat %windir%\System32\sysprep\
copy \\\%ip_scribe%\admin_perso\perso\sysprep_oscar_w7_$nb_bits_os\delay.vbs %windir%\System32\sysprep\

regedit /s %windir%\System32\sysprep\oscar_samba_domaine.reg
rem %windir%\System32\sysprep\delay.vbs

cd %windir%\System32\sysprep

echo			^<ComputerName^>%ComputerName%^<^/ComputerName^>>>%windir%\System32\sysprep\unattend1.txt

copy /A %windir%\System32\sysprep\unattend1.txt+%windir%\System32\sysprep\unattend2.txt %windir%\System32\sysprep\unattend.txt
echo ^<^/unattend^>>>%windir%\System32\sysprep\unattend.txt
copy %windir%\System32\sysprep\unattend.txt %windir%\System32\sysprep\unattend.xml
del %windir%\System32\sysprep\unattend.txt
del %windir%\System32\sysprep\unattend1.txt
del %windir%\System32\sysprep\unattend2.txt
del %windir%\System32\sysprep\oscar_samba_domaine.reg

echo.
echo.
echo.
echo.
echo     Poste = %COMPUTERNAME%
echo.
echo.
if exist %windir%\System32\sysprep\unattend.xml goto continuer
echo.
echo  *** Erreur le fichier c:\Windows\System32\sysprep\unattend.xml est absent ***
echo.
echo.
pause
goto fin
:continuer

echo.
pause
%windir%\System32\sysprep\sysprep.exe /generalize /oobe /unattend:%windir%\System32\sysprep\unattend.xml
:fin
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_win7_numero_poste_$nb_bits_os.bat
}
#----------------------------------------------------------------------------------------------------
faire_texte_demander_bidon()
{
echo "echo.
echo     avant de redemarrer 'Modifiez les parametres'
echo     dans le menu 'Systeme' de l'Ordinateur
echo     pour le mettre dans le groupe de travail BIDON
echo.
echo     puis redemarrez immmediatement sous OSCAR pour sauvegarder ...
echo.
echo.
echo.
sysdm.cpl @0,1
echo.
echo.
" > /tmp/texte_demander_bidon
}
#----------------------------------------------------------------------------------------------------
faire_copier_pour_deployer()
{
echo "copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\joindre_domaine.txt %windir%\oscar_deploie\joindre_domaine.ps1
copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\oscar_samba_domaine.reg %windir%\oscar_deploie\
regedit /s %windir%\oscar_deploie\oscar_samba_domaine.reg
" > /tmp/copier_pour_deployer
}
#----------------------------------------------------------------------------------------------------
faire_oscar_deploie_numero_poste()
{
echo "" > /tmp/copier_pour_deployer
texte_del_oscar_samba_domaine_reg=
texte_netdom=
texte_delay=
if [ "$groupe_de_travail" = non ]
then
	faire_copier_pour_deployer
	texte_del_oscar_samba_domaine_reg="del %windir%\oscar_deploie\oscar_samba_domaine.reg"
	texte_netdom="if not exist %windir%\System32\netdom.exe goto afficher
	%windir%\System32\netdom.exe remove %COMPUTERNAME% /userd:votre_login_admin /passwordd:votre_mot_passe_admin /force"
	texte_delay="%windir%\oscar_deploie\delay.vbs"
fi
echo "@echo off
rem ## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
rem ## Outil Système Complet d'Assistance Réseau: OSCAR
rem ## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
rem ## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation

set ip_scribe=srv-scribe
`cat /tmp/powershell`
`cat /tmp/fichier_Name`

if not exist %windir%\oscar_deploie mkdir %windir%\oscar_deploie
cd %windir%\oscar_deploie
copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\oscar_var.txt %windir%\oscar_deploie\
copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\joindre_domaine.bat %windir%\oscar_deploie\
copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\local_poste.reg %windir%\oscar_deploie\
copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\demarre_poste.reg %windir%\oscar_deploie\
copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\oscar_nettoie_deploie.bat %windir%\oscar_deploie\
copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\fin_integre_poste.reg %windir%\oscar_deploie\
`cat /tmp/copier_pour_deployer`

if exist \\\%ip_scribe%\admin_perso\perso\oscar_deploie\netdom.exe copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\netdom.exe %windir%\System32\
if exist \\\%ip_scribe%\admin_perso\perso\oscar_deploie\netdom.exe.mui copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\netdom.exe.mui %windir%\System32\fr-FR\
if exist \\\%ip_scribe%\admin_perso\perso\oscar_deploie\wpkg-gp_install.bat copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\wpkg-gp_install.bat %windir%\oscar_deploie\
if exist \\\%ip_scribe%\wpkg\Wpkg-GP_x64.exe copy \\\%ip_scribe%\wpkg\Wpkg-GP_x64.exe %windir%\oscar_deploie\
if exist \\\%ip_scribe%\wpkg\Wpkg-GP_x86.exe copy \\\%ip_scribe%\wpkg\Wpkg-GP_x86.exe %windir%\oscar_deploie\
if exist \\\%ip_scribe%\wpkg\wpkg-gp.ini copy \\\%ip_scribe%\wpkg\wpkg-gp.ini %windir%\oscar_deploie\
if exist \"%programfiles%\Wpkg-GP\uninstall.exe\" \"%programfiles%\Wpkg-GP\uninstall.exe\" /S
if exist \\\%ip_scribe%\admin_perso\perso\oscar_deploie\oscar1.bat copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\oscar1.bat %windir%\oscar_deploie\
if exist \\\%ip_scribe%\admin_perso\perso\oscar_deploie\oscar2.bat copy \\\%ip_scribe%\admin_perso\perso\oscar_deploie\oscar2.bat %windir%\oscar_deploie\

echo.
regedit /s %windir%\oscar_deploie\local_poste.reg
regedit /s %windir%\oscar_deploie\demarre_poste.reg
rem net stop iisadmin /y
rem $texte_delay
cd %windir%\oscar_deploie

$texte_del_oscar_samba_domaine_reg

echo.
echo.
echo.
echo.
echo     Poste = %COMPUTERNAME%
echo.
echo.
$texte_netdom
del %windir%\oscar_deploie\demarre_poste.reg
if exist %windir%\System32\oscar_down.exe goto continuer
%windir%\System32\shutdown.exe -s -t 4
goto fin
:continuer
%windir%\System32\oscar_down.exe -s -t 4
goto fin
:afficher
`cat /tmp/texte_demander_bidon`
echo.
echo.
echo.
echo.
echo.
echo.
pause
:fin
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_deploie_numero_poste.bat
}
#----------------------------------------------------------------------------------------------------
faire_fichier_joindre_domaine_txt()
{
echo "\$credential = New-Object System.Management.Automation.PsCredential(\"VOTRE_DOMAINE\admin\" , (ConvertTo-SecureString \"votre_mot_passe_admin\" -AsPlainText -Force))
Add-Computer -DomainName \"VOTRE_DOMAINE\" -Credential \$credential
Set-ExecutionPolicy restricted
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/joindre_domaine.txt
}
#----------------------------------------------------------------------------------------------------
faire_fichier_joindre_oscar_domaine_bat()
{
if [ "$groupe_de_travail" = non ]
then
	texte_computer="OSCAR inscrit ce poste %ComputerName% au domaine domaine_scribe"
	texte_joindre_ps1="powershell %windir%\oscar_deploie\joindre_domaine.ps1"
	texte_del_joindre_domaine_ps1="del %windir%\oscar_deploie\joindre_domaine.ps1"
else
	texte_computer=`cat $chemin_langue/texte_84`
	texte_joindre_ps1=
	texte_del_joindre_domaine_ps1=
fi
echo "@echo off
rem ## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
rem ## Outil Système Complet d'Assistance Réseau: OSCAR
rem ## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
rem ## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation
echo.
`cat /tmp/powershell`
`cat /tmp/fichier_Name`
echo.
echo.
echo.
echo           $texte_computer.
echo.
echo.
echo.
echo  Le poste va redemarrer ...
echo.
echo.
cd %windir%\System32
@echo off
cls
echo.
echo.
echo.
echo           $texte_computer.
echo.
echo.
echo  Le poste va redemarrer ...
echo.
echo.
cscript slmgr.vbs /ato
`cat /tmp/powershell_oscar`
$texte_joindre_ps1
regedit /s %windir%\oscar_deploie\fin_integre_poste.reg
echo.
if exist %windir%\oscar_deploie\wpkg-gp_install.bat call %windir%\oscar_deploie\wpkg-gp_install.bat
if exist %windir%\oscar_deploie\oscar1.bat call %windir%\oscar_deploie\oscar1.bat
if exist %windir%\System32\oscar_down.exe goto continuer
%windir%\System32\shutdown.exe -r -t 4
goto fin
:continuer
%windir%\System32\oscar_down.exe -r -t 4
goto fin
:fin
$texte_del_joindre_domaine_ps1
del %windir%\oscar_deploie\fin_integre_poste.reg
call %windir%\oscar_deploie\oscar_nettoie_deploie.bat
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/joindre_domaine.bat
}
#----------------------------------------------------------------------------------------------------
faire_fichier_joindre_domaine_bat()
{
echo "@echo off
rem ## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
rem ## Outil Système Complet d'Assistance Réseau: OSCAR
rem ## Rapide de Sauvegarde aux Ordinateurs et Systèmes: RapideSOS
rem ## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation
echo.
`cat /tmp/powershell`
`cat /tmp/fichier_Name`
echo.
echo.
echo.
echo           OSCAR inscrit ce poste %ComputerName% au domaine domaine_scribe.
echo.
echo.
echo.
echo  Le poste va redemarrer ...
echo.
echo.
cd %windir%\System32
cscript slmgr.vbs /ato
powershell %windir%\System32\sysprep\joindre_domaine.ps1
echo.
if exist c:\oscar\oscar1.bat call c:\oscar\oscar1.bat
del %windir%\System32\sysprep\joindre_domaine.ps1
if exist %windir%\System32\oscar_down.exe goto continuer
%windir%\System32\shutdown.exe -r -t 4
goto fin
:continuer
%windir%\System32\oscar_down.exe -r -t 4
goto fin
:fin
%windir%\System32\sysprep\oscar_nettoie_sysprep.bat
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/joindre_domaine.bat
}
#----------------------------------------------------------------------------------------------------
faire_oscar_nettoie_sysprep_xml()
{
echo "@echo off
echo.
del %windir%\Panther\unattend.xml
del %windir%\Panther\Unattend.xml
del %windir%\Panther\Unattend\Unattend.xml
del %windir%\Panther\Unattend\unattend.xml
del %windir%\System32\sysprep\unattend.xml
del %windir%\System32\sysprep\Unattend.xml
del %windir%\System32\sysprep\sysprep_var.xml
del %windir%\System32\sysprep\sysprep_oscar.xml
del %windir%\System32\sysprep\joindre_domaine.ps1
del %windir%\System32\sysprep\delay.vbs
cls
del %windir%\System32\sysprep\joindre_domaine.bat
del %windir%\oscar_deploie\Wpkg-GP_x64.exe
del %windir%\oscar_deploie\Wpkg-GP_x86.exe
del %windir%\oscar_deploie\wpkg-gp.ini
del %windir%\System32\sysprep\oscar_nettoie_sysprep.bat
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_nettoie_sysprep.bat
}
#----------------------------------------------------------------------------------------------------
faire_oscar_nettoie_deploie_bat()
{
echo "@echo off
echo.
del %windir%\oscar_deploie\oscar_var.txt
del %windir%\oscar_deploie\local_poste.reg
del %windir%\oscar_deploie\delay.vbs
cls
del %windir%\oscar_deploie\joindre_domaine.bat
del %windir%\oscar_deploie\wpkg-gp_install.bat
del %windir%\oscar_deploie\Wpkg-GP_x64.exe
del %windir%\oscar_deploie\Wpkg-GP_x86.exe
del %windir%\oscar_deploie\wpkg-gp.ini
del %windir%\oscar_deploie\oscar_nettoie_deploie.bat
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_nettoie_deploie.bat
}
#----------------------------------------------------------------------------------------------------
faire_fichier_powershell()
{
echo "set ip_proxy=ip_proxy_accepte
set port_proxy=port_proxy_accepte
powershell -command Set-ExecutionPolicy unrestricted
netsh winhttp set proxy %ip_proxy%:%port_proxy%
" > /tmp/powershell
}
#----------------------------------------------------------------------------------------------------
boucle_fichier_Name()
{
cut -d":" -f1 /tmp/fichier_Name1 > /tmp/val_fichier_Name
val_fichier_Name=`cat /tmp/val_fichier_Name`
rm -f /tmp/val_fichier_Name
if [ "$val_fichier_Name" != fin_ligne ]
then
	echo "wmic path Win32_UserAccount WHERE Name='$val_fichier_Name' set PasswordExpires=false" >> /tmp/fichier_Name
	echo "perl -pi -e 's/$val_fichier_Name://g;' /tmp/fichier_Name1" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	boucle_fichier_Name
	return
fi
rm -f /tmp/fichier_Name1
}
#----------------------------------------------------------------------------------------------------
faire_compte_win_mdp_illimite()
{
grep \<Name\> /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_oscar.xml | grep \<Name\\\> | cut -d">" -f2 | cut -d"<" -f1 > /tmp/fichier_Name
echo "fin_ligne" >> /tmp/fichier_Name
echo `gawk '{print $1 ":"}' /tmp/fichier_Name` | perl -pi -e 's/ //g;' > /tmp/fichier_Name1
rm -f /tmp/fichier_Name
boucle_fichier_Name
}
#----------------------------------------------------------------------------------------------------
faire_fichier_nom_poste_reg_essai()
{
# il faudra tester pour remplacer Poste_OSCAR par $Poste_OSCAR ou %ComputerName% voir mettre_nom_poste
echo "REGEDIT4

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName]
\"ComputerName\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\ComputerName\ActiveComputerName]
\"ComputerName\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters]
\"Hostname\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters]
\"NV Hostname\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"DefaultDomainName\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\VxD\VNETSUP]
\"ComputerName\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce]
\"oscarC\"=\"C:\\\\demarre_oscar\\\\fin_numero_poste_oscar.bat\"
`cat oscar_modifstartup_ip.reg`" > /tmp/tmp_sysprep_oscar/oscar_sysprep/fichier_nom_poste.reg
}
#----------------------------------------------------------------------------------------------------
faire_fin_integre_poste_reg()
{
echo "REGEDIT4

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"DefaultPassword\"=\"\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"DefaultUserName\"=\"\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"AutoAdminLogon\"=\"0\"
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/fin_integre_poste.reg
}
#----------------------------------------------------------------------------------------------------
faire_oscar_samba_domaine_reg()
{
echo "REGEDIT4

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\LanmanWorkstation\Parameters]
\"DomainCompatibilityMode\"=dword:00000001
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\LanmanWorkstation\Parameters]
\"DNSNameResolutionRequired\"=dword:00000000
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Netlogon\Parameters]
\"RequireStrongKey\"=dword:00000001
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Netlogon\Parameters]
\"RequireSignOrSeal\"=dword:00000001
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_samba_domaine.reg
}
#----------------------------------------------------------------------------------------------------
faire_local_poste_reg()
{
echo "REGEDIT4

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"DefaultPassword\"=\"mot_passe_admin_local\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"DefaultUserName\"=\"login_admin_local\"
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/local_poste.reg
}
#----------------------------------------------------------------------------------------------------
faire_fichier_nom_poste_reg_ancien()
{
# il faudra tester pour remplacer Poste_OSCAR par $Poste_OSCAR ou %ComputerName% voir mettre_nom_poste
echo "REGEDIT4

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName]
\"ComputerName\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\ComputerName\ActiveComputerName]
\"ComputerName\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters]
\"Hostname\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters]
\"NV Hostname\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"DefaultDomainName\"=\"Poste_OSCAR\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"DefaultPassword\"=\"mot_passe_admin_local\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"DefaultUserName\"=\"login_admin_local\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"AutoAdminLogon\"=\"1\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce]
\"oscarC\"=\"C:\\\\Windows\\\\oscar_deploie\\\\joindre_domaine.bat\"
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/fichier_nom_poste.reg
}
#----------------------------------------------------------------------------------------------------
faire_demarre_poste_reg()
{
echo "REGEDIT4

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]
\"AutoAdminLogon\"=\"1\"
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce]
\"oscarC\"=\"C:\\\\Windows\\\\oscar_deploie\\\\joindre_domaine.bat\"
" > /tmp/tmp_sysprep_oscar/oscar_sysprep/demarre_poste.reg
}
#----------------------------------------------------------------------------------------------------
faire_fichier_sysprep_pour_XP()
{
faire_sysprep_XP_numero_poste_bat
cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep.inf /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_poste.inf

# remplacer dans sysprep_poste.xml ComputerName=iiii  par ComputerName=%COMPUTERNAME%
grep -i "ComputerName=" /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_poste.inf > /tmp/ligne_computername_sysprep
cut -d"=" -f2 /tmp/ligne_computername_sysprep > /tmp/valeur_computername_sysprep
rm -f /tmp/ligne_computername_sysprep
echo "perl -pi -e 's/ComputerName=`cat /tmp/valeur_computername_sysprep`/ComputerName=%COMPUTERNAME%/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_poste.inf " > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom
rm -f /tmp/valeur_computername_sysprep

# sysprep_XP est le lien vers sysprep_XP_numero_poste.bat
if [ "$sp_deploiement_oscar_linux" != oui ]
then
	cp -f /usr/share/oscar/usr/scribe/sysprep_XP /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_XP.lnk
fi
cp -f /usr/share/oscar/usr/scribe/routine_remplace /tmp/tmp_sysprep_oscar/oscar_sysprep/routine_remplace.bat
cp -f /usr/share/oscar/usr/oscar.ico /tmp/tmp_sysprep_oscar/oscar_sysprep/
echo "perl -pi -e 's/srv-scribe/$ip_serveur_scribe/g; ' /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_XP_numero_poste.bat " > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom
cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_XP_numero_poste.bat /tmp/tmp_sysprep_oscar/oscar_sysprep/compte_sysprep_XP_numero_poste.bat
perl -pi -e 's/admin/sysprep/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/compte_sysprep_XP_numero_poste.bat

cp -f /usr/share/oscar/usr/scribe/Copie_ApplicationData_prof_SYSPREP /tmp/tmp_sysprep_oscar/oscar_sysprep/Copie_ApplicationData_prof_SYSPREP.bat
if [ "$sp_deploiement_oscar_linux" != oui ]
then
	cp -f /usr/share/oscar/usr/scribe/Copie_ApplicationData_prof_SYSPREP.lnk /tmp/tmp_sysprep_oscar/oscar_sysprep/
fi
# travail :
connexion_admin_serveur_scribe
if ( test -e /tmp/sortir )
then
	rm -f /tmp/sortir
	rm -fr /tmp/tmp_sysprep_oscar
	main
fi
demander_mot_passe_sysprep_et_monter
pas_repertoire_sysprep=non
if ( test -e /tmp/sortir )
then
	rm -f /tmp/sortir
	pas_repertoire_sysprep=oui
	main
fi

chmod 777 -R /tmp/tmp_sysprep_oscar/oscar_sysprep
if ! ( test -e /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_xp )
then
	mkdir /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_xp
fi
if [ "$sp_deploiement_oscar_linux" != oui ]
then
	cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_XP.lnk /mnt/$ip_serveur_scribe-admin/perso/
fi
cp -rf /tmp/tmp_sysprep_oscar/oscar_sysprep/* /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_xp/
rm -f /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_xp/compte_sysprep_XP_numero_poste.bat

if ( test -e /mnt/$ip_serveur_scribe-sysprep/perso )
then
	if ! ( test -e /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_xp )
	then
		mkdir /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_xp
	fi
	perl -pi -e 's/DomainAdmin=admin/DomainAdmin=sysprep/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_oscar.inf
	perl -pi -e 's/DomainAdmin=admin/DomainAdmin=sysprep/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep.inf
	perl -pi -e 's/DomainAdmin=admin/DomainAdmin=sysprep/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_poste.inf
	echo "perl -pi -e 's/=$mot_passe_admin_scribe/=$mot_passe_sysprep/g; ' /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_oscar.inf
	perl -pi -e 's/=$mot_passe_admin_scribe/=$mot_passe_sysprep/g; ' /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep.inf
	perl -pi -e 's/=$mot_passe_admin_scribe/=$mot_passe_sysprep/g; ' /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_poste.inf " > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
	if [ "$sp_deploiement_oscar_linux" != oui ]
	then
		cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_XP.lnk /mnt/$ip_serveur_scribe-sysprep/perso/
	fi
	cp -fr /tmp/tmp_sysprep_oscar/oscar_sysprep/* /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_xp/
	cp -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_xp/compte_sysprep_XP_numero_poste.bat /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_xp/sysprep_XP_numero_poste.bat
	rm -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_xp/compte_sysprep_XP_numero_poste.bat
fi
rm -fr /tmp/tmp_sysprep_oscar
# ancien_smbclient_XP

echo
echo -e "\033[1;34m Le répertoire \033[1;32m/admin/perso/sysprep_oscar_xp\033[1;34m est à jour dans \033[1;32m$domaine_scribe\033[1;34m ...\033[1;m"
if [ "$pas_repertoire_sysprep" = non ]
then
	echo -e "\033[1;34m Le répertoire \033[1;32m/sysprep/perso/sysprep_oscar_xp\033[1;34m est à jour dans \033[1;32m$domaine_scribe\033[1;34m ...\033[1;m"
fi
echo
boucle
}
#----------------------------------------------------------------------------------------------------
faire_fichiers_pour_deployer()
{
oscar_deploie_avec_sysprep=oui
groupe_de_travail=non
if ( test -e /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_var.txt )
then
	oscar_deploie_avec_sysprep=non
	grep -c "Groupe de travail" /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_var.txt > /tmp/nb_groupe_de_travail
	grep -c "Workgroup" /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_var.txt > /tmp/nb_groupe_de_travail1
	nb_groupe_de_travail=`cat /tmp/nb_groupe_de_travail`
	nb_groupe_de_travail1=`cat /tmp/nb_groupe_de_travail1`
	rm -f /tmp/nb_groupe_de_travail
	rm -f /tmp/nb_groupe_de_travail1
	if [ "$nb_groupe_de_travail" = 1 ] || [ "$nb_groupe_de_travail1" = 1 ]
	then
		groupe_de_travail=oui
	fi
elif ( test -e /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_oscar.inf )
then
	faire_fichier_sysprep_pour_XP
	if [ "$sp_deploiement_oscar_linux" = oui ]
	then
		return
	else
		main
	fi
fi
echo "" > /tmp/fichier_Name
if [ "$oscar_deploie_avec_sysprep" = oui ]
then
	# cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_oscar.xml /tmp/tmp_sysprep_oscar/oscar_sysprep/unattend_poste.xml
	# remplacer_ComputerName_win7_non_utile
	grep -ci "x86" /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_oscar.xml > /tmp/nb_test_x86
	nb_test_x86=`cat /tmp/nb_test_x86`
	rm -f /tmp/nb_test_x86
	if [ "$nb_test_x86" != 0 ]
	then
		nb_bits_os=32
	else
		nb_bits_os=64
	fi
	faire_oscar_nettoie_sysprep_xml
	# ajouter cette ligne si besoin apres debug :
	# faire_compte_win_mdp_illimite
else
	faire_oscar_nettoie_deploie_bat
fi
echo "powershell -command Set-ExecutionPolicy unrestricted" > /tmp/powershell
# supprimer ou remettre cette ligne si besoin apres debug 'ip_proxy=non' :
if ( test -e /tmp/defaut_ip_sans_proxy )
then	# demande par menu_domaine sans scribe 
	ip_proxy=non
	rm -f /tmp/defaut_ip_sans_proxy
fi
if ! [ "$ip_proxy" = non ]
then
	faire_fichier_powershell
fi
# ajouter cette ligne si besoin apres debug et dans else aussi :
# echo "netsh advfirewall set allprofiles state off " >> /tmp/powershell
if [ "$oscar_deploie_avec_sysprep" = oui ]
then
	faire_fichier_joindre_domaine_bat
else
	# ajouter cette ligne si besoin apres debug et supprimer la suivante :
	# echo "netsh advfirewall set allprofiles state on " > /tmp/powershell_oscar
	echo "" > /tmp/powershell_oscar
	faire_fichier_joindre_oscar_domaine_bat
fi

echo "WScript.Sleep(1000)" > /tmp/tmp_sysprep_oscar/oscar_sysprep/delay.vbs
echo "" > /tmp/tmp_sysprep_oscar/oscar_sysprep/joindre_domaine.txt
if [ "$groupe_de_travail" = non ]
then
	faire_fichier_joindre_domaine_txt
fi
if [ "$oscar_deploie_avec_sysprep" = oui ]
then
	faire_fichier_sysprep_win7_numero_poste
else
	echo "" > /tmp/texte_demander_bidon
	if [ "$groupe_de_travail" = non ]
	then
		faire_texte_demander_bidon
	fi
	faire_oscar_deploie_numero_poste
	rm -f /tmp/texte_demander_bidon
	faire_fin_integre_poste_reg
fi
rm -f /tmp/fichier_Name
rm -f /tmp/powershell
rm -f /tmp/powershell_oscar

# 3 fichiers fournis par l'administrateur :
# joindre_domaine.txt , sysprep_oscar.xml , sysprep_var.xml
cp -f /usr/share/oscar/usr/oscar.ico /tmp/tmp_sysprep_oscar/oscar_sysprep/
echo "" > /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_samba_domaine.reg
if [ "$groupe_de_travail" = non ]
then
	faire_oscar_samba_domaine_reg
fi
if [ "$oscar_deploie_avec_sysprep" = oui ]
then
	# sysprep_W7_8 est le lien vers sysprep_win7_numero_poste.bat
	if [ "$sp_deploiement_oscar_linux" != oui ]
	then
		cp -f /usr/share/oscar/usr/scribe/sysprep_W7_8_$nb_bits_os /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_W7_8_$nb_bits_os.lnk
	fi
	echo "perl -pi -e 's/srv-scribe/$ip_serveur_scribe/g; ' /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_win7_numero_poste_$nb_bits_os.bat " > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
	cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_win7_numero_poste_$nb_bits_os.bat /tmp/tmp_sysprep_oscar/oscar_sysprep/compte_sysprep_win7_numero_poste_$nb_bits_os.bat
	perl -pi -e 's/admin_perso/admin/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_win7_numero_poste_$nb_bits_os.bat
	perl -pi -e 's/admin_perso/sysprep/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/compte_sysprep_win7_numero_poste_$nb_bits_os.bat

	# faire les demis fichiers unattend1 et unattend2 de unattend (on enleve la ligne du nom du poste et la derniere ligne.
	# numeroter les lignes :
	grep -n "" /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_oscar.xml > /tmp/unattend_avec_numero_lignes
	grep -i "<ComputerName>" /tmp/unattend_avec_numero_lignes > /tmp/ligne_computername
	cut -d":" -f1 /tmp/ligne_computername > /tmp/numero_ligne_computername
	grep -i "</unattend>"  /tmp/unattend_avec_numero_lignes > /tmp/derniere_ligne
	cut -d":" -f1 /tmp/derniere_ligne > /tmp/nb_ligne_unattend

	numero_ligne_computername=`cat /tmp/numero_ligne_computername`
	numero_ligne_computername=$[$numero_ligne_computername]
	nb_lignes_avant_computeur=$[$numero_ligne_computername-1]
	grep -B $nb_lignes_avant_computeur "<ComputerName>" /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_oscar.xml > /tmp/lignes_avant_computeur_et_lui_meme
	grep -v "<ComputerName>" /tmp/lignes_avant_computeur_et_lui_meme > /tmp/tmp_sysprep_oscar/oscar_sysprep/unattend1.xml

	nb_ligne_unattend=`cat /tmp/nb_ligne_unattend`
	nb_ligne_unattend=$[$nb_ligne_unattend]
	numero_ligne_computername=`cat /tmp/numero_ligne_computername`
	numero_ligne_computername=$[$numero_ligne_computername]
	nb_ligne_apres_computername=$[$nb_ligne_unattend-$numero_ligne_computername-1]	# ne pas prendre la derniere ligne </unattend>
	grep -A $nb_ligne_apres_computername "<ComputerName>" /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_oscar.xml > /tmp/lignes_apres_computeur_et_lui_meme
	grep -v "<ComputerName>" /tmp/lignes_apres_computeur_et_lui_meme > /tmp/tmp_sysprep_oscar/oscar_sysprep/unattend2.xml
	rm -f /tmp/unattend_avec_numero_lignes
	rm -f /tmp/ligne_computername
	rm -f /tmp/numero_ligne_computername
	rm -f /tmp/derniere_ligne
	rm -f /tmp/nb_ligne_unattend
	rm -f /tmp/lignes_avant_computeur_et_lui_meme
	rm -f /tmp/lignes_apres_computeur_et_lui_meme
fi

# travail :
connexion_admin_serveur_scribe
if ( test -e /tmp/sortir )
then
	rm -fr /tmp/tmp_sysprep_oscar
	return
fi
pas_repertoire_sysprep=oui
demander_mot_passe_sysprep_et_monter
pas_repertoire_sysprep=non
if ( test -e /tmp/sortir )
then
	pas_repertoire_sysprep=oui
	return
fi
if [ "$oscar_deploie_avec_sysprep" = non ]
then # demander login et mot de passe en local
	demander_login_admin_local
	if ( test -e /tmp/sortir )
	then
		return
	fi
	demander_mot_passe_admin_local
	if ( test -e /tmp/sortir )
	then
		return
	fi
	faire_local_poste_reg
	faire_demarre_poste_reg
	echo "perl -pi -e 's/login_admin_local/$login_admin_local/g; s/mot_passe_admin_local/$mot_passe_admin_local/g; ' /tmp/tmp_sysprep_oscar/oscar_sysprep/local_poste.reg" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
	if [ "$sp_deploiement_oscar_linux" != oui ]
	then
		cp -f /usr/share/oscar/usr/scribe/oscar_deploie /tmp/tmp_sysprep_oscar/oscar_sysprep/OSCAR_deploie.lnk
	fi
	echo "
	if [ $groupe_de_travail = non ]
	then
		perl -pi -e 's/srv-scribe/$ip_serveur_scribe/g; s/VOTRE_DOMAINE/$domaine_scribe/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_deploie_numero_poste.bat
	else
		perl -pi -e 's/srv-scribe/$domaine_scribe/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_deploie_numero_poste.bat
	fi
	" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
	cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_deploie_numero_poste.bat /tmp/tmp_sysprep_oscar/oscar_sysprep/compte_oscar_deploie_numero_poste.bat
	perl -pi -e 's/admin_perso/admin/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_deploie_numero_poste.bat
	echo "perl -pi -e 's/admin_perso/sysprep/g; s/votre_login_admin/sysprep/g; s/votre_mot_passe_admin/$mot_passe_sysprep/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/compte_oscar_deploie_numero_poste.bat" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
	if ( test -e /mnt/$ip_serveur_scribe-sysprep/perso )
	then
		echo "perl -pi -e 's/votre_login_admin/sysprep/g; s/votre_mot_passe_admin/$mot_passe_sysprep/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_deploie_numero_poste.bat" > /tmp/exec_nom
	else
		echo "perl -pi -e 's/votre_login_admin/admin/g; s/votre_mot_passe_admin/$mot_passe_admin_scribe/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_deploie_numero_poste.bat" > /tmp/exec_nom
	fi
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
fi
echo "perl -pi -e 's/VOTRE_DOMAINE/$domaine_scribe/g; s/votre_mot_passe_admin/$mot_passe_admin_scribe/g; ' /tmp/tmp_sysprep_oscar/oscar_sysprep/joindre_domaine.txt
perl -pi -e 's/ip_proxy_accepte/$ip_proxy/g; s/port_proxy_accepte/$port_ip_proxy/g; s/domaine_scribe/$domaine_scribe/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/joindre_domaine.bat
perl -pi -e 's/ip_proxy_accepte/$ip_proxy/g; s/port_proxy_accepte/$port_ip_proxy/g; s/domaine_scribe/$domaine_scribe/g;' /tmp/tmp_sysprep_oscar/oscar_sysprep/oscar_deploie_numero_poste.bat
" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom

cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/joindre_domaine.txt /tmp/tmp_sysprep_oscar/oscar_sysprep/compte_sysprep_joindre_domaine.txt
echo "perl -pi -e 's/admin/sysprep/g; s/$mot_passe_admin_scribe/$mot_passe_sysprep/g; ' /tmp/tmp_sysprep_oscar/oscar_sysprep/compte_sysprep_joindre_domaine.txt " > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom
chmod 777 -R /tmp/tmp_sysprep_oscar/oscar_sysprep

if [ "$oscar_deploie_avec_sysprep" = oui ]
then
	if [ "$nb_bits_os" = 32 ]
	then
		if ! ( test -e /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_32 )
		then
			mkdir /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_32
		fi
		if [ "$sp_deploiement_oscar_linux" != oui ]
		then
			cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_W7_8_32.lnk /mnt/$ip_serveur_scribe-admin/perso/
		fi
		cp -fr /tmp/tmp_sysprep_oscar/oscar_sysprep/* /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_32/
		rm -f /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_32/compte_sysprep_joindre_domaine.txt
		rm -f /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_32/compte_sysprep_win7_numero_poste_$nb_bits_os.bat
		if ( test -e /mnt/$ip_serveur_scribe-sysprep/perso )
		then
			if ! ( test -e /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_32 )
			then
				mkdir /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_32
			fi
			if [ "$sp_deploiement_oscar_linux" != oui ]
			then
				cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_W7_8_32.lnk /mnt/$ip_serveur_scribe-sysprep/perso/
			fi
			cp -fr /tmp/tmp_sysprep_oscar/oscar_sysprep/* /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_32/
			cp -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_32/compte_sysprep_joindre_domaine.txt /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_32/joindre_domaine.txt
			cp -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_32/compte_sysprep_joindre_domaine.txt /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_32/joindre_domaine.txt
			cp -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_32/compte_sysprep_win7_numero_poste_$nb_bits_os.bat /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_32/sysprep_win7_numero_poste_$nb_bits_os.bat
			rm -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_32/compte_sysprep_joindre_domaine.txt
			rm -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_32/compte_sysprep_win7_numero_poste_$nb_bits_os.bat
		fi
		repertoire_sysprep_oscar_installe=sysprep_W7_8_32
	elif [ "$nb_bits_os" = 64 ]
	then
		if ! ( test -e /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_64 )
		then
			mkdir /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_64
		fi
		if [ "$sp_deploiement_oscar_linux" != oui ]
		then
			cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_W7_8_64.lnk /mnt/$ip_serveur_scribe-admin/perso/
		fi
		cp -fr /tmp/tmp_sysprep_oscar/oscar_sysprep/* /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_64/
		rm -f /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_64/compte_sysprep_joindre_domaine.txt
		rm -f /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_64/compte_sysprep_win7_numero_poste_$nb_bits_os.bat
		if ( test -e /mnt/$ip_serveur_scribe-sysprep/perso )
		then
			if ! ( test -e /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_64 )
			then
				mkdir /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_64
			fi
			if [ "$sp_deploiement_oscar_linux" != oui ]
			then
				cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/sysprep_W7_8_64.lnk /mnt/$ip_serveur_scribe-sysprep/perso/
			fi
			cp -fr /tmp/tmp_sysprep_oscar/oscar_sysprep/* /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_64/
			cp -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_64/compte_sysprep_joindre_domaine.txt /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_64/joindre_domaine.txt
			cp -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_64/compte_sysprep_joindre_domaine.txt /mnt/$ip_serveur_scribe-admin/perso/sysprep_oscar_w7_64/joindre_domaine.txt
			cp -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_64/compte_sysprep_win7_numero_poste_$nb_bits_os.bat /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_64/sysprep_win7_numero_poste_$nb_bits_os.bat
			rm -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_64/compte_sysprep_joindre_domaine.txt
			rm -f /mnt/$ip_serveur_scribe-sysprep/perso/sysprep_oscar_w7_64/compte_sysprep_win7_numero_poste_$nb_bits_os.bat
		fi
		repertoire_sysprep_oscar_installe=sysprep_W7_8_64
	fi
else # oscar deploie sans sysprep
	if ! ( test -e /mnt/$ip_serveur_scribe-admin/perso/oscar_deploie )
	then
		mkdir -p /mnt/$ip_serveur_scribe-admin/perso/oscar_deploie
	fi
	if [ "$sp_deploiement_oscar_linux" != oui ]
	then
		cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/OSCAR_deploie.lnk /mnt/$ip_serveur_scribe-admin/perso/
	fi
	cp -fr /tmp/tmp_sysprep_oscar/oscar_sysprep/* /mnt/$ip_serveur_scribe-admin/perso/oscar_deploie/
	rm -f /mnt/$ip_serveur_scribe-admin/perso/oscar_deploie/compte_sysprep_joindre_domaine.txt
	rm -f /mnt/$ip_serveur_scribe-admin/perso/oscar_deploie/compte_oscar_deploie_numero_poste.bat
	if [ "$groupe_de_travail" = oui ]
	then
		rm -f /mnt/$ip_serveur_scribe-admin/perso/oscar_deploie/oscar_samba_domaine.reg
		rm -f /mnt/$ip_serveur_scribe-admin/perso/oscar_deploie/joindre_domaine.txt
	fi
	if ( test -e /mnt/$ip_serveur_scribe-sysprep/perso )
	then
		if ! ( test -e /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie )
		then
			mkdir /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie
		fi
		if [ "$sp_deploiement_oscar_linux" != oui ]
		then
			cp -f /tmp/tmp_sysprep_oscar/oscar_sysprep/OSCAR_deploie.lnk /mnt/$ip_serveur_scribe-sysprep/perso/
		fi
		cp -fr /tmp/tmp_sysprep_oscar/oscar_sysprep/* /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie/
		cp -f /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie/compte_sysprep_joindre_domaine.txt /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie/joindre_domaine.txt
		cp -f /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie/compte_sysprep_joindre_domaine.txt /mnt/$ip_serveur_scribe-admin/perso/oscar_deploie/joindre_domaine.txt
		cp -f /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie/compte_oscar_deploie_numero_poste.bat /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie/oscar_deploie_numero_poste.bat
		rm -f /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie/compte_sysprep_joindre_domaine.txt
		rm -f /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie/compte_oscar_deploie_numero_poste.bat
		if [ "$groupe_de_travail" = oui ]
		then
			rm -f /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie/oscar_samba_domaine.reg
			rm -f /mnt/$ip_serveur_scribe-sysprep/perso/oscar_deploie/joindre_domaine.txt
			rm -f /mnt/$ip_serveur_scribe-admin/perso/oscar_deploie/joindre_domaine.txt
		fi
	fi
	repertoire_sysprep_oscar_installe=oscar_deploie
fi
umount /mnt/$ip_serveur_scribe-admin 2>/dev/null 1>/dev/null ; sync
echo "/mnt/$ip_serveur_scribe-admin : demontage smb" >> /tmp/historique
umount /mnt/$ip_serveur_scribe-sysprep 2>/dev/null 1>/dev/null ; sync
echo "/mnt/$ip_serveur_scribe-sysprep : demontage smb" >> /tmp/historique
rm -fr /tmp/tmp_sysprep_oscar
# ancien_smbclient_W7

echo
echo -e "\033[1;34m Le répertoire \033[1;32m/admin/perso/$repertoire_sysprep_oscar_installe\033[1;34m est à jour dans \033[1;32m$domaine_scribe\033[1;34m ...\033[1;m"
if [ "$pas_repertoire_sysprep" = non ]
then
	echo -e "\033[1;34m Le répertoire \033[1;32m/sysprep/perso/$repertoire_sysprep_oscar_installe\033[1;34m est à jour dans \033[1;32m$domaine_scribe\033[1;34m ...\033[1;m"
fi
}
#----------------------------------------------------------------------------------------------------
main()
{
rm -f /tmp/sortir
rm -f /tmp/tempfile # des menus precedents sauf celui-ci tempfile______
rm -f /tmp/tempfile___
rm -f /tmp/tempfile____
rm -f /tmp/tempfile_____
rm -f /tmp/tempfile_______

type_copie=
sp_info_copies=
calendrier=$(date +%d/%m/%y)
heure=$(date +%kh%Mmin)
rm -f /tmp/rien
echo "\Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  " > /tmp/rien
output=exit
dialog  --no-cancel --colors --no-shadow \
	--backtitle "`cat /etc/banniere_oscar`" --title " Menu SCRIBE " \
	--menu  "\n  \Zb\Z3 `cat $chemin_langue/texte_19` : `cat ip_installe_poste``cat /tmp/rien`  le $calendrier à $heure\n " 11 111 0  \
	" " "" \
	"administration" "Administre le serveur \Z2scribe $ip_serveur_scribe:$port_ip_serveur_scribe\Zn." \
	"console" "Accède à la console du serveur \Z2scribe $ip_serveur_scribe\Zn." \
	"filtre_internet" "Edite le fichier des filtres\Z2 amon2 $ip_amon2:$port_ip_amon2\Zn." \
	" " "" \
	"fin_connexion" "Supprime la connexion au serveur \Z2scribe $ip_serveur_scribe\Zn." \
	" " "" \
	"info_copies" "\Z1Affiche \Znles copies des sauvegardes \Zb\Z3OSCAR\Zn du serveur\Zn." \
	"copie_oscar" "\Z1Copie\Zn la sauvegarde \Zb\Z3OSCAR\Zn vers le serveur \Z2scribe\Zn." \
	"recup_oscar" "\Z1Récupère\Zn la sauvegarde \Zb\Z3OSCAR\Zn depuis le serveur \Z2scribe\Zn." \
	"renomme_copie" "\Z1Renomme\Zn la copie \Zb\Z3OSCAR\Zn du serveur \Z2scribe\Zn." \
	"supprime_copie" "\Z1Supprime\Zn une sauvegarde \Zb\Z3OSCAR\Zn du serveur scribe\Zn." \
	" " "" \
	"utilisateur" "\Z1Monte\Zn un répertoire \Z2utilisateur\Zn." \
	"liste_fichiers" "Envoie à l'utilisateur la \Z1taille de ses fichiers\Zn." \
	"partitions" "Montre les \Z1partitions\Zn du serveur \Z2scribe $ip_serveur_scribe\Zn." \
	"usb_sauvegarde" "Montre le contenu du \Z2disque USB\Zn de sauvegarde des données." \
	"domaine" "Installe les fichiers sur le serveur de domaine." \
	"installe_wpkg" "Installe \Z2wpkg\Zn sur le serveur \Z2scribe $ip_serveur_scribe\Zn." \
	"configure" "Configure les \Z1adresses des serveurs\Zn." \
	" " "" \
        "halt" "\Z1Eteindre\Zn l'ordinateur." \
	"oscar" "Revenir au \Z1menu principal\Zn. " \
	" " "" 2>/tmp/tempscribe
	
if [ $? = "255" ]
then
	rm -f /tmp/tempscribe
	rm -f /tmp/rien
	fin_ssh
	exit
fi
output=`cat /tmp/tempscribe`
rm -f /tmp/tempscribe
rm -f /tmp/rien

if [ "$output" = " " ]
then
	main
elif [ "$output" = "" ]
then
	main
elif [ $output = "configure" ]
then
	menu_scribe_config
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	else
		recupere_adresses_ip
		controle_ip_serveur_scribe_existe
	fi
	main
elif [ $output = "fin_connexion" ]
then
	fin_ssh
	exit
elif [ $output = "console" ]
then
	#	runme lancer_dhcp 2>/dev/null 1>/dev/null
	#	echo
	#	echo -e "\033[1;34m Après \033[0;37myes\033[1;34m entrez le mot de passe du \033[0;32mroot\033[1;34m :\033[1;m"
	#	echo
	debut_ssh
	ssh $ip_serveur_scribe
	boucle
elif [ $output = "info_copies" ]
then
	sp_info_copies=oui
	debut_ssh
	cherche_partition_copies_oscar_scribe
	if [ "$copies_oscar_trouve" != "0" ]
	then
		if [ "$liste_repertoire_copies_oscar_scribe" = "" ]
		then
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "\n\Zb\Z4Le répertoire \Z3copies_oscar_scribe \Z4est vide ... \Zn" 7 60
			case $? in
				0) ;;
				255) ;;
			esac
		else
			valeur1=`awk '{print$2}' /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar`
			valeur2=`awk '{print$3}' /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar`
			valeur3=`awk '{print$5}' /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar`
			rm -f /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar
			valeur1=$[valeur1/1000]
			valeur2=$[valeur2/1000]
			valeur2=$[valeur1-valeur2]
			
			echo " " > /tmp/ligne_copies_oscar_scribe
			echo "Copies dans '/copies_oscar_scribe', partition utilisée à $valeur3 : " >> /tmp/ligne_copies_oscar_scribe
			echo " " >> /tmp/ligne_copies_oscar_scribe
			echo "$valeur2 Mo `cat $chemin_langue/repertoire_3` $valeur1 Mo " >> /tmp/ligne_copies_oscar_scribe
			cut -d" " -f5-15 /tmp/liste_copies_oscar_scribe  >> /tmp/ligne_copies_oscar_scribe
			rm -f /tmp/liste_copies_oscar_scribe
			
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors --no-shadow \
			--backtitle "`cat /etc/banniere_oscar`" \
			--exit-label "`cat $chemin_langue/Continuer`" \
			--title " Sauvegardes copiées sur scribe " \
			--textbox "/tmp/ligne_copies_oscar_scribe" 0 0
		        case $? in
				0)	;;
				3)  ;;
				255) ;;
			esac 
			rm -f /tmp/ligne_copies_oscar_scribe
		fi
	fi
	fin_ssh_copie_recup
elif [ $output = "copie_oscar" ]
then
	debut_ssh
	cherche_partition_copies_oscar_scribe
	if [ "$copies_oscar_trouve" != "0" ]
	then
		boites_choix_controle_copie
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
		else
			if [ "$liste_repertoire_copies_oscar_scribe" = "" ]
			then
				demander_le_nom_de_la_copie
				copier_la_sauvegarde_sur_scribe
			else
				echo " Copies sauvegardées sur scribe " > /tmp/menu_titre
				echo "\n\Zb\Z3Choix de copie : \n" > /tmp/menu_texte
				# proposer_les_sauvegardes
				choix_copie_sauvegarde
				if ( test -e /tmp/sortir )
				then
					rm -f /tmp/tempfile
					rm -f /tmp/sortir
				fi
			fi
		fi
	fi
	fin_ssh_copie_recup
elif [ $output = "recup_oscar" ]
then
	debut_ssh
	cherche_partition_copies_oscar_scribe
	if [ "$copies_oscar_trouve" != "0" ]
	then
		if [ "$liste_repertoire_copies_oscar_scribe" = "" ]
		then
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "\n\Zb\Z4Le répertoire \Z3copies_oscar_scribe \Z4est vide ... " 7 60
			case $? in
				0) ;;
				255) ;;
			esac
		else
			boites_choix_controle_copie
			if ( test -e /tmp/sortir )
			then
				rm -f /tmp/sortir
			else
				echo " Copies sauvegardées sur scribe " > /tmp/menu_titre
				echo "\n\Zb\Z3Choix des copies.\n" > /tmp/menu_texte
				echo "\Zb\Z4Sélectionnez la copie à récupérer : " > /tmp/fichierquestion
				proposer_les_sauvegardes
				if ( test -e /tmp/sortir )
				then
					rm -f /tmp/tempfile
					rm -f /tmp/sortir
				else
					cp -f /tmp/tempfile /tmp/nom_copie_oscar
					rm -f /tmp/tempfile
					nom_copie_oscar=`cat /tmp/nom_copie_oscar`
					scp /tmp/nom_copie_oscar $ip_serveur_scribe:/tmp/nom_copie_oscar 1>/dev/null
					recuperer_la_sauvegarde_depuis_scribe
				fi
			fi
		fi
	fi
	fin_ssh_copie_recup
elif [ $output = "renomme_copie" ]
then
	debut_ssh
	cherche_partition_copies_oscar_scribe
	if [ "$copies_oscar_trouve" != "0" ]
	then
		if [ "$liste_repertoire_copies_oscar_scribe" = "" ]
		then
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "\n\Zb\Z4Le répertoire \Z3copies_oscar_scribe \Z4est vide ... \Zn" 7 60
			case $? in
				0) ;;
				255) ;;
			esac
		else
			echo " Renommer une copie sauvegardée sur scribe " > /tmp/menu_titre
			echo "\n\Zb\Z3Choix des copies. \n" > /tmp/menu_texte
			echo "\Zb\Z4Sélectionnez la copie à renommer : " > /tmp/fichierquestion
			proposer_les_sauvegardes
			if ( test -e /tmp/sortir )
			then
				rm -f /tmp/tempfile
				rm -f /tmp/sortir
			else
				cp -f /tmp/tempfile /tmp/nom_copie_oscar_a_renommer
				rm -f /tmp/tempfile
				nom_copie_oscar_a_renommer=`cat /tmp/nom_copie_oscar_a_renommer`
				demander_le_nouveau_nom_de_la_copie
				scp /tmp/nom_copie_oscar_a_renommer $ip_serveur_scribe:/tmp/nom_copie_oscar_a_renommer 1>/dev/null
				rm -f /tmp/nom_copie_oscar_a_renommer
				renommer_la_sauvegarde_sur_scribe
				scp $ip_serveur_scribe:/tmp/erreur_renomme_oscar /tmp/erreur_renomme_oscar 1>/dev/null
				erreur_renomme_oscar=`cat /tmp/erreur_renomme_oscar`
				rm -f /tmp/erreur_renomme_oscar
				if [ "$erreur_renomme_oscar" = "erreur" ]
				then
					DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
					--backtitle "`cat /etc/banniere_oscar`" \
					--title " `cat $chemin_langue/DESOLE` " \
					--ok-label "`cat $chemin_langue/Continuer`"  \
					--msgbox "\n\Zb\Z4Le répertoire \Z3$nom_copie_oscar\Z4 existe déjà ... \Zn" 7 55
					case $? in
						0) ;;
						255) ;;
					esac
				fi
			fi
		fi
	fi
	fin_ssh_copie_recup
elif [ $output = "supprime_copie" ]
then
	debut_ssh
	cherche_partition_copies_oscar_scribe
	if [ "$copies_oscar_trouve" != "0" ]
	then
		if [ "$liste_repertoire_copies_oscar_scribe" = "" ]
		then
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "\n\Zb\Z4Le répertoire \Z3copies_oscar_scribe \Z4est vide ... \Zn" 7 60
			case $? in
				0) ;;
				255) ;;
			esac
		else
			echo " Supprimer une copie sauvegardée sur scribe " > /tmp/menu_titre
			echo "\n\Zb\Z3Choix des copies. \n" > /tmp/menu_texte
			echo "\Zb\Z4Sélectionnez la copie à supprimer : " > /tmp/fichierquestion
			proposer_les_sauvegardes
			if ( test -e /tmp/sortir )
			then
				rm -f /tmp/tempfile
				rm -f /tmp/sortir
			else
				cp -f /tmp/tempfile /tmp/nom_copie_oscar
				rm -f /tmp/tempfile
				nom_copie_oscar=`cat /tmp/nom_copie_oscar`
				scp /tmp/nom_copie_oscar $ip_serveur_scribe:/tmp/nom_copie_oscar 1>/dev/null
				supprimer_la_sauvegarde_sur_scribe
			fi
		fi
	fi
	fin_ssh_copie_recup
elif [ $output = "installe_wpkg" ]
then
	boite_demande_32bits_ou_64bits
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/tempfile
		rm -f /tmp/sortir
		main
		return
	else
		installer_wpkg
	fi
elif [ $output = "utilisateur" ]
then
	connexion_utilisateur_serveur_scribe
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	fi
	main
elif [ $output = "liste_fichiers" ]
then
	debut_ssh
	echo "Donnez le login à lister" > /tmp/texte_login_scribe
	demander_l_utilisateur	# puis le suivant
	rm -f /tmp/texte_login_scribe
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	fi
	ssh $ip_serveur_scribe	'
		rm -f /tmp/temp_repertoire_utilisateur_scribe
		rm -f /tmp/temp_premiere_lettre_repertoire_utilisateur_scribe
		umount /mnt/usb_sauvegarde 2>/dev/null ; sync
		'
	# fin_ssh
	rm -f /tmp/listing_utilisateur_scribe_affiche
	rm -f /tmp/listing_utilisateur_scribe_envoye_titre
	main
elif [ $output = "domaine" ]
then
	# rechercher la cle USB avec le repertoire sysprep_oscar
	sysprep_oscar_scribe	# dans le fichier /tmp/tmp_sysprep_oscar/sysprep
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		main
	else
		faire_fichiers_pour_deployer
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
			main
		fi
		echo
		boucle
	fi
elif [ $output = "usb_sauvegarde" ]
then
	boite_usb_sauvegarde
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	else
		debut_ssh
		echo "$dev_usb_sauvegarde,`cat ip_installe_poste`" > /tmp/dev_usb_sauvegarde_ip_oscar
		scp /tmp/dev_usb_sauvegarde_ip_oscar $ip_serveur_scribe:/tmp/dev_usb_sauvegarde_ip_oscar 1>/dev/null
		rm -f /tmp/dev_usb_sauvegarde_ip_oscar
		ssh $ip_serveur_scribe	'
			if ! ( test -e /mnt/usb_sauvegarde )
			then
				mkdir /mnt/usb_sauvegarde
			fi
			cut -d"," -f1 /tmp/dev_usb_sauvegarde_ip_oscar > /tmp/dev_usb_sauvegarde
			cut -d"," -f2 /tmp/dev_usb_sauvegarde_ip_oscar > /tmp/ip_client_oscar
			rm -f /tmp/dev_usb_sauvegarde_ip_oscar
			repertoire=`cat /tmp/dev_usb_sauvegarde`
			rm -f /tmp/dev_usb_sauvegarde
			mount /dev/$repertoire /mnt/usb_sauvegarde
			
			ls -ohtp /mnt/usb_sauvegarde > /tmp/liste_usb_sauvegarde
			echo "`df /mnt/usb_sauvegarde | grep "usb_sauvegarde"`" > /tmp/toutes_les_valeurs_repertoire
			grep -i "dev" /tmp/toutes_les_valeurs_repertoire > /tmp/ligne_toutes_les_valeurs_repertoire_sauvegarde
			rm -f /tmp/toutes_les_valeurs_repertoire
			'
		scp $ip_serveur_scribe:/tmp/ligne_toutes_les_valeurs_repertoire_sauvegarde /tmp/ligne_toutes_les_valeurs_repertoire_sauvegarde 1>/dev/null
		scp $ip_serveur_scribe:/tmp/liste_usb_sauvegarde /tmp/liste_usb_sauvegarde 1>/dev/null
		ssh $ip_serveur_scribe	'
			rm -f /tmp/liste_usb_sauvegarde
			rm -f /tmp/ligne_toutes_les_valeurs_repertoire_sauvegarde
			umount /mnt/usb_sauvegarde 2>/dev/null ; sync
			'
		# fin_ssh
		
		valeur1=`awk '{print$2}' /tmp/ligne_toutes_les_valeurs_repertoire_sauvegarde`
		valeur2=`awk '{print$3}' /tmp/ligne_toutes_les_valeurs_repertoire_sauvegarde`
		valeur3=`awk '{print$5}' /tmp/ligne_toutes_les_valeurs_repertoire_sauvegarde`
		rm -f /tmp/ligne_toutes_les_valeurs_repertoire_sauvegarde
		valeur1=$[valeur1/1000]
		valeur2=$[valeur2/1000]
		valeur2=$[valeur1-valeur2]
	
		echo "Contenu du disque USB sur $dev_usb_sauvegarde, utilisé à $valeur3 : " > /tmp/ligne_usb_sauvegarde
		echo " " >> /tmp/ligne_usb_sauvegarde
		echo "$valeur2 Mo `cat $chemin_langue/repertoire_3` $valeur1 Mo " >> /tmp/ligne_usb_sauvegarde
		echo " " >> /tmp/ligne_usb_sauvegarde
		echo " " > /tmp/affichage_liste_usb_sauvegarde
		cat /tmp/ligne_usb_sauvegarde >> /tmp/affichage_liste_usb_sauvegarde
		cat /tmp/liste_usb_sauvegarde >> /tmp/affichage_liste_usb_sauvegarde
		rm -f /tmp/ligne_usb_sauvegarde
		rm -f /tmp/liste_usb_sauvegarde
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors --no-shadow \
		--backtitle "`cat /etc/banniere_oscar`" \
		--exit-label "`cat $chemin_langue/Continuer`" \
		--title " Fichiers sauvegardés sur le disque USB $dev_usb_sauvegarde " \
		--textbox "/tmp/affichage_liste_usb_sauvegarde" 0 0
	        case $? in
			0)	;;
			3)  ;;
			255) ;;
		esac 
		rm -f /tmp/affichage_liste_usb_sauvegarde
	fi
	main
elif [ $output = "administration" ]
then
	runme lancer_dhcp 2>/dev/null 1>/dev/null
	$navigateur_web https://$ip_serveur_scribe:$port_ip_serveur_scribe &
	echo
	echo -e " \033[1;32m`cat $chemin_langue/Procedure` : Navigateur web ...\033[1;34m"
	echo
	for passe in . . . .
	do
		sleep 2
		echo -en "\033[1;31m $passe\033[1;m"
	done
	main
elif [ $output = "filtre_internet" ]
then
	if ! ( test -e /etc/oscar_scribe/filtre_internet_lance )
	then
		controle_ip_fixe_filtre_deja_sur_reseau
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
			main
			return
		fi
	fi
	# runme lancer_dhcp 2>/dev/null 1>/dev/null
	carte_ethi=`cat /tmp/carte_ethi`
	ifconfig $carte_ethi $ip_client_fixe_pour_amon2 netmask $masque_ip_client_fixe_pour_amon2
	echo "$ip_client_fixe_pour_amon2" > ip_installe_poste
	sleep 2
	$navigateur_web https://$ip_amon2:$port_ip_amon2 &
	echo
	echo -e " \033[1;32m`cat $chemin_langue/Procedure` : Navigateur web ...\033[1;34m"
	echo
	for passe in . . . .
	do
		sleep 2
		echo -en "\033[1;31m $passe\033[1;m"
	done
	if ( test -e /etc/oscar_scribe/filtre_internet_lance )
	then
		echo
		echo
		echo -e "\033[1;31m L'accès au serveur est seulement possible au prochain démarrage du poste ...\033[1;m"
		fin_SP=boucle
	else
		echo "" > /etc/oscar_scribe/filtre_internet_lance
		fin_SP=main
	fi
	$fin_SP
elif [ $output = "partitions" ]
then
	runme lancer_dhcp 2>/dev/null 1>/dev/null
	ssh root@$ip_serveur_scribe fdisk -l 2>/dev/null
	boucle
elif [ "$output" = "halt" ]
then
	fin_ssh
        eteindre_le_poste
elif [ $output = "oscar" ]
then
	fin_ssh
	exit
else
	$output
fi
boucle
}
#----------------------------------------------------------------------------------------------------
recupere_adresses_ip()
{
ip_client_fixe_pour_amon2=`cat /etc/oscar_scribe/ip_client_fixe_pour_amon2`
masque_ip_client_fixe_pour_amon2=`cat /etc/oscar_scribe/masque_ip_client_fixe_pour_amon2`

# ifconfig $carte_ethi $ip_client_fixe_pour_amon2 netmask $masque_ip_client_fixe_pour_amon2

cut -d":" -f1 /etc/oscar_scribe/ip_serveur_scribe > /tmp/defaut_ip_serveur_scribe
cut -d":" -f2 /etc/oscar_scribe/ip_serveur_scribe > /tmp/defaut_port_ip_serveur_scribe
ip_serveur_scribe=`cat /tmp/defaut_ip_serveur_scribe`
port_ip_serveur_scribe=`cat /tmp/defaut_port_ip_serveur_scribe`
rm -f /tmp/defaut_ip_serveur_scribe
rm -f /tmp/defaut_port_ip_serveur_scribe

cut -d":" -f1 /etc/oscar_scribe/ip_amon2 > /tmp/defaut_ip_amon2
cut -d":" -f2 /etc/oscar_scribe/ip_amon2 > /tmp/defaut_port_ip_amon2
ip_amon2=`cat /tmp/defaut_ip_amon2`
port_ip_amon2=`cat /tmp/defaut_port_ip_amon2`
rm -f /tmp/defaut_ip_amon2
rm -f /tmp/defaut_port_ip_amon2

cut -d":" -f1 /etc/oscar_scribe/ip_proxy > /tmp/defaut_ip_proxy
ip_proxy=`cat /tmp/defaut_ip_proxy`
port_ip_proxy=non
if ! [ "$ip_proxy" = non ]
then
	cut -d":" -f2 /etc/oscar_scribe/ip_proxy > /tmp/defaut_port_ip_proxy
	port_ip_proxy=`cat /tmp/defaut_port_ip_proxy`
fi
rm -f /tmp/defaut_ip_proxy
rm -f /tmp/defaut_port_ip_proxy
}
#----------------------------------------------------------------------------------------------------
PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

#  commandes externes de procédures
case "$1" in
	faire_fichiers_pour_deployer)
		sp_deploiement_oscar_linux=oui
		ip_serveur_scribe=`cat /tmp/defaut_ip_serveur_scribe`
		rm -f /tmp/defaut_ip_serveur_scribe
		faire_fichiers_pour_deployer
		exit 0
	;;
	connexion_utilisateur_serveur_scribe)
		sp_deploiement_oscar_linux=oui
		ip_serveur_scribe=`cat /tmp/defaut_ip_serveur_scribe`
		rm -f /tmp/defaut_ip_serveur_scribe
		connexion_utilisateur_serveur_scribe
		exit 0
	;;
esac

if ! ( test -e /etc/oscar_scribe/ip_oscar_scribe_defaut ) || ! ( test -e /etc/oscar_scribe/ip_client_fixe_pour_amon2 )
then
	menu_scribe_config
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		exit
	fi
fi

recupere_adresses_ip
sp_deploiement_oscar_linux=
controle_ip_serveur_scribe_existe
main
