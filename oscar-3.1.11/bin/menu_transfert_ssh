#!/bin/bash

## Copyright (c) 2003-2013 Tissoires Jean-Fran√ßois & Benjamin,  jftissoires@gmail.com
## Outil Syst√®me Complet d'Assistance R√©seau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et Syst√®mes: RapideSOS
## Ce programme est sous Licence Publique G√©n√©rale GNU publi√©e par la Free Software Foundation.

#   programme de transfert de sauvegarde vers un serveur ssh linux





#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boites_choix_controle_copie()    # copie avec v√©rification ou non
{
	# Contr√¥le de la copie de sauvegarde
	oui_ou_non_eteindre=`cat $chemin_langue/menu_266a`	# eteindre a la fin
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/menu_263`" --cancel-label "`cat $chemin_langue/Annuler`" --title " `cat $chemin_langue/menu_262a` " \
	--extra-button --extra-label "`cat $chemin_langue/Controlee`" \
	--menu "\Zb\Z3 `cat $chemin_langue/menu_278` : " 0 0 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_264c`" \
	"" "`cat $chemin_langue/menu_265a`." \
	"" "" \
	"" "" \
	"" "" \
	"" "\Z1`cat $chemin_langue/Remarque` :\Zn " \
	"" "" \
	"" "      `cat $chemin_langue/menu_266d`" \
	"" "      `cat $chemin_langue/menu_267f`" \
	"" ""
       case $? in
	    3)	type_copie=controlee
	    	oui_ou_non_eteindre=`cat $chemin_langue/menu_267a` # Le poste ne s'√©teint pas
		;;
	    0)  # Le poste s'√©teint √† la fin
	    	type_copie=non_controlee
	    	;;
	    1)	echo "" > /tmp/sortir
		return
		;;
	    255) echo "" > /tmp/sortir
		return
		;;
	esac 
}
#----------------------------------------------------------------------------------------------------
eteindre_le_poste()
{
runme boite_eteindre_le_poste
if ( test -e /tmp/annuler_eteindre )
then
	rm -f /tmp/annuler_eteindre
	main
	return
fi

runme boite_eteindre_ordinateur
}
#----------------------------------------------------------------------------------------------------
boucle()  # retour au programme principal
{
echo
echo
echo -e "`cat $chemin_langue/boucle_1`"
echo -ne "`cat $chemin_langue/boucle_2`"
read reponse
main
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
fin_ssh()
{
ssh $ip_serveur_ssh	'
	grep -v "OSCAR" /root/.ssh/authorized_keys > /root/.ssh/authorized_keys1
	cp -f /root/.ssh/authorized_keys1 /root/.ssh/authorized_keys
	rm -f /root/.ssh/authorized_keys1
	exit
	'
rm -f /root/.ssh/id_dsa
rm -f /root/.ssh/id_dsa.pub
rm -f /etc/console_transfert_ssh_lance
}
#----------------------------------------------------------------------------------------------------
debut_ssh()
{
if ( test -e /etc/console_transfert_ssh_lance )
then
	if [ "$output" != console ]
	then
		return
	fi
fi

runme lancer_dhcp 2>/dev/null 1>/dev/null
rm -f /root/.ssh/id_dsa
ssh-keygen -t dsa -b 1024 -N '' -f /root/.ssh/id_dsa 1>/dev/null
echo
echo -e "\033[1;34m `cat $chemin_langue/menu_10j`\033[1;34m :\033[1;m"
echo
ssh-copy-id -i /root/.ssh/id_dsa.pub $ip_serveur_ssh 1>/dev/null
if [ $? = 0 ]
then
	echo "" > /etc/console_transfert_ssh_lance
fi
}
#----------------------------------------------------------------------------------------------------
controle_ip_serveur_ssh_existe()
{
echo
echo
echo -e "\033[1;33m OSCAR \033[1;34mcherche le serveur ssh \033[0;32m$ip_serveur_ssh\033[1;34m ...\033[1;m"
echo
ping -w 8 $ip_serveur_ssh 2>/dev/null 1>/dev/null
test_ping_serveur_pxe=$?
if ! [ "$test_ping_serveur_pxe" = "0" ]
then
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--ok-label "`cat $chemin_langue/Continuer`"  --extra-button --extra-label "`cat $chemin_langue/Forcer`"  \
	--msgbox "\n\Zb\Z1`cat $chemin_langue/menu_10c` : $ip_serveur_ssh \Zn" 7 65
	case $? in
		0) ;;
		3) return ;;
		255) return ;;
	esac
	configurer_ip_serveur_ssh
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	else
		recupere_adresses_ip
		controle_ip_serveur_ssh_existe
	fi
fi
}
#----------------------------------------------------------------------------------------------------
boite_demande_oscar_ssh()
{
awk 'BEGIN { FS=":" } { printf ("%0s\n","\""$1"\" \"\" \\")}' /tmp/repertoire_copies_oscar_ssh > /tmp/bozo

# boite : Choix de la copie oscar pour ssh

echo "10" > /tmp/hauteur
echo "50" > /tmp/largeur
echo "0" > /tmp/position
runme boite_selection_bozo
rm -f /tmp/hauteur
rm -f /tmp/largeur
rm -f /tmp/position
rm -f /tmp/texte
}
#----------------------------------------------------------------------------------------------------
faire_exec_dialog_oscar_ssh()	# sort le choix : ecraser la selection ou nouvelle copie dans reponse et /tmp/tempfile
{
cat /tmp/bozo >> /tmp/exec_dialog
rm -f /tmp/bozo
rm -f /tmp/tempfile
echo '2>/tmp/tempfile
toutou=$?
if [ $toutou = 255 ]
then
	rm -f /tmp/tempfile
	echo "" > /tmp/sortir
	exit
elif [ $toutou = 0 ] # ok
then
	echo "nouvelle" > /tmp/reponse
	exit
elif [ $toutou = 1 ]
then
	rm -f /tmp/tempfile
	echo "" > /tmp/sortir
	exit
elif [ $toutou = 3 ] # selection
then
	echo "selection" > /tmp/reponse
	exit
fi
' >> /tmp/exec_dialog
chmod +x /tmp/exec_dialog
/tmp/exec_dialog
if ( test -e /tmp/sortir )
then
	return
fi 
reponse=`cat /tmp/tempfile`
}
#----------------------------------------------------------------------------------------------------
choix_copie_sauvegarde() # choisit une copie eventuelle a ecraser
{
# Choix possibles

echo "\n\Zb\Z4`cat $chemin_langue/menu_10k`\Z4. \
\n\Zb\Z4`cat $chemin_langue/menu_10l`.\n\Zb\Z4`cat $chemin_langue/menu_10m` :\n " > /tmp/fichierquestion

cp /usr/share/oscar/usr/exec_dialog_src /tmp/exec_dialog -f
perl -pi -e 's/--cancel-label \"\`cat \$chemin_langue\/Annuler\`\"/--cancel-label \"\`cat \$chemin_langue\/Annuler\`\"  --ok-label \" \`cat \$chemin_langue\/Nouvelle\` ... \"  --extra-button --extra-label \" \`cat \$chemin_langue\/Ecraser\` \"/g;' /tmp/exec_dialog

awk 'BEGIN { FS=":" } { printf ("%0s\n","\""$1"\" \"\" \\")}' /tmp/repertoire_copies_oscar_ssh > /tmp/bozo

faire_exec_dialog_oscar_ssh
if ( test -e /tmp/sortir )
then
	rm -f /tmp/menu_titre
	rm -f /tmp/menu_texte
	rm -f /tmp/fichierquestion
        return
fi
perl -pi -e 's/ //g;' /tmp/reponse
perl -pi -e 's/ //g;' /tmp/tempfile
variable=`cat /tmp/reponse`
rm -f /tmp/reponse

if [ "$variable" = "nouvelle" ]
then
	demander_le_nom_de_la_copie
	copier_la_sauvegarde_sur_ssh
elif [ "$variable" = "selection" ]
then
	cp -f /tmp/tempfile /tmp/nom_copie_oscar
	rm -f /tmp/tempfile
	nom_copie_oscar=`cat /tmp/nom_copie_oscar`
	scp /tmp/nom_copie_oscar $ip_serveur_ssh:/tmp/nom_copie_oscar 1>/dev/null
	copier_la_sauvegarde_sur_ssh
fi
rm -f /tmp/tempfile
rm -f /tmp/menu_titre
rm -f /tmp/menu_texte
rm -f /tmp/fichierquestion
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boite_info_patience_copie_recup()
{
# Patience
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/menu_10n` " \
	--infobox "`cat $chemin_langue/infobox_22`\n \
	\n\Z1            --- $oui_ou_non_eteindre ---\Z1\n" 15 60
}
#----------------------------------------------------------------------------------------------------
cherche_partition_copies_oscar_ssh()
{
echo "$sp_info_copies" > /tmp/sp_info_copies
scp /tmp/sp_info_copies $ip_serveur_ssh:/tmp/sp_info_copies 1>/dev/null
rm -f /tmp/sp_info_copies
ssh $ip_serveur_ssh	'
	echo "non" > /tmp/repertoire_copies_existe_ssh
	sp_info_copies=`cat /tmp/sp_info_copies`
	rm -f /tmp/sp_info_copies
	valeur_sdai_copies_oscar=0
	for valeurA in a b c d e f g
	do
		if [ "$valeur_sdai_copies_oscar" = 0 ]
		then
			for valeuri in 1 2 3 4 5 6 7 8 9 10
			do
				if [ "$valeur_sdai_copies_oscar" = 0 ]
				then
					if ( test -e /dev/sd$valeurA$valeuri )
					then
						id_type_ssh=`sfdisk /dev/sd$valeurA -c $valeuri 2>/dev/null`
						if [ "$id_type_ssh" = "83" ] # partition linux non swap
						then
							if ! ( test -e /mnt/usb_oscar_ssh )
							then
								mkdir /mnt/usb_oscar_ssh
							fi
							mount /dev/sd$valeurA$valeuri /mnt/usb_oscar_ssh 1>/dev/null 2>/dev/null
							if ( test -e /mnt/usb_oscar_ssh/copies_oscar_ssh )
							then
								echo "sd$valeurA$valeuri" > /tmp/repertoire_copies_existe_ssh
							fi
							if [ -d /mnt/usb_oscar_ssh/copies_oscar_ssh ]
							then
								valeur_sdai_copies_oscar=usb_oscar_ssh
								echo "usb_oscar_ssh" > /tmp/partition_montee_copie_oscar_ssh
								ls /mnt/usb_oscar_ssh/copies_oscar_ssh > /tmp/repertoire_copies_oscar_ssh
								
								if [ "$sp_info_copies" = "oui" ]
								then
									ls -oht /mnt/usb_oscar_ssh/copies_oscar_ssh > /tmp/liste_copies_oscar_ssh
									echo "`df /mnt/usb_oscar_ssh/copies_oscar_ssh | grep "usb_oscar_ssh"`" > /tmp/toutes_les_valeurs_repertoire_copies_oscar
									grep -i "dev" /tmp/toutes_les_valeurs_repertoire_copies_oscar > /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar
									rm -f /tmp/toutes_les_valeurs_repertoire_copies_oscar
								fi
							else
								umount /mnt/usb_oscar_ssh 1>/dev/null 2>/dev/null ; sync
							fi
						fi
					fi
				fi
			done
		fi
	done
	echo "$valeur_sdai_copies_oscar" > /tmp/copies_oscar_trouve
	'
scp $ip_serveur_ssh:/tmp/repertoire_copies_existe_ssh /tmp/repertoire_copies_existe_ssh 1>/dev/null
scp $ip_serveur_ssh:/tmp/copies_oscar_trouve /tmp/copies_oscar_trouve 1>/dev/null
repertoire_copies_existe_ssh=`cat /tmp/repertoire_copies_existe_ssh`
rm -f /tmp/repertoire_copies_existe_ssh
copies_oscar_trouve=`cat /tmp/copies_oscar_trouve`

if [ "$repertoire_copies_existe_ssh" != "non" ]
then
	if [ "$sp_info_copies" = "oui" ]
	then
		scp $ip_serveur_ssh:/tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar 1>/dev/null
		scp $ip_serveur_ssh:/tmp/liste_copies_oscar_ssh /tmp/liste_copies_oscar_ssh 1>/dev/null
	fi
	if [ "$copies_oscar_trouve" != "0" ]
	then
		scp $ip_serveur_ssh:/tmp/repertoire_copies_oscar_ssh /tmp/repertoire_copies_oscar_ssh 1>/dev/null
		liste_repertoire_copies_oscar_ssh=`cat /tmp/repertoire_copies_oscar_ssh`
	fi
fi
}
#----------------------------------------------------------------------------------------------------
fin_ssh_copie_recup()
{
ssh $ip_serveur_ssh	'
		if ( test -e /tmp/partition_montee_copie_oscar_ssh )
		then
			umount /mnt/`cat /tmp/partition_montee_copie_oscar_ssh` 1>/dev/null 2>/dev/null ; sync
		fi
		rm -f /tmp/copies_oscar_trouve
		rm -f /tmp/repertoire_copies_oscar_ssh
		rm -f /tmp/nom_copie_oscar
		rm -f /tmp/partition_montee_copie_oscar_ssh
		rm -f /tmp/nom_copie_oscar_a_renommer
		rm -f /tmp/erreur_renomme_oscar
		rm -f /tmp/liste_copies_oscar_ssh
		rm -f /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar
		rm -f /tmp/repertoire_copies_existe_ssh
		'
# fin_ssh

rm -f /tmp/repertoire_copies_oscar_ssh
rm -f /tmp/nom_copie_oscar
if [ "$repertoire_copies_existe_ssh" != "non" ]
then
	if [ "$copies_oscar_trouve" = "0" ]
	then
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/DESOLE` " \
		--ok-label "`cat $chemin_langue/Continuer`"  \
		--msgbox "\n\Zb\Z4`cat $chemin_langue/menu_10o1` ... \Zn \n " 10 65
		case $? in
			0) ;;
			255) ;;
		esac
	else
		if [ "$type_copie" = "non_controlee" ]
		then
			runme boite_eteindre_ordinateur
		elif [ "$type_copie" = "controlee" ]
		then
			echo
			echo -e " \033[1;33m`cat $chemin_langue/texte_46`\033[1;m ..."
			sauve question_test
		fi
	fi
else
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--ok-label "`cat $chemin_langue/Continuer`"  \
	--msgbox "\n\Zb\Z4`cat $chemin_langue/menu_10o` ... \Zn \n \
	\n\Zb\Z4`cat $chemin_langue/menu_10p`.\Zn " 10 65
	case $? in
		0) ;;
		255) ;;
	esac
fi
rm -f /tmp/copies_oscar_trouve
main
}
#----------------------------------------------------------------------------------------------------
supprimer_la_sauvegarde_sur_ssh()
{
ssh $ip_serveur_ssh	'
	nom_copie_oscar=`cat /tmp/nom_copie_oscar`
	rm -fR /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar
	'
}
#----------------------------------------------------------------------------------------------------
renommer_la_sauvegarde_sur_ssh()
{
ssh $ip_serveur_ssh	'
	nom_copie_oscar_a_renommer=`cat /tmp/nom_copie_oscar_a_renommer`
	nom_copie_oscar=`cat /tmp/nom_copie_oscar`
	if ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar )
	then
		echo "erreur" > /tmp/erreur_renomme_oscar
	else
		echo "" > /tmp/erreur_renomme_oscar
		mv /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar_a_renommer /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar
	fi
	'
}

#----------------------------------------------------------------------------------------------------
recuperer_la_sauvegarde_depuis_ssh()
{
recup_sauvegarde recherche_partition_oscar_pour_recuperer
partition_oscar_pour_recuperer=`cat /tmp/partition_oscar_pour_recuperer`
rm -f /tmp/partition_oscar_pour_recuperer
if ( test -e /tmp/nouveau_commentaire )
then
	nouveau_commentaire_txt=`cat /tmp/nouveau_commentaire`
	rm -f /tmp/nouveau_commentaire
fi

boite_info_patience_copie_recup

ssh $ip_serveur_ssh	'
	nom_copie_oscar=`cat /tmp/nom_copie_oscar`
	if ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar/sauvegarde_oscar/commentaire_oscar.txt )
	then
		echo "OK" > /tmp/commentaire_oscar_ssh
	else
		echo "" > /tmp/commentaire_oscar_ssh
	fi
	if ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar/sauvegarde_oscar/version_oscar )
	then
		echo "OK" > /tmp/version_oscar_ssh
	else
		echo "" > /tmp/version_oscar_ssh
	fi
	if ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar/sauvegarde_oscar/liste_postes_sysprep )
	then
		echo "OK" > /tmp/liste_postes_sysprep_oscar_ssh
	else
		echo "" > /tmp/liste_postes_sysprep_oscar_ssh
	fi
	
	if ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar/sauvegarde_oscar/image.partimage.000 )
	then
		echo "image.partimage" > /tmp/image_transferee_oscar_ssh
	elif ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar/sauvegarde_oscar/image.ntfs.00 )
	then
		echo "image.ntfs" > /tmp/image_transferee_oscar_ssh
	elif ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar/sauvegarde_oscar/image_dar.1.dar )
	then
		echo "image_dar" > /tmp/image_transferee_oscar_ssh
	elif ( test -e /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar/sauvegarde_oscar/image_fsa.fsa )
	then
		echo "image_fsa" > /tmp/image_transferee_oscar_ssh
	fi
	'

scp $ip_serveur_ssh:/tmp/commentaire_oscar_ssh /tmp/commentaire_oscar_ssh 1>/dev/null
scp $ip_serveur_ssh:/tmp/version_oscar_ssh /tmp/version_oscar_ssh 1>/dev/null
scp $ip_serveur_ssh:/tmp/liste_postes_sysprep_oscar_ssh /tmp/liste_postes_sysprep_oscar_ssh 1>/dev/null
scp $ip_serveur_ssh:/tmp/image_transferee_oscar_ssh /tmp/image_transferee_oscar_ssh 1>/dev/null

commentaire_oscar_ssh=`cat /tmp/commentaire_oscar_ssh`
rm -f /tmp/commentaire_oscar_ssh
version_oscar_ssh=`cat /tmp/version_oscar_ssh`
rm -f /tmp/version_oscar_ssh
liste_postes_sysprep_oscar_ssh=`cat /tmp/liste_postes_sysprep_oscar_ssh`
rm -f /tmp/liste_postes_sysprep_oscar_ssh
image_transferee_oscar_ssh=`cat /tmp/image_transferee_oscar_ssh`
rm -f /tmp/image_transferee_oscar_ssh


if ! [ "$nouveau_commentaire_txt" = "oui" ]
then
	if [ "$commentaire_oscar_ssh" = "OK" ]
	then
		scp $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/commentaire_oscar.txt $partition_oscar_pour_recuperer/oscar/commentaire_oscar.txt 1>/dev/null
	fi
fi

if [ "$version_oscar_ssh" = "OK" ]
then
	scp $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/version_oscar $partition_oscar_pour_recuperer/oscar 1>/dev/null
fi
if [ "$liste_postes_sysprep_oscar_ssh" = "OK" ]
then
	scp $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/liste_postes_sysprep $partition_oscar_pour_recuperer/oscar 1>/dev/null
fi

scp $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/date_de_sauvegarde $partition_oscar_pour_recuperer/oscar 1>/dev/null
scp $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/partition_sauvegardee $partition_oscar_pour_recuperer/oscar 1>/dev/null
scp $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/taille_partition_* $partition_oscar_pour_recuperer/oscar 1>/dev/null
scp $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/sauvegarde_* $partition_oscar_pour_recuperer/oscar 1>/dev/null

ssh $ip_serveur_ssh	'
	rm -f /tmp/commentaire_oscar_ssh
	rm -f /tmp/version_oscar_ssh
	rm -f /tmp/liste_postes_sysprep_oscar_ssh
	rm -f /tmp/image_transferee_oscar_ssh
	'

scp $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/$image_transferee_oscar_ssh.* $partition_oscar_pour_recuperer/oscar

recup_sauvegarde nettoyer_fin
umount $partition_oscar_pour_recuperer 1>/dev/null 2>/dev/null ; sync
}
#----------------------------------------------------------------------------------------------------
copier_la_sauvegarde_sur_ssh()
{
transfert_sauvegarde recherche_partition_oscar_a_copier
partition_oscar_a_copier=`cat /tmp/partition_oscar_a_copier`
rm -f /tmp/partition_oscar_a_copier

boite_info_patience_copie_recup

ssh $ip_serveur_ssh	'
	nom_copie_oscar=`cat /tmp/nom_copie_oscar`
	rm -fR /mnt/`cat /tmp/copies_oscar_trouve`/$nom_copie_oscar
	mkdir -p /mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/$nom_copie_oscar/sauvegarde_oscar
	'
scp $partition_oscar_a_copier/oscar/date_de_sauvegarde $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
scp $partition_oscar_a_copier/oscar/partition_sauvegardee $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
scp $partition_oscar_a_copier/oscar/taille_partition_* $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null

if ( test -e $partition_oscar_a_copier/oscar/table_partitions.mbr )
then
	scp $partition_oscar_a_copier/oscar/table_partitions.mbr $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/table_partitions.mbr 1>/dev/null
	scp $partition_oscar_a_copier/oscar/table_partitions.sf $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar/table_partitions.sf 1>/dev/null
fi

if ( test -e $partition_oscar_a_copier/oscar/disque_boot )
then
	scp $partition_oscar_a_copier/oscar/disque_boot $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
fi

if ( test -e $partition_oscar_a_copier/oscar/version_oscar )
then	
	scp $partition_oscar_a_copier/oscar/version_oscar $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
fi
if ( test -e $partition_oscar_a_copier/oscar/liste_postes_sysprep )
then	
	scp $partition_oscar_a_copier/oscar/liste_postes_sysprep $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
fi

if ( test -e $partition_oscar_a_copier/oscar/commentaire_oscar.txt )
then
	scp $partition_oscar_a_copier/oscar/commentaire_oscar.txt $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
fi

scp $partition_oscar_a_copier/oscar/sauvegarde_* $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null
scp /usr/share/oscar/usr/recuperer_sauvegarde_oscar.txt $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar 1>/dev/null

if ( test -e $partition_oscar_a_copier/oscar/image.partimage.000 )
then
	image_transferee=image.partimage
elif ( test -e $partition_oscar_a_copier/oscar/image.ntfs.00 )
then
	image_transferee=image.ntfs
elif ( test -e $partition_oscar_a_copier/oscar/image_dar.1.dar )
then
	image_transferee=image_dar
elif ( test -e $partition_oscar_a_copier/oscar/image_fsa.fsa )
then
	image_transferee=image_fsa
fi

scp $partition_oscar_a_copier/oscar/$image_transferee.* $ip_serveur_ssh:/mnt/`cat /tmp/copies_oscar_trouve`/copies_oscar_ssh/`cat /tmp/nom_copie_oscar`/sauvegarde_oscar
transfert_sauvegarde nettoyer_fin
umount $partition_oscar_a_copier 1>/dev/null 2>/dev/null ; sync
}
#----------------------------------------------------------------------------------------------------
proposer_les_sauvegardes()
{
	boite_demande_oscar_ssh
}
#----------------------------------------------------------------------------------------------------
demander_le_nom_de_la_copie()
{
echo -en "\033[1;34m `cat $chemin_langue/menu_10q` : \033[1;31m"
read nom_copie_oscar
echo -e "\033[1;m"
echo "$nom_copie_oscar" > /tmp/nom_copie_oscar
scp /tmp/nom_copie_oscar $ip_serveur_ssh:/tmp/nom_copie_oscar 1>/dev/null
}
#----------------------------------------------------------------------------------------------------
demander_le_nouveau_nom_de_la_copie()
{
echo -en "\033[1;34m `cat $chemin_langue/menu_10r` \033[1;33m$nom_copie_oscar_a_renommer \033[1;34m: \033[1;31m"
read nom_copie_oscar
echo -e "\033[1;m"
echo "$nom_copie_oscar" > /tmp/nom_copie_oscar
scp /tmp/nom_copie_oscar $ip_serveur_ssh:/tmp/nom_copie_oscar 1>/dev/null
}
#----------------------------------------------------------------------------------------------------
main()
{
rm -f /tmp/sortir
rm -f /tmp/tempfile # des menus precedents sauf celui-ci tempfile______
rm -f /tmp/tempfile___
rm -f /tmp/tempfile____
rm -f /tmp/tempfile_____
rm -f /tmp/tempfile_______

type_copie=
sp_info_copies=
calendrier=$(date +%d/%m/%y)
heure=$(date +%kh%Mmin)
rm -f /tmp/rien
echo "\Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  \Zn  " > /tmp/rien
output=exit
dialog  --no-cancel --colors --no-shadow \
	--backtitle "`cat /etc/banniere_oscar`" --title " `cat $chemin_langue/menu_10t` " \
	--menu  "\n  \Zb\Z3 `cat $chemin_langue/texte_19` : `cat ip_installe_poste``cat /tmp/rien`  le $calendrier √† $heure\n " 11 111 0  \
	" " "" \
	"console" "`cat $chemin_langue/menu_10y` $ip_serveur_ssh\Zn." \
	" " "" \
	"fin_connexion" "`cat $chemin_langue/menu_10za` $ip_serveur_scribe\Zn." \
	" " "" \
	"info_copies" "`cat $chemin_langue/menu_10s`" \
	"copie_oscar" "`cat $chemin_langue/menu_10u`" \
	"recup_oscar" "`cat $chemin_langue/menu_10v`" \
	"renomme_copie" "`cat $chemin_langue/menu_10w`" \
	"supprime_copie" "`cat $chemin_langue/menu_10x`" \
	" " "" \
	"configure" "`cat $chemin_langue/menu_10z`" \
	"partitions" "`cat $chemin_langue/menu_11a` $ip_serveur_ssh\Zn." \
	" " "" \
        "halt" "`cat $chemin_langue/menu_8`" \
	"oscar" "`cat $chemin_langue/menu_21`" \
	" " "" 2>/tmp/tempssh
	
if [ $? = "255" ]
then
	rm -f /tmp/tempssh
	rm -f /tmp/rien
	fin_ssh
	exit
fi
output=`cat /tmp/tempssh`
rm -f /tmp/tempssh
rm -f /tmp/rien

if [ "$output" = " " ]
then
	main
elif [ "$output" = "" ]
then
	main
elif [ $output = "configure" ]
then
	configurer_ip_serveur_ssh
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	#else
	#	recupere_adresses_ip
	#	controle_ip_serveur_ssh_existe
	fi
	main
elif [ $output = "console" ]
then
	runme lancer_dhcp 2>/dev/null 1>/dev/null
	echo
	echo -e "\033[1;34m `cat $chemin_langue/menu_10j`\033[1;34m :\033[1;m"
	echo
	ssh $ip_serveur_ssh
	boucle
elif [ $output = "fin_connexion" ]
then
	fin_ssh
	exit
elif [ $output = "info_copies" ]
then
	sp_info_copies=oui
	debut_ssh
	cherche_partition_copies_oscar_ssh
	if [ "$copies_oscar_trouve" != "0" ]
	then
		if [ "$liste_repertoire_copies_oscar_ssh" = "" ]
		then
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "\n\Zb\Z4`cat $chemin_langue/menu_11b` ... \Zn" 7 60
			case $? in
				0) ;;
				255) ;;
			esac
		else
			valeur1=`awk '{print$2}' /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar`
			valeur2=`awk '{print$3}' /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar`
			valeur3=`awk '{print$5}' /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar`
			rm -f /tmp/ligne_toutes_les_valeurs_repertoire_copies_oscar
			valeur1=$[valeur1/1000]
			valeur2=$[valeur2/1000]
			valeur2=$[valeur1-valeur2]
			
			echo " " > /tmp/ligne_copies_oscar_ssh
			echo "`cat $chemin_langue/menu_11c` $valeur3 : " >> /tmp/ligne_copies_oscar_ssh
			echo " " >> /tmp/ligne_copies_oscar_ssh
			echo "$valeur2 Mo `cat $chemin_langue/repertoire_3` $valeur1 Mo " >> /tmp/ligne_copies_oscar_ssh
			cut -d" " -f5-15 /tmp/liste_copies_oscar_ssh  >> /tmp/ligne_copies_oscar_ssh
			rm -f /tmp/liste_copies_oscar_ssh
			
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors --no-shadow \
			--backtitle "`cat /etc/banniere_oscar`" \
			--exit-label "`cat $chemin_langue/Continuer`" \
			--title " `cat $chemin_langue/menu_11d` " \
			--textbox "/tmp/ligne_copies_oscar_ssh" 0 0
		        case $? in
				0)	;;
				3)  ;;
				255) ;;
			esac 
			rm -f /tmp/ligne_copies_oscar_ssh
		fi
	fi
	fin_ssh_copie_recup
elif [ $output = "copie_oscar" ]
then
	debut_ssh
	cherche_partition_copies_oscar_ssh
	if [ "$copies_oscar_trouve" != "0" ]
	then
		boites_choix_controle_copie
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
		else
			if [ "$liste_repertoire_copies_oscar_ssh" = "" ]
			then
				demander_le_nom_de_la_copie
				copier_la_sauvegarde_sur_ssh
			else
				echo " `cat $chemin_langue/menu_11d` " > /tmp/menu_titre
				echo "\n\Zb\Z3`cat $chemin_langue/menu_11e` : \n" > /tmp/menu_texte
				# proposer_les_sauvegardes
				choix_copie_sauvegarde
				if ( test -e /tmp/sortir )
				then
					rm -f /tmp/tempfile
					rm -f /tmp/sortir
				fi
			fi
		fi
	fi
	fin_ssh_copie_recup
elif [ $output = "recup_oscar" ]
then
	debut_ssh
	cherche_partition_copies_oscar_ssh
	if [ "$copies_oscar_trouve" != "0" ]
	then
		if [ "$liste_repertoire_copies_oscar_ssh" = "" ]
		then
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "\n\Zb\Z4`cat $chemin_langue/menu_11b` ... " 7 60
			case $? in
				0) ;;
				255) ;;
			esac
		else
			boites_choix_controle_copie
			if ( test -e /tmp/sortir )
			then
				rm -f /tmp/sortir
			else
				echo " `cat $chemin_langue/menu_11d` " > /tmp/menu_titre
				echo "\n\Zb\Z3`cat $chemin_langue/menu_11e`.\n" > /tmp/menu_texte
				echo "\Zb\Z4`cat $chemin_langue/menu_11f` : " > /tmp/fichierquestion
				proposer_les_sauvegardes
				if ( test -e /tmp/sortir )
				then
					rm -f /tmp/tempfile
					rm -f /tmp/sortir
				else
					cp -f /tmp/tempfile /tmp/nom_copie_oscar
					rm -f /tmp/tempfile
					nom_copie_oscar=`cat /tmp/nom_copie_oscar`
					scp /tmp/nom_copie_oscar $ip_serveur_ssh:/tmp/nom_copie_oscar 1>/dev/null
					recuperer_la_sauvegarde_depuis_ssh
				fi
			fi
		fi
	fi
	fin_ssh_copie_recup
elif [ $output = "renomme_copie" ]
then
	debut_ssh
	cherche_partition_copies_oscar_ssh
	if [ "$copies_oscar_trouve" != "0" ]
	then
		if [ "$liste_repertoire_copies_oscar_ssh" = "" ]
		then
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "\n\Zb\Z4`cat $chemin_langue/menu_11b` ... \Zn" 7 60
			case $? in
				0) ;;
				255) ;;
			esac
		else
			echo " Renommer une copie sauvegard√©e sur le serveur ssh " > /tmp/menu_titre
			echo "\n\Zb\Z3`cat $chemin_langue/menu_11e`. \n" > /tmp/menu_texte
			echo "\Zb\Z4`cat $chemin_langue/menu_11g` : " > /tmp/fichierquestion
			proposer_les_sauvegardes
			if ( test -e /tmp/sortir )
			then
				rm -f /tmp/tempfile
				rm -f /tmp/sortir
			else
				cp -f /tmp/tempfile /tmp/nom_copie_oscar_a_renommer
				rm -f /tmp/tempfile
				nom_copie_oscar_a_renommer=`cat /tmp/nom_copie_oscar_a_renommer`
				demander_le_nouveau_nom_de_la_copie
				scp /tmp/nom_copie_oscar_a_renommer $ip_serveur_ssh:/tmp/nom_copie_oscar_a_renommer 1>/dev/null
				rm -f /tmp/nom_copie_oscar_a_renommer
				renommer_la_sauvegarde_sur_ssh
				scp $ip_serveur_ssh:/tmp/erreur_renomme_oscar /tmp/erreur_renomme_oscar 1>/dev/null
				erreur_renomme_oscar=`cat /tmp/erreur_renomme_oscar`
				rm -f /tmp/erreur_renomme_oscar
				if [ "$erreur_renomme_oscar" = "erreur" ]
				then
					DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
					--backtitle "`cat /etc/banniere_oscar`" \
					--title " `cat $chemin_langue/DESOLE` " \
					--ok-label "`cat $chemin_langue/Continuer`"  \
					--msgbox "\n\Zb\Z4`cat $chemin_langue/menu_11h`† ... \Zn" 7 55
					case $? in
						0) ;;
						255) ;;
					esac
				fi
			fi
		fi
	fi
	fin_ssh_copie_recup
elif [ $output = "supprime_copie" ]
then
	debut_ssh
	cherche_partition_copies_oscar_ssh
	if [ "$copies_oscar_trouve" != "0" ]
	then
		if [ "$liste_repertoire_copies_oscar_ssh" = "" ]
		then
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "\n\Zb\Z4`cat $chemin_langue/menu_11b` ... \Zn" 7 60
			case $? in
				0) ;;
				255) ;;
			esac
		else
			echo " `cat $chemin_langue/menu_11i` " > /tmp/menu_titre
			echo "\n\Zb\Z3`cat $chemin_langue/menu_11e`. \n" > /tmp/menu_texte
			echo "\Zb\Z4`cat $chemin_langue/menu_11j` : " > /tmp/fichierquestion
			proposer_les_sauvegardes
			if ( test -e /tmp/sortir )
			then
				rm -f /tmp/tempfile
				rm -f /tmp/sortir
			else
				cp -f /tmp/tempfile /tmp/nom_copie_oscar
				rm -f /tmp/tempfile
				nom_copie_oscar=`cat /tmp/nom_copie_oscar`
				scp /tmp/nom_copie_oscar $ip_serveur_ssh:/tmp/nom_copie_oscar 1>/dev/null
				supprimer_la_sauvegarde_sur_ssh
			fi
		fi
	fi
	fin_ssh_copie_recup

elif [ $output = "partitions" ]
then
	runme lancer_dhcp 2>/dev/null 1>/dev/null
	ssh root@$ip_serveur_ssh fdisk -l 2>/dev/null
	boucle
elif [ "$output" = "halt" ]
then
	fin_ssh
        eteindre_le_poste
elif [ $output = "oscar" ]
then
	fin_ssh
	exit
else
	$output
fi
boucle
}
#----------------------------------------------------------------------------------------------------
recupere_adresses_ip()
{
ip_serveur_ssh=`cat /etc/oscar_transfert_ssh/ip_serveur_ssh`
}
#----------------------------------------------------------------------------------------------------
boite_ip_serveur_ssh()
{
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " `cat $chemin_langue/menu_10f`  " \
	--inputbox "\n\n\Z2 `cat $chemin_langue/menu_10g` : \n\n\Z2 `cat $chemin_langue/menu_10i` \
	\n\n\n\Zb\Z4 `cat $chemin_langue/menu_10h` :  " 0 0 `cat /etc/oscar_transfert_ssh/ip_serveur_ssh` 2>/tmp/temp_ip_serveur_ssh
	case $? in
    0)  cut -f4 -d"." /tmp/temp_ip_serveur_ssh > /tmp/temp_ip_serveur_ssh1
	valeur_test=`cat /tmp/temp_ip_serveur_ssh1`
	rm -f /tmp/temp_ip_serveur_ssh1
	if [ "$valeur_test" = "" ]
	then
		rm -f /tmp/temp_ip_serveur_ssh
		boite_ip_serveur_ssh
		return 0
	fi
	cp -f /tmp/temp_ip_serveur_ssh /etc/oscar_transfert_ssh/ip_serveur_ssh
	rm -f /tmp/temp_ip_serveur_ssh
	;;
    1)	echo "" > /tmp/sortir
    	rm -f /tmp/temp_ip_serveur_ssh
	;;
    255) echo "" > /tmp/sortir
    	rm -f /tmp/temp_ip_serveur_ssh
	;;
esac
}
#----------------------------------------------------------------------------------------------------
prepare_boite_ip_serveur_ssh()
{
if [ "$test_reseau" = "" ]
then
	echo "192.168" > /etc/oscar_transfert_ssh/ip_serveur_ssh
fi

boite_ip_serveur_ssh
if ( test -e /tmp/sortir )
then
	rm -f /tmp/sortir
	exit
fi
}
#----------------------------------------------------------------------------------------------------
configurer_ip_serveur_ssh()
{
if ! ( test -e /etc/oscar_transfert_ssh/ip_serveur_ssh )
then
	if ! ( test -e /tmp/carte_ethi )
	then
		runme lancer_dhcp
	fi
	if ! ( test -e /etc/oscar_transfert_ssh )
	then
		mkdir /etc/oscar_transfert_ssh
	fi
	cut -d"." -f1-2 ip_installe_poste > /etc/oscar_transfert_ssh/ip_serveur_ssh
	test_reseau=`cat /etc/oscar_transfert_ssh/ip_serveur_ssh`
	prepare_boite_ip_serveur_ssh
else
	cut -d"." -f2-4 /etc/oscar_transfert_ssh/ip_serveur_ssh > /tmp/test_ip_serveur_ssh
	test_reseau=`cat /tmp/test_ip_serveur_ssh`
	rm -f /tmp/test_ip_serveur_ssh
	prepare_boite_ip_serveur_ssh
fi

recupere_adresses_ip
controle_ip_serveur_ssh_existe
}
#----------------------------------------------------------------------------------------------------
PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

#  commandes externes de proc√©dures
case "$1" in
	controle_ip_serveur_ssh_existe)
		controle_ip_serveur_ssh_existe
	exit 0
	;;
esac

configurer_ip_serveur_ssh
main
