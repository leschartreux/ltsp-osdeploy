#!/bin/bash

## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin,  jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.

# pour Ubuntu rechercher : # ici repare boot ubuntu demarrage ubuntu debug ubuntu

# si /etc/installer_grub2 existe installer grub2
# pour grub2:
mode_graphique=640x480
# voir : bug_grub2 sysrscd pour affichage, verifier si unicode_org.pf2 est different de unicode.pf2

# pour installer grub1 : echo "" > /etc/installer_grub1

PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

clavier_grub
choix_clavier=`cat /usr/share/oscar/usr/choix_clavier`


# OSCAR realise le grub ubuntu, mandriva ou autres linux avec grub2 si oscar_realise_grub2_autres_linux=oui
oscar_realise_grub2_autres_linux=non

# pour ajouter un demarrage personnel sous grub2 le mettre dans /etc/conf.d/prive_40_custom

# pour un demarrage uniquement fait par OSCAR /etc/installe_oscar_seul




#----------------------------------------------------------------------------------------------------
choix_noyau_demarrage()
{
# pour sysrcd 0.4.2 prendre le noyau utilisé
grep -ci "oscar_64" /proc/cmdline > /tmp/nombre_oscar_64
grep -ci "oscar1" /proc/cmdline > /tmp/nombre_oscar1
grep -ci "oscar164" /proc/cmdline > /tmp/nombre_oscar164
	nombre_oscar_64=0
	nombre_oscar1=0
	nombre_oscar164=0
if ( test -e /tmp/nombre_oscar_64 )
then
	nombre_oscar_64=`cat /tmp/nombre_oscar_64`
fi
if ( test -e /tmp/nombre_oscar1 )
then
	nombre_oscar1=`cat /tmp/nombre_oscar1`
fi
if ( test -e /tmp/nombre_oscar164 )
then
	nombre_oscar164=`cat /tmp/nombre_oscar164`
fi
rm -f /tmp/nombre_oscar_64
rm -f /tmp/nombre_oscar1
rm -f /tmp/nombre_oscar164
if [ "$nombre_oscar_64" = "1" ]	# demarrage oscar_64
then
	choix_noyau=oscar_64
elif [ "$nombre_oscar1" = "1" ]	# demarrage oscar1
then
      	choix_noyau=oscar1
elif [ "$nombre_oscar164" = "1" ]	# demarrage oscar164
then
	choix_noyau=oscar164
else
	choix_noyau=oscar	# tous les autres cas ??
fi
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
test_cdrom_isolinux()
{
if ! ( test -e /etc/demarrage_usb )
then
	if [ "$ip_serveur_pxe" = "" ]	# installation complete par cederom
	then
		if ( test -e /etc/demarrage_cdrom ) ## le poste est démarré avec le cdrom voir depart
		then	## seulement les fichiers OSCAR
		    if ! ( test -e /livemnt/boot/isolinux/oscar )
		    then
	    		if ( test -e /livemnt/boot/isolinux/rescue32 ) || ( test -e /livemnt/boot/isolinux/rescuecd )	# sauvegarde non autorisée car utilisation de cd_oscar
	    		then
	    			# Vous n'avez pas les droits de \Zb\Z3sauvegarde
				DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
				--backtitle "`cat /etc/banniere_oscar`" \
				--title " `cat $chemin_langue/DESOLE` " \
				--ok-label "`cat $chemin_langue/Continuer`"  \
				--msgbox "\n\n `cat $chemin_langue/msgbox_47`" 13 70
				case $? in
				0) 	exit;;
				255) exit;;
				esac
			else
				# cdrom enleve
				DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
				--backtitle "`cat /etc/banniere_oscar`" \
				--title " `cat $chemin_langue/DESOLE` " \
				--ok-label "`cat $chemin_langue/Continuer`"  \
				--msgbox "\n\n \Zb\Z1`cat $chemin_langue/ATTENTION` : \Zn\n \
				\n`cat $chemin_langue/msgbox_48`.\n \
				\n`cat $chemin_langue/msgbox_27` \Zb\Z3installer\Zn\Z2.\n\n \
				\n`cat $chemin_langue/msgbox_49`\n\n\n" 17 75
				case $? in
					0) exit;;
					255) exit;;
				esac
			fi
		    fi
		fi
	fi
fi
}
#----------------------------------------------------------------------------------------------------
test_demarrage_usb()	## si oscar est démarré avec clé USB et cdcache ne pas utiliser cette commande
{
# a verifier si possible en client et serveur pxe le demarrage avec l'option docache
return

option=docache

if [ "$ip_serveur_pxe" = "" ]	# installation complete par cederom
then
	if ( test -e /etc/demarrage_cdcache )
	then
		# option docache
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/DESOLE` " \
		--ok-label "`cat $chemin_langue/Continuer`"  \
		--msgbox "\n\n \Zb\Z1A`cat $chemin_langue/ATTENTION` : \Zn \n \
		\n\Zn`cat $chemin_langue/menu_291` \Zb\Z3$option \n\n \
		\n`cat $chemin_langue/msgbox_50`\n\n\n" 17 78
		case $? in
		    0) 	echo "" > /tmp/sortir
		    	return;;
		    255) echo "" > /tmp/sortir
		    	return;;
		esac
	else	# demarrage usb sans cdcache
		if ! ( test -e /mnt/cdrom/syslinux.cfg )
		then
			# cle usb demontee
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "\n\n `cat $chemin_langue/msgbox_51`.\n\n\n" 17 73
			case $? in
				0) echo "" > /tmp/sortir
		    			return;;
				255) echo "" > /tmp/sortir
		    			return;;
			esac
		fi
	fi
fi	
}
#----------------------------------------------------------------------------------------------------
test_demarrage_cdrom() ## si oscar est démarré avec lilo ou docache ne pas utiliser cette commande
{
if [ "$ip_serveur_pxe" = "" ]	# installation complete par cederom
then
	if ! ( test -e /etc/demarrage_cdrom ) ## le poste est démarré avec client_multi de multi_lilo voir depart
	then	## seulement les fichiers OSCAR
		# demarrage disque dur
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/DESOLE` " \
		--ok-label "`cat $chemin_langue/Continuer`"  \
		--msgbox "\n\n `cat $chemin_langue/msgbox_52`.\n\n\n" 17 80
		case $? in
		    0) 	exit;;
		    255) exit;;
		esac
	fi

	if ( test -e /etc/demarrage_cdoscar_minimal )  # client minimal fsscript_cli.sh de livecd
	then
		# Vous avez démarré ce poste avec un cédérom \Zb\Z3OSCAR minimal
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/Information` " \
		--ok-label "`cat $chemin_langue/Continuer`"  \
		--msgbox "\n\n \Zb\Z1ATTENTION : \Zn \n \
		\n\Zn\Z2Vous avez démarré ce poste avec un cédérom \Zb\Z3OSCAR minimal\Zn\Z2. \n \
		\n\Z2Sur ce poste vous ne pourrez pas utiliser \Zb\Z3l'interface graphique\Zn\Z2.\n\n\n" 14 70
		case $? in
		    0) 	return ;;
		    255) exit ;;
		esac
	fi
fi
}
#----------------------------------------------------------------------------------------------------
boite_partition_de_sauvegarde() # selectionner seulement les partitions linux non swap
{
# supprimer la partition ubuntu mandriva et juste boot
runme prepare_fichier_temptaille
rm -f /tmp/bozo
if [ "$partition_juste_boot" = "" ]
then
	partition_juste_boot=pas_juste_boot
fi
# rechercher dans global_ubuntu et glogal_mandrive les partitions sdai pour ne pas les proposees
	rm -f /tmp/tempfile
	if ( test -e /tmp/global_ubuntu ) 
	then
		cp -f /tmp/global_ubuntu /tmp/tempfile
	fi
	if ( test -e /tmp/global_mandriva ) 
	then	    
		cat /tmp/global_mandriva >> /tmp/tempfile
	fi
# enlever aussi les systèmes linux autres qu'OSCAR:
	if ( test -e /tmp/partition_oscar_trouvee )
	then
		partition_oscar_trouvee=`cat /tmp/partition_oscar_trouvee`
	else
		partition_oscar_trouvee=pas_partition_oscar_trouvee
	fi
	egrep -e "partition_linux_complete" /tmp/fichier_partitions_boot | grep -v "$partition_oscar_trouvee" | perl -pi -e 's/partition_linux_complete,//g;' > /tmp/tempcomplete
	if ( test -e /tmp/tempcomplete ) 
	then	    
		cat /tmp/tempcomplete >> /tmp/tempfile
	fi
	rm -f /tmp/tempcomplete
	
if ( test -e /tmp/tempfile ) 
then
	perl -pi -e 's/\?/ __/g;' /tmp/tempfile
	echo `gawk '{ print $1 " " }' /tmp/tempfile ` > /tmp/tempfile2
	perl -pi -e 's/ sd/\" \| grep -v \"sd/g; s/ hd/\" \| grep -v \"hd/g;' /tmp/tempfile2
	perl -pi -e 's/\"/ \"/g;' /tmp/tempfile2	# ajouter espace pour ne pas prendre sdaix
	test_fichier=`cat /tmp/tempfile2`
	if [ "$test_fichier" = "" ] || [ "$test_fichier" = " " ]
	then
		echo "_pas_partition_" > /tmp/tempfile2
	fi
	echo "grep -v \"`cat /tmp/tempfile2` \"" > /tmp/tempfile
else
	echo "grep -v \"_pas_partition_\" " > /tmp/tempfile
fi

echo "egrep -e \"^\/dev\" /tmp/fichier_disque_dur | grep \"Linux\" | grep -v \"swap\" | grep -v \"$partition_juste_boot \" | \
`cat /tmp/tempfile` | \
perl -pi -e 's/\*//g;  s/\+/ /g; s/\-/ /g; s/  /:/g; s/:+/:/g;' > /tmp/tempfile1" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom
rm -f /tmp/tempfile
rm -f /tmp/tempfile2

# awk 'BEGIN { FS=":" } { printf ("%0s %15s %25s\n","\""$1"\" \"",$4,$6"\" \\")}' /tmp/tempfile1 > /tmp/bozo
awk 'BEGIN { FS=" " } { printf ("%0s %15s %25s\n","\""$1"\" \"",$2,$3"\" \\")}' /tmp/tempfile1 > /tmp/bozo

# ne faire 'runme boite_selection_bozo' que si le nombre de ligne est différent de 1:
grep -ci "/dev" /tmp/bozo > /tmp/tempfile
nombre_partition_linux=`cat /tmp/tempfile`
rm -f /tmp/tempfile
if [ "$nombre_partition_linux" = "0" ]	# plus qu'une partition linux possible
then
	echo " ERREUR pas de partition Linux LIBRE "
	sleep 2
elif ! [ "$nombre_partition_linux" = "1" ]	# plus qu'une partition linux possible
then
        if ( test -e /tmp/partition_oscar_client ) # c'est le client clone qui demande prendre alors la partition oscar envoyee
        then
		echo "/dev/`cat /tmp/partition_oscar_client`" > /tmp/tempfile	# /dev/sda2
        else
		runme boite_selection_bozo 2>/dev/null
		rm -f /tmp/menu_titre
		rm -f /tmp/menu_texte
		rm -f /tmp/fichierquestion
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
		        exit
		fi
	fi
	reponse=`cat /tmp/tempfile` # /dev/hdaiii
else	# une seule ligne
	perl -pi -e 's/ /,/g; s/\"//g;' /tmp/bozo
	cut -d"," -f1 /tmp/bozo > /tmp/tempfile
	reponse=`cat /tmp/tempfile` # /dev/hdaiii
	fi
}
#----------------------------------------------------------------------------------------------------
boite_partition_linux() # prépare la boite pour selectionner seulement les partitions linux non swap
{
if ( test -e /etc/demarrage_usb ) || ( test -e /etc/demarrage_cdrom )
then
	# proposer toutes les partitions à sauvegarder sur seulement linux non swap
	echo " `cat $chemin_langue/selection_1` " > /tmp/menu_titre
	echo "" > /tmp/menu_texte
	echo "\n`cat $chemin_langue/selection_2`\n\n " > /tmp/fichierquestion
	echo "\n\n`cat $chemin_langue/selection_47`" >> /tmp/fichierquestion
	boite_partition_de_sauvegarde
	rm -f /tmp/menu_titre
	rm -f /tmp/menu_texte
	rm -f /tmp/fichierquestion

	perl -pi -e 's/\/dev\///g;' /tmp/tempfile
	partition_linux=`cat /tmp/tempfile`		#hdaiii
	rm -f /tmp/tempfile
else
	grep -ci "root=UUID=" /proc/cmdline > /tmp/test_demarrage_oscar_sur_dd	# par sécurite
	test_demarrage_oscar_sur_dd=`cat /tmp/test_demarrage_oscar_sur_dd`
        if [ "$test_demarrage_oscar_sur_dd" = "1" ]
	then
		echo "`cat /proc/cmdline`" > /tmp/tempfile_sur_dd
		perl -pi -e 's/root=UUID=/;/g; ' /tmp/tempfile_sur_dd
		cut -d";" -f2 /tmp/tempfile_sur_dd > /tmp/tempfile_sur_dd1
		cut -d" " -f1 /tmp/tempfile_sur_dd1 > /tmp/tempfile_sur_dd	# UUID partition oscar
		cp -f /tmp/tempfile_sur_dd /tmp/temp_sdai
		remplacer_uuid_par_sdai
		partition_linux=`cat /tmp/temp_sdai`
		rm -f /tmp/tempfile_sur_dd
		rm -f /tmp/tempfile_sur_dd1
	fi
fi
}
#----------------------------------------------------------------------------------------------------
boite_erreur_partition_sans_UUID()
{
if ! [ "$systeme_partition_sans_UUID" = "" ] # partition Ubuntu sans repertoire boot
then
	echo "\Zn\Z2`cat $chemin_langue/msgbox_59` \Zb\Z4$systeme_partition_sans_UUID\Zn\Z2." > /tmp/temp_sans_UUID
else
	echo "\Zn\Z2`cat $chemin_langue/msgbox_59` \Zb\Z4$partition_sans_UUID\Zn\Z2." > /tmp/temp_sans_UUID
	systeme_partition_sans_UUID=Linux
fi
# erreur de formatage
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--ok-label "`cat $chemin_langue/Continuer`"  \
	--msgbox "\n\n `cat $chemin_langue/msgbox_53` \Zb\Z3$partition_sans_UUID\Zb\Z1 : \Zn \n \
	\n\n `cat /tmp/temp_sans_UUID` \n \
	\n\Zn\Z2 `cat $chemin_langue/Utilisez` \Zb\Z3$systeme_partition_sans_UUID\Zn\Z2 `cat $chemin_langue/ou` \Zb\Z3OSCAR\Zn\Z2 `cat $chemin_langue/msgbox_54`\Zn\Z2.\n\n" 15 56
	case $? in
0) rm -f /tmp/temp_sans_UUID
   rm -f /tmp/$tmp_a_effacer
   exit;;
255) rm -f /tmp/temp_sans_UUID
     rm -f /tmp/$tmp_a_effacer
     exit;;
esac
}
#----------------------------------------------------------------------------------------------------
remplacer_rien_du_tout()
{
cp -f /tmp/kernel_ligne_etude /tmp/kernel_ligne_etude_temp
grep -ci "root=UUID" /tmp/kernel_ligne_etude > /tmp/tempfile4
nombre_UUID_rien=`cat /tmp/tempfile4`
rm -f /tmp/tempfile4
if [ "$nombre_UUID_rien" = "1" ]	# partition rien_du_tout
then
	perl -pi -e 's/root=UUID=/?/g;' /tmp/kernel_ligne_etude_temp
	cut -d"?" -f2 /tmp/kernel_ligne_etude_temp > /tmp/kernel_ligne_etude_temp1
	cut -d" " -f1 /tmp/kernel_ligne_etude_temp1 > /tmp/temp_sdai
	rm -f /tmp/kernel_ligne_etude_temp1
	rm -f /tmp/kernel_ligne_etude_temp
	uuid_etude=`cat /tmp/temp_sdai`
	remplacer_uuid_par_sdai
	partition_etude=`cat /tmp/temp_sdai`
else # partition non UUID
	perl -pi -e 's/root=/?/g;' /tmp/kernel_ligne_etude_temp
	cut -d"?" -f2 /tmp/kernel_ligne_etude_temp > /tmp/kernel_ligne_etude_temp1
	cut -d" " -f1 /tmp/kernel_ligne_etude_temp1 > /tmp/temp_sdai
	rm -f /tmp/kernel_ligne_etude_temp1
	rm -f /tmp/kernel_ligne_etude_temp
	uuid_etude=rien_du_tout
	partition_etude_dev=`cat /tmp/temp_sdai`
	if [ "$partition_etude" != "" ]
	then
		partition_etude=`expr substr $partition_etude_dev 6 6` # répertoire
	else
		partition_etude=
	fi
fi
rm -f /tmp/temp_sdai
if [ "$partition_etude" != "" ]
then
	numero_hd_etude=`expr substr $partition_etude 4 3` # numero du répertoire
	numero_hd_etude=$[$numero_hd_etude-1]
else
	numero_hd_etude=
fi
}
#----------------------------------------------------------------------------------------------------
recuperer_numero_disque_grub()	# le repertoire sdai est $trouver_numero_disque_grub les disques sont dans /tmp/ordre_disques_grub
{
if ( test -e /tmp/ordre_disques_grub )
then
	if [ "$trouver_numero_disque_grub" != "" ]
	then
		lettres_disque_sdai=`expr substr $trouver_numero_disque_grub 1 3` # lettres du disque sdai
		echo "$lettres_disque_sdai" > /tmp/temp1
		echo "grep -i \"`cat /tmp/temp1`\" /tmp/ordre_disques_grub > /tmp/temp2" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		rm -f /tmp/exec_nom
		cut -d"," -f2 /tmp/temp2 > /tmp/temp1
		trouver_numero_disque_grub=`cat /tmp/temp1`
		rm -f /tmp/temp1
		rm -f /tmp/temp2
	fi
fi
}
#----------------------------------------------------------------------------------------------------
faire_variables_partition_ubuntu()
{
partition_montee_boot_ubuntu=$partition_montee_boot
echo "partition_linux_complete,$reponse" > /tmp/partition_temp
enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
if [ "$partition_juste_boot" != "$reponse" ]
then
	echo "partition_linux_ubuntu,$reponse" > /tmp/partition_temp
	enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
	echo "partition_linux_ubuntu,$reponse" >> /tmp/fichier_partitions_boot
fi

sortir_uuid_reponse
if [ "$test_vol_id" = "" ] # partition qui ne possède pas d'UUID
then
	partition_sans_UUID=$reponse
	systeme_partition_sans_UUID=Ubuntu
	tmp_a_effacer=uuid_ubuntu
	boite_erreur_partition_sans_UUID
fi
uuid_ubuntu=`cat /tmp/uuid_ubuntu`
trouver_numero_disque_grub=$partition_ubuntu
recuperer_numero_disque_grub
numero_disque_grub=$trouver_numero_disque_grub
rm -f /tmp/uuid_ubuntu
verif_kernel_ligne_ubuntu=
if ( test -e /tmp/kernel_ligne_ubuntu )
then
    verif_kernel_ligne_ubuntu=`cat /tmp/kernel_ligne_ubuntu`
fi

if ! ( [ "$verif_kernel_ligne_ubuntu" = "" ] || [ "$partition_ubuntu" = "" ] || [ "$partition_ubuntu" = "rien_du_tout" ] )
then
	verifier_version_titre_ubuntu
	grep -ci "partition_linux_juste_boot" /tmp/fichier_partitions_boot > /tmp/nb_juste_boot
	nb_juste_boot=`cat /tmp/nb_juste_boot`
	rm -f /tmp/nb_juste_boot
	if [ "$nb_juste_boot" != "0" ]
	then
		if [ "$partition_juste_boot" = "$reponse" ]	# partition juste boot
		then
			numero_partition_juste_grub=`expr substr $reponse 4 3` # numero du répertoire juste boot
			numero_partition_juste_grub=$[$numero_partition_juste_grub-1]
		fi
	else
		numero_partition_juste_grub=$numero_hd_ubuntu
	fi
	echo "$partition_ubuntu?$numero_hd_ubuntu?$uuid_ubuntu?`cat /tmp/kernel_ligne_ubuntu`?$version_ubuntu?$numero_disque_grub?$ubuntu_titre?$numero_disque_ubuntu?$numero_partition_juste_grub" >> /tmp/global_ubuntu	# pour plusieurs partitions ubuntu
fi
	#	echo "$partition_ubuntu?$numero_hd_ubuntu?$uuid_ubuntu?" >> /tmp/global_ubuntu	# pour plusieurs partitions ubuntu
}
#----------------------------------------------------------------------------------------------------
remplacer_resume_swap_uuid_mandriva()
{
cp -f /tmp/kernel_ligne_ubuntu /tmp/kernel_ligne_etude_temp
grep -ci "resume=UUID" /tmp/kernel_ligne_etude_temp > /tmp/tempfile4
nombre_UUID_rien=`cat /tmp/tempfile4`
rm -f /tmp/tempfile4
if [ "$nombre_UUID_rien" = "1" ]	# partition rien_du_tout
then
	perl -pi -e 's/resume=UUID=/?/g;' /tmp/kernel_ligne_etude_temp
	cut -d"?" -f2 /tmp/kernel_ligne_etude_temp > /tmp/kernel_ligne_etude_temp1
	cut -d" " -f1 /tmp/kernel_ligne_etude_temp1 > /tmp/temp_sdai
	rm -f /tmp/kernel_ligne_etude_temp1
	rm -f /tmp/kernel_ligne_etude_temp
	uuid_etude=`cat /tmp/temp_sdai`
	rm -f /tmp/temp_sdai
	# sfdisk -l > /tmp/tempswap 2>/dev/null
	runme info_ddialog
	grep -i swap /tmp/fichier_disque_dur > /tmp/tempswap
	# prendre la premiere colonne :
	dev_swap=`awk '{print$1}' /tmp/tempswap`
	rm -f /tmp/tempswap
	
	# sortir uuid de $dev_swap :
	# ancien : vol_id $dev_swap -u > /tmp/uuid_swap
	echo "$dev_swap" > /tmp/temp_dev_swap
	blkid -o full `cat /tmp/temp_dev_swap` > /tmp/temp_uuid_sdai
	perl -pi -e 's/UUID="/,/g;' /tmp/temp_uuid_sdai
	cut -d"," -f2 /tmp/temp_uuid_sdai > /tmp/temp_uuid_sdai1
	cut -d"\"" -f1 /tmp/temp_uuid_sdai1 > /tmp/uuid_swap
	rm -f /tmp/temp_uuid_sdai
	rm -f /tmp/temp_uuid_sdai1
	rm -f /tmp/temp_dev_swap
	
	# remplacer par le bon uuid swap:
	echo "perl -pi -e 's/$uuid_etude/`cat /tmp/uuid_swap`/g;' /tmp/kernel_ligne_ubuntu" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/uuid_swap
fi
}
#----------------------------------------------------------------------------------------------------
teste_partition_ubuntu()
{
# teste Ubuntu # ici repare boot ubuntu demarrage ubuntu debug ubuntu
controle_ubuntu=
controle_ubuntu_oscar=

if ( test -e $partition_montee_boot/grub/grub.cfg )
then
 	rm -f /tmp/tempubuntu_grub2
	#grep -i -A 8 "BEGIN /etc/grub.d/10_Linux" $partition_montee_boot/grub/grub.cfg > /tmp/tempubuntu_grub2
	#grep -i -A 9 "menuentry" $partition_montee_boot/grub/grub.cfg | head -n 10 > /tmp/tempubuntu_grub2
	grep -i -A 13 "\-\-class gnu\-linux" $partition_montee_boot/grub/grub.cfg | head -n 15 > /tmp/tempubuntu_grub2
	
	# sortir ubuntu_titre
	#grep -i "menuentry" /tmp/tempubuntu_grub2 | head -n 1 > /tmp/temptitre
	grep -i ", with Linux" $partition_montee_boot/grub/grub.cfg | head -n 1 > /tmp/temptitre
	grep -ci "Linux" /tmp/temptitre > /tmp/nb_linux_ubuntu
	if [ `cat /tmp/nb_linux_ubuntu` != 1 ]
	then	# oscar deja installe
		grep -i ", avec Linux" $partition_montee_boot/grub/grub.cfg | head -n 1 > /tmp/temptitre
	fi
	rm -f /tmp/nb_linux_ubuntu
	
	grep -ci "\"" /tmp/temptitre > /tmp/nombre_guillemet_double
	nombre_guillemet_double=`cat /tmp/nombre_guillemet_double`
	# pour la nouvelle version ubuntu 11.04 :
	grep -ci "'" /tmp/temptitre > /tmp/nombre_guillemet_simple
	nombre_guillemet_simple=`cat /tmp/nombre_guillemet_simple`
	rm -f /tmp/nombre_guillemet_double
	rm -f /tmp/nombre_guillemet_simple
	if [ "$nombre_guillemet_simple" != "0" ]
	then
		cut -d"'" -f2 /tmp/temptitre > /tmp/ubuntu_titre
	elif [ "$nombre_guillemet_double" != "0" ]
	then
		cut -d"\"" -f2 /tmp/temptitre > /tmp/ubuntu_titre
	else
		echo "Linux" > /tmp/ubuntu_titre
	fi
	perl -pi -e 's/with/avec/g;' /tmp/ubuntu_titre
	ubuntu_titre=`cat /tmp/ubuntu_titre`
	rm -f /tmp/ubuntu_titre
	rm -f /tmp/temptitre
	
	grep -i "vmlinuz-" /tmp/tempubuntu_grub2 > /tmp/temp_kernel_ligne_ubuntu_grub2
	perl -pi -e 's/vmlinuz-/,/g;' /tmp/temp_kernel_ligne_ubuntu_grub2
	cut -d"," -f2 /tmp/temp_kernel_ligne_ubuntu_grub2 > /tmp/kernel_ligne_ubuntu_grub2	# apres vmlinuz-
	cut -d" " -f1 /tmp/kernel_ligne_ubuntu_grub2 > /tmp/version_ubuntu_grub2
	version_ubuntu_grub2=_GRUB2_`cat /tmp/version_ubuntu_grub2`
	rm -f /tmp/version_ubuntu_grub2
	rm -f /tmp/temp_kernel_ligne_ubuntu_grub2

	#---------------------------
	# maintenant set root='hd0,msdos5'
	# mais ligne Linux /boot/vmlinuz-3.0.0-12-generic root=UUID=uuid_ubuntu ro quiet splash vt.handoff=7
	#---------------------------
	# recupere uuid :
	grep -i "vmlinuz-" /tmp/tempubuntu_grub2 > /tmp/temp_kernel_ligne_ubuntu_grub3
	perl -pi -e 's/=UUID=/}/g;' /tmp/temp_kernel_ligne_ubuntu_grub3
	cut -d"}" -f2 /tmp/temp_kernel_ligne_ubuntu_grub3 > /tmp/temp_kernel_ligne_ubuntu_grub4	# apres UUID=
	cut -d" " -f1 /tmp/temp_kernel_ligne_ubuntu_grub4 > /tmp/uuid_ubuntu
	rm -f tmp/temp_kernel_ligne_ubuntu_grub3
	rm -f tmp/temp_kernel_ligne_ubuntu_grub4
	uuid_ubuntu=`cat /tmp/uuid_ubuntu`

	echo "$partition_montee_boot" > /tmp/temp_partition_montee_boot
	perl -pi -e 's/\/mnt\///g;' /tmp/temp_partition_montee_boot
	cut -d"/" -f1 /tmp/temp_partition_montee_boot > /tmp/temp_partition_montee_boot1
	partition_ubuntu=`cat /tmp/temp_partition_montee_boot1`
	rm -f /tmp/temp_partition_montee_boot
	rm -f /tmp/temp_partition_montee_boot1
	
	# test uuid partition ubuntu
	blkid | grep -i "$uuid_ubuntu" > /tmp/test_uuid_partition
	test_uuid_partition=`cat /tmp/test_uuid_partition`
	rm -f /tmp/test_uuid_partition
	if [ "$test_uuid_partition" = "" ]
	then
		ancien_uuid_partition=$uuid_ubuntu
		echo "$partition_ubuntu" > /tmp/temp_sdai
		remplacer_sdai_par_uuid	# sdai dans /tmp/temp_sdai resultat dans /tmp/temp_sdai
		uuid_ubuntu=`cat /tmp/temp_sdai`
		rm -f tmp/temp_sdai
		echo "perl -pi -e 's/$ancien_uuid_partition/$uuid_ubuntu/g;' /tmp/kernel_ligne_ubuntu_grub2" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		rm -f /tmp/exec_nom
	fi
	
	numero_hd_ubuntu=`expr substr $partition_ubuntu 4 7`
	numero_hd_ubuntu=$[$numero_hd_ubuntu-1]
	partition_ubuntu_sd=`expr substr $partition_ubuntu 1 3`
	
	# calculer numero_disque_ubuntu :
	if [ "$partition_ubuntu_sd" = "sda" ]
	then
		numero_disque_ubuntu=0
	elif [ "$partition_ubuntu_sd" = "sdb" ]
	then
		numero_disque_ubuntu=1
	elif [ "$partition_ubuntu" = "sdc" ]
	then
		numero_disque_ubuntu=2
	elif [ "$partition_ubuntu_sd" = "sdd" ]
	then
		numero_disque_ubuntu=3
	elif [ "$partition_ubuntu_sd" = "sde" ]
	then
		numero_disque_ubuntu=4
	elif [ "$partition_ubuntu_sd" = "sdf" ]
	then
		numero_disque_ubuntu=5
	elif [ "$partition_ubuntu_sd" = "sdg" ]
	then
		numero_disque_ubuntu=6
	elif [ "$numero_disque_ubuntu" = "sdh" ]
	then
		numero_disque_ubuntu=7
	elif [ "$numero_disque_ubuntu" = "sdi" ]
	then
		numero_disque_ubuntu=8
	elif [ "$partition_ubuntu_sd" = "sdj" ]
	then
		numero_disque_ubuntu=9
	elif [ "$partition_ubuntu_sd" = "sdk" ]
	then
		numero_disque_ubuntu=10
	fi
	
	trouver_numero_disque_grub=$partition_ubuntu
	recuperer_numero_disque_grub
	numero_disque_grub=$trouver_numero_disque_grub
	rm -f /tmp/uuid_ubuntu
	
	# dans /tmp/partition_temp il y a partition_linux_..,$reponse
	echo "partition_linux_grub,$reponse" > /tmp/partition_temp
	enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
	
	grep -ci "partition_linux_juste_boot" /tmp/fichier_partitions_boot > /tmp/nb_juste_boot
	nb_juste_boot=`cat /tmp/nb_juste_boot`
	rm -f /tmp/nb_juste_boot
	if [ "$nb_juste_boot" != "0" ]
	then
		if [ "$partition_juste_boot" = "$reponse" ]	# partition juste boot
		then
			numero_partition_juste_grub=`expr substr $reponse 4 3` # numero du répertoire juste boot
			numero_partition_juste_grub=$[$numero_partition_juste_grub-1]
		fi
	else
		numero_partition_juste_grub=$numero_hd_ubuntu
	fi
	
	echo "$partition_ubuntu?$numero_hd_ubuntu?$uuid_ubuntu?`cat /tmp/kernel_ligne_ubuntu_grub2`?$version_ubuntu_grub2?$numero_disque_grub?$ubuntu_titre?$numero_disque_ubuntu?$numero_partition_juste_grub" >> /tmp/global_ubuntu	# pour plusieurs partitions ubuntu
	return
elif ( test -e $partition_montee_boot/grub/menu.lst )
then
        rm -f /tmp/tempubuntu
	grep -i "buntu" $partition_montee_boot/grub/menu.lst | grep -i "kernel" | grep -v "recovery" > /tmp/tempubuntu
        perl -pi -e 's/kernel /;/g; s/ /,/g;' /tmp/tempubuntu
	controle_ubuntu=`cat /tmp/tempubuntu`
	
	grep -i "buntu" $partition_montee_boot/grub/menu.lst | grep -i "kernel" | grep -v "recovery" > /tmp/tempubuntu
	
	if ! [ "$controle_ubuntu" = "" ] # partition Ubuntu
	then
		if ! [ "$partition_juste_boot" = "$reponse" ]	# partition ubuntu
		then
			if ( test -e /mnt/$reponse/etc/lsb-release )
			then
				grep -i "\"" /mnt/$reponse/etc/lsb-release > /tmp/temptitre
				cut -d"\"" -f2 /tmp/temptitre > /tmp/ubuntu_titre
				ubuntu_titre=`cat /tmp/ubuntu_titre`
				afficher_systeme_linux_installe=Ubuntu
				rm -f /tmp/ubuntu_titre
				rm -f /tmp/temptitre
			fi
			# oui si menu.lst sur partition ubuntu sinon reponse est la partition_juste_boot
			partition_ubuntu=$reponse
			numero_hd_ubuntu=`expr substr $partition_ubuntu 4 3` # numero du répertoire Ubuntu eventuel
			numero_hd_ubuntu=$[$numero_hd_ubuntu-1]
			faire_variables_partition_ubuntu
		fi
	else
		grep -i "kernel " $partition_montee_boot/grub/menu.lst | grep -i "splash=silent" | grep -i "resume=" > /tmp/tempubuntu
		controle_ubuntu=`cat /tmp/tempubuntu`	# partition Mandriva
		if [ "$controle_ubuntu" != "" ]
		then
			afficher_systeme_linux_installe=Mandriva
			cut -d")" -f2 /tmp/tempubuntu > /tmp/temp1	# pour supprimer (hdi,j)
			echo "kernel `cat /tmp/temp1`" > /tmp/kernel_ligne_ubuntu
			
			cut -d"(" -f2 /tmp/tempubuntu > /tmp/temp1	# pour trouver i
			cut -d"," -f1 /tmp/temp1 > /tmp/temp
			perl -pi -e 's/hd//g;' /tmp/temp
			numero_disque_ubuntu=`cat /tmp/temp`	# ici i
			cut -d"," -f2 /tmp/tempubuntu > /tmp/temp1	# pour trouver j
			cut -d")" -f1 /tmp/temp1 > /tmp/temp
			numero_partition_juste_grub=`cat /tmp/temp`	# car numero_partition_juste_grub est partition j pour juste boot
			rm -f /tmp/temp
			rm -f /tmp/temp1
		fi
	fi

	# pour oscar deja installe dans menu.lst pour Ubuntu kbuntu ...:
	grep -i "title=" $partition_montee_boot/grub/menu.lst | grep -i "buntu" > /tmp/tempubuntu
	controle_ubuntu_oscar=`cat /tmp/tempubuntu`
	if [ "$controle_ubuntu_oscar" = "" ]	# on ne peut pas avoir sur un meme poste ubuntu et mandriva
	then
		if  ( test -e /mnt/$reponse/etc/release ) # Mandriva
		then
			grep -i "Mandriva" /mnt/$reponse/etc/release > /tmp/temptitre
			ubuntu_titre=`cat /tmp/temptitre`
			if [ "$ubuntu_titre" != "" ]
			then
				afficher_systeme_linux_installe=Mandriva
				rm -f /tmp/temptitre
				
				# oui si menu.lst sur partition Mandriva sinon reponse est la partition_juste_boot
				partition_ubuntu=$reponse
				numero_hd_ubuntu=`expr substr $partition_ubuntu 4 3` # numero du répertoire Ubuntu eventuel
				numero_hd_ubuntu=$[$numero_hd_ubuntu-1]
				faire_variables_partition_ubuntu
				controle_ubuntu_oscar=$ubuntu_titre
				echo "$ubuntu_titre" > /tmp/tempubuntu
			fi
		fi
	fi
else # verifier si partition ubuntu ou mandriva sans repertoire boot
	if ( test -e /mnt/$reponse/etc/release )
	then
		grep -i "Mandriva" /mnt/$reponse/etc/release > /tmp/ubuntu_titre
		ubuntu_titre=`cat /tmp/ubuntu_titre`
		rm -f /tmp/ubuntu_titre
		if ! [ "$ubuntu_titre" = "" ]	# partition mandriva
		then
			partition_ubuntu=$reponse
			numero_hd_ubuntu=`expr substr $partition_ubuntu 4 3` # numero du répertoire Ubuntu eventuel
			numero_hd_ubuntu=$[$numero_hd_ubuntu-1]
			afficher_systeme_linux_installe=Mandriva
			faire_variables_partition_ubuntu
		fi
	elif ( test -e /mnt/$reponse/etc/lsb-release )	# existe aussi pour mandriva si partition juste boot
	then
		grep -i "RELEASE=" /mnt/$reponse/etc/lsb-release > /tmp/tempversion_ubuntu_ancienne
		version_ubuntu_ancienne=`cat /tmp/tempversion_ubuntu_ancienne`
		rm -f /tmp/tempversion_ubuntu_ancienne
			grep -i "\"" /mnt/$reponse/etc/lsb-release > /tmp/temptitre
			cut -d"\"" -f2 /tmp/temptitre > /tmp/ubuntu_titre
			ubuntu_titre=`cat /tmp/ubuntu_titre`
			rm -f /tmp/ubuntu_titre
			rm -f /tmp/temptitre
			partition_ubuntu=$reponse
			numero_hd_ubuntu=`expr substr $partition_ubuntu 4 3` # numero du répertoire Ubuntu eventuel
			numero_hd_ubuntu=$[$numero_hd_ubuntu-1]
			faire_variables_partition_ubuntu
	fi
fi
####	DEBUG
#    echo controle_ubuntu=$controle_ubuntu
#    echo controle_ubuntu_oscar=$controle_ubuntu_oscar
#    echo controle_ubuntu_partition=$controle_ubuntu_partition
#    echo partition_ubuntu=$partition_ubuntu
#    echo afficher_systeme_linux_installe=$afficher_systeme_linux_installe
#    echo reponse=$reponse

#    read m
####
if ! [ "$controle_ubuntu" = "" ] # mise a jour ubuntu ou nouvelle installation Ubuntu
then
	echo "$controle_ubuntu" > /tmp/tempubuntu
	cut -d";" -f2 /tmp/tempubuntu > /tmp/tempubuntu1
	cut -d"," -f1 /tmp/tempubuntu1 > /tmp/tempubuntu
	version_ubuntu=`cat /tmp/tempubuntu`
	echo $version_ubuntu > /tmp/tempubuntu1
	perl -pi -e 's/ /,/g;' /tmp/tempubuntu1
	cut -d"," -f1 /tmp/tempubuntu1 > /tmp/tempubuntu # pour ne prendre que le premier noyau ubuntu
	version_ubuntu=`cat /tmp/tempubuntu`
	rm -f /tmp/tempubuntu
	rm -f /tmp/tempubuntu1
	echo $version_ubuntu > /tmp/version_ubuntu
	if ( test -e $partition_montee_boot/vmlinuz-$version_ubuntu )
	then
		# prendre la ligne vmlinuz-$version_ubuntu:
		echo "grep -i \"vmlinuz-`cat /tmp/version_ubuntu`\" $partition_montee_boot/grub/menu.lst | grep -v \"single\" > /tmp/kernel_ligne_ubuntu" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		rm -f /tmp/exec_nom
		# si plusieurs lignes (modification manuelle) ne prendre que la premiere
		grep -ci "kernel" /tmp/kernel_ligne_ubuntu > /tmp/nombre_lignes_kernel
		nombre_lignes_kernel=`cat /tmp/nombre_lignes_kernel`
		rm -f /tmp/nombre_lignes_kernel
		if ! [ "$nombre_lignes_kernel" = "0" ]
		then # ne prendre que la premiere
			# supprimer les sauts de ligne:
			echo `gawk '{ print $0 "{" } ' /tmp/kernel_ligne_ubuntu` > /tmp/tempfileligne
			cut -d "{" -f1 /tmp/tempfileligne > /tmp/kernel_ligne_ubuntu # prend la premiere ligne
			rm -f /tmp/tempfileligne
		fi
		#ajouter /boot/ si nécessaire a la ligne kernel:
		if ( test -e $partition_montee_boot/boot/grub) ## verifie si contient pas juste boot seulement
		then
			grep -ci "boot\/vmlinuz" /tmp/kernel_ligne_ubuntu > /tmp/nombre_si_boot
			nombre_si_boot=`cat /tmp/nombre_si_boot`
			rm -f /tmp/nombre_si_boot
			if [ "$nombre_si_boot" = "0" ]
			then
				perl -pi -e 's/boot\/vmlinuz/vmlinuz/g;' /tmp/kernel_ligne_ubuntu
			fi
		fi

		# recuperer dans cette ligne la partition ubuntu et verifier
		cp -f /tmp/kernel_ligne_ubuntu /tmp/partition_temp
	    	grep -i "root=UUID" /tmp/partition_temp > /tmp/tempubuntu
    		controle_UUID=`cat /tmp/tempubuntu`
		if ! [ "$controle_UUID" = "" ]	# UUID existe
		then	# UUID existe
			perl -pi -e 's/root=UUID=/;/g;' /tmp/partition_temp
			# determiner si partition juste_boot ou partition ubuntu
			if ! [ "$partition_juste_boot" = "$reponse" ]	# partition ubuntu, prendre la valeur uuid de $reponse
			then
				if [ "$partition_ubuntu" = "rien_du_tout" ]	# partition ubuntu, prendre la valeur uuid de $reponse
				then
					partition_ubuntu=$reponse
					sortir_uuid_reponse
					uuid_ubuntu=`cat /tmp/uuid_ubuntu`
					rm -f /tmp/uuid_ubuntu
				fi
			fi
		else
			# determiner si partition juste_boot ou partition ubuntu
			if ! [ "$partition_juste_boot" = "$reponse" ]	# partition ubuntu, prendre la valeur uuid de $reponse
			then
				if [ "$partition_ubuntu" = "rien_du_tout" ]	# partition ubuntu, prendre sdai de $reponse
				then
					partition_ubuntu=$reponse
				fi
			fi
		fi
		numero_hd_ubuntu=`expr substr $partition_ubuntu 4 3` # numero du répertoire Ubuntu eventuel
		numero_hd_ubuntu=$[$numero_hd_ubuntu-1]
		partition_montee_boot_ubuntu=$partition_montee_boot
		echo "partition_linux_complete,$reponse" > /tmp/partition_temp
		enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
		if [ "$partition_juste_boot" != "$reponse" ]
		then
			echo "partition_linux_ubuntu,$reponse" > /tmp/partition_temp
			enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
			echo "partition_linux_ubuntu,$reponse" >> /tmp/fichier_partitions_boot
		fi
		if [ "$partition_ubuntu" = "rien_du_tout" ]	# partition ubuntu, prendre sdai de $reponse
		then
			cp -f /tmp/kernel_ligne_ubuntu /tmp/kernel_ligne_etude
			remplacer_rien_du_tout
			partition_ubuntu=$partition_etude
			numero_hd_ubuntu=$numero_hd_etude
			uuid_ubuntu=$uuid_etude
			trouver_numero_disque_grub=$partition_ubuntu
			recuperer_numero_disque_grub
			numero_disque_grub=$trouver_numero_disque_grub
		fi
		if ! ( [ "$partition_ubuntu" = "" ] || [ "$partition_ubuntu" = "rien_du_tout" ] )
		then
			verifier_version_titre_ubuntu
			grep -ci "partition_linux_juste_boot" /tmp/fichier_partitions_boot > /tmp/nb_juste_boot
			nb_juste_boot=`cat /tmp/nb_juste_boot`
			rm -f /tmp/nb_juste_boot
			if [ "$nb_juste_boot" != "0" ]
			then
				if [ "$partition_juste_boot" = "$reponse" ]	# partition juste boot
				then
					numero_partition_juste_grub=`expr substr $reponse 4 3` # numero du répertoire juste boot
					numero_partition_juste_grub=$[$numero_partition_juste_grub-1]
				fi
			else
				numero_partition_juste_grub=$numero_hd_ubuntu
			fi
			echo "$partition_ubuntu?$numero_hd_ubuntu?$uuid_ubuntu?`cat /tmp/kernel_ligne_ubuntu`?$version_ubuntu?$numero_disque_grub?$ubuntu_titre?$numero_disque_ubuntu?$numero_partition_juste_grub" >> /tmp/global_ubuntu	# pour plusieurs partitions ubuntu
		fi
	fi
elif ! [ "$controle_ubuntu_oscar" = "" ] # grub de partition oscar c'est le cas si erreur sur menu.lst, car reste celui d'oscar
then
	# prendre la ligne contenant vmlinuz-
	rm -f /tmp/temp
    	grep -i "vmlinuz-" $partition_montee_boot/grub/menu.lst > /tmp/temp
	controle_vmlinuz=`cat /tmp/temp`
	if ! [ "$controle_vmlinuz" = "" ]	# pour ne prendre les options que si vmlinuz- contenu
	then
	    cp /tmp/temp /tmp/kernel_ligne_ubuntu
	else
		if [ "$afficher_systeme_linux_installe" = "Mandriva" ]
		then
			grep -i "vmlinuz " $partition_montee_boot/grub/menu.lst | grep -i "silent" > /tmp/temp	# partition Mandriva
			controle_vmlinuz=`cat /tmp/temp`
			if ! [ "$controle_vmlinuz" = "" ]	# pour ne prendre les options Mandriva que si vmlinuz contenu
			then
				# enlever (hd0,i) devant /boot
				cut -d")" -f2 /tmp/temp > /tmp/temp1
				echo "kernel `cat /tmp/temp1`" > /tmp/kernel_ligne_ubuntu
				rm -f /tmp/temp
				rm -f /tmp/temp1
			fi
		fi
	fi
	rm -f /tmp/temp
    	controle_ubuntu_oscar=`cat /tmp/kernel_ligne_ubuntu`
	if ! [ "$controle_ubuntu_oscar" = "" ]
	then
		#ajouter /boot/ si nécessaire à la ligne kernel:
		if ( test -e $partition_montee_boot/boot/grub) ## verifie si contient pas juste boot seulement
		then
			grep -ci "boot\/vmlinuz" /tmp/kernel_ligne_ubuntu > /tmp/nombre_si_boot
			nombre_si_boot=`cat /tmp/nombre_si_boot`
			rm -f /tmp/nombre_si_boot
			if [ "$nombre_si_boot" = "0" ]
			then
				perl -pi -e 's/boot\/vmlinuz/vmlinuz/g;' /tmp/kernel_ligne_ubuntu
			fi
		fi
		# recupere la version :
		if ! [ "$afficher_systeme_linux_installe" = "Mandriva" ]
		then
			cp -f /tmp/kernel_ligne_ubuntu /tmp/tempubuntu
			perl -pi -e 's/vmlinuz-/{/g;' /tmp/tempubuntu
			cut -d"{" -f2 /tmp/tempubuntu > /tmp/tempubuntu1
			cut -d" " -f1 /tmp/tempubuntu1 > /tmp/tempubuntu
		
			version_ubuntu=`cat /tmp/tempubuntu`
			rm -f /tmp/tempubuntu
			rm -f /tmp/tempubuntu1
		else
			remplacer_resume_swap_uuid_mandriva
			version_ubuntu=
		fi
		echo $version_ubuntu > /tmp/version_ubuntu
		
		# récupérer dans cette ligne la partition ubuntu et vérifier
		cp -f /tmp/kernel_ligne_ubuntu /tmp/partition_temp
	    	grep -i "root=UUID" /tmp/partition_temp > /tmp/tempubuntu
    		controle_UUID=`cat /tmp/tempubuntu`
		if ! [ "$controle_UUID" = "" ]	# UUID existe
		then	# UUID existe
			perl -pi -e 's/root=UUID=/;/g;' /tmp/partition_temp
			# determiner si partition juste_boot ou partition ubuntu
			if ! [ "$partition_juste_boot" = "$reponse" ]	# partition ubuntu, prendre la valeur uuid de $reponse
			then
				if ! [ "$partition_ubuntu" = "rien_du_tout" ]	# partition ubuntu, prendre la valeur uuid de $reponse
				then
					partition_ubuntu=$reponse
					sortir_uuid_reponse
					uuid_ubuntu=`cat /tmp/uuid_ubuntu`
					rm -f /tmp/uuid_ubuntu
				fi
			fi
		else
			# determiner si partition juste_boot ou partition ubuntu
			if ! [ "$partition_juste_boot" = "$reponse" ]	# partition ubuntu, prendre la valeur uuid de $reponse
			then
				if [ "$partition_ubuntu" = "rien_du_tout" ]	# partition ubuntu, prendre sdai de $reponse
				then
					partition_ubuntu=$reponse
				fi
			fi
		fi
		numero_hd_ubuntu=`expr substr $partition_ubuntu 4 3` # numero du répertoire Ubuntu eventuel
		numero_hd_ubuntu=$[$numero_hd_ubuntu-1]
		partition_montee_boot_ubuntu=$partition_montee_boot
		echo "partition_linux_complete,$reponse" > /tmp/partition_temp
		enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
		if [ "$partition_juste_boot" != "$reponse" ]
		then
			echo "partition_linux_ubuntu,$reponse" > /tmp/partition_temp
			enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
			echo "partition_linux_ubuntu,$reponse" >> /tmp/fichier_partitions_boot
		fi
		if [ "$partition_ubuntu" = "rien_du_tout" ]	# partition ubuntu, prendre sdai de $reponse
		then
		    cp -f /tmp/kernel_ligne_ubuntu /tmp/kernel_ligne_etude
		    remplacer_rien_du_tout
		    partition_ubuntu=$partition_etude
		    numero_hd_ubuntu=$numero_hd_etude
		    uuid_ubuntu=$uuid_etude
		    trouver_numero_disque_grub=$partition_ubuntu
		    recuperer_numero_disque_grub
		    numero_disque_grub=$trouver_numero_disque_grub
		fi
		if ! ( [ "$partition_ubuntu" = "" ] || [ "$partition_ubuntu" = "rien_du_tout" ] )
		then
			verifier_version_titre_ubuntu
			grep -ci "partition_linux_juste_boot" /tmp/fichier_partitions_boot > /tmp/nb_juste_boot
			nb_juste_boot=`cat /tmp/nb_juste_boot`
			rm -f /tmp/nb_juste_boot
			if [ "$nb_juste_boot" != "0" ]
			then
				if [ "$partition_juste_boot" = "$reponse" ]	# partition juste boot
				then
					numero_partition_juste_grub=`expr substr $reponse 4 3` # numero du répertoire juste boot
					numero_partition_juste_grub=$[$numero_partition_juste_grub-1]
				fi
			else
				numero_partition_juste_grub=$numero_hd_ubuntu
			fi
			echo "$partition_ubuntu?$numero_hd_ubuntu?$uuid_ubuntu?`cat /tmp/kernel_ligne_ubuntu`?$version_ubuntu?$numero_disque_grub?$ubuntu_titre?$numero_disque_ubuntu?$numero_partition_juste_grub" >> /tmp/global_ubuntu	# pour plusieurs partitions ubuntu
		fi
	fi
fi
}
#----------------------------------------------------------------------------------------------------
verifier_version_titre_ubuntu()	# pour corriger eventuellement en remplacant non utile pour mandriva
{
if ! [ "$afficher_systeme_linux_installe" = "Mandriva" ]
then
	#	ubuntu titre:
	if ( test -e /mnt/$partition_ubuntu/etc/lsb-release )
	then
		grep -i "DESCRIPTION" /mnt/$partition_ubuntu/etc/lsb-release > /tmp/temp
		perl -pi -e 's/DISTRIB_DESCRIPTION=//g; s/\"//g;' /tmp/temp
		ubuntu_titre=`cat /tmp/temp`
	fi
	if [ "$partition_juste_boot" = "" ] || [ "$partition_juste_boot" = "pas_juste_boot" ]
	then
		if ( test -e /mnt/$partition_ubuntu/boot )
		then
			ls -t /mnt/$partition_ubuntu/boot > /tmp/temp
		else
			echo "" > /tmp/temp
		fi
	else	# partition juste boot
		ls -t /mnt/$partition_juste_boot > /tmp/temp
	fi
	
	grep -i "vmlinuz-" /tmp/temp > /tmp/temp1			#recupere les ligne des versions
	grep -ci "vmlinuz-" /tmp/temp > /tmp/nombre_temp1
	nombre_temp1=`cat /tmp/nombre_temp1`
	if ! [ "$nombre_temp1" = "0" ]
	then
		grep -n "vmlinuz-" /tmp/temp1 > /tmp/temp 	# ajoute le numero de ligne et :
		#recupere la ligne 1: derniere version
		echo "perl -pi -e 's/1:/__derniere_version__/g;' /tmp/temp" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		grep -i "__derniere_version__" /tmp/temp > /tmp/temp1
		perl -pi -e 's/__derniere_version__//g;' /tmp/temp1
		cut -d"," -f2 /tmp/temp1 > /tmp/temp
		cp -f /tmp/temp /tmp/temp_version_ubuntu
		perl -pi -e 's/vmlinuz-//g;' /tmp/temp_version_ubuntu
		version_ubuntu=`cat /tmp/temp_version_ubuntu`	# derniere version de la forme 2.6.24-19-generic
		
		# remplacer la version_ubuntu corrigee dans /tmp/kernel_ligne_ubuntu
		perl -pi -e 's/vmlinuz-/vmlinuz-{/g; s/-generic/{-generic/g;' /tmp/temp
		cut -d"{" -f2 /tmp/temp > /tmp/temp_numero_derniere_version
		cp -f /tmp/kernel_ligne_ubuntu /tmp/ligne1
		perl -pi -e 's/vmlinuz-/vmlinuz-{/g; s/-generic/{-generic/g;' /tmp/ligne1
		cut -d"{" -f2 /tmp/ligne1 > /tmp/temp_numero_version_initiale
		echo "perl -pi -e 's/`cat /tmp/temp_numero_version_initiale`/`cat /tmp/temp_numero_derniere_version`/g;' /tmp/kernel_ligne_ubuntu" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		rm -f /tmp/exec_nom
		rm -f /tmp/ligne1
		rm -f /tmp/temp_numero_version_initiale
		rm -f /tmp/temp_numero_derniere_version
	fi
fi
rm -f /tmp/temp
rm -f /tmp/temp1
rm -f /tmp/nombre_temp1
##### 	DEBUG
# 	read m
}
#----------------------------------------------------------------------------------------------------
faire_variables_partition_mandriva()
{
partition_mandriva=$reponse
numero_hd_mandriva=`expr substr $partition_mandriva 4 3` # numero du répertoire mandriva eventuel
numero_hd_mandriva=$[$numero_hd_mandriva-1]
partition_montee_boot_mandriva=$partition_montee_boot
echo "partition_linux_complete,$reponse" > /tmp/partition_temp
enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
if [ "$partition_juste_boot" != "$reponse" ]
then
	echo "partition_linux_mandriva,$reponse" > /tmp/partition_temp
	enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
	echo "partition_linux_mandriva,$reponse" >> /tmp/fichier_partitions_boot
fi
if ( test -e /tmp/uuid_mandriva )
then
	uuid_mandriva=`cat /tmp/uuid_mandriva`
fi
trouver_numero_disque_grub=$partition_mandriva
recuperer_numero_disque_grub
numero_disque_grub=$trouver_numero_disque_grub
rm -f /tmp/uuid_ubuntu
rm -f /tmp/uuid_mandriva
verif_kernel_ligne_mandriva=
if ( test -e /tmp/kernel_ligne_mandriva )
then
	verif_kernel_ligne_mandriva=`cat /tmp/kernel_ligne_mandriva`
fi
if ! ( [ "$verif_kernel_ligne_mandriva" = "" ]  || [ "$partition_mandriva" = "" ] || [ "$partition_mandriva" = "rien_du_tout" ] )
then
	echo "$partition_mandriva?$numero_hd_mandriva?$uuid_mandriva?`cat /tmp/kernel_ligne_mandriva`?$version_mandriva?numero_disque_grub" >> /tmp/global_mandriva	# pour plusieurs partitions mandriva
fi
#    echo "$partition_mandriva?$numero_hd_mandriva?$uuid_mandriva?" >> /tmp/global_mandriva	# pour plusieurs partitions mandriva
}
#----------------------------------------------------------------------------------------------------
teste_partition_mandriva()	# ou autre linux
{
	# teste partition linux pour oscar, pour cela demander un nouveau menu.lst de la forme:
	#oscar#title Mandriva
	#oscar#kernel (hd0,0)/boot/vmlinuz root=/dev/hda1  resume=/dev/hda5 splash=silent vga=788
	#oscar#initrd (hd0,0)/boot/initrd.img

controle_mandriva=
if ( test -e $partition_montee_boot/grub/menu.lst )
then
	if ! ( test -e /tmp/tempmandriva )
	then
		grep -i "#oscar#" $partition_montee_boot/grub/menu.lst > /tmp/tempmandriva
		perl -pi -e 's/#oscar#//g;' /tmp/tempmandriva
	else
		test_tempmandriva=`cat /tmp/tempmandriva`
		if ! [ "$test_tempmandriva" = "" ]
		then
			stat -c %Z $partition_montee_boot/grub/menu.lst > /tmp/date_menu.lst
			stat -c %Z /tmp/tempmandriva > /tmp/date_chgt_tempmandriva
			date_menu_lst=`cat /tmp/date_menu.lst`
			date_chgt_tempmandriva=`cat /tmp/date_chgt_tempmandriva`
			test_negative=$[$date_chgt_tempmandriva-$date_menu_lst]
			signe_test_negative=`expr substr $test_negative 1 1` # valeur - ou non
			if [ "$signe_test_negative" = "-" ]	# prendre le nouveau menu.lst pour reparer le boot
			then
				grep -i "#oscar#" $partition_montee_boot/grub/menu.lst > /tmp/tempmandriva
				perl -pi -e 's/#oscar#//g;' /tmp/tempmandriva
			fi
			rm -f /tmp/date_menu.lst
			rm -f /tmp/date_chgt_tempmandriva
		else
			grep -i "#oscar#" $partition_montee_boot/grub/menu.lst > /tmp/tempmandriva
			perl -pi -e 's/#oscar#//g;' /tmp/tempmandriva
		fi
	fi
	controle_mandriva=`cat /tmp/tempmandriva`
	if ! [ "$controle_mandriva" = "" ] # partition Mandriva
	then
		if ! [ "$partition_juste_boot" = "$reponse" ]	# partition non juste_boot
		then
			# oui si menu.lst sur partition mandriva sinon reponse est la partition_juste_boot
			faire_variables_partition_mandriva
		fi
	fi
else # verifier si partition mandriva ou autre sans repertoire boot
	if ( test -e /mnt/$reponse/etc/release )
	then
		faire_variables_partition_mandriva
	fi
fi

if ! [ "$controle_mandriva" = "" ]
then
	# récupérer dans la ligne kernel root le titre :
	cp -f /tmp/tempmandriva /tmp/partition_temp
	grep -i "title" /tmp/tempmandriva > /tmp/temp_title
	if ( test -e /tmp/temp_title )
	then
		cut -d" " -f2 /tmp/temp_title > /tmp/title_ligne_mandriva
	fi
	title_ligne_mandriva=`cat /tmp/title_ligne_mandriva`
	rm -f /tmp/title_ligne_mandriva
	rm -f /tmp/temp_title
	
	# récupérer dans la ligne kernel root la partition mandriva et vérifier
	cp -f /tmp/tempmandriva /tmp/partition_temp
	grep -i "kernel" /tmp/tempmandriva > /tmp/temp
	perl -pi -e 's/vmlinuz/vmlinuz;/g;' /tmp/temp
	cut -d";" -f2 /tmp/temp > /tmp/kernel_ligne_mandriva

	grep -i "initrd" /tmp/tempmandriva > /tmp/temp
	perl -pi -e 's/initrd / /g; s/initrd/;/g;' /tmp/temp
	cut -d";" -f2 /tmp/temp > /tmp/temp1
	version_mandriva=`cat /tmp/temp1`
	rm -f /tmp/temp
	rm -f /tmp/temp1
	# récupérer dans cette ligne la partition mandriva et vérifier
	cp -f /tmp/kernel_ligne_mandriva /tmp/partition_temp
    	grep -i "UUID" /tmp/partition_temp > /tmp/temp3_uuid
	controle_UUID=`cat /tmp/temp3_uuid`
	rm -f /tmp/temp3_uuid
	if ! [ "$controle_UUID" = "" ]	# UUID existe
	then	# UUID existe
		perl -pi -e 's/root=UUID=/;/g;' /tmp/partition_temp
		# determiner si partition juste_boot ou partition ubuntu
		if ! [ "$partition_juste_boot" = "$reponse" ]	# partition ubuntu, prendre la valeur uuid de $reponse
		then
			if ! [ "$partition_mandriva" = "rien_du_tout" ]	# partition ubuntu, prendre la valeur uuid de $reponse
			then
				partition_mandriva=$reponse
				sortir_uuid_reponse
				uuid_mandriva=`cat /tmp/uuid_ubuntu`
				rm -f /tmp/uuid_ubuntu
			fi
		fi
	else
		# determiner si partition juste_boot ou partition ubuntu
		if ! [ "$partition_juste_boot" = "$reponse" ]	# partition ubuntu, prendre la valeur uuid de $reponse
		then
			if [ "$partition_mandriva" = "rien_du_tout" ]	# partition ubuntu, prendre sdai de $reponse
			then
			partition_mandriva=$reponse
			fi
		fi
	fi
        numero_hd_mandriva=`expr substr $partition_mandriva 4 3` # numero du répertoire mandriva
        numero_hd_mandriva=$[$numero_hd_mandriva-1]
	partition_montee_boot_mandriva=$partition_montee_boot
	echo "partition_linux_complete,$reponse" > /tmp/partition_temp
	enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
	if [ "$partition_juste_boot" != "$reponse" ]
	then
		echo "partition_linux_mandriva,$reponse" > /tmp/partition_temp
		enlever_partition_si_existe	# si elle existe supprimer la ligne de cette partition ou pour éviter les doubles
		echo "partition_linux_mandriva,$reponse" >> /tmp/fichier_partitions_boot
	fi
	if [ "$partition_mandriva" = "rien_du_tout" ]	# partition mandriva, prendre sdai de $reponse
	then
		cp -f /tmp/kernel_ligne_mandriva /tmp/kernel_ligne_etude
		remplacer_rien_du_tout
		partition_mandriva=$partition_etude
		numero_hd_mandriva=$numero_hd_etude
		uuid_mandriva=$uuid_etude
		trouver_numero_disque_grub=$partition_mandriva
		recuperer_numero_disque_grub
		numero_disque_grub=$trouver_numero_disque_grub
	fi
	
	# test uuid partition mandriva
	blkid | grep -i "$uuid_mandriva" > /tmp/test_uuid_partition
	test_uuid_partition=`cat /tmp/test_uuid_partition`
	rm -f /tmp/test_uuid_partition
	if [ "$test_uuid_partition" = "" ]
	then
		ancien_uuid_partition=$uuid_mandriva
		echo "$partition_mandriva" > /tmp/temp_sdai
		remplacer_sdai_par_uuid	# sdai dans /tmp/temp_sdai resultat dans /tmp/temp_sdai
		uuid_mandriva=`cat /tmp/temp_sdai`
		rm -f tmp/temp_sdai
		echo "perl -pi -e 's/$ancien_uuid_partition/$uuid_mandriva/g;' /tmp/kernel_ligne_mandriva" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		rm -f /tmp/exec_nom
	fi
	
	if ! ( [ "$partition_mandriva" = "" ] || [ "$partition_mandriva" = "rien_du_tout" ] )
	then
		echo "$partition_mandriva?$numero_hd_mandriva?$uuid_mandriva?`cat /tmp/kernel_ligne_mandriva`?$version_mandriva?$numero_disque_grub?$title_ligne_mandriva" >> /tmp/global_mandriva	# pour plusieurs partitions mandriva
	fi
fi
}
#----------------------------------------------------------------------------------------------------
teste_autres_systemes_linux()
{
teste_partition_ubuntu
if ! [ "$afficher_systeme_linux_installe" = "Mandriva" ]
then
	teste_partition_mandriva
fi
#	DEBUG:
#	echo teste $reponse
#	cat /tmp/global_ubuntu
#	read m
}
#----------------------------------------------------------------------------------------------------
enlever_partition_si_existe()	# besoin du fichier /tmp/partition_temp
{
# dans /tmp/partition_temp il y a partition_linux_..,$reponse
# si elle existe supprimer la ligne de cette partition pour éviter les doubles
# on peut enlever sda1 qui enlève aussi sda10 pas encore là
echo "grep -v \"`cat /tmp/partition_temp`\" /tmp/fichier_partitions_boot > /tmp/partition_temp1" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
cp -f /tmp/partition_temp1 /tmp/fichier_partitions_boot

if ( test -e /tmp/global_ubuntu )
then
	echo "$reponse" > /tmp/partition_temp
	# on peut enlever sda1 qui enlève aussi sda10 pas encore là
	echo "grep -v \"`cat /tmp/partition_temp`\" /tmp/global_ubuntu > /tmp/partition_temp1" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	cp -f /tmp/partition_temp1 /tmp/global_ubuntu
fi
if ( test -e /tmp/global_mandriva )
then
	echo "$reponse" > /tmp/partition_temp
	# on peut enlever sda1 qui enlève aussi sda10 pas encore là
	echo "grep -v \"`cat /tmp/partition_temp`\" /tmp/global_mandriva > /tmp/partition_temp1" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	cp -f /tmp/partition_temp1 /tmp/global_mandriva
fi

rm -f /tmp/exec_nom
rm -f /tmp/partition_temp
rm -f /tmp/partition_temp1
}
#----------------------------------------------------------------------------------------------------
ajouter_si_partition_existe_pas()
{
if ( test -e /tmp/fichier_partitions_boot )
then
	echo "grep -ci \"`cat /tmp/partition_temp`\" /tmp/fichier_partitions_boot > /tmp/partition_temp1" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	partition_existe=`cat /tmp/partition_temp1`
	if [ "$partition_existe" = "0" ]
	then
	    echo "partition_linux_complete,$reponse" >> /tmp/fichier_partitions_boot
	fi
else
	echo "partition_linux_complete,$reponse" >> /tmp/fichier_partitions_boot
fi
if ( test -e /mnt/$reponse/oscar )
then
	echo "$reponse" > /tmp/partition_oscar_trouvee
fi

rm -f /tmp/exec_nom
rm -f /tmp/partition_temp
	rm -f /tmp/partition_temp1
}
#----------------------------------------------------------------------------------------------------
comparer_grub_conf_menu_lst()
{
diff $partition_montee/grub/menu.lst $partition_montee/grub/grub.conf 2>/dev/null 1>/dev/null
egalite=$?
if ! [ "$egalite" = "0" ]
then        # les fichiers ne sont pas egaux donc changer menu.lst.ini car mise a jour ubuntu mandriva ...
	cp -f $partition_montee/grub/menu.lst $partition_montee/grub/menu.lst.init
fi
}
#----------------------------------------------------------------------------------------------------
realise_uuid_des_partitions()
{
cut -d";" -f2 /tmp/temp1 > /tmp/temp	#hdaiii
partition_sdai=`cat /tmp/temp`
if ! [ "$partition_sdai" = "" ]
then
	sortir_uuid_partition_sdai
	uuid_partition_sdai=`cat /tmp/uuid_partition_sdai`
	rm -f /tmp/uuid_partition_sdai

	echo "$partition_sdai,$uuid_partition_sdai" >> /tmp/uuid_tableau
	echo "perl -pi -e 's/;$partition_sdai;/;/g;' /tmp/temp1" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	valeur_intermediaire=`cat /tmp/temp1`
	echo "$valeur_intermediaire;" > /tmp/temp1
	rm -f /tmp/exec_nom
	realise_uuid_des_partitions
else
    rm -f /tmp/temp
    rm -f /tmp/temp1
    return
fi
}
#----------------------------------------------------------------------------------------------------
boucle_partition_UUID() # faire le tableau sdai,uuid
{
runme info_ddialog
# fdisk -l 2>/dev/null > /tmp/fichier_disque
grep -i "^\/dev\/" /tmp/fichier_disque_dur | grep -v "dev\/dm-" > /tmp/temp
echo `gawk '{ print $1 " " } ' /tmp/temp` > /tmp/temp1
perl -pi -e 's/ //g; s/\/dev\//;/g;' /tmp/temp1 # sda1;sda2;
rm -f /tmp/uuid_tableau
realise_uuid_des_partitions
}
#----------------------------------------------------------------------------------------------------
remplacer_uuid_par_sdai()	# uuid dans /tmp/temp_sdai resultat dans /tmp/temp_sdai
{
boucle_partition_UUID # faire le tableau sdai,uuid
echo "grep -i \",`cat /tmp/temp_sdai`\" /tmp/uuid_tableau > /tmp/temp1 2>/dev/null" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
cut -d"," -f1 /tmp/temp1 > /tmp/temp_sdai	#hdaiii
}
#----------------------------------------------------------------------------------------------------
remplacer_sdai_par_uuid()	# sdai dans /tmp/temp_sdai resultat dans /tmp/temp_sdai
{
boucle_partition_UUID # faire le tableau sdai,uuid
echo "grep -i \"`cat /tmp/temp_sdai`,\" /tmp/uuid_tableau > /tmp/temp1 2>/dev/null" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
cut -d"," -f2 /tmp/temp1 > /tmp/temp_sdai	#hdaiii
}
#----------------------------------------------------------------------------------------------------
boucle_partition() # sortir la partition  /boot dans la reponse utilisé seulement pour le type linux
{
rm -f /tmp/tempfile
echo "$type" > /tmp/tempfile
runme prepare_boucle_partition
nombretype=`cat /tmp/nombre`
rm -f /tmp/nombre
if [ "$type" = "linux" ] # tjs le cas car boucle_partition seulement pour partitions linux
then 
	if [ "$nombretype" = "0" ] # pas de partition linux ni swap
	then 
		# pas de partition linux
		rm -f /tmp/tempfile
		dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
		--ok-label "`cat $chemin_langue/Continuer`" \
		--title " `cat $chemin_langue/DESOLE` " \
		--msgbox "\n\n`cat $chemin_langue/msgbox_44`" 9 60
		exit
	fi
fi

rm -f /tmp/fichier_partitions_boot
rm -f /tmp/partition_oscar_trouvee
partition_ubuntu=rien_du_tout
partition_mandriva=rien_du_tout
uuid_ubuntu=rien_du_tout
uuid_mandriva=rien_du_tout
rm -f /tmp/kernel_ligne_ubuntu
rm -f /tmp/kernel_ligne_mandriva
	rm -f /tmp/global_ubuntu	# pour plusieurs partitions ubuntu
	rm -f /tmp/global_mandriva	# pour plusieurs partitions mandriva

cp -f /tmp/tempfile /tmp/tempboucle
rm -f /tmp/tempfile
numero=0
until  ( test  $numero = $nombretype )
do
	rm -f /tmp/temp_ligne_deux_points1
#	rm -f /tmp/partfile1
	numero=$[$numero+1]
	cut -d":" -f$numero /tmp/tempboucle > /tmp/temp_ligne_deux_points1	#hdaiii
#	cut -d":" -f$numero /tmp/partfile > /tmp/partfile1	#ide/h0/b0/t0/l0/hdaiii
	reponse=`cat /tmp/temp_ligne_deux_points1`
#	reparti=`cat /tmp/partfile1`
	rm -f /tmp/temp_ligne_deux_points1
	if ! [ "$reponse" = "" ] # si la partition existe
	then 
		numero_hd=`expr substr $reponse 4 3`
		disque=`expr substr $reponse 1 3`       #hda
#		disque=`cut -d/ -f1-5 /tmp/partfile1`/disc	#ide/h0/b0/t0/l0/disc
#		rm -f /tmp/partfile1
	        if [ "$type" = "linux" ]
		then
	        	# id_type=`sfdisk /dev/$disque -c $numero_hd 2>/dev/null`
			grep -i $reponse /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
		        nb_partition_linux=`cat /tmp/nb_partition_linux`
		        rm -f /tmp/nb_partition_linux
			if [ "$nb_partition_linux" = "1" ] # partition linux non swap
			then
				nombre_partitions_linux=$nombretype
				if [ "$nombre_partitions_linux" = "1" ]
				then
					if ( test -e $partition_montee/etc )
					then
						if ! ( test -e $partition_montee/usr/share/oscar )
						then
							# pas de partition linux
							rm -f /tmp/tempboucle
							dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
							--ok-label "`cat $chemin_langue/Continuer`" \
							--title " `cat $chemin_langue/DESOLE` " \
							--msgbox "\n\n`cat $chemin_langue/msgbox_55`\Zn " 9 68
							exit
						fi
					fi
					echo "partition_linux_unique,$reponse" >> /tmp/fichier_partitions_boot
					rm -f /tmp/tempboucle
					#	rm -f /tmp/partfile
					return
				else
					# chercher si partition avec seulement boot,  /grub
					# monter la partition reponse
					echo "$reponse" > /tmp/monter_partition
		                        runme autoriser_monter_partition_oscar 2>/dev/null
		                        partition_montee=`cat /tmp/monter_partition`
		                        rm -f /tmp/monter_partition
					if ( test -e $partition_montee/grub/menu.lst) || ( test -e $partition_montee/grub/grub.cfg ) ## verifie si contient /grub pour boot seulement
					then
						partition_juste_boot=$reponse
						echo "partition_linux_juste_boot,$reponse" >> /tmp/fichier_partitions_boot
						if (test -e $partition_montee/grub/menu.lst.init )
						then
							comparer_grub_conf_menu_lst
							cp -f $partition_montee/grub/menu.lst $partition_montee/grub/menu.lst.old
							if ! [ "$serveur_grub" = "oui" ] # pas serveur ou pas client
							then
								if ! ( test -e /etc/lilo_expert )
								then
									if (test -e $partition_montee/grub/menu.lst)
									then
										cp -f $partition_montee/grub/menu.lst.init $partition_montee/grub/menu.lst
									fi
								fi
						    	else
								if [ "$client_lance" = "oui" ]	# si client
								then
									if (test -e $partition_montee/grub/menu.lst)
									then
										if ! ( test -e /etc/grub.conf.expert )
										then
											cp -f $partition_montee/grub/menu.lst.init $partition_montee/grub/menu.lst
										else
											cp -f /etc/grub.conf.expert $partition_montee/grub/menu.lst
										fi
									fi
						    		fi						    	
						    	fi
						fi
						# chercher si partition ubuntu ou mandriva
						partition_montee_boot=$partition_montee
						teste_autres_systemes_linux
					elif ( test -e $partition_montee/usr/share/oscar ) ## verifie si contient oscar
					then
						partition_avec_oscar=$reponse
						echo "partition_avec_oscar,$reponse" >> /tmp/fichier_partitions_boot
					elif ( test -e $partition_montee/cd_oscar ) ## verifie si contient oscar si client
					then
						partition_avec_oscar=$reponse
						echo "partition_avec_oscar,$reponse" >> /tmp/fichier_partitions_boot
					elif ( test -e $partition_montee/boot/grub/menu.lst ) ## verifie si contient ubuntu ou mandriva autre
					then
						echo "$reponse" > /tmp/partition_temp
						ajouter_si_partition_existe_pas	# si elle existe ne pas ajouter cette partition pour éviter les doubles
						partition_montee_boot=$partition_montee/boot
						teste_autres_systemes_linux	# supprime aussi cette partition si autre système
					elif ( test -e $partition_montee/etc/init.d ) ## verifie si systeme linux installé
					then
						echo "$reponse" > /tmp/partition_temp
						ajouter_si_partition_existe_pas	# si elle existe ne pas ajouter cette partition pour éviter les doubles
						partition_montee_boot=$partition_montee/boot
						teste_autres_systemes_linux	# supprime aussi cette partition si autre système
					else # autre partition linux
						partition_avec_oscar=$reponse
						echo "partition_linux_donnees,$reponse" >> /tmp/fichier_partitions_boot	
					fi
					if ! [ "$partition_montee" = "" ]
					then
						umount $partition_montee 2>/dev/null ; sync
					fi
				fi
			fi
		fi
	fi
#	rm -f /tmp/partfile1
done
rm -f /tmp/tempboucle
}
#----------------------------------------------------------------------------------------------------
boite_erreur_plusieurs_partitions_oscar()
{
# erreur plusieurs partitions OSCAR
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--ok-label "`cat $chemin_langue/Continuer`"  \
	--msgbox "\n\n `cat $chemin_langue/msgbox_56`\n\n\n" 16 80
	case $? in
    0) 	echo "" > /tmp/sortir
    exit
    ;;
    255) echo "" > /tmp/sortir
    exit
    ;;
esac
}
#----------------------------------------------------------------------------------------------------
determiner_partition_linux_boot()
{
# etude du fichier /tmp/fichier_partitions_boot:
# proposer partitions oscar et les linux autres que boot, ubuntu et mandriva
# partition_linux_unique
# partition_linux_juste_boot
# partition_avec_oscar
# partition_linux_complete
# partition_linux_ubuntu
# partition_linux_mandriva
# partition_linux_donnees

# si partition_linux_unique choisir pour boot cette partition
# si partition_linux_juste_boot choisir pour boot cette partition
# sinon : proposer les autres partitions partition_linux_complete et partition_avec_oscar

# partition_linux_unique
grep -ci "partition_linux_unique" /tmp/fichier_partitions_boot > /tmp/tempfile
nombre_partition_linux_unique=`cat /tmp/tempfile`
grep -ci "partition_linux_juste_boot" /tmp/fichier_partitions_boot > /tmp/tempfile
nombre_partition_linux_juste_boot=`cat /tmp/tempfile`
grep -ci "partition_avec_oscar" /tmp/fichier_partitions_boot > /tmp/tempfile
nombre_partition_linux_avec_oscar=`cat /tmp/tempfile`

	# les 8 lignes suivantes sont maintenant inutiles car faites dans boucle_partition
	if [ "$partition_ubuntu" = "" ]
	then
	    partition_ubuntu=rien_du_tout
	fi
	if [ "$partition_mandriva" = "" ]
	then
	    partition_mandriva=rien_du_tout
	fi
chercher_numero_disque_grub_partition_juste_boot=non
if [ "$nombre_partition_linux_unique" = "1" ]
then
	grep -i "partition_linux_unique" /tmp/fichier_partitions_boot > /tmp/tempfile_unique
	cut -d"," -f2 /tmp/tempfile_unique > /tmp/tempfile
	rm -f /tmp/tempfile_unique
	partition_linux=`cat /tmp/tempfile`
	rm -f /tmp/tempfile
    	numero_hd_boot_grub=`expr substr $partition_linux 4 3`	# numero du répertoire de boot/grub
	echo "$partition_linux" > /tmp/partition_boot_grub
	numero_hd_boot_grub=$[$numero_hd_boot_grub-1]
	numero_hd_oscar=$numero_hd_boot_grub			# numero du répertoire oscar
elif [ "$nombre_partition_linux_juste_boot" = "1" ]
then
	grep -i "partition_linux_juste_boot" /tmp/fichier_partitions_boot > /tmp/tempfile
	cut -d"," -f2 /tmp/tempfile > /tmp/tempfile1
	partition_boot_grub=`cat /tmp/tempfile1`
	
	rm -f /tmp/tempfile
	rm -f /tmp/tempfile1
	numero_hd_boot_grub=`expr substr $partition_boot_grub 4 3`	# numero du répertoire de boot/grub linux_juste_boot
	echo "$partition_boot_grub" > /tmp/partition_boot_grub
	numero_hd_boot_grub=$[$numero_hd_boot_grub-1]
	# voir fin du sous programme pour valeur disque numero_disque_grub_partition_juste_boot
	chercher_numero_disque_grub_partition_juste_boot=oui
	
	# cherche autre partition linux pour oscar et trouver numero_hd_oscar
	# proposer la partition_avec_oscar et les partition_linux_complete
	if [ "$serveur_grub" = "oui" ]
	then
		# chercher la partition_avec_oscar:
		if [ "$nombre_partition_linux_avec_oscar" = "1" ]
		then
			grep -i "partition_avec_oscar" /tmp/fichier_partitions_boot > /tmp/tempfile
			cut -d"," -f2 /tmp/tempfile > /tmp/tempfile1

			partition_linux=`cat /tmp/tempfile1`
			numero_hd_oscar=`expr substr $partition_linux 4 3`
			numero_hd_oscar=$[$numero_hd_oscar-1]
			# numero_hd_oscar=$numero_hd_boot_grub			# numero du répertoire oscar
			rm -f /tmp/tempfile
			rm -f /tmp/tempfile1
		else	# plus d'une partition_avec_oscar demander celle pour le client:
			boite_erreur_plusieurs_partitions_oscar
		fi
	else
		if ! ( test -e /tmp/partition_installer_oscar )
		then
			boite_partition_linux	# pas si client_multi ou client_clone ou deja trouve par maj_boot_oscar
			echo "$partition_linux" > /tmp/partition_installer_oscar
		else
			partition_linux=`cat /tmp/partition_installer_oscar`
		fi
		numero_hd_oscar=`expr substr $partition_linux 4 3`		# numero du répertoire oscar
		numero_hd_oscar=$[$numero_hd_oscar-1]
	fi
else
	# ici numero_hd_boot_grub=numero_hd_oscar
	# proposer la partition_avec_oscar et les partition_linux_complete
	if [ "$serveur_grub" = "oui" ] || ! [ "$commande_installe_resolution_lancee" = "non" ]	### ne pas demander les partitions linux deja choisie si résolution demandée
	then
	    if [ "$nombre_partition_linux_avec_oscar" = "1" ]
	    then
		grep -i "partition_avec_oscar" /tmp/fichier_partitions_boot > /tmp/tempfile
		cut -d"," -f2 /tmp/tempfile > /tmp/tempfile1
		partition_linux=`cat /tmp/tempfile1`
		rm -f /tmp/tempfile
		rm -f /tmp/tempfile1
	    else
	    	if [ "$serveur_grub" = "oui" ]	# plusieurs partitions oscar sur le poste : interdit
	    	then
	    		boite_erreur_plusieurs_partitions_oscar
	    	else
			if ! ( test -e /tmp/partition_installer_oscar )
			then
				boite_partition_linux	# pas si client_multi ou client_clone ou deja trouve par maj_boot_oscar
				echo "$partition_linux" > /tmp/partition_installer_oscar
			else
				partition_linux=`cat /tmp/partition_installer_oscar`
			fi
		fi
	    fi
	else
		if ! ( test -e /tmp/partition_installer_oscar )
		then
			boite_partition_linux	# pas si client_multi ou client_clone ou deja trouve par maj_boot_oscar
			echo "$partition_linux" > /tmp/partition_installer_oscar
		else
			partition_linux=`cat /tmp/partition_installer_oscar`
		fi
	fi
	numero_hd_oscar=`expr substr $partition_linux 4 3`	# numero du répertoire oscar
	echo "$partition_linux" > /tmp/partition_boot_grub
	numero_hd_oscar=$[$numero_hd_oscar-1]
	numero_hd_boot_grub=$numero_hd_oscar			# numero du répertoire de boot/grub
	
fi

partition_installer_oscar=$partition_linux	# numero du répertoire oscar
echo "$partition_installer_oscar" > /tmp/partition_installer_oscar
if ! [ "$serveur_lance" = "oui" ]
then
	if [ "$chercher_numero_disque_grub_partition_juste_boot" = "oui" ]
	then
		chercher_disque_oscar_pour_grub
		trouver_numero_disque_grub=$partition_boot_grub
		recuperer_numero_disque_grub
		numero_disque_grub_partition_juste_boot=$trouver_numero_disque_grub
	fi
fi
}
#----------------------------------------------------------------------------------------------------
boite_info_resolution()	## info fin resolution
{
# Modification de l'affichage
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" --no-cancel \
	--title " Modification de l'affichage " \
	--menu "\n\Zb\Z3   Fin du changement d'affichage\n\n" 10 66 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_318`" \
	"" "" \
	"" "" \
	"" "\Z2Cette modification sera effective au \Zb\Z4prochain \Zn\Z2démarrage. " \
	"" ""
case $? in
    0)	return;;
    255) if ! [ "$partition_linux" = "" ]
	then
		umount $partition_montee 2>/dev/null ; sync
	fi
    exit;;
esac
}
#-----------------------------------------------------------------------------------------------------
boite_info_fin() # info de la fin
{
rm -f /tmp/tempfile
rm -f /tmp/tempfile1

if [ "$type_boot" = "lilo" ]
then
	touche_clavier=Majuscule
else
	touche_clavier=Echappe
fi

if ( test -e /etc/lilo_expert )
then
	echo "`cat $chemin_langue/menu_311`" > /tmp/tempfile2
	echo "" > /tmp/tempfile3
	echo "`cat $chemin_langue/menu_312`" > /tmp/tempfile1
	echo "`cat $chemin_langue/menu_313`" > /tmp/tempfile
else
	echo "`cat $chemin_langue/menu_314` \Zb\Z7$touche_clavier" > /tmp/tempfile2
	echo "`cat $chemin_langue/menu_315`" > /tmp/tempfile3
	echo "" > /tmp/tempfile
	echo "" > /tmp/tempfile1
fi
if [ "$type_boot" = "lilo" ]
then
	touche_clavier=Majuscule
else
	touche_clavier=Echappe
fi
# Installation des fichiers OSCAR sur le poste 
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" --no-cancel \
	--title " `cat $chemin_langue/menu_316` " \
	--menu "\n\Zb\Z3   `cat $chemin_langue/menu_317`\n\n" 10 80 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_318`" \
	"" "" \
	"" "" \
	"" "\Z2`cat /tmp/tempfile2`\Zn " \
	"" "\Z2`cat /tmp/tempfile3`\Zn " \
	"" "" \
	"" "`cat $chemin_langue/menu_319`" \
	"" "" \
	"" "`cat /tmp/tempfile1`" \
	"" "\Z2`cat /tmp/tempfile`" \
	"" ""
case $? in
    0)	rm -f /tmp/tempfile
	rm -f /tmp/tempfile1
	rm -f /tmp/tempfile2
	rm -f /tmp/tempfile3
    	return;;
    255) rm -f /tmp/tempfile
	rm -f /tmp/tempfile1
	rm -f /tmp/tempfile2
	rm -f /tmp/tempfile3
	if ! [ "$partition_montee" = "" ]
	then
		umount $partition_montee 2>/dev/null ; sync
	fi
    	exit;;
esac
rm -f /tmp/tempfile
rm -f /tmp/tempfile1
rm -f /tmp/tempfile2
rm -f /tmp/tempfile3
}
#----------------------------------------------------------------------------------------------------
boite_choix_menu_demarrage_propose_grub1()    # choisir le menu fait par oscar minimum ou par grub2 complet
{
rm -f /tmp/fichiertmp
# Choix du menu de demarrage
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Standard`" --cancel-label "Grub1" --extra-button --extra-label "`cat $chemin_langue/Depannage`" \
	--title " `cat $chemin_langue/menu_194a` " \
	--menu "\Zb\Z3 `cat $chemin_langue/menu_192a` : " 0 0 0 \
	"" "" \
	"" "\Zb\Z4`cat $chemin_langue/Standard`  \Zn\Z2: `cat $chemin_langue/menu_195a` " \
	"" "\Zb\Z4`cat $chemin_langue/Depannage` \Zn\Z2: `cat $chemin_langue/menu_196a`" \
	"" "\Zb\Z4Grub1     \Zn\Z2: `cat $chemin_langue/menu_196c`" \
	"" ""
case $? in
    0)	# Standard fait par oscar
    	echo "" > /etc/installe_oscar_seul
	return ;;
    3)  # Depannage fait par grub2 
    	rm -f /etc/installe_oscar_seul
    	return ;;
    1)	# Grub1
    	rm -f /etc/installer_grub2
    	rm -f /usr/share/oscar/usr/installer_grub2
    	rm -f /etc/installe_oscar_seul
    	return ;;
    255) 
	exit ;;
esac 
}
#----------------------------------------------------------------------------------------------------
boite_choix_menu_demarrage()    # choisir le menu fait par oscar minimum ou par grub2 complet
{
rm -f /tmp/fichiertmp
# Choix du menu de demarrage
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Standard`" --cancel-label "`cat $chemin_langue/Depannage`" --title " `cat $chemin_langue/menu_194a` " \
	--menu "\Zb\Z3 `cat $chemin_langue/menu_192a` : " 0 0 0 \
	"" "" \
	"" "\Zb\Z4`cat $chemin_langue/Standard`  \Zn\Z2: `cat $chemin_langue/menu_195a` " \
	"" "\Zb\Z4`cat $chemin_langue/Depannage` \Zn\Z2: `cat $chemin_langue/menu_196a`" \
	"" ""
case $? in
    0)	# minimum fait par oscar
    	echo "" > /etc/installe_oscar_seul
	return ;;
    1)  # complet fait par grub2
    	rm -f /etc/installe_oscar_seul
    	return ;;
    255) 
	exit ;;
esac 
}
#----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
boite_expert() # propose le secteur d'amorçage sur la partition de sauvegarde
{
# Installation en mode expert
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Annuler`" --cancel-label "`cat $chemin_langue/Accepter`"  \
	--title " `cat $chemin_langue/menu_320` " \
	--menu "\n\Zb\Z3   `cat $chemin_langue/menu_321`\n\n" 10 76 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_322` \Zb\Z4$type_boot\Zn`cat $chemin_langue/menu_323`." \
	"" "" \
	"" "" \
	"" "`cat $chemin_langue/menu_324`\Zn " \
	"" "`cat $chemin_langue/menu_325` \Zb\Z4$type_boot\Zn`cat $chemin_langue/menu_326`" \
	"" "" \
	"" ""
case $? in
    0)	rm -f /etc/lilo_expert
    	supprimer_fichier_expert_grub=oui
    	boite_info_depart ;;
    1)  rm -f /etc/lilo_expert
    	echo " " > /etc/lilo_expert ;;
    255) rm -f /etc/lilo_expert
    	supprimer_fichier_expert_grub=oui
    	exit;;
esac
}
#-----------------------------------------------------------------------------------------------------
boite_info_depart() # info du départ
{
# Installation des fichiers OSCAR sur le poste
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" --cancel-label "`cat $chemin_langue/Annuler`" --extra-button --extra-label "`cat $chemin_langue/Expert`" \
	--title " `cat $chemin_langue/menu_316` " \
	--menu "\Zb\Z3   `cat $chemin_langue/menu_236`\n" 7 76 0 \
	"" "`cat $chemin_langue/menu_327`" \
	"" "" \
	"" "`cat $chemin_langue/menu_328`" \
	"" "`cat $chemin_langue/menu_329` \Zb\Z7copie_sauvegarde\Zn`cat $chemin_langue/menu_330`" \
	"" "`cat $chemin_langue/menu_331` \Zb\Z7recup_sauvegarde\Zn." \
	"" "" \
	"" "`cat $chemin_langue/menu_332`" \
	"" "`cat $chemin_langue/menu_333` \Zb\Z1oscar\Zn." \
	"" "" \
	"" "`cat $chemin_langue/menu_334`" \
	"" "" \
	"" "`cat $chemin_langue/menu_335`" \
	"" "`cat $chemin_langue/menu_336`"
case $? in
    0)	rm -f /etc/lilo_expert
	return;;
    3) boite_expert
    	return;;
    1) rm -f /etc/lilo_expert
	exit ;;
    255) rm -f /etc/lilo_expert 
	exit;;
esac
}
#-----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
test_mot_passe()
{
if [ "$reponse" = "" ] || [ "$reponse" = " " ]
then
	# mot de passe non valable
	dialog 	--colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "Recommencez" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\n\Z1 Ce mot de passe n'est pas valable ...\Zn " 9 43
	boite_mdp
fi
}
#----------------------------------------------------------------------------------------------------
boite_mdp()
{
rm -f /tmp/tempfile
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title "$titre_mdp" \
	--passwordbox "$fichierquestion" 12 70 2>/tmp/tempfile
	case $? in
    0)	reponse=`cat /tmp/tempfile`
	rm -f /tmp/tempfile
	test_mot_passe
	;;
    1)	rm -f /tmp/tempfile
    	exit ;;
    255) rm -f /tmp/tempfile
    	exit ;;
esac
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boite_confirme_mdp()
{
rm -f /tmp/tempfile
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Oui`" --cancel-label "`cat $chemin_langue/Annuler`"  --title "$titre_mdp" \
	--passwordbox "$fichierquestion" 14 70 2>/tmp/tempfile
	case $? in
    0)	reponse_confirme=`cat /tmp/tempfile`
	rm -f /tmp/tempfile
	if [ $reponse_confirme = $reponse ]
	then  
		return 
	else
		boite_confirme_mdp
	fi 
	;;
    1)	exit
    	rm -f /tmp/tempfile ;;
    255) exit
    	rm -f /tmp/tempfile ;;
esac
}
#-----------------------------------------------------------------------------------------------------
grub_autorise()
{
demande_restaure=non
demande_boot=non
demande_sauve=non
while [ "$demande_restaure" = "non" ] || [ "$demande_boot" = "non" ]
do
demande_grub
###recapitule :
	# Mots de passe déjà choisis
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" --no-cancel \
	--title " `cat $chemin_langue/menu_337` " \
	--menu "\n\Zb\Z3 `cat $chemin_langue/Recapitulatif`\n\n" 10 82 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_338` \Zb\Z3$demande_restaure" \
	"" "`cat $chemin_langue/menu_339` \Zb\Z3$demande_boot" \
	"" "" \
	"" "`cat $chemin_langue/menu_340`" \
	"" ""
case $? in
    0)	
    	 ;; # accepter le choix
    255) exit ;;
esac
done
}
#----------------------------------------------------------------------------------------------------
crypter_grub2()
{
echo "$reponse" > /tmp/mot_passe
echo `installer_grub2_crypt_pbkdf2 2>/dev/null` > /usr/share/oscar/usr/pour_crypt_mot_passe_pbkdf2

grep -i "grub.pbkdf2" /usr/share/oscar/usr/pour_crypt_mot_passe_pbkdf2 > /tmp/pour_crypt_mot_passe_pbkdf2_1
cut -d"." -f2-30 /tmp/pour_crypt_mot_passe_pbkdf2_1 > /usr/share/oscar/usr/pour_crypt_mot_passe_pbkdf2
echo "grub.`cat /usr/share/oscar/usr/pour_crypt_mot_passe_pbkdf2`" > /usr/share/oscar/usr/pour_crypt_mot_passe_pbkdf2
perl -pi -e 's/ //g;' /usr/share/oscar/usr/pour_crypt_mot_passe_pbkdf2
rm -f /tmp/pour_crypt_mot_passe_pbkdf2_1
}
#----------------------------------------------------------------------------------------------------
demande_grub()
{
rm -f /tmp/tempfile
output=exit
	# Installation des autorisations OSCAR
dialog  --no-cancel --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" --title " `cat $chemin_langue/menu_341` " \
	--menu  "\n`cat $chemin_langue/menu_342` \n\n" 10 80 0  \
	" " "`cat $chemin_langue/menu_343`" \
	" " "" \
	restaure "`cat $chemin_langue/menu_344`" \
	oscar "`cat $chemin_langue/menu_345`" \
	" " "" \
	" " "" \
	quitter "`cat $chemin_langue/menu_61`" \
	" " "" 2>/tmp/tempfile	
if [ $? = "255" ]
then
	rm -f /tmp/tempfile
	return
fi
	output=`cat /tmp/tempfile`

if [ "$output" = " " ]
then
	return
elif [ "$output" = "" ]
then
	return
elif [ "$output" = "restaure" ]
then
	# Mot de passe de restauration du poste par sa sauvegarde
	titre_mdp=" `cat $chemin_langue/mdp_5` "
	fichierquestion="\n\n\n`cat $chemin_langue/mdp_6` "
	boite_mdp
	mot_passe_boot=$reponse

	# Confirmation du mot de passe de démarrage de restaure
	titre_mdp=" `cat $chemin_langue/mdp_7` "
	fichierquestion="\n \n`cat $chemin_langue/mdp_8`\n \
	\Zn \n\n\Zn\Z2 `cat $chemin_langue/mdp_9`"
	boite_confirme_mdp
	rm -f /etc/fichier_t
	#echo "$reponse" > /etc/fichier_t
	echo "$reponse" > /tmp/mot_passe
	crypt_fichier
	cp -f /tmp/mot_passe /etc/fichier_t
	rm -f /tmp/mot_passe
	demande_restaure=oui
	if ( test -e /etc/installer_grub2 )
	then
		# a l'etude pour gpt
		# crypter_grub2
		# cp -f /usr/share/oscar/usr/pour_crypt_mot_passe_pbkdf2 /etc/fichier_t
		rm -f /usr/share/oscar/usr/pour_crypt_mot_passe_pbkdf2
	fi
        return
elif [ "$output" = "oscar" ]
then
	# Mot de passe administrateur réseau
	titre_mdp=" `cat $chemin_langue/mdp_1` "
	fichierquestion="`cat $chemin_langue/mdp_2`"
	boite_mdp
	mot_passe_boot=$reponse

	# Confirmation du mot de passe
	titre_mdp=" `cat $chemin_langue/mdp_3` "
	fichierquestion="`cat $chemin_langue/mdp_4`"
	boite_confirme_mdp
	rm -f /etc/fichier_s
	#echo "$reponse" > /etc/fichier_s
	echo "$reponse" > /tmp/mot_passe
	crypt_fichier
	cp -f /tmp/mot_passe /etc/fichier_s
	rm -f /tmp/mot_passe
	demande_boot=oui
	
	if ( test -e /etc/installer_grub2 )
	then
		crypter_grub2
		cp -f /usr/share/oscar/usr/pour_crypt_mot_passe_pbkdf2 /usr/share/oscar/usr/crypt_mot_passe_pbkdf2
		rm -f /usr/share/oscar/usr/pour_crypt_mot_passe_pbkdf2
		# a l'etude pour gpt
		# cp -f /usr/share/oscar/usr/crypt_mot_passe_pbkdf2 /etc/fichier_s
		
		echo "root" > /tmp/mot_passe
		prepare_clavier_grub2
		cp -f /tmp/mot_passe /usr/share/oscar/usr/superuser_oscar
		rm -f /tmp/mot_passe
	fi
        return
        
elif [ "$output" = "quitter" ]
then
	rm -f /tmp/tempfile
	exit
#	return
else
	$output
fi
rm -f /tmp/tempfile
}
#----------------------------------------------------------------------------------------------------
menu_affichage_sysrcd_grub()
{
rm -f /tmp/tempfile
output=exit
dialog  --no-cancel --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--title " Résolution de l'affichage d'écran " \
	--menu  "\n\Zb\Z3     Sélectionnez votre type d'affichage \n\n" 8 63 0  \
	" " "" \
	quitter "`cat $chemin_langue/menu_61`" \
	" " "" \
	nofb "\Z1Sans\Zn carte graphique, pour utiliser \Z2GParted\Zn." \
	" " "" \
	640x480 "\Z1Très basse\Zn résolution." \
	800x600 "\Z1Basse\Zn résolution. " \
	1024x768 "\Z1Haute\Zn résolution (par défaut)." \
	1280x1024 "\Z1Très haute\Zn résolution." \
	" " "" \
	i810fb640 "\Z1Basse\Zn résolution." \
	i810fb800 "\Z1Haute\Zn résolution." \
	" " "" \
	intelfb640 "\Z1Basse\Zn résolution." \
	intelfb800 "\Z1Haute\Zn résolution." \
	" " "" 2>/tmp/tempfile	
if [ $? = "255" ]
then 
	echo "" > /tmp/sortir
	rm -f /tmp/tempfile
	return
fi
	output=`cat /tmp/tempfile`

if [ "$output" = " " ]
	then
	menu_affichage_sysrcd_grub
elif [ "$output" = "" ]
	then
	menu_affichage_sysrcd_grub
elif [ "$output" = "nofb" ]
then
	rm -f /etc/fichier_r
#	echo "vga=785" > /etc/fichier_r
	echo "vga=0" > /etc/fichier_r
        return
elif [ "$output" = "640x480" ]
then
	rm -f /etc/fichier_r
#	echo "vga=785" > /etc/fichier_r
	echo "vga=0x311" > /etc/fichier_r
        return
elif [ "$output" = "800x600" ]
then
	rm -f /etc/fichier_r
#	echo "vga=788" > /etc/fichier_r
	echo "vga=0x314" > /etc/fichier_r
        return
elif [ "$output" = "1024x768" ]
then
	rm -f /etc/fichier_r
#	echo "vga=791" > /etc/fichier_r
	echo "vga=0x317" > /etc/fichier_r
        return
elif [ "$output" = "1280x1024" ]
then
	rm -f /etc/fichier_r
#	echo "vga=794" > /etc/fichier_r
	echo "vga=0x31A" > /etc/fichier_r
        return
elif [ "$output" = "i810fb640" ]
then
	echo "video=i810fb:640x480" > /etc/fichier_r
        return
elif [ "$output" = "i810fb800" ]
then
	echo "video=i810fb:800x600" > /etc/fichier_r
        return
elif [ "$output" = "intelfb640" ]
then
	echo "video=intelfb:640x480" > /etc/fichier_r
        return
elif [ "$output" = "intelfb800" ]
then
	echo "video=intelfb:800x600" > /etc/fichier_r
        return
elif [ "$output" = "quitter" ]
then	
	echo "" > /tmp/sortir
	rm -f /tmp/tempfile
	return
else
$output
fi
rm -f /tmp/tempfile
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
menu_affichage_sysrcd_lilo()
{
rm -f /tmp/tempfile
output=exit
dialog  --no-cancel --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--title " Résolution de l'affichage d'écran " \
	--menu  "\n\Zb\Z3     Sélectionnez votre type d'affichage \n\n" 0 0 0  \
	" " "" \
	quitter "`cat $chemin_langue/menu_61`" \
	" " "" \
	640x480 "\Z1Très basse\Zn résolution." \
	800x600 "\Z1Basse\Zn résolution. " \
	1024x768 "\Z1Haute\Zn résolution (par défaut)." \
	1280x1024 "\Z1Très haute\Zn résolution." \
	" " "" \
	i810fb640 "\Z1Basse\Zn résolution." \
	i810fb800 "\Z1Haute\Zn résolution." \
	" " "" \
	intelfb640 "\Z1Basse\Zn résolution." \
	intelfb800 "\Z1Haute\Zn résolution." \
	" " "" 2>/tmp/tempfile	
if [ $? = "255" ]
then
	echo "" > /tmp/sortir
	rm -f /tmp/tempfile
	return
fi
	output=`cat /tmp/tempfile`

if [ "$output" = " " ]
	then
	menu_affichage_sysrcd_lilo
elif [ "$output" = "" ]
	then
	menu_affichage_sysrcd_lilo
elif [ "$output" = "640x480" ]
then
	rm -f /etc/fichier_r
	echo "vga=785" > /etc/fichier_r
        return
elif [ "$output" = "800x600" ]
then
	rm -f /etc/fichier_r
	echo "vga=788" > /etc/fichier_r
        return
elif [ "$output" = "1024x768" ]
then
	rm -f /etc/fichier_r
	echo "vga=791" > /etc/fichier_r
        return
elif [ "$output" = "1280x1024" ]
then
	rm -f /etc/fichier_r
	echo "vga=794" > /etc/fichier_r
        return
elif [ "$output" = "i810fb640" ]
then
	echo "video=i810fb:640x480" > /etc/fichier_r
        return
elif [ "$output" = "i810fb800" ]
then
	echo "video=i810fb:800x600" > /etc/fichier_r
        return
elif [ "$output" = "intelfb640" ]
then
	echo "video=intelfb:640x480" > /etc/fichier_r
        return
elif [ "$output" = "intelfb800" ]
then
	echo "video=intelfb:800x600" > /etc/fichier_r
        return
elif [ "$output" = "quitter" ]
then	
	echo "" > /tmp/sortir
	rm -f /tmp/tempfile
	return
else
$output
fi
rm -f /tmp/tempfile
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
menu_affichage()
{
rm -f /tmp/tempfile
output=exit
dialog  --no-cancel --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--title " Résolution de l'affichage d'écran " \
	--menu  "\n\Zb\Z3     Sélectionnez votre type d'affichage \n\n" 0 0 0  \
	" " "" \
	quitter "`cat $chemin_langue/menu_61`" \
	" " "" \
	" " "\Zb\Z4Système 16 bits:" \
	" " "" \
	640x480__16bits "\Z1Basse\Zn résolution." \
	800x600__16bits "\Z1Moyenne\Zn résolution (par défaut). " \
	1024x768_16bits "\Z1Haute\Zn résolution." \
	" " "" \
	" " "\Zb\Z4Système 32 bits:" \
	" " "" \
	640x480__32bits "\Z1Basse\Zn résolution." \
	800x600__32bits "\Z1Moyenne\Zn résolution." \
	1024x768_32bits "\Z1Haute\Zn résolution." \
	" " "" 2>/tmp/tempfile	
if [ $? = "255" ]
then 
	echo "" > /tmp/sortir
	rm -f /tmp/tempfile
	return
fi
	output=`cat /tmp/tempfile`

if [ "$output" = " " ]
	then
	menu_affichage	
elif [ "$output" = "" ]
	then
	menu_affichage
elif [ "$output" = "640x480__16bits" ]
then
	rm -f /etc/fichier_r
	echo "785" > /etc/fichier_r
        return
elif [ "$output" = "800x600__16bits" ]
then
	rm -f /etc/fichier_r
	echo "788" > /etc/fichier_r
        return
elif [ "$output" = "1024x768_16bits" ]
then
	rm -f /etc/fichier_r
	echo "791" > /etc/fichier_r
        return
elif [ "$output" = "640x480__32bits" ]
then
	rm -f /etc/fichier_r
	echo "786" > /etc/fichier_r
        return
elif [ "$output" = "800x600__32bits" ]
then
	rm -f /$chemin/fichier_r
	echo "789" > /etc/fichier_r
        return
elif [ "$output" = "1024x768_32bits" ]
then
	rm -f /etc/fichier_r
	echo "792" > /etc/fichier_r
        return
elif [ "$output" = "quitter" ]
then	
	echo "" > /tmp/sortir
	rm -f /tmp/tempfile
	return
else
$output
fi
rm -f /tmp/tempfile
}
#----------------------------------------------------------------------------------------------------
variables_fichier_lilo_conf() # faire les variables nécessaires au fichier lilo.conf et grub.conf
{
if ! ( test -e /tmp/texte_mbr )
then
	echo "installe_oscar_dd" > /tmp/texte_mbr
fi
runme cherche_disque_boot
if ( test -e /tmp/sortir )
then
	return
fi
	disque_boot_grub=hd`cat /tmp/disque_boot_grub`	# numero du disque pour grub
#	rm -f /tmp/disque_boot_grub
disque_boot=dev/`cat /tmp/disque_boot`		# dev/hda	disque boot d'origine
partition_boot=dev/`cat /tmp/partition`		# dev/hdaiii	partition de boot
nom_simple_boot=`cat /tmp/nom_simple`		# hdaiii
numero_boot=`expr substr $nom_simple_boot 4 3`	# iii	
#	$dev_partition_linux	# dev/hdaiii	partition linux de démarrage

### a installer sur les 5 fichiers: client_clone et jf, client_multi et jf ,installe_oscar_dd:

# id_type=`sfdisk /$disque_boot -c $numero_boot 2>/dev/null`
grep -i /$disque_boot$numero_boot /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
grep -i /$disque_boot$numero_boot /tmp/fichier_disque_dur | grep -ci swap >> /tmp/nb_partition_linux
grep -ci 1 /tmp/nb_partition_linux > /tmp/nb_partition_linux1
nb_partition_linux=`cat /tmp/nb_partition_linux1`
rm -f /tmp/nb_partition_linux
rm -f /tmp/nb_partition_linux1
if [ "$nb_partition_linux" = "1" ] # partition linux ou swap
then
	type_partition="Linux"
else
	grep -i /$disque_boot$numero_boot /tmp/fichier_disque_dur | grep -ci ntfs > /tmp/nb_partition_win
	grep -i /$disque_boot$numero_boot /tmp/fichier_disque_dur | grep -ci fat32 >> /tmp/nb_partition_win
	grep -ci 1 /tmp/nb_partition_win > /tmp/nb_partition_win1
	nb_partition_win=`cat /tmp/nb_partition_win1`
	rm -f /tmp/nb_partition_win
	rm -f /tmp/nb_partition_win1
	if [ "$nb_partition_win" = "1" ] # partition fat32 ou ntfs
	then  # partition fat32 ou ntfs
		type_partition="Windows"
	else
		type_partition="$nom_simple_boot"
	fi
fi
}
#----------------------------------------------------------------------------------------------------
cacher_partition_oscar()
{
runme autoriser_monter_partition_oscar
partition_montee=`cat /tmp/monter_partition`	# /mnt/$partition_ubuntu ou mandriva ...

if ( test -e /mnt/`cat /tmp/monter_part`/etc/fstab )
then
	cp -f $partition_montee/etc/fstab /tmp/tempfile
	controle_uuid_existe

        if ! [ "$aucun_uuid" = "oui" ]
	then
	    mettre_a_jour_uuid_fstab # si besoin
	fi

	perl -pi -e 's/\//{/g;' $partition_montee/etc/fstab
	# début : remplacer / par { 
		
		sortir_uuid_dev_repertoire_linux
		if ! [ "$test_vol_id" = "" ] # partition OSCAR qui possède un UUID
		then
			echo "grep -i \"`cat /tmp/temp_uuid_oscar`\" $partition_montee/etc/fstab > /tmp/tempfile" > /tmp/exec_nom
		else # partition OSCAR qui ne possède pas d'UUID car ancien format
			echo "grep -i \"{dev{$repertoire_linux\" $partition_montee/etc/fstab > /tmp/tempfile" > /tmp/exec_nom
		fi
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		rm -f /tmp/exec_nom
		controle_fichier=`cat /tmp/tempfile`
		if ! ( test -e /mnt/`cat /tmp/monter_part`/mnt/OSCAR_`cat /tmp/part_oscar` )
		then
			mkdir -p /mnt/`cat /tmp/monter_part`/mnt/OSCAR_`cat /tmp/part_oscar`
		fi 
		if ! [ "$controle_fichier" = "" ]
		then
			cp -f /tmp/tempfile /tmp/tempfile1
			perl -pi -e 's/defaults/noauto/g;' /tmp/tempfile1	# si la partition oscar nest pas deja cachee
			echo "perl -pi -e 's/`cat /tmp/tempfile`/`cat /tmp/tempfile1`/g;' $partition_montee/etc/fstab" > /tmp/exec_nom
		        chmod +x /tmp/exec_nom
	    		/tmp/exec_nom	
			rm -f /tmp/exec_nom
		else 
			echo ""  >> $partition_montee/etc/fstab
			echo "# OSCAR" >> $partition_montee/etc/fstab
			echo "UUID=`cat /tmp/temp_uuid_oscar`	/mnt/OSCAR_`cat /tmp/part_oscar`	ext4	ro,noauto,noexec	0	2" >> $partition_montee/etc/fstab
		fi
	# fin : remplacer { par /
	perl -pi -e 's/{/\//g;' $partition_montee/etc/fstab
	rm -f /tmp/tempfile
	rm -f /tmp/tempfile1
	rm -f /tmp/monter_partition
		#UUID=xxxxxyyy       /mnt/OSCAR_sda5     ext4    ro,noauto,noexec        0       2
fi
}
#----------------------------------------------------------------------------------------------------
changer_valeur_uuid()
{
# /tmp/tempfile : sdji{uuid{sdji{uuid
perl -pi -e 's/--//g;' /tmp/tempfile # peut se produire si plusieurs uuid comme avec mandriva
cut -d"{" -f1 /tmp/tempfile > /tmp/temp	# sdai

partition_uuid=`cat /tmp/temp`
rm -f /tmp/temp
if ! [ "$partition_uuid" = "" ]
then
	cut -d"{" -f2 /tmp/tempfile > /tmp/temp1	# uuid
	valeur_uuid_fstab=`cat /tmp/temp1`
	cp -f /tmp/temp1 /tmp/temp_sdai
	rm -f /tmp/temp1
	if ! [ "$valeur_uuid_fstab" = "" ]
    	then
    		# cherche partition uuid existe :
    		remplacer_uuid_par_sdai
    		test_sdai_existe=`cat /tmp/temp_sdai`
    		rm -f /tmp/temp_sdai
    		if ! [ "$test_sdai_existe" = "" ] # si ubuntu installe avec cle usb et disque dur en sdb
	    	then
	    		# ne pas changer uuid mais changer sdij :
	    		echo "if ( test -e $partition_montee/etc/fstab )
			then
				perl -pi -e 's/$partition_uuid /$test_sdai_existe /g;' $partition_montee/etc/fstab
			fi" > /tmp/exec_nom
		        chmod +x /tmp/exec_nom
		        /tmp/exec_nom
	    	else
			# mettre la nouvelle uuid de cette partition dans fstab:
			#### si noyau ubuntu détecte hdai oscar peut détecter sdai, il faut donc remplacer hdai par sdai
			echo "$partition_uuid" > /tmp/partition_uuid
			prendre_hdai_au_lieu_sdai_nouveau_noyau	# dans le fichier fabriqué par Ubuntu 
			rm -f /tmp/partition_uuid
			partition_sdai=$partition_uuid
	
			# changer les uuid pour fstab et aussi grub.conf de la partition OSCAR si restaure ou client
			sortir_uuid_partition_sdai
			cp -f /tmp/uuid_partition_sdai /tmp/temp
			rm -f /tmp/uuid_partition_sdai
			echo "if ( test -e $partition_montee/etc/fstab )
			then
				perl -pi -e 's/$valeur_uuid_fstab/`cat /tmp/temp`/g;' $partition_montee/etc/fstab
			fi
			perl -pi -e 's/$valeur_uuid_fstab/`cat /tmp/temp`/g;' $partition_linux/boot/grub/grub.conf
			cp -f $partition_linux/boot/grub/grub.conf /etc/grub.conf " > /tmp/exec_nom
		        chmod +x /tmp/exec_nom
		        /tmp/exec_nom
		fi
		# supprimer la ligne utilisee:
		cut -d"{" -f1-2 /tmp/tempfile > /tmp/temp
		echo "perl -pi -e 's/`cat /tmp/temp`{//g;' /tmp/tempfile" > /tmp/exec_nom
	        chmod +x /tmp/exec_nom
	        /tmp/exec_nom
	
		changer_valeur_uuid
	else
		rm -f /tmp/temp_sdai
		rm -f /tmp/exec_nom
		rm -f /tmp/tempfile
		rm -f /tmp/temp
		return
	fi
else
	rm -f /tmp/exec_nom
	rm -f /tmp/tempfile
	rm -f /tmp/temp
	return
fi
}
#----------------------------------------------------------------------------------------------------
controle_uuid_existe()
{
aucun_uuid=non
grep -ci "^UUID=" $partition_montee/etc/fstab > /tmp/temp
test_uuid=`cat /tmp/temp`
if [ "$test_uuid" = "0" ]
then
        grep -ci "^uuid=" $partition_montee/etc/fstab > /tmp/temp
	test_uuid=`cat /tmp/temp`
	if [ "$test_uuid" = "0" ]
	then
		rm -f /tmp/temp
		aucun_uuid=oui
	fi
fi
}
#----------------------------------------------------------------------------------------------------
prendre_hdai_au_lieu_sdai_nouveau_noyau()	# aussi evms pour /dev/sdai remplacé par /dev/hdai
{
# le fichier est dans /tmp/partition_uuid la reponse est aussi dans /tmp/partition_uuid

partition_uuid=`cat /tmp/partition_uuid`
if ! ( test -e /dev/$partition_uuid )	# /dev/hdai n'existe pas
then
	if ( test -e /dev/evms/$partition_uuid )	# partition evms
	then
		echo "evms/$partition_uuid" > /tmp/partition_uuid
	else
		numero_partition=`expr substr $partition_uuid 3 4` # pour prendre aiii de sdaiii ou de hdaiii
		if ( test -e /dev/hd$numero_partition )	# partition hdai au lieu de sdai
		then
			echo "hd$numero_partition" > /tmp/partition_uuid
		elif ( test -e /dev/evms/hd$numero_partition )
		then
			echo "evms/hd$numero_partition" > /tmp/partition_uuid
		else	# par sécurité mais inutile je teste:
			if ( test -e /dev/sd$numero_partition )	# partition sdai au lieu de hdai
			then
				echo "sd$numero_partition" > /tmp/partition_uuid
			elif ( test -e /dev/evms/sd$numero_partition )
			then
				echo "evms/sd$numero_partition" > /tmp/partition_uuid
			#else
			#	echo
			#	echo " Erreur la partition /dev/$partition_uuid n'existe pas ... "
			#	echo
			#	sleep 3
			fi
		fi
	fi
fi
partition_uuid=`cat /tmp/partition_uuid`
}
#----------------------------------------------------------------------------------------------------
prendre_ligne_ubuntu_mandriva_pour_uuid()
{
# pour grub.conf de la partition OSCAR
if ( test -e $partition_linux/boot/grub/grub.conf )
then
    	grep -i "vmlinuz-" $partition_linux/boot/grub/grub.conf > /tmp/tempgrub_oscar
    	if ! [ "$nombre_partition_linux_juste_boot" = "1" ]
    	then	# une partition linux juste /boot
	    	cut -d"(" -f2 /tmp/tempgrub_oscar > /tmp/tempgrub_oscar1
	    	cut -d")" -f1 /tmp/tempgrub_oscar1 > /tmp/temp_hdi_j	# hdi,j depuis (hdi,j)

	    	# convertir hdi en sda :
	    	perl -pi -e 's/hd0,/sda,/g; s/hd1,/sdb,/g; s/hd2,/sdc,/g; s/hd3,/sdd,/g; s/hd4,/sde,/g; s/hd5,/sdf,/g;
	    	s/hd6,/sdg,/g; s/hd7,/sdh,/g; s/hd8,/sdi,/g; s/hd9,/sdj,/g; s/hd10,/sdk,/g;' /tmp/temp_hdi_j
	
	    	# convertir j en j+1 :
	    	perl -pi -e 's/,29/30/g; s/,28/29/g; s/,27/28/g; s/,26/27/g; s/,25/26/g; s/,24/25/g; s/,23/24/g; s/,22/23/g; s/,21/22/g;
	    	s/,20/21/g; s/,19/20/g; s/,18/19/g; s/,17/18/g; s/,16/17/g; s/,15/16/g; s/,14/15/g; s/,13/14/g; s/,12/13/g; s/,11/12/g; s/,10/11/g; 
	    	s/,9/10/g; s/,8/9/g; s/,7/8/g; s/,6/7/g; s/,5/6/g; s/,4/5/g; s/,3/4/g; s/,2/3/g; s/,1/2/g; s/,0/1/g;' /tmp/temp_hdi_j
	else
		# si partition juste boot :
		grep -i "ubuntu" /tmp/fichier_partitions_boot > /tmp/temp_ubuntu_essai
		temp_ubuntu_essai=`cat /tmp/temp_ubuntu_essai`
		fin_uuid_ubuntu_mandriva=non
		if [ "$temp_ubuntu_essai" != "" ]
		then
			cut -d"," -f2 /tmp/temp_ubuntu_essai > /tmp/temp_hdi_j
			rm -f /tmp/temp_ubuntu_essai
		else
			grep -i "mandriva" /tmp/fichier_partitions_boot > /tmp/temp_mandriva_essai
			temp_mandriva_essai=`cat /tmp/temp_mandriva_essai`
			if [ "$temp_mandriva_essai" != "" ]
			then
				cut -d"," -f2 /tmp/temp_mandriva_essai > /tmp/temp_hdi_j
				rm -f /tmp/temp_mandriva_essai
			else
				fin_uuid_ubuntu_mandriva=oui
				rm -f /tmp/temp_ubuntu_essai
				rm -f /tmp/temp_mandriva_essai
				return
			fi
		fi
	fi
    	# valeur uuid:
    	perl -pi -e 's/root=UUID=/{/g;' /tmp/tempgrub_oscar
    	cut -d"{" -f2 /tmp/tempgrub_oscar > /tmp/tempgrub_oscar1
    	cut -d" " -f1 /tmp/tempgrub_oscar1 > /tmp/tempuuid_hdi_j	# uuid de hdi,j
    	rm -f /tmp/tempgrub_oscar
    	rm -f /tmp/tempgrub_oscar1
    	echo "`cat /tmp/temp_hdi_j`{`cat /tmp/tempuuid_hdi_j`" > /tmp/tempgrub_oscar # sdai{uuid
    	rm -f /tmp/temp_hdi_j
    	rm -f /tmp/tempuuid_hdi_j
fi
}
#----------------------------------------------------------------------------------------------------
mettre_a_jour_uuid_fstab()
{
# aussi pour grub.conf  si restaure ou client
if ! ( test -e /etc/lilo_expert )
then
	# pour grub.conf de la partition OSCAR
	prendre_ligne_ubuntu_mandriva_pour_uuid

	# pour fstab d'un systeme linux :
	if ! (test -e $partition_montee/etc/fstab.avt.oscar )
	then
		cp -f $partition_montee/etc/fstab $partition_montee/etc/fstab.avt.oscar
	fi
	
	donner_heure
	cp -f $partition_montee/etc/fstab $partition_montee/etc/fstab-$date_heure

	cp -f $partition_montee/etc/fstab /tmp/tempfile
	grep -i -B 1 "^UUID=" /tmp/tempfile > /tmp/tempfstab1
	perl -pi -e 's/UUID=/;/g; s/\/dev\//;/g;' /tmp/tempfstab1
	cut -d";" -f2 /tmp/tempfstab1 > /tmp/tempfstab2
	perl -pi -e 's/ /;/g;' /tmp/tempfstab2
	cut -d";" -f1 /tmp/tempfstab2 > /tmp/tempfstab1
	
	# ajouter sdai{uuid de grub.conf OSCAR
	if ( test -e /tmp/tempgrub_oscar )
	then
		echo "`cat /tmp/tempgrub_oscar`" >> /tmp/tempfstab1
		rm -f /tmp/tempgrub_oscar
	fi
	
	# mettre en une ligne :
    	echo `gawk '{ print $0 "{" } ' /tmp/tempfstab1` | perl -pi -e 's/ //g;' > /tmp/tempfile
	rm -f /tmp/tempfstab1
	rm -f /tmp/tempfstab2

	changer_valeur_uuid
fi
}
#----------------------------------------------------------------------------------------------------
remplacer_mac_adr_iftab()
{
if ! ( test -e /etc/lilo_expert )
then
    cut -d";" -f2 /tmp/temp1 > /tmp/temp2 # pour ne prendre que le premier qui correspond à la première ligne
    test_mac=`cat /tmp/temp2`

    if ! [ "$test_mac" = "" ]
    then	# mac adresse existe
	cut -d"{" -f2 /tmp/temp2 > /tmp/temp
	cut -d"}" -f1 /tmp/temp > /tmp/temp_mac_ancien
	cut -d"{" -f1 /tmp/temp2 > /tmp/temp_ethi	# pour ethi étudié
	perl -pi -e 's/}//g;' /tmp/temp_ethi # si espaces existes

	ifconfig | grep -i "Ethernet" > /tmp/temp_ligne_ethi_poste
	echo "grep -i \"`cat /tmp/temp_ethi`\" /tmp/temp_ligne_ethi_poste > /tmp/temp" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/temp_ethi
	cp -f /tmp/temp /tmp/temp_ligne_ethi_poste
	rm -f /tmp/temp
	# prendre dans la ligne de /tmp/temp_ligne_ethi_poste la nouvelle valeur mac adresse:
	perl -pi -e 's/HWaddr /{/g; s/ether /{/g; s/txqueuelen/{/g; s/ //g;' /tmp/temp_ligne_ethi_poste
	cut -d"{" -f2 /tmp/temp_ligne_ethi_poste > /tmp/temp_mac_poste
	rm -f /tmp/temp_ligne_ethi_poste
	
	# remplacer l'ancienne mac adresse de iftab par celle du poste :
	echo "perl -pi -e 's/`cat /tmp/temp_mac_ancien`/`cat /tmp/temp_mac_poste`/g;' $partition_montee/etc/iftab" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/temp_mac_poste
	rm -f /tmp/temp_mac_ancien

	#supprimer /tmp/temp2
	echo "perl -pi -e 's/;`cat /tmp/temp2`//g;' /tmp/temp1" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
	remplacer_mac_adr_iftab
    fi
    rm -f /tmp/temp1
    rm -f /tmp/temp2
fi
}
#----------------------------------------------------------------------------------------------------
sortir_uuid_partition_sdai()
{
# sortir uuid de /dev/$partition_sdai :
# ancien : echo `/lib/udev/vol_id -u /dev/$partition_sdai 2>/dev/null` > /tmp/temp
blkid -o full /dev/$partition_sdai > /tmp/temp_uuid_sdai
perl -pi -e 's/UUID="/,/g;' /tmp/temp_uuid_sdai
cut -d"," -f2 /tmp/temp_uuid_sdai > /tmp/temp_uuid_sdai1
cut -d"\"" -f1 /tmp/temp_uuid_sdai1 > /tmp/uuid_partition_sdai
rm -f /tmp/temp_uuid_sdai
rm -f /tmp/temp_uuid_sdai1
}
#----------------------------------------------------------------------------------------------------
sortir_uuid_reponse()
{
# sortir uuid de $reponse :
# ancien : echo "`/lib/udev/vol_id -u /dev/$reponse 2>/dev/null`" > /tmp/uuid_ubuntu
blkid -o full /dev/$reponse > /tmp/temp_uuid_sdai
perl -pi -e 's/UUID="/,/g;' /tmp/temp_uuid_sdai
cut -d"," -f2 /tmp/temp_uuid_sdai > /tmp/temp_uuid_sdai1
cut -d"\"" -f1 /tmp/temp_uuid_sdai1 > /tmp/uuid_ubuntu
rm -f /tmp/temp_uuid_sdai
rm -f /tmp/temp_uuid_sdai1
test_vol_id=`cat /tmp/uuid_ubuntu`
}
#----------------------------------------------------------------------------------------------------
sortir_uuid_dev_repertoire_linux()
{
# sortir uuid de /dev/$repertoire_linux :
# ancien : echo `/lib/udev/vol_id -u /dev/$repertoire_linux 2>/dev/null` > /tmp/temp_uuid_oscar
blkid -o full /dev/$repertoire_linux > /tmp/temp_uuid_sdai
perl -pi -e 's/UUID="/,/g;' /tmp/temp_uuid_sdai
cut -d"," -f2 /tmp/temp_uuid_sdai > /tmp/temp_uuid_sdai1
cut -d"\"" -f1 /tmp/temp_uuid_sdai1 > /tmp/temp_uuid_oscar
rm -f /tmp/temp_uuid_sdai
rm -f /tmp/temp_uuid_sdai1
test_vol_id=`cat /tmp/temp_uuid_oscar`
}
#----------------------------------------------------------------------------------------------------
faire_fstab()
{
##	Ajout de la ligne désignant la partition /$chemin/fstab au fichier /etc/fstab...
##	 si cette ligne existe ne pas la rajoutée seulement si démarrage cédérom ou USB
##	cacher la partition oscar de sauvegarde pour ubuntu et mandriva ...
##	remplacer mac adresse dans iftab, toujours à l'installation surtout client:

#>  repertoire_reel_linux=$repertoire_linux
#> change_lettre_disque_si_demarre_usb # inutile car uuid

fsck /dev/$repertoire_linux -N 2>/dev/null > /tmp/fs_type_oscar 
grep -ci "ext4" /tmp/fs_type_oscar > /tmp/nb_fs_type_oscar
valeur_fs_type_oscar=`cat /tmp/nb_fs_type_oscar`
rm -f /tmp/nb_fs_type_oscar
rm -f /tmp/fs_type_oscar
if [ "$valeur_fs_type_oscar" = "1" ]
then
	format_oscar=ext4
else
	format_oscar=ext3
fi

sortir_uuid_dev_repertoire_linux

if ! [ "$test_vol_id" = "" ] # partition OSCAR qui possède un UUID
then
	echo "UUID=`cat /tmp/temp_uuid_oscar` / $format_oscar errors=remount-ro 0 0" > /tmp/tempfile
else # partition OSCAR qui ne possède pas d'UUID
	echo "/dev/$repertoire_linux / $format_oscar errors=remount-ro 0 0" > /tmp/tempfile
fi
echo "grep -ci \"`cat /tmp/tempfile`\" /etc/fstab > /tmp/tempfile1" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
controle_ligne=`cat /tmp/tempfile1`

if [ "$controle_ligne" = "0" ]	# fstab non modifié avec oscar
then
	echo "none        /proc     proc    defaults             0 0" > /etc/fstab
	echo "none        /dev/shm  tmpfs   nodev,nosuid,noexec  0 0" >> /etc/fstab
	echo "/dev/cdroms/cdrom0    /mnt/cdrom    auto      noauto,user   0 0" >> /etc/fstab
	if ! [ "$test_vol_id" = "" ] # partition OSCAR qui possède un UUID
	then
		echo "# /dev/$repertoire_linux OSCAR" >> /etc/fstab
	    	echo "UUID=`cat /tmp/temp_uuid_oscar` / $format_oscar errors=remount-ro 0 0" >> /etc/fstab # ne pas changer pour runme autoriser_monter_partition_oscar
	else # partition OSCAR qui ne possède pas d'UUID
		echo "/dev/$repertoire_linux / $format_oscar errors=remount-ro 0 0" >> /etc/fstab # ne pas changer pour runme autoriser_monter_partition_oscar
	fi
	if [ "$test_partition_swap" != "" ]	# il existe peut-etre une partition swap
	then
		if [ "$test_partition_swap" != "0" ]	# il existe une partition swap
		then
			echo "# /dev/$partition_swap swap" >> /etc/fstab
			echo "UUID=$uuid_partition_swap  none  swap  sw  0 0" >> /etc/fstab
		fi
	fi
fi
rm -f /tmp/exec_nom
rm -f /tmp/tempfile
rm -f /tmp/tempfile1
rm -f /tmp/temp_uuid_oscar

##	cacher la partition oscar de sauvegarde pour ubuntu et mandriva ...
##	si cette partition est déjà cachée ne pas la cachée encore
echo "$repertoire_linux" > /tmp/part_oscar
if ! [ "$partition_ubuntu" = "rien_du_tout" ]
then
	echo "$partition_ubuntu" > /tmp/monter_part
    	echo "$partition_ubuntu" > /tmp/monter_partition	# cacher la partition de sauvegarde Oscar
	cacher_partition_oscar

	partition_ubuntu_normale=`cat /tmp/monter_part`
	
	# supprimer pour les clients le fichier depuis ubuntu 7.10:
	rm -f $partition_montee/etc/udev/rules.d/70-persistent-net.rules
	# remplacer mac adresse dans iftab, toujours à l'installation surtout client:
	# plus nécesssaire avec ubuntu 07.10 mais je le laisse pour les anciennes config
	if ( test -e $partition_montee/etc/iftab ) # remplacer la mac adresse par sa vraie valeur:
	then
		grep -ci "eth"  $partition_montee/etc/iftab > /tmp/test_eth
		test_eth=`cat /tmp/test_eth`
		rm -f /tmp/test_eth
		if ! [ "$test_eth" = "0" ]
		then
			ifconfig | grep -i "Ethernet" > /tmp/temp1
			grep -ci "eth" /tmp/temp1 > /tmp/test_eth
			test_eth=`cat /tmp/test_eth`
			rm -f /tmp/test_eth
			if ! [ "$test_eth" = "0" ] # il faut remplacer la mac
			then
	    			if ! ( test -e $partition_montee/etc/iftab_avt_oscar )
				then
			    		cp -f $partition_montee/etc/iftab $partition_montee/etc/iftab_avt_oscar
				else
			    		cp -f $partition_montee/etc/iftab $partition_montee/etc/iftab-$date_heure 
				fi
				echo " " > /tmp/tableau_iftab	#premiere ligne pour } au départ
				grep -i "eth"  $partition_montee/etc/iftab >> /tmp/tableau_iftab
				perl -pi -e 's/ mac /{/g;' /tmp/tableau_iftab
				# supprimer les sauts de ligne:
	    			echo `gawk '{ print $0 ";" } ' /tmp/tableau_iftab` | perl -pi -e 's/ /}/g;' > /tmp/temp1	# valeur mac encadrée par { et }
				remplacer_mac_adr_iftab
				#faire_tableau_eth_iftab
			fi
		fi
	fi
fi
if ! [ "$partition_mandriva" = "rien_du_tout" ]
then
	echo "$partition_mandriva" > /tmp/monter_part
    	echo "$partition_mandriva" > /tmp/monter_partition	# cacher la partition de sauvegarde Oscar
	cacher_partition_oscar
	partition_mandriva_normale=`cat /tmp/monter_part`
	
	# remplacer mac adresse dans iftab, toujours à l'installation surtout client:
	if ( test -e $partition_montee/etc/iftab ) # remplacer la mac adresse par sa vraie valeur:
	then
		grep -ci "eth"  $partition_montee/etc/iftab > /tmp/test_eth
		test_eth=`cat /tmp/test_eth`
		rm -f /tmp/test_eth
		if ! [ "$test_eth" = "0" ]
		then
			ifconfig | grep -i "Ethernet" > /tmp/temp1
			grep -ci "eth" /tmp/temp1 > /tmp/test_eth
			test_eth=`cat /tmp/test_eth`
			rm -f /tmp/test_eth
			if ! [ "$test_eth" = "0" ] # il faut remplacer la mac
			then
	    			if ! ( test -e $partition_montee/etc/iftab_avt_oscar )
				then
			    		cp -f $partition_montee/etc/iftab $partition_montee/etc/iftab_avt_oscar
				else
			    		cp -f $partition_montee/etc/iftab $partition_montee/etc/iftab-$date_heure 
				fi
				echo " " > /tmp/tableau_iftab	#premiere ligne pour } au départ
				grep -i "eth"  $partition_montee/etc/iftab >> /tmp/tableau_iftab
				perl -pi -e 's/ mac /{/g;' /tmp/tableau_iftab
				# supprimer les sauts de ligne:
	    			echo `gawk '{ print $0 ";" } ' /tmp/tableau_iftab` | perl -pi -e 's/ /}/g;' > /tmp/temp1	# valeur mac encadrée par { et }
				remplacer_mac_adr_iftab
				#faire_tableau_eth_iftab
			fi
		fi
	fi
	# voir si remplacer_uid_fstab
fi
rm -f /tmp/monter_part
}
#----------------------------------------------------------------------------------------------------
boucle_partition_windows() # sortir la partition windows ou autre dans la reponse
{
	rm -f /tmp/tempfile
	echo "$type" > /tmp/tempfile
	runme prepare_boucle_partition	##  /tmp/tempfile # toutes les partitions du type séparées par : hdaiii:hdaiii
	nombretype=`cat /tmp/nombre`
	rm -f /tmp/nombre
numero=0
until  ( test  $numero = $nombretype )
    do
	rm -f /tmp/tempfile1
#	rm -f /tmp/partfile1
	numero=$[$numero+1]

	if ( test -e /tmp/tempfile )
	then
	    cut -d":" -f$numero /tmp/tempfile > /tmp/tempfile1	#hdaiii
	else
	    echo "" > /tmp/tempfile
	    echo "" > /tmp/tempfile1
	fi

#	cut -d":" -f$numero /tmp/partfile > /tmp/partfile1	#ide/h0/b0/t0/l0/hdaiii
	reponse=`cat /tmp/tempfile1`
#	reparti=`cat /tmp/partfile1`


	rm -f /tmp/tempfile1
	if ! [ "$reponse" = "" ] # si la partition existe
	then 
		numero_hd=`expr substr $reponse 4 3`
		disque=`expr substr $reponse 1 3`       #hda
		if [ "$type" = "ntfs" ] || [ "$type" = "fat32" ]
		then
			echo "$reponse" > /tmp/monter_partition
			if [ "$type" = "ntfs" ]
			then
				echo "ntfs" > /tmp/besoin_type
			fi
                        runme autoriser_monter_partition_oscar
                        partition_montee=`cat /tmp/monter_partition`
                        rm -f /tmp/monter_partition
			rm -f /tmp/besoin_type

                        if ( test -e $partition_montee/WINDOWS/system32/drivers ) ## verifie si contient windows
			then
				partition_windows=$reponse
				umount $partition_montee 2>/dev/null ; sync
				return
			elif ( test -e $partition_montee/WINNT/system32/drivers ) ## verifie si contient windows
			then
				partition_windows=$reponse
				umount $partition_montee 2>/dev/null ; sync
				return
			elif ( test -e $partition_montee/Windows/System32 ) ## verifie si contient windows pour vista
			then
				partition_windows=$reponse
				umount $partition_montee 2>/dev/null ; sync
				return
			elif ( test -e $partition_montee/Winnt/System32 ) ## verifie si contient windows
			then
				partition_windows=$reponse
				umount $partition_montee 2>/dev/null ; sync
				return
			elif [ "$type" = "ntfs" ] # voir si erreur de montage sur ntfs
			then
				if ( test -e /tmp/erreur_montage_ntfs )
				then
				    rm -f /tmp/erreur_montage_ntfs
				    if ! [ "$partition_windows" = "" ] # deja une partition windows systeme detectee
				    then # a priori ce n'est pas une partition de donnees
				    	# partition ntfs de mauvaise qualit
					dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
					--title " `cat $chemin_langue/DESOLE` " --ok-label "`cat $chemin_langue/Système`" --help-button --help-label "`cat $chemin_langue/Données`" \
					--msgbox "\n\Zb\Z1 `cat $chemin_langue/msgbox_30` ntfs\Z3 $partition_ntfs_a_monter `cat $chemin_langue/msgbox_60` ntfs\Z3 $partition_ntfs_a_monter\Z4 : " 10 67
					case $? in
				        1)  # Donnees
				            ;;
				        0) # Systeme
					    partition_windows=$reponse
					    return
					    ;;
					esac
				    fi
				fi
			fi
			umount $partition_montee 2>/dev/null ; sync
		fi
	fi
    done
rm -f $partition_linux/usr/share/oscar/usr/version_ubuntu_oscar
rm -f $partition_linux/usr/share/oscar/usr/version_mandriva_oscar
rm -f /tmp/tempfile
# rm -f /tmp/partfile
}
#----------------------------------------------------------------------------------------------------
rechercher_si_ubuntu_installe()
{
# initialiser 
if ( test -e $partition_linux/usr/share/oscar/usr/version_ubuntu_oscar )
then 	# initialiser
	version_ubuntu=`cat $partition_linux/usr/share/oscar/usr/version_ubuntu_oscar`
	rm -f $partition_linux/usr/share/oscar/usr/version_ubuntu_oscar
	rm -f $partition_linux/boot/vmlinuz-$version_ubuntu
	rm -f $partition_linux/boot/initrd.img-$version_ubuntu
fi

partition_ubuntu=non
type="linux"
boucle_partition_windows
}
#----------------------------------------------------------------------------------------------------
rechercher_si_windows_installe()
{
# rechercher si windows installe	# cherche la partition windows
partition_windows=non
type="ntfs"
boucle_partition_windows
if [ "$partition_windows" = "non" ]
then
	type="fat32"
	boucle_partition_windows
fi
if ! [ "$partition_windows" = "non" ]	# partition $reponse windows
then
	numero_hd_windows=`expr substr $reponse 4 3` # numero du répertoire de Windows
	numero_sd_disque_windows=`expr substr $reponse 1 3`
	# sfdisk /dev/$numero_sd_disque_windows -c 1 > /tmp/test_boot_winRE 2>/dev/null
	grep -i $numero_sd_disque_windows"1" /tmp/fichier_disque_dur | grep -i ntfs | grep -ci diag > /tmp/nb_partition_ntfs_diag
	nb_partition_ntfs_diag=`cat /tmp/nb_partition_ntfs_diag`
	rm -f /tmp/nb_partition_ntfs_diag
	if [ "$nb_partition_ntfs_diag" = "1" ] # partition ntfs diag
	then # partition dell utility ou 'ntfs' et 'diag' au lieu de '27' avec parted, boot sur sda1 cachee pour Toshiba
		numero_hd_windows=0
	else	# chercher si partition davant est ntfs boot qui a bootmgr pour Dell
		numero_hd_windows_moins_un=$[$numero_hd_windows-1]
		# sfdisk /dev/$numero_sd_disque_windows -c $numero_hd_windows_moins_un > /tmp/test_partition_boot_windows_de 2>/dev/null
		grep -i $numero_sd_disque_windows$numero_hd_windows_moins_un /tmp/fichier_disque_dur | grep -ci ntfs > /tmp/nb_partition_ntfs
		nb_partition_ntfs=`cat /tmp/nb_partition_ntfs`
		rm -f /tmp/nb_partition_ntfs
		if [ "$nb_partition_ntfs" = "1" ] # partition ntfs
		then
			echo "ntfs" > /tmp/besoin_type
			echo "$numero_sd_disque_windows$numero_hd_windows_moins_un" > /tmp/monter_partition
			runme autoriser_monter_partition_oscar
			rm -f /tmp/monter_partition
			rm -f /tmp/besoin_type
			if ( test -e /mnt/$numero_sd_disque_windows$numero_hd_windows_moins_un/bootmgr )
			then
				numero_hd_windows=$[$numero_hd_windows_moins_un-1]
				umount /mnt/$numero_sd_disque_windows$numero_hd_windows_moins_un 2>/dev/null
			else
				numero_hd_windows=$[$numero_hd_windows-1]
			fi
		else
			numero_hd_windows=$[$numero_hd_windows-1]
		fi
	fi
	trouver_numero_disque_grub=$reponse
	recuperer_numero_disque_grub
	numero_disque_grub_windows=$trouver_numero_disque_grub
fi
}
#----------------------------------------------------------------------------------------------------
donner_heure()
{
calendrier=$(date +%y.%m.%d)
heure=$(date +%kh.%Mmin)
echo "$calendrier-$heure" > /tmp/date_heure
perl -pi -e 's/ //g;' /tmp/date_heure
date_heure=`cat /tmp/date_heure`
rm -f /tmp/date_heure
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
installation_eventuelle_ubuntu_grub()	# recherche ubuntu ou mandriva ou windows
{	# non obligatoire : installe le demarrage sur la partition ubuntu ou mandriva si pas expert
donner_heure

	chercher_disque_oscar_pour_grub

	resolution_ecran=`cat /etc/fichier_r`

if [ "$nombre_partition_linux_juste_boot" = "1" ]	# une partition linux juste /boot
then
	# return # commande à vérifier en client ???? poste seul OK
	echo "$partition_boot_grub" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	partition_montee_boot_ubuntu=/mnt/$partition_boot_grub
	partition_montee_boot_mandriva=/mnt/$partition_boot_grub
else
	#    partition_boot_pour_grub=$partition_linux/boot
	partition_montee_boot_ubuntu=/mnt/$partition_ubuntu/boot
	partition_montee_boot_mandriva=/mnt/$partition_mandriva/boot
fi

if ! ( test -e /etc/lilo_expert )
then
    if ! [ "$partition_ubuntu" = "rien_du_tout" ]
    then
    	# ajouter Oscar dans le fichier menu.lst:
        echo
        if [ "$afficher_systeme_linux_installe" = "Ubuntu" ]
	then
		echo -e "`cat $chemin_langue/texte_58` \033[1;32m$partition_ubuntu\033[1;m"
        elif [ "$afficher_systeme_linux_installe" = "Mandriva" ]
        then
        	echo -e "`cat $chemin_langue/texte_59` \033[1;32m$partition_ubuntu\033[1;m"
        fi
        echo

	# installer Oscar dans le fichier menu.lst d'Ubuntu pour grub
	repertoire_partition_linux=$partition_linux

	echo "$version_ubuntu" > $repertoire_partition_linux/usr/share/oscar/usr/version_ubuntu_oscar
	echo "$partition_ubuntu" > /tmp/monter_partition
        runme autoriser_monter_partition_oscar

	#repertoire_reel_linux=$repertoire_linux
	sortir_uuid_dev_repertoire_linux

	if ( test -e $partition_montee_boot_ubuntu/grub/menu.lst )
	then
		cp -f $partition_montee_boot_ubuntu/grub/menu.lst $partition_montee_boot_ubuntu/grub/menu.lst-$date_heure
		mot_passe_boot=`cat /etc/fichier_s`
		echo " " >> $partition_montee_boot_ubuntu/grub/menu.lst
		echo "title=OSCAR $version_oscar_cdrom" >> $partition_montee_boot_ubuntu/grub/menu.lst
		echo "password --md5 $mot_passe_boot" >> $partition_montee_boot_ubuntu/grub/menu.lst
		uuid_partition_oscar=`cat /tmp/temp_uuid_oscar`
		#change_lettre_disque_si_demarre_usb
		# ici uuid impossible si partition juste boot
		echo "root ($nom_disque_oscar_grub,$numero_hd_oscar)" >> $partition_montee_boot_ubuntu/grub/menu.lst
	fi
	if ( test -e $partition_linux/usr/share/oscar/usr/options_boot )
	then
		options_boot=`cat $partition_linux/usr/share/oscar/usr/options_boot`
	else
		options_boot=
	fi

	if ( test -e $partition_montee_boot_ubuntu/grub/menu.lst )
	then
		if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
		then
			if ! [ "$test_vol_id" = "" ] # partition OSCAR qui possède UUID
			then
				echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=UUID=`cat /tmp/temp_uuid_oscar` $resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> $partition_montee_boot_ubuntu/grub/menu.lst
			else # partition OSCAR qui ne possède pas d'UUID
				echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=/dev/$repertoire_linux $resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> $partition_montee_boot_ubuntu/grub/menu.lst
			fi
		else
			if ! [ "$test_vol_id" = "" ] # partition OSCAR qui possède UUID
			then
				echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=/dev/ram0 init=/linuxrc ramdisk=8192 real_root=UUID=`cat /tmp/temp_uuid_oscar` udev vga=$resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> $partition_montee_boot_ubuntu/grub/menu.lst
			else # partition OSCAR qui ne possède pas d'UUID
				echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=/dev/ram0 init=/linuxrc ramdisk=8192 real_root=/dev/$repertoire_linux udev vga=$resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> $partition_montee_boot_ubuntu/grub/menu.lst
			fi	
		fi
		echo "initrd ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar.igz" >> $partition_montee_boot_ubuntu/grub/menu.lst
	fi
	rm -f /tmp/temp_uuid_oscar
	# umount $partition_montee_boot_ubuntu ; sync
    fi

    if ! [ "$partition_mandriva" = "rien_du_tout" ]
    then
	# ajouter Oscar dans le fichier menu.lst:
        # installer Oscar dans le fichier menu.lst de Mandriva pour grub
	echo
	echo -e "`cat $chemin_langue/texte_65` \033[1;31m$title_ligne_mandriva \033[1;34m`cat $chemin_langue/sur` \033[1;32m$partition_mandriva\033[1;m"
        echo

	repertoire_partition_linux=$partition_linux

	echo "$partition_mandriva" > /tmp/monter_partition
        runme autoriser_monter_partition_oscar

	#repertoire_reel_linux=$repertoire_linux
	sortir_uuid_dev_repertoire_linux

	if (test -e $partition_montee_boot_mandriva/grub/menu.lst )
	then
		cp -f $partition_montee_boot_mandriva/grub/menu.lst $partition_montee_boot_mandriva/grub/menu.lst-$date_heure
		mot_passe_boot=`cat /etc/fichier_s`
		echo " " >> $partition_montee_boot_mandriva/grub/menu.lst
		echo "title=OSCAR $version_oscar_cdrom" >> $partition_montee_boot_mandriva/grub/menu.lst
		echo "password --md5 $mot_passe_boot" >> $partition_montee_boot_mandriva/grub/menu.lst
		uuid_partition_oscar=`cat /tmp/temp_uuid_oscar`
		
		#change_lettre_disque_si_demarre_usb
		echo "root ($nom_disque_oscar_grub,$numero_hd_oscar)" >> $partition_montee_boot_mandriva/grub/menu.lst
	fi
	if ( test -e $partition_linux/usr/share/oscar/usr/options_boot )
	then
		options_boot=`cat $partition_linux/usr/share/oscar/usr/options_boot`
	else
		options_boot=
	fi

	if (test -e $partition_montee_boot_mandriva/grub/menu.lst )
	then
		if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
		then
			if ! [ "$test_vol_id" = "" ] # partition OSCAR qui possède UUID
			then
				echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=UUID=`cat /tmp/temp_uuid_oscar` $resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> $partition_montee_boot_mandriva/grub/menu.lst
			else # partition OSCAR qui ne possede pas d'UUID
				echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=/dev/$repertoire_linux $resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> $partition_montee_boot_mandriva/grub/menu.lst
			fi
		else
			if ! [ "$test_vol_id" = "" ] # partition OSCAR qui possède UUID
			then
				echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=/dev/ram0 init=/linuxrc ramdisk=8192 real_root=UUID=`cat /tmp/temp_uuid_oscar` udev vga=$resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> $partition_montee_boot_mandriva/grub/menu.lst
			else # partition OSCAR qui ne possede pas d'UUID
				echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=/dev/ram0 init=/linuxrc ramdisk=8192 real_root=/dev/$repertoire_linux udev vga=$resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> $partition_montee_boot_mandriva/grub/menu.lst
			fi
		fi
		echo "initrd ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar.igz" >> $partition_montee_boot_mandriva/grub/menu.lst
	fi
	rm -f /tmp/temp_uuid_oscar
    fi
    # umount $partition_montee_boot_mandriva ; sync
fi
}
#----------------------------------------------------------------------------------------------------
installation_eventuelle_ubuntu()
{
rechercher_si_ubuntu_installe

if [ "$partition_ubuntu" = "non" ]
then 
	return
else
	version_ubuntu=`cat /tmp/version_ubuntu`
	rm -f /tmp/version_ubuntu
	echo
	if [ "$afficher_systeme_linux_installe" = "Ubuntu" ]
	then
		echo -e "`cat $chemin_langue/texte_58` \033[1;32m$partition_ubuntu\033[1;m"
	elif [ "$afficher_systeme_linux_installe" = "Mandriva" ]
	then
		echo -e "`cat $chemin_langue/texte_59` \033[1;32m$partition_ubuntu\033[1;m"
	fi
	echo
	# installer lilo pour Ubuntu
	repertoire_partition_linux=$partition_linux
	cp -fg /mnt/$partition_ubuntu/boot/vmlinuz-$version_ubuntu $repertoire_partition_linux/boot/
	cp -fg /mnt/$partition_ubuntu/boot/initrd.img-$version_ubuntu $repertoire_partition_linux/boot/
	echo "$version_ubuntu" > $repertoire_partition_linux/usr/share/oscar/usr/version_ubuntu_oscar
	
	echo "image = /boot/vmlinuz-$version_ubuntu" >> /etc/lilo.conf
	echo "     label = Ubuntu" >> /etc/lilo.conf
	echo "     root = /dev/$partition_ubuntu" >> /etc/lilo.conf
	echo "     initrd = /boot/initrd.img-$version_ubuntu" >> /etc/lilo.conf
	echo "     read-only" >> /etc/lilo.conf
fi
}
#----------------------------------------------------------------------------------------------------
change_lettre_disque_si_demarre_usb()
{
if (test -e /tmp/lettres_disques_sd ) ||  [ "$change_lettre_sd_pour_usb" = "oui" ]
then
	valeur_repertoire_oscar=`expr substr $repertoire_reel_linux 4 3`
	if (test -e /tmp/lettres_disques_sd )
	then
		change_lettre_sd_pour_usb=oui
		memoire_lettres_disque_sd=`cat /tmp/lettres_disques_sd`
		rm -f /tmp/lettres_disques_sd	# car derniere utilisation
	fi	
	repertoire_reel_oscar=$memoire_lettres_disque_sd$valeur_repertoire_oscar
else
	repertoire_reel_oscar=$repertoire_reel_linux
fi
}
#----------------------------------------------------------------------------------------------------
chercher_disque_oscar_pour_grub()
{
echo "" > /tmp/cherche_oscar_pour_grub
runme cherche_disque_boot
rm -f /tmp/cherche_oscar_pour_grub
# cherche numero_grub_oscar
if ( test -e /tmp/ordre_reel_disques_grub )
then
	cp -f /tmp/ordre_reel_disques_grub /tmp/tempfile
else
	cp -f /tmp/ordre_disques_grub /tmp/tempfile
fi 
nom_disque_oscar_1=`cat /tmp/partition_installer_oscar`
nom_disque_oscar=`expr substr $nom_disque_oscar_1 1 3`

echo "grep -i \"$nom_disque_oscar\" /tmp/tempfile > /tmp/tempfile2" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom
cut -d "," -f2 /tmp/tempfile2 > /tmp/tempfile
nom_disque_oscar_grub=hd`cat /tmp/tempfile`
rm -f /tmp/tempfile
rm -f /tmp/tempfile2
}
#----------------------------------------------------------------------------------------------------
faire_demarrage_mandriva()
{
# Le fichier /tmp/tempmandriva	est ici de la forme apres retrait de #oscar#
		#title Mandriva
		#kernel (hd0,0)/boot/vmlinuz root=/dev/hda1  resume=/dev/hda5 splash=silent vga=788
		#initrd (hd0,0)/boot/initrd.img

uuid_mandriva=`cat /tmp/uuid_$valeur_commun`
uuid_ubuntu_mandriva=$uuid_mandriva
partition_mandriva=`cat /tmp/partition_$valeur_commun`
numero_hd_mandriva=`cat /tmp/numero_hd_$valeur_commun`
version_mandriva=`cat /tmp/version_$valeur_commun`
numero_disque_grub_mandriva=`cat /tmp/numero_disque_grub_$valeur_commun`

controle_menu=`expr substr $partition_mandriva 1 2`
if [ "$controle_menu" != "sd" ] && [ "$controle_menu" != "hd" ]
then
	return
fi

if ! ( [ "$numero_disque_grub_mandriva" = "0" ] || [ "$numero_disque_grub_mandriva" = "1" ] || [ "$numero_disque_grub_mandriva" = "2" ] || [ "$numero_disque_grub_mandriva" = "3" ] || [ "$numero_disque_grub_mandriva" = "4" ] )
then
	trouver_numero_disque_grub=$numero_disque_grub_mandriva
	recuperer_numero_disque_grub
	numero_disque_grub_mandriva=$trouver_numero_disque_grub
fi
nom_mandriva=$title_ligne_mandriva

# remplacer uuid par uuid_ubuntu:
cp -f /tmp/kernel_ligne_mandriva /tmp/temp
grep -ci "UUID" /tmp/temp > /tmp/temp1
test_UUID=`cat /tmp/temp1`
if ! [ "$test_UUID" = "0" ]
then
	perl -pi -e 's/root=UUID=/{/g;' /tmp/temp
	cut -d"{" -f2 /tmp/temp > /tmp/temp1
	cut -d" " -f1 /tmp/temp1 > /tmp/temp
	uuid_ancien=`cat /tmp/temp`
	echo "perl -pi -e 's/$uuid_ancien/$uuid_mandriva/g;'  /tmp/kernel_ligne_mandriva" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
else # si openSUSE remplacer /dev/disk/by-id/xxx-partx par /dev/sdax
	grep -ci "by-id" /tmp/temp > /tmp/temp1
	test_byid=`cat /tmp/temp1`
	if ! [ "$test_byid" = "0" ]
	then
		grep -i "by-id" /tmp/temp > /tmp/temp1
		perl -pi -e 's/disk\/by-id\//{/g;' /tmp/temp1
		perl -pi -e 's/-part/{/g;' /tmp/temp1
		cut -d"{" -f2 /tmp/temp1 > /tmp/temp_by_id_mandriva
	fi
fi
rm -f /tmp/temp
rm -f /tmp/temp1
rm -f /tmp/temp2

if ! ( test -e /etc/installer_grub2 )
then
	echo " " >> /etc/grub.conf
	echo "title=$nom_mandriva $version_mandriva" >> /etc/grub.conf
else
	titre_menuentry="$nom_mandriva $version_mandriva"
fi
#	echo
#	echo -e "`cat $chemin_langue/texte_65` \033[1;31m$nom_mandriva \033[1;34m`cat $chemin_langue/sur` \033[1;32m$partition_mandriva_normale\033[1;m"
#	echo

if [ "$nombre_partition_linux_juste_boot" = "1" ]	# une partition linux juste /boot
then
	if ( test -e /mnt/$partition_mandriva/boot/grub/menu.lst ) # possible avec chainloader
	then
		if ! ( test -e /etc/installer_grub2 )
		then
			echo "root (hd$numero_disque_grub_mandriva,$numero_hd_mandriva)" >> /etc/grub.conf
		else
			hd_disque_ubuntu_mandriva=hd$numero_disque_grub_mandriva
			hd_partition_ubuntu_mandriva=$numero_hd_mandriva
		fi
	else
		if ! ( test -e /etc/installer_grub2 )
		then
			echo "root (hd$numero_disque_grub_partition_juste_boot,$numero_hd_boot_grub)" >> /etc/grub.conf
		else
			hd_disque_ubuntu_mandriva=hd$numero_disque_grub_partition_juste_boot
			hd_partition_ubuntu_mandriva=$numero_hd_boot_grub
		fi
	fi
	
	if ! ( test -e /etc/installer_grub2 )
	then
		echo "kernel (hd$numero_disque_grub_partition_juste_boot,$numero_hd_boot_grub)/vmlinuz`cat /tmp/kernel_ligne_mandriva`" >> /etc/grub.conf
	else
		echo "kernel (hd$numero_disque_grub_partition_juste_boot,$numero_hd_boot_grub)/vmlinuz`cat /tmp/kernel_ligne_mandriva`" > /tmp/kernel_ligne_ubuntu_mandriva
	fi
	

	grep -ci "\/boot\/" /tmp/kernel_ligne_mandriva > /tmp/tempfile
	reponse=`cat /tmp/tempfile`
	rm -f /tmp/tempfile
	if [ "$reponse" = "0" ]	# pas de repertoire boot
	then
		if ! ( test -e /etc/installer_grub2 )
		then
			echo "initrd (hd$numero_disque_grub_partition_juste_boot,$numero_hd_boot_grub)/initrd$version_mandriva" >> /etc/grub.conf
		else
			echo "(hd$numero_disque_grub_partition_juste_boot,$numero_hd_boot_grub)/initrd$version_mandriva" > /tmp/ligne_initrd_ubuntu_mandriva
		fi
	else
		if ! ( test -e /etc/installer_grub2 )
		then
			echo "initrd (hd$numero_disque_grub_partition_juste_boot,$numero_hd_boot_grub)/boot/initrd.img-$version_mandriva" >> /etc/grub.conf
		else
			echo "(hd$numero_disque_grub_partition_juste_boot,$numero_hd_boot_grub)/boot/initrd.img-$version_mandriva" > /tmp/ligne_initrd_ubuntu_mandriva
		fi
		
	fi
else
	if ! ( test -e /etc/installer_grub2 )
	then
		echo "root (hd$numero_disque_grub_mandriva,$numero_hd_mandriva)" >> /etc/grub.conf
	else
		hd_disque_ubuntu_mandriva=hd$numero_disque_grub_mandriva
		hd_partition_ubuntu_mandriva=$numero_hd_mandriva
	fi
	if ! ( test -e /etc/installer_grub2 )
	then
		echo "kernel (hd$numero_disque_grub_mandriva,$numero_hd_mandriva)/boot/vmlinuz`cat /tmp/kernel_ligne_mandriva`" >> /etc/grub.conf
		echo "initrd (hd$numero_disque_grub_mandriva,$numero_hd_mandriva)/boot/initrd$version_mandriva" >> /etc/grub.conf
	else
		echo "kernel (hd$numero_disque_grub_mandriva,$numero_hd_mandriva)/boot/vmlinuz`cat /tmp/kernel_ligne_mandriva`" > /tmp/kernel_ligne_ubuntu_mandriva
		echo "(hd$numero_disque_grub_mandriva,$numero_hd_mandriva)/boot/initrd$version_mandriva" > /tmp/ligne_initrd_ubuntu_mandriva
	fi
fi

# si openSUSE remplacer by-id pour les clients et modele dans /etc/grub.conf
if ( test -e /tmp/temp_by_id_mandriva )
then
	if ! ( test -e /etc/installer_grub2 )
	then
		disque_mandriva=`expr substr $partition_mandriva 1 3`
		by_id_mandriva=`cat /tmp/temp_by_id_mandriva`
		echo "perl -pi -e 's/disk\/by-id\/$by_id_mandriva-part/$disque_mandriva/g;'  /etc/grub.conf" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
		rm -f /tmp/exec_nom
		rm -f /tmp/temp_by_id_mandriva
	fi
	
	# remplacer by-id pour les clients et modele dans /etc/fstab de openSUSE
	echo "$partition_mandriva" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	rm -f /tmp/monter_partition
	cp -f /mnt/$partition_mandriva/etc/fstab /mnt/$partition_mandriva/etc/fstab-$date_heure
	echo "perl -pi -e 's/disk\/by-id\/$by_id_mandriva-part/$disque_mandriva/g;'  /mnt/$partition_mandriva/etc/fstab" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
fi

rm -f /tmp/kernel_ligne_mandriva
rm -f /tmp/global_mandriva	# pour plusieurs partitions mandriva
}
#----------------------------------------------------------------------------------------------------
faire_demarrage_ubuntu()
{
uuid_ubuntu=`cat /tmp/uuid_$valeur_commun`
uuid_ubuntu_mandriva=$uuid_ubuntu
partition_ubuntu=`cat /tmp/partition_$valeur_commun`
numero_hd_ubuntu=`cat /tmp/numero_hd_$valeur_commun`
version_ubuntu=`cat /tmp/version_$valeur_commun`
numero_partition_juste_grub=`cat /tmp/numero_partition_juste_grub_$valeur_commun`

controle_menu=`expr substr $partition_ubuntu 1 2`
if [ "$controle_menu" != "sd" ] && [ "$controle_menu" != "hd" ]
then
	return
fi

numero_disque_grub_ubuntu=`cat /tmp/numero_disque_grub_$valeur_commun`
if ! [ "$nombre_valeur_grub2" = "1" ]
then
	#valeur_titre=Ubuntu-$version_ubuntu
	if ! [ "$afficher_systeme_linux_installe" = "Mandriva" ]	# partition Ubuntu
	then
		valeur_titre="`cat /tmp/titre_linux_grub_$valeur_commun`, noyau $version_ubuntu"
		valeur_titre_test=`cat /tmp/titre_linux_grub_$valeur_commun`
		if [ "$valeur_titre_test" = "" ]
		then
		    valeur_titre="Ubuntu, noyau $version_ubuntu"
		fi
	else	# Mandriva
		valeur_titre=`cat /tmp/titre_linux_grub_$valeur_commun`
	fi

	if ! ( [ "$numero_disque_grub_ubuntu" = "0" ] || [ "$numero_disque_grub_ubuntu" = "1" ] || [ "$numero_disque_grub_ubuntu" = "2" ] || [ "$numero_disque_grub_ubuntu" = "3" ] || [ "$numero_disque_grub_ubuntu" = "4" ] )
	then
		trouver_numero_disque_grub=$numero_disque_grub_ubuntu
		recuperer_numero_disque_grub
		numero_disque_grub_ubuntu=$trouver_numero_disque_grub
	fi

	# remplacer uuid par uuid_ubuntu:
	cp -f /tmp/kernel_ligne_ubuntu /tmp/temp
	grep -ci "UUID" /tmp/temp > /tmp/temp1
	test_UUID=`cat /tmp/temp1`
	if ! [ "$test_UUID" = "0" ]
	then
		perl -pi -e 's/root=UUID=/{/g;' /tmp/temp
		cut -d"{" -f2 /tmp/temp > /tmp/temp1
		cut -d" " -f1 /tmp/temp1 > /tmp/temp
		uuid_ancien=`cat /tmp/temp`
		echo "perl -pi -e 's/$uuid_ancien/$uuid_ubuntu/g;'  /tmp/kernel_ligne_ubuntu" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom	
		rm -f /tmp/exec_nom
	else	# contient /dev/sdai
		perl -pi -e 's/root=\/dev\//{/g;' /tmp/temp
		cut -d"{" -f2 /tmp/temp > /tmp/temp1
		cut -d" " -f1 /tmp/temp1 > /tmp/temp
		partition_ancien=`cat /tmp/temp`
		echo "perl -pi -e 's/$partition_ancien/$partition_ubuntu/g;'  /tmp/kernel_ligne_ubuntu" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom	
		rm -f /tmp/exec_nom
	fi
	rm -f /tmp/temp
	rm -f /tmp/temp1
	if ! ( test -e /etc/installer_grub2 )
	then
		echo " " >> /etc/grub.conf
		echo "title=$valeur_titre" >> /etc/grub.conf
	else
		titre_menuentry=$valeur_titre
	fi
	if [ "$nombre_partition_linux_juste_boot" = "1" ]	# une partition linux juste /boot
	then
		if ( test -e /mnt/$partition_ubuntu/boot/grub/menu.lst ) # possible avec chainloader
		then
			# remplacer root par uuid en decembre 2009 a partir de Jaunty
			#	if [ "$uuid_ubuntu" = "" ]
			#	then
		if ! ( test -e /etc/installer_grub2 )
		then
			echo "root (hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub)" >> /etc/grub.conf
		else
			hd_disque_ubuntu_mandriva=hd$numero_disque_grub_ubuntu
			hd_partition_ubuntu_mandriva=$numero_partition_juste_grub
		fi
			#	else
			#		echo "uuid $uuid_ubuntu" >> /etc/grub.conf
			#	fi
		else
			if ! ( test -e /etc/installer_grub2 )
			then
				# echo "root (hd$numero_disque_grub_partition_juste_boot,$numero_hd_boot_grub)" >> /etc/grub.conf
				echo "root (hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub)" >> /etc/grub.conf
			else
				hd_disque_ubuntu_mandriva=hd$numero_disque_grub_partition_juste_boot
				hd_partition_ubuntu_mandriva=$numero_partition_juste_grub
			fi
		fi
		
		# ajouter si besoin [hdi,j) dans la ligne kernel : kernel (hdi,j)/
		echo "hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub" > /tmp/temp_kernel_hd
		grep -ci "`cat /tmp/temp_kernel_hd`" /tmp/kernel_ligne_ubuntu > /tmp/temp_nombre_kernel_hd
		temp_nombre_kernel_hd=`cat /tmp/temp_nombre_kernel_hd`
		rm -f /tmp/temp_nombre_kernel_hd
		if [ "$temp_nombre_kernel_hd" = "0" ]
		then
			echo "perl -pi -e 's/kernel /kernel __OSCAR__hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub--RACSO__/g;' /tmp/kernel_ligne_ubuntu" > /tmp/exec_nom
			chmod +x /tmp/exec_nom
			/tmp/exec_nom
			rm -f /tmp/exec_nom
			perl -pi -e 's/__OSCAR__/\(/g; s/--RACSO__/\)/g;' /tmp/kernel_ligne_ubuntu
		fi
		if ! ( test -e /etc/installer_grub2 )
		then
			echo "`cat /tmp/kernel_ligne_ubuntu`" >> /etc/grub.conf
		else
			cp -f /tmp/kernel_ligne_ubuntu /tmp/kernel_ligne_ubuntu_mandriva
		fi
		
		
		grep -ci "\/boot\/" /tmp/kernel_ligne_ubuntu > /tmp/tempfile
		reponse=`cat /tmp/tempfile`
		rm -f /tmp/tempfile
		if [ "$reponse" = "0" ]	# pas de repertoire boot
		then
			if ! [ "$afficher_systeme_linux_installe" = "Mandriva" ]
			then
				if ! ( test -e /etc/installer_grub2 )
				then
					echo "initrd (hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub)/initrd.img-$version_ubuntu" >> /etc/grub.conf
				else
					echo "(hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub)/initrd.img-$version_ubuntu" > /tmp/ligne_initrd_ubuntu_mandriva
				fi
			else
				if ! ( test -e /etc/installer_grub2 )
				then
					echo "initrd (hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub)/initrd.img" >> /etc/grub.conf
				else
					echo "(hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub)/initrd.img" > /tmp/ligne_initrd_ubuntu_mandriva
				fi
			fi
		else
			if ! [ "$afficher_systeme_linux_installe" = "Mandriva" ]
			then
				if ! ( test -e /etc/installer_grub2 )
				then
					echo "initrd (hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub)/boot/initrd.img-$version_ubuntu" >> /etc/grub.conf
				else
					echo "(hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub)/boot/initrd.img-$version_ubuntu" > /tmp/ligne_initrd_ubuntu_mandriva
				fi
			else
				if ! ( test -e /etc/installer_grub2 )
				then
					echo "initrd (hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub)/boot/initrd.img" >> /etc/grub.conf
				else
					echo "(hd$numero_disque_grub_partition_juste_boot,$numero_partition_juste_grub)/boot/initrd.img" > /tmp/ligne_initrd_ubuntu_mandriva
				fi
			fi
		fi
	else
			# remplacer root par uuid en decembre 2009 a partir de Jaunty
			#	if [ "$uuid_ubuntu" = "" ]
			#	then
		if ! ( test -e /etc/installer_grub2 )
		then
			echo "root (hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub)" >> /etc/grub.conf
		else
			hd_disque_ubuntu_mandriva=hd$numero_disque_grub_ubuntu
			hd_partition_ubuntu_mandriva=$numero_partition_juste_grub
		fi
			#	else
			#		echo "uuid $uuid_ubuntu" >> /etc/grub.conf
			#	fi
		#perl -pi -e 's/vmlinuz/boot\/vmlinuz/g;' /tmp/kernel_ligne_ubuntu
		
		# ajouter (hdi,j) dans la ligne kernel : kernel (hdi,j)/
		echo "perl -pi -e 's/kernel /kernel __OSCAR__hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub--RACSO__/g;' /tmp/kernel_ligne_ubuntu" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom	
		rm -f /tmp/exec_nom
		perl -pi -e 's/__OSCAR__/\(/g; s/--RACSO__/\)/g;' /tmp/kernel_ligne_ubuntu
		
		if ! ( test -e /etc/installer_grub2 )
		then
			echo "`cat /tmp/kernel_ligne_ubuntu`" >> /etc/grub.conf
		else
			cp -f /tmp/kernel_ligne_ubuntu /tmp/kernel_ligne_ubuntu_mandriva
		fi
		grep -ci "\/boot\/" /tmp/kernel_ligne_ubuntu > /tmp/tempfile
		reponse=`cat /tmp/tempfile`
		rm -f /tmp/tempfile
		if [ "$reponse" = "0" ]	# pas de repertoire boot
		then
			if ! [ "$afficher_systeme_linux_installe" = "Mandriva" ]
			then
				if ! ( test -e /etc/installer_grub2 )
				then
					echo "initrd (hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub)/initrd.img-$version_ubuntu" >> /etc/grub.conf
				else
					echo "(hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub)/initrd.img-$version_ubuntu" > /tmp/ligne_initrd_ubuntu_mandriva
				fi
			else
				if ! ( test -e /etc/installer_grub2 )
				then
					echo "initrd (hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub)/initrd.img" >> /etc/grub.conf
				else
					echo "(hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub)/initrd.img" > /tmp/ligne_initrd_ubuntu_mandriva
				fi
			fi
		else
			if ! [ "$afficher_systeme_linux_installe" = "Mandriva" ]
			then
				if ! ( test -e /etc/installer_grub2 )
				then
					echo "initrd (hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub)/boot/initrd.img-$version_ubuntu" >> /etc/grub.conf
				else
					echo "(hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub)/boot/initrd.img-$version_ubuntu" > /tmp/ligne_initrd_ubuntu_mandriva
				fi
			else
				if ! ( test -e /etc/installer_grub2 )
				then
					echo "initrd (hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub)/boot/initrd.img" >> /etc/grub.conf
				else
					echo "(hd$numero_disque_grub_ubuntu,$numero_partition_juste_grub)/boot/initrd.img" > /tmp/ligne_initrd_ubuntu_mandriva
				fi
			fi
		fi
	fi
else
	valeur_titre=`cat /tmp/titre_linux_grub_$valeur_commun`
	
	if ! ( test -e /etc/installer_grub2 )
	then
		echo " " >> /etc/grub.conf
		echo "title=$valeur_titre" >> /etc/grub.conf
		echo "root (hd$numero_disque_ubuntu,$numero_partition_juste_grub)" >> /etc/grub.conf
		# au lieu du chainloader les 2 lignes suivantes :
		echo "kernel (hd$numero_disque_ubuntu,$numero_partition_juste_grub)/boot/vmlinuz-`cat /tmp/kernel_ligne_ubuntu`" >> /etc/grub.conf
	else
		titre_menuentry=$valeur_titre
		hd_disque_ubuntu_mandriva=hd$numero_disque_ubuntu
		hd_partition_ubuntu_mandriva=$numero_partition_juste_grub
		echo "kernel (hd$numero_disque_ubuntu,$numero_partition_juste_grub)/boot/vmlinuz-`cat /tmp/kernel_ligne_ubuntu`" > /tmp/kernel_ligne_ubuntu_mandriva
	fi
	
	if ! [ "$afficher_systeme_linux_installe" = "Mandriva" ]
	then
		if ! ( test -e /etc/installer_grub2 )
		then
			echo "initrd (hd$numero_disque_ubuntu,$numero_partition_juste_grub)/boot/initrd.img-$version_ubuntu" >> /etc/grub.conf
		else
			echo "(hd$numero_disque_ubuntu,$numero_partition_juste_grub)/boot/initrd.img-$version_ubuntu" > /tmp/ligne_initrd_ubuntu_mandriva
		fi
	else
		if ! ( test -e /etc/installer_grub2 )
		then
			echo "initrd (hd$numero_disque_ubuntu,$numero_partition_juste_grub)/boot/initrd.img" >> /etc/grub.conf
		else
			echo "(hd$numero_disque_ubuntu,$numero_partition_juste_grub)/boot/initrd.img" > /tmp/ligne_initrd_ubuntu_mandriva
		fi
	fi
	# echo "chainloader +1" >> /etc/grub.conf
fi
rm -f /tmp/kernel_ligne_ubuntu
rm -f /tmp/global_ubuntu	# pour plusieurs partitions ubuntu
}
#----------------------------------------------------------------------------------------------------
caracteristiques_mandriva()
{
cp -f /tmp/global_mandriva /tmp/global_commun
valeur_commun=mandriva
prendre_valeurs_ligne_commun
}
#----------------------------------------------------------------------------------------------------
ligne_par_ligne_commun()
{

# sans grub2 : echo "$partition_ubuntu?$numero_hd_ubuntu?$uuid_ubuntu?`cat /tmp/kernel_ligne_ubuntu`?$version_ubuntu?$numero_disque_grub?$ubuntu_titre?$numero_disque_ubuntu?$numero_partition_juste_grub" >> /tmp/global_ubuntu	# pour plusieurs partitions ubuntu
# pour grub2 : echo "$partition_ubuntu?$numero_hd_ubuntu?$uuid_ubuntu?`cat /tmp/kernel_ligne_ubuntu_grub2`?$version_ubuntu_grub2?$numero_disque_grub?$ubuntu_titre?$numero_disque_ubuntu?$numero_partition_juste_grub" >> /tmp/global_ubuntu	# pour plusieurs partitions ubuntu

cut -d"{" -f1 /tmp/tempfileligne > /tmp/tempfileligne1
test_derniere_ligne_commun=`cat /tmp/tempfileligne1`
if ! [ "$test_derniere_ligne_commun" = "" ]
then
	# prendre les valeurs de la ligne
	cut -d"?" -f1 /tmp/tempfileligne > /tmp/partition_$valeur_commun
	cut -d"?" -f2 /tmp/tempfileligne > /tmp/numero_hd_$valeur_commun
	cut -d"?" -f3 /tmp/tempfileligne > /tmp/uuid_$valeur_commun
	cut -d"?" -f4 /tmp/tempfileligne > /tmp/kernel_ligne_$valeur_commun
	
	cut -d"?" -f5 /tmp/tempfileligne > /tmp/tempfileligne2
	cut -d"{" -f1 /tmp/tempfileligne2 > /tmp/version_$valeur_commun
		
	cut -d"?" -f6 /tmp/tempfileligne > /tmp/numero_disque_grub_$valeur_commun
	cut -d"?" -f7 /tmp/tempfileligne > /tmp/tempfileligne2
	cut -d"{" -f1 /tmp/tempfileligne2 > /tmp/titre_linux_grub_$valeur_commun
	
	grep -ci "_GRUB2_" /tmp/version_$valeur_commun > /tmp/nombre_valeur_grub2
	nombre_valeur_grub2=`cat /tmp/nombre_valeur_grub2`
	if [ "$nombre_valeur_grub2" = "1" ]
	then
		perl -pi -e 's/_GRUB2_//g;' /tmp/version_$valeur_commun
		cut -d"?" -f8 /tmp/tempfileligne > /tmp/numero_disque_$valeur_commun
	fi
	
	cut -d"?" -f9 /tmp/tempfileligne > /tmp/tempfileligne2
	cut -d"{" -f1 /tmp/tempfileligne2 > /tmp/numero_partition_juste_grub_$valeur_commun
	
	rm -f /tmp/tempfileligne2
	faire_demarrage_$valeur_commun
	if ( test -e /etc/installer_grub2 )
	then
		faire_menuentry_ubuntu_mandriva_40_custom
	fi
	# supprimer cette ligne:
	perl -pi -e 's/\//__oscar__/g; s/\?/___racso___/g;' /tmp/tempfileligne
	perl -pi -e 's/\//__oscar__/g; s/\?/___racso___/g;' /tmp/tempfileligne1
	perl -pi -e 's/\(/__os1car__/g; s/\)/__os2car__/g;' /tmp/tempfileligne
	perl -pi -e 's/\(/__os1car__/g; s/\)/__os2car__/g;' /tmp/tempfileligne1
	perl -pi -e 's/\$/__os3car__/g;' /tmp/tempfileligne
	perl -pi -e 's/\$/__os3car__/g;' /tmp/tempfileligne1
	# installe le demarrage Linux
	echo
	echo -e "\033[1;33m OSCAR \033[1;34m`cat $chemin_langue/menu_658a` ..."
	echo
	echo "perl -pi -e 's/`cat /tmp/tempfileligne1`{//g; s/||||//g;' /tmp/tempfileligne" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
	perl -pi -e 's/__oscar__/\//g; s/___racso___/\?/g;' /tmp/tempfileligne
	perl -pi -e 's/__os1car__/\(/g; s/__os2car__/\)/g;' /tmp/tempfileligne
	perl -pi -e 's/__os3car__/\$/g;' /tmp/tempfileligne
	umount /mnt/`cat /tmp/partition_$valeur_commun` 1>/dev/null 2>/dev/null ; sync
	ligne_par_ligne_commun
else
	rm -f /tmp/uuid_$valeur_commun
	rm -f /tmp/partition_$valeur_commun
	rm -f /tmp/numero_hd_$valeur_commun
	rm -f /tmp/version_$valeur_commun
	rm -f /tmp/numero_disque_grub_$valeur_commun
	rm -f /tmp/numero_disque_$valeur_commun
	rm -f /tmp/titre_linux_grub_$valeur_commun
	rm -f /tmp/global_commun
	rm -f /tmp/numero_partition_juste_grub
	return
fi
}
#----------------------------------------------------------------------------------------------------
prendre_valeurs_ligne_commun()
{
# supprimer les sauts de ligne:
echo `gawk '{ print $0 "{" } ' /tmp/global_commun` | perl -pi -e 's/{ /{/g;' > /tmp/tempfileligne
ligne_par_ligne_commun
rm -f /tmp/tempfileligne
rm -f /tmp/tempfileligne1
}
#----------------------------------------------------------------------------------------------------
caracteristiques_ubuntu()
{
cp -f /tmp/global_ubuntu /tmp/global_commun
valeur_commun=ubuntu
prendre_valeurs_ligne_commun
}
#----------------------------------------------------------------------------------------------------
faire_prive_40_custom()
{
echo "
`cat /etc/conf.d/prive_40_custom`
" >> /etc/grub.d/40_custom
}
#----------------------------------------------------------------------------------------------------
faire_windows_chainloader_40_custom()
{
hd_partition_windows=$[$numero_hd_windows+1]
# uuid partition windows :
echo "$partition_windows" > /tmp/temp_sdai
remplacer_sdai_par_uuid	# sdai dans /tmp/temp_sdai resultat dans /tmp/temp_sdai
uuid_partition_windows=`cat /tmp/temp_sdai`
rm -f tmp/temp_sdai
# search --no-floppy --fs-uuid --set=root $uuid_partition_windows # a mettre entre set root et chainloader si besoin
echo "
menuentry \"Windows\"  {
insmod part_msdos
insmod ntfs
set root=(hd$numero_disque_grub_windows,$hd_partition_windows)
chainloader +1
}
" >> /etc/grub.d/40_custom
}
#----------------------------------------------------------------------------------------------------
debut_40_custom()
{
if ! ( test -e /usr/share/oscar/usr/superuser_oscar )
then # car reparation_boot par cederom
	if [ "$repertoire_partition_linux" = "" ]	# car demarrage avec plusieurs partitions linux demande par boite_partition_linux
	then
		repertoire_partition_linux=$partition_linux
	fi
	cp -f $repertoire_partition_linux/usr/share/oscar/usr/superuser_oscar /usr/share/oscar/usr/superuser_oscar
	cp -f $repertoire_partition_linux/usr/share/oscar/usr/crypt_mot_passe_pbkdf2 /usr/share/oscar/usr/crypt_mot_passe_pbkdf2
fi

echo "#!/bin/sh
exec tail -n +3 \$0

set superusers=\"`cat /usr/share/oscar/usr/superuser_oscar`\"
password_pbkdf2 `cat /usr/share/oscar/usr/superuser_oscar` `cat /usr/share/oscar/usr/crypt_mot_passe_pbkdf2`

" > /etc/grub.d/40_custom

supprimer_30_os=
if ( test -e /etc/installe_oscar_seul )
then
	supprimer_30_os=oui
	rm -f /etc/grub.d/30_os-prober
	if ! [ "$partition_windows" = "non" ]
	then
		faire_windows_chainloader_40_custom
	fi
fi
if ( test -e /etc/conf.d/prive_40_custom )
then
	faire_prive_40_custom
else
	rm -f $repertoire_partition_linux/usr/share/oscar/usr/prive_40_custom
	rm -f $repertoire_partition_linux/etc/conf.d/prive_40_custom
fi
}
#----------------------------------------------------------------------------------------------------
faire_menuentry_ubuntu_mandriva_40_custom()
{
# voir les sp faire_demarrage_ubuntu et faire_demarrage_mandriva
if [ "$oscar_realise_grub2_autres_linux" = "non" ]
then
	if ! ( test -e /etc/installe_oscar_seul )
	then
		return
	fi
fi

hd_partition_ubuntu_mandriva=$[$hd_partition_ubuntu_mandriva+1]
perl -pi -e 's/kernel //g;' /tmp/kernel_ligne_ubuntu_mandriva

# enlever (hd0,3) de debut des lignes :
grep -ci "(hd" /tmp/kernel_ligne_ubuntu_mandriva > /tmp/nb_hd_test
nb_hd_test=`cat /tmp/nb_hd_test`
if ! [ "$nb_hd_test" = "0" ]
then
	cut -d")" -f2 /tmp/kernel_ligne_ubuntu_mandriva > /tmp/kernel_ligne_ubuntu_mandriva1
	cp -f /tmp/kernel_ligne_ubuntu_mandriva1 /tmp/kernel_ligne_ubuntu_mandriva
fi
grep -ci "(hd" /tmp/ligne_initrd_ubuntu_mandriva > /tmp/nb_hd_test
nb_hd_test=`cat /tmp/nb_hd_test`
if ! [ "$nb_hd_test" = "0" ]
then
	cut -d")" -f2 /tmp/ligne_initrd_ubuntu_mandriva > /tmp/ligne_initrd_ubuntu_mandriva1
	cp -f /tmp/ligne_initrd_ubuntu_mandriva1 /tmp/ligne_initrd_ubuntu_mandriva
fi
rm -f /tmp/nb_hd_test
rm -f /tmp/kernel_ligne_ubuntu_mandriva1
rm -f /tmp/ligne_initrd_ubuntu_mandriva1

if [ "$nombre_partition_linux_juste_boot" = "1" ] # pour grub2
then
	# uuid partition_juste_boot :
	echo "$partition_juste_boot" > /tmp/temp_sdai
	remplacer_sdai_par_uuid	# sdai dans /tmp/temp_sdai resultat dans /tmp/temp_sdai
	uuid_partition_juste_boot=`cat /tmp/temp_sdai`
	rm -f tmp/temp_sdai
	uuid_ubuntu_mandriva=$uuid_partition_juste_boot
	perl -pi -e 's/\/boot//g;' /tmp/kernel_ligne_ubuntu_mandriva
	perl -pi -e 's/\/boot//g;' /tmp/ligne_initrd_ubuntu_mandriva
fi

echo "
menuentry \"$titre_menuentry\"  --class gnu-linux --class gnu --class os {
insmod ext2
set root=($hd_disque_ubuntu_mandriva,$hd_partition_ubuntu_mandriva)
search --no-floppy --fs-uuid --set=root $uuid_ubuntu_mandriva
linux `cat /tmp/kernel_ligne_ubuntu_mandriva`
initrd `cat /tmp/ligne_initrd_ubuntu_mandriva`
}
" >> /etc/grub.d/40_custom

rm -f /tmp/kernel_ligne_ubuntu_mandriva1
rm -f /tmp/ligne_initrd_ubuntu_mandriva1
}
#----------------------------------------------------------------------------------------------------
faire_40_custom_linux16()
{
# pour noyaux sur cdrom
echo "
menuentry \"$titre_menu\"  --class gnu-linux --class gnu --class os {
$debut_menugrub2
insmod ext2
set root=($nom_disque_oscar_grub,$numero_hd_oscar_grub2)
search --no-floppy --fs-uuid --set=root `cat /tmp/temp_uuid_oscar`
linux16 /boot/$kernel_oscar root=UUID=`cat /tmp/temp_uuid_oscar` $resolution_ecran setkmap=$choix_clavier nocdroot menuoscar=$choix_menu fin_ligne $options_boot
$fin_menugrub2
}
" >> /etc/grub.d/40_custom
}
#----------------------------------------------------------------------------------------------------
faire_40_custom()
{
echo "
menuentry \"$titre_menu\" $autorisation_oscar --class gnu-linux --class gnu --class os {
$debut_menugrub2
insmod ext2
set root=($nom_disque_oscar_grub,$numero_hd_oscar_grub2)
search --no-floppy --fs-uuid --set=root `cat /tmp/temp_uuid_oscar`
linux /boot/$kernel_oscar root=UUID=`cat /tmp/temp_uuid_oscar` $resolution_ecran setkmap=$choix_clavier nocdroot menuoscar=$choix_menu fin_ligne $options_boot
initrd /boot/oscar.igz
$fin_menugrub2
}
" >> /etc/grub.d/40_custom
}
#----------------------------------------------------------------------------------------------------
faire_oscar_40_custom()
{
if [ "$teste_disque_gpt" = gpt ] # demarrage gpt partition vfat
then # gpt
	autorisation_oscar=
	debut_menugrub2=
	fin_menugrub2=
else
	autorisation_oscar=
	debut_menugrub2="if legacy_check_password --md5 '`cat /etc/fichier_s`' ; then"
	fin_menugrub2="fi"
fi
echo "
menuentry \"OSCAR $version_oscar_cdrom\" $autorisation_oscar --class gnu-linux --class gnu --class os {
$debut_menugrub2
insmod ext2
set root=($nom_disque_oscar_grub,$numero_hd_oscar_grub2)
search --no-floppy --fs-uuid --set=root `cat /tmp/temp_uuid_oscar`
linux /boot/oscar root=UUID=`cat /tmp/temp_uuid_oscar` $resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot
initrd /boot/oscar.igz
$fin_menugrub2
}
" >> /etc/grub.d/40_custom
}
#----------------------------------------------------------------------------------------------------
menu_oscar_boot()
{
if ! ( test -e /etc/installer_grub2 )
then
	echo " " >> /etc/grub.conf
	echo "title=$titre_menu" >> /etc/grub.conf
	echo "$mot_passe_boot" >> /etc/grub.conf
	#repertoire_reel_linux=$repertoire_linux

	#change_lettre_disque_si_demarre_usb
	echo "root ($nom_disque_oscar_grub,$numero_hd_oscar)" >> /etc/grub.conf

	if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
	then
		if ! [ "$uuid_partition_oscar" = "" ] # partition OSCAR qui possède UUID
		then
			echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/$kernel_oscar root=UUID=`cat /tmp/temp_uuid_oscar` $resolution_ecran setkmap=$choix_clavier nocdroot menuoscar=$choix_menu fin_ligne $options_boot" >> /etc/grub.conf
		else # partition OSCAR qui ne possède pas d'UUID
			echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/$kernel_oscar root=/dev/$repertoire_linux $resolution_ecran setkmap=$choix_clavier nocdroot menuoscar=$choix_menu fin_ligne $options_boot" >> /etc/grub.conf
		fi
		echo "initrd ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar.igz" >> /etc/grub.conf
	else
		if ! [ "$uuid_partition_oscar" = "" ] # partition OSCAR qui possède UUID
		then
			echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/$kernel_oscar root=/dev/ram0 init=/linuxrc ramdisk=8192 real_root=UUID=`cat /tmp/temp_uuid_oscar` udev vga=$resolution_ecran setkmap=$choix_clavier nocdroot menuoscar=$choix_menu fin_ligne $options_boot" >> /etc/grub.conf
		else # partition OSCAR qui ne possède pas d'UUID
			echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/$kernel_oscar root=/dev/ram0 init=/linuxrc ramdisk=8192 real_root=/dev/$repertoire_linux udev vga=$resolution_ecran setkmap=$choix_clavier nocdroot menuoscar=$choix_menu fin_ligne $options_boot" >> /etc/grub.conf
		fi
		echo "initrd ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar.igz" >> /etc/grub.conf
	fi
else
	if ! [ "$kernel_oscar" = netboot ]
	then
		faire_40_custom
	else
		faire_40_custom_linux16
	fi
fi
}
#----------------------------------------------------------------------------------------------------
extraire_version_oscar_cdrom()
{
cp -f /usr/share/oscar/usr/version_oscar /tmp/version_temp
cut -f2 -d"V" /tmp/version_temp > /tmp/tempfile_version
perl -pi -e 's/\\Z/!Z/g;' /tmp/tempfile_version
cut -f1 -d"\\" /tmp/tempfile_version > /tmp/version_temp
perl -pi -e 's/!/\\/g;' /tmp/version_temp
cut -f2 -d"n" /tmp/version_temp > /tmp/tempfile_version
version_oscar_cdrom=`cat /tmp/tempfile_version`
cut -f3 -d" " /tmp/tempfile_version > /tmp/version_temp
cut -f1 -d" " /tmp/version_temp > /tmp/tempfile_version
version_oscar_cdrom=`cat /tmp/tempfile_version`
rm -f /tmp/tempfile_version
rm -f /tmp/version_temp
}
#----------------------------------------------------------------------------------------------------
caracteristiques_ubuntu_mandriva()
{
if ! [ "$partition_ubuntu" = "rien_du_tout" ]
then
	caracteristiques_ubuntu
	rm -f /tmp/tempubuntu
fi
rm -f $partition_linux/usr/share/oscar/usr/grub_oscar_autres_systemes_ubuntu
if ! [ "$partition_mandriva" = "rien_du_tout" ]
then
	caracteristiques_mandriva
	# pour copier le /tmp/tempmandriva avec les #oscar# dans /usr/share/oscar/usr
	if ( test -e /tmp/tempmandriva )
	then
		cp -f /tmp/tempmandriva $partition_linux/usr/share/oscar/usr/grub_oscar_autres_systemes_ubuntu
	fi
fi
}
#----------------------------------------------------------------------------------------------------
ecrire_grub_conf_debut()
{
echo "default $numero_partition_boot" > /etc/grub.conf
echo "hiddenmenu" >> /etc/grub.conf
echo "timeout $option_delai_boot" >> /etc/grub.conf

mot_passe_boot=`cat /etc/fichier_s`

echo "password --md5 $mot_passe_boot" >> /etc/grub.conf
echo "splashimage ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/grub/splash.xpm.gz" >> /etc/grub.conf
# echo "splashimage ($disque_boot_grub,$numero_hd_oscar)/boot/grub/splash.xpm.gz" >> /etc/grub.conf
# echo "splashimage ($disque_boot_grub,$numero_hd_boot_grub)/boot/grub/splash.xpm.gz" >> /etc/grub.conf
echo "" >> /etc/grub.conf

# convertir le clavier pour grub :
#echo "cat ($nom_disque_oscar_grub,$numero_hd_oscar)/usr/share/oscar/usr/clavier/clavier_grub" >> /etc/grub.conf
echo "`cat $partition_linux/usr/share/oscar/usr/clavier/clavier_grub`" >> /etc/grub.conf

if ! [ "$partition_windows" = "non" ]
then
	echo " " >> /etc/grub.conf
	echo "title=Windows" >> /etc/grub.conf
	echo "rootnoverify (hd$numero_disque_grub_windows,$numero_hd_windows)" >> /etc/grub.conf
	echo "makeactive" >> /etc/grub.conf
	echo "chainloader +1" >> /etc/grub.conf
fi

caracteristiques_ubuntu_mandriva

if [ "$nombre_partition_linux_juste_boot" = "1" ] # pour grub
then
	perl -pi -e 's/\/boot\/vmlinuz/\/vmlinuz/g; s/\/boot\/initrd/\/initrd/g;' /etc/grub.conf

	# a verifier si existe encore :
	mount /dev/$partition_juste_boot /mnt/$partition_juste_boot 1>/dev/null 2>/dev/null
	cp -f /boot/grub/stage1 /mnt/$partition_juste_boot/grub/
	cp -f /boot/grub/stage2 /mnt/$partition_juste_boot/grub/
	cp -f /boot/grub/*_stage1_5 /mnt/$partition_juste_boot/grub/
fi
}
#----------------------------------------------------------------------------------------------------
faire_grub2_default()
{
# modifier /etc/default/grub
affichage_menu_grub=0
if ( test -e /etc/afficher_menu_grub )
then
	affichage_menu_grub=-1
fi
grep -v "GRUB_DEFAULT=" /etc/default/grub | grep -v "GRUB_TIMEOUT=" | grep -v "GRUB_HIDDEN_TIMEOUT=" | grep -v "GRUB_HIDDEN_TIMEOUT_QUIET=" | grep -v "GRUB_DISABLE_RECOVERY=" | grep -v "GRUB_BACKGROUND=" | grep -v "GRUB_GFXMODE" > /tmp/grub_default
echo "GRUB_DEFAULT=$numero_partition_boot
GRUB_TIMEOUT=$affichage_menu_grub
GRUB_HIDDEN_TIMEOUT=$[$option_delai_boot+1]
GRUB_HIDDEN_TIMEOUT_QUIET=false
GRUB_DISABLE_RECOVERY=true
GRUB_GFXMODE=$mode_graphique
GRUB_BACKGROUND=\"/usr/share/oscar/icones/grub2_oscar.jpg\"
" >> /tmp/grub_default

cp -f /tmp/grub_default /etc/default/grub
cp -f /etc/default/grub $partition_linux/usr/share/oscar/usr/etc_default_grub
rm -f /tmp/grub_default
}
#----------------------------------------------------------------------------------------------------
faire_grub_conf_pour_oscar()
{
chercher_disque_oscar_pour_grub
rechercher_si_windows_installe
if [ "$nombre_partition_linux_juste_boot" = "1" ]	# une partition linux juste /boot
then
	echo "$partition_boot_grub" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
fi

rm -f /etc/grub.conf
if ( test -e /etc/fichier_b )
then
	numero_partition_boot=`cat /etc/fichier_b`
else
	numero_partition_boot=`cat $partition_linux/usr/share/oscar/bin/fichier_b`
fi
if ( test -e $partition_linux/usr/share/oscar/usr/option_delai_boot )
then
	option_delai_boot=`cat $partition_linux/usr/share/oscar/usr/option_delai_boot`
else
	option_delai_boot=3
	echo "$option_delai_boot" > $partition_linux/usr/share/oscar/usr/option_delai_boot
fi
if ! ( test -e /etc/installer_grub2 )
then
	ecrire_grub_conf_debut
else
	numero_hd_oscar_grub2=$[$numero_hd_oscar+1]
	debut_40_custom
	caracteristiques_ubuntu_mandriva
fi

##### chercher_disque_oscar_pour_grub # deplace en haut de ce sp

# extraire version_oscar_cdrom
extraire_version_oscar_cdrom

sortir_uuid_dev_repertoire_linux
uuid_partition_oscar=`cat /tmp/temp_uuid_oscar`

if ( test -e $partition_linux/usr/share/oscar/usr/options_boot )
then
	options_boot=`cat $partition_linux/usr/share/oscar/usr/options_boot`
else
	options_boot=
fi

cherche_si_disque_gpt
# faire menu netboot :
choix_menu=netboot
autorisation_oscar=
#titre_menu="`cat $chemin_langue/Reseau_sans_accent`"
titre_menu="`cat $chemin_langue/mdp_10a`"
mot_passe_boot=
debut_menugrub2=
fin_menugrub2=
kernel_oscar=netboot
menu_oscar_boot

# faire menu installe netboot :
if ( test -e /sbin/ether-wake )
then
	choix_menu=net_programme
	# titre_menu="`cat $chemin_langue/Reseau_sans_accent` : OSCAR `cat $chemin_langue/mdp_10`"
	titre_menu="OSCAR `cat $chemin_langue/mdp_10`"
	mot_passe_boot="password --md5 `cat /etc/fichier_t`"
	if [ "$teste_disque_gpt" = gpt ] # demarrage gpt partition vfat
	then # gpt
		autorisation_oscar=
		debut_menugrub2=
		fin_menugrub2=
	else
		autorisation_oscar=
		debut_menugrub2="if legacy_check_password --md5 '`cat /etc/fichier_t`' ; then"
		fin_menugrub2="fi"
	fi
	kernel_oscar=oscar
	menu_oscar_boot
fi

# faire menu restaure :
choix_menu=restaure
titre_menu="OSCAR restaure"
autorisation_oscar=
mot_passe_boot="password --md5 `cat /etc/fichier_t`"
if [ "$teste_disque_gpt" = gpt ] # demarrage gpt partition vfat
then # gpt
	debut_menugrub2=
	fin_menugrub2=
else
	debut_menugrub2="if legacy_check_password --md5 '`cat /etc/fichier_t`' ; then"
	fin_menugrub2="fi"
fi
kernel_oscar=oscar
menu_oscar_boot

# faire menu client :
choix_menu=client
titre_menu="OSCAR client"
if [ "$teste_disque_gpt" = gpt ] # demarrage gpt partition vfat
then # gpt
	autorisation_oscar=
	debut_menugrub2=
	fin_menugrub2=
else
	mot_passe_boot="password --md5 `cat /etc/fichier_s`"
	autorisation_oscar=
	debut_menugrub2="if legacy_check_password --md5 '`cat /etc/fichier_s`' ; then"
	fin_menugrub2="fi"
fi
kernel_oscar=oscar
menu_oscar_boot

# faire menu OSCAR :
if ! ( test -e /etc/installer_grub2 )
then
	echo " " >> /etc/grub.conf
	echo "title=OSCAR $version_oscar_cdrom" >> /etc/grub.conf
	echo "password --md5 `cat /etc/fichier_s`" >> /etc/grub.conf
	#repertoire_reel_linux=$repertoire_linux
	
	# ici uuid impossible si partition juste boot
	echo "root ($nom_disque_oscar_grub,$numero_hd_oscar)" >> /etc/grub.conf
	
	if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
	then
		if ! [ "$uuid_partition_oscar" = "" ] # partition OSCAR qui possède UUID
		then
			echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=UUID=`cat /tmp/temp_uuid_oscar` $resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> /etc/grub.conf
		else # partition OSCAR qui ne possede pas d'UUID
			echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=/dev/$repertoire_linux $resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> /etc/grub.conf
		fi
		echo "initrd ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar.igz" >> /etc/grub.conf
	else
		if ! [ "$uuid_partition_oscar" = "" ] # partition OSCAR qui possède UUID
		then
			echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=/dev/ram0 init=/linuxrc ramdisk=8192 real_root=UUID=`cat /tmp/temp_uuid_oscar` udev vga=$resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> /etc/grub.conf
		else # partition OSCAR qui ne possede pas d'UUID
			echo "kernel ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar root=/dev/ram0 init=/linuxrc ramdisk=8192 real_root=/dev/$repertoire_linux udev vga=$resolution_ecran setkmap=$choix_clavier nocdroot fin_ligne $options_boot" >> /etc/grub.conf
		fi
		echo "initrd ($nom_disque_oscar_grub,$numero_hd_oscar)/boot/oscar.igz" >> /etc/grub.conf
	fi
	rm -f /tmp/temp_uuid_oscar
else
	faire_oscar_40_custom
	chmod +x /etc/grub.d/40_custom
	faire_grub2_default
fi

# mettre a jour les valeurs uuid des sdai autres systemes qu'OSCAR
if ! ( test -e /etc/lilo_expert )
then
	if ! ( test -e /etc/installer_grub2 )
	then
		cp -f /etc/grub.conf $partition_linux/boot/grub/grub.conf
	fi
	prendre_ligne_ubuntu_mandriva_pour_uuid	# mettre a jour uuid des lignes vmlinuz- pour reparer
	if [ "$fin_uuid_ubuntu_mandriva" = "oui" ]
	then
		return
	fi
	# ajouter sdai{uuid de grub.conf OSCAR
	if ( test -e /tmp/tempgrub_oscar )
	then
		cp -f /tmp/tempgrub_oscar /tmp/tempfstab1
		rm -f /tmp/tempgrub_oscar
		test_tempfstab1=`cat /tmp/tempfstab1`
		if [ "$test_tempfstab1" != ""  ]
		then
			# mettre en une ligne :
		    	echo `gawk '{ print $0 "{" } ' /tmp/tempfstab1` | perl -pi -e 's/ //g;' > /tmp/tempfile
			rm -f /tmp/tempfstab1
			changer_valeur_uuid
		fi
	fi
fi
}
#----------------------------------------------------------------------------------------------------
faire_conf_sysrcd_grub()	## fichier grub.conf pour sysrcd
{
installation_eventuelle_ubuntu_grub
faire_grub_conf_pour_oscar
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
faire_conf_grub()	## fichier grub.conf
{
installation_eventuelle_ubuntu_grub
faire_grub_conf_pour_oscar
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
faire_conf_sysrcd_lilo()	## fichier lilo.conf
{
#   faire_fstab # faire seulement en automatique
disque_table=$disque_boot		# disque boot d'origine	# dev/hda
rm -f /etc/lilo.conf
if ( test -e /etc/lilo_expert )
then
echo "#" >> /etc/lilo.conf
echo "#    Vous êtes en 'Expert' pour installer lilo en MBR :" >> /etc/lilo.conf
echo "#    Remplacez '/DISQUE_BOOT' par '/$disque_boot'" >> /etc/lilo.conf
echo "#" >> /etc/lilo.conf

disque_boot=DISQUE_BOOT
fi


resolution_ecran=`cat /etc/fichier_r`
teste_video=`expr substr $resolution_ecran 1 3`
if [ "$teste_video" = "vga" ]
then
	valeur_vga=$resolution_ecran
	valeur_video=
else # dans append
	valeur_vga=
	valeur_video=$resolution_ecran
fi
echo "boot = /$disque_boot" >> /etc/lilo.conf
echo "map = /boot/.map" >> /etc/lilo.conf
echo "#prompt" >> /etc/lilo.conf
echo "install = /boot/boot-menu.b" >> /etc/lilo.conf
echo "delay = 25" >> /etc/lilo.conf
echo "#vga = normal" >> /etc/lilo.conf
echo "#vga = 788 ou 791 " >> /etc/lilo.conf
echo "$valeur_vga" >> /etc/lilo.conf	
echo "keytable = /boot/fr.ktl" >> /etc/lilo.conf
echo "default = $type_partition" >> /etc/lilo.conf

installation_eventuelle_ubuntu
mot_passe_boot=`cat /etc/fichier_t`
	
echo "image = /boot/oscar" >> /etc/lilo.conf
echo "     label = OSCAR" >> /etc/lilo.conf
echo "     root = /dev/$repertoire_linux" >> /etc/lilo.conf
echo "     append = \"noapic $valeur_video  \"" >> /etc/lilo.conf
echo "     password = $mot_passe_boot" >> /etc/lilo.conf
echo "     read-only" >> /etc/lilo.conf

echo "other = /$partition_boot" >> /etc/lilo.conf
echo "     label = $type_partition" >> /etc/lilo.conf
echo "     table = /$disque_table" >> /etc/lilo.conf

if ( test -e /etc/lilo_expert )
then
	disque_boot=$disque_table
fi
}
#-----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
faire_conf_lilo()	## fichier lilo.conf
{
#   faire_fstab # faire seulement en automatique
disque_table=$disque_boot		# disque boot d'origine	# dev/hda
rm -f /etc/lilo.conf
if ( test -e /etc/lilo_expert )
then
	echo "#" >> /etc/lilo.conf
	echo "#    Vous êtes en 'Expert' pour installer lilo en MBR :" >> /etc/lilo.conf
	echo "#    Remplacez '/DISQUE_BOOT' par '/$disque_boot'" >> /etc/lilo.conf
	echo "#" >> /etc/lilo.conf
	disque_boot=DISQUE_BOOT
fi

resolution_ecran=`cat /etc/fichier_r`	
echo "lba32" >> /etc/lilo.conf
echo "boot = /$disque_boot" >> /etc/lilo.conf
echo "map = /boot/.map" >> /etc/lilo.conf
echo "#prompt" >> /etc/lilo.conf
echo "install = /boot/boot-menu.b" >> /etc/lilo.conf
echo "delay = 25" >> /etc/lilo.conf
echo "#vga = normal" >> /etc/lilo.conf
echo "#vga = 788" >> /etc/lilo.conf
echo "vga = $resolution_ecran" >> /etc/lilo.conf	
echo "keytable = /boot/fr.ktl" >> /etc/lilo.conf
echo "default = $type_partition" >> /etc/lilo.conf

installation_eventuelle_ubuntu
mot_passe_boot=`cat /etc/fichier_t`
	
echo "image = /boot/oscar" >> /etc/lilo.conf
echo "     label = OSCAR" >> /etc/lilo.conf
echo "     root = /dev/ram0" >> /etc/lilo.conf
echo "     append = \"noapic init=/linuxrc ramdisk=8192 real_root=/dev/$repertoire_linux udev \"" >> /etc/lilo.conf
echo "     initrd = /boot/oscar.igz" >> /etc/lilo.conf
echo "     password = $mot_passe_boot" >> /etc/lilo.conf
echo "     read-only" >> /etc/lilo.conf
	
echo "other = /$partition_boot" >> /etc/lilo.conf
echo "     label = $type_partition" >> /etc/lilo.conf
echo "     table = /$disque_table" >> /etc/lilo.conf

if ( test -e /etc/lilo_expert )
then
	disque_boot=$disque_table
fi
}
#-----------------------------------------------------------------------------------------------------
test_sortie_lilo()
{
rm -f /tmp/tempfile
grep -ci " \*" /etc/sortie_lilo > /tmp/tempfile
rm -f /etc/sortie_lilo
reponse=`cat /tmp/tempfile`
rm -f /tmp/tempfile
if ! [ "$reponse" = "0" ]	# lilo sans erreur
then
	return
else
	# erreur lilo
	dialog 	--colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\n\Z1   Erreur d'installation LILO ...\Zn " 9 40
	exit
fi
}
#----------------------------------------------------------------------------------------------------
debug_sysrcd_grub2_affichage()
{
# bug_grub2 sysrscd : verifier si unicode_org.pf2 est different de unicode.pf2
if ( test -e /usr/share/oscar/usr/unicode.pf2 )
then
	if [ "$teste_disque_gpt" = gpt ] # demarrage gpt partition vfat
	then # gpt
		if [ "$faire_chroot_gpt" = non ]
		then
			if ! ( test -e /boot/efi/$repertoire_efi/grub2/fonts/unicode_org.pf2 )
			then
				cp -f /boot/efi/$repertoire_efi/grub2/fonts/unicode.pf2 /boot/efi/$repertoire_efi/grub2/fonts/unicode_org.pf2 2>/dev/null
				cp -f /usr/share/oscar/usr/unicode.pf2 /boot/efi/$repertoire_efi/grub2/fonts/unicode.pf2
			fi
		else
			chroot $repertoire_partition_linux umount /boot/efi
			mkdir /mnt/$partition_boot_efi 2>/dev/null
			mount -t vfat /dev/$partition_boot_efi /mnt/$partition_boot_efi
			if ! ( test -e /mnt/$partition_boot_efi/$repertoire_efi/grub2/fonts/unicode_org.pf2 )
			then
				cp -f /mnt/$partition_boot_efi/$repertoire_efi/grub2/fonts/unicode.pf2 /mnt/$partition_boot_efi/$repertoire_efi/grub2/fonts/unicode_org.pf2 2>/dev/null
				cp -f /usr/share/oscar/usr/unicode.pf2 /mnt/$partition_boot_efi/$repertoire_efi/grub2/fonts/unicode.pf2
				cp -f /usr/share/oscar/usr/grubenv /mnt/$partition_boot_efi/$repertoire_efi/grub2/grubenv
			fi
		fi
	else
		if ! ( test -e $repertoire_partition_linux/boot/grub2/fonts )
		then
			mkdir $repertoire_partition_linux/boot/grub2/fonts
		fi
		if ! ( test -e $repertoire_partition_linux/boot/grub2/fonts/unicode_org.pf2 )
		then
			cp -f $repertoire_partition_linux/boot/grub2/fonts/unicode.pf2 $repertoire_partition_linux/boot/grub2/fonts/unicode_org.pf2 2>/dev/null
			cp -f /usr/share/oscar/usr/unicode.pf2 $repertoire_partition_linux/boot/grub2/fonts/unicode.pf2
			cp -f /usr/share/oscar/usr/grubenv $repertoire_partition_linux/boot/grub2/grubenv
		fi
	fi
fi
}
#----------------------------------------------------------------------------------------------------
label_partition_boot_efi()
{
numero_partition_boot_efi=`expr substr $partition_boot_efi 4 3`
parted /dev/$nom_disque_oscar name $numero_partition_boot_efi efi-boot
if [ "$controle_ligne" = 0 ]
then
	echo "LABEL=efi-boot /boot/efi  vfat defaults 0 2" >> /etc/fstab
fi
}
#----------------------------------------------------------------------------------------------------
cherche_si_disque_gpt()
{
if [ "$teste_disque_gpt" = "" ]
then
	echo "$nom_disque_oscar" > /tmp/teste_disque_gpt
	runme tester_disque_gpt
	teste_disque_gpt=`cat /tmp/teste_disque_gpt`
	rm -f /tmp/teste_disque_gpt
	if [ "$teste_disque_gpt" = gpt ] # demarrage gpt partition vfat
	then # gpt
		# cherche la partition vfat :
		echo "fat" > /tmp/tempfile
		runme prepare_boucle_partition
		nombretype=`cat /tmp/nombre`
		rm -f /tmp/nombre
		partition_boot_efi=
		if [ "$nombretype" = 1 ]
		then
			perl -pi -e 's/://g;' /tmp/tempfile
			partition_boot_efi=`cat /tmp/tempfile`
			rm -f /tmp/tempfile
			label_partition_boot_efi
			return
		elif [ "$nombretype" = 0 ]
		then
			rm -f /tmp/tempfile
			dialog --colors --backtitle "`cat /etc/banniere_oscar`" \
			--ok-label "`cat $chemin_langue/Continuer`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--msgbox "\n\n\Zb\Z1 `cat $chemin_langue/recapitule_10` ...\Zn " 9 65
			exit
		fi
		numero=0
		cp -f /tmp/tempfile /tmp/temp_ligne_deux_points
		rm -f /tmp/tempfile
		until  ( test $numero = $nombretype )
		do
			rm -f /tmp/temp_ligne_deux_points1
			numero=$[$numero+1]
			cut -d":" -f$numero /tmp/temp_ligne_deux_points > /tmp/temp_ligne_deux_points1	#hdaiii
			reponse=`cat /tmp/temp_ligne_deux_points1`
			rm -f /tmp/temp_ligne_deux_points1
			echo "$reponse" > /tmp/monter_partition
			runme autoriser_monter_partition_oscar
			rm -f /tmp/monter_partition
			
			cherche_repertoire=/mnt/$reponse
			chercher_repertoire_EFI
			partition_ecrite_efi=$repertoire_efi
			
			if ( test -e /mnt/$reponse/$partition_ecrite_efi ) ## partition efi
			then
				umount /mnt/$reponse 2>/dev/null ; sync
				rm -f /tmp/temp_ligne_deux_points
				partition_boot_efi=$reponse
				label_partition_boot_efi
				return
			elif ( test -e /mnt/$reponse ) ## premiere partition sans efi
			then
				if [ "$partition_boot_efi" = "" ]
				then
					partition_boot_efi=$reponse
					label_partition_boot_efi
				fi
			fi
			umount /mnt/$reponse 2>/dev/null ; sync
		done
		rm -f /tmp/temp_ligne_deux_points
	fi
fi
}
#----------------------------------------------------------------------------------------------------
chercher_repertoire_EFI()
{
ls $cherche_repertoire -Q | grep -i \"EFI\" | perl -pi -e 's/EFI/OK/g;' | grep -ci OK > /tmp/nb_partition_EFI
ls $cherche_repertoire -Q | grep -i \"efi\" | perl -pi -e 's/efi/OK/g;' | grep -ci OK > /tmp/nb_partition_efi
ls $cherche_repertoire -Q | grep -i \"Efi\" | perl -pi -e 's/Efi/OK/g;' | grep -ci OK > /tmp/nb_partition_Efi
nb_partition_EFI=`cat /tmp/nb_partition_EFI`
nb_partition_efi=`cat /tmp/nb_partition_efi`
nb_partition_Efi=`cat /tmp/nb_partition_Efi`
rm -f /tmp/nb_partition_EFI
rm -f /tmp/nb_partition_efi
rm -f /tmp/nb_partition_Efi
if [ "$nb_partition_EFI" = 1 ]
then
	repertoire_efi=EFI
elif [ "$nb_partition_efi" = 1 ]
then
	repertoire_efi=efi
elif [ "$nb_partition_Efi" = 1 ]
then
	repertoire_efi=Efi
else
	repertoire_efi=EFI
fi
}
#----------------------------------------------------------------------------------------------------
faire_demarrage_gpt()
{
#### Si demarrage poste IL faut CORRIGER faire_chroot_gpt=non car au prochain repare_boot fait chroot 
cherche_si_disque_gpt
if [ "$teste_disque_gpt" = gpt ] # demarrage gpt partition vfat
then # gpt
	faire_chroot_gpt=non
	mkdir -p /boot/efi/ 2>/dev/null
	mount -t vfat /dev/$partition_boot_efi /boot/efi 2>/dev/null
	
	cherche_repertoire=/boot/efi
	chercher_repertoire_EFI
	repertoire_efi=$repertoire_efi
	
	mkdir -p /boot/efi/$repertoire_efi/grub2 2>/dev/null
	cp -fr /usr/lib/grub/* /boot/efi/$repertoire_efi/grub2/fonts 2>/dev/null
	mount -t vfat /dev/$partition_boot_efi /boot/efi 2>/dev/null
	modprobe efivars
	grub2-mkconfig -o /boot/efi/$repertoire_efi/grub2/grub.cfg 2>/dev/null 1>/dev/null
	grub2-install --boot-directory=/boot/efi/$repertoire_efi --bootloader-id=grub2 --target=x86_64-efi --no-floppy --recheck 2>/dev/null 1>/dev/null
	modprobe efivars
	efibootmgr --create --gpt --disk /dev/$nom_disque_oscar --part 1 --label "OSCAR" --loader "\\EFI\\grub2\\grub.efi"
else
	grub2-mkconfig -o /boot/grub2/grub.cfg 2>/dev/null 1>/dev/null
	grub2-install /dev/$nom_disque_oscar 2>/dev/null 1>/dev/null
fi
debug_sysrcd_grub2_affichage
}
#----------------------------------------------------------------------------------------------------
chroot_faire_demarrage_gpt()
{
cherche_si_disque_gpt
if [ "$teste_disque_gpt" = gpt ] # demarrage gpt partition vfat
then # gpt
	faire_chroot_gpt=oui
	chroot $repertoire_partition_linux mkdir -p /boot/efi 2>/dev/null
	chroot $repertoire_partition_linux mount -t vfat /dev/$partition_boot_efi /boot/efi 2>/dev/null
	# essai lignes suivantes pour repertoire EFI efi ou Efi 
	repertoire_efi=EFI
	if ( test -e $repertoire_partition_linux/boot/efi/efi )
	then
		repertoire_efi=efi
	elif ( test -e $repertoire_partition_linux/boot/efi/Efi )
	then
		repertoire_efi=Efi
	fi
	chroot $repertoire_partition_linux mkdir -p /boot/efi/$repertoire_efi/grub2/fonts 2>/dev/null
	chroot $repertoire_partition_linux cp -fr /usr/lib/grub/* /boot/efi/$repertoire_efi/grub2/ 2>/dev/null
	chroot $repertoire_partition_linux mount -t vfat /dev/$partition_boot_efi /boot/efi 2>/dev/null
	chroot $repertoire_partition_linux modprobe efivars
	chroot $repertoire_partition_linux grub2-mkconfig -o /boot/efi/$repertoire_efi/grub2/grub.cfg 2>/dev/null 1>/dev/null
	chroot $repertoire_partition_linux grub2-install --boot-directory=/boot/efi/$repertoire_efi --target=x86_64-efi --bootloader-id=grub2 --no-floppy --recheck 2>/dev/null 1>/dev/null
	chroot $repertoire_partition_linux modprobe efivars
	chroot $repertoire_partition_linux efibootmgr --create --gpt --disk /dev/$nom_disque_oscar --part 1 --label "OSCAR" --loader "\\EFI\\grub2\\grub.efi"
else
	chroot $repertoire_partition_linux grub2-mkconfig -o /boot/grub2/grub.cfg 2>/dev/null 1>/dev/null
	chroot $repertoire_partition_linux grub2-install /dev/$nom_disque_oscar 2>/dev/null 1>/dev/null
fi
}
#----------------------------------------------------------------------------------------------------
chrooter_grub2()
{
grep -v "/oscar" /etc/mtab > /tmp/temp_mtab # supprime les montages reseau oscar pour demonter avec option -a
cp -f /tmp/temp_mtab /etc/mtab
rm -f /tmp/temp_mtab
# umount -a 2>/dev/null ; sync	# pour installer grub2
umount /mnt/sd* 2>/dev/null ; sync	# pour installer grub2
mount /dev/$partition_installer_oscar /mnt/$partition_installer_oscar 2>/dev/null


mount -o bind /proc $repertoire_partition_linux/proc
mount -o bind /dev $repertoire_partition_linux/dev
mount -o bind /sys $repertoire_partition_linux/sys

chroot_faire_demarrage_gpt

umount $repertoire_partition_linux/proc 2>/dev/null ; sync
umount $repertoire_partition_linux/sys 2>/dev/null ; sync
umount $repertoire_partition_linux/dev 2>/dev/null ; sync
debug_sysrcd_grub2_affichage
}
#----------------------------------------------------------------------------------------------------
faire_chroot_grub2()
{
if [ "$partition_ubuntu" = "rien_du_tout" ]
then
	if [ "$partition_mandriva" = "rien_du_tout" ]
	then
		chrooter_grub2
	else
		faire_demarrage_gpt
	fi
else
	faire_demarrage_gpt
fi
}
#----------------------------------------------------------------------------------------------------
chrooter_selon_demarrage()
{
if ! ( test -e /etc/demarrage_cdrom )
then
	if ! ( test -e /etc/demarrage_usb )
	then
		faire_chroot_grub2
	else
		if [ "$partition_ubuntu" = "rien_du_tout" ]
		then
			if [ "$partition_mandriva" = "rien_du_tout" ]
			then
				faire_chroot_grub2
			else
				chroot_grub2
			fi
		else
			chrooter_grub2
		fi
	fi
else
	if [ "$partition_ubuntu" = "rien_du_tout" ]
	then
		if [ "$partition_mandriva" = "rien_du_tout" ]
		then
			faire_chroot_grub2
		else
			chroot_grub2
		fi
	else
		chrooter_grub2
	fi
fi
}
#----------------------------------------------------------------------------------------------------
installe_console_clavier_grub()
{
repertoire_partition_linux=$partition_linux

if ! [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
then
	if ! [ "$repertoire_partition_linux" = "" ]
	then
		# mount -t proc none $repertoire_partition_linux/proc
		mount -o bind /proc $repertoire_partition_linux/proc
		mount -o bind /dev $repertoire_partition_linux/dev
		mount -o bind /sys $repertoire_partition_linux/sys
		chroot $repertoire_partition_linux rc-update add consolefont boot 2>/dev/null 1>/dev/null
		chroot $repertoire_partition_linux rc-update add keymaps boot 2>/dev/null 1>/dev/null
		
		# pave numerique GENTOO : NON car mauvais pour les portables
		# chroot $repertoire_partition_linux rc-update add numlock boot 2>/dev/null 1>/dev/null
	else
		rc-update add consolefont boot 2>/dev/null 1>/dev/null
		rc-update add keymaps boot 2>/dev/null 1>/dev/null
		# pave numerique GENTOO :
		# rc-update add numlock boot 2>/dev/null 1>/dev/null
	fi
else	# clavier pour jwm car sysrcd voir /root/.xinitrc
	echo "XKEYBOARD=`cat  /usr/share/oscar/usr/choix_clavier`" > $repertoire_partition_linux/etc/sysconfig/keyboard
	echo "XKEYBOARD=`cat  /usr/share/oscar/usr/choix_clavier`" > /etc/sysconfig/keyboard
	
	#	# pave numerique GENTOO : NON car mauvais pour les portables
	#	if ! [ "$repertoire_partition_linux" = "" ]
	#	then
	#		mount -t proc none $repertoire_partition_linux/proc 2>/dev/null 1>/dev/null
	#		mount -o bind /dev $repertoire_partition_linux/dev 2>/dev/null 1>/dev/null
	#		chroot $repertoire_partition_linux rc-update add numlock boot 2>/dev/null 1>/dev/null
	#	else
	#		rc-update add numlock boot 2>/dev/null 1>/dev/null
	#	fi
fi

if ! ( test -e /etc/lilo_expert )
then
	if ! ( test -e /etc/installer_grub2 )
	then
		echo "#!/bin/sh
		grub --batch <<EOT 1>/dev/null 2>/dev/null
		root ($nom_disque_oscar_grub,$numero_hd_boot_grub)
		setup ($nom_disque_oscar_grub)
		root ($nom_disque_oscar_grub,$numero_hd_boot_grub)
		setup (hd0)
		quit" > $repertoire_partition_linux/usr/share/oscar/usr/installer_oscar_grub
		echo "EOT" >> $repertoire_partition_linux/usr/share/oscar/usr/installer_oscar_grub
		chmod +x $repertoire_partition_linux/usr/share/oscar/usr/installer_oscar_grub

		cp -f /etc/installer_grub1 $repertoire_partition_linux/usr/share/oscar/usr/installer_grub1
		rm -f $repertoire_partition_linux/usr/share/oscar/usr/installer_grub2
	else
		rm -f $repertoire_partition_linux/usr/share/oscar/usr/installer_grub1
		cp -f /etc/installer_grub2 $repertoire_partition_linux/usr/share/oscar/usr/installer_grub2
		cp -f /usr/share/oscar/usr/superuser_oscar $repertoire_partition_linux/usr/share/oscar/usr/superuser_oscar 2>/dev/null
		cp -f /usr/share/oscar/usr/crypt_mot_passe_pbkdf2 $repertoire_partition_linux/usr/share/oscar/usr/crypt_mot_passe_pbkdf2 2>/dev/null
		
		if ( test -e /etc/conf.d/prive_40_custom )
		then
			cp -f /etc/conf.d/prive_40_custom $repertoire_partition_linux/usr/share/oscar/usr/prive_40_custom 2>/dev/null
			cp -f /etc/conf.d/prive_40_custom $repertoire_partition_linux/etc/conf.d/prive_40_custom 2>/dev/null
		else
			rm -f $repertoire_partition_linux/usr/share/oscar/usr/prive_40_custom
			rm -f $repertoire_partition_linux/etc/conf.d/prive_40_custom
		fi
		if ( test -e /etc/afficher_menu_grub )
		then
			cp -f /etc/afficher_menu_grub $repertoire_partition_linux/usr/share/oscar/usr/afficher_menu_grub 2>/dev/null
			cp -f /etc/afficher_menu_grub $repertoire_partition_linux/etc/afficher_menu_grub 2>/dev/null
		else
			rm -f $repertoire_partition_linux/usr/share/oscar/usr/afficher_menu_grub
			rm -f $repertoire_partition_linux/etc/afficher_menu_grub
		fi
		if [ "$supprimer_30_os" = oui ]
		then
			rm -f $repertoire_partition_linux/etc/grub.d/30_os-prober
			echo "" > $repertoire_partition_linux/usr/share/oscar/usr/installe_oscar_seul 2>/dev/null
			echo "" > $repertoire_partition_linux/etc/installe_oscar_seul 2>/dev/null
		fi
		if ! [ "$repertoire_partition_linux" = "" ]
		then
			grep -c " / ext" /etc/mtab > /tmp/nb_partition_demarrage # existe si demarrage par poste
			nb_partition_demarrage=`cat /tmp/nb_partition_demarrage`
			rm -f /tmp/nb_partition_demarrage
			if [ $nb_partition_demarrage = 0 ]
			then
				cp -f /etc/installer_grub2 $repertoire_partition_linux/etc/installer_grub2 2>/dev/null
				cp -f /etc/default/grub $repertoire_partition_linux/etc/default/grub 2>/dev/null
				cp -f /etc/grub.d/* $repertoire_partition_linux/etc/grub.d/ 2>/dev/null
				chrooter_selon_demarrage
			else
				faire_demarrage_gpt
			fi
		else
			faire_demarrage_gpt
		fi
	fi
	# variables pour clients:

	# echo "$numero_hd_oscar" > /tmp/numero_hd_oscar
	# echo "$numero_hd_boot_grub" > /tmp/numero_hd_boot_grub
	# echo "$partition_linux" > /tmp/partition_boot

	# disque_boot=dev/`cat /tmp/disque_boot`		# dev/hda	disque boot d'origine
	# disque_boot_grub=hd`cat /tmp/disque_boot_grub`	# numero du disque pour grub

	if ( test -e /tmp/partition_boot_grub )
	then
		partition_boot_grub=`cat /tmp/partition_boot_grub`
	else
		echo "$partition_linux" > /tmp/partition_boot_grub
	fi
	
	echo "$disque_boot,$disque_boot_grub,$numero_hd_boot_grub,$partition_boot_grub,$numero_hd_oscar,$partition_installer_oscar" > $repertoire_partition_linux/usr/share/oscar/usr/fichier_disque_boot_grub
	# ex: "/dev/sda,hd0,2,sda3(/boot/grub),3,sda4(Oscar)"

	if ! ( test -e /etc/installer_grub2 )
	then
		if ! [ "$repertoire_partition_linux" = "" ]
		then
			$repertoire_partition_linux/usr/share/oscar/usr/installer_oscar_grub
		else
			/usr/share/oscar/usr/installer_oscar_grub
		fi
	fi
	if ! [ "$repertoire_partition_linux" = "" ]
	then
		umount $repertoire_partition_linux/proc 2>/dev/null ; sync
		umount $repertoire_partition_linux/sys 2>/dev/null ; sync
		umount $repertoire_partition_linux/dev 2>/dev/null ; sync	# voir doc http://www.gentoo.org/doc/fr/handbook/handbook-x86.xml?part=1&chap=6
	fi
	# monter_partitions_non_montees demonter_partitions_non_montees
fi

if ! ( test -e /etc/installer_grub2 )
then
	# en expert pour chainloader voir Xavier
	echo "#!/bin/sh
	grub --batch <<EOT 1>/dev/null 2>/dev/null
	root ($nom_disque_oscar_grub,$numero_hd_oscar)
	setup ($nom_disque_oscar_grub,$numero_hd_oscar)
	quit" > $repertoire_partition_linux/usr/share/oscar/usr/installer_oscar_grub
	echo "EOT" >> $repertoire_partition_linux/usr/share/oscar/usr/installer_oscar_grub
	chmod +x $repertoire_partition_linux/usr/share/oscar/usr/installer_oscar_grub

	if ! [ "$repertoire_partition_linux" = "" ]
	then
		$repertoire_partition_linux/usr/share/oscar/usr/installer_oscar_grub
	else
		/usr/share/oscar/usr/installer_oscar_grub
	fi
else
	echo " ..."
	echo
	if ! [ "$repertoire_partition_linux" = "" ]
	then
		grep -c " / ext" /etc/mtab > /tmp/nb_partition_demarrage # existe si demarrage par poste
		nb_partition_demarrage=`cat /tmp/nb_partition_demarrage`
		rm -f /tmp/nb_partition_demarrage
		if [ $nb_partition_demarrage = 0 ]
		then
			chrooter_selon_demarrage
		else
			faire_demarrage_gpt
		fi
	else
		faire_demarrage_gpt
	fi
fi
rm -f /tmp/partition_boot_grub
#	else	# si sysrcd condition à rajouter
#		if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
#		then
#			if ! [ "$repertoire_partition_linux" = "" ]
#			then
#			    mount -t proc none $repertoire_partition_linux/proc
#			    mount -o bind /dev $repertoire_partition_linux/dev
#			    rc-update add consolefont boot 2>/dev/null 1>/dev/null
#			    rc-update add keymaps boot 2>/dev/null 1>/dev/null
#			else
#			    chroot $repertoire_partition_linux rc-update add consolefont boot 2>/dev/null 1>/dev/null
#			    chroot $repertoire_partition_linux rc-update add keymaps boot 2>/dev/null 1>/dev/null
#			fi
#			if ! [ "$repertoire_partition_linux" = "" ]
#			then
#			    umount $repertoire_partition_linux/proc 2>/dev/null ; sync
#			    umount $repertoire_partition_linux/dev 2>/dev/null ; sync	## voir doc http://www.gentoo.org/doc/fr/handbook/handbook-x86.xml?part=1&chap=6
#			fi
#		fi
}
#----------------------------------------------------------------------------------------------------
installe_console_clavier_lilo()
{
	if ( test -e /tmp/client_lance )
	then
		repertoire_partition_linux=/mnt/$partition_linux
	else
		repertoire_partition_linux=$partition_linux
	fi

	if ! ( test -e /etc/lilo_expert )
	then
		monter_partitions_non_montees
		    # mount -t proc none $repertoire_partition_linux/proc
		    mount -o bind /proc $repertoire_partition_linux/proc
		    mount -o bind /dev $repertoire_partition_linux/dev
		    mount -o bind /sys $repertoire_partition_linux/sys
		    echo "`chroot $repertoire_partition_linux lilo 2>/dev/null`" > /etc/sortie_lilo
		    chroot $repertoire_partition_linux rc-update add consolefont boot 2>/dev/null 1>/dev/null
		    chroot $repertoire_partition_linux rc-update add keymaps boot 2>/dev/null 1>/dev/null
		    #	chroot $repertoire_partition_linux rc-update add numlock boot 2>/dev/null 1>/dev/null
		    umount $repertoire_partition_linux/sys 2>/dev/null ; sync
		    umount $repertoire_partition_linux/proc 2>/dev/null ; sync
		    umount $repertoire_partition_linux/dev 2>/dev/null ; sync	# voir doc http://www.gentoo.org/doc/fr/handbook/handbook-x86.xml?part=1&chap=6
		monter_partitions_non_montees demonter_partitions_non_montees
	else	# si sysrcd condition à rajouter
		if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
		then
			# mount -t proc none $repertoire_partition_linux/proc
			mount -o bind /proc $repertoire_partition_linux/proc
			mount -o bind /dev $repertoire_partition_linux/dev
			mount -o bind /sys $repertoire_partition_linux/sys
			chroot $repertoire_partition_linux rc-update add consolefont boot 2>/dev/null 1>/dev/null
			chroot $repertoire_partition_linux rc-update add keymaps boot 2>/dev/null 1>/dev/null
			#	chroot $repertoire_partition_linux rc-update add numlock boot 2>/dev/null 1>/dev/null
			umount $repertoire_partition_linux/sys 2>/dev/null ; sync
			umount $repertoire_partition_linux/proc 2>/dev/null ; sync
			umount $repertoire_partition_linux/dev 2>/dev/null ; sync	## voir doc http://www.gentoo.org/doc/fr/handbook/handbook-x86.xml?part=1&chap=6
		fi
	fi
}
#----------------------------------------------------------------------------------------------------
installer_demarrage()
{
if ( test -e /usr/share/oscar/usr/splash.xpm.gz )
then
	cp -f /usr/share/oscar/usr/splash.xpm.gz $partition_linux/boot/grub/splash.xpm.gz
fi

if [ "$nombre_partition_linux_juste_boot" = "1" ]	# une partition linux juste /boot
then
	#	partition_boot_pour_grub=$partition_linux
	echo "$partition_boot_grub" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	partition_montee=`cat /tmp/monter_partition`
	rm -f /tmp/monter_partition
	#	else
	#		partition_boot_pour_grub=$partition_linux/boot
fi
	# rappel : la $partition_linux est la partition oscar de sauvegarde
	if [ "$type_boot" = "lilo" ]
	then
	##	installe LILO
		cp -f /etc/lilo.conf $partition_linux/etc/lilo.conf
		installe_console_clavier_$type_boot
	else
		## installer GRUB si nécessaire si pas Ubuntu
		if ! ( test -e /etc/installer_grub2 )
		then
			cp -f /etc/grub.conf $partition_linux/boot/grub/grub.conf
			cp -f /etc/grub.conf $partition_linux/usr/share/oscar/usr/oscar_grub.conf
			if ( test -e /etc/grub.conf.expert )
			then
				cp -f /etc/grub.conf $partition_linux/boot/grub/grub.conf.oscar
				cp -f /etc/grub.conf.expert $partition_linux/boot/grub/grub.conf # vient du client multi ou clone
			fi
			if [ "$nombre_partition_linux_juste_boot" = "1" ]	# une partition linux juste /boot
			then
			
				if ! ( test -e /etc/lilo_expert )
				then
		                        if ( test -e $partition_montee/grub/menu.lst )
		                        then
			                        if ! ( test -e $partition_montee/grub/menu.lst.init )
		        	                then
						    cp -f $partition_montee/grub/menu.lst $partition_montee/grub/menu.lst.init
						fi
						cp -f $partition_montee/grub/menu.lst $partition_montee/grub/menu.lst-$date_heure
						rm -f $partition_montee/grub/menu.lst
					fi
		                        if ( test -e $partition_montee/grub/grub.conf )
		                        then
						cp -f $partition_montee/grub/grub.conf $partition_montee/grub/grub.conf.old
						rm -f $partition_montee/grub/grub.conf
					fi
					cp -f /etc/grub.conf $partition_montee/grub/grub.conf
					cp -f /etc/grub.conf $partition_montee/grub/menu.lst
					cp -f $partition_linux/boot/grub/splash.xpm.gz $partition_montee/grub/
				else
					cp -f /etc/grub.conf $partition_montee/grub/menu.lst.oscar
					cp -f /etc/grub.conf $partition_montee/grub/grub.conf.oscar
				fi
				if ( test -e /etc/grub.conf.expert )
				then
					cp -f /etc/grub.conf $partition_montee/grub/grub.conf.oscar
					cp -f /etc/grub.conf.expert $partition_montee/grub/menu.lst
					cp -f /etc/grub.conf.expert $partition_montee/grub/grub.conf # vient du client multi ou clone
					# cp -f $partition_linux/boot/grub/splash.xpm.gz $partition_montee/grub/
				fi
			fi
		fi
		rm -f /etc/grub.conf.expert
		installe_console_clavier_$type_boot
	fi
}
#----------------------------------------------------------------------------------------------------
installer_fstab_conf_demarrage()
{
	#### charger_variables_lilo
	cp -f $partition_linux/etc/fstab $partition_linux/usr/share/oscar/usr/fstab.init

	faire_fstab # faire seulement a l'installation
	cp -f /etc/fstab $partition_linux/usr/share/oscar/usr/fstab

	if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
	then
		if ! ( test -e /etc/installer_grub2 )
		then
			faire_conf_sysrcd_$type_boot
		else
			faire_grub_conf_pour_oscar
		fi
	else
		faire_conf_$type_boot
	fi
	
	cp -f /etc/fstab $partition_linux/etc/fstab 2>/dev/null
	echo
	echo -e "\033[1;32m ..."
	echo
	### sauvegarde le MBR installé par windows, le premier souvant
	if ! ( test -e $partition_linux/oscar/table_partitions.mbr )
	then
		if ! [ "$change_lettre_sd_pour_usb" = "oui" ]	# dans ce cas definir disque incremente
		then
			disque_boot_sauvegarde=`expr substr $disque_boot 5 8` # disque_boot de la forme dev/sda
			# dd if=/$disque_boot of=$partition_linux/oscar/table_partitions.mbr count=1 bs=512 2>/dev/null
			dd if=/dev/$disque_boot_sauvegarde of=$partition_linux/oscar/table_partitions.mbr count=1 bs=512 2>/dev/null
			# sfdisk -d /dev/$disque_boot_sauvegarde > $partition_linux/oscar/table_partitions.sf 2>/dev/null
			echo "$disque_boot_sauvegarde" > /tmp/disque_table_sauvegarder_sf
			runme sauver_table_partition_sf
			cp -f /tmp/disque_table_sauvegarder_sf $partition_linux/oscar/table_partitions.sf
			rm -f /tmp/disque_table_sauvegarder_sf
		fi
	fi

	installer_demarrage

	# à l'installation:
##	chroot $partition_linux rc-update del pwgen default 1>/dev/null 2>/dev/null
	
	date=$(date +%y%m%d)
	echo "oui,$date" > $partition_linux/etc/date_oscar	# repère de l'installation
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
faire_teste_grub()	# essayer grub 
{
teste_disque_grub=hd`cat /tmp/disque_boot_grub`
# en expert aussi pour chainloader voir Xavier
if ! ( test -e /boot/grub/grub.conf )
then
	echo "" > /boot/grub/grub.conf
fi
if ! ( test -e $partition_linux/grub )
then
	mkdir $partition_linux/grub
	cp -fR /boot/grub/* $partition_linux/grub/
fi

echo "#!/bin/sh
grub --batch <<EOT 1>/tmp/fichier_test_grub 2>/dev/null
root ($teste_disque_grub,$numero_hd_oscar)
setup ($teste_disque_grub,$numero_hd_oscar)
quit
EOT" > /tmp/tester_grub
chmod +x /tmp/tester_grub
/tmp/tester_grub
rm -f /tmp/tester_grub
grep -i "succeeded" /tmp/fichier_test_grub > /tmp/fichier_test_grub1
fichier_test_grub=`cat /tmp/fichier_test_grub1`
rm -f /tmp/fichier_test_grub
rm -f /tmp/fichier_test_grub1
}
#----------------------------------------------------------------------------------------------------
tester_erreur_grub_ancien()	# pour le materiel NEC
{
faire_teste_grub
	if [ "$fichier_test_grub" = "" ]	# grub non installe test a verifier
	then
		cp -fR /lib/grub/x86_64-pc/* /boot/grub/
		faire_teste_grub
	fi

if [ "$fichier_test_grub" = "" ]	# grub non installe
then
	# Cette version ne permet pas d'installer les fichiers \Zb\Z3OSCAR\Z2 sur ce poste
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--ok-label "`cat $chemin_langue/Continuer`"  \
	--msgbox "\n\n\Zb\Z2Cette version ne permet pas d'installer les fichiers \Zb\Z3OSCAR\Z2 sur ce poste. \n\n \
	\n\Zb\Z2Pour le déploiement utilisez le cédérom \Z3OSCAR\Z2 avec le serveur PXE" 12 76
	case $? in
	    0) 	exit;;
	    255) exit;;
	esac
fi
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
demander_clavier()	# seulement si pas langue fr ou azerty
{
#	if ( test -e /etc/demarrage_usb )
#	then
#		test_demarrage_usb
#	fi
if ( test -e /tmp/sortir )
then
	exit
fi
perl -pi -e 's/.ktl//g; s/genlist.sh
//g; s/azerty
//g;' /tmp/liste_clavier

awk 'BEGIN { FS=":" } { printf ("%0s\n","\""$1"\" \"\" \\")}' /tmp/liste_clavier > /tmp/bozo
rm -f /tmp/liste_clavier

# boite : Choix du clavier
echo " `cat $chemin_langue/selection_45` " > /tmp/menu_titre
echo "" > /tmp/menu_texte
echo "`cat $chemin_langue/selection_46` : " > /tmp/fichierquestion

echo "5" > /tmp/hauteur
echo "30" > /tmp/largeur
echo "0" > /tmp/position
runme boite_selection_bozo
rm -f /tmp/hauteur
rm -f /tmp/largeur
rm -f /tmp/position
rm -f /tmp/texte

if ( test -e /tmp/sortir )
then
	rm -f /tmp/tempfile
	return
fi
choix_clavier=`cat /tmp/tempfile`
rm -f /tmp/tempfile
echo "$choix_clavier" > /usr/share/oscar/usr/choix_clavier
echo "XKEYBOARD=`cat  /usr/share/oscar/usr/choix_clavier`" > /etc/sysconfig/keyboard
clavier_grub
# copier le clavier_grub sur la partition oscar du poste
}
#----------------------------------------------------------------------------------------------------
pour_controler_sysrcd() # 	ancien
{
if [ "$ip_serveur_pxe" = "" ]	# installation complete par cederom
then
	if [ "$cd_base" = "oscar_sysrcd" ] # démarrage cdrom et sysrcd
	then 
		echo "sysrcd" > $partition_linux/usr/share/oscar/usr/srscd	# installation depuis srscd
		if (test -e /mnt/cdrom/sysrcd.dat )	# sans option cdcache
		then
			cp -f /mnt/cdrom/sysrcd.dat $partition_linux/oscar/livecd.squashfs
		else	# si option cdcache impossible
			if (test -e /mnt/sysrcd.dat )	# sans option cdcache
			then
		    		cp -f /mnt/sysrcd.dat $partition_linux/oscar/livecd.squashfs
		#    	else	# demarrage usb avec docache impossible ANCIEN
		#		cp -f /usr/share/oscar/usb/sysrcd.dat $partition_linux/oscar/livecd.squashfs
		    	fi
		fi
	else	# démarrage cdrom et catalyst d'oscar
		rm -f $partition_linux/usr/share/oscar/usr/srscd # on ne sait jamais...
		if (test -e /mnt/cdrom/livecd.squashfs )	# sans option docache
		then
			cp -f /mnt/cdrom/livecd.squashfs $partition_linux/oscar/
		else	# si option docache impossible
			cp -f /mnt/livecd.squashfs $partition_linux/oscar/
		fi
	fi
fi
}
#----------------------------------------------------------------------------------------------------
calcul_pourcentage_depuis_partition_oscar()
{
# taille du repertoire OSCAR
du -s $partition_linux | tail -n 1 | awk '{print $1}' > /tmp/taille_repertoire_oscar_copie
taille_repertoire_oscar_copie=`cat /tmp/taille_repertoire_oscar_copie`
rm -f /tmp/taille_repertoire_oscar_copie
taille_repertoire_oscar_copie=$[$taille_repertoire_oscar_copie]

pourcentage_copie=$[100*($taille_repertoire_oscar_copie-$taille_repertoire_oscar_avant_decompression)/$taille_fichiers_avant_mksquashfs]
}
#----------------------------------------------------------------------------------------------------
calcul_pourcentage_depuis_disque()
{
# taille du repertoire OSCAR
df -P | grep $partition_linux | tail -n 1 | awk '{print $3}' > /tmp/taille_repertoire_oscar_copie
taille_repertoire_oscar_copie=`cat /tmp/taille_repertoire_oscar_copie`
rm -f /tmp/taille_repertoire_oscar_copie
taille_repertoire_oscar_copie=$[$taille_repertoire_oscar_copie]

pourcentage_copie=$[100*($taille_repertoire_oscar_copie-$taille_repertoire_oscar_nettoye)/$taille_fichiers_avant_mksquashfs]
}
#----------------------------------------------------------------------------------------------------
bargraphe_dialog_copier_fichiers()
{
if ! ( test -e /tmp/client_lance )
then
	# taille_repertoire_oscar_nettoye
	df -P | grep $partition_linux | tail -n 1 | awk '{print $3}' > /tmp/taille_repertoire_oscar_nettoye
	taille_repertoire_oscar_nettoye=`cat /tmp/taille_repertoire_oscar_nettoye`
	rm -f /tmp/taille_repertoire_oscar_nettoye
	taille_repertoire_oscar_nettoye=$[$taille_repertoire_oscar_nettoye]
else
	# taille du repertoire OSCAR avant decompression
	# avec du c'est plus long que df quand c'est possible preferer df
	du -s $partition_linux | tail -n 1 | awk '{print $1}' > /tmp/taille_repertoire_oscar_avant_decompression
	taille_repertoire_oscar_avant_decompression=`cat /tmp/taille_repertoire_oscar_avant_decompression`
	rm -f /tmp/taille_repertoire_oscar_avant_decompression
	taille_repertoire_oscar_avant_decompression=$[$taille_repertoire_oscar_avant_decompression]
fi
valeur_fin_copie=0
pourcentage_copie=0
while [ "$valeur_fin_copie" != 1 ]
do
	sleep 4
	if ! ( test -e /tmp/client_lance )
	then
		calcul_pourcentage_depuis_disque
	else
		calcul_pourcentage_depuis_partition_oscar
	fi
	
	if ( test -e /tmp/fin_copie )
	then
		valeur_fin_copie=1
		rm -f /tmp/fin_copie
		pourcentage_copie=100
	fi
	pourcentage_copie=$[$pourcentage_copie]
	echo $pourcentage_copie
done | DIALOGRC="/etc/dialogmenu_bloque" dialog --colors\
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/menu_316` " \
	--gauge "`cat $chemin_langue/infobox_22`" 13 60
}
#----------------------------------------------------------------------------------------------------
copier_fichiers_oscar()
{
cp -dpR $chemin/* $partition_linux 1>/dev/null 2>/dev/null	# copie de tous les repertoires bin, boot,...
echo $? > /tmp/fin_copie
fin_copie=`cat /tmp/fin_copie`
}
#----------------------------------------------------------------------------------------------------
installer_fichiers_oscar()	##	décompresser les fichiers et ajouter oscar
{
# tester_erreur_grub
	choix_clavier=fr
	# demander le clavier si premiere installation et pas client :
	if ! ( test -e /tmp/client_lance )
	then
		if [ "$choix_langue" != "fr" ]
		then
			#	if ( test -e /livemnt/boot/isolinux/maps )
			#	then
			#		ls /livemnt/boot/isolinux/maps > /tmp/liste_clavier
			#	else	# demarrage USB
			#		ls /$chemin_usb/maps > /tmp/liste_clavier
			#	fi
			if ( test -e /livemnt/boot/isolinux/maps )
			then
				isolinux_=isolinux
			elif ( test -e /livemnt/boot/syslinux/maps )
			then # demarrage cle usb
				isolinux_=syslinux
			else
				echo " Erreur clavier ..."
				sleep 8
				exit
			fi
			ls /livemnt/boot/$isolinux_/maps > /tmp/liste_clavier
			demander_clavier # seulement si pas en langue fr
			if ( test -e /tmp/sortir )
			then
				rm -f /tmp/tempfile
				return
			fi
		else
			echo "$choix_clavier" > /usr/share/oscar/usr/choix_clavier
		fi
	fi
	clavier_grub
	choix_clavier=`cat /usr/share/oscar/usr/choix_clavier`
	# clavier pour jwm car sysrcd voir /root/.xinitrc
	echo "XKEYBOARD=`cat  /usr/share/oscar/usr/choix_clavier`" > /etc/sysconfig/keyboard
	if ! ( test -e $partition_linux/etc/sysconfig )
	then
		mkdir -p $partition_linux/etc/sysconfig
	fi
	echo "XKEYBOARD=`cat  /usr/share/oscar/usr/choix_clavier`" > $partition_linux/etc/sysconfig/keyboard

	# nettoyer la partition pour mise à jour
	if ( test -e $partition_linux/boot )
		then
		echo
    		echo -e "  `cat $chemin_langue/texte_66` \033[0;32m$partition_linux\033[1;34m ...\033[1;m"
   		echo
		rm -fr $partition_linux/bin
		if ( test -e $partition_linux/boot/boot.b )	### verification du boot car si boot.b existe le boot est mauvais !!
		then
			chmod 777 $partition_linux/boot/boot.b
			rm -f $partition_linux/boot/boot.b
		fi
		if ( test -e $partition_linux/usr/share/oscar/var_salle )
		then
			cp -dpfR $partition_linux/usr/share/oscar/var_salle /tmp/
		fi
		rm -fr $partition_linux/bin
		rm -fr $partition_linux/boot
		rm -fr $partition_linux/dev
		rm -fr $partition_linux/etc
		rm -fr $partition_linux/home
		rm -fr $partition_linux/lib
		rm -fr $partition_linux/lib64
		rm -fr $partition_linux/livemnt
		rm -fr $partition_linux/media
		rm -fr $partition_linux/mnt/partage_nfs
		rm -fr $partition_linux/mnt/serveur_partage
		rm -fr $partition_linux/opt
		rm -fr $partition_linux/proc
		rm -fr $partition_linux/root
		rm -fr $partition_linux/sbin
		rm -fr $partition_linux/sys
		rm -fr $partition_linux/tftpboot
		rm -fr $partition_linux/tmp
		rm -fr $partition_linux/usr
		rm -fr $partition_linux/var
	fi
	echo
	echo -e " ...\033[1;34m"
	echo

	# Installer les fichiers Oscar:
	choix_noyau_demarrage
	
		####	cp -dpR /livemnt/squashfs/* $partition_linux 1>/dev/null 2>/dev/null
		if ! ( test -e $partition_linux/oscar )
		then
			mkdir $partition_linux/oscar	# possible en expert
		fi
		# initialiser la vitesse de transmission à 75mb: # possible si déjà existante à 1000mb ancienne version 
			if ! ( test -e $partition_linux/oscar/var_poste )
			then
				mkdir $partition_linux/oscar/var_poste
			fi
			echo "75m" > $partition_linux/oscar/var_poste/vitesse_transmission

		if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
		then
			chemin=/livemnt/squashfs
			if ( test -e /tmp/client_lance )
			then
				if ! ( test -e $partition_linux/oscar/livecd )
				then
					mkdir $partition_linux/oscar/livecd
				fi
				
				mount $partition_linux/cd_oscar/oscar/usr/oscar_usb/sysrcd.dat $partition_linux/oscar/livecd -t squashfs -o loop 2>/dev/null 1>/dev/null
				# mount $partition_linux/oscar/livecd.squashfs $partition_linux/oscar/livecd -t squashfs -o loop 2>/dev/null
				test_montage_squashfs=$?
				if [ "$test_montage_squashfs" != 0 ]
				then
					mount $partition_linux/cd_oscar/oscar/usr/oscar_usb/sysrcd.dat $partition_linux/oscar/livecd -o loop
					# mount $partition_linux/oscar/livecd.squashfs $partition_linux/oscar/livecd -o loop
				fi
				chemin=$partition_linux/oscar/livecd
			fi
		#	if ! ( test -e $partition_linux/oscar/livecd )
		#		then
		#			mkdir $partition_linux/oscar/livecd
		#		fi
		#		# decompresser livecd.squashfs en cloop
		#		noyau=`uname -r`
		#		mknod /dev/cloop b 240 0 2>/dev/null # à vérifier si besoin de cette commande
		#		# mknod /dev/cloop1 b 240 0
		#		insmod /lib/modules/$noyau/kernel/cloop.ko file=$partition_linux/oscar/livecd.squashfs 1>/dev/null 2>/dev/null
		#		mount -o ro -t ext2 /dev/cloop $partition_linux/oscar/livecd    # voir le fichier /initrd/linuxrc
		#		chemin=$partition_linux/oscar/livecd
		else # oscar depuis catalyst
			chemin=/livemnt/squashfs
		    	if ( test -e /tmp/client_lance )
			then
				if ! ( test -e $partition_linux/oscar/livecd )
				then
					mkdir $partition_linux/oscar/livecd
				fi
				
				mount $partition_linux/cd_oscar/oscar/usr/oscar_usb/livecd.squashfs $partition_linux/oscar/livecd -t squashfs -o loop 2>/dev/null
				# mount $partition_linux/oscar/livecd.squashfs $partition_linux/oscar/livecd -t squashfs -o loop 2>/dev/null
				test_montage_squashfs=$?
				if [ "$test_montage_squashfs" != 0 ]
				then
					mount $partition_linux/cd_oscar/oscar/usr/oscar_usb/livecd.squashfs $partition_linux/oscar/livecd -o loop
					# mount $partition_linux/oscar/livecd.squashfs $partition_linux/oscar/livecd -o loop
				fi
				chemin=$partition_linux/oscar/livecd
			fi
		fi
		
		if ! ( test -e $chemin/usr/share/oscar/usr/taille_fichiers_avant_mksquashfs )
		then
			# Patience : Installation des fichiers OSCAR
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/menu_316` " \
			--infobox "`cat $chemin_langue/infobox_22`" 13 60
			
			cp -dpR $chemin/* $partition_linux 1>/dev/null 2>/dev/null	# copie de tous les repertoires bin, boot,...
		else
			taille_fichiers_avant_mksquashfs=`cat $chemin/usr/share/oscar/usr/taille_fichiers_avant_mksquashfs`
			taille_fichiers_avant_mksquashfs=$[$taille_fichiers_avant_mksquashfs]
			rm -f /tmp/fin_copie
			copier_fichiers_oscar &
			bargraphe_dialog_copier_fichiers
		fi
		if ! ( test -e $partition_linux/boot/grub2 ) # pour demarrage efi oscar_64
		then
			mkdir -p $partition_linux/boot/grub2
			cp -fR /usr/lib/grub/* $partition_linux/boot/grub2/
		fi
		if ( test -e /usr/share/oscar/usr/initialise )
		then
			cp -f /usr/share/oscar/usr/initialise $partition_linux/usr/share/oscar/usr/initialise
		fi
		if ( test -e /tmp/client_lance )
		then
			umount $partition_linux/oscar/livecd 2>/dev/null ; sync
			if ( test -e /tmp/var_salle )
			then
				cp -fdpR /tmp/var_salle $partition_linux/cd_oscar/oscar/
				rm -fR /tmp/var_salle
			fi
			cp -f $partition_linux/cd_oscar/oscar/usr/oscar_usb/isolinux/$choix_noyau $partition_linux/boot/oscar
			cp -f $partition_linux/cd_oscar/oscar/usr/oscar_usb/isolinux/oscar.igz $partition_linux/boot/oscar.igz
			cp -f $partition_linux/cd_oscar/oscar/usr/oscar_usb/isolinux/netboot $partition_linux/boot/
			cp -f $partition_linux/cd_oscar/oscar/usr/options_boot $partition_linux/usr/share/oscar/usr/options_boot
			cp -f $partition_linux/cd_oscar/oscar/usr/option_delai_boot $partition_linux/usr/share/oscar/usr/option_delai_boot
			
			cp -f $partition_linux/cd_oscar/oscar/usr/choix_clavier $partition_linux/usr/share/oscar/usr/choix_clavier
			cp -f $partition_linux/cd_oscar/oscar/usr/choix_clavier /usr/share/oscar/usr/choix_clavier
			choix_clavier=`cat $partition_linux/usr/share/oscar/usr/choix_clavier`
			clavier_grub
			cp -fpR $partition_linux/cd_oscar/oscar/usr/clavier $partition_linux/usr/share/oscar/usr
			# clavier pour jwm car sysrcd voir /root/.xinitrc fait dans installe_console_clavier_grub
			
			cp -f $partition_linux/cd_oscar/oscar/usr/choix_langue $partition_linux/usr/share/oscar/usr/choix_langue
			cp -f $partition_linux/cd_oscar/oscar/usr/choix_langue /usr/share/oscar/usr/choix_langue
			choix_langue=`cat $partition_linux/usr/share/oscar/usr/choix_langue`
			
			# cp -f $partition_linux/oscar/boot/oscar $partition_linux/boot/
			# cp -f $partition_linux/oscar/boot/oscar.igz $partition_linux/boot/
			
			if ( test -e $partition_linux/cd_oscar/oscar/usr/lilo_expert )
			then
				cp -f $partition_linux/cd_oscar/oscar/usr/lilo_expert /etc/lilo_expert
			fi
			if ( test -e $partition_linux/cd_oscar/oscar/usr/installer_grub2 )
			then
				echo "" >  /etc/installer_grub2	# installer grub2
				cp -f $partition_linux/cd_oscar/oscar/usr/superuser_oscar /usr/share/oscar/usr/superuser_oscar
				cp -f $partition_linux/cd_oscar/oscar/usr/crypt_mot_passe_pbkdf2 /usr/share/oscar/usr/crypt_mot_passe_pbkdf2
				rm -f /etc/installer_grub1
				rm -f $partition_linux/usr/share/oscar/usr/installer_grub1
			fi
			if ( test -e $partition_linux/cd_oscar/oscar/usr/installer_grub1 )
			then
				echo "" >  /etc/installer_grub1	# installer grub1
				rm -f /etc/installer_grub2
				rm -f $partition_linux/usr/share/oscar/usr/installer_grub2
			fi
			
		else	# ce n'est pas un client et premiere installation
			# choix de la langue :
			cp -f /usr/share/oscar/usr/choix_langue $partition_linux/usr/share/oscar/usr/choix_langue
			if ( test -e /tmp/var_salle )
			then
				cp -fdpR /tmp/var_salle $partition_linux/usr/share/oscar/
				rm -fR /tmp/var_salle
			fi

			# choix du noyau de demarrage :
				proc_cmdline=`cat /proc/cmdline`
				echo "$proc_cmdline" > /tmp/proc_cmdline
				grep -ci "BOOT_IMAGE" /tmp/proc_cmdline > /tmp/nombre_BOOT_IMAGE
				if ( test -e /tmp/nombre_BOOT_IMAGE )
				then
					nombre_BOOT_IMAGE=`cat /tmp/nombre_BOOT_IMAGE`
				fi
				rm -f /tmp/nombre_BOOT_IMAGE
				if [ "$nombre_BOOT_IMAGE" = "1" ]	# demarrage cdrom
				then
				      	perl -pi -e 's/BOOT_IMAGE=/}/g;' /tmp/proc_cmdline
				      	cut -d"}" -f2 /tmp/proc_cmdline > /tmp/proc_cmdline1
				      	cut -d" " -f1 /tmp/proc_cmdline1 > /tmp/proc_cmdline
				      	cp -f /tmp/proc_cmdline $partition_linux/usr/share/oscar/usr/BOOT_IMAGE
				else
					echo oscar > $partition_linux/usr/share/oscar/usr/BOOT_IMAGE
				fi
				perl -pi -e 's/\/isolinux\///g; s/\/syslinux\///g;' $partition_linux/usr/share/oscar/usr/BOOT_IMAGE
				rm -f /tmp/proc_cmdline
				rm -f /tmp/proc_cmdline1
			# fin du choix du noyau de demarrage

			# option_delai_boot
			echo "3" > $partition_linux/usr/share/oscar/usr/option_delai_boot
			temp_options_boot=`cat /proc/cmdline`
			echo "$temp_options_boot" > /tmp/temp_options_boot
			
			# option_boot
			perl -pi -e 's/fin_ligne/,/g;' /tmp/temp_options_boot
			cut -d"," -f2 /tmp/temp_options_boot > /tmp/temp_options_boot1
			perl -pi -e 's/oscar/,/g;' /tmp/temp_options_boot1
			cut -d"," -f2 /tmp/temp_options_boot1 > $partition_linux/usr/share/oscar/usr/options_boot
			rm -f /tmp/temp_options_boot
			rm -f /tmp/temp_options_boot1
			
			cp -f /usr/share/oscar/bin/fichier_b /etc/fichier_b
			
			if ( test -e /etc/demarrage_usb ) # usb ou cdrom
			then
				if ( test -e /etc/demarrage_cdcache )
				then
					if ( test -e /livemnt/tftpmem/syslinux ) # usb docache
					then
						# chemin_usb=tftpboot
						chemin_usb=livemnt/tftpmem
					else
						chemin_usb=livemnt/boot
					fi
				else
					chemin_usb=livemnt/boot
				fi
				echo
				echo -e " ...\033[1;34m"
				echo
				if ( test -e /$chemin_usb/syslinux/$choix_noyau )
				then
					_syslinux_=syslinux
				elif ( test -e /$chemin_usb/isolinux/$choix_noyau )
				then
					_syslinux_=isolinux
				fi
				if ( test -e /$chemin_usb/$_syslinux_/$choix_noyau )
				then
					cp -f /$chemin_usb/$_syslinux_/$choix_noyau $partition_linux/boot/oscar
					cp -f /$chemin_usb/$_syslinux_/oscar.igz $partition_linux/boot/oscar.igz
					if ( test -e /$chemin_usb/$_syslinux_/netboot )
					then
						cp -f /$chemin_usb/$_syslinux_/netboot $partition_linux/boot/
					fi
				fi
			else
				if [ "$ip_serveur_pxe" = "" ]	# installation complete par cederom
				then
					echo
					echo -e " \033[1;32m`cat $chemin_langue/Patience` ...\033[1;34m"
					echo
					if ( test -e /livemnt/boot/syslinux/$choix_noyau )
					then
						_syslinux_=syslinux
					elif ( test -e /livemnt/boot/isolinux/$choix_noyau )
					then
						_syslinux_=isolinux
					fi
					cp -f /livemnt/boot/$_syslinux_/$choix_noyau $partition_linux/boot/oscar
					cp -f /livemnt/boot/$_syslinux_/oscar.igz $partition_linux/boot/oscar.igz
					if ( test -e /livemnt/boot/$_syslinux_/netboot )
					then
					    cp -f /livemnt/boot/$_syslinux_/netboot $partition_linux/boot/
					fi
				else
					if [ "$cd_base" = "oscar_sysrcd" ] # démarrage cdrom et sysrcd
					then 
						echo "sysrcd" > $partition_linux/usr/share/oscar/usr/srscd	# installation depuis srscd
					fi
					
					cd $partition_linux/usr/share/oscar/usr/
					# la partition partagee est /livemnt/boot par le serveur http
					wget http://$ip_serveur_pxe/ -r -X /Personnel -X /bootprog -R sysrcd.dat -R sysrcd.md5
					cd /root/
					mv $partition_linux/usr/share/oscar/usr/$ip_serveur_pxe $partition_linux/usr/share/oscar/usr/oscar_usb
					
					echo
					echo -e " \033[1;32m`cat $chemin_langue/Patience` ...\033[1;34m"
					echo
					
					#	if ( test -e $partition_linux/usr/share/oscar/usr/oscar_usb/isolinux ) # si serveur pxe cederom
					#	then
					#		mv $partition_linux/usr/share/oscar/usr/oscar_usb/isolinux $partition_linux/usr/share/oscar/usr/oscar_usb/ 1>/dev/null 2>/dev/null
					#		rm -fr $partition_linux/usr/share/oscar/usr/oscar_usb/isolinux
					#	fi
					
					cp -f $partition_linux/usr/share/oscar/usr/oscar_usb/isolinux/$choix_noyau $partition_linux/boot/oscar
					cp -f $partition_linux/usr/share/oscar/usr/oscar_usb/isolinux/oscar.igz $partition_linux/boot/
					cp -f $partition_linux/usr/share/oscar/usr/oscar_usb/isolinux/netboot $partition_linux/boot/
					
					cp -f /usr/share/oscar/usr/choix_clavier $partition_linux/usr/share/oscar/usr/choix_clavier
					if ! ( test -e $partition_linux/usr/share/oscar/usr/clavier )
					then
						mkdir $partition_linux/usr/share/oscar/usr/clavier
					fi
					cp -fp /usr/share/oscar/usr/clavier/clavier_grub $partition_linux/usr/share/oscar/usr/clavier/clavier_grub
					if ! ( test -e $partition_linux/usr/share/oscar/usr/oscar_usb/sysrcd.dat )
					then
						cp -f /livemnt/boot/sysrcd.dat $partition_linux/usr/share/oscar/usr/oscar_usb/sysrcd.dat
						cp -f /livemnt/boot/sysrcd.md5 $partition_linux/usr/share/oscar/usr/oscar_usb/sysrcd.md5
					fi
				fi
			fi
			
			if ! ( test -e $partition_linux/usr/share/oscar/usr/clavier )
			then
				mkdir $partition_linux/usr/share/oscar/usr/clavier
			fi
			if ! ( test -e $partition_linux/usr/share/oscar/usr/oscar_usb )
			then
				mkdir $partition_linux/usr/share/oscar/usr/oscar_usb
			fi
			
			if ! ( test -e $partition_linux/usr/share/oscar/usr/oscar_usb/sysrcd.dat )
			then
				cp -f /livemnt/boot/sysrcd.dat $partition_linux/usr/share/oscar/usr/oscar_usb/sysrcd.dat
				cp -f /livemnt/boot/sysrcd.md5 $partition_linux/usr/share/oscar/usr/oscar_usb/sysrcd.md5
			fi
			
			cp -f $partition_linux/etc/conf.d/thttpd $partition_linux/etc/conf.d/thttpd.bak	
			perl -pi -e 's/\/livemnt\/boot/\/usr\/share\/oscar\/usr\/oscar_usb/g;' $partition_linux/etc/conf.d/thttpd
			
			### pour l'installation aussi sur clé USB:
			if ( test -e /usr/share/oscar/usr/grub-version.cfg )
			then
				cut -d"-" -f1 /root/version | perl -pi -e 's/\.//g;' > /root/version1
				version_sysrscd=`cat /root/version1`
				rm -f /root/version1
			fi
			if ( test -e /etc/demarrage_usb )
			then
				if ( test -e /livemnt/tftpmem/boot ) # car demarrage usb et cdcache
				then
					cp -fR /livemnt/tftpmem/boot $partition_linux/usr/share/oscar/usr/oscar_usb/ 2>/dev/null
					cp -fR /livemnt/tftpmem/efi $partition_linux/usr/share/oscar/usr/oscar_usb/ 2>/dev/null
				fi
				if ( test -e /$chemin_usb/syslinux/$choix_noyau )
				then
					_syslinux_=syslinux
				elif ( test -e /$chemin_usb/isolinux/$choix_noyau )
				then
					_syslinux_=isolinux
				fi
				if ( test -e /$chemin_usb/$_syslinux_/$choix_noyau )
				then
					# cp -fR /$chemin_usb/* $partition_linux/usr/share/oscar/usr/oscar_usb/
					cp -R /$chemin_usb/boot $partition_linux/usr/share/oscar/usr/oscar_usb/
					cp -R /$chemin_usb/bootdisk $partition_linux/usr/share/oscar/usr/oscar_usb/
					cp -R /$chemin_usb/efi $partition_linux/usr/share/oscar/usr/oscar_usb/
					cp -R /$chemin_usb/ntpasswd $partition_linux/usr/share/oscar/usr/oscar_usb/
					cp -R /$chemin_usb/$_syslinux_ $partition_linux/usr/share/oscar/usr/oscar_usb/
					cp -fr /livemnt/boot/sysrcd.* $partition_linux/usr/share/oscar/usr/oscar_usb/
					
					if ( test -e $partition_linux/usr/share/oscar/usr/oscar_usb/syslinux )
					then
						mv $partition_linux/usr/share/oscar/usr/oscar_usb/syslinux $partition_linux/usr/share/oscar/usr/oscar_usb/isolinux
					fi
					if ( test -e /usr/share/oscar/usr/grub-version.cfg )
					then
						perl -pi -e 's/syslinux/isolinux/g;' $partition_linux/usr/share/oscar/usr/oscar_usb/boot/grub/grub-$version_sysrscd.cfg
					fi
				fi
				# pour forcer le clavier au demarrage :
				if ( test -e /$chemin_usb/syslinux/$choix_noyau )
				then
					cp -f /$chemin_usb/syslinux/maps/$choix_clavier.ktl $partition_linux/usr/share/oscar/usr/oscar_usb/
				elif ( test -e /$chemin_usb/isolinux/$choix_noyau )
				then
					cp -f /$chemin_usb/isolinux/maps/$choix_clavier.ktl $partition_linux/usr/share/oscar/usr/oscar_usb/
				fi
				cp -f /usr/share/oscar/usr/choix_clavier $partition_linux/usr/share/oscar/usr/choix_clavier
				cp -f /usr/share/oscar/usr/clavier/clavier_grub $partition_linux/usr/share/oscar/usr/clavier/clavier_grub
			else
				if [ "$ip_serveur_pxe" = "" ]	# installation complete par cederom
				then
					# copie aussi le repertoire maps des claviers :
					if ( test -e /livemnt/boot/syslinux/$choix_noyau )
					then
						_syslinux_=syslinux
					elif ( test -e /livemnt/boot/isolinux/$choix_noyau )
					then
						_syslinux_=isolinux
					fi
					cp -fR /livemnt/boot/$_syslinux_ $partition_linux/usr/share/oscar/usr/oscar_usb/ 1>/dev/null 2>/dev/null
					# pour forcer le clavier au demarrage :
					cp -f /livemnt/boot/$_syslinux_/maps/$choix_clavier.ktl $partition_linux/usr/share/oscar/usr/oscar_usb/isolinux/ 1>/dev/null 2>/dev/null
					cp -f /usr/share/oscar/usr/choix_clavier $partition_linux/usr/share/oscar/usr/choix_clavier
					cp -f /usr/share/oscar/usr/clavier/clavier_grub $partition_linux/usr/share/oscar/usr/clavier/clavier_grub
					# copier /bootdisk et /ntpasswd aussi dans /oscar_usb pour etre pret pour la cle usb
					# cp -f /livemnt/boot/bootdisk/* $partition_linux/usr/share/oscar/usr/oscar_usb/
					# cp -fR /livemnt/boot/bootdisk $partition_linux/usr/share/oscar/usr/oscar_usb/
					cp -fR /livemnt/boot/bootdisk $partition_linux/usr/share/oscar/usr/oscar_usb/
					cp -fR /livemnt/boot/boot $partition_linux/usr/share/oscar/usr/oscar_usb/ 2>/dev/null
					if ( test -e $partition_linux/usr/share/oscar/usr/oscar_usb/boot/grub/grub-$version_sysrscd.cfg )
					then
						perl -pi -e 's/isolinux/syslinux/g;' $partition_linux/usr/share/oscar/usr/oscar_usb/boot/grub/grub-$version_sysrscd.cfg
					fi
					cp -fR /livemnt/boot/efi $partition_linux/usr/share/oscar/usr/oscar_usb/ 2>/dev/null
					if ( test -e /livemnt/boot/ntpasswd )
					then
						# cp -f /livemnt/boot/ntpasswd/* $partition_linux/usr/share/oscar/usr/oscar_usb/
						cp -fR /livemnt/boot/ntpasswd $partition_linux/usr/share/oscar/usr/oscar_usb/
					fi
				fi
			fi
			chmod 666 $partition_linux/usr/share/oscar/usr/oscar_usb/sysrcd.dat
			echo
		fi

	# Oscar installe l'autorun:
	#	if [ "$cd_base" = "oscar_catalyst" ] # pour oscar avec catalyst
	#	then
			cp -f /etc/inittab $partition_linux/etc/ # supprime le login root
	#	fi

	# pour les boites de dialogues:
	if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd et pour avoir immediatement les commandes des menus dans dialog au premier demarrage du poste
	then
		if ! ( test -e $partition_linux/tmp/mc-root )
		then
			mkdir $partition_linux/tmp/mc-root
		fi
		mount -o bind /proc $partition_linux/proc
		mount -o bind /dev $partition_linux/dev
		mount -o bind /sys $partition_linux/sys
		# chroot $partition_linux /bin/zsh rm -f /tmp/sortir 2>/dev/null
		chroot $partition_linux /bin/bash rm -f /tmp/sortir 2>/dev/null
	fi
	# fin d'initialisation des boites de dialog
	
	perl -pi -e 's/fichier_a/fichier_s /g;' $partition_linux/usr/share/oscar/bin/depart
	if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
	then
		perl -pi -e 's/fichier_a/fichier_s /g;' $partition_linux/usr/share/oscar/bin/sauve
	fi

	## initialiser les fichiers:
	echo "" > $partition_linux/etc/oscar	 # autoriser
	echo "" > $partition_linux/etc/cdrom_ejecte ## pour ne pas ejecter le cd
	if ( test -e /etc/demarrage_cdoscar_minimal )  # client minimal fsscript_cli.sh de livecd
	then
		echo "" > $partition_linux/etc/demarrage_cdoscar_minimal
	else
		rm -f $partition_linux/etc/demarrage_cdoscar_minimal
	fi
	cp -f /etc/fichier_s $partition_linux/bin/fichier_s
	cp -f /etc/fichier_s $partition_linux/usr/share/oscar/bin/fichier_s
	
	cp -f /etc/fichier_t $partition_linux/bin/fichier_t
	cp -f /etc/fichier_t $partition_linux/usr/share/oscar/bin/fichier_t

	if ! ( test -e /etc/fichier_r )
	then
		if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
		then
			# echo "vga=791" > /etc/fichier_r
			#echo "vga=0x317" > /etc/fichier_r
			echo "vga=0" > /etc/fichier_r
		else
	    		echo "791" > /etc/fichier_r
	    	fi
	fi
	cp -f /etc/fichier_r $partition_linux/bin/fichier_r
	cp -f /etc/fichier_r $partition_linux/usr/share/oscar/bin/fichier_r
	if ( test -e /etc/lilo_expert )
	then
		cp -f /etc/lilo_expert $partition_linux/usr/share/oscar/usr/lilo_expert
	else
		rm -f $partition_linux/usr/share/oscar/usr/lilo_expert
	fi

	installer_fstab_conf_demarrage
}
#----------------------------------------------------------------------------------------------------
modifier_grub_conf_si_expert_resolution_ou_mdp()
{
	## installe_oscar_dd cherche_partition_et_variables_boot
	# partition_boot=`cat /tmp/partition_boot`	# partition_boot montée
	# $partition_linux
	# rm -f /tmp/partition_boot

	if ( test -e $partition_linux/usr/share/oscar/usr/grub.conf.expert )
	then
		if ( test -e $partition_linux/boot/grub/grub.conf )
		then
		    cp -f $partition_linux/boot/grub/grub.conf $partition_linux/etc/grub.conf.bak
		    cp -f $partition_linux/boot/grub/grub.conf $partition_linux/etc/grub.conf
		fi

		mc -e $partition_linux/etc/grub.conf
		clear
		cp -f $partition_linux/etc/grub.conf $partition_linux/boot/grub/grub.conf
		cp -f $partition_linux/etc/grub.conf $partition_linux/usr/share/oscar/usr/grub.conf.expert
	
		## changer le mot de passe sauve:
		commande_maj=`cat /tmp/mot_de_passe`
		rm -f /tmp/mot_de_passe
		    if [ "$commande_maj" = "mot_de_passe" ]
		    then
		    	# Mot de passe administrateur réseau
			titre_mdp=" `cat $chemin_langue/mdp_1` "
			fichierquestion="`cat $chemin_langue/mdp_2`"
			boite_mdp
			mot_passe_boot=$reponse
		
			# Confirmation du mot de passe
			titre_mdp=" `cat $chemin_langue/mdp_3`  "
			fichierquestion="`cat $chemin_langue/mdp_4`"
			boite_confirme_mdp
			rm -f /etc/fichier_s
			echo "$reponse" > /etc/fichier_s
			cp -f /etc/fichier_s $partition_linux/usr/share/oscar/bin/fichier_s
		    fi
		exit
#	echo "" > /tmp/mot_change
	fi
}
#----------------------------------------------------------------------------------------------------
cherche_partition_et_variables_boot()
{
variables_fichier_lilo_conf # faire les variables nécessaires au fichier lilo.conf et grub.conf
if ( test -e /tmp/sortir )
then
	return
fi
	#	disque_boot_grub=hd`cat /tmp/disque_boot_grub`	# numero du disque pour grub
	#	disque_boot=dev/`cat /tmp/disque_boot`			# dev/hda
	#	partition_boot=dev/`cat /tmp/partition`			# dev/hdaiii
	#	nom_simple_boot=`cat /tmp/nom_simple`			# hdaiii

nombre_partitions_linux=0
type="linux"
# initialiser:
	rm -f /tmp/kernel_ligne_ubuntu			# ligne kernel ubuntu pour grub.conf
	rm -f /tmp/kernel_ligne_mandriva		# ligne kernel mandriva pour grub.conf
	rm -f /tmp/global_ubuntu	# pour plusieurs partitions ubuntu
	rm -f /tmp/global_mandriva	# pour plusieurs partitions mandriva

# donner le fichier /tmp/ordre_disques_grub :
boucle_partition

# donner partition swap si existe pour fstab oscar:
# sfdisk -l > /tmp/partition_swap 2>/dev/null
grep -ci "swap" /tmp/fichier_disque_dur > /tmp/partition_swap1
test_partition_swap=`cat /tmp/partition_swap1`
if [ "$test_partition_swap" != "0" ]	# il existe une partition swap
then
	grep -i "swap" /tmp/fichier_disque_dur > /tmp/partition_swap1
	cut -d" " -f1 /tmp/partition_swap1 > /tmp/partition_swap
	dev_partition_swap=`cat /tmp/partition_swap`
	partition_swap=`expr substr $dev_partition_swap 6 6`
	reponse=$partition_swap
	sortir_uuid_reponse
	uuid_partition_swap=$test_vol_id
	echo "partition_swap,$partition_swap,$uuid_partition_swap" >> /tmp/fichier_partitions_boot
fi
rm -f /tmp/partition_swap
rm -f /tmp/partition_swap1

# etude du fichier /tmp/fichier_partitions_boot:
# si partition_linux_unique choisir pour boot cette partition
# si partition_linux_juste_boot choisir pour boot cette partition
# sinon : proposer les autres partitions partition_linux_complete et partition_avec_oscar

determiner_partition_linux_boot

# variables obtenues: utiles pour grub.conf
#    echo "
# 	$disque_boot_grub=hd`cat /tmp/disque_boot_grub`	# numero du disque pour grub
#	$nombre_partition_linux_juste_boot		# pour utiliser obligatoirement la partition de /boot
#	$partition_boot_grub				# sdaii partition du boot, oscar ou éventuellement contient juste /boot
# 	$numero_hd_oscar				# numero du répertoire oscar pour grub
#	$numero_hd_boot_grub				# numero du répertoire de boot/grub
#	$partition_ubuntu				# partition_ubuntu
#	$version_ubuntu					# version ubuntu
#	`cat /tmp/kernel_ligne_ubuntu`			# ligne kernel ubuntu pour grub.conf
#	$numero_hd_ubuntu				# numero du répertoire Ubuntu eventuel
#	$partition_mandriva				# partition_mandriva
#	$version_mandriva				# version mandriva
#	`cat /tmp/kernel_ligne_mandriva`		# ligne kernel mandriva pour grub.conf
#	$numero_hd_mandriva				# numero du répertoire Mandriva eventuel
#    "
#	echo ici
#	read m

repertoire_linux=$partition_linux	# pour lilo
echo "$partition_linux" > /tmp/monter_partition
runme autoriser_monter_partition_oscar
partition_linux=`cat /tmp/monter_partition`
rm -f /tmp/monter_partition
}
#----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
boucle_partition_vfat_ancien()##  boucle cherche premiere partition vfat:
{
rm -f /tmp/tempfile
echo "$type" > /tmp/tempfile
runme prepare_boucle_partition
nombretype=`cat /tmp/nombre`
rm -f /tmp/nombre
rm -f /tmp/partition_oscar_lettre_win
numero=0
until  ( test  $numero = $nombretype )
do
	rm -f /tmp/tempfile1
	numero=$[$numero+1]
	cut -d":" -f$numero /tmp/tempfile > /tmp/tempfile1	#hdaiii
	reponse=`cat /tmp/tempfile1`
	echo "D" > /tmp/partition_oscar_lettre_win
	echo "$reponse" > partition_oscar_reponse
	partition_vfat_trouvee=oui
	rm -f /tmp/tempfile
	rm -f /tmp/tempfile1
	return 1
done
rm -f /tmp/tempfile
rm -f /tmp/tempfile1
}
#-----------------------------------------------------------------------------------------------------
cherche_partition_vfat_autre_systeme()  # pour ecrire les fichiers servant au nom du poste sur cette partition si vfat
{
# cherche si partition sauvegardee c est vfat
rm -f /tmp/partition_oscar_lettre_win
disque=`expr substr $base 1 3`	## avec la valeur de la base:	## sda
numero=`expr substr $base 4 3`
rm -f partition_oscar_reponse
# id_type=`sfdisk /dev/$disque -c $numero 2>/dev/null`
runme info_ddialog
grep -i $base /tmp/fichier_disque_dur | grep -ci fat32 > /tmp/nb_partition_fat32
nb_partition_fat32=`cat /tmp/nb_partition_fat32`
rm -f /tmp/nb_partition_fat32
if [ "$nb_partition_fat32" = "1" ] # partition fat32 cherche la premiere partition vfat
then
	echo "vfat" > partition_oscar_reponse
	echo "C" > /tmp/partition_oscar_lettre_win
else
	grep -i $base /tmp/fichier_disque_dur | grep -ci ntfs > /tmp/nb_partition_ntfs
	nb_partition_ntfs=`cat /tmp/nb_partition_ntfs`
	rm -f /tmp/nb_partition_ntfs
	if [ "$nb_partition_ntfs" = "1" ] # partition ntfs
	then  # partition ntfs
		echo "ntfs" > partition_oscar_reponse
		echo "C" > /tmp/partition_oscar_lettre_win
	else
		grep -i $base /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
		nb_partition_linux=`cat /tmp/nb_partition_linux`
		rm -f /tmp/nb_partition_linux
		if [ "$nb_partition_linux" = "1" ] # partition linux non swap
		then #	cherche si ubuntu installé
			echo "rien_linux" > /tmp/partition_oscar_lettre_win
			echo "linux" > partition_oscar_reponse
		fi
	fi
fi
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
#  Prog principal
#----------------------------------------------------------------------------------------------------
#  commandes externes de procédures
case "$1" in
    installer_fichiers_oscar)
    	type_boot=grub

	partition_linux=`cat partition_linux_sauvegarde`	# sdaiii
	repertoire_linux=$partition_linux	# pour lilo

	echo "$partition_linux" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	partition_linux=`cat /tmp/monter_partition`
	rm -f /tmp/monter_partition

	echo
	echo -e "\033[1;31m `cat $chemin_langue/Patience` ... \033[1;m "
	variables_fichier_lilo_conf

	# disque_boot=dev/`cat /tmp/disque_boot`		# dev/hda	disque boot d'origine
	# partition_boot=dev/`cat /tmp/partition`		# dev/hdaiii	partition de boot
	# nom_simple_boot=`cat /tmp/nom_simple`			# hdaiii
	# numero_boot=`expr substr $nom_simple_boot 4 3`	# iii
	
	echo "" > /tmp/client_lance
	if ( test -e /root/sysresccd-pkg.txt )	# démarrage cd sysrcd avec ou sans option cdcache ou démarrage sur le poste si sysrcd
	then	# menu pour sysrcd:
		cd_base=oscar_sysrcd
	else
		cd_base=oscar_catalyst
	fi
	installer_fichiers_oscar
	rm -f /etc/sortie_lilo
	exit 0
	;;

    faire_lilo_conf_lilo) # faire le fichier conf.lilo et lilo
    	type_boot=grub

    	partition_linux=`cat partition_linux_sauvegarde`	# sdaiii
	repertoire_linux=$partition_linux	# pour lilo
	
	variables_fichier_lilo_conf	# faire les variables nécessaires au fichier lilo.conf	
	#	disque_boot=dev/`cat /tmp/disque_boot`		# dev/hda

    	faire_fstab
	if ( test -e /root/sysresccd-pkg.txt )	# démarrage cd sysrcd avec ou sans option cdcache ou démarrage sur le poste si sysrcd
	then	# menu pour sysrcd:
		cd_base=oscar_sysrcd
		if ! ( test -e /etc/installer_grub2 )
		then
			faire_conf_sysrcd_$type_boot
		else
			faire_grub_conf_pour_oscar
		fi
	else
		cd_base=oscar_catalyst
		faire_conf_$type_boot
	fi

	# nettoyer la partition pour réinstaller lilo
	if ( test -e $partition_linux/boot/boot.b )
	then
		chmod 777 $partition_linux/boot/boot.b
		rm -f $partition_linux/boot/boot.b
	fi

	installer_demarrage
	
	exit 0
	;;	
    installation_eventuelle_ubuntu)
    	type_boot=grub
	installation_eventuelle_ubuntu
	exit 0
	;;
    installation_eventuelle_ubuntu_grub)
	type_boot=grub
	installation_eventuelle_ubuntu_grub
	rechercher_si_windows_installe
        exit 0
	;;
    faire_conf_grub)
	faire_conf_grub
	exit 0
	;;
    mettre_a_jour_uuid_fstab)
	controle_uuid_existe
        if ! [ "$aucun_uuid" = "oui" ]
	then
	    mettre_a_jour_uuid_fstab # si besoin
	fi
	exit 0
	;;
    cherche_partition_et_variables_boot)	####	cherche la partition de boot:
    	type_boot=grub
   	cherche_partition_et_variables_boot
   	echo "$partition_linux" > /tmp/partition_boot	
	exit 0
	;;
    boucle_partition_UUID)	####
    	boucle_partition_UUID	
	exit 0
	;;
    remplacer_sdai_par_uuid)
	remplacer_sdai_par_uuid
	exit 0
	;;
    remplacer_uuid_par_sdai)
	remplacer_uuid_par_sdai
	exit 0
	;;
    cherche_partition_et_variables_boot_pour_serveur)	####	cherche la partition de boot et partition vfat
    	# besoin de la partition sauvegadee dans /tmp/base_sauvegarde
    	type_boot=grub
    	echo "serveur_grub" > /tmp/serveur_grub
    	serveur_grub=oui
    	serveur_lance=oui
   	cherche_partition_et_variables_boot
   	if ( test -e /tmp/sortir )
	then
		exit 0
	fi
   	rm -f /tmp/serveur_grub
   	# résultats:
   		# variables obtenues: utiles pour grub.conf
		#    echo "
		# 	$disque_boot_grub=hd`cat /tmp/disque_boot_grub`	# numero du disque pour grub
		#	$nombre_partition_linux_juste_boot		# pour utiliser obligatoirement la partition de /boot
		#	$partition_boot_grub				# sdaii partition du boot, oscar ou éventuellement contient juste /boot
		# 	$numero_hd_oscar				# numero du répertoire oscar pour grub
		#	$numero_hd_boot_grub				# numero du répertoire de boot/grub
		#	$partition_ubuntu				# partition_ubuntu
		#	$version_ubuntu					# version ubuntu
		#	`cat /tmp/kernel_ligne_ubuntu`			# ligne kernel ubuntu pour grub.conf
		#	$numero_hd_ubuntu				# numero du répertoire Ubuntu eventuel
		#	$partition_mandriva				# partition_mandriva
		#	$version_mandriva				# version mandriva
		#	`cat /tmp/kernel_ligne_mandriva`		# ligne kernel mandriva pour grub.conf
		#	$numero_hd_mandriva				# numero du répertoire Mandriva eventuel
		#    "
		# dans le fichier /tmp/fichier_partitions_boot:
		# partition_linux_unique
		# partition_linux_juste_boot
		# partition_avec_oscar
		# partition_linux_complete
		# partition_linux_ubuntu
		# partition_linux_mandriva
		# partition_linux_donnees
		# partition_oscar = $partition_linux (peut être vide si démarrage poste)

		# disque_boot_grub=hd`cat /tmp/disque_boot_grub`	# numero du disque pour grub
		# echo "$partition_linux" > /tmp/partition_boot_grub
		# echo "$partition_installer_oscar" > /tmp/partition_installer_oscar
	
	# partition_boot_grub=`cat /tmp/partition_boot_grub` non fait ici
		# echo "$disque_boot,$disque_boot_grub,$numero_hd_boot_grub,$partition_boot_grub,$numero_hd_oscar,$partition_installer_oscar" > $repertoire_partition_linux/usr/share/oscar/usr/fichier_disque_boot_grub
		# ex: "/dev/sda,hd0,2,sda3(/boot/grub),3,sda4(Oscar)"
		# 
		# $repertoire_partition_linux/usr/share/oscar/usr/installer_oscar_grub : pour installer grub
	
	
	base=`cat /tmp/base_sauvegarde`
	rm -f /tmp/base_sauvegarde
	#	echo "non_autre_systeme" > partition_autre_systeme
	# teste sysprep :
	echo "$partition_installer_oscar" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	linux_sauvegarde=`cat /tmp/monter_partition`
	rm -f /tmp/monter_partition

	rm -f /tmp/sysprep_installe
	rm -f /tmp/newsid_installe
	if ( test -e $linux_sauvegarde/oscar/date_de_sauvegarde )
	then
		cut -d";" -f2 $linux_sauvegarde/oscar/date_de_sauvegarde > /tmp/tempsysprep
		test_sysprep=`cat /tmp/tempsysprep`
		rm -f /tmp/tempsysprep
		if [ "$test_sysprep" = "sysprep" ]
		then
			echo "sysprep" > /tmp/sysprep_installe
		elif [ "$test_sysprep" = "oscar_deploie" ]
		then
			echo "oscar_deploie" > /tmp/sysprep_installe
		elif [ "$test_sysprep" = "newsid" ]
		then
			echo "" > /tmp/newsid_installe
		fi
	fi
	
	cherche_partition_vfat_autre_systeme
	reponse_nom=`cat partition_oscar_reponse`
	# reponse_lettre=`cat /tmp/partition_oscar_lettre_win`
	reponse_lettre="C"

	# à déterminer :
	# echo "linux_non_ubuntu" > partition_oscar_reponse
	# echo "ubuntu" > partition_oscar_reponse
	
	autre_partition_linux=`cat /tmp/partition_oscar_lettre_win`
	
	if ! [ "$partition_ubuntu" = "rien_du_tout" ] # à vérifier sinon vide
	then
		nom_systeme=ubuntu
	elif ! [ "$partition_mandriva" = "rien_du_tout" ]
	then
		nom_systeme=mandriva
	elif [ "$autre_partition_linux" = "rien_linux" ]	# la sauvegarde est autre linux
	then
		nom_systeme=linux
	else
		nom_systeme=windows
	fi

	rm -f /tmp/textetmp1
	rm -f /tmp/textetmp2
	
	if ! ( test -e 	/tmp/sysprep_installe )
	then
		if ! ( test -e 	/tmp/newsid_installe )
		then
			echo "\Zn --> `cat $chemin_langue/texte_60` $nom_systeme, `cat $chemin_langue/texte_61`" > /tmp/textetmp1
			echo "\Zn --> `cat $chemin_langue/texte_62` \Zb\Z4sauve\Zn." > /tmp/textetmp2
		
		        if [ "$nom_systeme" = "windows" ]
			then
			        if ! [ "$reponse_nom" = "nonvfat" ]	# changer les fichiers précédents
				then
					echo "\Zn --> `cat $chemin_langue/texte_63`" > /tmp/textetmp1
					echo "\Zn     `cat $chemin_langue/texte_64`" > /tmp/textetmp2
				fi
			fi
		else
			echo "" > /tmp/textetmp1
			echo "" > /tmp/textetmp2
		fi
	else
		echo "" > /tmp/textetmp1
		echo "" > /tmp/textetmp2
	fi
	exit 0
	;;
    demander_clavier)
	demander_clavier
	exit 0
	;;
esac ## fin de commandes externes

# ci-dessous debut test provisoire pour EFI
runme tester_gpt_provisoire
# fin du test provisoire EFI qu'il faudra supprimer quand OK 

menu_reseau test_partition_lvm
if ( test -e /tmp/sortir )
then
	rm -f /tmp/sortir
	exit
fi

rm -f /tmp/texte_mbr
runme test_cdrom_sysresccd
if ( test -e /tmp/sortir_commande )
then
	exit
fi
if ( test -e /tmp/client_lance )
then
    client_lance=oui
else
    client_lance=non
fi
if ( test -e /tmp/rst_lance )
then
	rm -f /tmp/rst_lance
	rst_lance=oui
else
	rst_lance=non
fi
	#	recherche si client PXE
	grep -ci "netboot=http:" /proc/cmdline > /tmp/tempfile
	nombre_demarrage_pxe=`cat /tmp/tempfile`
	# ip_serveur_pxe est vide si installation complete
	ip_serveur_pxe=
        if [ "$nombre_demarrage_pxe" = "1" ]
	then
		echo "`cat /proc/cmdline`" > /tmp/tempfile
		perl -pi -e 's/netboot=http:\/\//?/g;' /tmp/tempfile
		cut -d"?" -f2 /tmp/tempfile > /tmp/temp1
		perl -pi -e 's/\/sysrcd.dat/?/g;' /tmp/temp1
		cut -d"?" -f1 /tmp/temp1 > /tmp/tempfile
		ip_serveur_pxe=`cat /tmp/tempfile`	## pour telecharger un fichier dans /root/ : wget http://$ip_serveur_pxe/isolinux/oscar 
		rm -f /tmp/tempfile
		rm -f /tmp/temp1
	fi
	#	fin de recherche si client PXE
type_boot=grub
rm -f /tmp/serveur_grub # on ne sait jamais

if ( test -e /tmp/repare_boot_dd )
then
	repare_boot_dd=oui
	rm -f /tmp/repare_boot_dd
	if [ "$client_lance" = "oui" ]
	then
        	echo "serveur_grub" > /tmp/serveur_grub
		serveur_grub=oui
	fi
else
	repare_boot_dd=non
fi

# modifier_fstab=oui		# pour modifier fstab
commande_installe_oscar_mp_lancee=non
commande_installe_resolution_lancee=non
if ( test -e /tmp/installe_oscar_mp_lance )
then
	commande_installe_oscar_mp_lancee=oui	
	rm -f /tmp/installe_oscar_mp_lance
	if ( test -e /tmp/installe_resolution_lance )
	then
		commande_installe_resolution_lancee=oui
		rm -f /tmp/installe_resolution_lance
	fi
fi


if [ "$repare_boot_dd" = "non" ]
then
	if [ "$commande_installe_oscar_mp_lancee" = "non" ]
	then
		test_cdrom_isolinux
	fi
fi

if ( test -e /root/sysresccd-pkg.txt )	# démarrage cd sysrcd avec ou sans option cdcache ou démarrage sur le poste si sysrcd
then	# menu pour sysrcd:
	cd_base=oscar_sysrcd
else
	cd_base=oscar_catalyst
fi


if [ "$repare_boot_dd" = "non" ]
then
	if [ "$commande_installe_oscar_mp_lancee" = "non" ] ## ce n'est pas la commande installe_oscar_mp qui est lancée
	then
		if ! ( test -e /etc/demarrage_usb )
		then
			test_demarrage_cdrom # et pas fichier minimal oscar client minimal
		else
			test_demarrage_usb # pour ne pas utiliser si cdcache activé
		fi
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
			exit
		fi
		####	cherche les partitions linux:
		boite_info_depart

		if ! ( test -e /etc/installer_grub1 )
		then
			echo "" > /etc/installer_grub2
			# rm -f /usr/share/oscar/usr/installer_grub1
			if ( test -e /usr/share/oscar/usr/initialise )
			then
				boite_choix_menu_demarrage_propose_grub1
			else
				boite_choix_menu_demarrage
			fi
		else	# car grub1 force par jf
			rm -f /etc/installer_grub2
			rm -f /usr/share/oscar/usr/installer_grub2
		fi
	
	fi	## fin non commande installe_oscar_mp
fi
if ( test -e /tmp/tempmandriva )
then
	if [ "$repare_boot_dd" = "non" ]	# si modification du fichier /etc/menu.lst pour autres systemes ubuntu il faut lancer installe_oscar_dd et non repare_boot
	then
		rm -f /tmp/tempmandriva
	fi
fi

####	cherche la partition de boot:
cherche_partition_et_variables_boot
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		exit
	fi
##	echo "$partition_linux : monté linux" >> /tmp/historique
if [ "$commande_installe_oscar_mp_lancee" = "oui" ] || [ "$repare_boot_dd" = "oui" ]	# faire grub2 si /usr/installer_grub2 existe sur poste
then
	if ( test -e $partition_linux/usr/share/oscar/usr/installer_grub2 )
	then
		echo "" > /etc/installer_grub2
	fi
fi

if [ "$commande_installe_oscar_mp_lancee" = "oui" ]	#	modifier grub.conf si expert pour résolution et mdp de maj_boot_oscar
then
	
	modifier_grub_conf_si_expert_resolution_ou_mdp
fi

if [ "$repare_boot_dd" = "non" ]
then
	if [ "$commande_installe_resolution_lancee" = "non" ]	### ne pas demander les mdp si résolution demandée
	then
		grub_autorise
		clear
	fi
fi

if [ "$supprimer_fichier_expert_grub" = "oui" ]	# pour supprimer le grub personnalisé par demande expert
then
	if ( test -e $partition_linux/usr/share/oscar/usr/grub.conf.expert )
	then
		rm -f $partition_linux/usr/share/oscar/usr/grub.conf.expert
	fi
fi

resolution=non	# pour boite info_fin_resolution

if [ "$commande_installe_oscar_mp_lancee" = "non" ] ## la commande installe_oscar_mp non demande
then
	if [ "$repare_boot_dd" = "non" ]
	then
		installer_fichiers_oscar
	else	# en repare_boot_dd et client_clone et multi
		if ( test -e /etc/demarrage_cdrom ) || ( test -e /etc/demarrage_usb )
		then
			if ! ( test -e /tmp/client_lance )
			then
				if ! ( test -e $partition_linux/usr/share/oscar/usr/version_oscar )
				then
					if [ "$rst_lance" = "non" ]
					then
						# OSCAR\Zn\Z2 n'est pas installé sur ce poste
						DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
						--backtitle "`cat /etc/banniere_oscar`" \
						--title " `cat $chemin_langue/DESOLE` " \
						--ok-label "`cat $chemin_langue/Continuer`"  \
						--msgbox "\n`cat $chemin_langue/msgbox_62` \Zb\Z3réparer_boot\Zn\Z2." 9 60
						case $? in
						    0) 	exit;;
						    255) exit;;
						esac
					fi
					exit
				fi
				if ( test -e $partition_linux/usr/share/oscar/usr/installer_grub2 )
				then
					echo "" > /etc/installer_grub2
					if ! ( test -e /usr/share/oscar/usr/superuser_oscar )
					then # car reparation_boot par cederom
						cp -f $partition_linux/usr/share/oscar/usr/superuser_oscar /usr/share/oscar/usr/superuser_oscar
						cp -f $partition_linux/usr/share/oscar/usr/crypt_mot_passe_pbkdf2 /usr/share/oscar/usr/crypt_mot_passe_pbkdf2
					fi
					if ( test -e $partition_linux/usr/share/oscar/usr/installe_oscar_seul )
					then # car reparation_boot par cederom
						cp -f $partition_linux/usr/share/oscar/usr/installe_oscar_seul /etc/installe_oscar_seul
					fi
					if ( test -e $partition_linux/usr/share/oscar/usr/etc_default_grub )
					then # car reparation_boot par cederom
						cp -f $partition_linux/usr/share/oscar/usr/etc_default_grub /etc/grub
					fi
				fi
			fi
		fi
		if ( test -e $partition_linux/usr/share/oscar/bin/fichier_t ) # ne copie pas si non installé, possible en client_oscar
		then
			cp -f $partition_linux/usr/share/oscar/bin/fichier_r /etc/fichier_r
			cp -f $partition_linux/usr/share/oscar/bin/fichier_s /etc/fichier_s
			cp -f $partition_linux/usr/share/oscar/bin/fichier_t /etc/fichier_t
		fi
		if [ "$rst_lance" = "non" ]
		then
			if [ "$client_lance" = "oui" ]
			then
				if ! ( test -e /tmp/client_multi_lance )
				then
					rm -f /tmp/client_multi_lance
					installer_fichiers_oscar # installation complète avec le boot grub pour client cloné
				else
					installer_fstab_conf_demarrage	# installation grub sans les fichiers oscar
				fi
			else
				rm -f /etc/lilo_expert
				rm -f $partition_linux/usr/share/oscar/usr/lilo_expert
				installer_fstab_conf_demarrage	# pour reparer boot
			fi
		else	# rst_lance
			installer_fstab_conf_demarrage	# pour reparer boot
		fi

	fi
else	## 	commande installe_oscar_mp
	if [ "$commande_installe_resolution_lancee" = "non" ]	###	ne pas modifier les mots de mdp si résolution demandée
	then	
		### grub_autorise a determiner les variables utiles dans /etc/fichier_x
		cp -f /etc/fichier_s $partition_linux/usr/share/oscar/bin/fichier_s
		cp -f /etc/fichier_t $partition_linux/usr/share/oscar/bin/fichier_t
		
		cp -f $partition_linux/usr/share/oscar/bin/fichier_r /etc/fichier_r
		
		if ( test -e $partition_linux/usr/share/oscar/usr/lilo_expert )
		then
			cp -f $partition_linux/usr/share/oscar/usr/lilo_expert /etc/lilo_expert
		fi
	
		if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
		then
			if ! ( test -e /etc/installer_grub2 )
			then
				faire_conf_sysrcd_$type_boot
			else
				faire_grub_conf_pour_oscar
			fi
		else
			faire_conf_$type_boot
		fi
	else	### modifier la résolution d'affichage: 
	    	if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
		then
			menu_affichage_sysrcd_$type_boot
		else
			menu_affichage
		fi
		if ( test -e /tmp/sortir )
		then
		    rm -f /tmp/sortir
	    	    exit
		fi
		cp -f /etc/fichier_r $partition_linux/bin/fichier_r
		cp -f /etc/fichier_r $partition_linux/usr/share/oscar/bin/fichier_r
		cp -f $partition_linux/usr/share/oscar/bin/fichier_t /etc/fichier_t
		cp -f $partition_linux/usr/share/oscar/bin/fichier_s /etc/fichier_s
		
		if ( test -e $partition_linux/usr/share/oscar/usr/lilo_expert )
		then
			cp -f $partition_linux/usr/share/oscar/usr/lilo_expert /etc/lilo_expert
		fi

		if [ "$cd_base" = "oscar_sysrcd" ] # pour sysrcd
		then
			if ! ( test -e /etc/installer_grub2 )
			then
				faire_conf_sysrcd_$type_boot
			else
				faire_grub_conf_pour_oscar
			fi
		else
			faire_conf_$type_boot
		fi

		resolution=oui	## pour boite info fin
	fi
	if ( test -e $partition_linux/boot/boot.b )
	then
		chmod 777 $partition_linux/boot/boot.b
		rm -f $partition_linux/boot/boot.b
	fi
	cp -f /etc/fstab $partition_linux/etc/fstab 2>/dev/null
	installer_demarrage
	rm -f /etc/sortie_lilo
	## fin de résolution d'affichage
fi	## fin non commande installe_oscar_mp	et de résolution d'affichage

	##	Démontage de la partition accueillant Oscar...

if [ "$repare_boot_dd" = "non" ]
then
	if [ "$resolution" = "non" ]
	then
		boite_info_fin
	else
		boite_info_resolution
	fi
fi
umount $partition_linux 2>/dev/null 1>/dev/null ; sync
umount $partition_boot_grub 2>/dev/null 1>/dev/null ; sync
umount /mnt/$partition_boot_efi 2>/dev/null 1>/dev/null ; sync
