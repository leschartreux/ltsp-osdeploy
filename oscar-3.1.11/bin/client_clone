#!/bin/sh


## Copyright (c) 2003-2013 Tissoires Jean-Fran√ßois & Benjamin, jftissoires@gmail.com
## Outil Syst√®me Complet d'Assistance R√©seau: OSCAR
## Ce programme est sous Licence Publique G√©n√©rale GNU publi√©e par la Free Software Foundation.

# 3 variables /tmp/correcteur_compression_restaure selon linux ou  2 pour ntfs

#----------------------------------------------------------------------------------------------------
test_demarrage_cdrom() ## si oscar est d√©marr√© sur le poste ne pas utiliser cette commande
{
	if ! ( test -e /etc/demarrage_cdrom ) ## le poste est d√©marr√© avec client_multi de multi_lilo voir depart
	then
		if ! ( test -e /etc/demarrage_usb ) ## le poste est d√©marr√© avec client_multi de multi_lilo voir depart
		then
			DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--ok-label "`cat $chemin_langue/Continuer`"  \
			--msgbox "`cat $chemin_langue/nocederom_1`" 0 0
			case $? in
			    0) 	exit;;
			    255) exit;;
			esac
		fi
	fi
}
#----------------------------------------------------------------------------------------------------
boite_numero_poste()
{
	# Client synchrone proc√©dure compl√®te
	DIALOGRC="/etc/dialogrc" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " `cat $chemin_langue/inputbox_23` " \
	--inputbox "\n `cat /tmp/fichierquestion`" 15 70 $defaut 2>/tmp/tempfile
	case $? in
	    0)	#rm -f /tmp/fichier_disque_dur
		#rm -f /tmp/fichierquestion
                #reponse=`cat /tmp/tempfile`
		#return
		#;;
		rm -f /tmp/fichier_disque_dur
		teste_numero_client
		rm -f /tmp/fichierquestion
		if ( test -e /tmp/sortir )
	        then
	        	rm -f /tmp/tempfile
    			rm -f /tmp/sortir
	        	exit
		else
	                reponse=`cat /tmp/tempfile`
			rm -f /tmp/tempfile
			return
		fi
		;;
	    1)  rm -f /tmp/fichier_disque_dur
		rm -f /tmp/tempfile
	        echo "" > /tmp/sortir
		rm -f /tmp/fichierquestion
		return;;
	    255) rm -f /tmp/fichier_disque_dur
		rm -f /tmp/tempfile
	        echo "" > /tmp/sortir
		rm -f /tmp/fichierquestion
		return;;
	esac
}
#----------------------------------------------------------------------------------------------------
boucle_partition_image() # sortir la partition de sauvegarde √©ventuelle dans la reponse
{
rm -f /tmp/tempfile
echo "$type" > /tmp/tempfile
runme prepare_boucle_partition
nombretype=`cat /tmp/nombre`
rm -f /tmp/nombre

numero=0
until  ( test  $numero = $nombretype )
    do
	rm -f /tmp/tempfile1
#	rm -f /tmp/partfile1
	numero=$[$numero+1]
	cut -d":" -f$numero /tmp/tempfile > /tmp/tempfile1
#	cut -d":" -f$numero /tmp/partfile > /tmp/partfile1	#ide/h0/b0/t0/l0/hdaiii
	reponse=`cat /tmp/tempfile1`
	reparti=$reponse
	rm -f /tmp/tempfile1
	numero_hd=`expr substr $reponse 4 3`
	disque=`expr substr $reponse 1 3`       #hda
#	disque=`cut -d"/" -f1-5 /tmp/partfile1`/disc	#ide/h0/b0/t0/l0/disc
#	rm -f /tmp/partfile1
        if [ "$type" = "linux" ]
	then
        	# id_type=`sfdisk /dev/$disque -c $numero_hd 2>/dev/null`
		grep -c Linux /tmp/fichier_disque_dur > /tmp/nb_partition_linux
	        nb_partition_linux=`cat /tmp/nb_partition_linux`
	        rm -f /tmp/nb_partition_linux
		if ! [ "$nb_partition_linux" = "0" ] # partition linux non swap
		then
			#if ! ( test -e /mnt/$reponse )
			#	then	mkdir /mnt/$reponse
			#fi
			
			echo "$reponse" > /tmp/monter_partition
			runme autoriser_monter_partition_oscar
			partition_linux_dd=`cat /tmp/monter_partition`
			rm -f /tmp/monter_partition

			if ( test -e $partition_linux_dd/oscar/var_poste/numero_poste_client )
			then
				poste=`cat $partition_linux_dd/oscar/var_poste/numero_poste_client`
				umount $partition_linux_dd 2>/dev/null ; sync
				rm -f /tmp/tempfile
	#			rm -f /tmp/partfile
				return
			fi
			umount $partition_linux_dd 2>/dev/null ; sync
		fi
	fi
    done
rm -f /tmp/tempfile
# rm -f /tmp/partfile
}
#----------------------------------------------------------------------------------------------------
restaurer_avec_rsync()
{
rsync -aXAHWq /mnt/partition_disque_$reponse /mnt/$reponse 2>/dev/null
echo $? > /tmp/rapport_fin_rsync
erreur=`cat /tmp/rapport_fin_rsync`
if ! [ "$erreur" = "0" ]
then	# des erreurs
	echo
	echo -e "`cat $chemin_langue/boucle_2`"
	echo
	read p
	echo "" > /tmp/sortir
	exit
fi
}
#----------------------------------------------------------------------------------------------------
bargraphe_dialog_rsync()
{
#	# taille des fichiers de la partition serveur : trop long ici
#	ls -sR /mnt/partition_disque_$reponse | grep total | awk '{print $2 "+" }' > /tmp/fichiers_partition_serveur	# par ligne : total valeur
#	perl -pi -e 's/ //g;' /tmp/fichiers_partition_serveur
#	taille_fichiers_partition_serveur=`cat /tmp/fichiers_partition_serveur`1-1
#	rm -f /tmp/fichiers_partition_serveur

# taille des fichiers de la partition serveur ET le serveur ne doit pas etre eteint
df -P | grep /mnt/partition_disque_$reponse | tail -n 1 | awk '{print $3}' > /tmp/fichiers_partition_serveur
taille_fichiers_partition_serveur=`cat /tmp/fichiers_partition_serveur`
rm -f /tmp/fichiers_partition_serveur

taille_fichiers_partition_serveur=$[$taille_fichiers_partition_serveur]
taille_fichiers_partition_serveur_mo=$[$taille_fichiers_partition_serveur/1024]
if [ "$taille_fichiers_partition_serveur" = "0" ]
then
	taille_fichiers_partition_serveur=10 # ne pas diviser par 0
fi

valeur_fin_rsync=0
pourcentage_rsync=0
test_valeur_fin_rsync=
while [ "$valeur_fin_rsync" != 1 ]
do
	sleep 4
	#	# taille des fichiers restaures sur la partition  : trop long ici
	#	ls -sR /mnt/$reponse | grep total | awk '{print $2 "+" }' > /tmp/fichiers_restaures_sur_partition	# par ligne : total valeur
	#	perl -pi -e 's/ //g;' /tmp/fichiers_restaures_sur_partition
	#	taille_fichiers_restaures_sur_partition=`cat /tmp/fichiers_restaures_sur_partition`1-1
	#	rm -f /tmp/fichiers_restaures_sur_partition
	#	taille_fichiers_restaures_sur_partition=$[$taille_fichiers_restaures_sur_partition]
	
	# taille des fichiers restaures sur la partition ET le serveur ne doit pas etre eteint
	df -P | grep /dev/$reponse | tail -n 1 | awk '{print $3}' > /tmp/fichiers_restaures_sur_partition
	taille_fichiers_restaures_sur_partition=`cat /tmp/fichiers_restaures_sur_partition`
	taille_fichiers_restaures_sur_partition=$[$taille_fichiers_restaures_sur_partition]
	rm -f /tmp/fichiers_restaures_sur_partition
	
	pourcentage_rsync=$[100*$taille_fichiers_restaures_sur_partition/$taille_fichiers_partition_serveur]

	if ( test -e /tmp/rapport_fin_rsync )
	then
		valeur_fin_rsync=1
		grep -ci "0" /tmp/rapport_fin_rsync > /tmp/valeur_fin_rsync	# OK fin de sauvegarde
		test_valeur_fin_rsync=`cat /tmp/valeur_fin_rsync`
		rm -f /tmp/rapport_fin_rsync
		rm -f /tmp/valeur_fin_rsync
		if ! [ "$test_valeur_fin_rsync" = "1" ]
		then
			if ! [ "$pourcentage_rsync" = "100" ]
			then
				echo "\n\033[1;31m  `cat $chemin_langue/ERREUR` : rsync ...\n" > /tmp/sortie_fin_rsync
				echo "" > /tmp/erreur_rsync
			else
				echo "\n\033[1;31m  restauration : 100% \n" > /tmp/sortie_fin_rsync
			fi
		else
			echo "\n\033[1;31m  restauration : 100% \n" > /tmp/sortie_fin_rsync
			pourcentage_rsync=100
		fi
	fi
	pourcentage_rsync=$[$pourcentage_rsync]
	echo $pourcentage_rsync
done | DIALOGRC="/etc/dialogmenu_bloque" dialog --colors\
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/Restauration` " \
	--gauge "\n\Zb\Z3  `cat $chemin_langue/texte_30b` \Z2$reponse \n \
	\n  \Zb\Z2`cat $chemin_langue/Taille` = $taille_fichiers_partition_serveur_mo Mo \n\n
	\n  `cat $chemin_langue/menu_74`\n\n  \Zb\Z2`cat $chemin_langue/Patience` ... " 14 90

echo -e "`cat /tmp/sortie_fin_rsync`"
rm -f /tmp/sortie_fin_rsync
if ( test -e /tmp/erreur_rsync )
then
	rm -f /tmp/erreur_rsync
	echo
	echo -e "  `cat $chemin_langue/boucle_2`"
	echo
	read p
	exit
fi
}
#----------------------------------------------------------------------------------------------------
#	Recherche d'une image
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
copie_partition_disque_eventuel()	# si demande par la procedure disque en nfs
{
if ! ( test -e /mnt/partition_disque_$reponse )
then
	mkdir /mnt/partition_disque_$reponse
fi

mount "$ip_serveur":/mnt/$reponse /mnt/partition_disque_$reponse 1>/dev/null 2>/dev/null

sleep 2
rm -f /tmp/rapport_fin_rsync
sleep 2
restaurer_avec_rsync &
# bargraphe_rsync
bargraphe_dialog_rsync

umount /mnt/partition_disque_$reponse
mv /mnt/$reponse/partition_disque_$reponse/* /mnt/$reponse 2>/dev/null
mv /mnt/$reponse/partition_disque_$reponse/.* /mnt/$reponse 2>/dev/null

rm -fr /mnt/$reponse/partition_disque_$reponse
if ( test -e /mnt/$reponse/etc/conf.d/hostname )
then
	grep -ci "OSCAR" /mnt/$reponse/etc/conf.d/hostname > /tmp/partition_oscar_existe_disque
	test_partition_oscar_existe_disque=`cat /tmp/partition_oscar_existe_disque`
	rm -f /tmp/partition_oscar_existe_disque
	if [ "$test_partition_oscar_existe_disque" = 1 ]
	then
		echo "" > /tmp/oui_partition_oscar_existe_disque
	fi
fi
}
#----------------------------------------------------------------------------------------------------		
formater_partitions()
{
# id_type=`sfdisk /dev/$disque -c $numero_hd 2>/dev/null`
grep -i $reponse /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
nb_partition_linux=`cat /tmp/nb_partition_linux`
rm -f /tmp/nb_partition_linux
if [ "$nb_partition_linux" = "1" ] # partition linux non swap
then # partition linux non swap
	grep -i $reponse /tmp/fichier_disque_dur | grep -ci reiserfs > /tmp/nb_partition_reiserfs
	nb_partition_reiserfs=`cat /tmp/nb_partition_reiserfs`
	rm -f /tmp/nb_partition_reiserfs
	if [ "$nb_partition_reiserfs" = "1" ] # partition linux reiserfs
	then
	#	grep -i "$reponse" /tmp/formatage_linux > /tmp/fslinux
	#	grep -ci "linux_reiserfs" /tmp/fslinux > /tmp/nb_fslinux
	#	valeur=`cat /tmp/nb_fslinux`
	#   	if [ "$valeur" = "1" ]
	#	then
		echo
		echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$reponse \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ReiserFS\033[1;m "
		echo
		if [ "$formatage" = "rapide" ]
		then
			mkfs.reiserfs -f /dev/$reponse 2>/dev/null
		else            # minutieux:
			mkfs.reiserfs -f /dev/$reponse       #   pour chekdisk
		fi
		if [ "$procedure_nfs_disque" = "oui" ]
		then
			mkdir /mnt/$reponse 2>/dev/null
			mount -t reiserfs /dev/$reponse /mnt/$reponse
			copie_partition_disque_eventuel
		fi
	else
		grep -i $reponse /tmp/fichier_disque_dur | grep -ci xfs > /tmp/nb_partition_xfs
		nb_partition_xfs=`cat /tmp/nb_partition_xfs`
		rm -f /tmp/nb_partition_xfs
		if [ "$nb_partition_xfs" = "1" ] # partition linux xfs
		then
		#grep -ci "linux_xfs" /tmp/fslinux > /tmp/nb_fslinux
		#valeur=`cat /tmp/nb_fslinux`
    		#if [ "$valeur" = "1" ]
	        #then
	        	echo
			echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$reponse \033[1;m`cat $chemin_langue/en` \033[0;32mLinux XFS\033[1;m "
			echo
			if [ "$formatage" = "rapide" ]
			then
				mkfs.xfs -f /dev/$reponse
			else            # minutieux:
				mkfs.xfs -f /dev/$reponse
			fi
			if [ "$procedure_nfs_disque" = "oui" ]
			then
				mkdir /mnt/$reponse 2>/dev/null
				mount -t xfs /dev/$reponse /mnt/$reponse
				copie_partition_disque_eventuel
			fi
		else
			grep -i $reponse /tmp/fichier_disque_dur | grep -ci jfs > /tmp/nb_partition_jfs
			nb_partition_jfs=`cat /tmp/nb_partition_jfs`
			rm -f /tmp/nb_partition_jfs
			if [ "$nb_partition_jfs" = "1" ] # partition linux jfs
			then
			#grep -ci "linux_jfs" /tmp/fslinux > /tmp/nb_fslinux
			#valeur=`cat /tmp/nb_fslinux`
    			#if [ "$valeur" = "1" ]
	        	#then
				echo
				echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$reponse \033[1;m`cat $chemin_langue/en` \033[0;32mLinux JFS\033[1;m "
				echo
				if [ "$formatage" = "rapide" ]
				then
					mkfs.jfs -q /dev/$reponse
				else            # minutieux:
					mkfs.jfs -qc /dev/$reponse
				fi
				if [ "$procedure_nfs_disque" = "oui" ]
				then
					mkdir /mnt/$reponse 2>/dev/null
					mount -t jfs /dev/$reponse /mnt/$reponse
					copie_partition_disque_eventuel
				fi
			else
				grep -i $reponse /tmp/fichier_disque_dur | grep -ci ext4 > /tmp/nb_partition_ext4
				nb_partition_ext4=`cat /tmp/nb_partition_ext4`
				rm -f /tmp/nb_partition_ext4
				if [ "$nb_partition_ext4" = "1" ] # partition linux ext4
				then
				#grep -ci "ext4" /tmp/fslinux > /tmp/nb_fslinux
				#valeur=`cat /tmp/nb_fslinux`
				#if [ "$valeur" = "1" ]
				#then
					echo
	            			echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$reponse \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ext4\033[1;m "
					echo
			                if [ "$formatage" = "rapide" ]
	    			        then
						mkfs.ext4 -Fq /dev/$reponse
						test_format=$?
						tester_montage_linux
		            		else            # minutieux:
						mkfs.ext4 -cvF /dev/$reponse #   pour chekdisk
						test_format=$?
						tester_montage_linux
					fi
					if [ "$procedure_nfs_disque" = "oui" ]
					then
						mkdir /mnt/$reponse 2>/dev/null
						mount /dev/$reponse /mnt/$reponse
						copie_partition_disque_eventuel
					fi
				else
					grep -i $reponse /tmp/fichier_disque_dur | grep -ci reiser4 > /tmp/nb_partition_reiser4
					nb_partition_reiser4=`cat /tmp/nb_partition_reiser4`
					rm -f /tmp/nb_partition_reiser4
					if [ "$nb_partition_reiser4" = "1" ] # partition linux reiser4
					then
					#grep -i "$reponse" /tmp/formatage_linux > /tmp/fslinux
				        #grep -ci "linux_reiser4" /tmp/fslinux > /tmp/nb_fslinux
					#valeur=`cat /tmp/nb_fslinux`
			    		#if [ "$valeur" = "1" ]
				        #then
						echo
						echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$reponse \033[1;m`cat $chemin_langue/en` \033[0;32mLinux Reiser4\033[1;m "
						echo
						if [ "$formatage" = "rapide" ]
						then
							mkfs.reiser4 -f /dev/$reponse 2>/dev/null
						else            # minutieux:
							mkfs.reiser4 -f /dev/$reponse       #   pour chekdisk
						fi
						if [ "$procedure_nfs_disque" = "oui" ]
						then
							mkdir /mnt/$reponse 2>/dev/null
							mount -t reiser4 /dev/$reponse /mnt/$reponse
							copie_partition_disque_eventuel
						fi
					else	# linux_ext2
						grep -i $reponse /tmp/fichier_disque_dur | grep -ci ext2 > /tmp/nb_partition_ext2
						nb_partition_ext2=`cat /tmp/nb_partition_ext2`
						rm -f /tmp/nb_partition_ext2
						if [ "$nb_partition_ext2" = "1" ] # partition linux ext2
						then
						#grep -ci "ext2" /tmp/fslinux > /tmp/nb_fslinux
						#valeur=`cat /tmp/nb_fslinux`
						#if [ "$valeur" = "1" ]
						#then
								echo
								echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$reponse \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ext2\033[1;m "
								echo
								if [ "$formatage" = "rapide" ]
								then
									mkfs.ext2 -qF /dev/$reponse
									test_format=$?
									tester_montage_linux
								else            # minutieux:
									mkfs.ext2 -cvF /dev/$reponse #   pour chekdisk
									test_format=$?
									tester_montage_linux
								fi
								if [ "$procedure_nfs_disque" = "oui" ]
								then
									mkdir /mnt/$reponse 2>/dev/null
									mount /dev/$reponse /mnt/$reponse
									copie_partition_disque_eventuel
								fi

						else	# autres cas en ext3
							echo
							echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$reponse \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ext3\033[1;m "
							echo
							if [ "$formatage" = "rapide" ]
							then
								mkfs.ext3 -qF /dev/$reponse
								test_format=$?
								tester_montage_linux
							else            # minutieux:
								mkfs.ext3 -cvF /dev/$reponse #   pour chekdisk
								test_format=$?
								tester_montage_linux
							fi
							if [ "$procedure_nfs_disque" = "oui" ]
							then
								mkdir /mnt/$reponse 2>/dev/null
								mount /dev/$reponse /mnt/$reponse
								copie_partition_disque_eventuel
							fi
						fi # autres et ext3
					fi # ext2
				fi #reiser4
			fi # ext4
		fi #jfs
	fi #xfs
	# rm -f /tmp/fslinux
	# rm -f /tmp/nb_fslinux
else
	grep -i $reponse /tmp/fichier_disque_dur | grep -ci swap > /tmp/nb_partition_swap
	nb_partition_swap=`cat /tmp/nb_partition_swap`
	rm -f /tmp/nb_partition_swap
	if [ "$nb_partition_swap" = "1" ] # partition swap linux
	then  # partition linux swap
		echo
		echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$reponse \033[1;m`cat $chemin_langue/en` \033[0;32mLinux swap\033[1;m "
		echo
		if [ "$formatage" = "rapide" ]
		then
		    	mkfs.ext3 -qF /dev/$reponse
		    	test_format=$?
			tester_montage_linux
		else		# minutieux:
			mkfs.ext3 -cvF /dev/$reponse	#   pour chekdisk
			test_format=$?
			tester_montage_linux
		fi
		mkswap -f /dev/$reponse 1>/dev/null
	else
		grep -i $reponse /tmp/fichier_disque_dur | grep -ci ntfs > /tmp/nb_partition_ntfs
		nb_partition_ntfs=`cat /tmp/nb_partition_ntfs`
		rm -f /tmp/nb_partition_ntfs
		if [ "$nb_partition_ntfs" = "1" ] # partition ntfs
		then
			echo
			echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$reponse \033[1;m`cat $chemin_langue/en` \033[0;32mNTFS\033[1;m "
			echo
			echo -e "`cat $chemin_langue/texte_6`"
			echo
			if [ "$formatage" = "rapide" ]
			then
				mkntfs -f /dev/$reponse 1>/dev/null
				fsck /dev/$reponse -N 2>/tmp/ntfs_valide 1>/dev/null
				grep -ci ntfs /tmp/ntfs_valide > /tmp/nb_ntfs_valide
				nb_ntfs_valide=`cat /tmp/nb_ntfs_valide`
				rm -f /tmp/nb_ntfs_valide
				rm -f /tmp/ntfs_valide
				if [ "$nb_ntfs_valide" = 0 ]
				then
					echo
					echo -e " \033[1;33mOSCAR \033[1;34mcorrige la partition \033[1;32m$repertoire ntfs \033[1;34m:"
					echo
					mkfs.ext4 -qF /dev/$reponse
					mkntfs -f /dev/$reponse
				fi
			else		# minutieux:
				mkntfs /dev/$reponse
			fi
			if [ "$procedure_nfs_disque" = "oui" ]
			then
				mkdir /mnt/$reponse 2>/dev/null
				echo "ntfs" > /tmp/besoin_type
				echo "$reponse" > /tmp/monter_partition
				runme autoriser_monter_partition_oscar
				rm -f /tmp/monter_partition
				rm -f /tmp/besoin_type
				copie_partition_disque_eventuel
			fi
		fi
	fi
fi
}
#----------------------------------------------------------------------------------------------------
formater_vfat()
{
echo
echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$reponse \033[1;m`cat $chemin_langue/en` \033[0;32mFat32\033[1;m "
echo
if [ "$formatage" = "rapide" ]
then
	mkdosfs -vF 32 /dev/$reponse 1>/dev/null
else		# minutieux:
	mkdosfs -cvF 32 /dev/$reponse	#   pour chekdisk
fi
if [ "$procedure_nfs_disque" = "oui" ]
then
	mkdir /mnt/$reponse 2>/dev/null
	mount /dev/$reponse /mnt/$reponse
	copie_partition_disque_eventuel
fi
}
#----------------------------------------------------------------------------------------------------
boucle_partition() # sortir la partition dans la reponse pour la formater
{
rm -f /tmp/tempfile
echo "$type" > /tmp/tempfile
runme prepare_boucle_partition
nombretype=`cat /tmp/nombre`
rm -f /tmp/nombre

numero=0
cp -f /tmp/tempfile /tmp/temp_ligne_deux_points
rm -f /tmp/tempfile
until  ( test  $numero = $nombretype )
    do
	rm -f /tmp/temp_ligne_deux_points1
#	rm -f /tmp/partfile1
	numero=$[$numero+1]
	cut -d":" -f$numero /tmp/temp_ligne_deux_points > /tmp/temp_ligne_deux_points1	#hdaiii
#	cut -d":" -f$numero /tmp/partfile > /tmp/partfile1	#ide/h0/b0/t0/l0/hdaiii
	reponse=`cat /tmp/temp_ligne_deux_points1`
	reparti=$reponse
	rm -f /tmp/temp_ligne_deux_points1
	if ! [ "$reponse" = "" ] # si la partition existe
	then
		numero_hd=`expr substr $reponse 4 3`
		disque=`expr substr $reponse 1 3`       #hda
#		disque=`cut -d/ -f1-5 /tmp/partfile1`/disc	#ide/h0/b0/t0/l0/disc
#		rm -f /tmp/partfile1
		if ! ( test -e disque_maitre )
		then
			formater_partitions
		else	# sp externe formater $disque_table
			if [ "$disque" = "$disque_table" ]
			then
				formater_partitions	# du disque demande $disque_table
			fi
		fi
	fi
#	rm -f /tmp/partfile1
    done
rm -f /tmp/tempfile
}
#----------------------------------------------------------------------------------------------------
tester_montage_linux()
{
if [ "$test_format" != 0 ]
then
	test_format_linux=non
else
	mkdir /mnt/$reponse 2>/dev/null
	mount /dev/$reponse /mnt/$reponse 2>/dev/null
	if [ $? != 0 ]
	then
		test_format_linux=non
	else
		echo "essai_montage" > /mnt/$reponse/essai_montage_linux  2>/dev/null
		if ! ( test -e /mnt/$reponse/essai_montage_linux )
		then
			test_format_linux=non
		else
			rm -f /mnt/$reponse/essai_montage_linux
		fi
	fi
	umount /mnt/$reponse 2>/dev/null ; sync
fi
}
#----------------------------------------------------------------------------------------------------
verifier_formatage_linux()
{
if [ "$test_format_linux" = non ]
then
	faire_table_et_mbr
fi
}
#-----------------------------------------------------------------------------------------------------
cherche_valeurs_disque_ancien()
{
# fdisk -lu /dev/$evms_oscar$hd_boot 2>/dev/null | grep -i "^Disk \/dev\/" | grep -v "dev\/dm-" | \
# cut -d"," -f2 | cut -d" " -f2 > /tmp/taille_disque_octet
echo "$evms_oscar$hd_boot" > /tmp/calcul_taille_partition_disque
runme calcul_taille_partition_MB
taille_disque_octet=`cat /tmp/calcul_taille_partition_disque`
rm -f /tmp/calcul_taille_partition_disque
taille_maxi_Mega=$[$taille_disque_octet/1000000]
# taille_disque_octet=$[$taille_disque_octet * 1000000 / 1048576 ] # 1048576 
rm -f /tmp/taille_disque_octet
taille_maxi_Mega=$[$taille_maxi_Mega-2]
}
#-----------------------------------------------------------------------------------------------------
nettoyer_disque_a_formater()
{
echo
echo -e " --> `cat $chemin_langue/patience_1` \033[1;m "
echo
# supprimer toutes les partitions :
for x in 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1
do
	parted /dev/$evms_oscar$hd_boot rm $x 2>/dev/null 1>/dev/null
done
sleep 2
#	# formater le disque complet en ext4 et rapide
#	cherche_valeurs_disque_ancien
#	parted /dev/$evms_oscar$hd_boot mkpart primary ext4 0 $taille_maxi_Mega -a cylinder  1>/dev/null
#	sleep 4
#	# tempo obligatoire avant le formatage
#	mkfs.ext4 -vF /dev/$evms_oscar$hd_boot"1" 1>/dev/null 2>/dev/null
#	echo
}
#-----------------------------------------------------------------------------------------------------
formater_disque() 
{
echo
echo -e " \033[1;32m`cat $chemin_langue/texte_17` :\033[1;m"
echo
sleep 2 # obligatoire apr√®s l'installation de la table des partitions

# formater les partitions vfat en fat32:
if ( test -e /tmp/ligne_partitions_vfat_gpt )
then
	ligne_partitions_vfat=`cat /tmp/ligne_partitions_vfat_gpt`
	rm -f /tmp/ligne_partitions_vfat_gpt
else
	blkid -n /dev/$disque | grep vfat | perl -pi -e 's/\/dev\///g;' | cut -d":" -f1 > /tmp/partitions_vfat
	# prendre la premiere colonne :
	`awk '{print$1}' /tmp/partitions_vfat`
	rm -f /tmp/partitions_vfat
fi
for reponse in $ligne_partitions_vfat
do
	formater_vfat
done

# formater les partitions linux:
type="linux"
test_format_linux=oui
echo "" > /tmp/client_boucle_parted
boucle_partition
verifier_formatage_linux

# formater la partition swap :
type="swap"
test_format_linux=oui
echo "" > /tmp/client_boucle_parted
boucle_partition
verifier_formatage_linux

# formater les partitions ntfs:
type="ntfs"
echo "" > /tmp/client_boucle_parted
boucle_partition

rm -f /tmp/client_boucle_parted
rm -f /tmp/fichier_disque_dur_serveur
sleep 2 # obligatoire apr√®s le formatage
rm -f /tmp/formatage_linux
}
#-----------------------------------------------------------------------------------------------------
faire_table_et_mbr()
{
nettoyer_disque_a_formater
# sfdisk -f /dev/$evms_oscar$hd_boot < table_partitions.sf 2>/dev/null	# il est oblogatoire apr√®s d'attendre 7 secondes pour continuer
echo "$evms_oscar$hd_boot" > /tmp/disque_installer_table_sf
cp -f table_partitions.sf /tmp/fichier_installer_table_sf
runme installer_table_partition_sf
sleep 2 # obligatoire apr√®s l'installation de la table des partitions
disque=$evms_oscar$hd_boot
formater_disque

dd if=table_partitions.mbr of=/dev/$evms_oscar$hd_boot 2>/dev/null
sleep 2 # obligatoire apr√®s le mbr
}
#-----------------------------------------------------------------------------------------------------
recevoir_tables_partitions() # recevoir en synchrone des tables de partitions des disques hd et sd du serveur √† cloner
{
echo -e "\033[1;34m Poste : \033[1;31m$poste"
echo
echo -e "`cat $chemin_langue/texte_18`"
echo "eteindre_le_poste" > /tmp/tempofile
rm -f fichiers_depart_recept
echo
udp-receiver -f fichiers_depart_recept --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
clear
echo
echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	if [ "$menuoscar_clone" = "oui" ]
	then
		if ( test -e /etc/demarrage_usb )	# demarrage usb
		then
			echo
			echo -e "\033[1;32m `cat $chemin_langue/menu_292b` ..."
			echo
		fi
	fi
echo
echo -e " ..."
	
	rm -f ctrl_serveur
	cut -f1 -d"," fichiers_depart_recept > ctrl_serveur
	commande_serveur=`cat ctrl_serveur`
	if ! [ "$commande_serveur" = "serveur_clone" ]
	then 
		rm -f ctrl_client
		echo "client_clone" > ctrl_client
		boite_erreur_client_synchrone
		rm -f fichiers_depart_recept
		exit
	fi
	rm -f ctrl_serveur
	
	rm -f formatage_disques
	cut -f2 -d"," fichiers_depart_recept > formatage_disques
	formatage=`cat formatage_disques`
	rm -f formatage_disques

	cut -f3 -d"," fichiers_depart_recept > /tmp/disque_boot_et_grub # ce fichier contient sda
	hd_boot=`cat /tmp/disque_boot_et_grub`		# sda
	echo "$hd_boot" > /tmp/disque_client

	mise_en_reseau_asynchrone

	cut -f4 -d"," fichiers_depart_recept > version_oscar_envoyee
	
	version_oscar_envoyee=`cat version_oscar_envoyee`
	version_oscar=`cat /usr/share/oscar/usr/numero_version_oscar`
	if ! [ "$version_oscar_envoyee" = "$version_oscar" ]
	then
		echo "mauvais_$poste" >> /mnt/serveur_nfs/erreur_numero_version
	else
		echo "bon_$poste" >> /mnt/serveur_nfs/erreur_numero_version
	fi

	rm -f /tmp/test_version
	echo -en "\033[1;31m"
	udp-receiver -f /tmp/test_version --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
	clear
	echo
	echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	echo
	echo -e " ..."
	echo
	rm -f /tmp/test_version
	if ! [ "$version_oscar_envoyee" = "$version_oscar" ]
	then
		controle_version_oscar
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
			umount /mnt/serveur_nfs 2>/dev/null ; sync
			umount /mnt/serveur_oscar 2>/dev/null ; sync
			umount /mnt/serveur_partage 2>/dev/null ; sync
			exit
		fi
	fi
	
	rm -f /tmp/valeur_vitesse
	echo -en "\033[1;31m"
	udp-receiver -f /tmp/valeur_vitesse --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
	clear
	echo
	echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	echo
	echo -e " ..."
	echo
	cut -d"," -f1 /tmp/valeur_vitesse > /tmp/resultat_temp1
	resultat_test=`cat /tmp/resultat_temp1`
	rm -f /tmp/resultat_temp1
	vitesse_bande_largeur
	
	rm -f /tmp/valeur_vitesse
	if [ "$resultat_test" = "eteindre" ]
	then
		umount /mnt/serveur_nfs 2>/dev/null ; sync
		umount /mnt/serveur_oscar 2>/dev/null ; sync
		umount /mnt/serveur_partage 2>/dev/null ; sync
		rm -f /tmp/ip_mcast_rdv
		rm -f /tmp/ip_mcast_rdv
		runme eteindre_le_poste
	fi
	
	cut -f5 -d"," fichiers_depart_recept > /tmp/taille_disque_envoye
##################
	if ( test -e /dev/evms/$hd_boot )
	then
	    evms_oscar="evms/"
	else
	    evms_oscar=
	fi
##################
	controler_taille_disque_client
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		exit
	fi

rm -f fichiers_depart_recept

	rm -f table_partitions.mbr
	echo
	udp-receiver -f table_partitions.mbr --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
	clear
	echo
	echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	echo
	echo -e " ..."
	rm -f table_partitions.sf
	echo
	udp-receiver -f table_partitions.sf --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
	clear
	echo
	echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	echo
	echo -e " ..."
	rm -f /tmp/fichier_disque_dur_serveur
	echo
	udp-receiver -f /tmp/fichier_disque_dur_serveur --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
	clear
	echo
	echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	echo
	echo -e " ..."
	rm -f /tmp/formatage_linux
	echo
	udp-receiver -f /tmp/formatage_linux --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
	clear
	echo
	echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	echo
	echo -e " ..."
	
#  danger!!! ici tue le poste:
	# $hd_boot: sda

faire_table_et_mbr
}
#----------------------------------------------------------------------------------------------------
eteindre_ordinateur() 
{
rm -f /tmp/client_en_reseau
if ( test -e /tmp/differe )
then
	rm -f /tmp/differe
	if ( test -e /mnt/serveur_nfs/client_pxe )
	then
		# indiquer au serveur pxe que le poste va s'eteindre :
		echo "perl -pi -e 's/$poste//g;' /mnt/serveur_nfs/client_pxe" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
	fi
fi

# indiquer au serveur clone que le poste va s'eteindre :
rm -f /mnt/serveur_oscar/var_poste/postes_clients/$poste

# enleve les doublons du fichier $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol
if ( test -e /tmp/nom_salle )
then
	if ( test -e $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol )
	then
		cp -f $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol /tmp/temp_doublons_a_supprimer
		enlever_les_doublons
		if ( test -e /tmp/doublons_supprimes )
		then
			cp -f /tmp/doublons_supprimes $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol
		fi
		rm -f /tmp/doublons_supprimes
		rm -f /tmp/nom_salle
	fi
fi
# indiquer au serveur clone que le poste va s'eteindre :
echo "perl -pi -e 's/$poste//g;' /mnt/serveur_nfs/client_pxe" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom

umount /mnt/serveur_nfs 2>/dev/null ; sync
umount /mnt/serveur_oscar 2>/dev/null ; sync
umount /mnt/serveur_partage 2>/dev/null ; sync
rm -fR /tmp/temp_var_salle
rm -f /tmp/ip_mcast_rdv
umount $partition_ecrire_oscar 2>/dev/null  ; sync
umount $image_serveur 2>/dev/null  ; sync
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/infobox_1` " \
	--infobox "\n`cat /tmp/fichiertemp`\n" 9 $largeur_info
	
rm -f /tmp/fichiertemp
for passe in 10 9 8 7 6 5 4 3 2 1 STOP
do
    sleep 1
    echo -en "\033[1;31m  > $passe\033[1;m"
done
/etc/init.d/nfs stop
if ( test -e /etc/cdrom_ejecte )
then
	eject -t
fi
if [ "$reboot_clients" = "oui_reboot" ]
then
	reboot
else
	halt
fi
sleep 10
exit
}
#----------------------------------------------------------------------------------------------------
nettoyer_tmp()
{
 	rm -f partition_oscar
	rm -f oscar.bat
	rm -f oscar_modifstartup_nom.reg
	rm -f oscar_nettoie_numero_poste.reg
	rm -f fin_numero_poste_oscar.reg
	rm -f fin_numero_poste_oscar.bat
	rm -f /tmp/delay.vbs
	rm -f partition_linux_sauvegarde
	rm -f /tmp/partition_oscar_lettre_win
	rm -f /tmp/nom_oscar_poste
        rm -f /tmp/cherche_oscar.bat
        rm -f /tmp/cherche_oscar_modifstartup_nom.reg
        rm -f /tmp/fin_cherche_oscar_modifstartup_nom.reg
        rm -f /tmp/netsh_oscar_bat
        rm -f oscar_modifstartup_ip.reg
	rm -f /tmp/ip_oscar_bat
	rm -fr $image_serveur/cd_oscar
	rm -f md5sum_oscar
	rm -f recept_md5sum_oscar
	rm -f /tmp/partition_oscar_client
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
installation_eventuelle_cdOSCAR()
{
umount /mnt/$base 2>/dev/null ; sync
if [ "$oscar_dd" = "oui" ]
then
	## d√©compresser fichiers oscar_seul
	echo "$image_serveur" > /tmp/partition_oscar_image
	echo "$taille_fichiers_oscar" > /tmp/sp_taille_fichiers_oscar
	fichiers_oscar_clients sp_decompresser_fichiers_oscar
	
	#### pr√©parer lilo.conf:
	fichiers_oscar_clients
	
	#### fin de pr√©parer lilo.conf

	# installe_oscar_dd pour installer_fichiers_oscar et grub :
	echo "$image_serveur" > /tmp/tempfile # /mnt/sda2
	perl -pi -e 's/\/mnt\///g;' /tmp/tempfile # sda2
	repertoire_oscar=`cat /tmp/tempfile`
	rm -f /tmp/tempfile
	echo "$repertoire_oscar" > /tmp/partition_oscar_client
	echo "" > /tmp/client_lance
	echo "" > /tmp/repare_boot_dd

	installe_oscar_dd	# ici pour client clone
	
	partition_serveur=$partition_linux	# car d√©mont√© par installe_oscar_dd
	echo "$partition_linux" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	image_serveur=`cat /tmp/monter_partition`
	rm -f /tmp/monter_partition
	
	### installer les nouveaux fichiers oscar:
	#cp -f $image_serveur/etc/date_oscar $image_serveur/oscar/date_oscar
	
	fichiers_oscar_clients fichiers_apres_installe_oscar_dd

	if ( test -e /tmp/temp_var_salle )
	then
		if ! ( test -e $image_serveur/usr/share/oscar/var_salle )
		then
			mkdir $image_serveur/usr/share/oscar/var_salle
		fi
		cp -fr /tmp/temp_var_salle/* $image_serveur/usr/share/oscar/var_salle/
		rm -fR /tmp/temp_var_salle
	fi
	
	rm -f /tmp/disque_boot_et_grub
	rm -fr $image_serveur/cd_oscar
	rm -f /tmp/disque_boot_et_grub
	rm -f /tmp/partition_oscar_image
fi  ### fin d'installation √©ventuelle du cd OSCAR
}
#-----------------------------------------------------------------------------------------------------
controler_taille_disque_client()
{
	taille_disque_envoye=`cat /tmp/taille_disque_envoye`
	rm -f /tmp/taille_disque_envoye

# taille du disque a installer:

# sfdisk -s > /tmp/les_disques 2>/dev/null
# echo "grep -i \"`cat /tmp/disque_client`\" /tmp/les_disques > /tmp/les_disques1" > /tmp/exec_nom
# chmod +x /tmp/exec_nom
# /tmp/exec_nom
# perl -pi -e 's/ //g;' /tmp/les_disques1
# cut -d":" -f2 /tmp/les_disques1 > /tmp/taille_disque_installe
cp -f /tmp/disque_client /tmp/calcul_taille_partition_disque
runme calcul_taille_partition_MB
cp -f /tmp/calcul_taille_partition_disque /tmp/taille_disque_installe
rm -f /tmp/calcul_taille_partition_disque

taille_disque_poste=`cat /tmp/taille_disque_installe`
rm -f /tmp/taille_disque_installe
rm -f /tmp/les_disques
rm -f /tmp/les_disques1

# comparer les tailles des disques
	# taille_arrondie_poste=$[$taille_disque_poste/1024+2]
	# taille_arrrondie_disque_envoye=$[$taille_disque_envoye/1024]
	taille_arrondie_poste=$[$taille_disque_poste/1000+100]
	taille_arrrondie_disque_envoye=$[$taille_disque_envoye/1000]
	test_taille=$[$taille_arrondie_poste-$taille_arrrondie_disque_envoye]
	signe_negatif=`expr substr $test_taille 1 1`

	if [ "$signe_negatif" = "-" ]
	then
		#	Copier tout de m√™me
		dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/menu_168` " --ok-label "`cat $chemin_langue/Annuler`" --cancel-label "`cat $chemin_langue/menu_169`" \
		--menu "\n\n`cat $chemin_langue/menu_170` \Z3`cat /tmp/disque_client` " 10 68 0 \
		"" "`cat $chemin_langue/menu_171`"
		case $? in
		    0)  echo "" > /tmp/sortir
		    	;;
		    1) 	;;
		    255) echo "" > /tmp/sortir
		    	;;
		esac
	fi

rm -f /tmp/disque_client
}
#-----------------------------------------------------------------------------------------------------
erreur_reseau()
{
umount /mnt/serveur_nfs 2>/dev/null ; sync
umount /mnt/serveur_oscar 2>/dev/null ; sync
umount /mnt/serveur_partage 2>/dev/null ; sync
variable_runme=`cat /tmp/tempofile`
clear
echo
echo -e " ..."
rm -f /tmp/tempofile
}
#-----------------------------------------------------------------------------------------------------
montage_nfs_avec_controle()
{
# /etc/init.d/nfs restart 1>/dev/null 2>/dev/null
mount "$ip_serveur":$chemin_oscar /mnt/serveur_oscar 1>/dev/null 2>/dev/null	# serveur_oscar est le repertoire oscar du serveur
sleep 4

grep -ci "/mnt/serveur_oscar" /etc/mtab > /tmp/test_deja_monte_nfs
test_deja_monte_nfs=`cat /tmp/test_deja_monte_nfs`
rm -f /tmp/test_deja_monte_nfs
if [ "$test_deja_monte_nfs" = "0" ]
then
	montage_nfs_avec_controle
	return
	#	echo
	#	echo -e "\033[1;31m  `cat $chemin_langue/menu_665a`"
	#	echo
	#	echo -e "  `cat $chemin_langue/boucle_2`"
	#	read p
	#	exit
else
	return
fi
}
#-----------------------------------------------------------------------------------------------------
lancer_client_nfs()
{
# deja fait dans avahi
/etc/init.d/nfs restart 1>/dev/null 2>/dev/null
tftpboot_partage=`cat /tmp/partage_tftpboot_serveur 2>/dev/null`
test_reseau_nfs=$?	# /tmp/partage_tftpboot_serveur n'existe pas
if [ "$test_reseau_nfs" != 0 ]
then
	echo
	echo -e "\033[1;31m  `cat $chemin_langue/menu_665a`"
	echo
	if ! ( test -e /etc/avahi/oscar_avahi )
	then
		echo -e " `cat $chemin_langue/boucle_2`"
		read p
	fi
	lancer_avahi client
	return
fi
rm -f /tmp/partage_tftpboot_serveur

##	avec chemin_oscar = /mnt/sdai/oscar si serveur d√©marr√© par cdrom ou /oscar si serveur d√©marr√© par disque dur
montage_nfs_avec_controle
}
#-----------------------------------------------------------------------------------------------------
mise_en_reseau_asynchrone()	# fait une seule fois
{
# mise en rÈseau nfs :
# montage linux   monter un rÈpertoire oscar distant avec le protocole de linux

	if ! ( test -e /mnt/serveur_oscar )
	then
		mkdir /mnt/serveur_oscar
	fi
	if ! ( test -e /mnt/serveur_nfs )
	then
		mkdir /mnt/serveur_nfs
	fi
	#	echo
	#	echo -e "`cat $chemin_langue/texte_21` \033[1;32m$ip_serveur:$chemin_oscar \033[1;34m... \033[1;m"
	#	echo
	
	lancer_client_nfs
	
	mount "$ip_serveur":$tftpboot_partage /mnt/serveur_nfs 1>/dev/null 2>/dev/null	# serveur_oscar est le repertoire oscar du serveur
	sleep 4
	
	# essai oK si demarrage cdrom :
	# si ici mount "$ip_serveur":/livemnt/memory /mnt/serveur_nfs 1>/dev/null 2>/dev/null
	# si sur le serveur /tftpboot *(fsid=0,rw,sync,no_subtree_check,all_squash,insecure) dans /etc/exports
	# ET sur le serveur_clone 1182 /livemnt/memory *(fsid=0,rw,sync,no_root_squash) dans /etc/exports
	# sera ecrit sur le serveur dans /livemnt/tftpmem
	# et sur le serveur dans /tftpboot/
	#
	# mieux si demarrage cdrom :
	# sur le serveur /tftpboot *(fsid=0,rw,sync,no_subtree_check,all_squash,insecure) dans /etc/exports
	# sur le serveur /livemnt/memory *(fsid=0,rw,sync,no_subtree_check) dans /etc/exports
	# sur le serveur creer /livemnt/memory/tmp_oscar_nfs
	# sur le serveur creer /tftpboot/tmp_oscar_nfs
	# sur le client mount "$ip_serveur":/tftpboot /mnt/serveur_nfs 1>/dev/null 2>/dev/null
	# cp -fr rep /mnt/serveur_nfs/tmp_oscar_nfs/ sera sur le serveur dans /livemnt/memory/tmp_oscar_nfs
	#
	# si demarrage poste creer /tftpboot/tmp_oscar_nfs a partager
	
	
	
	echo -e "\033[1;34m       `cat $chemin_langue/texte_19`\033[1;32m $poste \033[1;34m`cat $chemin_langue/texte_20`\033[1;m"
	echo	
	echo "/mnt/serveur_oscar : mont√© r√©seau linux" >> /tmp/historique

	# indiquer au serveur_pxe poste en fonctionnement
	echo "$poste" >> /mnt/serveur_nfs/client_pxe
	# ajouter la mac adresse au serveur
	cut -f1 -d";" /mnt/serveur_oscar/var_poste/salle_clients > /tmp/nom_salle
	if ( test -e /mnt/serveur_oscar/var_poste/`cat /tmp/nom_salle`.wol )
	then	# supprimer la mac adresse si existe
		grep -v "`cat /tmp/mac_adresse`" /mnt/serveur_oscar/var_poste/`cat /tmp/nom_salle`.wol > /tmp/temp_nom_salle
		cp -f /tmp/temp_nom_salle /mnt/serveur_oscar/var_poste/`cat /tmp/nom_salle`.wol
		rm -f /tmp/temp_nom_salle
	fi
	echo "`cat /tmp/mac_adresse`,poste=$poste" >> /mnt/serveur_oscar/var_poste/`cat /tmp/nom_salle`.wol
}
#-----------------------------------------------------------------------------------------------------
recevoir_fichier_mac()
{
	# lignes suivantes impossibles en clone :
	#	if ( test -e $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol )
	#	then
	#		cp -f $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol.bak
	#	fi
	#	if ! ( test -e $image_serveur/usr/share/oscar/var_salle )
	#	then
	#		mkdir $image_serveur/usr/share/oscar/var_salle
	#	fi
	#	cp -f /mnt/serveur_oscar/var_poste/`cat /tmp/nom_salle`.wol  $image_serveur/usr/share/oscar/var_salle/`cat /tmp/nom_salle`.wol
	rm -fR /tmp/temp_var_salle
	mkdir /tmp/temp_var_salle
	cp -f /mnt/serveur_oscar/var_poste/`cat /tmp/nom_salle`.wol /tmp/temp_var_salle/
}
#-----------------------------------------------------------------------------------------------------
controle_fichier_image()
{
	echo
	echo -e " \033[1;32m`cat $chemin_langue/texte_74` ... "
	echo
	image=`cat fichier_image_recept`
	md5sum $image_serveur/oscar/$image > /tmp/md5sum_fichier_image
	echo
	rm -f /tmp/controle_md5sum_serveur
	udp-receiver -f /tmp/controle_md5sum_serveur --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
	clear
	echo
	echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	echo
	echo -e " ..."
	echo
	cut -d" " -f1 /tmp/controle_md5sum_serveur > /tmp/md5sum_serveur
	md5sum_serveur=`cat /tmp/md5sum_serveur`
	rm -f /tmp/md5sum_serveur
	cut -d" " -f1 /tmp/md5sum_fichier_image > /tmp/md5sum_image
	md5sum_image=`cat /tmp/md5sum_image`
	rm -f /tmp/md5sum_image
	## ne pas autoriser le serveur a s'eteindre :
	if ! ( test -e /tmp/client_en_reseau )
	then
		echo "" > /tmp/client_en_reseau
		echo "$poste" > /mnt/serveur_oscar/var_poste/postes_clients/$poste
	fi
	if [ "$md5sum_serveur" != "$md5sum_image" ]
	then
		if ! ( test -e /tmp/erreur_md5sum )
		then
			echo "$poste" > /mnt/serveur_oscar/var_poste/postes_defectueux/$poste
		fi
		echo "erreur_md5sum" > /tmp/erreur_md5sum
		
		# Erreur du fichier re√ßu
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/infobox_7` " \
		--infobox "\n`cat $chemin_langue/infobox_8`" 8 50
		sleep 2
	fi
	rm -f /tmp/md5sum_fichier_image
	rm -f /tmp/controle_md5sum_serveur
}
#-----------------------------------------------------------------------------------------------------
fin_apres_sysprep()
{
	### installation √©ventuelle du cd OSCAR
	installation_eventuelle_cdOSCAR
	nettoyer_tmp
	rm -fr $image_serveur/cd_oscar
	rm -f partition_linux_sauvegarde
	poste=`cat $image_serveur/oscar/var_poste/numero_poste_client`
	echo "\Zb\Z2       `cat $chemin_langue/texte_19` \Z4$poste `cat $chemin_langue/infobox_9`\n
	\n`cat $chemin_langue/infobox_2`" > /tmp/fichiertemp
	largeur_info=60
	eteindre_ordinateur
}
#-----------------------------------------------------------------------------------------------------
vitesse_bande_largeur()
{
cut -d"," -f2 /tmp/valeur_vitesse > /tmp/bande_largeur
rm -f /tmp/valeur_vitesse
bande_largeur=`cat /tmp/bande_largeur`
rm -f /tmp/bande_largeur
grep -i "right (" /usr/share/oscar/bin/choix_largeur_bande > /tmp/bande_largeur1
perl -pi -e 's/##//g; s/ //g;' /tmp/bande_largeur1
bande_largeur1=`cat /tmp/bande_largeur1`
rm -f /tmp/bande_largeur1
bande_largeur_=`expr substr $bande_largeur1 17 1`
bande_largeur1=
rm -f /tmp/bande_verif
if ! ( test -e /etc/avahi/oscar_avahi )
then
	# if [ "$bande_largeur" = "bande_largeur_" ]
	if [ "$bande_largeur" = "$bande_largeur_" ]
	then
		bande_largeur_=
		erreur_reseau
		runme $variable_runme
	fi
else
	rm -f /tmp/tempofile
fi
bande_largeur_=
}
#---------------------------------------------------------------------------------------------------
afficher_ligne_images_oscar()
{
echo -e "`cat $chemin_langue/texte_6`"
echo
echo -e "\033[1;m ( `cat $chemin_langue/Taille` = $taille_repertoire_oscar Mo )\033[1;m"
echo "perl -pi -e 's/en cours \033\[1;32m`cat $image_serveur/oscar/commentaire_oscar.txt`\033\[1;31m \: `cat $chemin_langue/Poste` $poste .../re√ßu/g;' /tmp/ligne_images_oscar 
perl -pi -e 's/$image/$image \033[1;31men cours \033\[1;32m`cat $image_serveur/oscar/commentaire_oscar.txt`\033\[1;31m \: `cat $chemin_langue/Poste` $poste ...\033[1;m/g;' /tmp/ligne_images_oscar" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom
cat /tmp/ligne_images_oscar
}
#-----------------------------------------------------------------------------------------------------
ecrire_sur_ntfs_oscar()
{
#	cr√©er le r√©pertoire demarre_oscar
if ! ( test -e $partition_ecrire_oscar/demarre_oscar )
then 
	mkdir $partition_ecrire_oscar/demarre_oscar
else
	rm -f $partition_ecrire_oscar/demarre_oscar/*
fi

#	nettoyer partition_ecrire_oscar sur le poste :
if ( test -e $partition_ecrire_oscar/oscar.bat )
then 
	rm -f $partition_ecrire_oscar/oscar.bat
fi
if ( test -e $partition_ecrire_oscar/oscar_modifstartup_nom.reg )
then 
	rm -f $partition_ecrire_oscar/oscar_modifstartup_nom.reg
fi
if ( test -e $partition_ecrire_oscar/oscar_nettoie_numero_poste.reg )
then 
	rm -f $partition_ecrire_oscar/oscar_nettoie_numero_poste.reg
fi

if ( test -e $partition_ecrire_oscar/fin_numero_poste_oscar.reg )
then 
	rm -f $partition_ecrire_oscar/fin_numero_poste_oscar.reg
fi
if ! ( test -e $image_serveur/oscar/demarre_oscar )
then 
	mkdir $image_serveur/oscar/demarre_oscar
fi

if ( test -e $partition_ecrire_oscar/demarre_oscar/delay.vbs )
then
        rm -f $partition_ecrire_oscar/demarre_oscar/delay.vbs
fi
if ( test -e $partition_ecrire_oscar/demarre_oscar/fin_numero_poste_oscar.bat )
then
        rm -f $partition_ecrire_oscar/demarre_oscar/fin_numero_poste_oscar.bat
fi

###### installer newsid:
newsid=`cat $image_serveur/oscar/var_poste/domaine`
if [ "$newsid" = "non" ]
then
	mettre_nom_poste
else 
	mettre_dom_nom_poste
	#	if ( test -e $partition_ecrire_oscar/demarre_oscar/newsid.exe )
	#	then 
	#	cp -f $partition_ecrire_oscar/demarre_oscar/newsid.exe $image_serveur/oscar/demarre_oscar
	#	elif ( test -e /usr/share/oscar/usr/newsid.exe )
	if ( test -e /usr/share/oscar/usr/newsid.exe )
	then 
		cp -f /usr/share/oscar/usr/newsid.exe $partition_ecrire_oscar/demarre_oscar
		cp -f /usr/share/oscar/usr/newsid.exe $image_serveur/oscar/demarre_oscar
	fi
fi 

#	copier les fichiers dans partition_ecrire_oscar et dans demarre_oscar et sur linux:


cp -f partition_oscar $image_serveur/oscar
cp -f oscar.bat $partition_ecrire_oscar
cp -f oscar.bat $image_serveur/oscar
if ( test -e domaine_oscar.bat )
then
	cp -f domaine_oscar.bat $partition_ecrire_oscar/demarre_oscar
	cp -f domaine_oscar.bat $image_serveur/oscar/demarre_oscar
fi
cp -f /tmp/nom_oscar_poste $partition_ecrire_oscar

cp -f oscar_modifstartup_nom.reg $partition_ecrire_oscar
cp -f oscar_modifstartup_nom.reg $image_serveur/oscar
cp -f oscar_nettoie_numero_poste.reg $partition_ecrire_oscar
cp -f oscar_nettoie_numero_poste.reg $image_serveur/oscar
cp -f fin_numero_poste_oscar.reg $partition_ecrire_oscar
cp -f fin_numero_poste_oscar.reg $image_serveur/oscar
cp -f fin_numero_poste_oscar.bat $partition_ecrire_oscar/demarre_oscar
cp -f fin_numero_poste_oscar.bat $image_serveur/oscar/demarre_oscar
cp -f /tmp/delay.vbs $partition_ecrire_oscar/demarre_oscar
cp -f /tmp/delay.vbs $image_serveur/oscar/demarre_oscar

### installation √©ventuelle du cd OSCAR
installation_eventuelle_cdOSCAR

# nettoyer desktop.ini intempestif
rm -f $partition_ecrire_oscar/Documents\ and\ Settings/All\ Users/Menu\ D√©marrer/Programmes/D√©marrage/desktop.ini
rm -f $partition_ecrire_oscar/ProgramData/Microsoft/Windows/Start\ Menu/Programs/Startup/desktop.ini

#lettre_win=`cat /tmp/partition_oscar_lettre_win`
lettre_win=C
echo "\Zb\Z2           `cat $chemin_langue/texte_19` \Z4$nom_poste `cat $chemin_langue/infobox_9`\n
	\n`cat $chemin_langue/infobox_10` \n
	\n\Z2    `cat $chemin_langue/infobox_2`" > /tmp/fichiertemp
largeur_info=78
}
#-----------------------------------------------------------------------------------------------------
restaure_ntfsclone()
{
echo -e " `cat $chemin_langue/texte_30` \033[1;32m$base $texte_ecrire\033[1;34mNTFS \033[1;m...\033[1;31m"
echo -e "\033[1;m `cat $chemin_langue/Taille` = $valeur1 Mo\033[1;m     `cat $chemin_langue/Poste` : \033[1;31m$poste "
echo
echo -e " `cat $chemin_langue/texte_31`\033[1;m "
echo
cat image.ntfs.* | gunzip -c | ntfsclone --restore-image --overwrite /dev/$evms_oscar$base -
erreur=$?
if ! [ "$erreur" = "0" ]
then    # des erreurs
	echo
        echo -e "\033[1;31m `cat $chemin_langue/ERREUR` \033[1;34m$base \033[1;31m`cat $chemin_langue/ou` \033[1;34m`cat $chemin_langue/sauvegarde`\033[1;34m ...\033[1;m "
	echo
	echo -e " `cat $chemin_langue/boucle_2`"
	echo
	read p
	oscar
	exit
fi
}
#-----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
####### fin montage de la base
#-----------------------------------------------------------------------------------------------------
#		CLIENT √† CLONER
#-----------------------------------------------------------------------------------------------------
#   permet la copie de la table des partitions d'un SERVEUR √† CLONER puis se restaure √† partir de la sauvegarde du serveur
PATH="/usr/share/oscar/bin:$PATH"
/usr/share/oscar/usr/version_theme_oscar
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

#  commandes externes de proc√©dures
case "$1" in
	formater_disque)
		if ( test -e /tmp/ip_serveur_disque )
		then
			ip_serveur=`cat /tmp/ip_serveur_disque`
		fi
		rm -f /tmp/ip_serveur_disque
		
		if ( test -e /tmp/procedure_nfs_disque )
		then
			rm -f /tmp/procedure_nfs_disque
			procedure_nfs_disque=oui
		fi
		disque_table=`cat disque_maitre`
		hd_boot=$disque_table
		formatage=`cat formatage_disques`
		rm -f formatage_disques
		# formater_disque
		faire_table_et_mbr
		exit 0
	;;
	controler_taille_disque_client)
		controler_taille_disque_client
		exit 0
	;;
esac

rm -f /tmp/client_en_reseau
rm -f disque_maitre
	# fin commandes externes

test_demarrage_cdrom
rm -f disque_maitre

	poste=`cat /tmp/numero_poste`
	client=$poste
	ip_transfert=`cat /tmp/ip_poste_client`
	ip_serveur=`cat /tmp/ip_serveur`
	rm -f /tmp/ip_poste_client
	rm -f /tmp/ip_serveur
	chemin_oscar=`cat /tmp/chemin_oscar_serveur`

	recevoir_tables_partitions
	echo
	echo -e "`cat $chemin_langue/texte_22` :\033[1;m"
	echo
	
	rm -f /tmp/ligne_images_oscar
	echo -en "\033[1;31m"
	udp-receiver -f /tmp/ligne_images_oscar --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
	clear
	echo
	echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	echo
	echo -e " ..."
	echo

	rm -f fichiers_root_recept
	echo -en "\033[1;31m"
	udp-receiver -f fichiers_root_recept --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
	clear
	echo
	echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	echo
	echo -e " ..."
	echo
	rm -f fichiers_linux_recept
	udp-receiver -f fichiers_linux_recept --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
	clear
	echo
	echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
	echo
	echo -e " ..."
	echo


	rm -f partition_linux_sauvegarde
	cut -f1 -d"," fichiers_root_recept > partition_linux_sauvegarde
	partition_linux=`cat partition_linux_sauvegarde`

	#if ! ( test -e /mnt/$image_serveur )
	#then
	#	mkdir /mnt/$image_serveur
	#fi
	
	#if ! ( test -e /mnt/$partition_linux )
	#	then	mkdir /mnt/$partition_linux
	#fi
	
	echo "$partition_linux" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	image_serveur=`cat /tmp/monter_partition`
	rm -f /tmp/monter_partition

	if ! ( test -e $image_serveur/oscar )
	then
		mkdir $image_serveur/oscar
	fi
	if ! ( test -e $image_serveur/oscar/var_poste )
	then
		mkdir $image_serveur/oscar/var_poste
	fi
	
	# gestion plusieurs sauvegardes pour l'instant:
	cut -f13 -d"," fichiers_root_recept > commentaire_oscar.txt
	test_plusieurs_sauvegardes=`cat commentaire_oscar.txt`
	if ! [ "$test_plusieurs_sauvegardes" = "_non_plusieurs_" ]
	then
		cp -f commentaire_oscar.txt $image_serveur/oscar/commentaire_oscar_envoye.txt
		cp -f commentaire_oscar.txt $image_serveur/oscar/commentaire_oscar.txt
	else
		rm -f commentaire_oscar.txt
	fi
	
#	cut -f14 -d"," fichiers_root_recept > position_sauvegarde
#	echo "$image_serveur" > partition_travail
#	info_image gerer_sauvegardes_client

	rm -f $image_serveur/oscar/var_poste/numero_poste_client
	echo "$poste" > $image_serveur/oscar/var_poste/numero_poste_client
	
	if ( test -e /tmp/liste_postes_sysprep )
	then
		cp -f /tmp/liste_postes_sysprep $image_serveur/oscar/
		rm -f /tmp/liste_postes_sysprep
	fi

	## sauvegarder table de partitions:
	rm -f $image_serveur/oscar/table_partitions.mbr		##	inutile car format√© mais on ne sait jamais...
	rm -f $image_serveur/oscar/table_partitions.sf
	
	cp -f table_partitions.mbr $image_serveur/oscar/table_partitions.mbr
	cp -f table_partitions.sf $image_serveur/oscar/table_partitions.sf
	rm -f table_partitions.mbr
	rm -f table_partitions.sf

	rm -f $image_serveur/oscar/var_poste/salle_clients
        cut -f2 -d"," fichiers_root_recept > $image_serveur/oscar/var_poste/salle_clients
        grep -ci ";" $image_serveur/oscar/var_poste/salle_clients > /tmp/tempnombre
        nombre_test=`cat /tmp/tempnombre`
        rm -f /tmp/tempnombre
        if [ "$nombre_test" = "0" ]
        then
            nomsalle=`cat $image_serveur/oscar/var_poste/salle_clients`
            echo "$nomsalle" > /tmp/tempnom
            echo "" > /tmp/tempsepar
        else
            cut -f1 -d";" $image_serveur/oscar/var_poste/salle_clients > /tmp/tempnom
            cut -f2 -d";" $image_serveur/oscar/var_poste/salle_clients > /tmp/tempsepar
        fi
 	
	rm -f partition_oscar
	cut -f3 -d"," fichiers_root_recept > partition_oscar

	rm -f /tmp/partition_oscar_lettre_win
	echo "C" > /tmp/partition_oscar_lettre_win
	# cut -f4 -d"," fichiers_root_recept > /tmp/partition_oscar_lettre_win

	rm -f $image_serveur/oscar/var_poste/domaine
	cut -f5 -d"," fichiers_root_recept > $image_serveur/oscar/var_poste/domaine

	rm -f $image_serveur/oscar/var_poste/ip_format
	cut -f6 -d"," fichiers_root_recept > $image_serveur/oscar/var_poste/ip_format

	rm -f $image_serveur/oscar/var_poste/ip_masque
	cut -f7 -d"," fichiers_root_recept > $image_serveur/oscar/var_poste/ip_masque
	
	rm -f $image_serveur/oscar/var_poste/ip_passerelle
	cut -f8 -d"," fichiers_root_recept > $image_serveur/oscar/var_poste/ip_passerelle
	
	rm -f $image_serveur/oscar/var_poste/adresse_synchrone
	cut -f9 -d"," fichiers_root_recept > $image_serveur/oscar/var_poste/adresse_synchrone
	
	rm -f $image_serveur/oscar/var_poste/ip_colore
	cut -f10 -d"," fichiers_root_recept > $image_serveur/oscar/var_poste/ip_colore

	rm -f $image_serveur/oscar/var_poste/vitesse_transmission
	cut -f11 -d"," fichiers_root_recept > $image_serveur/oscar/var_poste/vitesse_transmission
	
	rm -f recept_md5sum_oscar
	cut -f12 -d"," fichiers_root_recept > recept_md5sum_oscar

	## ATTENTION on arrive a cut -f13 (gestion plusieurs sauvegardes) le prochain doit etre cut -f14
	
	cut -f14 -d"," fichiers_root_recept > partition_juste_boot
	partition_juste_boot=`cat partition_juste_boot`
	rm -f partition_juste_boot
	
	cut -f15 -d"," fichiers_root_recept > taille_repertoire_oscar
	taille_repertoire_oscar=`cat taille_repertoire_oscar`
	rm -f taille_repertoire_oscar
	
	cut -f16 -d"," fichiers_root_recept > $image_serveur/oscar/version_oscar
	
	cut -f17 -d"," fichiers_root_recept > /tmp/reboot_clients
	reboot_clients=`cat /tmp/reboot_clients`
	rm -f /tmp/reboot_clients
	
	cut -f18 -d"," fichiers_root_recept > /tmp/taille_fichiers_oscar
	taille_fichiers_oscar=`cat /tmp/taille_fichiers_oscar`
	rm -f /tmp/taille_fichiers_oscar
	
	cut -f19 -d"," fichiers_root_recept > /tmp/taille_fichiers_boot
	taille_fichiers_boot=`cat /tmp/taille_fichiers_boot`
	rm -f /tmp/taille_fichiers_boot
	
	rm -f fichiers_root_recept
	
	rm -f $image_serveur/oscar/partition_sauvegardee
	cut -f1 -d"," fichiers_linux_recept > $image_serveur/oscar/partition_sauvegardee
	base=`cat $image_serveur/oscar/partition_sauvegardee`

##################
	if ( test -e /dev/evms/$base )
	then
	    evms_oscar="evms/"
	else
	    evms_oscar=
	fi
##################

	if ! ( test -e /dev/$evms_oscar$base )
	then
		# texte_mauvais_cablage_disque
		runme choisir_partition_a_restaurer
		base=`cat /tmp/tempfile`	# sdaiii
		rm -f /tmp/tempfile
		if ( test -e /tmp/sortir )
		then
		    rm -f /tmp/sortir
		    rm -f fichiers_linux_recept
		    exit
		fi
	fi
	# si partition windows est boot c'est donc une partition syst√®me v√©rifier ide ou sata
	runme info_ddialog
	perl -pi -e 's/\*/_oscar_/g;' /tmp/fichier_disque_dur
	
	grep -i "^\/dev\/$base" /tmp/fichier_disque_dur | grep -i "_oscar_" | grep -i "ntfs" > /tmp/test_partition_boot_windows
	test_partition_boot_windows=`cat /tmp/test_partition_boot_windows`
	rm -f /tmp/test_partition_boot_windows
	rm -f /tmp/fichier_disque_dur
	if [ "$test_partition_boot_windows" != "" ]
	then
		cut -f8 -d"," fichiers_linux_recept > type_disque_serveur
		type_disque_serveur=`cat type_disque_serveur`
		rm -f type_disque_serveur
		echo "$base" > /tmp/partition_type_scsi_ide
		donner_scsi_ide	# le type est dans /tmp/partition_type_scsi_ide
		type_disque_client=`cat /tmp/partition_type_scsi_ide`
		
		if [ "$type_disque_client" != "" ]
		then
			if [ "$type_disque_client" != "non_uuid" ]
			then
				if [ "$type_disque_serveur" != "" ]
				then
					if [ "$type_disque_serveur" != "non_uuid" ]
					then
						if [ "$type_disque_client" != "$type_disque_serveur" ]
						then
							texte_mauvais_cablage_disque type_ide
							rm -f fichiers_linux_recept
							rm -f /tmp/partition_type_scsi_ide
							exit
						fi
					fi
				fi
			fi
		fi
	fi
	rm -f /tmp/partition_type_scsi_ide
	rm -f $image_serveur/oscar/date_de_sauvegarde

	cut -f2 -d"," fichiers_linux_recept > $image_serveur/oscar/date_de_sauvegarde

	rm -f $image_serveur/oscar/taille_partition_$base
	cut -f3-5 -d"," fichiers_linux_recept > $image_serveur/oscar/taille_partition_$base

### r√©ception √©ventuelle du cd OSCAR

	# mise_en_reseau_asynchrone

	rm -f /tmp/fichiertmp
	cut -f6 -d"," fichiers_linux_recept > /tmp/fichiertmp
	oscar_dd=`cat /tmp/fichiertmp`
	if [ "$oscar_dd" = "oui" ]
	then
		if ! ( test -e $image_serveur/cd_oscar )
		then
			mkdir $image_serveur/cd_oscar
		fi
		rm -f $image_serveur/cd_oscar/oscar_seul_recept.tar.bz2
		echo -en "\033[1;31m"
		udp-receiver -f $image_serveur/cd_oscar/oscar_seul_recept.tar.bz2 --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
		clear
		echo
		echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
		echo
		echo -e " ..."
		echo
		
		echo -e " `cat $chemin_langue/texte_23` ...\033[1;m "
		echo
		
		md5sum $image_serveur/cd_oscar/oscar_seul_recept.tar.bz2 > md5sum_oscar
		
		cut -d" " -f1 md5sum_oscar > /tmp/tempfile_md5
		cp -f /tmp/tempfile_md5 md5sum_oscar
		rm -f /tmp/tempfile_md5
		recept_md5sum_oscar=`cat recept_md5sum_oscar`
		md5sum_oscar=`cat md5sum_oscar`
		rm -f md5sum_oscar
		rm -f recept_md5sum_oscar

		if ! [ "$recept_md5sum_oscar" = "$md5sum_oscar" ]
		then
			echo
			echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
			echo
			echo
			echo -e "`cat $chemin_langue/texte_24`\033[1;m "                      
			echo -e "`cat $chemin_langue/texte_25` \033[1;33m`cat $image_serveur/oscar/var_poste/vitesse_transmission`b/s \033[1;34m`cat $chemin_langue/texte_26` \033[1;m "
			echo
		#	echo -e "`cat $chemin_langue/texte_27` \033[1;m "
		#	echo -e " `cat $chemin_langue/boucle_2`"
		#	echo
			echo "$poste" >> /mnt/serveur_nfs/erreur_vitesse_transmission
		#	read p
		#	oscar
		#	exit
		else
			echo
			echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
			echo
			echo -e " `cat $chemin_langue/texte_28`\033[1;m "
			echo
		fi
		
		rm -f /tmp/test_vitesse
		echo -en "\033[1;31m"
		udp-receiver -f /tmp/test_vitesse --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
		clear
		echo
		echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
		echo
		echo -e " ..."
		echo
		rm -f /tmp/test_vitesse
		rm -f /tmp/resultat_test
		echo -en "\033[1;31m"
		udp-receiver -f /tmp/resultat_test --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
		clear
		echo
		echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
		echo
		echo -e " ..."
		echo
		resultat_test=`cat /tmp/resultat_test`
		rm -f /tmp/resultat_test
		if [ "$resultat_test" = "vitesse" ]
		then
			lancer_avahi client
			rm -f /tmp/sortir
			exit
		elif [ "$resultat_test" = "eteindre" ]
		then
			rm -f /tmp/fichiertmp
			rm -f $image_serveur/oscar/livecd.squashfs
			umount /mnt/serveur_nfs 2>/dev/null
			umount /mnt/serveur_oscar 2>/dev/null
			rm -f /tmp/ip_mcast_rdv
			runme eteindre_le_poste
		fi
	fi
	
	if ! [ "$partition_juste_boot" = "non" ]
	then
		echo "$partition_juste_boot" > /tmp/monter_partition
		runme autoriser_monter_partition_oscar
		# partition_montee_boot=`cat /tmp/monter_partition`
		echo
		echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
		echo
		rm -f /tmp/monter_partition		
		echo -e " `cat $chemin_langue/texte_29` \033[1;32m$partition_juste_boot \033[1;34m...\033[1;m "
		echo
		
		rm -f /mnt/juste_boot_recept.tar.bz2
		echo -en "\033[1;31m"
		udp-receiver -f $image_serveur/cd_oscar/juste_boot_recept.tar.bz2 --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
		clear
		echo
		echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
		echo
		echo -e " ..."
		echo
	
		## d√©compresser fichiers juste_boot
		echo "$image_serveur" > /tmp/partition_oscar_image
		echo "$partition_juste_boot" > /tmp/sp_partition_juste_boot
		echo "$taille_fichiers_boot" > /tmp/sp_taille_fichiers_boot
		fichiers_oscar_clients sp_decompresser_fichiers_boot
		rm -f /tmp/partition_oscar_image
		cp -fR $image_serveur/cd_oscar/$partition_juste_boot /mnt/
	fi
	
	rm -f $image_serveur/oscar/date_oscar
	cut -f6-7 -d"," fichiers_linux_recept > $image_serveur/oscar/date_oscar
	##### 	attention pour le suivant colonne 8 deja pris	#####
	rm -f fichiers_linux_recept

	echo
##	rm -f $image_serveur/oscar/image.partimage.*  # s'il y en a faire de la place !
	fichier_existe=oui
	rm -f /tmp/erreur_md5sum
	while [ "$fichier_existe" = "oui" ]
	do
		rm -f fichier_image_recept
		echo
		udp-receiver -f fichier_image_recept --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
		clear
		echo
		echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
		echo
		echo -e " ..."
		image=`cat fichier_image_recept`
		if ! [ "$image" = "fin" ]
		then
			echo
			afficher_ligne_images_oscar
			echo
			udp-receiver -f $image_serveur/oscar/$image --nokbd --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --portbase 9020 --interface `cat /tmp/carte_ethi`
			clear
			echo
			echo -e "\033[1;34m  `cat $chemin_langue/inputbox_26` \033[1;32m$ip_serveur:$chemin_oscar \033[1;m"
			echo
			echo -e " ..."
			echo
			if ! ( test -e /tmp/recu_fichier_mac )
			then
				echo "" > /tmp/recu_fichier_mac
				recevoir_fichier_mac
			fi
			controle_fichier_image
		else
		fichier_existe=non
		fi
	done
	rm -f /tmp/ligne_images_oscar
	rm -f fichier_image_recept
	rm -f /tmp/recu_fichier_mac
	
	echo -e "\033[1;m"
	        if ( test -e /tmp/sortir )
		then
		    rm -f /tmp/sortir
		    exit
		fi
	info_veille
	
	#		partimage restore /dev/$base $image_serveur/oscar/image.partimage.000 -b -f3 #  -f1
	#		echo
	#		echo -e "\033[1;31mSi la barre rouge est √† 100% la restauration de la partition \033[1;32m$base \033[1;31mest bonne !!\033[1;m"
	#		echo
	#		echo

	echo "$image_serveur" > /tmp/tempfile # /mnt/sda2
	perl -pi -e 's/\/mnt\///g;' /tmp/tempfile # sda2
	repertoire_oscar=`cat /tmp/tempfile`
	rm -f /tmp/tempfile
	echo "$repertoire_oscar" > /tmp/partition_oscar_client

	if [ "$image_serveur" = "" ]
	then
		repertoire=/
	else
		repertoire=$image_serveur
	fi
	partition_linux_poste=$repertoire
	if ( test -e /dev/evms/$base )
	then
	    evms_oscar="evms/"
	else
	    evms_oscar=
	fi
	repertoire=$repertoire/oscar
	if ( test -e /tmp/erreur_md5sum )
	then
		erreur_md5sum=`cat /tmp/erreur_md5sum`
		rm -f /tmp/erreur_md5sum
		if [ "$erreur_md5sum" = "erreur_md5sum" ]
		then
			repertoire=/mnt/serveur_oscar
		else	# pas d'erreur le poste est maintenant autonome le serveur peut s'eteindre
			if ( test -e /tmp/differe )
			then
				rm -f /tmp/differe
				if ( test -e /mnt/serveur_nfs/client_pxe )
				then
					# indiquer au serveur pxe que le poste va eteindra apres la restauration :
					echo "perl -pi -e 's/$poste//g;' /mnt/serveur_nfs/client_pxe" > /tmp/exec_nom
					chmod +x /tmp/exec_nom
					/tmp/exec_nom
				fi
			fi
			# umount /mnt/serveur_nfs 2>/dev/null ; sync
			# umount /mnt/serveur_oscar 2>/dev/null ; sync
			# umount /mnt/serveur_partage 2>/dev/null ; sync
		fi
	fi
	
	#	echo "$repertoire" > /tmp/repertoire_correct
	#	perl -pi -e 's/\/\//\//g;' /tmp/repertoire_correct
	#	repertoire=`cat /tmp/repertoire_correct`
	#	rm -f /tmp/repertoire_correct
	
	cd $repertoire
		texte_ecrire=
		if ( test -e partition_sauvegardee )
		then
			#	if ( test -e commentaire_oscar_envoye.txt )
			#	then
			#		ecrire=`cat commentaire_oscar_envoye.txt`
			#		rm -f commentaire_oscar_envoye.txt
			#		texte_ecrire="$ecrire "
			#	fi
			if ( test -e commentaire_oscar.txt )
			then
				ecrire=`cat commentaire_oscar.txt`
				texte_ecrire="$ecrire "
			fi
		fi
		echo "`du $repertoire --max-depth=1 -ma`" > /tmp/valeur2
		perl -pi -e 's/oscar\//__rien_OSCAR__/g;' /tmp/valeur2
		grep -v "__rien_OSCAR__" /tmp/valeur2 > /tmp/valeur1
		# prendre la premiere colonne :
		valeur1=`awk '{print$1}' /tmp/valeur1`
		rm -f /tmp/valeur1
		rm -f /tmp/valeur2

		numero_sd=`expr substr $base 4 3`
		disque=`expr substr $base 1 3`       		#sda
		if ! ( test -e /tmp/fichier_disque_dur )
	    	then
	    		runme info_ddialog
	    	fi
		rm -f /tmp/partition_ntfs_sauvegardee
	    	# id_type=`sfdisk /dev/$disque -c $numero_sd 2>/dev/null`
	    	grep -i $base /tmp/fichier_disque_dur | grep -ci ntfs > /tmp/nb_partition_ntfs
		nb_partition_ntfs=`cat /tmp/nb_partition_ntfs`
		rm -f /tmp/nb_partition_ntfs
		if [ "$nb_partition_ntfs" = "1" ] # partition ntfs
		then  # partition ntfs
			if ! ( test -e image.partimage.000 )
			then
				if ! ( test -e image_dar.1.dar )
				then
					echo "" > /tmp/sauve_diag
					if ( test -e /tmp/sauve_diag )
					then
						echo "$repertoire" > /tmp/partition_restaure_dar
						echo "$base" > /tmp/base_restaure_dar
						echo "$texte_ecrire" > /tmp/texte_ecrire
						echo "$poste" > /tmp/tmp_numero_poste_client
						rm -f /tmp/sauve_fsa
						if ! ( test -e image_fsa.fsa )
						then
							restaure_dar restaure_ntfsclone
						else
							echo "182" > /tmp/correcteur_compression_restaure	# compression 2,14 pour fsa
							echo "partition_ntfs_sauvegardee" > /tmp/partition_ntfs_sauvegardee
							restaure_dar restaure_fsa
							echo "" > /tmp/sauve_fsa # pour la sauvegarde prochaine de cette procedure
						fi
						rm -f /tmp/sauve_diag
						if ( test -e /tmp/sortir )
					 	then
					 		rm -f /tmp/sortir
					 		oscar
							exit
					 	fi
					else
						restaure_ntfsclone
					fi
				fi
				
				if ( test -e image_dar.1.dar )
				then
					echo "ntfs" > /tmp/besoin_type
					echo "$base" > /tmp/monter_partition
					runme autoriser_monter_partition_oscar
					rm -f /tmp/monter_partition
					rm -f /tmp/besoin_type
					
					echo "$repertoire" > /tmp/partition_restaure_dar
					echo "$base" > /tmp/base_restaure_dar
					echo "173" > /tmp/correcteur_compression_restaure	# compression 1,73 pour ntfs
					echo "$texte_ecrire" > /tmp/texte_ecrire
					echo "$poste" > /tmp/tmp_numero_poste_client

					restaure_dar
					
				 	if ( test -e /tmp/sortir )
				 	then
				 		rm -f /tmp/sortir
				 		oscar
						exit
				 	fi
				fi
				
				# tester sysprep :
				if ( test -e /mnt/$base/sysprep/sysprep_var.inf ) || ( test -e /mnt/$base/Windows/System32/sysprep/sysprep_var.xml ) || ( test -e /mnt/$base/Windows/oscar_deploie/oscar_var.txt ) || ( test -e /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt )
				then
					if ( test -e /mnt/$base/sysprep/sysprep_oscar.inf ) || ( test -e /mnt/$base/Windows/System32/sysprep/sysprep_oscar.xml ) || ( test -e /mnt/$base/Windows/oscar_deploie/oscar_var.txt ) || ( test -e /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt )
					then
						echo "$partition_linux_poste" > /tmp/partition_linux_pour_sysprep
						sysprep
						umount /mnt/$base 2>/dev/null ; sync
					fi
				fi
				umount /mnt/$base 2>/dev/null ; sync
			else 	# autre type de partition ou ancienne sauvegarde partimage en ntfs
				rm -f /tmp/fichiertmp
				echo " " >> /tmp/fichiertmp
				echo "`cat $chemin_langue/msgbox_23`" >> /tmp/fichiertmp
				echo " " >> /tmp/fichiertmp
				
				# Informations sur la SAUVEGARDE de ce poste
				dialog --colors --no-shadow --ok-label "`cat $chemin_langue/Continuer`" \
				--backtitle  "`cat /etc/banniere_oscar`" \
				--title " `cat $chemin_langue/msgbox_22` " \
				--msgbox "`cat /tmp/fichiertmp`" 10 60
				rm -f /tmp/fichiertmp
				rm -f /tmp/ip_mcast_rdv
				runme eteindre_le_poste
			fi
		else   # autre type de partition voir si c'est une bonne image:
			if ( test -e image_dar.1.dar ) || ( test -e image_fsa.fsa )
			then
				if ! ( test -e /mnt/$base )
				then
					mkdir /mnt/$base
				fi
				grep -i $base /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
				nb_partition_linux=`cat /tmp/nb_partition_linux`
				rm -f /tmp/nb_partition_linux
				if [ "$nb_partition_linux" = "1" ] # partition linux non swap
				then
			                fsck /dev/$evms_oscar$base -N > /tmp/fs_type
	    			        grep -ci "reiserfs" /tmp/fs_type > /tmp/nb_fstype
	            			valeur=`cat /tmp/nb_fstype`
		            		if [ "$valeur" = "1" ] # partition ReiserFS
	        		        then
						echo
		    		        	echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ReiserFS\033[1;m "
						echo
			                    	mkfs.reiserfs -f /dev/$evms_oscar$base 2>/dev/null
			                    	mount -t reiserfs /dev/$evms_oscar$base /mnt/$base
	    			        else
		        		        grep -ci "xfs" /tmp/fs_type > /tmp/nb_fstype
			        		valeur=`cat /tmp/nb_fstype`
				                if [ "$valeur" = "1" ] # partition XFS
		    			        then
		            	    			echo
			                		echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux XFS\033[1;m "
							echo
		                        	        mkfs.xfs -f /dev/$evms_oscar$base
		                        	        mount -t xfs /dev/$evms_oscar$base /mnt/$base
		                        	else
			        		        grep -ci "jfs" /tmp/fs_type > /tmp/nb_fstype
				        		valeur=`cat /tmp/nb_fstype`
					                if [ "$valeur" = "1" ] # partition JFS
			    			        then
			            	    			echo
				                		echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux JFS\033[1;m "
								echo
			                        	        mkfs.jfs -fq /dev/$evms_oscar$base
			                        	        mount -t jfs /dev/$evms_oscar$base /mnt/$base
							else
								grep -ci "ext4" /tmp/fs_type > /tmp/nb_fstype
					        		valeur=`cat /tmp/nb_fstype`
						                if [ "$valeur" = "1" ] # partition ext4
				    			        then
				    			        	echo
					            			echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ext4\033[1;m "
									echo
			            		            		mkfs.ext4 -qF /dev/$evms_oscar$base
			            		            		mount -t ext4 /dev/$evms_oscar$base /mnt/$base
			            		            	else
			            		            		grep -ci "reiser4" /tmp/fs_type > /tmp/nb_fstype
					            			valeur=`cat /tmp/nb_fstype`
						            		if [ "$valeur" = "1" ] # partition ReiserFS
					        		        then
										echo
						    		        	echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux Reiser4\033[1;m "
										echo
							                    	mkfs.reiser4 -f /dev/$evms_oscar$base 2>/dev/null
							                    	mount -t reiser4 /dev/$evms_oscar$base /mnt/$base
					    			        else  # autres cas ext3 et ext2
						        		        echo
						            			echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ext3\033[1;m "
										echo
				            		            		mkfs.ext3 -qF /dev/$evms_oscar$base
				            		            		mount -t ext3 /dev/$evms_oscar$base /mnt/$base
				            		            	fi
		            		            		fi
		            		            	fi
	            		            	fi
	            			fi
					rm -f /tmp/fs_type
					rm -f /tmp/nb_fstype
				else
					grep -i $base /tmp/fichier_disque_dur | grep -ci swap > /tmp/nb_partition_swap
					nb_partition_swap=`cat /tmp/nb_partition_swap`
					rm -f /tmp/nb_partition_swap
					if [ "$nb_partition_swap" = "1" ] # partition swap linux
					then  # partition linux swap
		                        	echo
		                        	echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux swap\033[1;m "
						echo
						mkfs.ext3 -qF /dev/$evms_oscar$base
						mkswap -f /dev/$evms_oscar$base 1>/dev/null
						mount /dev/$evms_oscar$base /mnt/$base
					else
						grep -i $base /tmp/fichier_disque_dur | grep -ci fat32 > /tmp/nb_partition_fat32
						nb_partition_fat32=`cat /tmp/nb_partition_fat32`
						rm -f /tmp/nb_partition_fat32
						if [ "$nb_partition_fat32" = "1" ] # partition fat32
				               	then
							echo
							echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mfat32\033[1;m "
							echo
							mkdosfs -vF 32 /dev/$evms_oscar$base
							mount /dev/$evms_oscar$base /mnt/$base
						else
							grep -i $base /tmp/fichier_disque_dur | grep -ci fat16 > /tmp/nb_partition_fat16
							nb_partition_fat16=`cat /tmp/nb_partition_fat16`
							rm -f /tmp/nb_partition_fat16
							if [ "$nb_partition_fat16" = "1" ] # partition fat16
					               	then
								echo
								echo -e " --> `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mfat16\033[1;m "
								echo
								mkdosfs -vF 16 /dev/$evms_oscar$base
								mount /dev/$evms_oscar$base /mnt/$base
				                        else    # partition  autre
								mount /dev/$evms_oscar$base /mnt/$base
							fi
						fi
					fi
				fi
				# cd /mnt/$base
				# dar -x $repertoire/image_dar -R /mnt/$base -b -w -v # √† voir option -b
				echo "$repertoire" > /tmp/partition_restaure_dar
				echo "$base" > /tmp/base_restaure_dar
				echo "234" > /tmp/correcteur_compression_restaure	# compression 2,34 pour linux
				echo "$texte_ecrire" > /tmp/texte_ecrire
				echo "$poste" > /tmp/tmp_numero_poste_client
				
				if ! ( test -e $repertoire/image_fsa.fsa )	# image_dar
				then
					restaure_dar
				else # avec image_fsa.fsa
					echo "182" > /tmp/correcteur_compression_restaure
					umount /mnt/$base 2>/dev/null ; sync
					restaure_dar restaure_fsa
				fi
				
	                 	if ( test -e /tmp/sortir )
	                 	then
	                 		rm -f /tmp/sortir
	                 		oscar
					exit
	                 	fi
				cd /root
				if [ "$oscar_dd" != "oui" ]
				then
					if ( test -e /mnt/$base/dev )	# partition linux systeme
					then
						echo "" > /tmp/rst_lance
						echo "" > /tmp/repare_boot_dd
						installe_oscar_dd	# pour boot sur partition syst√®me linux apr√®s formatage mbr local
					fi
				fi
	                        umount /mnt/$base 2>/dev/null ; sync
			else
				rm -f /tmp/fichiertmp
				echo " " >> /tmp/fichiertmp
				echo "`cat $chemin_langue/msgbox_23`" >> /tmp/fichiertmp
				echo " " >> /tmp/fichiertmp
				
				# Informations sur la SAUVEGARDE de ce poste
				dialog --colors --no-shadow --ok-label "`cat $chemin_langue/Continuer`" \
				--backtitle  "`cat /etc/banniere_oscar`" \
				--title " `cat $chemin_langue/msgbox_22` " \
				--msgbox "`cat /tmp/fichiertmp`" 10 60
				rm -f /tmp/fichiertmp
				rm -f /tmp/ip_mcast_rdv
				runme eteindre_le_poste
			fi
		fi
	cd /root
	if [ "$erreur_md5sum" = "erreur_md5sum" ]
	then
		# sauvegarder
		echo "$partition_linux_poste" > /tmp/chemin_de_sauvegarde
		sauve sauvegarder
		rm -f /mnt/serveur_oscar/var_poste/postes_defectueux/$poste
		if ! ( test -e /tmp/differe )
		then
			umount /mnt/serveur_nfs 2>/dev/null ; sync
		fi
	else
		if ! ( test -e /tmp/differe )
		then
			umount /mnt/serveur_nfs 2>/dev/null ; sync
		fi
	fi
	
if ! [ "$nomsalle" = "aucun" ]	# copier les fichiers oscar si le nom du poste demand√©:
then
	nom_separateur=`cat /tmp/tempsepar`
	if ! [ "$nom_separateur" = "aucun" ]	# copier les fichiers oscar si le nom du poste demand√©:
	then
		cp -f $image_serveur/oscar/var_poste/ip_masque /tmp/ip_masque
		cp -f $image_serveur/oscar/var_poste/ip_passerelle /tmp/ip_passerelle
		cp -f $image_serveur/oscar/var_poste/ip_format /tmp/ip_format
		cp -f $image_serveur/oscar/var_poste/numero_poste_client /tmp/numero_poste_client
		installe_ip	#	si IP demand√© installation dans oscar_modifstartup.reg
		rm -f /tmp/ip_masque
		rm -f /tmp/ip_passerelle
		rm -f /tmp/ip_format
		rm -f /tmp/numero_poste_client
		
		
		# copier les fichiers oscar:
	
		rm -f /tmp/nom_oscar_poste
		#	echo "$nomsalle-P$poste" > /tmp/nom_oscar_poste
		#	cat /tmp/nom_oscar_poste | sed s/-P/_P/g > /tmp/nom_oscar_poste
		
	        # dans salle_clients (nom,separateur) ou ancien (nom)
	        nom_poste=`cat /tmp/tempnom``cat /tmp/tempsepar`$poste
	        rm -f /tmp/tempnom
	        rm -f /tmp/tempsepar
	        echo "$nom_poste" > /tmp/nom_oscar_poste
		echo
	        echo -e " `cat $chemin_langue/texte_32`\033[1;34m $nom_poste \033[1;m"
	        echo
	
	#ok	monter le r√©pertoire o√π ecrire oscar avec le fichier oscar.bat et repertoire demarre_oscar
	
		echo "$base" > /tmp/base_sauvegarde
		installe_oscar_dd cherche_partition_et_variables_boot_pour_serveur  # pour mettre fichiers servant au nom du poste dans partition_oscar
		rm -f /tmp/sysprep_installe	# inutile ici en client
		
		partition_ecrire_oscar=`cat partition_oscar`
		#ok	monter le r√©pertoire o√π ecrire oscar
		if [ "$partition_ecrire_oscar" = "linux" ] # partition linux
		then
			echo "$base" > /tmp/monter_partition
			runme autoriser_monter_partition_oscar
			rm -f /tmp/monter_partition
			## ici installer le num√©ro de poste son IP et son domaine pour Ubuntu dans le r√©pertoire base
			if ( test -e /mnt/$base/etc )	# partition linux syst√®me
			then
				if ( test -e /mnt/$base/etc/hostname )
				then
					cp -f /mnt/$base/etc/hostname /tmp/hostname_modele
				else
					echo "$nom_poste" > /tmp/hostname_modele	# pour eviter une erreur
				fi
				echo "$nom_poste" > /mnt/$base/etc/hostname
				echo "$image_serveur" > /tmp/partition_linux_oscar
				echo "$base" > /tmp/partition_linux_particuliere	# pour ubuntu mandriva ou linux
				# dans le fichier installer_ip_manuel_linux_supprimer_fichiers supprimer les fichiers ssh et detection pour eole valable pour tous les linux
				installer_ip_manuel_linux_supprimer_fichiers	# pour ubuntu mandriva ou linux		
				rm -f /tmp/partition_linux_oscar
				## ici installer le num√©ro de poste pour Linux dans le r√©pertoire base
				
				# remplacer le nom du modele par le nom du client :
				echo "perl -pi -e 's/`cat /tmp/hostname_modele`/`cat /mnt/$base/etc/hostname`/g;' /mnt/$base/etc/hosts" > /tmp/exec_nom
				chmod +x /tmp/exec_nom
				/tmp/exec_nom
				
				rm -f /tmp/hostname_modele
				rm -f /tmp/exec_nom
				rm -f /tmp/partition_linux_particuliere
				
				installation_eventuelle_cdOSCAR
				rm -f /tmp/fichiertemp
				echo "\Zb\Z2   `cat $chemin_langue/texte_19` \Z4$nom_poste `cat $chemin_langue/infobox_9`\n
				\n`cat $chemin_langue/infobox_2`" > /tmp/fichiertemp
			else
				installation_eventuelle_cdOSCAR
				rm -f /tmp/fichiertemp
				poste=`cat $image_serveur/oscar/var_poste/numero_poste_client`
				echo "\Zb\Z2       `cat $chemin_langue/texte_19` \Z4$poste `cat $chemin_langue/infobox_9`\n
				\n`cat $chemin_langue/infobox_2`" > /tmp/fichiertemp
			fi
			largeur_info=60
		else	# partition windows
		
			#if ! ( test -e /mnt/$partition_ecrire_oscar )
			#then
			#    mkdir /mnt/$partition_ecrire_oscar
			#fi
	
			#echo "$partition_ecrire_oscar" > /tmp/monter_partition
			partition_sauvegardee_ntfs=non
			if [ "$partition_ecrire_oscar" = "ntfs" ]
			then
				echo "ntfs" > /tmp/besoin_type
				partition_sauvegardee_ntfs=oui
			fi
			echo "$base" > /tmp/monter_partition
			runme autoriser_monter_partition_oscar
			partition_ecrire_oscar=`cat /tmp/monter_partition`
			rm -f /tmp/monter_partition
			rm -f /tmp/besoin_type

			if ( test -e $partition_ecrire_oscar/ProgramData/Microsoft/Windows/Start\ Menu/Programs )
			then	# partition syst√®me Win Seven
				cp -f /usr/share/oscar/usr/oscar.lnk $partition_ecrire_oscar/ProgramData/Microsoft/Windows/Start\ Menu/Programs/Startup/oscar.lnk
				ecrire_sur_ntfs_oscar
			elif ( test -e $partition_ecrire_oscar/Documents\ and\ Settings/All\ Users/Menu\ D√©marrer/Programmes/D√©marrage ) # si partition syst√®me sauvegard√©e
			then	# partition syst√®me Win XP fr
				cp -f /usr/share/oscar/usr/oscar.lnk $partition_ecrire_oscar/Documents\ and\ Settings/All\ Users/Menu\ D√©marrer/Programmes/D√©marrage/oscar.lnk
				ecrire_sur_ntfs_oscar
			else	#fin du nommage des postes
				# partition de donn√©es
				### installation √©ventuelle du cd OSCAR
				installation_eventuelle_cdOSCAR
				poste=`cat $image_serveur/oscar/var_poste/numero_poste_client`
				echo "\Zb\Z2       `cat $chemin_langue/texte_19` \Z4$poste `cat $chemin_langue/infobox_9`\n
				\n`cat $chemin_langue/infobox_2`" > /tmp/fichiertemp
				largeur_info=60
			fi
		fi
		nettoyer_tmp
		eteindre_ordinateur
	else 	# ne pas copier les fichiers oscar:
		fin_apres_sysprep
	fi
else 	# ne pas copier les fichiers oscar:
	fin_apres_sysprep
fi
