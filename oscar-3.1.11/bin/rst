#!/bin/sh

## Copyright (c) 2003-2013 Tissoires Jean-FranÃ§ois & Benjamin, jftissoires@gmail.com
## Cdrom Outil SystÃ¨me Complet d'Assistance RÃ©seau: OSCAR
## Ce programme est sous Licence Publique GÃ©nÃ©rale GNU publiÃ©e par la Free Software Foundation.



# restaure la partition Ã  partir de l'image situÃ©e sur la partition linux

# 3 variables /tmp/correcteur_compression_restaure selon linux ou  2 pour ntfs

PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

#----------------------------------------------------------------------------------------------------
eteindre_le_poste()
{
if ( test -e /tmp/new_sysprep/sysprep/sysprep_var.inf ) || ( test -e /tmp/new_sysprep/sysprep/sysprep_var.xml ) || ( test -e /tmp/new_sysprep/oscar_deploie/oscar_var.txt )
then
	rm -fr /tmp/new_sysprep
	# sauvegarder :
	echo "$partition_linux" > /tmp/chemin_de_sauvegarde
	if ! ( test -e /mnt/serveur_oscar )
	then
		mkdir /mnt/serveur_oscar
	fi
	echo "ntfs" > /tmp/besoin_type
	echo "$base" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	rm -f /tmp/monter_partition
	rm -f /tmp/besoin_type
	if ( test -e /mnt/$base/Windows/System32/sysprep/sysprep_var.xml )
	then
		cp -f /tmp/newsysprep_temp_sysprep_var.xml /mnt/$base/Windows/System32/sysprep/sysprep_var.xml
		cp -f /tmp/newsysprep_temp_sysprep_oscar.inf /mnt/$base/Windows/System32/sysprep/sysprep_oscar.xml
		rm -f /tmp/newsysprep_temp_sysprep_var.xml
		rm -f /tmp/newsysprep_temp_sysprep_oscar.inf
	elif ( test -e /mnt/$base/sysprep/sysprep_var.inf )
	then
		cp -f /tmp/newsysprep_temp_sysprep_var.inf /mnt/$base/sysprep/sysprep_var.inf
		cp -f /tmp/newsysprep_temp_sysprep_oscar.inf /mnt/$base/sysprep/sysprep_oscar.inf
		rm -f /tmp/newsysprep_temp_sysprep_var.inf
		rm -f /tmp/newsysprep_temp_sysprep_oscar.inf
	elif ( test -e /mnt/$base/Windows/oscar_deploie/oscar_var.txt )
	then
		if ( test -e /tmp/new_sysprep/oscar_deploie/oscar_var.txt )
		then
			if [ "$verifie_new_sysprep_oscar_deploie" != "oscar_var_new_sysprep" ]
			then
				cp -f /tmp/newsysprep_temp_Windows_oscar_var.txt /mnt/$base/Windows/oscar_deploie/oscar_var.txt
			fi
		else
			cp -f /tmp/newsysprep_temp_Windows_oscar_var.txt /mnt/$base/Windows/oscar_deploie/oscar_var.txt
		fi
		rm -f /tmp/newsysprep_temp_Windows_oscar_var.txt
	elif ( test -e /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt )
	then
		if ( test -e /tmp/new_sysprep/oscar_deploie/oscar_var.txt )
		then
			if [ "$verifie_new_sysprep_oscar_deploie" != "oscar_var_new_sysprep" ]
			then
				cp -f /tmp/newsysprep_temp_WINDOWS_oscar_var.txt /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt
			fi
		else
			cp -f /tmp/newsysprep_temp_WINDOWS_oscar_var.txt /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt
		fi
		rm -f /tmp/newsysprep_temp_WINDOWS_oscar_var.txt
	fi
	umount /mnt/$base
	echo "$base" > /mnt/serveur_oscar/partition_sauvegardee
	cp -f $partition_linux/oscar/commentaire_oscar.txt /mnt/serveur_oscar/commentaire_oscar.txt
	echo "" > /tmp/sauve_fsa
	sauve sauvegarder
fi
# indiquer au serveur pxe que le poste va s'eteindre :
if ( test -e /mnt/serveur_nfs/client_pxe )
then
	echo "perl -pi -e 's/$mac_adresse_poste//g;' /mnt/serveur_nfs/client_pxe" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	umount /mnt/serveur_nfs 2>/dev/null ; sync
fi

	if ! [ "$partition_linux" = "" ]
	then
		umount $partition_linux 2>/dev/null ; sync
	fi
	# Le poste s'Ã©teint
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/infobox_1` " \
	--infobox "\n\n\n`cat $chemin_langue/infobox_2`\n\n\n\n" 0 0

rm -f /tmp/partition_lvm_existe
rm -f /tmp/partition_lvm_cherchee

for passe in 10 9 8 7 6 5 4 3 2 1 STOP
do
    sleep 1
    echo -en "\033[1;31m  > $passe\033[1;m"
done
if ( test -e /etc/cdrom_ejecte )
then
	eject -t
fi
umount -a 2>/dev/null ; sync
halt
sleep 10
exit
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boucle_partition() # sortir la partition dans la reponse
{
	rm -f /tmp/tempfile
	echo "$type" > /tmp/tempfile
	runme prepare_boucle_partition
	nombretype=`cat /tmp/nombre`
	rm -f /tmp/nombre
numero=0
cp -f /tmp/tempfile /tmp/temp_ligne_deux_points
rm -f /tmp/tempfile
until  ( test  $numero = $nombretype )
	do
	rm -f /tmp/temp_ligne_deux_points1
#	rm -f /tmp/partfile1
	numero=$[$numero+1]
	cut -d":" -f$numero /tmp/temp_ligne_deux_points > /tmp/temp_ligne_deux_points1	#hdaiii
#	cut -d":" -f$numero /tmp/partfile > /tmp/partfile1	#ide/h0/b0/t0/l0/hdaiii
	reponse=`cat /tmp/temp_ligne_deux_points1`
	reparti=$reponse
	rm -f /tmp/temp_ligne_deux_points1
	numero_hd=`expr substr $reponse 4 3`
#	disque=`cut -d/ -f1-5 /tmp/partfile1`/disc	#ide/h0/b0/t0/l0/disc
#	rm -f /tmp/partfile1
	disque=`expr substr $reponse 1 3`       #hda
        if [ "$type" = "linux" ]
	then
	        # id_type=`sfdisk /dev/$disque -c $numero_hd 2>/dev/null`
		grep -i $reponse /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
	        nb_partition_linux=`cat /tmp/nb_partition_linux`
	        rm -f /tmp/nb_partition_linux
		if [ "$nb_partition_linux" = "1" ] # partition linux pas swap linux
		then
			#if ! ( test -e /mnt/$reponse )
			#	then	mkdir /mnt/$reponse
			#fi
			
			echo "$reponse" > /tmp/monter_partition
			runme autoriser_monter_partition_oscar
			partition_linux=`cat /tmp/monter_partition`
			rm -f /tmp/monter_partition
			
			if ( test -e $partition_linux/image.partimage.000 ) ## sauvegarde dans ancienne version
			then
				rm -f partition_de_sauvegarde
				echo "$reponse" > partition_de_sauvegarde
				changement_version_oscar changement_partition_sauvegarde
			fi
			if ( test -e $partition_linux/oscar/image.partimage.000 ) || ( test -e $partition_linux/oscar/image.ntfs.00 ) || ( test -e $partition_linux/oscar/image_dar.1.dar ) || ( test -e $partition_linux/oscar/image_fsa.fsa )
			then
				image_trouvee=oui
				rm -f /tmp/temp_ligne_deux_points
				partition_sauvegarde_oscar=$reponse
#				rm -f /tmp/partfile
				return		
			fi
			umount $partition_linux 2>/dev/null ; sync
		fi
	fi
#	rm -f /tmp/partfile1
    done
rm -f /tmp/tempfile
# rm -f /tmp/partfile
}
#----------------------------------------------------------------------------------------------------
boite_partition_sauvegardee() # selectionner seulement les partitions linux non swap
{
if [ "$reponse" = "" ] # pour sp serveur si dÃ©marrage dd
then
	reponse=$partition_linux_boite
fi

#	runme prepare_fichier_temptaille
#	rm -f /tmp/bozo
#	egrep -e "^/dev" /tmp/fichier_disque_dur | grep -v "$reponse" | grep -v "W95 Ext'd" | grep -v "Extended" | grep -v "swap" | \
#	perl -pi -e 's/\*//g;  s/\+/ /g; s/\-/ /g; s/  /:/g; s/:+/:/g;' | \
#	awk 'BEGIN { FS=":" } { printf ("%0s %15s %25s\n","\""$1"\" \"",$4,$6"\" \\")}' >> /tmp/bozo

runme info_ddialog_menu
grep -v "swap" /tmp/bozo | grep -v "Linux LVM" > /tmp/bozo1
cp -f /tmp/bozo1 /tmp/bozo
rm -f /tmp/bozo1
runme boite_selection_bozo
}
#----------------------------------------------------------------------------------------------------
demander_partition_a_sauvegarder()	#si pas de fichier $partition_linux/oscar/partition_sauvegardee
{
	rm -f /tmp/menu_titre
	rm -f /tmp/menu_texte
	rm -f /tmp/fichierquestion

	if [ "$reponse" = "" ] # pour sp serveur si dÃ©marrage dd
	then
		reponse=$partition_linux_boite
	fi

	# Partition sauvegardÃ©e
	echo " `cat $chemin_langue/selection_7` " > /tmp/menu_titre
	echo "" > /tmp/menu_texte
	echo "`cat $chemin_langue/selection_8` \Zb\Z2$reponse\Z4 :\n\n " > /tmp/fichierquestion
	echo "`cat $chemin_langue/selection_9`" >> /tmp/fichierquestion
	boite_partition_sauvegardee
	
	rm -f /tmp/menu_titre
	rm -f /tmp/menu_texte
	rm -f /tmp/fichierquestion

	if ( test -e /tmp/sortir )
	then
        	return
	else
		perl -pi -e 's/\/dev\///g;' /tmp/tempfile
		base=`cat /tmp/tempfile`	# hdaiii
		rm -f /tmp/tempfile
	fi
}
#----------------------------------------------------------------------------------------------------
boite_changer_lettre()
{
sfdisk -l 2>/dev/null | grep -i "^\/dev\/$lettre_remplacee" | grep -v "swap" | grep -v "Ext'd" | grep -v "Empty" > /tmp/fichier_partition_remplacee

# Partition sauvegardÃ©e
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/selection_7` " \
	--ok-label "`cat $chemin_langue/menu_279`" --cancel-label "`cat $chemin_langue/menu_280`" \
	--extra-button --extra-label "`cat $chemin_langue/Accepter`" \
	--help-button --help-label "`cat $chemin_langue/Annuler`" \
	--menu "\n \Zb\Z1ATTENTION : \Zn " 8 75 0 \
	"" "\Zn\Z2`cat /tmp/temp_fichier_texte` " \
	"" "\Zn\Z2`cat /tmp/temp_fichier_texte1` "
nouvelle_lettre_sauvegarde=$?
case $nouvelle_lettre_sauvegarde in
    3)	# accepter
	rm -f /tmp/temp_fichier_texte
	rm -f /tmp/temp_fichier_texte1
	rm -f /tmp/fichier_partition_remplacee
	base=$test_base
	echo "$base" > $partition_linux/oscar/partition_sauvegardee
	# fdisk -s /dev/$base > $partition_linux/oscar/$taille_partition_de_base
	df -P | grep /dev/$base | tail -n 1 | awk '{print $2}' > $partition_linux/oscar/$taille_partition_de_base
	;;
    1)  # autre
	rm -f /tmp/temp_fichier_texte
	rm -f /tmp/temp_fichier_texte1
	rm -f /tmp/fichier_partition_remplacee
	demander_partition_a_sauvegarder
	if ( test -e /tmp/sortir )
	then
        	return
	fi
	nouvelle_lettre_sauvegarde=oui
	echo "$base" > $partition_linux/oscar/partition_sauvegardee
        # fdisk -s /dev/$base > $partition_linux/oscar/$taille_partition_de_base
        df -P | grep /dev/$base | tail -n 1 | awk '{print $2}' > $partition_linux/oscar/$taille_partition_de_base
	;;
    0) 	# Voir
	echo "" > /tmp/fichier_partition_remplacee
	echo "   Device Boot Start     End   #cyls     Blocks   Id  System" > /tmp/fichier_partition_remplacee
	# sfdisk -l 2>/dev/null | grep -i "system" > /tmp/fichier_partition_remplacee
	echo "" >> /tmp/fichier_partition_remplacee
	sfdisk -l 2>/dev/null | grep -i "^\/dev\/$lettre_remplacee" | grep -v "swap" | grep -v "Ext'd" | grep -v "Empty" >> /tmp/fichier_partition_remplacee
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--colors --exit-label "`cat $chemin_langue/Retour`" \
	--textbox "/tmp/fichier_partition_remplacee" 0 0
	boite_changer_lettre
	;;
    2) 	# Annuler
	rm -f /tmp/temp_fichier_texte
	rm -f /tmp/temp_fichier_texte1
	rm -f /tmp/fichier_partition_remplacee
	echo "" > /tmp/sortir
	 ;;
    255) rm -f /tmp/temp_fichier_texte
	rm -f /tmp/temp_fichier_texte1
	rm -f /tmp/fichier_partition_remplacee
	echo "" > /tmp/sortir
	 ;;
esac
}
#----------------------------------------------------------------------------------------------------
test_partition_sauvegarde_hdai_nouveaux_noyaux()
{
# sfdisk -l 2>/dev/null | grep -i "$base" > /tmp/fichier_partitions_dif
if ! ( test -e /tmp/fichier_disque_dur )
then
	runme info_ddialog
fi
grep -i "$base" /tmp/fichier_disque_dur > /tmp/fichier_partitions_dif
test_fichier_partitions_dif_existe=`cat /tmp/fichier_partitions_dif`
rm -f /tmp/fichier_partitions_dif
if [ "$test_fichier_partitions_dif_existe" = "" ] # la partition $base n'existe pas
then
    grep -i "hd" $partition_linux/oscar/partition_sauvegardee > /tmp/test_partition_hd
    test_partition_hd=`cat /tmp/test_partition_hd`
    grep -i "sd" $partition_linux/oscar/partition_sauvegardee > /tmp/test_partition_sd
    test_partition_sd=`cat /tmp/test_partition_sd`

    if [ "$test_partition_hd" != "" ] || [ "$test_partition_sd" != "" ] # partition hd ou sd n'existe plus avec les nouveaux noyaux
    then
    	#cp -f $partition_linux/oscar/partition_sauvegardee /tmp/test_lettre_partition
	#test_lettre_partition=`cat /tmp/test_lettre_partition`
	#rm -f /tmp/test_lettre_partition
	if [ "$test_partition_hd" != "" ]	# partition hd ou sd n'existe plus avec les nouveaux noyaux
	then
		perl -pi -e 's/h/s/g;' /tmp/test_partition_hd
		test_base=`cat /tmp/test_partition_hd`
		rm -f /tmp/test_partition_hd
		lettre_remplacee=sd
	elif [ "$test_partition_sd" != "" ]
	then
		perl -pi -e 's/s/h/g;' /tmp/test_partition_sd
		test_base=`cat /tmp/test_partition_sd`
		rm -f /tmp/test_partition_sd
		lettre_remplacee=hd
	fi

	grep -ci "," $partition_linux/oscar/$taille_partition_de_base > /tmp/nbr_valeurs_tailles
	nbr_valeurs_tailles=`cat /tmp/nbr_valeurs_tailles`
	rm -f /tmp/nbr_valeurs_tailles
	if [ "$nbr_valeurs_tailles" = "0" ]
	then
		test_fichier_taille=`cat $partition_linux/oscar/$taille_partition_de_base`
	else
		cut -d"," -f1 $partition_linux/oscar/$taille_partition_de_base > /tmp/valeur_taille_image
		test_fichier_taille=`cat /tmp/valeur_taille_image`
		rm -f /tmp/valeur_taille_image
	fi

	if ( test -e /dev/$test_base )
	then
	    # fdisk -s /dev/$test_base > /tmp/taille_reelle_partition_sauvegardee
	    echo "$test_base" > /tmp/calcul_taille_partition_disque
	    runme calcul_taille_partition_MB
	    taille_reelle=`cat  /tmp/calcul_taille_partition_disque`
	    rm -f /tmp/calcul_taille_partition_disque
	    
	    if [ "$taille_reelle" = "$test_fichier_taille" ]
	    then
		echo "`cat $chemin_langue/menu_281` \Z4$test_base `cat $chemin_langue/menu_282`" > /tmp/temp_fichier_texte
		echo "" > /tmp/temp_fichier_texte1
		if [ "$serveur_lance" = "oui" ]
		then
			echo "\Z2`cat $chemin_langue/msgbox_30` \Z4$test_base \Z2`cat $chemin_langue/menu_283`, " > /tmp/temp_fichier_texte
			echo "\Z3\Zb`cat $chemin_langue/menu_284`." > /tmp/temp_fichier_texte1
		fi
		boite_changer_lettre
	    else
		echo "`cat $chemin_langue/menu_281` \Z4$test_base \Z2`cat $chemin_langue/menu_285`" > /tmp/temp_fichier_texte
		echo "`cat $chemin_langue/differente` ..." > /tmp/temp_fichier_texte1
		if [ "$serveur_lance" = "oui" ]
		then
			echo "\Z2`cat $chemin_langue/menu_286` \Z4$test_base \Z2`cat $chemin_langue/menu_287`," > /tmp/temp_fichier_texte
			echo "\Z2`cat $chemin_langue/menu_288` ? " > /tmp/temp_fichier_texte1
		fi
		boite_changer_lettre
	    fi
	else
	    # demander la partition a restaurer car ne trouve pas /dev/$test_base
	    demander_partition_a_sauvegarder
		if ( test -e /tmp/sortir )
		then
	        	return
		fi
	    nouvelle_lettre_sauvegarde=oui
	fi
    fi
fi
}
#----------------------------------------------------------------------------------------------------
mettre_le_nouveau_sysprep()
{
if ( test -e /mnt/$base/Windows/System32/sysprep/sysprep_var.xml )
then
	cp -f /tmp/new_sysprep/sysprep/* /mnt/$base/Windows/System32/sysprep/
	cp -f /mnt/$base/Windows/System32/sysprep/sysprep_var.xml /tmp/newsysprep_temp_sysprep_var.xml
	cp -f /mnt/$base/Windows/System32/sysprep/sysprep_oscar.xml /tmp/newsysprep_temp_sysprep_oscar.inf
elif ( test -e /mnt/$base/sysprep/sysprep_var.inf )
then
	cp -f /tmp/new_sysprep/sysprep/* /mnt/$base/sysprep/
	cp -f /mnt/$base/sysprep/sysprep_var.inf /tmp/newsysprep_temp_sysprep_var.inf
	cp -f /mnt/$base/sysprep/sysprep_oscar.inf /tmp/newsysprep_temp_sysprep_oscar.inf
elif ( test -e /mnt/$base/Windows/oscar_deploie/oscar_var.txt )
then
	cp -f /tmp/new_sysprep/oscar_deploie/* /mnt/$base/Windows/oscar_deploie/
	cp -f /mnt/$base/Windows/oscar_deploie/oscar_var.txt /tmp/newsysprep_temp_Windows_oscar_var.txt
elif ( test -e /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt )
then
	cp -f /tmp/new_sysprep/oscar_deploie/* /mnt/$base/WINDOWS/oscar_deploie/
	cp -f /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt /tmp/newsysprep_temp_WINDOWS_oscar_var.txt
fi
}
#----------------------------------------------------------------------------------------------------
remettre_les_nouveaux_inf_effaces()
{
if ( test -e /tmp/newsysprep_temp_sysprep_var.xml )
then
	cp -f /tmp/new_sysprep/sysprep/sysprep_var.xml /mnt/$base/Windows/System32/sysprep/sysprep_var.xml
	cp -f /tmp/new_sysprep/sysprep/sysprep_oscar.xml /mnt/$base/Windows/System32/sysprep/sysprep_oscar.xml
elif ( test -e /tmp/newsysprep_temp_sysprep_var.inf )
then
	cp -f /tmp/new_sysprep/sysprep/sysprep_var.inf /mnt/$base/sysprep/sysprep_var.inf
	cp -f /tmp/new_sysprep/sysprep/sysprep_oscar.inf /mnt/$base/sysprep/sysprep_oscar.inf
elif ( test -e /tmp/newsysprep_temp_Windows_oscar_var.txt )
then
	cp -f /tmp/new_sysprep/oscar_deploie/oscar_var.txt /mnt/$base/Windows/oscar_deploie/oscar_var.txt
elif ( test -e /tmp/newsysprep_temp_WINDOWS_oscar_var.txt )
then
	cp -f /tmp/new_sysprep/oscar_deploie/oscar_var.txt /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt
fi
}
#----------------------------------------------------------------------------------------------------
tester_sysprep()
{
if ( test -e /tmp/new_sysprep/sysprep/sysprep_var.inf ) || ( test -e /tmp/new_sysprep/sysprep/sysprep_var.xml ) || ( test -e /tmp/new_sysprep/oscar_deploie/oscar_var.txt )
then
	if ( test -e /tmp/new_sysprep/oscar_deploie/oscar_var.txt )
	then
		verifie_new_sysprep_oscar_deploie=`cat /tmp/new_sysprep/oscar_deploie/oscar_var.txt`
		if [ "$verifie_new_sysprep_oscar_deploie" != "oscar_var_new_sysprep" ]
		then
			mettre_le_nouveau_sysprep
		fi
	else
		mettre_le_nouveau_sysprep
	fi
fi

if ( test -e /mnt/$base/sysprep/sysprep_var.inf ) || ( test -e /mnt/$base/Windows/System32/sysprep/sysprep_var.xml ) || ( test -e /mnt/$base/Windows/oscar_deploie/oscar_var.txt ) || ( test -e /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt )
then
	if ( test -e /mnt/$base/sysprep/sysprep_oscar.inf ) || ( test -e /mnt/$base/Windows/System32/sysprep/sysprep_oscar.xml ) || ( test -e /mnt/$base/Windows/oscar_deploie/oscar_var.txt ) || ( test -e /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt )
	then
		echo "$partition_linux" > /tmp/partition_linux_pour_sysprep
		if ! ( test -e $partition_linux/oscar/var_poste/numero_poste_client )
		then
			# Vous utilisez sysprep
			texte_input_box=`cat $chemin_langue/inputbox_37`
			if ( test -e /mnt/$base/Windows/oscar_deploie/oscar_var.txt ) || ( test -e /mnt/$base/WINDOWS/oscar_deploie/oscar_var.txt )
			then
				texte_input_box=`cat $chemin_langue/inputbox_37a`
			fi
			DIALOGRC="/etc/dialogrc" dialog --colors \
			--backtitle "`cat /etc/banniere_oscar`" \
			--cancel-label "`cat $chemin_langue/Annuler`"  --title " `cat $chemin_langue/inputbox_1` " \
			--inputbox "\n$texte_input_box" 12 50 2>/tmp/tempfile
			case $? in
			    0)	rm -f /tmp/fichier_disque_dur
				teste_numero_client test_caractere
				if ( test -e /tmp/sortir )
			        then
			        	rm -f /tmp/tempfile
		    			rm -f /tmp/sortir
		    			return
				else
					cp -f /tmp/tempfile $partition_linux/oscar/var_poste/numero_poste_client
					rm -f /tmp/tempfile
				fi
				;;
			    1)  rm -f /tmp/fichier_disque_dur
				rm -f /tmp/tempfile
			        # echo "" > /tmp/sortir
				return;;
			    255) rm -f /tmp/fichier_disque_dur
				rm -f /tmp/tempfile
			        # echo "" > /tmp/sortir
				return;;
			esac
		fi
		
		if [ "$verifie_new_sysprep_oscar_deploie" != "oscar_var_new_sysprep" ]
		then
			echo "" > /tmp/rst_new_sysprep
		fi
		sysprep
		
		if ( test -e /tmp/new_sysprep/sysprep/sysprep_var.inf ) || ( test -e /tmp/new_sysprep/sysprep/sysprep_var.xml ) || ( test -e /tmp/new_sysprep/oscar_deploie/oscar_var.txt )
		then
			if ( test -e /tmp/new_sysprep/oscar_deploie/oscar_var.txt )
			then
				if [ "$verifie_new_sysprep_oscar_deploie" != "oscar_var_new_sysprep" ]
				then
					remettre_les_nouveaux_inf_effaces
				fi
			else
				remettre_les_nouveaux_inf_effaces
			fi
			
		fi
		if ( test -e oscar/var_poste/numero_poste_client )
		then
			rm -f /mnt/$base/nom_oscar_poste
			Poste_OSCAR=`cat oscar/var_poste/numero_poste_client`
			echo "$Poste_OSCAR" > /mnt/$base/nom_oscar_poste.txt
		fi
	fi
elif ( test -e oscar/oscar.bat ) # inutile sur un poste individuel apres une sauvegarde oscar.bat supprime par sauve
then
	echo "
" > /tmp/netsh_oscar_bat
	echo ".
" > /tmp/ip_oscar_bat
	echo "" > oscar_modifstartup_ip.reg

	if ! ( test -e /mnt/$base/demarre_oscar )
	then
		mkdir /mnt/$base/demarre_oscar
	fi
	if ( test -e oscar/var_poste/numero_poste_client )
	then
		if ( test -e oscar/var_poste/salle_clients )
		then
			cut -d";" -f1 oscar/var_poste/salle_clients > /tmp/numero_salle
			cut -d";" -f2 oscar/var_poste/salle_clients > /tmp/separateur_salle
			Poste_OSCAR=`cat /tmp/numero_salle``cat /tmp/separateur_salle``cat oscar/var_poste/numero_poste_client`
			echo "$Poste_OSCAR" > /tmp/nom_oscar_poste
			#	si IP demandÃ© installation dans oscar_modifstartup.reg
			cp -f oscar/var_poste/ip_masque /tmp/ip_masque
			cp -f oscar/var_poste/ip_passerelle /tmp/ip_passerelle
			cp -f oscar/var_poste/ip_format /tmp/ip_format
			cp -f oscar/var_poste/numero_poste_client /tmp/numero_poste_client
			installe_ip	#	si IP demandÃ© installation dans oscar_modifstartup.reg
			rm -f /tmp/ip_masque
			rm -f /tmp/ip_passerelle
			rm -f /tmp/ip_format
			rm -f /tmp/numero_poste_client

		else
			echo "" > /tmp/nom_oscar_poste
		fi
	else
		echo "" > /tmp/nom_oscar_poste
	fi
	if ( test -e /mnt/$base/oscar/newsid.exe )
	then
		mettre_dom_nom_poste
	else
		mettre_nom_poste
	fi
	cp -f oscar.bat /mnt/$base
	cp -f oscar_modifstartup_nom.reg /mnt/$base
	cp -f fin_numero_poste_oscar.reg /mnt/$base
	cp -f fin_numero_poste_oscar.bat /mnt/$base/demarre_oscar
	cp -f /tmp/delay.vbs /mnt/$base/demarre_oscar
	if ( test -e oscar_nettoie_numero_poste.reg )
	then
		cp -f oscar_nettoie_numero_poste.reg /mnt/$base
	fi
	
	rm -f /tmp/nom_oscar_poste
	rm -f /tmp/numero_salle
	rm -f /tmp/separateur_salle
	rm -f $partition_linux/oscar.bat
	rm -f $partition_linux/oscar_modifstartup_nom.reg
	rm -f $partition_linux/fin_numero_poste_oscar.reg
	rm -f $partition_linux/fin_numero_poste_oscar.bat
	rm -f $partition_linux/oscar_nettoie_numero_poste.reg
	rm -f /tmp/delay.vbs
fi
}
#----------------------------------------------------------------------------------------------------
boites_table_partitions()
{
	# # la table de partition ne permet pas la restauration de cette sauvegarde
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors  \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Quitter`" --cancel-label "`cat $chemin_langue/Partitions`" \
	--extra-button --extra-label "`cat $chemin_langue/Partitionner`" \
	--title " `cat $chemin_langue/menu_709` " \
	--menu "\n\Zb\Z3`cat $chemin_langue/menu_710`" 0 0 0  \
	"" "\Zb\Z3`cat $chemin_langue/Choisissez` : \Zn " \
	"" "" \
	"" "\Zb\Z4`cat $chemin_langue/Quitter` : \Zn\Z2`cat $chemin_langue/menu_714` \Zn " \
	"" "\Zb\Z4`cat $chemin_langue/Partitionner` : \Zn\Z2`cat $chemin_langue/menu_715` \Zn " \
	"" "\Zb\Z4`cat $chemin_langue/Partitions` : \Zn\Z2`cat $chemin_langue/menu_716` \Zn " \
	"" " "
      case $? in
	    0)	# Quitter
	        rm -f /tmp/fichier_partitions_tables
	        umount -a 2>/dev/null ; sync
	        exit
		;;
	    3)  # Partitionner
	        calendrier=$(date +%y.%m.%d)
		heure=$(date +%kh.%Mmin)
		echo "$calendrier-$heure" > /tmp/date_heure
		perl -pi -e 's/ //g;' /tmp/date_heure
		date_heure=`cat /tmp/date_heure`
		rm -f /tmp/date_heure
		mkdir oscar/mbr_$date_heure
		# sauvegarde ancien mbr :
		# sfdisk -d /dev/$disque_boot_poste > oscar/mbr_$date_heure/table_partitions.sf 2>/dev/null
		echo "$disque_boot_poste" > /tmp/disque_table_sauvegarder_sf
		runme sauver_table_partition_sf
		cp -f /tmp/disque_table_sauvegarder_sf oscar/mbr_$date_heure/table_partitions.sf
		rm -f /tmp/disque_table_sauvegarder_sf
		dd if=/dev/$disque_boot_poste of=oscar/mbr_$date_heure/table_partitions.mbr count=1 bs=512 2>/dev/null
		# installer celui de la sauvegarde :
	    	# sfdisk -f /dev/$disque_boot_poste < oscar/table_partitions.sf 2>/dev/null	# il est oblogatoire aprÃ¨s d'attendre 5 secondes pour continuer
	    	echo "$disque_boot_poste" > /tmp/disque_installer_table_sf
		cp -f oscar/table_partitions.sf /tmp/fichier_installer_table_sf
		runme installer_table_partition_sf
		sleep 2 # obligatoire aprÃ¨s l'installation de la table des partitions
		runme formater_ligne_partitions_vfat_gpt
		echo
		echo -e "\033[1;32m ..."
		echo
		dd if=oscar/table_partitions.mbr of=/dev/$disque_boot_poste 2>/dev/null
		sleep 2 # obligatoire aprÃ¨s le mbr
	    	;;
	    1)  # Partitions : Voir les partitions
	    	dialog  --colors --backtitle "`cat /etc/banniere_oscar`" \
			--title " \Z2 \Zn `cat $chemin_langue/menu_709` \Z2\Zn " \
			--exit-label "`cat $chemin_langue/Retour`" --textbox "/tmp/fichier_partitions_tables" 0 0
	    	boites_table_partitions
	    	;;
	    255) rm -f /tmp/fichier_partitions_tables
	        umount -a 2>/dev/null ; sync
		exit
		;;
	esac 
}
#----------------------------------------------------------------------------------------------------
tester_tables_partitions()
{
	passe_sp_boites_table_partitions=
	partition_sauvegardee_poste=`cat oscar/partition_sauvegardee`
	disque_boot_poste=`expr substr $partition_sauvegardee_poste 1 3`	# sda

	# sfdisk -d /dev/$disque_boot_poste > /tmp/table_partitions_poste.sf 2>/dev/null
	echo "$disque_boot_poste" > /tmp/disque_table_sauvegarder_sf
	runme sauver_table_partition_sf
	cp -f /tmp/disque_table_sauvegarder_sf /tmp/table_partitions_poste.sf
	rm -f /tmp/disque_table_sauvegarder_sf
	echo "" > /tmp/fichier_partitions_tables
	echo "`cat $chemin_langue/menu_711` :" >> /tmp/fichier_partitions_tables
	echo "" >> /tmp/fichier_partitions_tables
	echo "`cat /tmp/table_partitions_poste.sf`" >> /tmp/fichier_partitions_tables
	echo "" >> /tmp/fichier_partitions_tables
	echo "`cat $chemin_langue/menu_712` :" >> /tmp/fichier_partitions_tables 
	echo "" >> /tmp/fichier_partitions_tables
	
	if ( test -e oscar/table_partitions.sf )
	then
		echo "`cat oscar/table_partitions.sf`" >> /tmp/fichier_partitions_tables
		echo "" >> /tmp/fichier_partitions_tables
		if ( test -e oscar/table_partitions.mbr )
		then
			grep -i "$partition_sauvegardee_poste" /tmp/table_partitions_poste.sf > /tmp/table_partitions.sf_poste
			perl -pi -e 's/size=/{/g;' /tmp/table_partitions.sf_poste
			cut -d"{" -f2 /tmp/table_partitions.sf_poste > /tmp/table_partitions.sf_poste1
			cut -d"," -f1 /tmp/table_partitions.sf_poste1 > /tmp/valeur_partition_sauvegarde_poste
			
			perl -pi -e 's/\/dev\/hd/\/dev\/sd/g;' oscar/table_partitions.sf
			grep -i "$partition_sauvegardee_poste" oscar/table_partitions.sf > /tmp/table_partitions.sf_sauvegarde
			perl -pi -e 's/size=/{/g;' /tmp/table_partitions.sf_sauvegarde
			cut -d"{" -f2 /tmp/table_partitions.sf_sauvegarde > /tmp/table_partitions.sf_sauvegarde1
			cut -d"," -f1 /tmp/table_partitions.sf_sauvegarde1 > /tmp/valeur_partition_sauvegarde_sauvegarde
			
			valeur_partition_sauvegarde_poste=`cat /tmp/valeur_partition_sauvegarde_poste`
			valeur_partition_sauvegarde_sauvegarde=`cat /tmp/valeur_partition_sauvegarde_sauvegarde`
			
			rm -f /tmp/table_partitions_poste.sf
			rm -f /tmp/table_partitions.sf_poste
			rm -f /tmp/table_partitions.sf_poste1
			rm -f /tmp/valeur_partition_sauvegarde_poste
			rm -f /tmp/table_partitions.sf_sauvegarde
			rm -f /tmp/table_partitions.sf_sauvegarde1
			rm -f /tmp/valeur_partition_sauvegarde_sauvegarde
			
			# les 2 valeurs doivent etre egales pour etre sur:
			valeur_partition_sauvegarde_poste=$[$valeur_partition_sauvegarde_poste+1]
			if [ "$valeur_partition_sauvegarde_poste" != "$valeur_partition_sauvegarde_sauvegarde" ]
			then
				valeur_plus_petite=$[$valeur_partition_sauvegarde_poste-$valeur_partition_sauvegarde_sauvegarde]
				test_plus_petite=`expr substr $valeur_plus_petite 1 1`
				if [ "$test_plus_petite" = "-" ]	# partition du poste est trop petite
				then	# remettre le mbr
					umount $partition_sauvegardee_poste 2>/dev/null ; sync
					# la table de partition ne permet pas la restauration de cette sauvegarde
					boites_table_partitions
					passe_sp_boites_table_partitions=oui
				fi
			fi
		fi
	fi
	rm -f /tmp/fichier_partitions_tables
	rm -f /tmp/table_partitions_poste.sf
}
#----------------------------------------------------------------------------------------------------
tester_taille_partition_ntfs()
{
tester_tables_partitions

if ( test -e oscar/$taille_partition_de_base )
then
	grep -ci "," oscar/$taille_partition_de_base > /tmp/nbr_valeurs_tailles
	nbr_valeurs_tailles=`cat /tmp/nbr_valeurs_tailles`
	rm -f /tmp/nbr_valeurs_tailles
	if [ "$nbr_valeurs_tailles" = "0" ]
	then
		taille_partition_ntfs_sauvegardee=`cat oscar/$taille_partition_de_base`
	else
		cut -d"," -f1 oscar/$taille_partition_de_base > /tmp/valeur_taille_image
		taille_partition_ntfs_sauvegardee=`cat /tmp/valeur_taille_image`
		rm -f /tmp/valeur_taille_image
	fi
	# taille_partition_ntfs_du_poste=`fdisk -s /dev/$base` partition base ntfs non montee
	# fdisk -l | perl -pi -e 's/-//g; s/\+//g; s/\*//g;' | grep $mesure_base | tail -n 1 | awk '{print $4}' > /tmp/taille_partition_base
	# fdisk -s $mesure_base > /tmp/taille_partition_base
	echo "$mesure_base" > /tmp/calcul_taille_partition_disque
	runme calcul_taille_partition_MB
	taille_partition_ntfs_du_poste=`cat /tmp/calcul_taille_partition_disque`
	rm -f /tmp/calcul_taille_partition_disque
	taille_arrondie_poste=$[$taille_partition_ntfs_du_poste/1000]
	taille_arrrondie_sauvegardee=$[$taille_partition_ntfs_sauvegardee/1000-2]
	test_taille=$[$taille_arrondie_poste-$taille_arrrondie_sauvegardee]
	signe_negatif=`expr substr $test_taille 1 1`

	if ! [ "$signe_negatif" = "-" ]
	then
		return
	else
		if [ "$passe_sp_boites_table_partitions" = "oui" ]
		then
			dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
			--ok-label "`cat $chemin_langue/Redemarrer`" \
			--cancel-label "`cat $chemin_langue/Quitter`" \
			--title " `cat $chemin_langue/Important` " \
			--menu " \n" 9 77 0 "" "`cat $chemin_langue/msgbox_45` \Zb\Z3$base\Zn"
		else
			dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
			--ok-label "`cat $chemin_langue/Continuer`" \
			--title " `cat $chemin_langue/DESOLE` " \
			--msgbox "\n\n`cat $chemin_langue/msgbox_45a` \Zb\Z3$base\Zn" 9 77
			exit
		fi
	case $? in
	    0)	reboot
	    	;;
	    1)	exit
	    	;;
	    255) exit
	    	;;
	esac
	fi
fi
}
#----------------------------------------------------------------------------------------------------
restaure_avec_ntfsclone()
{
echo "`du oscar --max-depth=1 -ma`" > /tmp/valeur2
perl -pi -e 's/oscar\//__rien_OSCAR__/g;' /tmp/valeur2
grep -v "__rien_OSCAR__" /tmp/valeur2 > /tmp/valeur1
# prendre la premiere colonne :
valeur1=`awk '{print$1}' /tmp/valeur1`
rm -f /tmp/valeur1
rm -f /tmp/valeur2

echo -e "`cat $chemin_langue/texte_30` \033[1;32m$base $texte_ecrire\033[1;34mNTFS \033[1;m...\033[1;31m"
echo -e "\033[1;m `cat $chemin_langue/Taille` = $valeur1 Mo\033[1;31m"
echo
cat oscar/image.ntfs.* | gunzip -c | ntfsclone --restore-image --overwrite /dev/$evms_oscar$base -
erreur=$?
if ! [ "$erreur" = "0" ]
then	# des erreurs
	echo
	echo -e "`cat $chemin_langue/boucle_2`"
	echo
	read p
	oscar
	exit
fi

echo "ntfs" > /tmp/besoin_type
echo "$base" > /tmp/monter_partition
runme autoriser_monter_partition_oscar
rm -f /tmp/monter_partition
rm -f /tmp/besoin_type

# taux de compression multiplie par 1 :
echo `ls -s $partition_linux/oscar/*.ntfs.* | awk '{print $1 "+" }'` > /tmp/fichiers_compresses_apres_sauvegarde
perl -pi -e 's/ //g;' /tmp/fichiers_compresses_apres_sauvegarde
taille_fichiers_compresses_apres_sauvegarde=`cat /tmp/fichiers_compresses_apres_sauvegarde`1-1
rm -f /tmp/fichiers_compresses_apres_sauvegarde
taille_fichiers_compresses_apres_sauvegarde=$[$taille_fichiers_compresses_apres_sauvegarde]

# taille des fichiers decompresses : trop long ici
#	ls -sR /mnt/$base | grep total | awk '{print $2 "+" }' > /tmp/liste_du_total_fichiers_base	# par ligne : total valeur
#	perl -pi -e 's/ //g;' /tmp/liste_du_total_fichiers_base
#	taille_fichiers_decompresses=`cat /tmp/liste_du_total_fichiers_base`1-1
#	rm -f /tmp/liste_du_total_fichiers_base

# taille des fichiers decompresses rapide
df -P | grep /dev/$base | tail -n 1 | awk '{print $3}' > /tmp/fichiers_decompresses
taille_fichiers_decompresses=`cat /tmp/fichiers_decompresses`
rm -f /tmp/fichiers_decompresses
taille_fichiers_decompresses=$[$taille_fichiers_decompresses]

# taux de compression multiplie par 100 :
taux_compression_sauvegarde=$[100*$taille_fichiers_decompresses/$taille_fichiers_compresses_apres_sauvegarde]

df -P | grep $mesure_base | tail -n 1 | awk '{print $2}' > /tmp/taille_partition_base
echo "`cat /tmp/taille_partition_base`,$taille_fichiers_decompresses,$taux_compression_sauvegarde" > $partition_linux/oscar/$taille_partition_de_base

# nettoyer desktop.ini intempestif (deja fait dans restaure_dar)
rm -f /mnt/$base/Documents\ and\ Settings/All\ Users/Menu\ DÃ©marrer/Programmes/DÃ©marrage/desktop.ini
rm -f /mnt/$base/ProgramData/Microsoft/Windows/Start\ Menu/Programs/Startup/desktop.ini
}
#----------------------------------------------------------------------------------------------------
restaurer_ntfsclone()
{
if ! ( test -e oscar/image_dar.1.dar )
then
	if ! ( test -e oscar/image_fsa.fsa )
	then
		tester_taille_partition_ntfs
	else
		mkntfs -f /dev/$base 1>/dev/null
		fsck /dev/$base -N 2>/tmp/ntfs_valide 1>/dev/null
		grep -ci ntfs /tmp/ntfs_valide > /tmp/nb_ntfs_valide
		nb_ntfs_valide=`cat /tmp/nb_ntfs_valide`
		rm -f /tmp/nb_ntfs_valide
		rm -f /tmp/ntfs_valide
		if [ "$nb_ntfs_valide" = 0 ]
		then
			echo
			echo -e " \033[1;33mOSCAR \033[1;34mcorrige la partition \033[1;32m$repertoire ntfs \033[1;34m:"
			echo
			mkfs.ext4 -qF /dev/$base
			mkntfs -f /dev/$base
		fi
	fi
else
	mkntfs -f /dev/$base 1>/dev/null
	fsck /dev/$base -N 2>/tmp/ntfs_valide 1>/dev/null
	grep -ci ntfs /tmp/ntfs_valide > /tmp/nb_ntfs_valide
	nb_ntfs_valide=`cat /tmp/nb_ntfs_valide`
	rm -f /tmp/nb_ntfs_valide
	rm -f /tmp/ntfs_valide
	if [ "$nb_ntfs_valide" = 0 ]
	then
		echo
		echo -e " \033[1;33mOSCAR \033[1;34mcorrige la partition \033[1;32m$repertoire ntfs \033[1;34m:"
		echo
		mkfs.ext4 -qF /dev/$base
		mkntfs -f /dev/$base
	fi
fi
rm -f /tmp/partition_ntfs_sauvegardee
if ! ( test -e oscar/image_dar.1.dar )
then
	echo "" > /tmp/sauve_diag
	if ( test -e /tmp/sauve_diag )
	then
		echo "$partition_linux/oscar" > /tmp/partition_restaure_dar
		echo "$base" > /tmp/base_restaure_dar
		echo "$texte_ecrire" > /tmp/texte_ecrire
		if ! ( test -e oscar/image_fsa.fsa )
		then
			echo "234" > /tmp/correcteur_compression_restaure
			restaure_dar restaure_ntfsclone
		else # avec oscar/image_fsa.fsa
			echo "182" > /tmp/correcteur_compression_restaure
			echo "partition_ntfs_sauvegardee" > /tmp/partition_ntfs_sauvegardee
			restaure_dar restaure_fsa
		fi
		rm -f /tmp/sauve_diag
		if ( test -e /tmp/sortir )
	 	then
	 		rm -f /tmp/sortir
	 		oscar
			exit
	 	fi
	else
		restaure_avec_ntfsclone
	fi
fi

if ( test -e oscar/image_dar.1.dar )
then
	echo "ntfs" > /tmp/besoin_type
	echo "$base" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	rm -f /tmp/monter_partition
	rm -f /tmp/besoin_type

	echo "$partition_linux/oscar" > /tmp/partition_restaure_dar
	echo "$base" > /tmp/base_restaure_dar
	echo "234" > /tmp/correcteur_compression_restaure
	echo "$texte_ecrire" > /tmp/texte_ecrire
	restaure_dar
 	if ( test -e /tmp/sortir )
 	then
 		rm -f /tmp/sortir
 		oscar
		exit
 	fi
fi

tester_sysprep	# teste sysprep et newsid
umount /mnt/$base 2>/dev/null ; sync
}
#-----------------------------------------------------------------------------------------------------
montage_nfs_avec_controle()
{
tftpboot_partage=`cat /tmp/partage_tftpboot_serveur 2>/dev/null`
test_reseau_nfs=$?	# /tmp/partage_tftpboot_serveur n'existe pas
if [ "$test_reseau_nfs" != 0 ]
then
	echo
	echo -e "\033[1;31m  `cat $chemin_langue/menu_665a`"
	echo
	if ! ( test -e /etc/avahi/oscar_avahi )
	then
		echo -e " `cat $chemin_langue/boucle_2`"
		read p
	fi
	rst
	return
fi
rm -f /tmp/partage_tftpboot_serveur

mount "$ip_serveur":/tftpboot /mnt/serveur_nfs 1>/dev/null 2>/dev/null	# serveur_nfs est le repertoire oscar du serveur
sleep 4

grep -ci "/mnt/serveur_nfs" /etc/mtab > /tmp/test_deja_monte_nfs
test_deja_monte_nfs=`cat /tmp/test_deja_monte_nfs`
rm -f /tmp/test_deja_monte_nfs
if [ "$test_deja_monte_nfs" = "0" ]
then
	montage_nfs_avec_controle
	return
	#	echo
	#	echo -e "\033[1;31m  `cat $chemin_langue/menu_665a`"
	#	echo
	#	echo -e "  `cat $chemin_langue/boucle_2`"
	#	read p
	#	exit
else
	return
fi
}
#-----------------------------------------------------------------------------------------------------
mise_en_reseau_asynchrone()	# si demarrage serveur_pxe
{
	perl -pi -e 's/netboot=http/{/g;' /tmp/test_line
	cut -d"{" -f2 /tmp/test_line > /tmp/test_line1
	cut -d"/" -f3 /tmp/test_line1 > /tmp/test_line
	ip_serveur=`cat /tmp/test_line`
	rm -f /tmp/test_line
	rm -f /tmp/test_line1

# mise en réseau nfs :
# montage linux   monter un répertoire oscar distant avec le protocole de linux

	if ! ( test -e /mnt/serveur_nfs )
	then
		mkdir /mnt/serveur_nfs
	fi
	echo
	echo -e "`cat $chemin_langue/texte_21` \033[1;32m$ip_serveur \033[1;34m... \033[1;m"
	echo
	
	runme recuperer_IP
	mac_adresse_poste=`cat /tmp/mac_adresse`
	
	/etc/init.d/nfs restart 1>/dev/null 2>/dev/null
	montage_nfs_avec_controle

	echo -e "\033[1;34m       `cat $chemin_langue/texte_19`\033[1;32m $mac_adresse_poste \033[1;34m`cat $chemin_langue/texte_20`\033[1;m"
	echo	
	echo "/mnt/serveur_nfs : montÃ© rÃ©seau linux" >> /tmp/historique

	# indiquer au serveur_pxe poste en fonctionnement
	echo "$mac_adresse_poste" >> /mnt/serveur_nfs/client_pxe
}
#----------------------------------------------------------------------------------------------------
formater_linux_et_monte()
{
partition_non_linux=non
grep -i $base /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
nb_partition_linux=`cat /tmp/nb_partition_linux`
rm -f /tmp/nb_partition_linux
if [ "$nb_partition_linux" = "1" ] # partition linux non swap
then
	fsck /dev/$evms_oscar$base -N > /tmp/fs_type
	grep -ci "ext3" /tmp/fs_type > /tmp/nb_fstype
	valeur=`cat /tmp/nb_fstype`
	if [ "$valeur" = "1" ] # partition ext3
	then
		echo
		echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ext3\033[1;m ... "
		echo
		mkfs.ext3 -qF /dev/$evms_oscar$base -U `cat /tmp/valeur_UUID_base` 2>/dev/null
		mount -t ext3 /dev/$evms_oscar$base /mnt/$base
	else
		grep -ci "ext2" /tmp/fs_type > /tmp/nb_fstype
		valeur=`cat /tmp/nb_fstype`
		if [ "$valeur" = "1" ] # partition ext2
		then
			echo
			echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ext2\033[1;m ... "
			echo
			mkfs.ext2 -qF /dev/$evms_oscar$base -U `cat /tmp/valeur_UUID_base` 2>/dev/null
			mount -t ext2 /dev/$evms_oscar$base /mnt/$base
		else
			grep -ci "reiserfs" /tmp/fs_type > /tmp/nb_fstype
			valeur=`cat /tmp/nb_fstype`
			if [ "$valeur" = "1" ] # partition ReiserFS
			then
				echo
				echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ReiserFS\033[1;m ... "
				echo
				mkfs.reiserfs -f /dev/$evms_oscar$base --uuid=`cat /tmp/valeur_UUID_base` 2>/dev/null
				mount -t reiserfs /dev/$evms_oscar$base /mnt/$base
			else
				grep -ci "xfs" /tmp/fs_type > /tmp/nb_fstype
				valeur=`cat /tmp/nb_fstype`
				if [ "$valeur" = "1" ] # partition XFS
				then
					echo
					echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux XFS\033[1;m ... "
					echo
					mkfs.xfs -f /dev/$evms_oscar$base
					xfs_admin -U `cat /tmp/valeur_UUID_base` /dev/$evms_oscar$base
					mount -t xfs /dev/$evms_oscar$base /mnt/$base
				else
					grep -ci "jfs" /tmp/fs_type > /tmp/nb_fstype
					valeur=`cat /tmp/nb_fstype`
					if [ "$valeur" = "1" ] # partition JFS
					then
							echo
							echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux JFS\033[1;m ... "
							echo
							mkfs.jfs -q /dev/$evms_oscar$base -J UUID=`cat /tmp/valeur_UUID_base`
							mount -t jfs /dev/$evms_oscar$base /mnt/$base
					else
							# reiser4 non encore reconnu dans nb_fstype
							grep -ci "reiser4" /tmp/fs_type > /tmp/nb_fstype
							valeur=`cat /tmp/nb_fstype`
							if [ "$valeur" = "1" ] # partition reiser4
							then
							echo
							echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux reiser4\033[1;m ... "
							echo
							# le formatage est pour l'instant reiserfs car lib de mkfs.reiser4 non installe
							mkfs.reiser4 -f /dev/$evms_oscar$base -U `cat /tmp/valeur_UUID_base` 2>/dev/null
							mount -t reiser4 /dev/$evms_oscar$base /mnt/$base
						else
							grep -ci "ext4" /tmp/fs_type > /tmp/nb_fstype
							valeur=`cat /tmp/nb_fstype`
							if [ "$valeur" = "1" ] # partition ext4
							then
								echo
								echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ext4\033[1;m ... "
								echo
								mkfs.ext4 -qF /dev/$evms_oscar$base -U `cat /tmp/valeur_UUID_base` 2>/dev/null
								mount -t ext4 /dev/$evms_oscar$base /mnt/$base
							else # autres cas non trouvÃ©s
								echo
								echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux ext3\033[1;m ... "
								echo
								mkfs.ext3 -qF /dev/$evms_oscar$base -U `cat /tmp/valeur_UUID_base` 2>/dev/null
								mount -t ext3 /dev/$evms_oscar$base /mnt/$base
							fi
						fi
 					fi
				fi
    			fi
		fi
	fi
	rm -f /tmp/fs_type
	rm -f /tmp/nb_fstype
else
	grep -i $base /tmp/fichier_disque_dur | grep -ci swap > /tmp/nb_partition_swap
	nb_partition_swap=`cat /tmp/nb_partition_swap`
	rm -f /tmp/nb_partition_swap
	if [ "$nb_partition_swap" = "1" ] # partition swap linux
	then  # partition linux swap
		echo
		echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mLinux swap\033[1;m ... "
		echo
		mkfs.ext3 -qF /dev/$evms_oscar$base -U `cat /tmp/valeur_UUID_base` 2>/dev/null
		mkswap -f /dev/$evms_oscar$base  1>/dev/null
		# mount /dev/$evms_oscar$base /mnt/$base
	else
		partition_non_linux=oui
	fi
fi
rm -f /tmp/valeur_UUID_base
}
#----------------------------------------------------------------------------------------------------
prendre_valeur_uuid_base()
{
blkid /dev/$evms_oscar$base -s UUID | cut -d"\"" -f2 > /tmp/valeur_UUID_base
}
#----------------------------------------------------------------------------------------------------
vider_partition()
{
#echo
#echo -e "  `cat $chemin_langue/texte_66` \033[0;32m$base\033[1;34m ...\033[1;m"
#echo

rm -f /tmp/fin_vidage
rm -fR /mnt/$base/*
echo "" > /tmp/fin_vidage
}
#----------------------------------------------------------------------------------------------------
bargraphe_vider()
{
pourcentage_oscar=0
valeur_fin_oscar=0
while [ "$valeur_fin_oscar" != 1 ]
do
	sleep 1
	# taille du vidage
	df -P | grep $mesure_base | tail -n 1 | awk '{print $3}' > /tmp/taille_vidage
	taille_vidage=`cat /tmp/taille_vidage`
	rm -f /tmp/taille_vidage
	taille_vidage=$[$taille_vidage]

	pourcentage_oscar=$[100*($taille_partition_de_base_avant_vidage-$taille_vidage)/$taille_partition_de_base_avant_vidage]

	if ( test -e /tmp/fin_vidage )
	then
		valeur_fin_oscar=1
		pourcentage_oscar=100
	fi
	pourcentage_oscar=$[$pourcentage_oscar]
	echo $pourcentage_oscar
done | DIALOGRC="/etc/dialogmenu_bloque" dialog --colors\
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " OSCAR " \
	--gauge "\n  `cat $chemin_langue/texte_66a` \Z2$base \n\n
	\n  `cat $chemin_langue/menu_74`\n\n  \Zb\Z2`cat $chemin_langue/Patience` ... " 12 80
rm -f /tmp/fin_vidage
}
#----------------------------------------------------------------------------------------------------
enregistrer_cles_ssh_avant_restaure() # ici mais pas en client
{
mkdir /tmp/ssh_avant_restaure 1>/dev/null 2>/dev/null
cp -f /mnt/$base/etc/ssh/ssh_host_*key* /tmp/ssh_avant_restaure/ 1>/dev/null 2>/dev/null
}
#----------------------------------------------------------------------------------------------------
remettre_cles_ssh_apres_restaure()
{
if ( test -e /tmp/ssh_avant_restaure )
then
	cp -f /tmp/ssh_avant_restaure/* /mnt/$base/etc/ssh/ 1>/dev/null 2>/dev/null
	rm -fr /tmp/ssh_avant_restaure
fi
}
#----------------------------------------------------------------------------------------------------
#  commandes externes de procÃ©dures
case "$1" in
    serveur)
    	base=`cat /tmp/base_sauvegarde_serveur`
    	partition_linux=`cat /tmp/linux_sauvegarde_serveur`
    	rm -f /tmp/linux_sauvegarde_serveur
    	rm -f /tmp/base_sauvegarde_serveur
    	if [ "$partition_linux" = "" ]	# car dÃ©marrage dd
    	then
    		grep -i "\/dev\/" /proc/cmdline > /tmp/test_line
    		test_line=`cat /tmp/test_line`
    		if [ "$test_line" = "" ]	# car dÃ©marrage dd
    		then	# remplacer UUID par sdai
    			grep -i "UUID" /proc/cmdline > /tmp/test_line
    			test_line=`cat /tmp/test_line`
			perl -pi -e 's/=UUID=/;/g; s/ /;/g;' /tmp/test_line
    			cut -d";" -f2 /tmp/test_line > /tmp/temp_sdai
    			installe_oscar_dd remplacer_uuid_par_sdai
    			partition_linux_boite=`cat /tmp/temp_sdai`
    			rm -f /tmp/temp_sdai
    		else	# prendre sdai
    			perl -pi -e 's/\/dev\//;/g; s/ /;/g;' /tmp/test_line
    			cut -d";" -f2 /tmp/test_line > /tmp/linux_sauvegarde_serveur
    			partition_linux_boite=`cat /tmp/linux_sauvegarde_serveur`
    			rm -f /tmp/linux_sauvegarde_serveur
    		fi
    		rm -f /tmp/test_line
    	else
	    partition_linux_boite=`expr substr $partition_linux 6 6`
	fi
    	serveur_lance=oui
    	test_partition_sauvegarde_hdai_nouveaux_noyaux
	exit 0
	;;
esac

rm -fr /tmp/ssh_avant_restaure

if ! ( test -e /etc/cdrom_ejecte )
then
	if ( test -e /etc/demarrage_cdcache )
	then
		echo "" > /etc/cdrom_ejecte	# cd ejecte
		# umount /mnt/cdrom 2>/dev/null  ; sync
		eject
	fi
fi

if ( test -e /usr/share/oscar/usr/initialise )
then
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/Information` " \
	--infobox "\n\Z1\Zb`cat $chemin_langue/msgbox_78a` ...\Zn " 14 55
	sleep 12
fi

type="linux"
image_trouvee=non
if ! ( test -e /tmp/menu_admin_rst )
then
	boucle_partition
else
	image_trouvee=oui
	partition_linux=`cat /tmp/linux_sauvegarde_rst`
	rm -f /tmp/linux_sauvegarde_rst
	if [ "$partition_linux" = "non" ]	# pas d'image sur le poste
	then
		image_trouvee=non
	fi
fi

if [ "$image_trouvee" = "oui" ]
then
	if ( test -e /tmp/new_sysprep/sysprep/sysprep_var.inf ) || ( test -e /tmp/new_sysprep/sysprep/sysprep_var.xml ) || ( test -e /tmp/new_sysprep/oscar_deploie/oscar_var.txt )
	then
		if ( test -e $partition_linux/oscar/date_de_sauvegarde )
		then
			grep -i "sysprep" $partition_linux/oscar/date_de_sauvegarde > /tmp/temp_new_sysprep
			grep -i "oscar_deploie" $partition_linux/oscar/date_de_sauvegarde >> /tmp/temp_new_sysprep
			temp_new_sysprep=`cat /tmp/temp_new_sysprep`
			rm -f /tmp/temp_new_sysprep
			texte_boite=`cat $chemin_langue/msgbox_2b`
			if ( test -e /tmp/new_sysprep/oscar_deploie/oscar_var.txt )
			then
				texte_boite=`cat $chemin_langue/msgbox_2ba`
			fi
			if [ "$temp_new_sysprep" = "" ]
			then
				DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
				--backtitle "`cat /etc/banniere_oscar`" \
				--title " `cat $chemin_langue/DESOLE` " \
				--ok-label "`cat $chemin_langue/Continuer`"  \
				--msgbox "\n\Zb\Z1`cat $chemin_langue/msgbox_2b`" 7 50
				case $? in
				    0) 	echo "" > /tmp/sortir
				    	exit
				    	;;
				    255) echo "" > /tmp/sortir
				    	exit
				    	;;
				esac
			fi
		fi
	fi
	
	grep -i "menuoscar=restaure" /proc/cmdline > /tmp/test_restaure_poste	# demarrage client restaure depuis poste
	test_restaure_poste=`cat /tmp/test_restaure_poste`
	rm -f /tmp/test_restaure_poste
	if [ "$test_restaure_poste" = "" ] # mettre en reseau seulement si client pxe
	then
		grep -i "netboot=http" /proc/cmdline > /tmp/test_line	# demarrage serveur_pxe
		test_line=`cat /tmp/test_line`
		if [ "$test_line" != "" ]
		then
			mise_en_reseau_asynchrone
		else
			rm -f /tmp/test_line
		fi
	fi
	
	cd $partition_linux
	if ! ( test -e $partition_linux/oscar )
	then
		mkdir $partition_linux/oscar
	fi
	
	rm -f /tmp/partition_lvm_existe
	if ! ( test -e $partition_linux/oscar/partition_sauvegardee )
	then
		demander_partition_a_sauvegarder
		if ( test -e /tmp/sortir )
		then
	        	rm -f /tmp/sortir
	        	exit
		fi
		echo "$base" > $partition_linux/oscar/partition_sauvegardee
	else
		base=`cat $partition_linux/oscar/partition_sauvegardee`
		test_partition_sauvegarde_hdai_nouveaux_noyaux
		if ( test -e /tmp/sortir )
		then
			exit 0
		fi
		
		base_initiale=$base
		if ( test -e $partition_linux/oscar/taille_partition_$base_initiale )
		then
			cp -f $partition_linux/oscar/taille_partition_$base $partition_linux/oscar/taille_part_base_initiale
		fi
		if ( test -e /tmp/menu_admin_rst )
		then
			rm -f /tmp/menu_admin_rst
			echo "$base" > /tmp/partition_base
			echo "$partition_linux" > /tmp/tempfile
			if ! [ "$partition_linux" = "" ]
			then
				echo "$partition_linux" > /tmp/tempfile
				runme selection_disque        # donne le nom_simple
				cp -f /tmp/nom_simple /tmp/partition_linux_sauvegarde_base
				rm -f /tmp/tempfile
				rm -f /tmp/nom_simple
				rm -f /tmp/disque
			else	# demarrage oscar par disque dur
				echo "$partition_sauvegarde_oscar" > /tmp/partition_linux_sauvegarde_base
			fi
			
			if ! [ "$nouvelle_lettre_sauvegarde" = "oui" ]
			then
				runme choix_partition_restauration
				if ( test -e /tmp/sortir )
				then
					rm -f /tmp/sortir
					exit
				fi
			fi
			base=`cat /tmp/partition_base`
			rm -f /tmp/partition_base
			rm -f /tmp/partition_linux_sauvegarde_base

			cp -f $partition_linux/oscar/taille_part_base_initiale $partition_linux/oscar/taille_partition_$base
		fi
		if [ "$base_initiale" = "$base" ]
		then
			rm -f $partition_linux/oscar/taille_partition_*
			cp -f $partition_linux/oscar/taille_part_base_initiale $partition_linux/oscar/taille_partition_$base
		fi
		rm -f $partition_linux/oscar/taille_part_base_initiale
	fi
	
	if ! ( test -e /tmp/partition_lvm_existe )
	then
		echo "$base" > /tmp/test_base_lvm
		sauve cherche_base_lvm
	fi
	if ! ( test -e /tmp/partition_lvm_existe )
	then
		mesure_base=/dev/$base
		taille_partition_de_base=taille_partition_$base
		sauvegarde_de_base=sauvegarde_$base
	else
		# id_type=lvm
	#	cp -f /tmp/partition_lvm_cherchee /tmp/mesure_base_lvm
	#	perl -pi -e 's/-/}/g;' /tmp/mesure_base_lvm
	#	mesure_base="`cat /tmp/mesure_base_lvm` "
	#	rm -f /tmp/mesure_base_lvm
		mesure_base="/dev/mapper/`cat /tmp/partition_lvm_cherchee` "
		taille_partition_de_base=taille_partition_`cat /tmp/partition_lvm_cherchee`
		sauvegarde_de_base=sauvegarde_`cat /tmp/partition_lvm_cherchee`
	fi

	rm -f /tmp/tempfile
	if ! ( test -e $partition_linux/oscar/$taille_partition_de_base )
	then	# installe le fichier de la taille de la partition restaurÃ©e
		# fdisk -s /dev/$base > $partition_linux/oscar/$taille_partition_de_base
		df -P | grep $mesure_base | tail -n 1 | awk '{print $2}' > $partition_linux/oscar/$taille_partition_de_base
	fi

	grep -ci "," $partition_linux/oscar/$taille_partition_de_base > /tmp/nbr_valeurs_tailles
	nbr_valeurs_tailles=`cat /tmp/nbr_valeurs_tailles`
	rm -f /tmp/nbr_valeurs_tailles
	if [ "$nbr_valeurs_tailles" = "0" ]
	then
		taille_image=`cat $partition_linux/oscar/$taille_partition_de_base`
	else
		cut -d"," -f1 $partition_linux/oscar/$taille_partition_de_base > /tmp/valeur_taille_image
		taille_image=`cat /tmp/valeur_taille_image`
		rm -f /tmp/valeur_taille_image
	fi

	if ! ( test -e $partition_linux/oscar/date_de_sauvegarde )
	then
		date=$(date +%d-%m-%y)
		echo "`cat $chemin_langue/texte_1` $date" > $partition_linux/oscar/date_de_sauvegarde		
cp -f $partition_linux/oscar/$taille_partition_de_base $partition_linux/$oscar/sauvegarde_de_base:$[$taille_image/1024].Mo_avant_$date

	fi
	info_veille
	# dÃ©monter Ã©ventuellement la partition Ã  restaurer
	rm -f /tmp/monter_partition
	echo "$base" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar_montage
	nombpart=`cat /tmp/nombpart`
	if ! [ "$nombpart" = 0 ]
	then	
		umount /mnt/$base 2>/dev/null ; sync
	fi
	if ( test -e /dev/evms/$base )
	then
		evms_oscar="evms/"
	else
		evms_oscar=
	fi
	
cd $partition_linux/
	if ( test -e oscar/partition_sauvegardee )
	then
		ecrire=`cat oscar/commentaire_oscar.txt`
		texte_ecrire="$ecrire "
	fi
	if ! ( test -e /tmp/partition_lvm_existe ) 
	then
		numero_sd=`expr substr $base 4 3`
		disque=`expr substr $base 1 3`       		#sda
		# id_type=`sfdisk /dev/$disque -c $numero_sd 2>/dev/null`
	#else
	#	id_type=lvm # rappel
	fi
    	if ! ( test -e /tmp/fichier_disque_dur )
    	then
    		runme info_ddialog
    	fi
	grep -i $base /tmp/fichier_disque_dur | grep -ci ntfs > /tmp/nb_partition_ntfs
	nb_partition_ntfs=`cat /tmp/nb_partition_ntfs`
	rm -f /tmp/nb_partition_ntfs
	if [ "$nb_partition_ntfs" = "1" ] # partition ntfs
	then
		if ! ( test -e oscar/image.partimage.000 )
		then
			restaurer_ntfsclone
		else 	# autre type de partition ou ancienne sauvegarde partimage en ntfs
			rm -f /tmp/client_udp
			rm -f /tmp/fichiertmp
			echo " " >> /tmp/fichiertmp
			
			# vous devez utiliser la version OSCAR 0.2.15
			echo "`cat $chemin_langue/msgbox_23`" >> /tmp/fichiertmp
			echo " " >> /tmp/fichiertmp
			dialog --colors --no-shadow --ok-label "`cat $chemin_langue/Continuer`" \
			--backtitle  "`cat /etc/banniere_oscar`" \
			--title " `cat $chemin_langue/msgbox_22` " \
			--msgbox "`cat /tmp/fichiertmp`" 10 60
			rm -f /tmp/fichiertmp
			eteindre_le_poste
			exit

			#	if ! ( test -e /tmp/rst_interactif )
			#	then
			#		sleep 1
			#		partimage -b -f3 restore /dev/$base oscar/image.partimage.000
			#		sleep 2 # obligatoire pour noyau 2.6
		        #	else
			#		sleep 1
			#		partimage -f3 restore /dev/$base oscar/image.partimage.000
			#		sleep 2 # obligatoire pour noyau 2.6
			#		rm -f /tmp/rst_interactif
			#	fi
		fi
	else   # autre type de partition voir si c'est une bonne image:
		if ! ( test -e /mnt/$base )
		then
			mkdir -p /mnt/$base
		fi
		
		# if ( test -e oscar/image_dar.1.dar ) || [ "$id_type" = "lvm" ]
		if ( test -e oscar/image_dar.1.dar ) || ( test -e oscar/image_fsa.fsa )
		then	
			# sfdisk -l 2>/dev/null | grep -ci /dev/mapper/ > /tmp/nb_partition_mapper
			parted -l 2>/dev/null | grep -ci lvm > /tmp/nb_partition_mapper
			nb_partition_mapper=`cat /tmp/nb_partition_mapper`
			rm -f /tmp/nb_partition_mapper
			partition_mapper_existe=non
			if [ "$nb_partition_mapper" = "0" ]
			then
				prendre_valeur_uuid_base
				mount /dev/$evms_oscar$base /mnt/$base 1>/dev/null 2>/dev/null
				enregistrer_cles_ssh_avant_restaure
				umount /mnt/$base 1>/dev/null 2>/dev/null ; sync
				formater_linux_et_monte
			else
				partition_mapper_existe=oui
			fi
			grep -i $base /tmp/fichier_disque_dur | grep -ci fat32 > /tmp/nb_partition_fat32
			nb_partition_fat32=`cat /tmp/nb_partition_fat32`
			rm -f /tmp/nb_partition_fat32
			if [ "$nb_partition_fat32" = "1" ] # partition fat32
	               	then
				echo
				echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mfat32\033[1;m ... "
				echo
				mkdosfs -vF 32 /dev/$evms_oscar$base
				mount /dev/$evms_oscar$base /mnt/$base
			else
				grep -i $base /tmp/fichier_disque_dur | grep -ci fat16 > /tmp/nb_partition_fat16
				nb_partition_fat16=`cat /tmp/nb_partition_fat16`
				rm -f /tmp/nb_partition_fat16
				if [ "$nb_partition_fat16" = "1" ] # partition fat16
		               	then
					echo
					echo -e " `cat $chemin_langue/texte_16` \033[1;34m$base \033[1;m`cat $chemin_langue/en` \033[0;32mfat16\033[1;m ... "
					echo
					mkdosfs -vF 16 /dev/$evms_oscar$base
					mount /dev/$evms_oscar$base /mnt/$base
				else
	                        	# elif [ "$id_type" = "lvm" ] || [ "$partition_mapper_existe" = "oui" ] || [ "$partition_non_linux" = "oui" ]    # partition  autre et lvm avec fsa
		                        if ( test -e oscar/image_fsa.fsa ) || [ "$partition_non_linux" = "oui" ]    # partition  autre et lvm avec fsa
		                        then
						if [ "$partition_mapper_existe" = "oui" ]
						then
							if ! ( test -e /tmp/partition_lvm_existe )
							then
								mount /dev/$evms_oscar$base /mnt/$base 1>/dev/null 2>/dev/null
								# taille utilisee dans la partition avant nettoyage
								mesure_base=/dev/$evms_oscar$base
							else
								mount /dev/mapper/`cat /tmp/partition_lvm_cherchee` /mnt/$base 1>/dev/null 2>/dev/null
								# taille utilisee dans la partition avant nettoyage
								mesure_base=/dev/mapper/`cat /tmp/partition_lvm_cherchee`
							fi
							df -P | grep $mesure_base | tail -n 1 | awk '{print $3}' > /tmp/taille_partition_de_base_avant_vidage
							enregistrer_cles_ssh_avant_restaure
						fi
						
						
						# vider la partition avant restauration pour lvm car non formatee
						if [ "$partition_mapper_existe" = "oui" ]
						then
							taille_partition_de_base_avant_vidage=`cat /tmp/taille_partition_de_base_avant_vidage`
							taille_partition_de_base_avant_vidage=$[$taille_partition_de_base_avant_vidage]
							rm -f /tmp/taille_partition_de_base_avant_vidage
							vider_partition &
							bargraphe_vider
							# if ( test -e /tmp/partition_lvm_existe ) # car sauvegarde est fsa
							# then
							#	umount /mnt/$base 2>/dev/null ; sync
							# fi
						fi
						if ( test -e oscar/image_fsa.fsa )
						then
							umount /mnt/$base 2>/dev/null ; sync
						fi
					fi
				fi
			fi
                        
                        # inutile car uuid conserve :
			#	if ! ( test -e /tmp/partition_lvm_existe )
			#	then
			#		if ! [ "$partition_mapper_existe" = "oui" ]
			#		then
			#			if ( test -e $partition_linux/oscar/table_partitions.mbr )
			#			then
			#				disque_boot=`expr substr $base 1 3`      # sda
			#				dd if=$partition_linux/oscar/table_partitions.mbr of=/dev/$disque_boot 2>/dev/null 1>/dev/null
			#				sleep 6
			#			fi
			#		fi
			#	fi
                 #      cd /mnt/$base
 
			#	dar -x $partition_linux/oscar/image_dar -R /mnt/$base -b -w -v # Ã  voir option -b
			#	if ! [ "$?" = "0" ]
			#	then	# des erreurs
		        #               umount /mnt/$base 2>/dev/null ; sync
			#		echo
			#		echo -e "`cat $chemin_langue/boucle_2`"
			#		echo
			#		read p
			#	fi
			echo "$partition_linux/oscar" > /tmp/partition_restaure_dar
			echo "$base" > /tmp/base_restaure_dar
			echo "173" > /tmp/correcteur_compression_restaure
			echo "$texte_ecrire" > /tmp/texte_ecrire
			
			if ! ( test -e oscar/image_fsa.fsa )	# image_dar
			then
				restaure_dar
			else # avec oscar/image_fsa.fsa
				echo "182" > /tmp/correcteur_compression_restaure
				restaure_dar restaure_fsa
			fi
			remettre_cles_ssh_apres_restaure
                 	if ( test -e /tmp/sortir )
                 	then
                 		rm -f /tmp/sortir
                 		rm -f /tmp/partition_lvm_existe
                 		oscar
				exit
                 	fi
			# inutile car uuid conserve :
			#	if ! ( test -e /tmp/partition_lvm_existe )
			#	then
			#		if ! [ "$partition_mapper_existe" = "oui" ]
			#		then
			#	
			#			if ( test -e /mnt/$base/etc )	# partition linux systeme
			#			then
			#				echo "" > /tmp/rst_lance
			#				echo "" > /tmp/repare_boot_dd
			#				installe_oscar_dd	# pour boot sur partition systÃ¨me linux aprÃ¨s formatage mbr local
			#			fi
			#		fi
			#	fi
			umount /mnt/$base 2>/dev/null ; sync
		else
			if ( test -e oscar/image.ntfs.00 )
			then # image NTFS mais partition de reception fat32 ou autre
				echo "$base" > /tmp/tempbase
				runme formater_ntfs
				echo
				restaurer_ntfsclone
			else
				if ( test -e oscar/image.partimage.000 )
				then
					rm -f /tmp/fichiertmp
					echo " " >> /tmp/fichiertmp
					# vous devez utiliser la version OSCAR 0.2.15
					echo "`cat $chemin_langue/msgbox_23`" >> /tmp/fichiertmp
					echo " " >> /tmp/fichiertmp
					dialog --colors --no-shadow --ok-label "`cat $chemin_langue/Continuer`" \
					--backtitle  "`cat /etc/banniere_oscar`" \
					--title " `cat $chemin_langue/msgbox_22` " \
					--msgbox "`cat /tmp/fichiertmp`" 10 60
					rm -f /tmp/fichiertmp
					eteindre_le_poste
					exit
				else
					echo
					echo -e "\033[1;31m `cat $chemin_langue/texte_48` \033[1;m"
					echo
					echo
					echo -e "`cat $chemin_langue/boucle_2`"
					echo
					read p
					oscar
					exit
				fi
			fi
		fi
	fi
cd /root/

	#	#copier les fichiers dans partition_oscar et dans demarre_oscar:
	#	if ( test -e $partition_linux/oscar/oscar.bat )
	#	then
	#		# ecrire Ã©ventuellement les fichiers pour le nom du poste:
	
	#		# erreur sur partition_oscar a remplacer par la partition a restaurer choisie
	#		partition_ecrire_oscar=`cat $partition_linux/oscar/partition_oscar`
	
	#
	#		#if ! ( test -e /mnt/$partition_ecrire_oscar )
	#		#then
	#		#    mkdir /mnt/$partition_ecrire_oscar
	#		#fi
			
	#		echo "$partition_ecrire_oscar" > /tmp/monter_partition
	#		runme autoriser_monter_partition_oscar
	#		partition_ecrire_oscar=`cat /tmp/monter_partition`
	#		rm -f /tmp/monter_partition
	#
	#		if ! ( test -e $partition_ecrire_oscar/demarre_oscar )
	#		then
	#			mkdir $partition_ecrire_oscar/demarre_oscar
	#		fi
	#		cp -f $partition_linux/oscar/oscar.bat $partition_ecrire_oscar
	#		if ( test -e $partition_linux/oscar/domaine_oscar.bat )
	#		then
	#			cp -f $partition_linux/oscar/domaine_oscar.bat $partition_ecrire_oscar/demarre_oscar
	#		fi
	#		cp -f $partition_linux/oscar/oscar_modifstartup_nom.reg $partition_ecrire_oscar
	#		cp -f $partition_linux/oscar/fin_numero_poste_oscar.reg $partition_ecrire_oscar
	#		cp -f $partition_linux/oscar/demarre_oscar/fin_numero_poste_oscar.bat $partition_ecrire_oscar/demarre_oscar
	#	fi	
	eteindre_le_poste
	exit
fi

rm -f /tmp/fichiertmp
echo " " >> /tmp/fichiertmp
echo "\n\n`cat $chemin_langue/msgbox_2`\Zn" >> /tmp/fichiertmp
echo " " >> /tmp/fichiertmp
## le timeout est nÃ©cessaire pour rapideSOS

# Informations sur la sauvegarde de ce poste
	dialog --colors --no-shadow --ok-label "`cat $chemin_langue/Continuer`" \
	--backtitle  "`cat /etc/banniere_oscar`"  \
	--title " `cat $chemin_langue/msgbox_22` " \
	--infobox "`cat /tmp/fichiertmp`" 7 60 2>/dev/null
rm -f /tmp/fichiertmp
sleep 10

eteindre_le_poste
