#!/bin/sh

## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
## Cdrom Outil Système Complet d'Assistance Réseau: OSCAR
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.


PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue


#----------------------------------------------------------------------------------------------------
boite_partition_de_sauvegarde() # selectionner seulement les partitions linux non swap
{
	runme prepare_fichier_temptaille
	rm -f /tmp/bozo
	egrep -e "^/dev" /tmp/fichier_disque_dur | grep "Linux" | grep -v "swap" |  grep -v "extended" | \
	perl -pi -e 's/\*//g;  s/\+/ /g; s/\-/ /g; s/  /:/g; s/:+/:/g;' | \
	awk 'BEGIN { FS=" " } { printf ("%0s %15s %25s\n","\""$1"\" \"",$2,$3"\" \\")}' >> /tmp/bozo

	runme boite_selection_bozo
}
#----------------------------------------------------------------------------------------------------
boite_partition_linux() # prépare la boite pour selectionner seulement les partitions linux non swap
{
	# proposer toutes les partitions linux non swap
	# Partition de sauvegarde de la table
	echo " `cat $chemin_langue/selection_65` " > /tmp/menu_titre
	echo "" > /tmp/menu_texte
	echo "\n`cat $chemin_langue/selection_2` " > /tmp/fichierquestion
	echo "\n\n`cat $chemin_langue/selection_3`" >> /tmp/fichierquestion
	boite_partition_de_sauvegarde
	rm -f /tmp/menu_titre
	rm -f /tmp/menu_texte
	rm -f /tmp/fichierquestion
	if ( test -e /tmp/sortir )
	        then
		rm -f /tmp/sortir
	        exit
	fi
	
	partition_linux=`cat /tmp/tempfile`	# /dev/hdaiii
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boucle_partition() # sortir la partition linux dans la reponse et tous les monter
{
	rm -f /tmp/tempfile
	echo "$type" > /tmp/tempfile
	runme prepare_boucle_partition
	nombretype=`cat /tmp/nombre`
	rm -f /tmp/nombre

numero=0
cp -f /tmp/tempfile /tmp/temp_ligne_deux_points
rm -f /tmp/tempfile
until  ( test  $numero = $nombretype )
    do
	rm -f /tmp/temp_ligne_deux_points1
#	rm -f /tmp/partfile1
	numero=$[$numero+1]
	cut -d":" -f$numero /tmp/temp_ligne_deux_points > /tmp/temp_ligne_deux_points1	#hdaiii
#	cut -d":" -f$numero /tmp/partfile > /tmp/partfile1	#ide/h0/b0/t0/l0/hdaiii
	reponse=`cat /tmp/temp_ligne_deux_points1`
	reparti=$reponse
	rm -f /tmp/temp_ligne_deux_points1
	if ! [ "$reponse" = "" ] # si la partition existe
	then 
		numero_hd=`expr substr $reponse 4 3`
		disque=`expr substr $reponse 1 3`	# hda
#		disque=`cut -d/ -f1-5 /tmp/partfile1`/disc	#ide/h0/b0/t0/l0/disc
#		rm -f /tmp/partfile1
	        	# id_type=`sfdisk /dev/$disque -c $numero_hd 2>/dev/null`
			grep -i $reponse /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
		        nb_partition_linux=`cat /tmp/nb_partition_linux`
		        rm -f /tmp/nb_partition_linux
			if [ "$nb_partition_linux" = "1" ] # partition linux non swap
			then
				nombre_partitions_linux=$nombretype			
				if [ "$premiere_partition_linux" = "non" ]
				then
					premiere_partition_linux=$reponse # premiere partition linux
				fi
				
				echo "$reponse" > /tmp/monter_partition
				runme autoriser_monter_partition_oscar
				partition_linux_dd=`cat /tmp/monter_partition`
				rm -f /tmp/monter_partition
				
				if ( test -e $partition_linux_dd/oscar )
				then
					if ! ( test -e $partition_linux_dd/oscar/table )
					then
						mkdir $partition_linux_dd/oscar/table
					fi
				repertoire_oscar="$partition_linux_dd/oscar/table"
				fi
			fi
	fi
#	rm -f /tmp/partfile1
    done
rm -f /tmp/tempfile
# rm -f /tmp/partfile
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
cherche_repertoire_oscar()		# recherche sur le disque dur la partition où se trouve oscar
					# cherche aussi une partition linux si pas oscar
{
type="linux"
repertoire_oscar=non
premiere_partition_linux="non"
boucle_partition
if ! [ "$premiere_partition_linux" = "non" ]  # il y a des partitions linux
then
        if [ "$repertoire_oscar" = "non" ]  # pas repertoire oscar sur les partitions linux
	then # sélectionner les partitions linux
		boite_partition_linux
		repertoire=$reponse
	        if ( test -e /tmp/sortir )
		then
		    rm -f /tmp/sortir
		    exit
		fi
	        ## donner le chemin avec peut etre sur oscar installe sur le disque dur
	        echo "$repertoire" > /tmp/linux_poste
    		runme verifier_partition_linux_oscar_sur_poste
	        linux_poste=`cat /tmp/linux_poste`
    		rm -f /tmp/linux_poste
	        if [ "linux_poste" = "" ]
	        then
    		    partition_linux_dd=
	        else
    		    partition_linux_dd=$linux_poste
	        fi
    		## fin chemin oscar

		mkdir $partition_linux_dd/oscar
		mkdir $partition_linux_dd/oscar/table
		repertoire_oscar=$partition_linux_dd/oscar/table
	fi
else		
	rm -f /tmp/fichiertmp
	dialog --colors --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\n`cat $chemin_langue/msgbox_24` ...\Zn " 9 64
        rm -f /tmp/fichiertmp

	exit
fi
}
#  fin de recherche du repertoire_oscar
#----------------------------------------------------------------------------------------------------
selection_repertoire_sauve()	# boite selection du repertoire \$chemin\table
{

	echo "$repertoire_oscar/" > /tmp/temp_nouveau_repertoire
	perl -pi -e 's/\/\//\//g;' /tmp/temp_nouveau_repertoire
	repertoire_oscar=`cat /tmp/temp_nouveau_repertoire`
        rm -f /tmp/temp_nouveau_repertoire
        
	rm -f /tmp/tempfile
	# Sélectionnez le REPERTOIRE de sauvegarde de la table
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/menu_548` " \
	--ok-label "`cat $chemin_langue/Valider`" --cancel-label "`cat $chemin_langue/Annuler`" \
	--help-button --help-label "`cat $chemin_langue/Aide`" \
	--fselect $repertoire_oscar 14 80 2>/tmp/tempfile
	case $? in
	    0)	chemin_table=`cat /tmp/tempfile`
		rm -f /tmp/tempfile
		# Répertoire de sauvegarde de la table des partitions
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--title " `cat $chemin_langue/menu_410` " \
		--backtitle "`cat /etc/banniere_oscar`" \
		--ok-label "`cat $chemin_langue/Accepter`" --cancel-label "`cat $chemin_langue/Annuler`" --extra-button \
		--extra-label "`cat $chemin_langue/Modifier`" \
		--menu "\n\Zb\Z3  `cat $chemin_langue/menu_549`\n\n" 10 80 0  \
		"" "" \
		"" "" \
		"" "`cat $chemin_langue/menu_550` : \Z2$chemin_table" \
		"" "" \
		"" "" \
		"" ""
		case $? in
	        0) # Accepter
		   return
	    	;;
		3) selection_repertoire_sauve
		;;
		1) exit
		;;
		255) exit
		;;
		esac
		;;
	    1) 	rm -f /tmp/tempfile
		exit;;
	    2)  # aide
	        DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/Navigation` " \
		--msgbox "\n\n`cat $chemin_langue/menu_550a`\n\n" 9 75
	        selection_repertoire_sauve
		;;
	    255) rm -f /tmp/tempfile 
		 exit;;
	esac

}
#----------------------------------------------------------------------------------------------------

cherche_repertoire_oscar	# cherche /$reponse/oscar/table s'il n'y en a pas le créer
### cherche le disque boot

	echo "sauve_mbr" > /tmp/texte_mbr
	runme cherche_disque_boot
	if ( test -e /tmp/sortir )
	then
	    rm -f /tmp/sortir
	    exit
	fi

	hd_boot=`cat /tmp/disque_boot`			# ide/h0/b0/t0/l0/disc
#	partition_boot=dev/`cat /tmp/partition`		# dev/ide/h0/b0/t0/l0/partiii
#	nom_simple_boot=`cat /tmp/nom_simple`		# hdaiii
#	numero_boot=`expr substr $nom_simple_boot 4 3`	# iii

selection_repertoire_sauve

	if ! ( test -e /tmp/recup_mbr )
	then
		rm -f /$chemin_table/table_partitions.mbr
		rm -f /$chemin_table/table_partitions.sf
		dd if=/dev/$hd_boot of=$chemin_table/table_partitions.mbr count=1 bs=512 2>/dev/null
		# sfdisk -d /dev/$hd_boot > $chemin_table/table_partitions.sf 2>/dev/null
		echo "$hd_boot" > /tmp/disque_table_sauvegarder_sf
		runme sauver_table_partition_sf
		cp -f /tmp/disque_table_sauvegarder_sf $chemin_table/table_partitions.sf
		rm -f /tmp/disque_table_sauvegarder_sf
	else
		rm -f	/tmp/recup_mbr
		echo "\n\Zb\Z4 `cat $chemin_langue/menu_570`\Z4 :\n\n " > /tmp/fichierquestion
		echo "\n\n`cat $chemin_langue/menu_571`" >> /tmp/fichierquestion
		serveur_disque choisir_disque_maitre
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/sortir
		else
			hd_boot=`cat /tmp/partition`		## scsi/host0/bus0/target0/lun0/disc
			rm -f /tmp/partition
			# 	echo " danger!!! ici tue le poste: "
			dd if=$chemin_table/table_partitions.mbr of=/dev/$hd_boot 2>/dev/null
			# sfdisk -f /dev/$hd_boot < $chemin_table/table_partitions.sf 2>/dev/null
			echo "$hd_boot" > /tmp/disque_installer_table_sf
			cp -f $chemin_table/table_partitions.sf /tmp/fichier_installer_table_sf
			runme installer_table_partition_sf
			runme formater_ligne_partitions_vfat_gpt
		fi
	fi
		echo
		echo -e "`cat $chemin_langue/boucle_1`"
		echo -ne "`cat $chemin_langue/boucle_2`" 
		read reponse

