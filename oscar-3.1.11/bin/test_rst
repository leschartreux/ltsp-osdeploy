#!/bin/sh


## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
## Cdrom Outil Système Complet d'Assistance Réseau: OSCAR
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.


PATH="/usr/share/oscar/bin:$PATH"




# test la sauvegarde de la partition hda1 ou hdc1 sur la partition linux

## noyau 2.6:
## remplacer runme par runme

#-----------------------------------------------------------------------------------------------------
boucle_partition() # sortir la partition dans la reponse
{
	rm -f /tmp/tempfile
	echo "$type" > /tmp/tempfile
	runme prepare_boucle_partition
	nombretype=`cat /tmp/nombre`
	rm -f /tmp/nombre

numero=0
cp -f /tmp/tempfile /tmp/temp_ligne_deux_points
rm -f /tmp/tempfile
until  ( test  $numero = $nombretype )
    do
	rm -f /tmp/temp_ligne_deux_points1
#	rm -f /tmp/partfile1
	numero=$[$numero+1]
	echo `cut -d":" -f$numero /tmp/temp_ligne_deux_points` > /tmp/temp_ligne_deux_points1	#hdaiii
#	echo `cut -d":" -f$numero /tmp/partfile` > /tmp/partfile1	#ide/h0/b0/t0/l0/hdaiii
	reponse=`cat /tmp/temp_ligne_deux_points1`
	reparti=$reponse
	rm -f /tmp/temp_ligne_deux_points1
		numero_hd=`expr substr $reponse 4 3`
		disque=`expr substr $reponse 1 3`       #hda
#		disque=`cut -d/ -f1-5 /tmp/partfile1`/disc	#ide/h0/b0/t0/l0/disc
#		rm -f /tmp/partfile1
	        if [ "$type" = "linux" ]
		then
			# id_type=`sfdisk /dev/$disque -c $numero_hd 2>/dev/null`
			grep -i $reponse /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
		        nb_partition_linux=`cat /tmp/nb_partition_linux`
		        rm -f /tmp/nb_partition_linux
			if [ "$nb_partition_linux" = "1" ] # partition linux non swap
			then
				if ! ( test -e /mnt/$reponse )
				then	mkdir /mnt/$reponse
				fi
				rm -f /tmp/monter_partition
				echo "$reponse" > /tmp/monter_partition
				runme autoriser_monter_partition_oscar
				nombpart=`cat /tmp/nombpart`
				if [ "$nombpart" = 0 ]
				then			
					mount /dev/$reponse /mnt/$reponse
				fi
				if ( test -e /mnt/$reponse/image.partimage.000 ) ## sauvegarde dans ancienne version
			    	then
				    rm -f partition_de_sauvegarde
				    echo "$reponse" > partition_de_sauvegarde
				    changement_version_oscar changement_partition_sauvegarde
				fi
				if ( test -e /mnt/$reponse/oscar/image.partimage.000 )
				then
				    image_trouvee=oui
				    rm -f /tmp/temp_ligne_deux_points
#				    rm -f /tmp/partfile			    
				    return		
				fi
				if ( test -e /mnt/$reponse/oscar/image.ntfs.00 ) || ( test -e /mnt/$reponse/oscar/image_fsa.fsa )
				then
				    image_trouvee=oui_ntfs
				    rm -f /tmp/temp_ligne_deux_points
				    return
				fi
				umount /mnt/$reponse 2>/dev/null ; sync
			fi
		fi
    done
rm -f /tmp/tempfile
# rm -f /tmp/partfile
}
#-----------------------------------------------------------------------------------------------------
restaure_puis_test()
{
cd /mnt/$reponse/
	sleep 1
	partimage -b -S -f3 restore /dev/$base oscar/image.partimage.000
	sleep 2
cd /root/
	faire_le_test
}
#-----------------------------------------------------------------------------------------------------
question_test()
{
  	if [ "$lettre_reponse" = "O" ] || [ "$lettre_reponse" = "o" ]
	then
		return
	elif [ "$lettre_reponse" = "N" ] || [ "$lettre_reponse" = "n" ]
	then
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors --ok-label "Test" \
		--cancel-label "Continuer" \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " Erreur de simulation " \
		--menu "\n\Zb\Z3  Autre vérification : \n " 10 80 0 \
		"" "" \
		"" "\Zb\Z2Vous pouvez refaire un test : " \
		"" "\Zn   Choisissez \Zb\Z4< Test >\Zn  " \
		"" "" \
		"" "" \
		"" "\Zb\Z2Si la simulation n'est toujours pas à \Zb\Z1100% \Zb\Z2 : " \
		"" "\ZB   Testez plusieurs fois si nécessaire... " \
		"" "\Zn   Formatez la partition \Z2$reponse \Znavec la commande\Zb\Z3 gparted\Zn " \
		"" "\Zn   ou avec la commande \Zb\Z3forma\Zn en minutieux du\Zb\Z4 menu_avancé\Zn,  " \
		"" "\Zn   puis refaire une sauvegarde de \Zb\Z2$base\Zn." \
		"" ""
		case $? in
		0)   # Test
			# démonter éventuellement la partition
			rm -f /tmp/monter_partition
			echo "$base" > /tmp/monter_partition
			runme autoriser_monter_partition_oscar
			nombpart=`cat /tmp/nombpart`
			if ! [ "$nombpart" = 0 ]
			then	
				umount /mnt/$base 2>/dev/null ; sync
			fi

			restaure_puis_test
		   ;;
		1) umount /mnt/$reponse 2>/dev/null ; sync
			exit ;; # Formater
		255) umount /mnt/$reponse 2>/dev/null ; sync
			exit ;;
		esac
	else
	faire_le_test
	fi
}
#-----------------------------------------------------------------------------------------------------
faire_le_test() # voir si la sauvegarde est bonne tout de meme: bug avec option -b de partimage
{
	  	echo
	  	echo -e "\033[1;31mSi la barre rouge est à 100% la partition \033[1;32m$base \033[1;31mest bien sauvegardée sur \033[1;32m$reponse \033[1;31m!!\033[1;m"
	  	echo
	  	echo
	  	echo -en "\033[1;32mLa barre \033[1;31mrouge \033[1;32mest-elle à \033[1;31m100%\033[1;32m ?  \033[1;33mO\033[1;m/\033[1;33mN\033[1;m : "
	  	read lettre_reponse
	  	question_test
}
#-----------------------------------------------------------------------------------------------------
boite_depanne_tst() # voir si la sauvegarde est bonne tout de meme: bug avec option -b de partimage
{
echo -e "Sinon il faut formater la partition \033[1;32m$reponse \033[1;mavec la commande\033[1;33m gparted\033[1;m "
	  	echo -e "ou la commande \033[1;33mforma\033[1;m en minutieux du\033[1;34m menu_avancé\033[1;m, puis refaire une sauvegarde de \033[1;32m$base\033[1;m."

}
#-----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
if ! ( test -e /etc/cdrom_ejecte )
then
	if ( test -e /etc/demarrage_cdcache )
	then
		echo "" > /etc/cdrom_ejecte	# cd ejecte
		# umount /mnt/cdrom 2>/dev/null  ; sync
		eject
	fi
fi
type="linux"
image_trouvee=non
boucle_partition

if [ "$image_trouvee" = "oui" ]
then
	echo "/mnt/$reponse : monté linux" >> /tmp/historique
	if ( test -e /mnt/$reponse/oscar/partition_sauvegardee ) # lire le nom de la partition sauvegardée
	then
		base=`cat /mnt/$reponse/oscar/partition_sauvegardee`
	else
		un=1	# par defaut premiere partition
		base=hda$un
		echo "$base" > /mnt/$reponse/oscar/partition_sauvegardee			
	fi

	if ! ( test -e /mnt/$reponse/oscar/taille_partition_$base )
	then	# installe le fichier de la taille de la partition restaurée
		# fdisk -s /dev/$base > /mnt/$reponse/oscar/taille_partition_$base
		echo "$base" > /tmp/calcul_taille_partition_disque
		runme calcul_taille_partition_MB
		cp -f /tmp/calcul_taille_partition_disque /mnt/$reponse/oscar/taille_partition_$base
		rm -f /tmp/calcul_taille_partition_disque
	fi
	
	grep -ci "," /mnt/$reponse/oscar/taille_partition_$base > /tmp/nbr_valeurs_tailles
	nbr_valeurs_tailles=`cat /tmp/nbr_valeurs_tailles`
	rm -f /tmp/nbr_valeurs_tailles
	if [ "$nbr_valeurs_tailles" = "0" ]
	then
		taille_image=`cat /mnt/$reponse/oscar/taille_partition_$base`
	else
		cut -d"," -f1 /mnt/$reponse/oscar/taille_partition_$base > /tmp/valeur_taille_image
		taille_image=`cat /tmp/valeur_taille_image`
		rm -f /tmp/valeur_taille_image
	fi
	
	if ! ( test -e /mnt/$reponse/oscar/date_de_sauvegarde )
	then
		date=$(date +%d-%m-%y)
		echo "avant le $date" > /mnt/$reponse/oscar/date_de_sauvegarde		
		cp -f /mnt/$reponse/oscar/taille_partition_$base /mnt/$reponse/oscar/sauvegarde_$base:$[$taille_image/1024].Mo_avant_$date
	fi
		# démonter éventuellement la partition
		rm -f /tmp/monter_partition
		echo "$base" > /tmp/monter_partition
		runme autoriser_monter_partition_oscar
		nombpart=`cat /tmp/nombpart`
		if ! [ "$nombpart" = 0 ]
		then	
			umount /mnt/$base 2>/dev/null ; sync
		fi
	restaure_puis_test
elif [ "$image_trouvee" = "oui_ntfs" ]
then
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "Continuer" \
	--title " DESOLE " \
	--msgbox "\n\n\Z1 La sauvegarde d'une partition \Zb\Z2NTFS\Zn\Z1 ne permet pas cette commande ...\Zn " 9 75
        rm -f /tmp/fichiertmp 
else
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "Continuer" \
	--title " DESOLE " \
	--msgbox "\n\n\Z1 Il n'y a pas de partition qui possède la sauvegarde de ce poste...\Zn " 9 72
        rm -f /tmp/fichiertmp
fi