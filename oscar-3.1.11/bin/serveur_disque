#!/bin/sh

## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
## Cdrom Outil Système Complet d'Assistance Réseau: OSCAR
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.


PATH="/usr/share/oscar/bin:$PATH"
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue


#-----------------------------------------------------------------------------------------------------
cherche_disque_maitre()	# donne le disque_maitre à copier
{
	echo "serveur_disque" > /tmp/texte_mbr
    	runme cherche_disque_boot

	if ( test -e /tmp/sortir )
	then
	    rm -f /tmp/sortir
	    exit
	fi
	hd_boot=`cat /tmp/disque_boot`			# ide/h0/b0/t0/l0/disc
#	partition_boot=dev/`cat /tmp/partition`		# dev/ide/h0/b0/t0/l0/partiii
#	nom_simple_boot=`cat /tmp/nom_simple`		# hdaiii
#	numero_boot=`expr substr $nom_simple_boot 4 3`	# iii

	rm -f /tmp/nombre_disques
# 
    ## les 2 lignes suivantes ne servent plus:
	#	grep -ci "lun" /etc/tab_disq > /tmp/nombre_disques	## scsi/host0/bus0/target0/lun0:sdx
	#	nombre_disques=`cat /tmp/nombre_disques`

	nombre_disques=
	rm -f /tmp/nombre_disques
	if [ "$nombre_disques" = "1" ]	# un seul disque on demande toujours
	then
		rm -f /tmp/tempfile
		cut -f1 -d: /etc/tab_disq > /tmp/tempfile
		disque_maitre=`cat /tmp/tempfile`/disc		## scsi/host0/bus0/target0/lun0/disc
		rm -f /tmp/tempfile
		cut -f2 -d: /etc/tab_disq > /tmp/tempfile
		disque_maitre_simple=`cat /tmp/tempfile`	## sdx ou hdx
		return
	fi
	    rm -f /tmp/fichierquestion
	    echo "\n`cat $chemin_langue/selection_11`\n\n " > /tmp/fichierquestion
	    echo "\n\n`cat $chemin_langue/selection_12`" >> /tmp/fichierquestion

	    choisir_disque_maitre
#########

	    if ( test -e /tmp/sortir )
	    then
	    rm -f /tmp/sortir
	    exit
	fi 

}
#-----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
test_demarrage_cdrom() ## si oscar est démarré sur le poste ne pas utiliser cette commande si un seul disque
{
if ! ( test -e /etc/demarrage_usb ) ## le poste n'est pas démarré avec la clé USB OSCAR !! voir si cela convient toujours pour l'ordre des disques et clé de démarrage
then
	if ! ( test -e /etc/demarrage_cdrom ) ## le poste est démarré avec client_multi de multi_lilo voir depart
	then
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/DESOLE` " \
		--ok-label "`cat $chemin_langue/Continuer`"  \
		--msgbox "`cat $chemin_langue/nocederom_1`" 17 78
		case $? in
		    0) 	exit;;
		    255) exit;;
		esac
	fi
fi
}
#----------------------------------------------------------------------------------------------------
boite_disque() # selectionner les disques
{
##	Les fichiers sortis seront:
##	/tmp/nombre_disques
##	/tmp/bozo	# pour la boite de dialog fabriquée /tmp/exec_dialog
##	# dans /tmp/bozo:  (utile pour des essai)
##	"/dev/hda" "  20.0 GB"
##	"/dev/hdb" "  40.0 GB"
##	"/dev/sda" "  20.0 GB"
##	"/dev/sdb" "  40.0 GB"
echo
echo -e "\033[1;32m ..."
echo
sleep 2
rm -f /tmp/demande_fichier_disque	# pour faire /tmp/fichier_disque_dur avec seulement les disques durs
rm -f /tmp/fichier_disques
echo "" > /tmp/demande_fichier_disque
echo "" > /tmp/fichier_disques
rm -f /tmp/bozo
runme info_ddialog
grep -i Disk /tmp/fichier_disque_dur > /tmp/bozo1
perl -pi -e 's/Disk //g; s/: /:/g;' /tmp/bozo1
if ( test -e /tmp/cle_usb_oscar )	# ne pas proposer sda et les nappes IDE pour faire une cle usb oscar
then
	rm -f /tmp/cle_usb_oscar
	grep -v "hda" /tmp/bozo1 | grep -v "sda" | grep -v "hdb" | grep -v "hdc" | grep -v "hdd"  > /tmp/bozo
	cp -f /tmp/bozo /tmp/bozo1
fi

awk 'BEGIN { FS=":" } { printf ("%0s %15s %25s\n","\""$1"\" \"",$2,$3"\" \\")}' /tmp/bozo1 > /tmp/bozo
rm -f /tmp/bozo1
}
#-----------------------------------------------------------------------------------------------------
choisir_disque_maitre()	#selection du disque_maitre
{
rm -f /tmp/menu_titre
rm -f /tmp/menu_texte
echo " `cat $chemin_langue/menu_136` " > /tmp/menu_titre
if ( test -e /tmp/port_usb )
then
	echo " `cat $chemin_langue/menu_137` " > /tmp/menu_titre
	rm -f /tmp/port_usb
fi
boite_disque
grep -ci dev /tmp/bozo > /tmp/nb_bozo
nb_bozo=`cat /tmp/nb_bozo`
rm -f /tmp/nb_bozo
if [ "$nb_bozo" != 1 ]
then
	runme boite_selection_bozo
	if ( test -e /tmp/sortir )
	then
		return
	fi
else
	if ( test -e /tmp/demande_cle_disque_usb )
	then
		runme boite_selection_bozo
		if ( test -e /tmp/sortir )
		then
			return
		fi
	else
		cut -d"\"" -f2 /tmp/bozo > /tmp/tempfile
		rm -f /tmp/bozo
	fi
fi

rm -f /tmp/menu_titre
rm -f /tmp/menu_texte
rm -f /tmp/fichierquestion

perl -pi -e 's/\/dev\///g;' /tmp/tempfile
disque_maitre_simple=`cat /tmp/tempfile`	# hdaiii
rm -f /tmp/tempfile
echo "/dev/$disque_maitre_simple" > /tmp/tempfile
runme selection_disque
disque_maitre=`cat /tmp/partition`		## scsi/host0/bus0/target0/lun0/partiii
rm -f /tmp/tempfile
if ( test -e /tmp/sortir )
then
	return
fi
}
#-----------------------------------------------------------------------------------------------------
boite_envoi_disque_maitre()
{
vitesse_transmission=`cat vitesse_transmission`
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/menu_138` " --ok-label "`cat $chemin_langue/Envoyer`" --cancel-label "`cat $chemin_langue/Annuler`" \
	--extra-button --extra-label "`cat $chemin_langue/menu_139`" \
	--menu "\n`cat $chemin_langue/menu_140` \Zb\Z4$disque_maitre_simple `cat $chemin_langue/menu_141`\n\n" 10 74 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_142` \Zb\Z4$disque_maitre_simple `cat $chemin_langue/menu_143`" \
	"" "" \
	"" " `cat $chemin_langue/menu_144a`" \
	"" "" \
	"" "`cat $chemin_langue/menu_144` \Z1`cat vitesse_transmission`/s " \
	"" "" \
	"" ""
	case $? in
	    0)	rm -f /tmp/texte
		return ;;
	    1)  rm -f /tmp/texte
		exit ;;
	    3)  choix_largeur_bande
	    	boite_envoi_disque_maitre
	    	;;
	    255) rm -f /tmp/texte
		exit ;;
	esac
}
#-----------------------------------------------------------------------------------------------------
installer_daemon_reseau()
{
# mise_en_reseau_asynchrone

echo "synchrone,disque," > /tmp/mode_transfert
lancer_avahi serveur
if ( test -e /tmp/sortir )
then
    rm -f /tmp/sortir
    rm -f /tmp/ip_mcast_rdv
    exit
fi
}
#-----------------------------------------------------------------------------------------------------
envoyer_disque_maitre()
{
rm -f ctrl_serveur
echo "serveur_disq" > ctrl_serveur

vitesse_transmission=`cat vitesse_transmission`

rm -f disque_boot
if [ "$disque_maitre" = "$hd_boot" ]	# avec hd_boot=ide/h0/b0/t0/l0/disc
then
	echo "disque_boot" > disque_boot
	rm -f table_partitions.mbr
	rm -f table_partitions.sf
	dd if=/dev/$hd_boot of=table_partitions.mbr count=1 bs=512 2>/dev/null
	# sfdisk -d /dev/$hd_boot > table_partitions.sf 2>/dev/null
	echo "$hd_boot" > /tmp/disque_table_sauvegarder_sf
	runme sauver_table_partition_sf
	cp -f /tmp/disque_table_sauvegarder_sf table_partitions.sf
	rm -f /tmp/disque_table_sauvegarder_sf
else
	echo "non_disque_boot" > disque_boot
	echo "" > /tmp/taille_disque_envoye
fi

	# taille du disque a envoyer:
	
	# sfdisk -s > /tmp/les_disques 2>/dev/null
	# echo "grep -i \"`cat /tmp/partition`\" /tmp/les_disques > /tmp/les_disques1" > /tmp/exec_nom
	# chmod +x /tmp/exec_nom
	# /tmp/exec_nom
	# perl -pi -e 's/ //g;' /tmp/les_disques1
	# cut -d":" -f2 /tmp/les_disques1 > /tmp/taille_disque_envoye
	cp -f /tmp/partition /tmp/calcul_taille_partition_disque
	runme calcul_taille_partition_MB
	cp -f /tmp/calcul_taille_partition_disque /tmp/taille_disque_envoye
	rm -f /tmp/calcul_taille_partition_disque
	rm -f /tmp/les_disques
	rm -f /tmp/les_disques1


# envoyer la procedure des clients :
echo
echo "$ip_installe" > /tmp/ip_transfert
cut -d"." -f1-2 /tmp/ip_transfert > /tmp/temptransfert
debut_ip_transfert=`cat /tmp/temptransfert`
rm -f /tmp/ip_transfert
rm -f /tmp/temptransfert
envoi_differe
differe=
echo "$nombre" > /tmp/bande_verif
if ( test -e /tmp/demarrage_programme_serveur_pxe )
then
	cut -d "," -f1 /tmp/demarrage_programme_serveur_pxe > /tmp/temp_fichier_wol
	differe=`cat /tmp/temp_fichier_wol`
	rm -f /tmp/temp_fichier_wol
fi

installer_daemon_reseau

# arreter le demon synchrone
daemon_oscar stop

echo "client_disque,$ip_installe,,$differe" > fichier_commande_envoi
echo
echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4`\033[1;34m."
echo
udp-sender -f fichier_commande_envoi --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
clear
echo
echo -e " ..."
echo
rm -f fichier_commande_envoi

# daemon_nfs stop

if [ "$differe" != "" ]
then
	cp -f /usr/share/oscar/var_salle/$differe fichier_mac_adresse_envoi
	echo
	# echo -e "\033[0;34m( `cat $chemin_langue/texte_11` : $debut_ip_transfert.XXX.YYY )"
	echo -e "`cat $chemin_langue/texte_12a`\033[1;m"
	echo
	echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4`\033[1;34m."
	echo
	udp-sender -f fichier_mac_adresse_envoi --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
	rm -f fichier_mac_adresse_envoi
fi



rm -f fichiers_depart_envoi
echo "`cat ctrl_serveur`,$disque_maitre,`cat disque_boot`,$hd_boot,`cat /tmp/taille_disque_envoye`" > fichiers_depart_envoi
rm -f disque_boot
rm -f ctrl_serveur
rm -f /tmp/taille_disque_envoye
echo
echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4`\033[1;34m."
echo
echo
udp-sender -f fichiers_depart_envoi --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
clear
echo
echo -e " ..."
echo
rm -f fichiers_depart_envoi

if [ "$disque_maitre" = "$hd_boot" ]
then
	echo
	echo -e "\033[1;32mEnvoi de la table des partitions sur les postes clients :\033[1;m"
	echo
	echo
	echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4` `cat $chemin_langue/suivant`\033[1;34m."
	echo
	udp-sender -f table_partitions.mbr --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
	echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4` `cat $chemin_langue/suivant`\033[1;34m."
	echo
	udp-sender -f table_partitions.sf --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
	rm -f table_partitions.mbr
	rm -f table_partitions.sf
	echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4` `cat $chemin_langue/suivant`\033[1;34m."
	echo
	udp-sender -f /tmp/fichier_disque_dur --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
	clear
	echo
	echo -e " ..."
	echo
fi

daemon_nfs stop

echo -e "`cat $chemin_langue/texte_3`\033[1;34m $nombre `cat $chemin_langue/texte_4` `cat $chemin_langue/suivant`\033[1;34m."
echo
udp-sender --file /dev/$disque_maitre --min-clients $nombre --max-bitrate $vitesse_transmission --portbase 9020 --mcast-rdv-address `cat /tmp/ip_mcast_rdv` --interface `cat /tmp/carte_ethi` ##--mcast-addr $adresse_synchrone_ctrl
clear
echo
echo -e " ..."
echo
}
#-----------------------------------------------------------------------------------------------------
test_nombre()
{
if [ "$fin_test" = "oui" ]
then
    return
else
    nombre=
    #echo -en "Donnez le\033[1;33m nombre \033[1;mde clients qui recevront le disque : "
    #read nombre	#instruction non valable après le lancement serveur_PXE
        DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title " `cat $chemin_langue/inputbox_13` " \
	--inputbox "\n\n`cat $chemin_langue/inputbox_18`\n " 12 75 2>/tmp/tempfile
        case $? in
	    1)  rm -f /tmp/tempfile
		rm -f /tmp/temp1
		exit
		;;
	    255) rm -f /tmp/tempfile
		rm -f /tmp/temp1
		exit
		;;
	esac
	nombre=`cat /tmp/tempfile`
	rm -f /tmp/tempfile
	rm -f /tmp/temp1

    echo -en "\033[1;31m"
    test_valeur=`expr 255 - $nombre`
    controle=$?
    if [ "$controle" = "0" ]
    then
            signe_valeur=`expr substr $test_valeur 1 1`
            if [ "$signe_valeur" = "-" ]
            then
                echo -e "\033[1;31m `cat $chemin_langue/texte_10` ... \033[1;m"
                sleep 1
            else
                echo -e "\033[1;m"
                fin_test=oui
            fi
    fi
    echo -en "\033[1;m"
    test_nombre
fi
}
#-----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
#		SERVEUR  d'un DISQUE A CLONER ici disque_maitre
#-----------------------------------------------------------------------------------------------------
#   permet l'installation d'un SERVEUR en réseau qui envoie un disque complet et sa table de partitions éventuelle
#-----------------------------------------------------------------------------------------------------
#  Prog principal
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
#  commandes externes de procédures

case "$1" in
	choisir_disque_maitre)
	choisir_disque_maitre
	exit 0
	;;
esac
	# fin commandes externes

if ! ( test -e /etc/cdrom_ejecte )
then
	if ( test -e /etc/demarrage_cdcache )
	then
		echo "" > /etc/cdrom_ejecte	# cd ejecte
		# umount /mnt/cdrom 2>/dev/null  ; sync
		eject
	fi
fi
test_demarrage_cdrom
daemon_oscar stop

rm -f vitesse_transmission
echo "75m" > vitesse_transmission
cherche_disque_maitre
rm -f adresse_synchrone
rm -f /tmp/tempfile

### ici pas de mise en reseau partage_nfs
### car si demarrage disque impossible de partager en ecriture nfs

##### l'ip est dans le fichier ip_installe_poste
lancer_avahi recherche_installe_IP
if ( test -e /tmp/sortir )
then
	rm -f /tmp/sortir
	exit 0
fi
ip_installe=`cat ip_installe_poste`

boite_envoi_disque_maitre

    fin_test=non
    test_nombre

envoyer_disque_maitre
if ( test -e $partition_linux/usr/share/oscar )
then
	echo "" > /tmp/procedure_lance_pxe_synchrone
	serveur_pxe tester_fin_procedure
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
		exit
	fi
fi



