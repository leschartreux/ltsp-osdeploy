#!/bin/bash

## Copyright (c) 2003-2013 Tissoires Jean-François,  jftissoires@gmail.com
## Cdrom Outil Système Complet d'Assistance Réseau: OSCAR
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.


# se programme monte les partitions non montees et les met dans /tmp/tempmonte


#---------------------------------------------------------------------------------------------------
PATH="/usr/share/oscar/bin:$PATH"



#---------------------------------------------------------------------------------------------------
trouver_toutes_partitions()
{
# trouver toutes partitions
if ! ( test -e /tmp/fichier_disque_dur )
then
	runme info_ddialog
fi
# fdisk -l 2>/dev/null | grep -i "^\/dev\/" | grep -v "dev\/dm-" | grep -v "W95 Ext'd" | grep -v "Extended" | grep -v "swap" > /tmp/tempfile
grep -v extended /tmp/fichier_disque_dur | grep -i "^\/dev\/" | grep -v swap > /tmp/tempfile
echo "/dev/fin" >> /tmp/tempfile
echo `gawk '{ print $1 ":" } ' /tmp/tempfile` > /tmp/tempart
perl -pi -e 's/: /:/g; s/\/dev\///g;' /tmp/tempart  ## pour enlever les espaces et /dev/ soit  hda1:hda5:hda6:hda7:fin:
}
#---------------------------------------------------------------------------------------------------
supprimer_partitions_montees() # les partitions a monter sont dans /tempmonte
{
cut -d":" -f1 /tmp/tempart > /tmp/tempfile      #hdaiii
partition_non_montee=`cat /tmp/tempfile`
cp -f /tmp/tempfile /tmp/monter_partition
if [ "$partition_non_montee" = "fin" ]
then
    echo "fin" >> /tmp/tempmonte
    echo `gawk '{ print $1 ":" } ' /tmp/tempmonte` > /tmp/tempfile
    perl -pi -e 's/: /:/g;' /tmp/tempfile  ## pour enlever les espaces  soit  hda1:hda5:hda6:hda7:fin:
    cp -f /tmp/tempfile /tmp/tempmonte

    rm -f /tmp/tempart

    return
else
    runme autoriser_monter_partition_oscar_montage
    nombre=`cat /tmp/nombpart`
#    echo $nombre
    if [ "$nombre" = "0" ] # partition non montée
    then
	echo "$partition_non_montee" >> /tmp/tempmonte
    fi	# partition montee a supprimer

        rm -f /tmp/exec_nom
        echo "perl -pi -e 's/`cat /tmp/tempfile`://g;' /tmp/tempart" > /tmp/exec_nom
        chmod +x /tmp/exec_nom
        /tmp/exec_nom
        rm -f /tmp/exec_nom
fi
supprimer_partitions_montees

# les partitions a monter sont dans /tempmonte
}
#---------------------------------------------------------------------------------------------------
monter_autres_partitions() # les partitions a monter sont dans /tempmonte copiees dans /tmp/tempart
{
cut -d":" -f1 /tmp/tempart > /tmp/tempfile      #hdaiii

partition_non_montee=`cat /tmp/tempfile`
cp -f /tmp/tempfile /tmp/monter_partition
if [ "$partition_non_montee" = "fin" ]
then
    rm -f /tmp/tempart
    rm -f /tmp/tempfile
    return
else
	disque=`expr substr $partition_non_montee 1 3`       #hda
	numero_hd=`expr substr $partition_non_montee 4 3`
	if ! (test -e /mnt/$partition_non_montee )
	then
		mkdir /mnt/$partition_non_montee
	fi
	if ! ( test -e /tmp/fichier_disque_dur )
	then
		runme info_ddialog
	fi
	# id_type=`sfdisk /dev/$disque -c $numero_hd 2>/dev/null`
	grep -i $partition_non_montee /tmp/fichier_disque_dur | grep -ci ntfs > /tmp/nb_partition_ntfs
	nb_partition_ntfs=`cat nb_partition_ntfs`
	rm -f /tmp/nb_partition_ntfs
	if [ "$nb_partition_ntfs" = "1" ] # partition NTFS
        then
		mount -o ro -t ntfs /dev/$partition_non_montee /mnt/$partition_non_montee
	else
		mount /dev/$partition_non_montee /mnt/$partition_non_montee
	fi
        rm -f /tmp/exec_nom
        echo "perl -pi -e 's/`cat /tmp/tempfile`://g;' /tmp/tempart" > /tmp/exec_nom
        chmod +x /tmp/exec_nom
        /tmp/exec_nom
        rm -f /tmp/exec_nom
fi
monter_autres_partitions
# les partitions a demonter sont dans /tempmonte
}
#---------------------------------------------------------------------------------------------------
demonter_partitions_non_montees() # demonte les partitions dans  /tempmonte copiees dans /tmp/tempart
{
cut -d":" -f1 /tmp/tempart > /tmp/tempfile      #hdaiii

partition_non_montee=`cat /tmp/tempfile`
cp -f /tmp/tempfile /tmp/monter_partition
if [ "$partition_non_montee" = "fin" ]
then
    rm -f /tmp/tempart
    rm -f /tmp/tempfile1
    rm -f /tmp/tempfile
    return
else
    umount /mnt/$partition_non_montee 2>/dev/null ; sync
    rm -f /tmp/exec_nom
    echo "perl -pi -e 's/`cat /tmp/tempfile`://g;' /tmp/tempart" > /tmp/exec_nom
    chmod +x /tmp/exec_nom
    /tmp/exec_nom
    rm -f /tmp/exec_nom
fi
demonter_partitions_non_montees
# les partitions a demonter sont dans /tempmonte
}
#---------------------------------------------------------------------------------------------------
main()
{
rm -f /tmp/tempmonte
trouver_toutes_partitions
supprimer_partitions_montees
cp -f /tmp/tempmonte /tmp/tempart
monter_autres_partitions
}
#---------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
#  commandes externes de procédures

case "$1" in
    demonter_partitions_non_montees)
	cp -f /tmp/tempmonte /tmp/tempart
        demonter_partitions_non_montees
	rm -f /tmp/tempmonte
        exit 0
        ;;
esac
#---------------------------------------------------------------------------------------------------
main

