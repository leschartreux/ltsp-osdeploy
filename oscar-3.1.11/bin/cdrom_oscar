#!/bin/sh

## Copyright (c) 2003-2013 Tissoires Jean-FranÃ§ois & Benjamin,  jftissoires@gmail.com
## Outil SystÃ¨me Complet d'Assistance RÃ©seau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et SystÃ¨mes: RapideSOS
## Ce programme est sous Licence Publique GÃ©nÃ©rale GNU publiÃ©e par la Free Software Foundation.
## Ce logiciel est libre sous GPL


# option possible jf pour un cederom de demonstration


#    fabriquer le CDROM  OSCAR sur une nouvelle partition de 1 Go
#----------------------------------------------------------------------------------------------------
choix_noyau_demarrage()
{
# pour sysrcd 0.4.2 prendre le noyau utilisÃ©
grep -i "=" /proc/cmdline  > /tmp/templine
cp -f /tmp/templine /tmp/templigne
perl -pi -e 's/initrd=/;/g;' /tmp/templigne
cut -d";" -f2 /tmp/templigne > /tmp/templigne1
perl -pi -e 's/ /;/g;' /tmp/templigne1
cut -d";" -f1 /tmp/templigne1 > /tmp/templigne
choix_igz=`cat /tmp/templigne`
cp -f /tmp/templine /tmp/templigne
perl -pi -e 's/BOOT_IMAGE=/;/g;' /tmp/templigne
cut -d";" -f2 /tmp/templigne > /tmp/templigne1
perl -pi -e 's/ /;/g;' /tmp/templigne1
cut -d";" -f1 /tmp/templigne1 > /tmp/templigne
choix_noyau=`cat /tmp/templigne`
rm -f /tmp/templigne1
rm -f /tmp/templigne
rm -f /tmp/templine
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
donner_lettre_disque()
{
if [ "$numero_disq" = 0 ]
then
	lettre_disque=a
elif [ "$numero_disq" = 1 ]
then
	lettre_disque=b
elif [ "$numero_disq" = 2 ]
then
	lettre_disque=c
elif [ "$numero_disq" = 3 ]
then
	lettre_disque=d
elif [ "$numero_disq" = 4 ]
then
	lettre_disque=e
elif [ "$numero_disq" = 5 ]
then
	lettre_disque=f
elif [ "$numero_disq" = 6 ]
then
	lettre_disque=g
elif [ "$numero_disq" = 7 ]
then
	lettre_disque=h
elif [ "$numero_disq" = 8 ]
then
	lettre_disque=i
elif [ "$numero_disq" = 9 ]
then
	lettre_disque=j
elif [ "$numero_disq" = 10 ]
then
	lettre_disque=k
elif [ "$numero_disq" = 11 ]
then
	lettre_disque=l
elif [ "$numero_disq" = 12 ]
then
	lettre_disque=m
elif [ "$numero_disq" = 13 ]
then
	lettre_disque=n
elif [ "$numero_disq" = 14 ]
then
	lettre_disque=o
elif [ "$numero_disq" = 15 ]
then
	lettre_disque=p
elif [ "$numero_disq" = 16 ]
then
	lettre_disque=q
elif [ "$numero_disq" = 17 ]
then
	lettre_disque=r
elif [ "$numero_disq" = 18 ]
then
	lettre_disque=s
elif [ "$numero_disq" = 19 ]
then
	lettre_disque=t
elif [ "$numero_disq" = 20 ]
then
	lettre_disque=v
fi
}
#----------------------------------------------------------------------------------------------------
remplacer_dans_fichier_disque_dur() # realise le fichier_disque_dur et le fichier_partitions
{
echo "$lettre_disque" > /tmp/tempfile2
rm -f /tmp/exec_nom
echo "perl -pi -e 's/`cat /tmp/tempfile1`\/disc/`cat /tmp/tempfile3``cat /tmp/tempfile2`/g;' /tmp/fichier_disque_dur" > /tmp/exec_nom
chmod +x /tmp/exec_nom
/tmp/exec_nom
rm -f /tmp/exec_nom
rm -f /tmp/tempfile4
if ( test -e /tmp/fichier_partitions )
then
	echo "
	grep -ci \"`cat /tmp/tempfile1`\" /tmp/fichier_partitions > /tmp/tempfile4
	chemin=\`cat /tmp/tempfile4\`
	if [ \"\$chemin\" = 0 ]
	then
	grep -i \"\/part\" /tmp/fichier_disque_dur >> /tmp/fichier_partitions
	fi" > /tmp/exec_nom	
else
	echo "grep -i \"\/part\" /tmp/fichier_disque_dur >> /tmp/fichier_partitions" > /tmp/exec_nom
fi
	
#	echo "grep -i \"\/part\" /tmp/fichier_disque_dur >> /tmp/fichier_partitions" >> /tmp/exec_nom
echo "perl -pi -e 's/`cat /tmp/tempfile1`\/part/`cat /tmp/tempfile3``cat /tmp/tempfile2`/g;' /tmp/fichier_disque_dur" >> /tmp/exec_nom

chmod +x /tmp/exec_nom
/tmp/exec_nom

rm -f `cat /tmp/tempfile1`
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
test_demarrage_cdrom() ## si oscar est dÃ©marrÃ© avec docache et cd demonte ne pas utiliser cette commande
{
#	if ( test -e /livemnt/boot/isolinux/oscar ) ###	Si dÃ©marrage par cdrom ou cdrom montÃ© OSCAR:
#	then
#		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
#		--backtitle "`cat /etc/banniere_oscar`" \
#		--title " `cat $chemin_langue/DESOLE` " \
#		--ok-label "`cat $chemin_langue/Continuer`"  \
#		--msgbox "\n\n \Zb\Z1ATTENTION : \Zn \n \
#		\n\Zn\Z2Vous utilisez le cÃ©dÃ©rom OSCAR \n \
#		\n\Zn\Z2Vous ne pouvez pas utiliser cette commande. \n\n\n" 13 50
#		case $? in
#		    0) 	exit;;
#		    255) exit;;
#		esac
#	fi
### pour le test suivant changer le nom si besoin de sysrcd.dat avec client_clone
if ! ( test -e /livemnt/boot/$isolinux_/rescue32 ) ## le CD est demonte
then
	if ! ( test -e /livemnt/boot/$isolinux_/rescuecd ) ## le CD est demonte
	then
		## seulement les fichiers OSCAR
		# Vous avez \Zb\Z3dÃ©montÃ© \Zn\Z2le cÃ©dÃ©rom 
		DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
		--backtitle "`cat /etc/banniere_oscar`" \
		--title " `cat $chemin_langue/DESOLE` " \
		--ok-label "`cat $chemin_langue/Continuer`"  \
		--msgbox "\n\n `cat $chemin_langue/msgbox_57`\n\n\n" 13 50
		case $? in
		    0) 	exit;;
		    255) exit;;
		esac
	fi
fi

#	if ! ( test -e /etc/demarrage_cdrom ) ## le poste est dÃ©marrÃ© avec client_multi de multi_lilo
#	then	## seulement les fichiers OSCAR
#	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
#	--backtitle "`cat /etc/banniere_oscar`" \
#	--title " `cat $chemin_langue/DESOLE` " \
#	--ok-label "`cat $chemin_langue/Continuer`"  \
#	--msgbox "\n\n \Zb\Z1ATTENTION : \Zn \n\n \
#	\Zn\Z2Vous avez dÃ©marrer \Zb\Z3OSCAR \Zn\Z2depuis le disque dur de ce poste \n\n \
#	\Zn\Z2Vous ne pouvez pas utiliser cette commande. \n\n\n" 0 0
#	case $? in
#	    0) 	exit;;
#	    255) exit;;
#	esac
#	fi
}
#----------------------------------------------------------------------------------------------------
controle_erreur_montage_ntfs()
{
if ( test -e /tmp/erreur_montage_ntfs )
then
	rm -f /tmp/erreur_montage_ntfs
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--title " `cat $chemin_langue/DESOLE` " --ok-label "`cat $chemin_langue/Continuer`" \
	--msgbox "\n\Zb\Z1 `cat $chemin_langue/msgbox_30` ntfs\Z3 $repertoire \Z1`cat $chemin_langue/msgbox_58`" 10 67
	$continuer_apres_erreur
	if ( test -e /tmp/sortir )
	then
            return
	fi
fi
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
# cdrom RapideSOS
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
montage_rapideSOS() # monte une partition
{
# Partition de copie du fichier RapideSOS.iso
echo " `cat $chemin_langue/selection_48` " > /tmp/menu_titre
echo "\n\Zb\Z3`cat $chemin_langue/selection_49`\Z2 RapideSOS-$date " > /tmp/menu_texte
echo "\n\Zn`cat $chemin_langue/selection_50`\Zb\Z2 RapideSOS.iso\\Zn,\
\n\Zn`cat $chemin_langue/selection_51`" > /tmp/fichierquestion
echo "\n`cat $chemin_langue/selection_52`" >> /tmp/fichierquestion
boites_demande_montage
if ( test -e /tmp/sortir )
then
    rm -f /tmp/sortir
    exit
fi

rm -f /tmp/menu_titre
rm -f /tmp/menu_texte
rm -f /tmp/fichierquestion

perl -pi -e 's/\/dev\///g;' /tmp/tempfile
repertoire=`cat /tmp/tempfile`

rm -f /tmp/tempfile
echo "/dev/$repertoire" > /tmp/tempfile
runme selection_disque
chemin_repertoire=`cat /tmp/partition`
rm -f /tmp/tempfile

numero=`expr substr $repertoire 4 3`

runme info_ddialog
# trouver_type_partition_ancien

if ! ( test -e /mnt/$repertoire )
then
	mkdir /mnt/$repertoire
fi

grep -i $repertoire /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
nb_partition_linux=`cat /tmp/nb_partition_linux`
rm -f /tmp/nb_partition_linux
if [ "$nb_partition_linux" = "1" ] # partition linux non swap
then
	type=swap
	echo "$repertoire" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
	rm -f /tmp/monter_partition
else
	grep -i $repertoire /tmp/fichier_disque_dur | grep -ci fat32 > /tmp/nb_partition_fat32
	nb_partition_fat32=`cat /tmp/nb_partition_fat32`
	rm -f /tmp/nb_partition_fat32
	if [ "$nb_partition_fat32" = "1" ] # partition fat32
	then
		type=fat32
		rm -f /tmp/monter_partition
		echo "$repertoire" > /tmp/monter_partition
		runme autoriser_monter_partition_oscar
	else
		grep -i $repertoire /tmp/fichier_disque_dur | grep -ci ntfs > /tmp/nb_partition_ntfs
		nb_partition_ntfs=`cat /tmp/nb_partition_ntfs`
		rm -f /tmp/nb_partition_ntfs
		if [ "$nb_partition_ntfs" = "1" ] # partition ntfs
		then
			type=ntfs
			echo "ntfs" > /tmp/besoin_type
			echo "$repertoire" > /tmp/monter_partition
			runme autoriser_monter_partition_oscar
			rm -f /tmp/monter_partition
			rm -f /tmp/besoin_type
	
			continuer_apres_erreur=montage_rapideSOS
			controle_erreur_montage_ntfs
		fi
	fi
fi

rm -f /tmp/fichiertmp
echo " " >> /tmp/fichiertmp
echo "`cat $chemin_langue/repertoire_1` /mnt/$repertoire :" >> /tmp/fichiertmp
echo " " >> /tmp/fichiertmp
ls /mnt/$repertoire >> /tmp/fichiertmp
echo " " >> /tmp/fichiertmp
echo  "\n`cat $chemin_langue/repertoire_7` \Zn\n " > /tmp/fichiertmp2
echo " " >> /tmp/fichiertmp2

echo "/mnt/$repertoire :  montÃ© $type " >> /tmp/historique
boites_montage
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
fichiers_cdrom_rapideSOS()
{
montage_rapideSOS
rm -f /tmp/fichiertmp
# RÃ©pertoire du cÃ©dÃ©rom RapideSOS
titre=" `cat $chemin_langue/inputbox_38` "
echo "\n \n`cat $chemin_langue/inputbox_39`\Z4 RapideSOS.iso\Z2 : " > /tmp/fichierquestion
defaut="/mnt/$repertoire/cdOSCAR"
boite_chemin

chemin_cdrom=$reponse

if ! ( test -e $chemin_cdrom )
then
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\Zb\Z1`cat $chemin_langue/texte_43` \n\n\Z2$chemin_cdrom \Z1`cat $chemin_langue/selection_56` !\Zn" 10 70
	rm -f /tmp/fichiertmp

	fichiers_cdrom_rapideSOS
fi
chemin_doc="$chemin_cdrom/dossiers"
if ! ( test -e $chemin_doc )
then
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\Zb\Z1`cat $chemin_langue/texte_43` \n\n\Z2$chemin_doc \Z1`cat $chemin_langue/selection_56` !\Zn" 10 70
        rm -f /tmp/fichiertmp
        fichiers_cdrom_rapideSOS
fi
chemin_scripts="$chemin_cdrom/scripts"				
if ! ( test -e $chemin_scripts )
then
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/ATTENTION` " \
	--msgbox "\n\Zb\Z1       `cat $chemin_langue/texte_43` \n\n\Z2$chemin_scripts \Z1`cat $chemin_langue/selection_56` ! \Zn " 10 70
	rm -f /tmp/fichiertmp
	fichiers_cdrom_rapideSOS
fi
}
#----------------------------------------------------------------------------------------------------
cdrom_RapideSOS()
{
# Partition Linux de rÃ©alisation du cÃ©dÃ©rom RapideSOS
echo " `cat $chemin_langue/selection_53` " > /tmp/menu_titre
echo "\n\Z2CÃ©dÃ©rom \Zb\Z1Rapide \Z3de\Zb\Z1 S\Z3auvegarde aux\Zb\Z1 O\Z3rdinateurs et\Zb\Z1 S\Z3ystÃ¨mes, \Zb\Z1RapideSOS \
\n\n\Z1        `cat $chemin_langue/selection_54`" > /tmp/menu_texte
echo "`cat $chemin_langue/selection_55`" > /tmp/fichierquestion
echo "`cat $chemin_langue/selection_52`" >> /tmp/fichierquestion
boites_demande_partition
if ( test -e /tmp/sortir )
then
	rm -f /tmp/sortir
	exit
fi
rm -f /tmp/menu_titre
rm -f /tmp/menu_texte
rm -f /tmp/fichierquestion

perl -pi -e 's/\/dev\///g;' /tmp/tempfile
repertoire=`cat /tmp/tempfile`
	
rm -f /tmp/tempfile
echo "/dev/$repertoire" > /tmp/tempfile

#	runme selection_disque
#	chemin_repertoire=`cat /tmp/partition`
#	rm -f /tmp/tempfile

numero=`expr substr $repertoire 4 3`
disque=`expr substr $repertoire 1 3`

runme info_ddialog
# id_type=`sfdisk /dev/$disque -c $numero 2>/dev/null`
grep -i $repertoire /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
nb_partition_linux=`cat /tmp/nb_partition_linux`
rm -f /tmp/nb_partition_linux
if [ "$nb_partition_linux" = "1" ]    #  type=linux
then
	type=linux
	mount /dev/$repertoire /mnt/custom 2>/dev/null 1>/dev/null
	echo
	echo
	date=$(date +%y%m%d)
	echo
	echo
	if ( test -e /mnt/custom/customcd )
	then
		rm -R -f /mnt/custom/customcd/*
	fi
	fichiers_cdrom_rapideSOS
	echo
	echo -e "`cat $chemin_langue/texte_49`"
	echo
	echo -e "`cat $chemin_langue/texte_6`"
	echo
	if ( test -e /livemnt/boot/syslinux/maps )
	then # demarrage cle usb
		perl -pi -e 's/isolinux/syslinux/g;' /usr/sbin/sysresccd-custom
	else
		perl -pi -e 's/syslinux/isolinux/g;' /usr/sbin/sysresccd-custom
	fi
	/usr/sbin/sysresccd-custom extract
	if ( test -e /livemnt/boot/syslinux/maps )
	then # demarrage cle usb
		perl -pi -e 's/syslinux/isolinux/g;' /usr/sbin/sysresccd-custom
		mv /mnt/custom/customcd/isoroot/syslinux /mnt/custom/customcd/isoroot/isolinux
	fi
	
	cp -f /usr/share/oscar/bin/oscar /mnt/custom/customcd/files/usr/sbin/
	cp -f /usr/share/oscar/bin/oscar /mnt/custom/customcd/files/root/.zsh/
	#cp -f /usr/share/oscar/bin/bashlogin /mnt/custom/customcd/files/bin
	cp -f /usr/share/oscar/usr/depart26_rst /mnt/custom/customcd/files/usr/share/oscar/bin/depart
	# demarrage OSCAR :
	#cp -f /mnt/sdb1/linux/bin_noyau_26-18/bashlogin /mnt/custom/customcd/files/bin # version 2.6.18
	grep -v "^echo -e" /mnt/custom/customcd/files/bin/bashlogin > /tmp/temp_bashlogin
	cp -f /tmp/temp_bashlogin /mnt/custom/customcd/files/bin/bashlogin
	rm -f /tmp/temp_bashlogin
	perl -pi -e 's/exec \$SHELL --login/\/usr\/share\/oscar\/bin\/depart
	exec \$SHELL --login/g;' /mnt/custom/customcd/files/bin/bashlogin

	chmod +x /mnt/custom/customcd/files/bin/*
	chmod +x /mnt/custom/customcd/files/usr/share/oscar/bin/*
	chmod +x /mnt/custom/customcd/files/usr/share/oscar/usr/*
	chmod +x /mnt/custom/customcd/files/root/.zsh/oscar
	chmod +x /mnt/custom/customcd/files/usr/sbin/oscar

	cp -f /usr/share/oscar/usr/isolinux18_rapidesos.cfg /mnt/custom/customcd/isoroot/isolinux/isolinux.cfg
	cp -f /usr/share/oscar/usr/f2help_rapidesos.msg /mnt/custom/customcd/isoroot/isolinux/f2help.msg
	cp -f /usr/share/oscar/usr/fr.ktl /mnt/custom/customcd/isoroot/isolinux/
	rm -f /mnt/custom/customcd/isoroot/isolinux/isolinux.bak
	rm -f /mnt/custom/customcd/isoroot/isolinux/isolinux.old
	
	chmod -R 777 /mnt/custom/customcd/isoroot

	echo "HOSTNAME=\"OSCAR\"" > /mnt/custom/customcd/files/etc/conf.d/hostname
	perl -pi -e 's/sysresccd localhost/OSCAR localhost/g;' /mnt/custom/customcd/files/etc/hosts

	## faire de la place:
	rm -fR /mnt/custom/customcd/files/usr/share/doc
	rm -fR /mnt/custom/customcd/files/usr/X11R6
	rm -fR /mnt/custom/customcd/files/usr/lib/gcc-lib
	rm -fR /mnt/custom/customcd/files/var/lib/clamav
	
	chmod +x /mnt/custom/customcd/files/usr/share/oscar/usr/version_theme_oscar
	mesurer_taille_fichiers_avant_mksquashfs
	/usr/sbin/sysresccd-custom squashfs

	mv /mnt/custom/customcd/isoroot/isolinux/$choix_noyau /mnt/custom/customcd/isoroot/isolinux/oscar
	mv /mnt/custom/customcd/isoroot/isolinux/$choix_igz /mnt/custom/customcd/isoroot/isolinux/oscar.igz
	if ( test -e /mnt/custom/customcd/isoroot/isolinux/rescue32 )
	then
		echo "r" > /mnt/custom/customcd/isoroot/isolinux/rescue32
	elif ( test -e /mnt/custom/customcd/isoroot/isolinux/rescuecd )
	then
		echo "r" > /mnt/custom/customcd/isoroot/isolinux/rescuecd
	fi
	echo "r" > /mnt/custom/customcd/isoroot/isolinux/rescue64
	echo "a" > /mnt/custom/customcd/isoroot/isolinux/altker32
	echo "a" > /mnt/custom/customcd/isoroot/isolinux/altker64
	rm -f /mnt/custom/customcd/isoroot/isolinux/isolinux.bak

	if [ "$type" = "ntfs" ]
	then
		echo
		echo -e "`cat $chemin_langue/texte_51`"
	fi
	echo
	echo -e "`cat $chemin_langue/texte_50`"
	echo
	echo -e "`cat $chemin_langue/texte_6`"
	echo
#	cp -f /usr/share/oscar/usr/autorun /mnt/custom/customcd/isoroot
#	chmod 777 /mnt/custom/customcd/isoroot/autorun
	
	#	# clavier fr ou autre pour RapideSOS
	#	# /usr/sbin/sysresccd-custom setkmap fr	
	#	# Set keymap in isolinux.cfg dans /usr/sbin/sysresccd-custom
	#	KEYMAP="fr"
	#	cp /mnt/custom/customcd/isoroot/isolinux/isolinux.cfg /mnt/custom/customcd/isoroot/isolinux/isolinux.bak
	#	sed -i -r -e "s: setkmap=[a-z0-9]+::g ; s:APPEND:APPEND setkmap=${KEYMAP}:gi" /mnt/custom/customcd/isoroot/isolinux/isolinux.cfg

	chmod 666 /mnt/custom/customcd/isoroot/sysrcd.dat
	
	grep -ci "cmd=\"xorriso" /usr/sbin/sysresccd-custom > /tmp/nb_xorriso
	nb_xorriso=`cat /tmp/nb_xorriso`
	rm -f /tmp/nb_xorriso
	if [ "$nb_xorriso" = 1 ]
	then # nouvelle version 3.0.0 sysresccd-custom
		perl -pi -e 's/cmd=\"xorriso/curtime=new
		cmd=\"xorriso/g;' /usr/sbin/sysresccd-custom
	else
		perl -pi -e 's/cmd=\"mkisofs/curtime=new
		cmd=\"mkisofs/g;' /usr/sbin/sysresccd-custom
	fi
	/usr/sbin/sysresccd-custom isogen RapideSOS-$date
	echo
	echo -e "`cat $chemin_langue/texte_50`"
	echo
	chmod 777 /mnt/custom/customcd/isofile/sysresccd-new.iso
	chmod 777 -f $chemin_cdrom
	cp -f /mnt/custom/customcd/isofile/sysresccd-new.iso $chemin_cdrom/RapideSOS-$date.iso
	
	echo "" > /tmp/RapideSOS_usb
	proposer_installe_sur_usb
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	fi
	boite_demande_installe_usb
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	fi
	echo
	echo -e " `cat $chemin_langue/texte_53`\033[1;32m $chemin_cdrom/\033[1;m: "
	echo
	ls $chemin_cdrom/
	echo
	echo
	echo -e "`cat $chemin_langue/texte_55` \033[1;32mRapideSOS-$date.iso\033[1;m "
	echo -e "`cat $chemin_langue/texte_54`"
	echo
	
	rm -f /mnt/custom/fichier_s
	rm -f /mnt/custom/fichier_a
	umount /mnt/custom 2>/dev/null ; sync
	sync

else
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\n\Z1 `cat $chemin_langue/msgbox_30`\Z2 $repertoire \Z1`cat $chemin_langue/selection_57` !\Zn" 10 60
        rm -f /tmp/fichiertmp
	exit
fi
echo
test_fin
exit
}
#----------------------------------------------------------------------------------------------------
# Fin cdrom RapideSOS
#----------------------------------------------------------------------------------------------------
test_fin() # si teste oscar sans depart
{
rm -f /tmp/tempfile
if ! ( test -e /etc/oscar )
then
	echo
	echo -e " `cat $chemin_langue/texte_56`"
	echo
fi
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boucle_partition() # sortir la partition dans la reponse
{
rm -f /tmp/tempfile
echo "$type" > /tmp/tempfile
runme prepare_boucle_partition
nombretype=`cat /tmp/nombre`
rm -f /tmp/nombre

numero=0
cp -f /tmp/tempfile /tmp/temp_ligne_deux_points
rm -f /tmp/tempfile
until  ( test  $numero = $nombretype )
    do    
	rm -f /tmp/temp_ligne_deux_points1
#	rm -f /tmp/partfile1
	numero=$[$numero+1]
	cut -d":" -f$numero /tmp/temp_ligne_deux_points > /tmp/temp_ligne_deux_points1	#hdaiii
#	cut -d":" -f$numero /tmp/partfile > /tmp/partfile1	#ide/h0/b0/t0/l0/hdaiii
	reponse=`cat /tmp/temp_ligne_deux_points1`
	reparti=$reponse
	rm -f /tmp/temp_ligne_deux_points1
	if ! [ "$reponse" = "" ] # si la partition du type existe chercher la sauvegarde
	then
		numero_hd=`expr substr $reponse 4 3`
		disque=`expr substr $reponse 1 3`	#sda
#		rm -f /tmp/partfile1
	        if [ "$type" = "linux" ]
		then
			# id_type=`sfdisk /dev/$disque -c $numero_hd 2>/dev/null`
			grep -i $reponse /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
			nb_partition_linux=`cat /tmp/nb_partition_linux`
			rm -f /tmp/nb_partition_linux
			if [ "$nb_partition_linux" = "1" ] # partition linux non swap
			then	# "swap linux" # ne pas monter la partition
				rm -f /tmp/temp_ligne_deux_points
				# rm -f /tmp/partfile
				return
			fi
		fi
	fi
#	rm -f /tmp/partfile1
    done
rm -f /tmp/tempfile
#rm -f /tmp/partfile
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boites_montage()
{
# RÃ©pertoire montÃ©
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors --no-shadow \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title "    \Zn      `cat $chemin_langue/menu_300`    \Zn      " \
	--exit-label "`cat $chemin_langue/Continuer`" --textbox "/tmp/fichiertmp" 0 0 \
	--and-widget --colors --ok-label "`cat $chemin_langue/menu_301`" --cancel-label "`cat $chemin_langue/Continuer`" \
	--menu "`cat /tmp/fichiertmp2`" 0 0 0 "" "`cat $chemin_langue/menu_302` ..." \
	"" "`cat $chemin_langue/msgbox_30` \Z2$type\Z3 $repertoire\Zn `cat $chemin_langue/menu_183`\Z2 /mnt/$repertoire\Zn "
	case $? in
    1)	rm -f /tmp/fichiertmp
	rm -f /tmp/fichiertmp2
	;;
    0) boites_montage;;
    255) rm -f /tmp/fichiertmp
	rm -f /tmp/fichiertmp2
	if ( test -e /tmp/sortir )
	then
	    rm -f /tmp/sortir
	fi
	exit
	;;
esac
rm -f /tmp/fichiertmp
rm -f /tmp/fichiertmp2
}
#----------------------------------------------------------------------------------------------------
boite_couleurs_exec_dialog()
{
perl -pi -e 's/FAT32/\\Z4FAT32\\Zn+/g; \
s/FAT16/\\Z4FAT16\\Zn+/g; \
s/NTFS/\\Z4NTFS\\Zn+/g; \
s/Linux/\\Z2Linux\\Zn+/g; \
s/\+ / /g; s/\+/ /g;' /tmp/exec_dialog
#	perl -pi -e 's/\\Z2Linux\\Zn \\Zn  swap/Linux swap /g; \
#        s/Extended/Extended /g;' /tmp/exec_dialog
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boites_demande_montage()
{
runme info_ddialog_menu
grep -v swap /tmp/bozo > /tmp/bozo1
cp -f /tmp/bozo1 /tmp/bozo
rm -f /tmp/bozo1
cp /etc/exec_dialog_src /tmp/exec_dialog -f
cat /tmp/bozo >> /tmp/exec_dialog
rm -f /tmp/fichier_dd
rm -f /tmp/fichier_disque_dur
rm -f /tmp/bozo
rm -f /tmp/tempfile
echo '2>/tmp/tempfile
toutou=$?
if [ $toutou = 255 ]
then
    rm -f /tmp/tempfile
    echo "" > /tmp/sortir
    exit
elif [ $toutou = 1 ]
then
    rm -f /tmp/tempfile
    echo "" > /tmp/sortir
    exit
fi
' >> /tmp/exec_dialog


# Mise en couleur
boite_couleurs_exec_dialog
chmod +x /tmp/exec_dialog
/tmp/exec_dialog

if ( test -e /tmp/sortir )
then
        return
fi

if ! ( test -e /tmp/tempfile )
    then 
    exit
fi
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
montage() # monte une partition
{
# Partition de copie du fichier OSCAR.iso
echo " `cat $chemin_langue/selection_58` " > /tmp/menu_titre
echo "\n\Zb\Z3`cat $chemin_langue/selection_59` :\Z2 OSCAR-$date " > /tmp/menu_texte
echo "\n\Zn`cat $chemin_langue/selection_50`\Zb\Z2 OSCAR.iso\Zn,\n`cat $chemin_langue/selection_51`" > /tmp/fichierquestion
echo "\n`cat $chemin_langue/selection_52`" >> /tmp/fichierquestion
boites_demande_montage
if ( test -e /tmp/sortir )
then
        return
fi

rm -f /tmp/menu_titre
rm -f /tmp/menu_texte
rm -f /tmp/fichierquestion

perl -pi -e 's/\/dev\///g;' /tmp/tempfile
repertoire=`cat /tmp/tempfile`

rm -f /tmp/tempfile
echo "/dev/$repertoire" > /tmp/tempfile
runme selection_disque
chemin_repertoire=`cat /tmp/partition`
rm -f /tmp/tempfile

numero=`expr substr $repertoire 4 3`

runme info_ddialog
# trouver_type_partition_ancien

if ! ( test -e /mnt/$repertoire )
then
	mkdir /mnt/$repertoire
fi

grep -i $repertoire /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
nb_partition_linux=`cat /tmp/nb_partition_linux`
rm -f /tmp/nb_partition_linux
if [ "$nb_partition_linux" = "1" ] # partition linux non swap
then
	type=linux
	rm -f /tmp/monter_partition
	echo "$repertoire" > /tmp/monter_partition
	runme autoriser_monter_partition_oscar
else
	grep -i $repertoire /tmp/fichier_disque_dur | grep -ci fat32 > /tmp/nb_partition_fat32
	nb_partition_fat32=`cat /tmp/nb_partition_fat32`
	rm -f /tmp/nb_partition_fat32
	if [ "$nb_partition_fat32" = "1" ] # partition fat32
	then
		type=fat32
		rm -f /tmp/monter_partition
		echo "$repertoire" > /tmp/monter_partition
		runme autoriser_monter_partition_oscar
	else
		grep -i $repertoire /tmp/fichier_disque_dur | grep -ci ntfs > /tmp/nb_partition_ntfs
		nb_partition_ntfs=`cat /tmp/nb_partition_ntfs`
		rm -f /tmp/nb_partition_ntfs
		if [ "$nb_partition_ntfs" = "1" ] # partition ntfs
		then
			type=ntfs
			echo "ntfs" > /tmp/besoin_type
			echo "$repertoire" > /tmp/monter_partition
			runme autoriser_monter_partition_oscar
			rm -f /tmp/besoin_type
			continuer_apres_erreur=montage
			controle_erreur_montage_ntfs
			if ( test -e /tmp/sortir )
			then
		            return
			fi
		fi
	fi
fi

rm -f /tmp/fichiertmp
echo " " > /tmp/fichiertmp
echo "`cat $chemin_langue/repertoire_1` /mnt/$repertoire :" >> /tmp/fichiertmp
echo " " >> /tmp/fichiertmp
ls /mnt/$repertoire >> /tmp/fichiertmp
echo " " >> /tmp/fichiertmp
echo  "\n`cat $chemin_langue/repertoire_7` \Zn\n " > /tmp/fichiertmp2
echo " " >> /tmp/fichiertmp2

echo "/mnt/$repertoire :  montÃ© $type " >> /tmp/historique
boites_montage
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boite_chemin()
{
echo "\n\Zb\Z3 `cat $chemin_langue/menu_303` :" >> /tmp/fichiertmp
# Chemin du cÃ©dÃ©rom OSCAR
	DIALOGRC="/etc/dialogrc" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`" --title "$titre" \
	--inputbox "`cat /tmp/fichiertmp`\n `cat /tmp/fichierquestion`" 12 85 $defaut 2>/tmp/tempfile
	case $? in
	0) rm -f /tmp/fichiertmp
		reponse=`cat /tmp/tempfile`
		rm -f /tmp/tempfile
		rm -f /tmp/fichierquestion
		return ;;
	1)  rm -f /tmp/fichiertmp
		rm -f /tmp/tempfile
		rm -f /tmp/fichierquestion
		exit ;;
	255) rm -f /tmp/fichiertmp
		rm -f /tmp/tempfile
		rm -f /tmp/fichierquestion
		exit ;;
esac
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
fichiers_cdrom()
{
montage
if ( test -e /tmp/sortir )
then
        return
fi
# RÃ©pertoire du cÃ©dÃ©rom OSCAR
rm -f /tmp/fichiertmp
titre=" `cat $chemin_langue/selection_61` "
echo "\n \n\Zb\Z2`cat $chemin_langue/selection_60`\Z4 OSCAR.iso\Z2 : " > /tmp/fichierquestion
defaut="/mnt/$repertoire/cdOSCAR"
boite_chemin

chemin_cdrom=$reponse

if ! ( test -e $chemin_cdrom )
then
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\Zb\Z1`cat $chemin_langue/texte_43` \n\n\Z2$chemin_cdrom \Z1`cat $chemin_langue/selection_56` ! \Zn " 10 70
	rm -f /tmp/fichiertmp
	
	fichiers_cdrom
	if ( test -e /tmp/sortir )
	then
		return
	fi
fi
chemin_doc="$chemin_cdrom/dossiers"
if ! ( test -e $chemin_doc )
then
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\Zb\Z1`cat $chemin_langue/texte_43` \n\n\Z2$chemin_doc \Z1`cat $chemin_langue/selection_56` ! \Zn " 10 70
        rm -f /tmp/fichiertmp
        fichiers_cdrom
	if ( test -e /tmp/sortir )
        then
        	return
	fi
fi
chemin_scripts="$chemin_cdrom/scripts"				
if ! ( test -e $chemin_scripts )
then
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/ATTENTION` " \
	--msgbox "\n\Zb\Z1`cat $chemin_langue/texte_43` \n\n\Z2$chemin_scripts \Z1`cat $chemin_langue/selection_56` ! \Zn " 10 70
	rm -f /tmp/fichiertmp
	
	fichiers_cdrom
	if ( test -e /tmp/sortir )
	then
	    rm -f /tmp/sortir
	    exit
	fi
fi
}
#----------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------
boite_choix_cdrom()
{
	# RÃ©aliser le cÃ©dÃ©rom OSCAR
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`" --ok-label "`cat $chemin_langue/menu_304`" --extra-button --extra-label "`cat $chemin_langue/menu_305`" \
	--title " `cat $chemin_langue/menu_178a` " \
	--menu "\n\Zb\Z4   `cat $chemin_langue/menu_164`\Z3O\Z4util de\Z3 S\Z4auvegarde\Z3 C\Z4omplet d'\Z3A\Z4ssistance \Z3R\Z4Ã©seaux \n\n" 10 80 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_306`" \
	"" "`cat $chemin_langue/menu_307`" \
	"" "" \
	"" "\Z2Copyright (c) 2003-2013 (Tissoires Jean-FranÃ§ois & Benjamin)" \
	"" "\Zb\Z1O\Z3util\Zb\Z1 S\Z3ystÃ¨me \Zb\Z1C\Z3omplet d'\Zb\Z1A\Z3ssistance\Zb\Z1 R\Z3Ã©seau, \Zb\Z1OSCAR" \
	"" "\Zb\Z1Rapide \Z3de\Zb\Z1 S\Z3auvegarde aux\Zb\Z1 O\Z3rdinateurs et\Zb\Z1 S\Z3ystÃ¨mes, \Zb\Z1RapideSOS " \
	"" "\Z2jftissoires@gmail.com \Zn " \
	"" "" \
	"" "\Zn`cat $chemin_langue/menu_166` \Zb\Z3Licence Publique GÃ©nÃ©rale GNU\Zn" \
	"" "`cat $chemin_langue/menu_167` Free Software Foundation." \
	"" "" \
	"" "\Zb\Z4`cat $chemin_langue/menu_308` :"
	case $? in
	    0)	# test_demarrage_cdrom
	    	return ;;
	    3)  # test_demarrage_cdrom
	    	cdrom_RapideSOS
	    	exit ;;
	    1)	exit;;
	    255) exit ;;
	esac
}
#-----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boites_demande_partition()
{
# rm -f /tmp/fichier_disque_dur
runme info_ddialog_menu
grep -v swap /tmp/bozo > /tmp/bozo1
cp -f /tmp/bozo1 /tmp/bozo
rm -f /tmp/bozo1
#
# A modifier : ./exec_dialog_src (donner le chemin)
#
cp /etc/exec_dialog_src /tmp/exec_dialog -f
#
# Fin de modif
#
cat /tmp/bozo >> /tmp/exec_dialog
rm -f /tmp/fichier_dd
rm -f /tmp/fichier_disque_dur
rm -f /tmp/bozo
rm -f /tmp/tempfile
echo '2>/tmp/tempfile
toutou=$?
if [ $toutou = 255 ]
then
	rm -f /tmp/tempfile
	echo "" > /tmp/sortir
	exit
elif [ $toutou = 1 ]
then
	rm -f /tmp/tempfile
	echo "" > /tmp/sortir
	exit
fi
' >> /tmp/exec_dialog
    

# Mise en couleur
boite_couleurs_exec_dialog

chmod +x /tmp/exec_dialog

/tmp/exec_dialog

if ( test -e /tmp/sortir )
then
	return
fi


if ! ( test -e /tmp/tempfile )
then
	exit
fi 

#perl -pi -e 's/\/dev\///g;' /tmp/tempfile
#reponse=`cat /tmp/tempfile`
#rm -f /tmp/tempfile
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
test_mot_passe()
{
if [ "$reponse" = "" ] || [ "$reponse" = " " ]
then
        dialog  --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
        --ok-label "`cat $chemin_langue/Recommencez`" \
        --title " `cat $chemin_langue/DESOLE` " \
        --msgbox "\n\n\Z1 `cat $chemin_langue/selection_62` ...\Zn " 9 43
        boite_mdp
fi
}
#----------------------------------------------------------------------------------------------------
boite_mdp()
{
	# verif=`cat /usr/share/oscar/bin/fichier_s`
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--cancel-label "`cat $chemin_langue/Annuler`"  --title "$titre_mdp" \
	--passwordbox "$fichierquestion" 12 80 2>/tmp/tempfile
	case $? in
	    0)	reponse=`cat /tmp/tempfile`
		rm -f /tmp/tempfile
		test_mot_passe
		;;
	    1)	exit;;
	    255) exit ;;
	esac
}
#----------------------------------------------------------------------------------------------------
#----------------------------------------------------------------------------------------------------
boite_confirme_mdp()
{
# verif=`cat /usr/share/oscar/bin/fichier_s`
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Oui`" --cancel-label "`cat $chemin_langue/Annuler`"  --title "$titre_mdp" \
	--passwordbox "$fichierquestion" 14 80 2>/tmp/tempfile
	case $? in
	    0)	reponse_confirme=`cat /tmp/tempfile`
		rm -f /tmp/tempfile
		if [ $reponse_confirme = $reponse ]
		then  
		    return 
		else
		    boite_confirme_mdp
		    if ( test -e /tmp/sortir )
		    then
			return
		    fi
		fi 
		;;
	    1)	exit;;
	    255) exit ;;
	esac
}
#----------------------------------------------------------------------------------------------------
faire_boot_msg()
{
echo "0c07








0c                O0eutil 0cS0eysteme 0cC0eomplet d'0cA0essistance 0cR0eeseau (c)07

0c                                O S C A R07

09                              Version `cat /usr/share/oscar/usr/numero_version_oscar`07

 02Copyright (c) 2003-2013 (Tissoires Jean-Francois & Benjamin)07
 02jftissoires@gmail.com 07
 02Licence publique generale GNU07

 02Gentoo Linux   http://gentoo.org07
 02SystemRescueCd http://www.sysresccd.org/index.fr.php07

 `cat $chemin_langue/textemsg_1` 0eF207 `cat $chemin_langue/textemsg_2`
 `cat $chemin_langue/textemsg_1` 0eF307 `cat $chemin_langue/textemsg_3`

 0c`cat $chemin_langue/textemsg_4`07 `cat $chemin_langue/textemsg_5` 0foscar docache07
 `cat $chemin_langue/textemsg_6` 0fdocache07 `cat $chemin_langue/textemsg_7` (`cat $chemin_langue/textemsg_8`)

0c`cat $chemin_langue/textemsg_9` :07 `cat $chemin_langue/textemsg_10` 0e`cat $chemin_langue/Entrer`07 `cat $chemin_langue/textemsg_11` 0foscar07
                           07 `cat $chemin_langue/tapez` 0fclient07, 0frestaure07, 0fnet07
 0C07" > /etc/boot.msg
}
#----------------------------------------------------------------------------------------------------
mesurer_taille_fichiers_dans_sysresccd_mksquashfs()
{
# taille des fichiers avant mksquashfs
ls -sR /mnt/custom/customcd/files | grep total | awk '{print $2 "+" }' > /tmp/taille_fichiers_avant_mksquashfs	# par ligne : total valeur
perl -pi -e 's/ //g;' /tmp/taille_fichiers_avant_mksquashfs
taille_fichiers_avant_mksquashfs=`cat /tmp/taille_fichiers_avant_mksquashfs`1-1
rm -f /tmp/taille_fichiers_avant_mksquashfs

taille_fichiers_avant_mksquashfs=$[$taille_fichiers_avant_mksquashfs]
echo "$taille_fichiers_avant_mksquashfs" > /mnt/custom/customcd/files/usr/share/oscar/usr/taille_fichiers_avant_mksquashfs
}
#----------------------------------------------------------------------------------------------------
mesurer_taille_fichiers_avant_mksquashfs()
{
grep -ci "cmd=\"mksquashfs" /usr/sbin/sysresccd-custom > /tmp/nb_cmd_mksquashfs
nb_cmd_mksquashfs=`cat /tmp/nb_cmd_mksquashfs`
rm -f /tmp/nb_cmd_mksquashfs
if [ "$nb_cmd_mksquashfs" = "1" ]
then
	grep -ci "mesurer_taille_fichiers_dans_sysresccd_mksquashfs" /usr/sbin/sysresccd-custom > /tmp/nb_mesurer_taille_sysresccd
	nb_mesurer_taille_sysresccd=`cat /tmp/nb_mesurer_taille_sysresccd`
	rm -f /tmp/nb_mesurer_taille_sysresccd
	if [ "$nb_mesurer_taille_sysresccd" = "0" ]
	then
		perl -pi -e 's/cmd=\"mksquashfs/\/usr\/share\/oscar\/bin\/cdrom_oscar mesurer_taille_fichiers_dans_sysresccd_mksquashfs
		cmd=\"mksquashfs/g;' /usr/sbin/sysresccd-custom
	fi
fi
}
#----------------------------------------------------------------------------------------------------
boite_demande_installe_usb()
{
texte_titre=`cat $chemin_langue/menu_52`
if ( test -e /tmp/RapideSOS_usb )
then
	texte_titre=`cat $chemin_langue/menu_52b`
fi
	DIALOGRC="/etc/dialogmenu_bloque" dialog --colors \
	--backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Oui`" --cancel-label "`cat $chemin_langue/Annuler`" \
	--title " `cat $chemin_langue/menu_235` " \
	--menu "\n\Zb\Z3   $texte_titre \n\n" 10 80 0 \
	"" "" \
	"" "`cat $chemin_langue/menu_237`" \
	"" "`cat $chemin_langue/menu_237a`" \
	"" "" \
	"" "`cat $chemin_langue/menu_239` : 2 Go" \
	"" ""
case $? in
    0)	proposer_installe_sur_usb
    	;;
    1)  echo "" > /tmp/sortir
    	return
	;;
    255) echo "" > /tmp/sortir
	return
	;;
esac
rm -f /tmp/sortir
boite_demande_installe_usb
}
#----------------------------------------------------------------------------------------------------
proposer_installe_sur_usb()
{
installe_oscar_usb info_depart_installe_oscar_sur_usb
if ( test -e /tmp/sortir )
then
	return
fi
if ( test -e /tmp/sp_erreur_usb_oscar )
then
	rm -f /tmp/sp_erreur_usb_oscar
	installe_oscar_usb info_erreur
	if ( test -e /tmp/sortir )
	then
		return
	fi
	proposer_installe_sur_usb
	rm -f /tmp/continuer_installer_usb_cdrom
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	fi
	return
fi
if ( test -e /tmp/continuer_installer_usb_cdrom )
then
	port_usb_oscar1=`cat /tmp/continuer_installer_usb_cdrom`
	cp -fr /mnt/custom/customcd/isoroot/isolinux $port_usb_oscar1/
	mv $port_usb_oscar1/isolinux $port_usb_oscar1/syslinux
	cp -fr /mnt/custom/customcd/isoroot/boot $port_usb_oscar1/ 2>/dev/null
	cp -fr /mnt/custom/customcd/isoroot/efi $port_usb_oscar1/ 2>/dev/null
	if ( test -e $port_usb_oscar1/boot/grub/grub-$version_sysrscd.cfg )
	then
		perl -pi -e 's/isolinux/syslinux/g;' $port_usb_oscar1/boot/grub/grub-$version_sysrscd.cfg
	fi
	if ! ( test -e /tmp/RapideSOS_usb )
	then
		cp -fr /mnt/custom/customcd/isoroot/Personnel/* $port_usb_oscar1/Personnel/ 2>/dev/null
		# cp -fr /mnt/custom/customcd/isoroot/bootdisk/* $port_usb_oscar1/
		cp -fr /mnt/custom/customcd/isoroot/bootdisk $port_usb_oscar1/
		cp -fr /mnt/custom/customcd/isoroot/ntpasswd $port_usb_oscar1/ 2>/dev/null
		cp -f /usr/share/oscar/usr/syslinux18.cfg $port_usb_oscar1/syslinux/syslinux.cfg
	else
		cp -f /usr/share/oscar/usr/isolinux18_rapidesos.cfg $port_usb_oscar1/syslinux/syslinux.cfg
	fi
	rm -f /tmp/RapideSOS_usb
	echo "perl -pi -e 's/setkmap\=fr/setkmap\=`cat /usr/share/oscar/usr/choix_clavier`/g; s/fr.ktl/`cat /usr/share/oscar/usr/choix_clavier`.ktl/g;' $port_usb_oscar1/syslinux/syslinux.cfg" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
	
	if ! ( test -e $port_usb_oscar1/syslinux/oscar )
	then	# cle non realisee
		umount $port_usb_oscar1 2>/dev/null 1>/dev/null ; sync
		installe_oscar_usb info_erreur
		if ( test -e /tmp/sortir )
		then
			return
		fi
		if ( test -e /tmp/sp_erreur_usb_oscar )
		then
			rm -f /tmp/sp_erreur_usb_oscar
			proposer_installe_sur_usb
			rm -f /tmp/continuer_installer_usb_cdrom
			if ( test -e /tmp/sortir )
			then
				rm -f /tmp/sortir
			fi
			return
		fi
	else
		umount $port_usb_oscar1 2>/dev/null 1>/dev/null ; sync
		installe_oscar_usb info_fin_usb
	fi
	rm -f /tmp/continuer_installer_usb_cdrom
fi
}
#----------------------------------------------------------------------------------------------------
PATH="/usr/share/oscar/bin:$PATH"
# /usr/share/oscar/usr/version_theme_oscar
if ( test -e /usr/share/oscar/usr/choix_langue )
then
	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
else
	echo "fr" > /usr/share/oscar/usr/choix_langue
	choix_langue=fr
	traduction
fi
chemin_langue=/usr/share/oscar/usr/langue/$choix_langue

if ( test -e /livemnt/boot/isolinux/maps )
then
	isolinux_=isolinux
elif ( test -e /livemnt/boot/syslinux/maps )
then # demarrage cle usb
	isolinux_=syslinux
else
	echo " Erreur clavier ..."
	sleep 8
	exit
fi

#  commandes externes de procÃ©dures
case "$1" in
	mesurer_taille_fichiers_avant_mksquashfs)
		mesurer_taille_fichiers_avant_mksquashfs
		exit 0
	;;
	mesurer_taille_fichiers_dans_sysresccd_mksquashfs)
		mesurer_taille_fichiers_dans_sysresccd_mksquashfs
		exit 0
	;;
esac


commande=$1	# pour cd jf
choix_noyau_demarrage

if [ "$commande" != "jf" ]
then
	boite_choix_cdrom
fi
rm -f /tmp/menu_titre
# Partition Linux de rÃ©alisation du CÃ©dÃ©rom OSCAR
echo " `cat $chemin_langue/menu_309` " > /tmp/menu_titre
echo "`cat $chemin_langue/menu_310`" > /tmp/menu_texte
echo "\n`cat $chemin_langue/selection_55`" > /tmp/fichierquestion
echo "`cat $chemin_langue/selection_52`" >> /tmp/fichierquestion
boites_demande_partition

rm -f /tmp/menu_titre
rm -f /tmp/menu_texte
rm -f /tmp/fichierquestion
if ( test -e /tmp/sortir )
then
        rm -f /tmp/sortir
        exit
fi

perl -pi -e 's/\/dev\///g;' /tmp/tempfile
repertoire=`cat /tmp/tempfile`
rm -f /tmp/tempfile
grep -i "e logiciel " /usr/share/oscar/bin/cdrom_oscar > /tmp/tempfile
# prendre la cinquieme colonne :
echo `gawk '{ print $5 ":" } ' /tmp/tempfile` > /tmp/tempfile1
cut -d":" -f1 /tmp/tempfile1 > /tmp/tempfile
temp_=`cat /tmp/tempfile`

rm -f /tmp/tempfile
rm -f /tmp/tempfile1

numero=`expr substr $repertoire 4 3`
disque=`expr substr $repertoire 1 3`

runme info_ddialog
# id_type=`sfdisk /dev/$disque -c $numero 2>/dev/null`
grep -i $repertoire /tmp/fichier_disque_dur | grep -c Linux > /tmp/nb_partition_linux
nb_partition_linux=`cat /tmp/nb_partition_linux`
rm -f /tmp/nb_partition_linux
if [ "$nb_partition_linux" = "1" ]    #  type=linux
then
	type=linux
	mount /dev/$repertoire /mnt/custom 2>/dev/null 1>/dev/null
	
	# choix du clavier :
		ls /livemnt/boot/$isolinux_/maps > /tmp/liste_clavier
		installe_oscar_dd demander_clavier # meme si pas en langue fr car suisse ou belge ...
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/tempfile
			exit
		fi
	choix_clavier=`cat /usr/share/oscar/usr/choix_clavier`
	reponse1=$temp_
	if [ "$commande" != "jf" ]
	then
		titre_mdp=" `cat $chemin_langue/mdp_1` "
		fichierquestion="`cat $chemin_langue/mdp_2`"
		boite_mdp
		mot_passe_sauve=$reponse
	
		titre_mdp=" `cat $chemin_langue/mdp_1` "
		fichierquestion="`cat $chemin_langue/mdp_4`"
		boite_confirme_mdp
		if ( test -e /tmp/sortir )
		then
			rm -f /tmp/tempfile
			rm -f /tmp/sortir
			exit
		fi
	else
		mot_passe_sauve=$reponse1
	fi
	echo "$mot_passe_sauve" > /mnt/custom/fichier_a
	echo "$mot_passe_sauve" > /mnt/custom/fichier_s	# ne sert a rien ici
	echo
	date=$(date +%y%m%d)
	if ( test -e /mnt/custom/customcd )
	then
		rm -R -f /mnt/custom/customcd/*
	fi

	choix_langue=`cat /usr/share/oscar/usr/choix_langue`
	fichiers_cdrom
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/tempfile
		rm -f /tmp/sortir
		exit
	fi

	echo
	echo -e "`cat $chemin_langue/texte_49`"
	echo
	echo -e "`cat $chemin_langue/texte_6`"
	echo
	if [ "$commande" = "jf" ]
	then
		if ! ( test -e /usr/share/oscar/usr/BOOT_IMAGE )
		then
			proc_cmdline=`cat /proc/cmdline`
			echo "$proc_cmdline" > /tmp/proc_cmdline
			grep -ci "BOOT_IMAGE" /tmp/proc_cmdline > /tmp/nombre_BOOT_IMAGE
			if ( test -e /tmp/nombre_BOOT_IMAGE )
			then
				nombre_BOOT_IMAGE=`cat /tmp/nombre_BOOT_IMAGE`
			fi
			rm -f /tmp/nombre_BOOT_IMAGE
			if [ "$nombre_BOOT_IMAGE" = "1" ]	# demarrage cdrom
			then
			      	perl -pi -e 's/BOOT_IMAGE=/}/g;' /tmp/proc_cmdline
			      	cut -d"}" -f2 /tmp/proc_cmdline > /tmp/proc_cmdline1
			      	cut -d" " -f1 /tmp/proc_cmdline1 > /tmp/proc_cmdline
			      	cp -f /tmp/proc_cmdline /usr/share/oscar/usr/BOOT_IMAGE
			else
				echo oscar > /usr/share/oscar/usr/BOOT_IMAGE
			fi
			rm -f /tmp/proc_cmdline
			rm -f /tmp/proc_cmdline1
		fi
		BOOT_IMAGE_oscar=`cat /usr/share/oscar/usr/BOOT_IMAGE`
		echo "perl -pi -e 's/rescue32/$BOOT_IMAGE_oscar/g; s/rescuecd/$BOOT_IMAGE_oscar/g;' /usr/sbin/sysresccd-custom" > /tmp/exec_nom
		chmod +x /tmp/exec_nom
		/tmp/exec_nom
	fi
	
	if ( test -e /livemnt/boot/syslinux/maps )
	then # demarrage cle usb
		perl -pi -e 's/isolinux/syslinux/g;' /usr/sbin/sysresccd-custom
	else
		perl -pi -e 's/syslinux/isolinux/g;' /usr/sbin/sysresccd-custom
	fi
	/usr/sbin/sysresccd-custom extract
	if ( test -e /livemnt/boot/syslinux/maps )
	then # demarrage cle usb
		perl -pi -e 's/syslinux/isolinux/g;' /usr/sbin/sysresccd-custom
		mv /mnt/custom/customcd/isoroot/syslinux /mnt/custom/customcd/isoroot/isolinux
	fi

	cp -f /usr/share/oscar/bin/oscar /mnt/custom/customcd/files/bin/oscar
	cp -f /usr/share/oscar/bin/ntfs_oscar /mnt/custom/customcd/files/bin
	cp -f $chemin_scripts/* /mnt/custom/customcd/files/usr/share/oscar/bin 2>/dev/null
	cp -f $chemin_scripts/* /mnt/custom/customcd/files/bin 2>/dev/null
	echo

	cp -Rf /usr/share/oscar/usr/GNUstep/* /mnt/custom/customcd/files/root/GNUstep/
	
	#cp -f /usr/share/oscar/bin/bashlogin /mnt/custom/customcd/files/bin
	# demarrage OSCAR :
	grep -v "^echo -e" /mnt/custom/customcd/files/bin/bashlogin > /tmp/temp_bashlogin
	cp -f /tmp/temp_bashlogin /mnt/custom/customcd/files/bin/bashlogin
	rm -f /tmp/temp_bashlogin
	rm -fR /mnt/custom/customcd/files/etc/avahi/oscar*
	perl -pi -e 's/exec \$SHELL --login/\/usr\/share\/oscar\/bin\/depart
	exec \$SHELL --login/g;' /mnt/custom/customcd/files/bin/bashlogin

	# configuration interface graphique OSCAR
	# cp -f /usr/share/oscar/usr/GNUstep/.jwmrc /mnt/custom/customcd/files/root/.jwmrc	# pour jwm
	# perl -pi -e 's/\/usr\/bin\/terminal/\/usr\/bin\/terminal -e \/usr\/share\/oscar\/bin\/oscar /g;' /mnt/custom/customcd/files/root/.xinitrc	
	cp -Rf /usr/share/oscar/usr/GNUstep/.config /mnt/custom/customcd/files/root/	# pour xfce
	# pour xfce :
	echo "" >> /mnt/custom/customcd/files/root/.config/xfce4/panel/launcher-2/oscar.desktop
	echo "Name=OSCAR-`cat /usr/share/oscar/usr/numero_version_oscar`" >> /mnt/custom/customcd/files/root/.config/xfce4/panel/launcher-2/oscar.desktop

	# page d'accueil OSCAR pour firefox ou midori
	if ( test -e /mnt/custom/customcd/files/opt/firefox/defaults/profile/prefs.js )
	then
		# perl -pi -e 's/www.sysresccd.org/oscar.crdp-lyon.fr/g;' /mnt/custom/customcd/files/usr/lib/mozilla-firefox/defaults/profile/prefs.js
		perl -pi -e 's/www.sysresccd.org/oscar.crdp-lyon.fr/g;' /mnt/custom/customcd/files/opt/firefox/defaults/profile/prefs.js
	elif ( test -e /mnt/custom/customcd/files/root/.config/midori/config )
	then
		grep -v "homepage=" /mnt/custom/customcd/files/root/.config/midori/config > /tmp/temp_config
		cp -f /tmp/temp_config /mnt/custom/customcd/files/root/.config/midori/config
		rm -f /tmp/temp_config
		echo "homepage=http://oscar.crdp-lyon.fr" >> /mnt/custom/customcd/files/root/.config/midori/config
		perl -pi -e 's/Firefox.desktop/midori.desktop/g;' /mnt/custom/customcd/files/root/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-panel.xml
	fi

	# cp -f /usr/share/oscar/usr/autostart.sh /mnt/custom/customcd/files/root/GNUstep/Library/WindowMaker/autostart

	chmod +x /mnt/custom/customcd/files/bin/*
	# chmod +x /mnt/custom/customcd/files/root/GNUstep/Library/WindowMaker/autostart

	echo "HOSTNAME=\"OSCAR\"" > /mnt/custom/customcd/files/etc/conf.d/hostname
	perl -pi -e 's/sysresccd localhost/OSCAR localhost/g;' /mnt/custom/customcd/files/etc/hosts

	cp -f /mnt/custom/fichier_a /mnt/custom/customcd/files/usr/share/oscar/bin
	cp -f /mnt/custom/fichier_s /mnt/custom/customcd/files/usr/share/oscar/bin
	perl -pi -e 's/fichier_s/fichier_a /g;' /mnt/custom/customcd/files/usr/share/oscar/bin/sauve
	rm -f /mnt/custom/fichier_a
	rm -f /mnt/custom/fichier_s
	
	# bug sysresccd-custom syslinux pour usb :
	#cp -f /livemnt/boot/usb_inst/syslinux /mnt/custom/customcd/files/usr/bin/syslinux
	#chmod +x /mnt/custom/customcd/files/usr/bin/syslinux
	if [ "$commande" = "jf" ]
	then
		echo "" > /mnt/custom/customcd/files/usr/share/oscar/usr/option_jf
		if ! ( test -e /mnt/sda10 )
	    	then
	    		mkdir /mnt/sda10
	    	fi
	    	mount /dev/sda10 /mnt/sda10
	    	if ! ( test -e /mnt/sda10/linux/bug_sysrcd/initialise_oscar )
	    	then
	    		if ! ( test -e /mnt/sdb1 )
		    	then
		    		mkdir /mnt/sdb1
		    	fi
		    	if ! ( test -e /mnt/sdb1/linux/bug_sysrcd/initialise_oscar )
		    	then
		    		echo
		    		echo " ATTENTION sdb1 et sda10 debranches ..."
		    		echo
		    	else
		    		cp -f /mnt/sdb1/linux/bug_sysrcd/initialise_oscar /tmp/lance_initialise_oscar
		    	fi
	    	else
	    		cp -f /mnt/sda10/linux/bug_sysrcd/initialise_oscar /tmp/lance_initialise_oscar
	    	fi
	    	if ( test -e /tmp/lance_initialise_oscar )
	    	then
    			chmod +x /tmp/lance_initialise_oscar
	    		/tmp/lance_initialise_oscar oscar_initialise
	    		rm -f /tmp/lance_initialise_oscar
	    	fi
	fi
	echo "initialise_oscar" > /mnt/custom/customcd/files/usr/share/oscar/usr/initialise
	### clavier francais pour installer OSCAR sur le poste:
	# perl -pi -e 's/KEYMAP=\"us\"/KEYMAP=\"fr-latin9\"/g;' /mnt/custom/customcd/files/etc/conf.d/keymaps
	# perl -pi -e 's/\"XkbLayout\" \"\"\\"XkbLayout\" \"fr-latin9\"/g;' /mnt/custom/customcd/files/etc/X11/xorg.conf

	chmod +x /mnt/custom/customcd/files/usr/share/oscar/usr/*
	chmod +x /mnt/custom/customcd/files/usr/share/oscar/bin/*

	faire_boot_msg
	cp -f /usr/share/oscar/usr/isolinux18.cfg /mnt/custom/customcd/isoroot/isolinux/isolinux.cfg
	
	if ( test -e /usr/share/oscar/usr/grub-version.cfg )
	then
		cut -d"-" -f1 /root/version | perl -pi -e 's/\.//g;' > /root/version1
		version_sysrscd=`cat /root/version1`
		rm -f /root/version1
		if ! ( test -e /mnt/custom/customcd/isoroot/boot/grub/grub-$version_sysrscd.bak )
		then
			cp -f /mnt/custom/customcd/isoroot/boot/grub/grub-$version_sysrscd.cfg /mnt/custom/customcd/isoroot/boot/grub/grub-$version_sysrscd.bak
		fi
		cp -f /usr/share/oscar/usr/grub-version.cfg /mnt/custom/customcd/isoroot/boot/grub/grub-$version_sysrscd.cfg
	fi
	
	cp -f /etc/boot.msg /mnt/custom/customcd/isoroot/isolinux/f1boot.msg
	cp -f /usr/share/oscar/usr/f2help18.msg /mnt/custom/customcd/isoroot/isolinux/f2help.msg
	cp -f /usr/share/oscar/usr/f3kern18.msg /mnt/custom/customcd/isoroot/isolinux/f3kern.msg
	
	# choix de la langue :
	cp -f /usr/share/oscar/usr/choix_langue /mnt/custom/customcd/files/usr/share/oscar/usr
	cp -fR /usr/share/oscar/usr/langue /mnt/custom/customcd/files/usr/share/oscar/usr
	
	# clavier choisi pour isolinux :
	cp -f /usr/share/oscar/usr/choix_clavier /mnt/custom/customcd/files/usr/share/oscar/usr
	cp -f /mnt/custom/customcd/isoroot/isolinux/maps/$choix_clavier.ktl /mnt/custom/customcd/isoroot/isolinux
	cp -f /mnt/custom/customcd/isoroot/isolinux/maps/$choix_clavier.ktl /mnt/custom/customcd/files/usr/share/oscar/usr
	echo "perl -pi -e 's/setkmap\=fr/setkmap\=`cat /usr/share/oscar/usr/choix_clavier`/g; s/fr.ktl/`cat /usr/share/oscar/usr/choix_clavier`.ktl/g;' /mnt/custom/customcd/isoroot/isolinux/isolinux.cfg" > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom
	rm -f /tmp/exec_nom
	if [ "$commande" = "jf" ]
	then
		rm -f /mnt/custom/customcd/isoroot/isolinux/maps/azerty.ktl
	fi
	# fin du clavier
	
	mv /mnt/custom/customcd/isoroot/isolinux/$choix_noyau /mnt/custom/customcd/isoroot/isolinux/oscar
	mv /mnt/custom/customcd/isoroot/isolinux/$choix_igz /mnt/custom/customcd/isoroot/isolinux/oscar.igz
	if ( test -e /mnt/custom/customcd/isoroot/isolinux/rescue32 )
	then
		echo "r" > /mnt/custom/customcd/isoroot/isolinux/rescue32
	elif ( test -e /mnt/custom/customcd/isoroot/isolinux/rescuecd )
	then
		echo "r" > /mnt/custom/customcd/isoroot/isolinux/rescuecd
	fi
	echo "r" > /mnt/custom/customcd/isoroot/isolinux/rescue64
	echo "a" > /mnt/custom/customcd/isoroot/isolinux/altker32
	echo "a" > /mnt/custom/customcd/isoroot/isolinux/altker64
	rm -f /mnt/custom/customcd/isoroot/isolinux/isolinux.bak
	rm -f /mnt/custom/customcd/isoroot/isolinux/isolinux.old
	
	chmod 777 -R /mnt/custom/customcd/isoroot
	mesurer_taille_fichiers_avant_mksquashfs
	/usr/sbin/sysresccd-custom squashfs

	if [ "$type" = "ntfs" ]
	then
		echo
		echo -e "`cat $chemin_langue/texte_52`"
	fi
	echo
	echo -e "`cat $chemin_langue/texte_50`"
	echo
	echo -e "`cat $chemin_langue/texte_6`"
	echo
	
	# installer ntpasswd
	if ! ( test -e /mnt/custom/customcd/isoroot/ntpasswd )
	then
		cp -fR /livemnt/boot/ntpasswd /mnt/custom/customcd/isoroot/
	fi
	# installer bootdisk
	if ! ( test -e /mnt/custom/customcd/isoroot/bootdisk )
	then
		cp -fR /livemnt/boot/bootdisk  /mnt/custom/customcd/isoroot/
	fi
	if ! ( test -e /mnt/custom/customcd/isoroot/boot )
	then
		cp -fR /livemnt/boot/boot  /mnt/custom/customcd/isoroot/ 2>/dev/null
	fi
	cp -fR /livemnt/boot/efi /mnt/custom/customcd/isoroot/ 2>/dev/null
#	mkdir /mnt/custom/customcd/isoroot/oscardoc	
#	cp -f -R /livemnt/oscardoc.fr /mnt/custom/customcd/isoroot/

	mkdir /mnt/custom/customcd/isoroot/Personnel
	echo
	cp -f -R $chemin_doc/* /mnt/custom/customcd/isoroot/Personnel 2>/dev/null 1>/dev/null
	echo
	
	#chmod 666 -R /mnt/custom/customcd/isoroot
	chmod 666 /mnt/custom/customcd/isoroot/sysrcd.dat
	
	grep -ci "cmd=\"xorriso" /usr/sbin/sysresccd-custom > /tmp/nb_xorriso
	nb_xorriso=`cat /tmp/nb_xorriso`
	rm -f /tmp/nb_xorriso
	if [ "$nb_xorriso" = 1 ]
	then # nouvelle version 3.0.0 sysresccd-custom
		perl -pi -e 's/cmd=\"xorriso/curtime=new
		cmd=\"xorriso/g;' /usr/sbin/sysresccd-custom
	else
		perl -pi -e 's/cmd=\"mkisofs/curtime=new
		cmd=\"mkisofs/g;' /usr/sbin/sysresccd-custom
	fi
	
	nom_cdrom_oscar=
	
	if ! [ "$commande" = "jf" ]
	then
		nom_cdrom_oscar=OSCAR-$date
	else
		nom_cdrom_oscar=OSCAR-particulier-$date
	fi
	/usr/sbin/sysresccd-custom isogen $nom_cdrom_oscar
	echo
	chmod 777 /mnt/custom/customcd/isofile/sysresccd-new.iso
	chmod 777 -f $chemin_cdrom
	cp -f /mnt/custom/customcd/isofile/sysresccd-new.iso $chemin_cdrom/$nom_cdrom_oscar.iso
	
	rm -f /mnt/custom/fichier_s
	rm -f /mnt/custom/fichier_a
	proposer_installe_sur_usb
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	fi
	boite_demande_installe_usb
	if ( test -e /tmp/sortir )
	then
		rm -f /tmp/sortir
	fi
	echo
	echo -e " `cat $chemin_langue/texte_53`\033[1;32m $chemin_cdrom/\033[1;m: "
	echo
	ls $chemin_cdrom/
	echo
	echo
	echo -e "`cat $chemin_langue/texte_55` \033[1;32m$nom_cdrom_oscar.iso\033[1;m "
	echo -e "`cat $chemin_langue/texte_54`"
	echo
	umount /mnt/custom 2>/dev/null ; sync
else
	rm -f /tmp/fichiertmp
	dialog --colors --no-shadow --backtitle "`cat /etc/banniere_oscar`" \
	--ok-label "`cat $chemin_langue/Continuer`" \
	--title " `cat $chemin_langue/DESOLE` " \
	--msgbox "\n\n\Z1 `cat $chemin_langue/msgbox_30`\Z2 $repertoire \Z1`cat $chemin_langue/selection_57` !\Zn" 10 60
        rm -f /tmp/fichiertmp
	exit
fi
rm -f /tmp/tempfile
echo
test_fin
