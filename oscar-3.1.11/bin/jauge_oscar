#!/bin/bash

## Copyright (c) 2003-2013 Tissoires Jean-François & Benjamin, jftissoires@gmail.com
## Outil Système Complet d'Assistance Réseau: OSCAR
## Ce programme est sous Licence Publique Générale GNU publiée par la Free Software Foundation.


PATH="/usr/share/oscar/bin:$PATH"
jauge_source=`cat /tmp/jauge_source`
jauge_destination=`cat /tmp/jauge_destination`
rm -f /tmp/jauge_source
rm -f /tmp/jauge_destination

if [ "$jauge_source" != "" -a "$jauge_destination" != "" ]; then
        if [ -f $jauge_source ]; then
                src=$jauge_source
                size=`ls -al $src | awk '{print int(($5/512)+(($5%512)?1:0))}'`
		src_name=`find $src -printf %f`
        else
                echo "Fichier source introuvable" >2
                exit 1
        fi
        if [ -f $jauge_destination ]; then
                dest=$jauge_destination
        else
                if [ -d $jauge_destination ]; then
                        dest=$jauge_destination/$src_name
                else
                        dest=$jauge_destination
                        touch $dest 2> /dev/null
                        if [ $? != 0 ]; then
                                echo "Destination invalide" >&2
                                exit 1
                        fi
                fi
        fi
        chunk_size=$(($size/100))
        if [ $chunk_size -lt 1 ]; then
                cp -f $src $dest
                exit 0
        fi
        copied=0
        (while [ $copied -lt $size ]; do
                dd if=$src of=$dest bs=512 count=$chunk_size skip=$copied seek=$copied >/dev/null 2>&1
                copied=$(($copied+$chunk_size))
		echo $(((100*$copied)/$size))
        done) | DIALOGRC="/etc/dialogmenu_bloque" dialog --colors  --backtitle "`cat /etc/banniere_oscar`" --title " Copie en cours " --gauge "$src\n> $dest " 10 60 0
else
	echo source dans /tmp/jauge_source
	echo destination dans /tmp/jauge_destination
        echo commande : jauge_oscar
fi


