#!/bin/sh



## Copyright (c) 2003-2013 Tissoires Jean-FranÃ§ois & Benjamin,  jftissoires@gmail.com
## Outil SystÃ¨me Complet d'Assistance RÃ©seau: OSCAR
## Rapide de Sauvegarde aux Ordinateurs et SystÃ¨mes: RapideSOS
## Ce programme est sous Licence Publique GÃ©nÃ©rale GNU publiÃ©e par la Free Software Foundation.



# rÃ©cupÃ¨re l'adresse ip du fichier ip_format pour mettre l'ip dans le fichier adequat linux
# valable pour ubuntu mandriva ou autre si /mnt/$partition_particuliere/etc/network/interfaces existe
# supprime aussi les fichiers ssh et autres pour le déploiement sous linux

PATH="/usr/share/oscar/bin:$PATH"

partition_oscar=`cat /tmp/partition_linux_oscar`
partition_particuliere=`cat /tmp/partition_linux_particuliere`

#---------------------------------------------------------------------------------------------------
supprimer_fichiers_reinstalles_au_demarrage()
{
rm -f /mnt/$partition_particuliere/etc/udev/rules.d/70-persistent-net.rules
rm -f /mnt/$partition_particuliere/etc/ssh/ssh_host_*key*
cp -f /mnt/$partition_particuliere/etc/rc.local /mnt/$partition_particuliere/etc/rc.local_avant_oscar
perl -pi -e 's/^exit 0/dpkg-reconfigure openssh-server
cp -f \/etc\/rc.local_avant_oscar \/etc\/rc.local
rm -f \/etc\/rc.local_avant_oscar
exit 0/g;' /mnt/$partition_particuliere/etc/rc.local
}
#---------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------
supprimer_fichiers_reinstalles_au_demarrage

# recupere l'ip:
	poste=`cat $partition_oscar/oscar/var_poste/numero_poste_client`
        rm -f ip_poste
        rm -f /tmp/fichiertmp
        cut -f5 -d. $partition_oscar/oscar/var_poste/ip_format > /tmp/fichiertmp
        format=`cat /tmp/fichiertmp`
        rm -f /tmp/fichiertmp
        ### dans ip_format: XXX.XXX.XXX.XXX.lettre
        if [ "$format" = "a" ]
        then
                cut -f4 -d. $partition_oscar/oscar/var_poste/ip_format > /tmp/fichiertmp
                vvv=`cat /tmp/fichiertmp`
                yyy=$[$vvv+$poste]
                echo "`cut -f1-3 -d. $partition_oscar/oscar/var_poste/ip_format`.$yyy" > ip_poste
        elif [ "$format" = "b" ]
        then
                cut -f3 -d. $partition_oscar/oscar/var_poste/ip_format > /tmp/fichiertmp
                vvv=`cat /tmp/fichiertmp`
                yyy=$[$vvv+$poste]
                echo "`cut -f1-2 -d. $partition_oscar/oscar/var_poste/ip_format`.$yyy.`cut -f4 -d. $partition_oscar/oscar/var_poste/ip_format`" > ip_poste
        else    # ne pas installer l'ip car dhcp
    	    exit
        fi
        echo " son adresse IP est `cat ip_poste`"

echo "auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address `cat ip_poste`
netmask `cat $partition_oscar/oscar/var_poste/ip_masque`
gateway `cat $partition_oscar/oscar/var_poste/ip_passerelle`" > /mnt/$partition_particuliere/etc/network/interfaces

if ( test -e /mnt/$partition_particuliere/etc/sysconfig/network-scripts/ifcfg-eth0 )
then	# partition mandriva
	grep -v "NETMASK" /mnt/$partition_particuliere/etc/sysconfig/network-scripts/ifcfg-eth0 | grep -v "IPADDR" > /tmp/tempfile
	cp -f /tmp/tempfile /mnt/$partition_particuliere/etc/sysconfig/network-scripts/ifcfg-eth0
	echo "NETMASK=`cat $partition_oscar/oscar/var_poste/ip_masque`
	IPADDR=`cat ip_poste`" >> /tmp/tempfile /mnt/$partition_particuliere/etc/sysconfig/network-scripts/ifcfg-eth0
	
	grep -v "GATEWAY" /mnt/$partition_particuliere/etc/sysconfig/network > /tmp/tempfile
	cp -f /tmp/tempfile /mnt/$partition_particuliere/etc/sysconfig/network
	echo "GATEWAY=`cat $partition_oscar/oscar/var_poste/ip_passerelle`" >> /mnt/$partition_particuliere/etc/sysconfig/network
	rm -f /tmp/tempfile
fi
rm -f ip_poste
rm -f /tmp/fichiertmp