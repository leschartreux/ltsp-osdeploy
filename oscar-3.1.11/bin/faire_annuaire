#!/bin/sh

## Copyright (c) 2003-2013 Tissoires Jean-Fran‡ois & Benjamin, jftissoires@gmail.com
## Cdrom Outil SystÃ¨me Complet d'Assistance R‚seau: OSCAR
## Ce programme est sous Licence Publique G‚n‚rale GNU publi‚e par la Free Software Foundation.


# les fichiers complets par acad‚mie sont dans /home/jf/annuaire/gouv/
# lien : http://rne.education.gouv.fr/html/accueil.htm
# --> "Etablissements du second degrÃ©"
#		autres choix possibles (ne prendre que les deux premiÃ¨res colonnes):
#		--> CLG		CollÃ¨ge
#		--> LPO		LycÃ©e polyvalent
#		--> LGT		LycÃ©e GÃ©nÃ©ral et Technique
#		--> LT		LycÃ©e Technologique (dans la deuxiÃ¨me colonne)
#		--> LG		LycÃ©e GÃ©nÃ©ral (dans la deuxiÃ¨me colonne)
#		--> LP		LycÃ©e Professionnel (dans la deuxiÃ¨me colonne)
#		--> LCL		LycÃ©e Climatique
#		--> SGT		Section GÃ©nÃ©rale et Technologique en lycÃ©e professionnel
#		--> SEGPA	Section d'Enseignement GÃ©nÃ©ral et Professionnel AdaptÃ©
#		--> SEP		Section d'Enseignement professionnel en lycÃ©e (dans la deuxiÃ¨me colonne)
#		--> SET		Section technologique (4Ã¨me et 3Ã¨me technologiques en collÃ¨ge) (dans la deuxiÃ¨me colonne)
#		--> DRA		Direction RÃ©gionale de l'Action Culturelle (dans la deuxiÃ¨me colonne)
#		--> EDM		Ecole De MÃ©tier (dans la deuxiÃ¨me colonne)
#		--> IUFM	Institut Universitaire de Formation des MaÃ®tres



# faire_annuaire en executable est dans /home/jf
# installer pour Ubuntu : #sudo apt-get install gawk
# installer aussi geany, choisir le type de fichier "script shell"

chemin_entree=/home/jf/annuaire/gouv
chemin_sortie=/home/jf/annuaire

# pour les ‚coles en ZEP et REP
# le fichier de travail est /home/jf/annuaire/ecoles_rep/ecoles


#----------------------------------------------------------------------------------------------------
choix_categorie()
{
if [ "$type" = "ecoles" ]
then
	categorie=ecoles
else
	echo
	echo " Donnez votre cat‚gorie : Tous Coll‚ges Lyc‚es ou  t/c/l :"
	echo
	read categorie
	if [ "$categorie" = "c" ] || [ "$categorie" = "C" ]
	then
		categorie=CLG	# ne prendre seulement que CLG
	elif [ "$categorie" = "l" ] || [ "$categorie" = "L" ]
	then
		categorie=lycees	# supprimer CLG
	elif [ "$categorie" = "t" ] || [ "$categorie" = "T" ]
	then
		categorie=tous	# ne rien changer
	else
		choix_categorie
	fi
fi
}
#----------------------------------------------------------------------------------------------------
conserver_seulement_rne()
{
	
	enlever_CLG=_conserver_
	prendre_CLG=		# tous
	if [ "$categorie" = "CLG" ]
	then
		prendre_CLG=CLG
	elif [ "$categorie" = "lycees" ]
	then
		enlever_CLG=CLG
	elif [ "$categorie" = "ecoles" ]
	then
		prendre_CLG=_oscar_
		perl -pi -e 's/E.E.PU/ _oscar_/g; s/E.M.PU/ _oscar_/g;' /tmp/tempfile
	fi
	grep -v "Liste des" /tmp/tempfile | grep -i "$prendre_CLG"| grep -v "$enlever_CLG" | grep -v "Nombre d" | grep -v "# :" | grep -v "ponses  -  Page" | grep -v "Code	Sigle" > /tmp/tempfile1
	perl -pi -e 's/ /;/g;' /tmp/tempfile1
	echo "$post_adresse" > /tmp/tempfile

	if [ "$categorie" = "ecoles" ]
	then
		perl -pi -e 's/;;/; /g;' /tmp/tempfile1
		echo `gawk '{ print $1 " " }' /tmp/tempfile1 ` >> /tmp/tempfile
	else
		echo `gawk '{ print $1 " " }' /tmp/tempfile1 ` >> /tmp/tempfile
	fi
	echo "perl -pi -e 's/;/$chaine_remplace/g;' /tmp/tempfile " > /tmp/exec_nom
	chmod +x /tmp/exec_nom
	/tmp/exec_nom	
	rm -f /tmp/exec_nom
	perl -pi -e 's/$post_adresse /$post_adresse/g; s/$post_adresse
/$post_adresse/g; s/,/,
/g;' /tmp/tempfile
	grep -i "\@" /tmp/tempfile > /tmp/tempfile1
	
	echo `gawk '{ print $1 " " }' /tmp/tempfile1 ` > /tmp/tempfile
	cat /tmp/tempfile

	rm  -f /tmp/tempfile1
	
	
}


#----------------------------------------------------------------------------------------------------

main()
{

cp -f $chemin_entree/$nom_fichier /tmp/tempfile

post_adresse=$type.
if [ "$type" = "complet" ] || [ "$type" = "ecoles" ]
then
	post_adresse=ce.
	fichier_sortie=$nom_fichier-rep
else
	fichier_sortie=$nom_fichier-$type
fi

chaine_remplace="\@ac-$nom_fichier.fr , $post_adresse"
conserver_seulement_rne
cp -f /tmp/tempfile /tmp/tempfile2

if [ "$type" != "ecoles" ]
then
	if [ "$type" = "complet" ]
	then
		post_adresse=int.
		cp -f $chemin_entree/$nom_fichier /tmp/tempfile	
		chaine_remplace="\@ac-$nom_fichier.fr , $post_adresse"
		conserver_seulement_rne
		echo "`cat /tmp/tempfile`" >> /tmp/tempfile2
		fichier_sortie=$fichier_sortie-int
	else
		if [ "$type1" != "" ]
		then
			post_adresse=$type1.
			cp -f $chemin_entree/$nom_fichier /tmp/tempfile	
			chaine_remplace="\@ac-$nom_fichier.fr , $post_adresse"
			conserver_seulement_rne
			echo "`cat /tmp/tempfile`" >> /tmp/tempfile2
			fichier_sortie=$fichier_sortie-$type1
		fi
	fi
	if [ "$type" = "complet" ]
	then
		post_adresse=cdi.
		cp -f $chemin_entree/$nom_fichier /tmp/tempfile	
		chaine_remplace="\@ac-$nom_fichier.fr , $post_adresse"
		conserver_seulement_rne
		echo "`cat /tmp/tempfile`" >> /tmp/tempfile2
		fichier_sortie=$fichier_sortie-cdi
	else
		if [ "$type2" != "" ]
		then
			post_adresse=$type2.
			cp -f $chemin_entree/$nom_fichier /tmp/tempfile	
			chaine_remplace="\@ac-$nom_fichier.fr , $post_adresse"
			conserver_seulement_rne
			echo "`cat /tmp/tempfile`" >> /tmp/tempfile2
			fichier_sortie=$fichier_sortie-$type2
		fi
	fi
fi
	perl -pi -e 's/
//g;' /tmp/tempfile2
	cp -f /tmp/tempfile2 $chemin_sortie/$fichier_sortie
	chmod 777 $chemin_sortie/$fichier_sortie
	echo
	echo "le fichier de sortie est $chemin_sortie/$fichier_sortie"
	echo
	rm  -f /tmp/tempfile
	rm  -f /tmp/tempfile2
		
}

#--------------------------------------------------------------------------------------------------


type=$1
type1=$2
type2=$3

if ! ( [ "$type" = "ce" ] || [ "$type" = "cdi" ] || [ "$type" = "int" ] || [ "$type" = "complet" ]|| [ "$type" = "ecoles" ] )
then
	echo
	echo " Erreur precisez l'option de commande ce, int, cdi, complet ou ecoles (ex : faire_annuaire ce)"
	echo
	exit
fi

if [ "$type" = "ecoles" ]
then
    chemin_entree=/home/jf/annuaire/ecoles_rep
    chemin_sortie=/home/jf/annuaire
fi

echo
echo " Donnez le nom du fichier a transformer site dans $chemin_entree : "
read nom_fichier
if ! ( test -e $chemin_entree/$nom_fichier )
then
	echo
	echo " Erreur ce fichier n'existe pas dans $chemin_entree ..."
	echo
	exit
fi




choix_categorie

annuaire=annuaire-LYCEES-CLG
if [ "$categorie" = "CLG" ]
then
	annuaire=annuaire-CLG
elif [ "$categorie" = "lycees" ]
then
	annuaire=annuaire-LYCEES
elif [ "$categorie" = "ecoles" ]
then
	annuaire=annuaire-ecoles-rep
fi


if [ "$type" = "complet" ]
then
	chemin_sortie=$chemin_sortie/$annuaire-ce_cdi_int
elif ( [ "$type" = "ce" ] || [ "$type" = "cdi" ] || [ "$type" = "int" ] )
then
	chemin_sortie=$chemin_sortie/$annuaire-$type
	if ( [ "$type1" = "ce" ] || [ "$type1" = "cdi" ] || [ "$type1" = "int" ] )
	then
		chemin_sortie=$chemin_sortie/$annuaire-$type-$type1
		if ( [ "$type2" = "ce" ] || [ "$type2" = "cdi" ] || [ "$type2" = "int" ] )
		then
			chemin_sortie=$chemin_sortie/$annuaire-ce_cdi_int
		fi
	fi
elif [ "$type" = "ecoles" ]
then
	chemin_sortie=$chemin_sortie/$annuaire
fi

if ! ( test -e $chemin_sortie )
then
	mkdir $chemin_sortie
fi

main
